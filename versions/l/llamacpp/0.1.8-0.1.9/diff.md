# Comparing `tmp/llamacpp-0.1.8.tar.gz` & `tmp/llamacpp-0.1.9.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "llamacpp-0.1.8.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
+gzip compressed data, was "llamacpp-0.1.9.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
```

## Comparing `llamacpp-0.1.8.tar` & `llamacpp-0.1.9.tar`

### file list

```diff
@@ -1,41 +1,74 @@
--rw-r--r--   0        0        0     2653 2022-11-09 12:37:21.000000 llamacpp-0.1.8/.github/workflows/wheels.yml
--rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 llamacpp-0.1.8/.gitignore
--rw-r--r--   0        0        0       98 2022-11-09 12:37:21.000000 llamacpp-0.1.8/.gitmodules
--rw-r--r--   0        0        0      938 2022-11-09 12:37:21.000000 llamacpp-0.1.8/CMakeLists.txt
--rw-r--r--   0        0        0     2278 2022-11-09 12:37:21.000000 llamacpp-0.1.8/README.md
--rw-r--r--   0        0        0       96 2022-11-09 12:37:21.000000 llamacpp-0.1.8/llamacpp/__init__.py
--rw-r--r--   0        0        0     3297 2022-11-09 12:37:21.000000 llamacpp-0.1.8/llamacpp/chat.py
--rw-r--r--   0        0        0     6322 2022-11-09 12:37:21.000000 llamacpp-0.1.8/llamacpp/cli.py
--rw-r--r--   0        0        0     5635 2022-11-09 12:37:21.000000 llamacpp-0.1.8/llamacpp/convert.py
--rw-r--r--   0        0        0     1838 2022-11-09 12:37:21.000000 llamacpp-0.1.8/llamacpp/quantize.py
--rw-r--r--   0        0        0     1360 2022-11-09 12:37:21.000000 llamacpp-0.1.8/pyproject.toml
--rw-r--r--   0        0        0     8167 2022-11-09 12:37:21.000000 llamacpp-0.1.8/src/PyLlama.cpp
--rw-r--r--   0        0        0      336 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.devops/full.Dockerfile
--rw-r--r--   0        0        0      259 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.devops/main.Dockerfile
--rwxr-xr-x   0        0        0     1812 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.devops/tools.sh
--rw-r--r--   0        0        0      231 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.dockerignore
--rw-r--r--   0        0        0       37 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.git
--rw-r--r--   0        0        0     8738 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.github/workflows/build.yml
--rw-r--r--   0        0        0     1860 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.github/workflows/docker.yml
--rw-r--r--   0        0        0      246 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/.gitignore
--rw-r--r--   0        0        0     4480 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/CMakeLists.txt
--rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/LICENSE
--rw-r--r--   0        0        0     5215 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/Makefile
--rw-r--r--   0        0        0    13500 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/README.md
--rwxr-xr-x   0        0        0      196 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/alpaca.sh
--rw-r--r--   0        0        0     4401 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/convert-pth-to-ggml.py
--rw-r--r--   0        0        0     1905 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/download-pth.py
--rw-r--r--   0        0        0     1025 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/flake.lock
--rw-r--r--   0        0        0     1512 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/flake.nix
--rw-r--r--   0        0        0   332256 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/ggml.c
--rw-r--r--   0        0        0    22153 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/ggml.h
--rw-r--r--   0        0        0    49865 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/llama.cpp
--rw-r--r--   0        0        0     3336 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/llama.h
--rw-r--r--   0        0        0     9563 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/main.cpp
--rw-r--r--   0        0        0      106 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/prompts/alpaca.txt
--rw-r--r--   0        0        0      387 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/prompts/chat-with-bob.txt
--rw-r--r--   0        0        0     1658 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/quantize.cpp
--rw-r--r--   0        0        0     4232 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/quantize.py
--rw-r--r--   0        0        0    20756 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/utils.cpp
--rw-r--r--   0        0        0     3763 2022-11-09 12:37:21.000000 llamacpp-0.1.8/vendor/llama.cpp/utils.h
--rw-r--r--   0        0        0     3116 2022-11-09 12:37:21.000000 llamacpp-0.1.8/PKG-INFO
+-rw-r--r--   0        0        0     2653 2022-11-09 12:37:21.000000 llamacpp-0.1.9/.github/workflows/wheels.yml
+-rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 llamacpp-0.1.9/.gitignore
+-rw-r--r--   0        0        0       98 2022-11-09 12:37:21.000000 llamacpp-0.1.9/.gitmodules
+-rw-r--r--   0        0        0      602 2022-11-09 12:37:21.000000 llamacpp-0.1.9/.vscode/c_cpp_properties.json
+-rw-r--r--   0        0        0      830 2022-11-09 12:37:21.000000 llamacpp-0.1.9/.vscode/launch.json
+-rw-r--r--   0        0        0       53 2022-11-09 12:37:21.000000 llamacpp-0.1.9/.vscode/settings.json
+-rw-r--r--   0        0        0      956 2022-11-09 12:37:21.000000 llamacpp-0.1.9/CMakeLists.txt
+-rw-r--r--   0        0        0     2783 2022-11-09 12:37:21.000000 llamacpp-0.1.9/README.md
+-rw-r--r--   0        0        0      663 2022-11-09 12:37:21.000000 llamacpp-0.1.9/examples/simple.py
+-rw-r--r--   0        0        0        0 2022-11-09 12:37:21.000000 llamacpp-0.1.9/examples/simple_low_level.py
+-rw-r--r--   0        0        0     1365 2022-11-09 12:37:21.000000 llamacpp-0.1.9/pyproject.toml
+-rw-r--r--   0        0        0     8167 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/PyLlama.cpp
+-rw-r--r--   0        0        0    15104 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llama2.cpp
+-rw-r--r--   0        0        0     4338 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llama_wrapper.cpp
+-rw-r--r--   0        0        0     4100 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llama_wrapper.h
+-rw-r--r--   0        0        0      137 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llamacpp/__init__.py
+-rw-r--r--   0        0        0     3297 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llamacpp/chat.py
+-rw-r--r--   0        0        0     7094 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llamacpp/cli.py
+-rw-r--r--   0        0        0     5635 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llamacpp/convert.py
+-rw-r--r--   0        0        0     1838 2022-11-09 12:37:21.000000 llamacpp-0.1.9/src/llamacpp/quantize.py
+-rw-r--r--   0        0        0      328 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.devops/full.Dockerfile
+-rw-r--r--   0        0        0      259 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.devops/main.Dockerfile
+-rwxr-xr-x   0        0        0     1493 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.devops/tools.sh
+-rw-r--r--   0        0        0      231 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.dockerignore
+-rw-r--r--   0        0        0       37 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.git
+-rw-r--r--   0        0        0    10063 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.github/ISSUE_TEMPLATE/custom.md
+-rw-r--r--   0        0        0    11614 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.github/workflows/build.yml
+-rw-r--r--   0        0        0     1961 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.github/workflows/docker.yml
+-rw-r--r--   0        0        0      305 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/.gitignore
+-rw-r--r--   0        0        0     7759 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/CMakeLists.txt
+-rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/LICENSE
+-rw-r--r--   0        0        0     7244 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/Makefile
+-rw-r--r--   0        0        0      464 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/Package.swift
+-rw-r--r--   0        0        0    16157 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/README.md
+-rw-r--r--   0        0        0     1898 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/SHA256SUMS
+-rw-r--r--   0        0        0     6042 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/convert-gptq-to-ggml.py
+-rw-r--r--   0        0        0     5295 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/convert-pth-to-ggml.py
+-rw-r--r--   0        0        0     3159 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/convert-unversioned-ggml-to-ggml.py
+-rw-r--r--   0        0        0     9825 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/convert_ggml_to_pth.py
+-rw-r--r--   0        0        0      637 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/CMakeLists.txt
+-rwxr-xr-x   0        0        0      226 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/alpaca.sh
+-rwxr-xr-x   0        0        0     2708 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/chat-13B.sh
+-rwxr-xr-x   0        0        0      337 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/chat.sh
+-rw-r--r--   0        0        0    13117 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/common.cpp
+-rw-r--r--   0        0        0     3078 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/common.h
+-rw-r--r--   0        0        0      196 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/embedding/CMakeLists.txt
+-rw-r--r--   0        0        0       21 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/embedding/README.md
+-rw-r--r--   0        0        0     3003 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/embedding/embedding.cpp
+-rw-r--r--   0        0        0      186 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/main/CMakeLists.txt
+-rw-r--r--   0        0        0       16 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/main/README.md
+-rw-r--r--   0        0        0    16048 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/main/main.cpp
+-rw-r--r--   0        0        0      198 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/perplexity/CMakeLists.txt
+-rw-r--r--   0        0        0       22 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/perplexity/README.md
+-rw-r--r--   0        0        0     5372 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/perplexity/perplexity.cpp
+-rw-r--r--   0        0        0      187 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/quantize/CMakeLists.txt
+-rw-r--r--   0        0        0       17 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/quantize/README.md
+-rw-r--r--   0        0        0     1522 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/examples/quantize/quantize.cpp
+-rw-r--r--   0        0        0     1025 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/flake.lock
+-rw-r--r--   0        0        0     1557 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/flake.nix
+-rw-r--r--   0        0        0   319112 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/ggml.c
+-rw-r--r--   0        0        0    22446 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/ggml.h
+-rw-r--r--   0        0        0    62704 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/llama.cpp
+-rw-r--r--   0        0        0     5174 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/llama.h
+-rw-r--r--   0        0        0   432610 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/models/ggml-vocab.bin
+-rw-r--r--   0        0        0      106 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/prompts/alpaca.txt
+-rw-r--r--   0        0        0      387 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/prompts/chat-with-bob.txt
+-rw-r--r--   0        0        0     1669 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/prompts/dan.txt
+-rw-r--r--   0        0        0     4436 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/quantize.py
+lrwxr-xr-x   0        0        0        0 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/spm-headers/llama.h -> ../llama.h
+-rw-r--r--   0        0        0      453 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/tests/CMakeLists.txt
+-rw-r--r--   0        0        0     1733 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/tests/test-double-float.c
+-rw-r--r--   0        0        0     1354 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/tests/test-quantize.c
+-rw-r--r--   0        0        0     2552 2022-11-09 12:37:21.000000 llamacpp-0.1.9/vendor/llama.cpp/tests/test-tokenizer-0.cpp
+-rw-r--r--   0        0        0     3621 2022-11-09 12:37:21.000000 llamacpp-0.1.9/PKG-INFO
```

### Comparing `llamacpp-0.1.8/.github/workflows/wheels.yml` & `llamacpp-0.1.9/.github/workflows/wheels.yml`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/.gitignore` & `llamacpp-0.1.9/.gitignore`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/CMakeLists.txt` & `llamacpp-0.1.9/CMakeLists.txt`

 * *Files 16% similar despite different names*

```diff
@@ -5,26 +5,24 @@
 
 set(CMAKE_CXX_STANDARD 14)
 set(CMAKE_CXX_STANDARD_REQUIRED ON)
 set(CMAKE_CXX_EXTENSIONS OFF)
 set(CMAKE_POSITION_INDEPENDENT_CODE ON)
 
 set(GGML_USE_ACCELERATE 1)
-find_package(pybind11 REQUIRED)
+find_package(pybind11 CONFIG REQUIRED)
 
 add_subdirectory(vendor/llama.cpp)
-add_library(llamacpp MODULE src/PyLlama.cpp)
-
+pybind11_add_module(llamacpp MODULE src/llama2.cpp src/llama_wrapper.cpp src/llama_wrapper.h)
 target_include_directories(llamacpp PRIVATE vendor/llama.cpp)
 target_link_libraries(llamacpp PRIVATE pybind11::module pybind11::lto pybind11::windows_extras llama)
 add_link_options(-no_fixup_chains)
-pybind11_extension(llamacpp)
 
 if(NOT MSVC AND NOT ${CMAKE_BUILD_TYPE} MATCHES Debug|RelWithDebInfo)
     # Strip unnecessary sections of the binary on Linux/macOS
     pybind11_strip(llamacpp)
 endif()
 
 set_target_properties(llamacpp PROPERTIES CXX_VISIBILITY_PRESET "hidden"
     CUDA_VISIBILITY_PRESET "hidden")
 
-install(TARGETS llamacpp LIBRARY DESTINATION llamacpp)
+install(TARGETS llamacpp DESTINATION llamacpp)
```

### Comparing `llamacpp-0.1.8/README.md` & `llamacpp-0.1.9/README.md`

 * *Files 17% similar despite different names*

```diff
@@ -32,51 +32,53 @@
 
 **Note that running `llamacpp-convert` requires `torch`, `sentencepiece` and `numpy` to be installed. These packages are not installed by default when your install `llamacpp`.**
 
 ## Command line interface
 
 The package installs the command line entry point `llamacpp-cli` that points to `llamacpp/cli.py` and should provide about the same functionality as the `main` program in the original C++ repository. There is also an experimental `llamacpp-chat` that is supposed to bring up a chat interface but this is not working correctly yet.
 
+## API
+
+Documentation is TBD. But the long and short of it is that there are two interfaces
+* `LlamaInference` - this one is a high level interface that tries to take care of most things for you. The demo script below uses this.
+* `LlamaContext` - this is a low level interface to the underlying llama.cpp API. You can use this similar to how the [main](https://github.com/ggerganov/llama.cpp/blob/master/examples/main/main.cpp) example in `llama.cpp` does uses the C API. This is a rough implementation and currently untested except for compiling successfully.
+
 ## Demo script
 
 See `llamacpp/cli.py` for a detailed example. The simplest demo would be something like the following:
 
 ```python
 import sys
 import llamacpp
 
-params = llamacpp.gpt_params(
-    './models/7B/ggml-model-q4_0.bin',  # model,
-    512,  # ctx_size
-    100,  # n_predict
-    40,  # top_k
-    0.95,  # top_p
-    0.85,  # temp
-    1.30,  # repeat_penalty
-    -1,  # seed
-    8,  # threads
-    64,  # repeat_last_n
-    8,  # batch_size
-)
-model = llamacpp.PyLLAMA(params)
-model.add_bos()     # Adds "beginning of string" token
-model.update_input("A llama is a")
-model.print_startup_stats()
-model.prepare_context()
-
-model.ingest_all_pending_input(True)
-while not model.is_finished():
-    text, is_finished = model.infer_text()
-    print(text, end="")
-
-    if is_finished:
-        break
 
+def progress_callback(progress):
+    print("Progress: {:.2f}%".format(progress * 100))
+    sys.stdout.flush()
+
+
+params = llamacpp.InferenceParams.default_with_callback(progress_callback)
+params.path_model = './models/7B/ggml-model-q4_0.bin'
+model = llamacpp.LlamaInference(params)
+
+prompt = "A llama is a"
+prompt_tokens = model.tokenize(prompt, True)
+model.update_input(prompt_tokens)
+
+model.ingest_all_pending_input()
+
+model.print_system_info()
+for i in range(20):
+    model.eval()
+    token = model.sample()
+    text = model.token_to_str(token)
+    print(text, end="")
+    
 # Flush stdout
 sys.stdout.flush()
 
-model.print_end_stats()
+model.print_timings()
 ```
 
 ## ToDo
 
 - [ ] Investigate using dynamic versions using setuptools-scm (Example: https://github.com/pypa/setuptools_scm/blob/main/scm_hack_build_backend.py)
```

### Comparing `llamacpp-0.1.8/llamacpp/chat.py` & `llamacpp-0.1.9/src/llamacpp/chat.py`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/llamacpp/cli.py` & `llamacpp-0.1.9/src/llamacpp/cli.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """Python version of main.cpp"""
 import sys
 import argparse
 import llamacpp
+from typing import Dict
 
 
-def parse_args_into_params(argv) -> llamacpp.gpt_params:
+def parse_args_into_params(argv) -> Dict[str, str]:
     """Parses arguments using argparse based on usage information above"""
     parser = argparse.ArgumentParser(description="llama.cpp CLI")
     parser.add_argument("-i", "--interactive", action="store_true", help="run in interactive mode")
     parser.add_argument(
         "-ins", "--instruct",
         action="store_true",
         help="run in 'instruct mode' where the user is prompted to enter a command",
@@ -48,46 +49,53 @@
     )
     parser.add_argument("--top_k", type=int, default=40, help="top-k sampling (default: 40)")
     parser.add_argument("--top_p", type=float, default=0.95, help="top-p sampling (default: 0.1)")
     parser.add_argument(
         "--repeat_last_n",
         type=int,
         default=64,
-        help="last n tokens to consider for penalize (default: 0)",
+        help="last n tokens to consider for penalize (default: 64)",
     )
     parser.add_argument(
         "--repeat_penalty",
         type=float,
         default=1.30,
-        help="penalize repeat sequence of tokens (default: 0.0)",
+        help="penalize repeat sequence of tokens (default: 1.30)",
     )
     parser.add_argument(
         "-c",
-        "--ctx_size",
+        "--n_ctx",
         type=int,
-        default=4096,
-        help="size of the prompt context (default: 4096)",
+        default=512,
+        help="size of the prompt context (default: 512)",
     )
     parser.add_argument("--temp", type=float, default=0.8, help="temperature (default: 0.7)")
     parser.add_argument(
         "-b",
         "--batch_size",
         type=int,
         default=8,
         help="batch size for prompt processing (default: 2)",
     )
     parser.add_argument("-m", "--model", type=str, default="./models/7B/ggml-model-q4_0.bin", help="model path (default: )")
+    parser.add_argument("--use_mlock", action="store_true", help="use mlock to lock memory")
+    parser.add_argument("--memory_f16", action="store_true", help="use half-precision memory")
+    parser.add_argument("--n_batch", type=int, default=8, help="number of tokens per batch")
+    parser.add_argument("--n_threads", type=int, default=4, help="number of threads to use")
+
     parser.usage = parser.format_help()
 
     args = parser.parse_args(argv[1:])
 
+    if args.interactive or args.instruct:
+        print("WARNING: interactive mode and instruct mode are currently broken")
     return args
 
 
-def process_interactive_input(model: llamacpp.PyLLAMA):
+def process_interactive_input(model: llamacpp.LlamaInference):
     """Process interactive input similar to the C++ version"""
 
     # Read lines as long as user is entering "\" at the end of the line
     # Pass each line to the model
     while True:
         line = input()
         if line.endswith("\\"):
@@ -104,69 +112,73 @@
     # if args.file is specified, read the file and set the prompt to the contents
     if args.file:
         with open(args.file, "r") as f:
             args.prompt = f.read().strip()
 
     # Add a space in front of the first character to match OG llama tokenizer behavior
     args.prompt = " " + args.prompt
+    
+    params = llamacpp.InferenceParams()
+    params.path_model = args.model
+    params.seed = args.seed
+    params.n_threads = args.n_threads
+
+    params.repeat_last_n = args.repeat_last_n
+    params.n_batch = args.n_batch
+    params.top_k = args.top_k
+    params.top_p = args.top_p
+    params.temp = args.temp
+    params.repeat_penalty = args.repeat_penalty
+    params.use_mlock = args.use_mlock
+    params.memory_f16 = args.memory_f16
+    params.n_ctx = args.n_ctx
 
-    # Initialize the gpt_params object
-    params = llamacpp.gpt_params(
-        args.model,
-        args.ctx_size,
-        args.n_predict,
-        args.top_k,
-        args.top_p,
-        args.temp,
-        args.repeat_penalty,
-        args.seed,
-        args.threads,
-        args.repeat_last_n,
-        args.batch_size,
-    )
-
-    model = llamacpp.PyLLAMA(params)
-    model.add_bos()
+    model = llamacpp.LlamaInference(params)
+    model.update_input([model.token_bos()])
     model.update_input(args.prompt)
-    model.print_startup_stats()
-    model.prepare_context()
+    print(model.system_info())
 
     inp_pfx = model.tokenize("\n\n### Instruction:\n\n", True)
     inp_sfx = model.tokenize("\n\n### Response:\n\n", False)
 
     if args.instruct:
         args.interactive = True
-        args.antiprompt = "### Instruction:\n\n"
+        args.reverse_prompt = "### Instruction:\n\n"
 
     # Set antiprompt if we are in interactive mode
-    if args.antiprompt:
+    if args.reverse_prompt:
         args.interactive = True
-        model.set_antiprompt(args.antiprompt)
 
     if args.interactive:
         print("== Running in interactive mode. ==")
         print(" - Press Ctrl+C to interject at any time.")
         print(" - Press Return to return control to LLaMa.")
         print(" - If you want to submit another line, end your input in '\\'.")
         print()
         is_interacting = True
 
     input_noecho = False
     is_finished = False
 
-    while not model.is_finished():
+    print(args.prompt, end="")
+
+    n_output = 0
+    while n_output < args.n_predict:
         if model.has_unconsumed_input():
-            model.ingest_all_pending_input(not input_noecho)
+            model.ingest_all_pending_input()
             # # reset color to default if we there is no pending user input
             # if (!input_noecho && args.use_color) {
             #     printf(ANSI_COLOR_RESET);
             # }
         else:
-            text, is_finished = model.infer_text()
+            token = model.sample()
+            text = model.token_to_str(token)
             print(text, end="")
+            n_output += 1
+            is_finished = token == model.token_eos()
             input_noecho = False
 
         if args.interactive:
             if model.is_antiprompt_present():
                 # reverse prompt found
                 is_interacting = True
             if is_interacting:
@@ -198,9 +210,10 @@
 
 
 def run():
     # Parse params into a gpt_params object
     args = parse_args_into_params(sys.argv)
     return main(args)
 
+
 if __name__ == "__main__":
     sys.exit(run())
```

### Comparing `llamacpp-0.1.8/llamacpp/convert.py` & `llamacpp-0.1.9/src/llamacpp/convert.py`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/llamacpp/quantize.py` & `llamacpp-0.1.9/src/llamacpp/quantize.py`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/pyproject.toml` & `llamacpp-0.1.9/pyproject.toml`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 [build-system]
-requires = ["scikit-build-core>=0.2.1", "pybind11"]
+requires = ["scikit-build-core>=0.2.1", "pybind11>2.10"]
 build-backend = "scikit_build_core.build"
 
 [project]
 name = "llamacpp"
-version = "0.1.8"
+version = "0.1.9"
 description = "Python bindings for @ggerganov's llama.cpp"
 authors = [
     {name = "Thomas Antony", email= "mail@thomasantony.com"}
 ]
 license = {text = "MIT"}
 readme = "README.md"
 requires-python = ">=3.7"
```

### Comparing `llamacpp-0.1.8/src/PyLlama.cpp` & `llamacpp-0.1.9/src/PyLlama.cpp`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/.devops/tools.sh` & `llamacpp-0.1.9/vendor/llama.cpp/.devops/tools.sh`

 * *Files 15% similar despite different names*

```diff
@@ -12,19 +12,15 @@
 
 if [[ $arg1 == '--convert' || $arg1 == '-c' ]]; then
     python3 ./convert-pth-to-ggml.py $arg2
 elif [[ $arg1 == '--quantize' || $arg1 == '-q' ]]; then
     ./quantize $arg2
 elif [[ $arg1 == '--run' || $arg1 == '-r' ]]; then
     ./main $arg2
-elif [[ $arg1 == '--download' || $arg1 == '-d' ]]; then
-    python3 ./download-pth.py $arg2
 elif [[ $arg1 == '--all-in-one' || $arg1 == '-a' ]]; then
-    echo "Downloading model..."
-    python3 ./download-pth.py "$1" "$2"
     echo "Converting PTH to GGML..."
     for i in `ls $1/$2/ggml-model-f16.bin*`; do
         if [ -f "${i/f16/q4_0}" ]; then
             echo "Skip model quantization, it already exists: ${i/f16/q4_0}"
         else
             echo "Converting PTH to GGML: $i into ${i/f16/q4_0}..."
             ./quantize "$i" "${i/f16/q4_0}" 2
@@ -35,12 +31,10 @@
     echo "Available commands: "
     echo "  --run (-r): Run a model previously converted into ggml"
     echo "              ex: -m /models/7B/ggml-model-q4_0.bin -p \"Building a website can be done in 10 simple steps:\" -n 512"
     echo "  --convert (-c): Convert a llama model into ggml"
     echo "              ex: \"/models/7B/\" 1"
     echo "  --quantize (-q): Optimize with quantization process ggml"
     echo "              ex: \"/models/7B/ggml-model-f16.bin\" \"/models/7B/ggml-model-q4_0.bin\" 2"
-    echo "  --download (-d): Download original llama model from CDN: https://agi.gpt4.org/llama/"
-    echo "              ex: \"/models/\" 7B"
-    echo "  --all-in-one (-a): Execute --download, --convert & --quantize"
+    echo "  --all-in-one (-a): Execute --convert & --quantize"
     echo "              ex: \"/models/\" 7B"
 fi
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/.github/workflows/build.yml` & `llamacpp-0.1.9/vendor/llama.cpp/.github/workflows/build.yml`

 * *Files 18% similar despite different names*

```diff
@@ -4,18 +4,18 @@
   workflow_dispatch: # allows manual triggering
     inputs:
       create_release:
         description: 'Create new release'
         required: true
         type: boolean
   push:
-    paths: ['.github/workflows/**', 'CMakeLists.txt', 'Makefile', '**.h', '*.c', '**.cpp']
+    paths: ['.github/workflows/**', '**/CMakeLists.txt', '**/Makefile', '**/*.h', '**/*.c', '**/*.cpp']
   pull_request:
     types: [opened, synchronize, edited, reopened, review_requested, ready_for_review]
-    paths: ['CMakeLists.txt', 'Makefile', '**.h', '*.c', '**.cpp']
+    paths: ['**/CMakeLists.txt', '**/Makefile', '**/*.h', '**/*.c', '**/*.cpp']
 
 env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
 
 jobs:
   ubuntu-latest-make:
     runs-on: ubuntu-latest
@@ -37,28 +37,73 @@
           make
 
   ubuntu-latest-cmake:
     runs-on: ubuntu-latest
 
     steps:
       - name: Clone
+        id: checkout
         uses: actions/checkout@v1
 
       - name: Dependencies
+        id: depends
         run: |
           sudo apt-get update
           sudo apt-get install build-essential
 
       - name: Build
+        id: cmake_build
         run: |
           mkdir build
           cd build
           cmake ..
           cmake --build . --config Release
 
+      - name: Test
+        id: cmake_test
+        run: |
+          cd build
+          ctest --verbose
+
+  ubuntu-latest-cmake-sanitizer:
+    runs-on: ubuntu-latest
+
+    continue-on-error: true
+
+    strategy:
+      matrix:
+        sanitizer: [ADDRESS, THREAD, UNDEFINED]
+        build_type: [Debug, Release]
+        accelerate: [ON, OFF]
+
+    steps:
+      - name: Clone
+        id: checkout
+        uses: actions/checkout@v1
+
+      - name: Dependencies
+        id: depends
+        run: |
+          sudo apt-get update
+          sudo apt-get install build-essential
+
+      - name: Build
+        id: cmake_build
+        run: |
+          mkdir build
+          cd build
+          cmake .. -DLLAMA_SANITIZE_${{ matrix.sanitizer }}=ON -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DLLAMA_ACCELERATE=${{ matrix.accelerate }}
+          cmake --build . --config ${{ matrix.build_type }}
+
+      - name: Test
+        id: cmake_test
+        run: |
+          cd build
+          ctest --verbose
+
   macOS-latest-make:
     runs-on: macos-latest
 
     steps:
       - name: Clone
         id: checkout
         uses: actions/checkout@v1
@@ -74,74 +119,144 @@
           make
 
   macOS-latest-cmake:
     runs-on: macOS-latest
 
     steps:
       - name: Clone
+        id: checkout
         uses: actions/checkout@v1
 
       - name: Dependencies
+        id: depends
         run: |
           brew update
 
       - name: Build
+        id: cmake_build
         run: |
           mkdir build
           cd build
-          cmake ..
+          cmake -DLLAMA_AVX2=OFF ..
           cmake --build . --config Release
 
+      - name: Test
+        id: cmake_test
+        run: |
+          cd build
+          ctest --verbose
+
   windows-latest-cmake:
     runs-on: windows-latest
 
+    strategy:
+      matrix:
+        include:
+         - build: 'avx2'
+           defines: ''
+         - build: 'avx'
+           defines: '-DLLAMA_AVX2=OFF'
+         - build: 'avx512'
+           defines: '-DLLAMA_AVX512=ON'
+
     steps:
       - name: Clone
         id: checkout
         uses: actions/checkout@v1
 
       - name: Build
         id: cmake_build
         run: |
           mkdir build
           cd build
-          cmake ..
+          cmake .. ${{ matrix.defines }}
           cmake --build . --config Release
 
+      - name: Check AVX512F support
+        id: check_avx512f
+        if: ${{ matrix.build == 'avx512' }}
+        continue-on-error: true
+        run: |
+          echo "TODO: check avx512f"
+
+      - name: Test
+        id: cmake_test
+        if: ${{ matrix.build != 'avx512' || env.HAS_AVX512F == '1' }} # Test AVX-512 only when possible
+        run: |
+          cd build
+          ctest -C Release --verbose
+
       - name: Get commit hash
         id: commit
         if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
         uses: pr-mpt/actions-commit-hash@v2
 
       - name: Pack artifacts
         id: pack_artifacts
         if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
         run: |
-          7z a llama-${{ env.BRANCH_NAME }}-${{ steps.commit.outputs.short }}-bin-win-x64.zip .\build\Release\*
+          7z a llama-${{ env.BRANCH_NAME }}-${{ steps.commit.outputs.short }}-bin-win-${{ matrix.build }}-x64.zip .\build\bin\Release\*
+
+      - name: Upload artifacts
+        if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
+        uses: actions/upload-artifact@v3
+        with:
+          path: |
+            llama-${{ env.BRANCH_NAME }}-${{ steps.commit.outputs.short }}-bin-win-${{ matrix.build }}-x64.zip
+
+  release:
+    if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
+
+    runs-on: ubuntu-latest
+
+    needs:
+      - ubuntu-latest-make
+      - ubuntu-latest-cmake
+      - macOS-latest-make
+      - macOS-latest-cmake
+      - windows-latest-cmake
+
+    steps:
+      - name: Download artifacts
+        id: download-artifact
+        uses: actions/download-artifact@v3
+
+      - name: Get commit hash
+        id: commit
+        uses: pr-mpt/actions-commit-hash@v2
 
       - name: Create release
         id: create_release
-        if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
-        uses: zendesk/action-create-release@v1
+        uses: anzz1/action-create-release@v1
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         with:
           tag_name: ${{ env.BRANCH_NAME }}-${{ steps.commit.outputs.short }}
 
       - name: Upload release
         id: upload_release
-        if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
-        uses: actions/upload-release-asset@v1
-        env:
-          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
+        uses: actions/github-script@v3
         with:
-          upload_url: ${{ steps.create_release.outputs.upload_url }} 
-          asset_path: .\llama-${{ env.BRANCH_NAME }}-${{ steps.commit.outputs.short }}-bin-win-x64.zip
-          asset_name: llama-${{ env.BRANCH_NAME }}-${{ steps.commit.outputs.short }}-bin-win-x64.zip
-          asset_content_type: application/octet-stream
+          github-token: ${{secrets.GITHUB_TOKEN}}
+          script: |
+            const path = require('path');
+            const fs = require('fs');
+            const release_id = '${{ steps.create_release.outputs.id }}';
+            for (let file of await fs.readdirSync('./artifact')) {
+              if (path.extname(file) === '.zip') {
+                console.log('uploadReleaseAsset', file);
+                await github.repos.uploadReleaseAsset({
+                  owner: context.repo.owner,
+                  repo: context.repo.repo,
+                  release_id: release_id,
+                  name: file,
+                  data: await fs.readFileSync(`./artifact/${file}`)
+                });
+              }
+            }
 
 #  ubuntu-latest-gcc:
 #    runs-on: ubuntu-latest
 #
 #    strategy:
 #      matrix:
 #        build: [Debug, Release]
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/.github/workflows/docker.yml` & `llamacpp-0.1.9/vendor/llama.cpp/.github/workflows/docker.yml`

 * *Files 5% similar despite different names*

```diff
@@ -36,26 +36,28 @@
       - name: Set up Docker Buildx
         uses: docker/setup-buildx-action@v2
 
       - name: Log in to Docker Hub
         uses: docker/login-action@v2
         with:
           registry: ghcr.io
-          username: ${{ github.actor }}
+          username: ${{ github.repository_owner }}
           password: ${{ secrets.GITHUB_TOKEN }}
 
       - name: Build and push Docker image (versioned)
         if: github.event_name == 'push'
         uses: docker/build-push-action@v4
         with:
           context: .
           push: true
+          platforms: linux/amd64,linux/arm64
           tags: "ghcr.io/ggerganov/llama.cpp:${{ matrix.config.tag }}-${{ env.COMMIT_SHA }}"
           file: ${{ matrix.config.dockerfile }}
 
       - name: Build and push Docker image (tagged)
         uses: docker/build-push-action@v4
         with:
           context: .
           push: ${{ github.event_name == 'push' }}
+          platforms: linux/amd64,linux/arm64
           tags: "ghcr.io/ggerganov/llama.cpp:${{ matrix.config.tag }}"
           file: ${{ matrix.config.dockerfile }}
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/LICENSE` & `llamacpp-0.1.9/vendor/llama.cpp/LICENSE`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/README.md` & `llamacpp-0.1.9/vendor/llama.cpp/README.md`

 * *Files 14% similar despite different names*

```diff
@@ -1,26 +1,29 @@
 # llama.cpp
 
+![llama](https://user-images.githubusercontent.com/1991296/227761327-6d83e30e-2200-41a6-bfbb-f575231c54f4.png)
+
 [![Actions Status](https://github.com/ggerganov/llama.cpp/workflows/CI/badge.svg)](https://github.com/ggerganov/llama.cpp/actions)
 [![License: MIT](https://img.shields.io/badge/license-MIT-blue.svg)](https://opensource.org/licenses/MIT)
 
 Inference of [LLaMA](https://arxiv.org/abs/2302.13971) model in pure C/C++
 
 **Hot topics:**
 
-- [Added Alpaca support](https://github.com/ggerganov/llama.cpp#instruction-mode-with-alpaca)
+- [Roadmap (short-term)](https://github.com/ggerganov/llama.cpp/discussions/457)
+- New C-style API is now available: https://github.com/ggerganov/llama.cpp/pull/370
 - Cache input prompts for faster initialization: https://github.com/ggerganov/llama.cpp/issues/64
 - Create a `llama.cpp` logo: https://github.com/ggerganov/llama.cpp/issues/105
 
 ## Description
 
 The main goal is to run the model using 4-bit quantization on a MacBook
 
 - Plain C/C++ implementation without dependencies
-- Apple silicon first-class citizen - optimized via ARM NEON
+- Apple silicon first-class citizen - optimized via ARM NEON and Accelerate framework
 - AVX2 support for x86 architectures
 - Mixed F16 / F32 precision
 - 4-bit quantization support
 - Runs on the CPU
 
 This was [hacked in an evening](https://github.com/ggerganov/llama.cpp/issues/33#issuecomment-1465108022) - I have no idea if it works correctly.
 Please do not make conclusions about the models based on the results from this implementation.
@@ -171,39 +174,37 @@
 
 ### Interactive mode
 
 If you want a more ChatGPT-like experience, you can run in interactive mode by passing `-i` as a parameter.
 In this mode, you can always interrupt generation by pressing Ctrl+C and enter one or more lines of text which will be converted into tokens and appended to the current context. You can also specify a *reverse prompt* with the parameter `-r "reverse prompt string"`. This will result in user input being prompted whenever the exact tokens of the reverse prompt string are encountered in the generation. A typical use is to use a prompt which makes LLaMa emulate a chat between multiple users, say Alice and Bob, and pass `-r "Alice:"`.
 
 Here is an example few-shot interaction, invoked with the command
-```
-./main -m ./models/13B/ggml-model-q4_0.bin -n 256 --repeat_penalty 1.0 --color -i -r "User:" -f prompts/chat-with-bob.txt
 
+```bash
+# default arguments using 7B model
+./examples/chat.sh
+
+# advanced chat with 13B model
+./examples/chat-13B.sh
+
+# custom arguments using 13B model
+./main -m ./models/13B/ggml-model-q4_0.bin -n 256 --repeat_penalty 1.0 --color -i -r "User:" -f prompts/chat-with-bob.txt
 ```
+
 Note the use of `--color` to distinguish between user input and generated text.
 
 ![image](https://user-images.githubusercontent.com/1991296/224575029-2af3c7dc-5a65-4f64-a6bb-517a532aea38.png)
 
 ### Instruction mode with Alpaca
 
-First, download the `ggml` Alpaca model into the `./models` folder:
+1. First, download the `ggml` Alpaca model into the `./models` folder
+2. Run the `main` tool like this:
 
 ```
-# use one of these
-# NOTE: these are copied from the alpaca.cpp repo - not sure how long these will work
-# TODO: add a script to simplify the download
-curl -o ggml-alpaca-7b-q4.bin -C - https://gateway.estuary.tech/gw/ipfs/QmQ1bf2BTnYxq73MFJWu1B7bQ2UD6qG7D7YDCxhTndVkPC
-curl -o ggml-alpaca-7b-q4.bin -C - https://ipfs.io/ipfs/QmQ1bf2BTnYxq73MFJWu1B7bQ2UD6qG7D7YDCxhTndVkPC
-curl -o ggml-alpaca-7b-q4.bin -C - https://cloudflare-ipfs.com/ipfs/QmQ1bf2BTnYxq73MFJWu1B7bQ2UD6qG7D7YDCxhTndVkPC
-```
-
-Now run the `main` tool like this:
-
-```
-./main -m ./models/ggml-alpaca-7b-q4.bin --color -f ./prompts/alpaca.txt -ins
+./examples/alpaca.sh
 ```
 
 Sample run:
 
 ```
 == Running in interactive mode. ==
  - Press Ctrl+C to interject at any time.
@@ -212,19 +213,77 @@
 
  Below is an instruction that describes a task. Write a response that appropriately completes the request.
 
 > How many letters are there in the English alphabet?
 There 26 letters in the English Alphabet
 > What is the most common way of transportation in Amsterdam?
 The majority (54%) are using public transit. This includes buses, trams and metros with over 100 lines throughout the city which make it very accessible for tourists to navigate around town as well as locals who commute by tram or metro on a daily basis
-> List 5 words that start with "ca".                                                                       
+> List 5 words that start with "ca".
 cadaver, cauliflower, cabbage (vegetable), catalpa (tree) and Cailleach.
 > 
 ```
 
+### Obtaining and verifying the Facebook LLaMA original model and Stanford Alpaca model data
+
+- **Under no circumstances share IPFS, magnet links, or any other links to model downloads anywhere in this respository, including in issues, discussions or pull requests. They will be immediately deleted.**
+- The LLaMA models are officially distributed by Facebook and will **never** be provided through this repository. 
+- Refer to [Facebook's LLaMA repository](https://github.com/facebookresearch/llama/pull/73/files) if you need to request access to the model data.
+- Please verify the sha256 checksums of all downloaded model files to confirm that you have the correct model data files before creating an issue relating to your model files.
+- The following command will verify if you have all possible latest files in your self-installed `./models` subdirectory:
+
+  `sha256sum --ignore-missing -c SHA256SUMS` on Linux
+
+  or
+
+  `shasum -a 256 --ignore-missing -c SHA256SUMS` on macOS
+
+- If your issue is with model generation quality then please at least scan the following links and papers to understand the limitations of LLaMA models. This is especially important when choosing an appropriate model size and appreciating both the significant and subtle differences between LLaMA models and ChatGPT:
+  - LLaMA:
+    - [Introducing LLaMA: A foundational, 65-billion-parameter large language model](https://ai.facebook.com/blog/large-language-model-llama-meta-ai/)
+    - [LLaMA: Open and Efficient Foundation Language Models](https://arxiv.org/abs/2302.13971)
+  - GPT-3
+    - [Language Models are Few-Shot Learners](https://arxiv.org/abs/2005.14165)
+  - GPT-3.5 / InstructGPT / ChatGPT:
+    - [Aligning language models to follow instructions](https://openai.com/research/instruction-following)
+    - [Training language models to follow instructions with human feedback](https://arxiv.org/abs/2203.02155)
+    
+### Perplexity (Measuring model quality)
+
+You can use the `perplexity` example to measure perplexity over the given prompt.  For more background,
+see https://huggingface.co/docs/transformers/perplexity.  However, in general, lower perplexity is better for LLMs.
+
+#### Latest measurements
+
+The latest perplexity scores for the various model sizes and quantizations are being tracked in [discussion #406](https://github.com/ggerganov/llama.cpp/discussions/406).  `llama.cpp` is measuring very well
+compared to the baseline implementations.  Quantization has a small negative impact to quality, but, as you can see, running
+13B at q4_0 beats the 7B f16 model by a significant amount.
+
+All measurements are done against wikitext2 test dataset (https://paperswithcode.com/dataset/wikitext-2), with default options (512 length context).
+Note that the changing the context length will have a significant impact on perplexity (longer context = better perplexity).
+```
+Perplexity - model options
+5.5985 - 13B, q4_0
+5.9565 - 7B, f16
+6.3001 - 7B, q4_1
+6.5949 - 7B, q4_0
+6.5995 - 7B, q4_0, --memory_f16
+```
+
+#### How to run
+
+1. Download/extract: https://s3.amazonaws.com/research.metamind.io/wikitext/wikitext-2-raw-v1.zip?ref=salesforce-research
+2. Run `./perplexity -m models/7B/ggml-model-q4_0.bin -f wiki.test.raw`
+3. Output:
+```
+perplexity : calculating perplexity over 655 chunks
+24.43 seconds per pass - ETA 4.45 hours
+[1]4.5970,[2]5.1807,[3]6.0382,...
+```
+And after 4.45 hours, you will have the final perplexity.
+
 ### Android
 
 You can easily run `llama.cpp` on Android device with [termux](https://play.google.com/store/apps/details?id=com.termux).
 First, obtain the [Android NDK](https://developer.android.com/ndk) and then build with CMake:
 ```
 $ mkdir build-android
 $ cd build-android
@@ -265,32 +324,25 @@
 
 or with light image:
 
 ```bash
 docker run -v /llama/models:/models ghcr.io/ggerganov/llama.cpp:light -m /models/7B/ggml-model-q4_0.bin -p "Building a website can be done in 10 simple steps:" -n 512
 ```
 
-## Limitations
-
-- We don't know yet how much the quantization affects the quality of the generated text
-- Probably the token sampling can be improved
-- The Accelerate framework is actually currently unused since I found that for tensor shapes typical for the Decoder,
-  there is no benefit compared to the ARM_NEON intrinsics implementation. Of course, it's possible that I simply don't
-  know how to utilize it properly. But in any case, you can even disable it with `LLAMA_NO_ACCELERATE=1 make` and the
-  performance will be the same, since no BLAS calls are invoked by the current implementation
-
 ### Contributing
 
 - Contributors can open PRs
 - Collaborators can push to branches in the `llama.cpp` repo and merge PRs into the `master` branch
 - Collaborators will be invited based on contributions
 - Any help with managing issues and PRs is very appreciated!
 - Make sure to read this: [Inference at the edge](https://github.com/ggerganov/llama.cpp/discussions/205)
+- A bit of backstory for those who are interested: [Changelog podcast](https://changelog.com/podcast/532)
 
 ### Coding guidelines
 
 - Avoid adding third-party dependencies, extra files, extra headers, etc.
 - Always consider cross-compatibility with other operating systems and architectures
 - Avoid fancy looking modern STL constructs, use basic `for` loops, avoid templates, keep it simple
 - There are no strict rules for the code style, but try to follow the patterns in the code (indentation, spaces, etc.). Vertical alignment makes things more readable and easier to batch edit
 - Clean-up any trailing whitespaces, use 4 spaces indentation, brackets on same line, `void * ptr`, `int & a`
 - See [good first issues](https://github.com/ggerganov/llama.cpp/issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22) for tasks suitable for first contributions
+
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/convert-pth-to-ggml.py` & `llamacpp-0.1.9/vendor/llama.cpp/convert-pth-to-ggml.py`

 * *Files 12% similar despite different names*

```diff
@@ -6,33 +6,34 @@
 # For each variable, write the following:
 #   - Number of dimensions (int)
 #   - Name length (int)
 #   - Dimensions (int[n_dims])
 #   - Name (char[name_length])
 #   - Data (float[n_dims])
 #
-# By default, the bigger matrices are converted to 16-bit floats.
-# This can be disabled by adding the "use-f32" CLI argument.
-#
 # At the start of the ggml file we write the model parameters
 # and vocabulary.
 #
+
 import argparse
+import os
 import sys
 import json
 import struct
 import numpy as np
 import torch
+
 from sentencepiece import SentencePieceProcessor
 
 def parse_args():
 
     parser = argparse.ArgumentParser(description='Convert a LLaMA model checkpoint to a ggml compatible file')
-    parser.add_argument('dir_model', help='directory containing the model checkpoint')
-    parser.add_argument('ftype', type=int, choices=[0, 1], default=1, help='file type (0: float32, 1: float16)')
+    parser.add_argument('dir_model',  help='directory containing the model checkpoint')
+    parser.add_argument('ftype',      help='file type (0: float32, 1: float16)', type=int, choices=[0, 1], default=1)
+    parser.add_argument('vocab_only', help='only write vocab to file', type=int, default=0, nargs='?')
     return parser.parse_args()
 
 def get_n_parts(dim):
 
     mappings = {4096: 1, 5120: 2, 6656: 4, 8192: 8}
     n_parts = mappings.get(dim)
     if n_parts is None:
@@ -40,31 +41,38 @@
         sys.exit(1)
 
     print(f"n_parts = {n_parts}\n")
     return n_parts
 
 def load_hparams_and_tokenizer(dir_model):
 
+    # `dir_model` is something like `models/7B` or `models/7B/`.
+    # "tokenizer.model" is expected under model's parent dir.
+    # When `dir_model` is a symlink, f"{dir_model}/../tokenizer.model" would not be found.
+    # Let's use the model's parent dir directly.
+    model_parent_dir = os.path.dirname(os.path.normpath(dir_model))
+
     fname_hparams = f"{dir_model}/params.json"
-    fname_tokenizer = f"{dir_model}/../tokenizer.model"
+    fname_tokenizer = f"{model_parent_dir}/tokenizer.model"
 
     with open(fname_hparams, "r") as f:
         hparams = json.load(f)
         print(hparams)
 
     tokenizer = SentencePieceProcessor(fname_tokenizer)
     hparams.update({"vocab_size": tokenizer.vocab_size()})
 
     return hparams, tokenizer
 
 def write_header(fout, hparams, ftype):
 
     keys = ["vocab_size", "dim", "multiple_of", "n_heads", "n_layers"]
     values = [
-        0x67676d6c,  # magic: ggml in hex
+        0x67676d66,  # magic: ggmf in hex
+        1, # file version
         *[hparams[key] for key in keys],
         hparams["dim"] // hparams["n_heads"],  # rot (obsolete)
         ftype
     ]
     fout.write(struct.pack("i" * len(values), *values))
 
 def write_tokens(fout, tokenizer):
@@ -81,14 +89,15 @@
                 sys.exit(1)
             byte_value = int(piece[3:-1], 16)
             text = struct.pack("B", byte_value)
         else:
             text = tokenizer.id_to_piece(i).replace("\u2581", " ").encode("utf-8")
         fout.write(struct.pack("i", len(text)))
         fout.write(text)
+        fout.write(struct.pack("f", tokenizer.get_score(i)))
 
 def process_and_write_variables(fout, model, ftype):
 
     for name, datao in model.items():
 
         if name.endswith("freqs"):
             continue
@@ -121,28 +130,50 @@
 
     args = parse_args()
     dir_model = args.dir_model
     ftype = args.ftype
     ftype_str = ["f32", "f16"]
 
     hparams, tokenizer = load_hparams_and_tokenizer(dir_model)
+
+    print(args)
+
+    # if only writing vocab to file
+    if args.vocab_only:
+
+        fname_model = f"{dir_model}/consolidated.00.pth"
+        fname_out = f"{dir_model}/ggml-vocab.bin"
+
+        print(f"Extracting only the vocab from '{fname_model}'\n")
+
+
+        with open(fname_out, "wb") as fout:
+            write_header(fout, hparams, ftype)
+            write_tokens(fout, tokenizer)
+
+
+        print(f"Done. Output file: {fname_out}\n")
+
+        return
+
     n_parts = get_n_parts(hparams["dim"])
 
     for p in range(n_parts):
 
-        print(f"Processing part {p}\n")
+        print(f"Processing part {p+1} of {n_parts}\n")
 
         fname_model = f"{dir_model}/consolidated.0{p}.pth"
         fname_out = f"{dir_model}/ggml-model-{ftype_str[ftype]}.bin{'' if p == 0 else '.' + str(p)}"
 
         model = torch.load(fname_model, map_location="cpu")
 
         with open(fname_out, "wb") as fout:
             write_header(fout, hparams, ftype)
             write_tokens(fout, tokenizer)
             process_and_write_variables(fout, model, ftype)
 
         del model
+
         print(f"Done. Output file: {fname_out}, (part {p})\n")
 
 if __name__ == "__main__":
     main()
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/flake.lock` & `llamacpp-0.1.9/vendor/llama.cpp/flake.lock`

 * *Files identical despite different names*

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/flake.nix` & `llamacpp-0.1.9/vendor/llama.cpp/flake.nix`

 * *Files 10% similar despite different names*

```diff
@@ -24,20 +24,21 @@
             darwin.apple_sdk.frameworks.Accelerate
           ];
           cmakeFlags = with pkgs; lib.optionals (system == "aarch64-darwin") [
             "-DCMAKE_C_FLAGS=-D__ARM_FEATURE_DOTPROD=1"
           ];
           installPhase = ''
             mkdir -p $out/bin
-            mv llama $out/bin/llama
-            mv quantize $out/bin/quantize
+            mv bin/main $out/bin/llama
+            mv bin/quantize $out/bin/quantize
             echo "#!${llama-python}/bin/python" > $out/bin/convert-pth-to-ggml
             cat ${./convert-pth-to-ggml.py} >> $out/bin/convert-pth-to-ggml
             chmod +x $out/bin/convert-pth-to-ggml
           '';
+          meta.mainProgram = "llama";
         };
         devShells.default = pkgs.mkShell {
           packages = with pkgs; [
             cmake
             llama-python
           ] ++ lib.optionals stdenv.isDarwin [
             darwin.apple_sdk.frameworks.Accelerate
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/ggml.c` & `llamacpp-0.1.9/vendor/llama.cpp/ggml.c`

 * *Files 2% similar despite different names*

```diff
@@ -1,20766 +1,19945 @@
-00000000: 2369 6e63 6c75 6465 2022 6767 6d6c 2e68  #include "ggml.h
-00000010: 220a 0a23 6966 2064 6566 696e 6564 285f  "..#if defined(_
-00000020: 4d53 435f 5645 5229 207c 7c20 6465 6669  MSC_VER) || defi
-00000030: 6e65 6428 5f5f 4d49 4e47 5733 325f 5f29  ned(__MINGW32__)
-00000040: 0a23 696e 636c 7564 6520 3c6d 616c 6c6f  .#include <mallo
-00000050: 632e 683e 202f 2f20 7573 696e 6720 6d61  c.h> // using ma
-00000060: 6c6c 6f63 2e68 2077 6974 6820 4d53 432f  lloc.h with MSC/
-00000070: 4d49 4e47 570a 2365 6c69 6620 2164 6566  MINGW.#elif !def
-00000080: 696e 6564 285f 5f46 7265 6542 5344 5f5f  ined(__FreeBSD__
-00000090: 2920 2626 2021 6465 6669 6e65 6428 5f5f  ) && !defined(__
-000000a0: 4e65 7442 5344 5f5f 290a 2369 6e63 6c75  NetBSD__).#inclu
-000000b0: 6465 203c 616c 6c6f 6361 2e68 3e0a 2365  de <alloca.h>.#e
-000000c0: 6e64 6966 0a0a 2369 6e63 6c75 6465 203c  ndif..#include <
-000000d0: 6173 7365 7274 2e68 3e0a 2369 6e63 6c75  assert.h>.#inclu
-000000e0: 6465 203c 7469 6d65 2e68 3e0a 2369 6e63  de <time.h>.#inc
-000000f0: 6c75 6465 203c 6d61 7468 2e68 3e0a 2369  lude <math.h>.#i
-00000100: 6e63 6c75 6465 203c 7374 646c 6962 2e68  nclude <stdlib.h
-00000110: 3e0a 2369 6e63 6c75 6465 203c 7374 7269  >.#include <stri
-00000120: 6e67 2e68 3e0a 2369 6e63 6c75 6465 203c  ng.h>.#include <
-00000130: 7374 6469 6e74 2e68 3e0a 2369 6e63 6c75  stdint.h>.#inclu
-00000140: 6465 203c 7374 6469 6f2e 683e 0a23 696e  de <stdio.h>.#in
-00000150: 636c 7564 6520 3c66 6c6f 6174 2e68 3e0a  clude <float.h>.
-00000160: 0a2f 2f20 6966 2043 3939 202d 2073 7461  .// if C99 - sta
-00000170: 7469 635f 6173 7365 7274 2069 7320 6e6f  tic_assert is no
-00000180: 6f70 0a2f 2f20 7265 663a 2068 7474 7073  op.// ref: https
-00000190: 3a2f 2f73 7461 636b 6f76 6572 666c 6f77  ://stackoverflow
-000001a0: 2e63 6f6d 2f61 2f35 3339 3233 3738 352f  .com/a/53923785/
-000001b0: 3430 3339 3937 360a 2369 666e 6465 6620  4039976.#ifndef 
-000001c0: 7374 6174 6963 5f61 7373 6572 740a 2364  static_assert.#d
-000001d0: 6566 696e 6520 7374 6174 6963 5f61 7373  efine static_ass
-000001e0: 6572 7428 636f 6e64 2c20 6d73 6729 2073  ert(cond, msg) s
-000001f0: 7472 7563 7420 676c 6f62 616c 5f73 636f  truct global_sco
-00000200: 7065 5f6e 6f6f 705f 7472 6963 6b0a 2365  pe_noop_trick.#e
-00000210: 6e64 6966 0a0a 2369 6620 6465 6669 6e65  ndif..#if define
-00000220: 6420 5f4d 5343 5f56 4552 207c 7c20 6465  d _MSC_VER || de
-00000230: 6669 6e65 6428 5f5f 4d49 4e47 5733 325f  fined(__MINGW32_
-00000240: 5f29 0a0a 2369 6620 2164 6566 696e 6564  _)..#if !defined
-00000250: 285f 5f4d 494e 4757 3332 5f5f 290a 2369  (__MINGW32__).#i
-00000260: 6e63 6c75 6465 203c 5769 6e64 6f77 732e  nclude <Windows.
-00000270: 683e 0a23 656c 7365 0a2f 2f20 7265 663a  h>.#else.// ref:
-00000280: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-00000290: 636f 6d2f 6767 6572 6761 6e6f 762f 7768  com/ggerganov/wh
-000002a0: 6973 7065 722e 6370 702f 6973 7375 6573  isper.cpp/issues
-000002b0: 2f31 3638 0a23 696e 636c 7564 6520 3c77  /168.#include <w
-000002c0: 696e 646f 7773 2e68 3e0a 2369 6e63 6c75  indows.h>.#inclu
-000002d0: 6465 203c 6572 726e 6f2e 683e 0a23 656e  de <errno.h>.#en
-000002e0: 6469 660a 0a74 7970 6564 6566 2076 6f6c  dif..typedef vol
-000002f0: 6174 696c 6520 4c4f 4e47 2061 746f 6d69  atile LONG atomi
-00000300: 635f 696e 743b 0a74 7970 6564 6566 2061  c_int;.typedef a
-00000310: 746f 6d69 635f 696e 7420 6174 6f6d 6963  tomic_int atomic
-00000320: 5f62 6f6f 6c3b 0a0a 7374 6174 6963 2076  _bool;..static v
-00000330: 6f69 6420 6174 6f6d 6963 5f73 746f 7265  oid atomic_store
-00000340: 2861 746f 6d69 635f 696e 742a 2070 7472  (atomic_int* ptr
-00000350: 2c20 4c4f 4e47 2076 616c 2920 7b0a 2020  , LONG val) {.  
-00000360: 2020 496e 7465 726c 6f63 6b65 6445 7863    InterlockedExc
-00000370: 6861 6e67 6528 7074 722c 2076 616c 293b  hange(ptr, val);
-00000380: 0a7d 0a73 7461 7469 6320 4c4f 4e47 2061  .}.static LONG a
-00000390: 746f 6d69 635f 6c6f 6164 2861 746f 6d69  tomic_load(atomi
-000003a0: 635f 696e 742a 2070 7472 2920 7b0a 2020  c_int* ptr) {.  
-000003b0: 2020 7265 7475 726e 2049 6e74 6572 6c6f    return Interlo
-000003c0: 636b 6564 436f 6d70 6172 6545 7863 6861  ckedCompareExcha
-000003d0: 6e67 6528 7074 722c 2030 2c20 3029 3b0a  nge(ptr, 0, 0);.
+00000000: 2f2f 2044 6566 696e 6573 2043 4c4f 434b  // Defines CLOCK
+00000010: 5f4d 4f4e 4f54 4f4e 4943 2061 6e64 2061  _MONOTONIC and a
+00000020: 7370 7269 6e74 6620 6f6e 204c 696e 7578  sprintf on Linux
+00000030: 0a23 6465 6669 6e65 205f 474e 555f 534f  .#define _GNU_SO
+00000040: 5552 4345 0a0a 2369 6e63 6c75 6465 2022  URCE..#include "
+00000050: 6767 6d6c 2e68 220a 0a23 6966 2064 6566  ggml.h"..#if def
+00000060: 696e 6564 285f 4d53 435f 5645 5229 207c  ined(_MSC_VER) |
+00000070: 7c20 6465 6669 6e65 6428 5f5f 4d49 4e47  | defined(__MING
+00000080: 5733 325f 5f29 0a23 696e 636c 7564 6520  W32__).#include 
+00000090: 3c6d 616c 6c6f 632e 683e 202f 2f20 7573  <malloc.h> // us
+000000a0: 696e 6720 6d61 6c6c 6f63 2e68 2077 6974  ing malloc.h wit
+000000b0: 6820 4d53 432f 4d49 4e47 570a 2365 6c69  h MSC/MINGW.#eli
+000000c0: 6620 2164 6566 696e 6564 285f 5f46 7265  f !defined(__Fre
+000000d0: 6542 5344 5f5f 2920 2626 2021 6465 6669  eBSD__) && !defi
+000000e0: 6e65 6428 5f5f 4e65 7442 5344 5f5f 2920  ned(__NetBSD__) 
+000000f0: 2626 2021 6465 6669 6e65 6428 5f5f 4f70  && !defined(__Op
+00000100: 656e 4253 445f 5f29 0a23 696e 636c 7564  enBSD__).#includ
+00000110: 6520 3c61 6c6c 6f63 612e 683e 0a23 656e  e <alloca.h>.#en
+00000120: 6469 660a 0a23 696e 636c 7564 6520 3c61  dif..#include <a
+00000130: 7373 6572 742e 683e 0a23 696e 636c 7564  ssert.h>.#includ
+00000140: 6520 3c65 7272 6e6f 2e68 3e0a 2369 6e63  e <errno.h>.#inc
+00000150: 6c75 6465 203c 7469 6d65 2e68 3e0a 2369  lude <time.h>.#i
+00000160: 6e63 6c75 6465 203c 6d61 7468 2e68 3e0a  nclude <math.h>.
+00000170: 2369 6e63 6c75 6465 203c 7374 646c 6962  #include <stdlib
+00000180: 2e68 3e0a 2369 6e63 6c75 6465 203c 7374  .h>.#include <st
+00000190: 7269 6e67 2e68 3e0a 2369 6e63 6c75 6465  ring.h>.#include
+000001a0: 203c 7374 6469 6e74 2e68 3e0a 2369 6e63   <stdint.h>.#inc
+000001b0: 6c75 6465 203c 7374 6469 6f2e 683e 0a23  lude <stdio.h>.#
+000001c0: 696e 636c 7564 6520 3c66 6c6f 6174 2e68  include <float.h
+000001d0: 3e0a 0a2f 2f20 6966 2043 3939 202d 2073  >..// if C99 - s
+000001e0: 7461 7469 635f 6173 7365 7274 2069 7320  tatic_assert is 
+000001f0: 6e6f 6f70 0a2f 2f20 7265 663a 2068 7474  noop.// ref: htt
+00000200: 7073 3a2f 2f73 7461 636b 6f76 6572 666c  ps://stackoverfl
+00000210: 6f77 2e63 6f6d 2f61 2f35 3339 3233 3738  ow.com/a/5392378
+00000220: 352f 3430 3339 3937 360a 2369 666e 6465  5/4039976.#ifnde
+00000230: 6620 7374 6174 6963 5f61 7373 6572 740a  f static_assert.
+00000240: 2364 6566 696e 6520 7374 6174 6963 5f61  #define static_a
+00000250: 7373 6572 7428 636f 6e64 2c20 6d73 6729  ssert(cond, msg)
+00000260: 2073 7472 7563 7420 676c 6f62 616c 5f73   struct global_s
+00000270: 636f 7065 5f6e 6f6f 705f 7472 6963 6b0a  cope_noop_trick.
+00000280: 2365 6e64 6966 0a0a 2369 6620 6465 6669  #endif..#if defi
+00000290: 6e65 6420 5f4d 5343 5f56 4552 207c 7c20  ned _MSC_VER || 
+000002a0: 6465 6669 6e65 6428 5f5f 4d49 4e47 5733  defined(__MINGW3
+000002b0: 325f 5f29 0a0a 2369 6620 2164 6566 696e  2__)..#if !defin
+000002c0: 6564 285f 5f4d 494e 4757 3332 5f5f 290a  ed(__MINGW32__).
+000002d0: 2369 6e63 6c75 6465 203c 5769 6e64 6f77  #include <Window
+000002e0: 732e 683e 0a23 656c 7365 0a2f 2f20 7265  s.h>.#else.// re
+000002f0: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
+00000300: 622e 636f 6d2f 6767 6572 6761 6e6f 762f  b.com/ggerganov/
+00000310: 7768 6973 7065 722e 6370 702f 6973 7375  whisper.cpp/issu
+00000320: 6573 2f31 3638 0a23 696e 636c 7564 6520  es/168.#include 
+00000330: 3c77 696e 646f 7773 2e68 3e0a 2365 6e64  <windows.h>.#end
+00000340: 6966 0a0a 7479 7065 6465 6620 766f 6c61  if..typedef vola
+00000350: 7469 6c65 204c 4f4e 4720 6174 6f6d 6963  tile LONG atomic
+00000360: 5f69 6e74 3b0a 7479 7065 6465 6620 6174  _int;.typedef at
+00000370: 6f6d 6963 5f69 6e74 2061 746f 6d69 635f  omic_int atomic_
+00000380: 626f 6f6c 3b0a 0a73 7461 7469 6320 766f  bool;..static vo
+00000390: 6964 2061 746f 6d69 635f 7374 6f72 6528  id atomic_store(
+000003a0: 6174 6f6d 6963 5f69 6e74 2a20 7074 722c  atomic_int* ptr,
+000003b0: 204c 4f4e 4720 7661 6c29 207b 0a20 2020   LONG val) {.   
+000003c0: 2049 6e74 6572 6c6f 636b 6564 4578 6368   InterlockedExch
+000003d0: 616e 6765 2870 7472 2c20 7661 6c29 3b0a  ange(ptr, val);.
 000003e0: 7d0a 7374 6174 6963 204c 4f4e 4720 6174  }.static LONG at
-000003f0: 6f6d 6963 5f66 6574 6368 5f61 6464 2861  omic_fetch_add(a
-00000400: 746f 6d69 635f 696e 742a 2070 7472 2c20  tomic_int* ptr, 
-00000410: 4c4f 4e47 2069 6e63 2920 7b0a 2020 2020  LONG inc) {.    
-00000420: 7265 7475 726e 2049 6e74 6572 6c6f 636b  return Interlock
-00000430: 6564 4578 6368 616e 6765 4164 6428 7074  edExchangeAdd(pt
-00000440: 722c 2069 6e63 293b 0a7d 0a73 7461 7469  r, inc);.}.stati
-00000450: 6320 4c4f 4e47 2061 746f 6d69 635f 6665  c LONG atomic_fe
-00000460: 7463 685f 7375 6228 6174 6f6d 6963 5f69  tch_sub(atomic_i
-00000470: 6e74 2a20 7074 722c 204c 4f4e 4720 6465  nt* ptr, LONG de
-00000480: 6329 207b 0a20 2020 2072 6574 7572 6e20  c) {.    return 
-00000490: 6174 6f6d 6963 5f66 6574 6368 5f61 6464  atomic_fetch_add
-000004a0: 2870 7472 2c20 2d28 6465 6329 293b 0a7d  (ptr, -(dec));.}
-000004b0: 0a0a 7479 7065 6465 6620 4841 4e44 4c45  ..typedef HANDLE
-000004c0: 2070 7468 7265 6164 5f74 3b0a 0a74 7970   pthread_t;..typ
-000004d0: 6564 6566 2044 574f 5244 2074 6872 6561  edef DWORD threa
-000004e0: 645f 7265 745f 743b 0a73 7461 7469 6320  d_ret_t;.static 
-000004f0: 696e 7420 7074 6872 6561 645f 6372 6561  int pthread_crea
-00000500: 7465 2870 7468 7265 6164 5f74 2a20 6f75  te(pthread_t* ou
-00000510: 742c 2076 6f69 642a 2075 6e75 7365 642c  t, void* unused,
-00000520: 2074 6872 6561 645f 7265 745f 7428 2a66   thread_ret_t(*f
-00000530: 756e 6329 2876 6f69 642a 292c 2076 6f69  unc)(void*), voi
-00000540: 642a 2061 7267 2920 7b0a 2020 2020 4841  d* arg) {.    HA
-00000550: 4e44 4c45 2068 616e 646c 6520 3d20 4372  NDLE handle = Cr
-00000560: 6561 7465 5468 7265 6164 284e 554c 4c2c  eateThread(NULL,
-00000570: 2030 2c20 284c 5054 4852 4541 445f 5354   0, (LPTHREAD_ST
-00000580: 4152 545f 524f 5554 494e 4529 2066 756e  ART_ROUTINE) fun
-00000590: 632c 2061 7267 2c20 302c 204e 554c 4c29  c, arg, 0, NULL)
-000005a0: 3b0a 2020 2020 6966 2028 6861 6e64 6c65  ;.    if (handle
-000005b0: 203d 3d20 4e55 4c4c 290a 2020 2020 7b0a   == NULL).    {.
-000005c0: 2020 2020 2020 2020 7265 7475 726e 2045          return E
-000005d0: 4147 4149 4e3b 0a20 2020 207d 0a0a 2020  AGAIN;.    }..  
-000005e0: 2020 2a6f 7574 203d 2068 616e 646c 653b    *out = handle;
-000005f0: 0a20 2020 2072 6574 7572 6e20 303b 0a7d  .    return 0;.}
-00000600: 0a0a 7374 6174 6963 2069 6e74 2070 7468  ..static int pth
-00000610: 7265 6164 5f6a 6f69 6e28 7074 6872 6561  read_join(pthrea
-00000620: 645f 7420 7468 7265 6164 2c20 766f 6964  d_t thread, void
-00000630: 2a20 756e 7573 6564 2920 7b0a 2020 2020  * unused) {.    
-00000640: 7265 7475 726e 2028 696e 7429 2057 6169  return (int) Wai
-00000650: 7446 6f72 5369 6e67 6c65 4f62 6a65 6374  tForSingleObject
-00000660: 2874 6872 6561 642c 2049 4e46 494e 4954  (thread, INFINIT
-00000670: 4529 3b0a 7d0a 0a73 7461 7469 6320 696e  E);.}..static in
-00000680: 7420 7363 6865 645f 7969 656c 6420 2876  t sched_yield (v
-00000690: 6f69 6429 207b 0a20 2020 2053 6c65 6570  oid) {.    Sleep
-000006a0: 2028 3029 3b0a 2020 2020 7265 7475 726e   (0);.    return
-000006b0: 2030 3b0a 7d0a 2365 6c73 650a 2369 6e63   0;.}.#else.#inc
-000006c0: 6c75 6465 203c 7074 6872 6561 642e 683e  lude <pthread.h>
-000006d0: 0a23 696e 636c 7564 6520 3c73 7464 6174  .#include <stdat
-000006e0: 6f6d 6963 2e68 3e0a 0a74 7970 6564 6566  omic.h>..typedef
-000006f0: 2076 6f69 642a 2074 6872 6561 645f 7265   void* thread_re
-00000700: 745f 743b 0a23 656e 6469 660a 0a23 6966  t_t;.#endif..#if
-00000710: 6465 6620 5f5f 4841 494b 555f 5f0a 2364  def __HAIKU__.#d
-00000720: 6566 696e 6520 7374 6174 6963 5f61 7373  efine static_ass
-00000730: 6572 7428 636f 6e64 2c20 6d73 6729 205f  ert(cond, msg) _
-00000740: 5374 6174 6963 5f61 7373 6572 7428 636f  Static_assert(co
-00000750: 6e64 2c20 6d73 6729 0a23 656e 6469 660a  nd, msg).#endif.
-00000760: 0a2f 2a23 6465 6669 6e65 2047 474d 4c5f  ./*#define GGML_
-00000770: 5045 5246 2a2f 0a23 6465 6669 6e65 2047  PERF*/.#define G
-00000780: 474d 4c5f 4445 4255 4720 300a 2364 6566  GML_DEBUG 0.#def
-00000790: 696e 6520 4747 4d4c 5f47 454c 555f 4650  ine GGML_GELU_FP
-000007a0: 3136 0a23 6465 6669 6e65 2047 474d 4c5f  16.#define GGML_
-000007b0: 5349 4c55 5f46 5031 360a 0a23 6465 6669  SILU_FP16..#defi
-000007c0: 6e65 2047 474d 4c5f 534f 4654 5f4d 4158  ne GGML_SOFT_MAX
-000007d0: 5f55 4e52 4f4c 4c20 340a 2364 6566 696e  _UNROLL 4.#defin
-000007e0: 6520 4747 4d4c 5f56 4543 5f44 4f54 5f55  e GGML_VEC_DOT_U
-000007f0: 4e52 4f4c 4c20 2032 0a0a 2369 6664 6566  NROLL  2..#ifdef
-00000800: 2047 474d 4c5f 5553 455f 4143 4345 4c45   GGML_USE_ACCELE
-00000810: 5241 5445 0a2f 2f20 756e 636f 6d6d 656e  RATE.// uncommen
-00000820: 7420 746f 2075 7365 2076 4453 5020 666f  t to use vDSP fo
-00000830: 7220 736f 6674 206d 6178 2063 6f6d 7075  r soft max compu
-00000840: 7461 7469 6f6e 0a2f 2f20 6e6f 7465 3a20  tation.// note: 
-00000850: 6e6f 7420 7375 7265 2069 6620 6974 2069  not sure if it i
-00000860: 7320 6163 7475 616c 6c79 2066 6173 7465  s actually faste
-00000870: 720a 2f2f 2364 6566 696e 6520 4747 4d4c  r.//#define GGML
-00000880: 5f53 4f46 545f 4d41 585f 4143 4345 4c45  _SOFT_MAX_ACCELE
-00000890: 5241 5445 0a23 656e 6469 660a 0a23 6966  RATE.#endif..#if
-000008a0: 2055 494e 5450 5452 5f4d 4158 203d 3d20   UINTPTR_MAX == 
-000008b0: 3078 4646 4646 4646 4646 0a20 2020 2023  0xFFFFFFFF.    #
-000008c0: 6465 6669 6e65 2047 474d 4c5f 4d45 4d5f  define GGML_MEM_
-000008d0: 414c 4947 4e20 340a 2365 6c73 650a 2020  ALIGN 4.#else.  
-000008e0: 2020 2364 6566 696e 6520 4747 4d4c 5f4d    #define GGML_M
-000008f0: 454d 5f41 4c49 474e 2031 360a 2365 6e64  EM_ALIGN 16.#end
-00000900: 6966 0a0a 2364 6566 696e 6520 554e 5553  if..#define UNUS
-00000910: 4544 2878 2920 2876 6f69 6429 2878 290a  ED(x) (void)(x).
-00000920: 2364 6566 696e 6520 5357 4150 2878 2c20  #define SWAP(x, 
-00000930: 792c 2054 2920 646f 207b 2054 2053 5741  y, T) do { T SWA
-00000940: 5020 3d20 783b 2078 203d 2079 3b20 7920  P = x; x = y; y 
-00000950: 3d20 5357 4150 3b20 7d20 7768 696c 6520  = SWAP; } while 
-00000960: 2830 290a 0a23 6465 6669 6e65 2047 474d  (0)..#define GGM
-00000970: 4c5f 4153 5345 5254 2878 2920 5c0a 2020  L_ASSERT(x) \.  
-00000980: 2020 646f 207b 205c 0a20 2020 2020 2020    do { \.       
-00000990: 2069 6620 2821 2878 2929 207b 205c 0a20   if (!(x)) { \. 
-000009a0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-000009b0: 7466 2873 7464 6572 722c 2022 4747 4d4c  tf(stderr, "GGML
-000009c0: 5f41 5353 4552 543a 2025 733a 2564 3a20  _ASSERT: %s:%d: 
-000009d0: 2573 5c6e 222c 205f 5f46 494c 455f 5f2c  %s\n", __FILE__,
-000009e0: 205f 5f4c 494e 455f 5f2c 2023 7829 3b20   __LINE__, #x); 
-000009f0: 5c0a 2020 2020 2020 2020 2020 2020 6162  \.            ab
-00000a00: 6f72 7428 293b 205c 0a20 2020 2020 2020  ort(); \.       
-00000a10: 207d 205c 0a20 2020 207d 2077 6869 6c65   } \.    } while
-00000a20: 2028 3029 0a0a 2369 6664 6566 2047 474d   (0)..#ifdef GGM
-00000a30: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
-00000a40: 0a23 696e 636c 7564 6520 3c41 6363 656c  .#include <Accel
-00000a50: 6572 6174 652f 4163 6365 6c65 7261 7465  erate/Accelerate
-00000a60: 2e68 3e0a 2365 6c69 6620 4747 4d4c 5f55  .h>.#elif GGML_U
-00000a70: 5345 5f4f 5045 4e42 4c41 530a 2369 6e63  SE_OPENBLAS.#inc
-00000a80: 6c75 6465 203c 6362 6c61 732e 683e 0a23  lude <cblas.h>.#
-00000a90: 656e 6469 660a 0a23 756e 6465 6620 4d49  endif..#undef MI
-00000aa0: 4e0a 2375 6e64 6566 204d 4158 0a23 6465  N.#undef MAX.#de
-00000ab0: 6669 6e65 204d 494e 2861 2c20 6229 2028  fine MIN(a, b) (
-00000ac0: 2861 2920 3c20 2862 2920 3f20 2861 2920  (a) < (b) ? (a) 
-00000ad0: 3a20 2862 2929 0a23 6465 6669 6e65 204d  : (b)).#define M
-00000ae0: 4158 2861 2c20 6229 2028 2861 2920 3e20  AX(a, b) ((a) > 
-00000af0: 2862 2920 3f20 2861 2920 3a20 2862 2929  (b) ? (a) : (b))
-00000b00: 0a0a 2f2f 2066 6c6f 6174 696e 6720 706f  ..// floating po
-00000b10: 696e 7420 7479 7065 2075 7365 6420 746f  int type used to
-00000b20: 2061 6363 756d 756c 6174 6520 7375 6d73   accumulate sums
-00000b30: 0a74 7970 6564 6566 2064 6f75 626c 6520  .typedef double 
-00000b40: 6767 6d6c 5f66 6c6f 6174 3b0a 0a2f 2f20  ggml_float;..// 
-00000b50: 3136 2d62 6974 2066 6c6f 6174 0a2f 2f20  16-bit float.// 
-00000b60: 6f6e 2041 726d 2c20 7765 2075 7365 205f  on Arm, we use _
-00000b70: 5f66 7031 360a 2f2f 206f 6e20 7838 362c  _fp16.// on x86,
-00000b80: 2077 6520 7573 6520 7569 6e74 3136 5f74   we use uint16_t
-00000b90: 0a23 6966 6465 6620 5f5f 4152 4d5f 4e45  .#ifdef __ARM_NE
-00000ba0: 4f4e 0a0a 2f2f 2069 6620 5943 4d20 6361  ON..// if YCM ca
-00000bb0: 6e6e 6f74 2066 696e 6420 3c61 726d 5f6e  nnot find <arm_n
-00000bc0: 656f 6e2e 683e 2c20 6d61 6b65 2061 2073  eon.h>, make a s
-00000bd0: 796d 626f 6c69 6320 6c69 6e6b 2074 6f20  ymbolic link to 
-00000be0: 6974 2c20 666f 7220 6578 616d 706c 653a  it, for example:
-00000bf0: 0a2f 2f0a 2f2f 2020 2024 206c 6e20 2d73  .//.//   $ ln -s
-00000c00: 666e 202f 4c69 6272 6172 792f 4465 7665  fn /Library/Deve
-00000c10: 6c6f 7065 722f 436f 6d6d 616e 644c 696e  loper/CommandLin
-00000c20: 6554 6f6f 6c73 2f75 7372 2f6c 6962 2f63  eTools/usr/lib/c
-00000c30: 6c61 6e67 2f31 332e 312e 362f 696e 636c  lang/13.1.6/incl
-00000c40: 7564 652f 6172 6d5f 6e65 6f6e 2e68 202e  ude/arm_neon.h .
-00000c50: 2f73 7263 2f0a 2f2f 0a23 696e 636c 7564  /src/.//.#includ
-00000c60: 6520 3c61 726d 5f6e 656f 6e2e 683e 0a0a  e <arm_neon.h>..
-00000c70: 2364 6566 696e 6520 4747 4d4c 5f43 4f4d  #define GGML_COM
-00000c80: 5055 5445 5f46 5031 365f 544f 5f46 5033  PUTE_FP16_TO_FP3
-00000c90: 3228 7829 2028 7829 0a23 6465 6669 6e65  2(x) (x).#define
-00000ca0: 2047 474d 4c5f 434f 4d50 5554 455f 4650   GGML_COMPUTE_FP
-00000cb0: 3332 5f54 4f5f 4650 3136 2878 2920 2878  32_TO_FP16(x) (x
-00000cc0: 290a 0a23 6465 6669 6e65 2047 474d 4c5f  )..#define GGML_
-00000cd0: 4650 3136 5f54 4f5f 4650 3332 2878 2920  FP16_TO_FP32(x) 
-00000ce0: 2878 290a 2364 6566 696e 6520 4747 4d4c  (x).#define GGML
-00000cf0: 5f46 5033 325f 544f 5f46 5031 3628 7829  _FP32_TO_FP16(x)
-00000d00: 2028 7829 0a0a 2365 6c73 650a 0a23 6966   (x)..#else..#if
-00000d10: 6465 6620 5f5f 7761 736d 5f73 696d 6431  def __wasm_simd1
-00000d20: 3238 5f5f 0a23 696e 636c 7564 6520 3c77  28__.#include <w
-00000d30: 6173 6d5f 7369 6d64 3132 382e 683e 0a23  asm_simd128.h>.#
-00000d40: 656c 7365 0a23 6966 6465 6620 5f5f 504f  else.#ifdef __PO
-00000d50: 5745 5239 5f56 4543 544f 525f 5f0a 2369  WER9_VECTOR__.#i
-00000d60: 6e63 6c75 6465 203c 616c 7469 7665 632e  nclude <altivec.
-00000d70: 683e 0a23 756e 6465 6620 626f 6f6c 0a23  h>.#undef bool.#
-00000d80: 6465 6669 6e65 2062 6f6f 6c20 5f42 6f6f  define bool _Boo
-00000d90: 6c0a 2365 6c73 650a 2369 6e63 6c75 6465  l.#else.#include
-00000da0: 203c 696d 6d69 6e74 7269 6e2e 683e 0a23   <immintrin.h>.#
-00000db0: 656e 6469 660a 2365 6e64 6966 0a0a 2369  endif.#endif..#i
-00000dc0: 6664 6566 205f 5f46 3136 435f 5f0a 0a23  fdef __F16C__..#
-00000dd0: 6465 6669 6e65 2047 474d 4c5f 434f 4d50  define GGML_COMP
-00000de0: 5554 455f 4650 3136 5f54 4f5f 4650 3332  UTE_FP16_TO_FP32
-00000df0: 2878 2920 5f63 7674 7368 5f73 7328 7829  (x) _cvtsh_ss(x)
-00000e00: 0a23 6465 6669 6e65 2047 474d 4c5f 434f  .#define GGML_CO
-00000e10: 4d50 5554 455f 4650 3332 5f54 4f5f 4650  MPUTE_FP32_TO_FP
-00000e20: 3136 2878 2920 5f63 7674 7373 5f73 6828  16(x) _cvtss_sh(
-00000e30: 782c 2030 290a 0a23 656c 7365 0a0a 2f2f  x, 0)..#else..//
-00000e40: 2046 5031 3620 3c2d 3e20 4650 3332 0a2f   FP16 <-> FP32./
-00000e50: 2f20 7265 663a 2068 7474 7073 3a2f 2f67  / ref: https://g
-00000e60: 6974 6875 622e 636f 6d2f 4d61 7261 7479  ithub.com/Maraty
-00000e70: 737a 637a 612f 4650 3136 0a0a 7374 6174  szcza/FP16..stat
-00000e80: 6963 2069 6e6c 696e 6520 666c 6f61 7420  ic inline float 
-00000e90: 6670 3332 5f66 726f 6d5f 6269 7473 2875  fp32_from_bits(u
-00000ea0: 696e 7433 325f 7420 7729 207b 0a20 2020  int32_t w) {.   
-00000eb0: 2075 6e69 6f6e 207b 0a20 2020 2020 2020   union {.       
-00000ec0: 2075 696e 7433 325f 7420 6173 5f62 6974   uint32_t as_bit
-00000ed0: 733b 0a20 2020 2020 2020 2066 6c6f 6174  s;.        float
-00000ee0: 2061 735f 7661 6c75 653b 0a20 2020 207d   as_value;.    }
-00000ef0: 2066 7033 323b 0a20 2020 2066 7033 322e   fp32;.    fp32.
-00000f00: 6173 5f62 6974 7320 3d20 773b 0a20 2020  as_bits = w;.   
-00000f10: 2072 6574 7572 6e20 6670 3332 2e61 735f   return fp32.as_
-00000f20: 7661 6c75 653b 0a7d 0a0a 7374 6174 6963  value;.}..static
-00000f30: 2069 6e6c 696e 6520 7569 6e74 3332 5f74   inline uint32_t
-00000f40: 2066 7033 325f 746f 5f62 6974 7328 666c   fp32_to_bits(fl
-00000f50: 6f61 7420 6629 207b 0a09 756e 696f 6e20  oat f) {..union 
-00000f60: 7b0a 0909 666c 6f61 7420 6173 5f76 616c  {...float as_val
-00000f70: 7565 3b0a 0909 7569 6e74 3332 5f74 2061  ue;...uint32_t a
-00000f80: 735f 6269 7473 3b0a 097d 2066 7033 323b  s_bits;..} fp32;
-00000f90: 0a09 6670 3332 2e61 735f 7661 6c75 6520  ..fp32.as_value 
-00000fa0: 3d20 663b 0a09 7265 7475 726e 2066 7033  = f;..return fp3
-00000fb0: 322e 6173 5f62 6974 733b 0a7d 0a0a 7374  2.as_bits;.}..st
-00000fc0: 6174 6963 2069 6e6c 696e 6520 666c 6f61  atic inline floa
-00000fd0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f66  t ggml_compute_f
-00000fe0: 7031 365f 746f 5f66 7033 3228 6767 6d6c  p16_to_fp32(ggml
-00000ff0: 5f66 7031 365f 7420 6829 207b 0a20 2020  _fp16_t h) {.   
-00001000: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
-00001010: 7720 3d20 2875 696e 7433 325f 7429 2068  w = (uint32_t) h
-00001020: 203c 3c20 3136 3b0a 2020 2020 636f 6e73   << 16;.    cons
-00001030: 7420 7569 6e74 3332 5f74 2073 6967 6e20  t uint32_t sign 
-00001040: 3d20 7720 2620 5549 4e54 3332 5f43 2830  = w & UINT32_C(0
-00001050: 7838 3030 3030 3030 3029 3b0a 2020 2020  x80000000);.    
-00001060: 636f 6e73 7420 7569 6e74 3332 5f74 2074  const uint32_t t
-00001070: 776f 5f77 203d 2077 202b 2077 3b0a 0a20  wo_w = w + w;.. 
-00001080: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-00001090: 7420 6578 705f 6f66 6673 6574 203d 2055  t exp_offset = U
-000010a0: 494e 5433 325f 4328 3078 4530 2920 3c3c  INT32_C(0xE0) <<
-000010b0: 2032 333b 0a23 6966 2064 6566 696e 6564   23;.#if defined
-000010c0: 285f 5f53 5444 435f 5645 5253 494f 4e5f  (__STDC_VERSION_
-000010d0: 5f29 2026 2620 285f 5f53 5444 435f 5645  _) && (__STDC_VE
-000010e0: 5253 494f 4e5f 5f20 3e3d 2031 3939 3930  RSION__ >= 19990
-000010f0: 314c 2920 7c7c 2064 6566 696e 6564 285f  1L) || defined(_
-00001100: 5f47 4e55 435f 5f29 2026 2620 2164 6566  _GNUC__) && !def
-00001110: 696e 6564 285f 5f53 5452 4943 545f 414e  ined(__STRICT_AN
-00001120: 5349 5f5f 290a 2020 2020 636f 6e73 7420  SI__).    const 
-00001130: 666c 6f61 7420 6578 705f 7363 616c 6520  float exp_scale 
-00001140: 3d20 3078 312e 3070 2d31 3132 663b 0a23  = 0x1.0p-112f;.#
-00001150: 656c 7365 0a20 2020 2063 6f6e 7374 2066  else.    const f
-00001160: 6c6f 6174 2065 7870 5f73 6361 6c65 203d  loat exp_scale =
-00001170: 2066 7033 325f 6672 6f6d 5f62 6974 7328   fp32_from_bits(
-00001180: 5549 4e54 3332 5f43 2830 7837 3830 3030  UINT32_C(0x78000
-00001190: 3030 2929 3b0a 2365 6e64 6966 0a20 2020  00));.#endif.   
-000011a0: 2063 6f6e 7374 2066 6c6f 6174 206e 6f72   const float nor
-000011b0: 6d61 6c69 7a65 645f 7661 6c75 6520 3d20  malized_value = 
-000011c0: 6670 3332 5f66 726f 6d5f 6269 7473 2828  fp32_from_bits((
-000011d0: 7477 6f5f 7720 3e3e 2034 2920 2b20 6578  two_w >> 4) + ex
-000011e0: 705f 6f66 6673 6574 2920 2a20 6578 705f  p_offset) * exp_
-000011f0: 7363 616c 653b 0a0a 2020 2020 636f 6e73  scale;..    cons
-00001200: 7420 7569 6e74 3332 5f74 206d 6167 6963  t uint32_t magic
-00001210: 5f6d 6173 6b20 3d20 5549 4e54 3332 5f43  _mask = UINT32_C
-00001220: 2831 3236 2920 3c3c 2032 333b 0a20 2020  (126) << 23;.   
-00001230: 2063 6f6e 7374 2066 6c6f 6174 206d 6167   const float mag
-00001240: 6963 5f62 6961 7320 3d20 302e 3566 3b0a  ic_bias = 0.5f;.
-00001250: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00001260: 6465 6e6f 726d 616c 697a 6564 5f76 616c  denormalized_val
-00001270: 7565 203d 2066 7033 325f 6672 6f6d 5f62  ue = fp32_from_b
-00001280: 6974 7328 2874 776f 5f77 203e 3e20 3137  its((two_w >> 17
-00001290: 2920 7c20 6d61 6769 635f 6d61 736b 2920  ) | magic_mask) 
-000012a0: 2d20 6d61 6769 635f 6269 6173 3b0a 0a20  - magic_bias;.. 
-000012b0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-000012c0: 7420 6465 6e6f 726d 616c 697a 6564 5f63  t denormalized_c
-000012d0: 7574 6f66 6620 3d20 5549 4e54 3332 5f43  utoff = UINT32_C
-000012e0: 2831 2920 3c3c 2032 373b 0a20 2020 2063  (1) << 27;.    c
-000012f0: 6f6e 7374 2075 696e 7433 325f 7420 7265  onst uint32_t re
-00001300: 7375 6c74 203d 2073 6967 6e20 7c0a 2020  sult = sign |.  
-00001310: 2020 2020 2020 2874 776f 5f77 203c 2064        (two_w < d
-00001320: 656e 6f72 6d61 6c69 7a65 645f 6375 746f  enormalized_cuto
-00001330: 6666 203f 2066 7033 325f 746f 5f62 6974  ff ? fp32_to_bit
-00001340: 7328 6465 6e6f 726d 616c 697a 6564 5f76  s(denormalized_v
-00001350: 616c 7565 2920 3a20 6670 3332 5f74 6f5f  alue) : fp32_to_
-00001360: 6269 7473 286e 6f72 6d61 6c69 7a65 645f  bits(normalized_
-00001370: 7661 6c75 6529 293b 0a20 2020 2072 6574  value));.    ret
-00001380: 7572 6e20 6670 3332 5f66 726f 6d5f 6269  urn fp32_from_bi
-00001390: 7473 2872 6573 756c 7429 3b0a 7d0a 0a73  ts(result);.}..s
-000013a0: 7461 7469 6320 696e 6c69 6e65 2067 676d  tatic inline ggm
-000013b0: 6c5f 6670 3136 5f74 2067 676d 6c5f 636f  l_fp16_t ggml_co
-000013c0: 6d70 7574 655f 6670 3332 5f74 6f5f 6670  mpute_fp32_to_fp
-000013d0: 3136 2866 6c6f 6174 2066 2920 7b0a 2369  16(float f) {.#i
-000013e0: 6620 6465 6669 6e65 6428 5f5f 5354 4443  f defined(__STDC
-000013f0: 5f56 4552 5349 4f4e 5f5f 2920 2626 2028  _VERSION__) && (
-00001400: 5f5f 5354 4443 5f56 4552 5349 4f4e 5f5f  __STDC_VERSION__
-00001410: 203e 3d20 3139 3939 3031 4c29 207c 7c20   >= 199901L) || 
-00001420: 6465 6669 6e65 6428 5f5f 474e 5543 5f5f  defined(__GNUC__
-00001430: 2920 2626 2021 6465 6669 6e65 6428 5f5f  ) && !defined(__
-00001440: 5354 5249 4354 5f41 4e53 495f 5f29 0a20  STRICT_ANSI__). 
-00001450: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
-00001460: 6361 6c65 5f74 6f5f 696e 6620 3d20 3078  cale_to_inf = 0x
-00001470: 312e 3070 2b31 3132 663b 0a20 2020 2063  1.0p+112f;.    c
-00001480: 6f6e 7374 2066 6c6f 6174 2073 6361 6c65  onst float scale
-00001490: 5f74 6f5f 7a65 726f 203d 2030 7831 2e30  _to_zero = 0x1.0
-000014a0: 702d 3131 3066 3b0a 2365 6c73 650a 2020  p-110f;.#else.  
-000014b0: 2020 636f 6e73 7420 666c 6f61 7420 7363    const float sc
-000014c0: 616c 655f 746f 5f69 6e66 203d 2066 7033  ale_to_inf = fp3
-000014d0: 325f 6672 6f6d 5f62 6974 7328 5549 4e54  2_from_bits(UINT
-000014e0: 3332 5f43 2830 7837 3738 3030 3030 3029  32_C(0x77800000)
-000014f0: 293b 0a20 2020 2063 6f6e 7374 2066 6c6f  );.    const flo
-00001500: 6174 2073 6361 6c65 5f74 6f5f 7a65 726f  at scale_to_zero
-00001510: 203d 2066 7033 325f 6672 6f6d 5f62 6974   = fp32_from_bit
-00001520: 7328 5549 4e54 3332 5f43 2830 7830 3838  s(UINT32_C(0x088
-00001530: 3030 3030 3029 293b 0a23 656e 6469 660a  00000));.#endif.
-00001540: 2020 2020 666c 6f61 7420 6261 7365 203d      float base =
-00001550: 2028 6661 6273 6628 6629 202a 2073 6361   (fabsf(f) * sca
-00001560: 6c65 5f74 6f5f 696e 6629 202a 2073 6361  le_to_inf) * sca
-00001570: 6c65 5f74 6f5f 7a65 726f 3b0a 0a20 2020  le_to_zero;..   
-00001580: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
-00001590: 7720 3d20 6670 3332 5f74 6f5f 6269 7473  w = fp32_to_bits
-000015a0: 2866 293b 0a20 2020 2063 6f6e 7374 2075  (f);.    const u
-000015b0: 696e 7433 325f 7420 7368 6c31 5f77 203d  int32_t shl1_w =
-000015c0: 2077 202b 2077 3b0a 2020 2020 636f 6e73   w + w;.    cons
-000015d0: 7420 7569 6e74 3332 5f74 2073 6967 6e20  t uint32_t sign 
-000015e0: 3d20 7720 2620 5549 4e54 3332 5f43 2830  = w & UINT32_C(0
-000015f0: 7838 3030 3030 3030 3029 3b0a 2020 2020  x80000000);.    
-00001600: 7569 6e74 3332 5f74 2062 6961 7320 3d20  uint32_t bias = 
-00001610: 7368 6c31 5f77 2026 2055 494e 5433 325f  shl1_w & UINT32_
-00001620: 4328 3078 4646 3030 3030 3030 293b 0a20  C(0xFF000000);. 
-00001630: 2020 2069 6620 2862 6961 7320 3c20 5549     if (bias < UI
-00001640: 4e54 3332 5f43 2830 7837 3130 3030 3030  NT32_C(0x7100000
-00001650: 3029 2920 7b0a 2020 2020 2020 2020 6269  0)) {.        bi
-00001660: 6173 203d 2055 494e 5433 325f 4328 3078  as = UINT32_C(0x
-00001670: 3731 3030 3030 3030 293b 0a20 2020 207d  71000000);.    }
-00001680: 0a0a 2020 2020 6261 7365 203d 2066 7033  ..    base = fp3
-00001690: 325f 6672 6f6d 5f62 6974 7328 2862 6961  2_from_bits((bia
-000016a0: 7320 3e3e 2031 2920 2b20 5549 4e54 3332  s >> 1) + UINT32
-000016b0: 5f43 2830 7830 3738 3030 3030 3029 2920  _C(0x07800000)) 
-000016c0: 2b20 6261 7365 3b0a 2020 2020 636f 6e73  + base;.    cons
-000016d0: 7420 7569 6e74 3332 5f74 2062 6974 7320  t uint32_t bits 
-000016e0: 3d20 6670 3332 5f74 6f5f 6269 7473 2862  = fp32_to_bits(b
-000016f0: 6173 6529 3b0a 2020 2020 636f 6e73 7420  ase);.    const 
-00001700: 7569 6e74 3332 5f74 2065 7870 5f62 6974  uint32_t exp_bit
-00001710: 7320 3d20 2862 6974 7320 3e3e 2031 3329  s = (bits >> 13)
-00001720: 2026 2055 494e 5433 325f 4328 3078 3030   & UINT32_C(0x00
-00001730: 3030 3743 3030 293b 0a20 2020 2063 6f6e  007C00);.    con
-00001740: 7374 2075 696e 7433 325f 7420 6d61 6e74  st uint32_t mant
-00001750: 6973 7361 5f62 6974 7320 3d20 6269 7473  issa_bits = bits
-00001760: 2026 2055 494e 5433 325f 4328 3078 3030   & UINT32_C(0x00
-00001770: 3030 3046 4646 293b 0a20 2020 2063 6f6e  000FFF);.    con
-00001780: 7374 2075 696e 7433 325f 7420 6e6f 6e73  st uint32_t nons
-00001790: 6967 6e20 3d20 6578 705f 6269 7473 202b  ign = exp_bits +
-000017a0: 206d 616e 7469 7373 615f 6269 7473 3b0a   mantissa_bits;.
-000017b0: 2020 2020 7265 7475 726e 2028 7369 676e      return (sign
-000017c0: 203e 3e20 3136 2920 7c20 2873 686c 315f   >> 16) | (shl1_
-000017d0: 7720 3e20 5549 4e54 3332 5f43 2830 7846  w > UINT32_C(0xF
-000017e0: 4630 3030 3030 3029 203f 2055 494e 5431  F000000) ? UINT1
-000017f0: 365f 4328 3078 3745 3030 2920 3a20 6e6f  6_C(0x7E00) : no
-00001800: 6e73 6967 6e29 3b0a 7d0a 0a23 6465 6669  nsign);.}..#defi
-00001810: 6e65 2047 474d 4c5f 434f 4d50 5554 455f  ne GGML_COMPUTE_
-00001820: 4650 3136 5f54 4f5f 4650 3332 2878 2920  FP16_TO_FP32(x) 
-00001830: 6767 6d6c 5f63 6f6d 7075 7465 5f66 7031  ggml_compute_fp1
-00001840: 365f 746f 5f66 7033 3228 7829 0a23 6465  6_to_fp32(x).#de
-00001850: 6669 6e65 2047 474d 4c5f 434f 4d50 5554  fine GGML_COMPUT
-00001860: 455f 4650 3332 5f54 4f5f 4650 3136 2878  E_FP32_TO_FP16(x
-00001870: 2920 6767 6d6c 5f63 6f6d 7075 7465 5f66  ) ggml_compute_f
-00001880: 7033 325f 746f 5f66 7031 3628 7829 0a0a  p32_to_fp16(x)..
-00001890: 2365 6e64 6966 202f 2f20 5f5f 4631 3643  #endif // __F16C
-000018a0: 5f5f 0a0a 2365 6e64 6966 202f 2f20 5f5f  __..#endif // __
-000018b0: 4152 4d5f 4e45 4f4e 0a0a 2f2f 0a2f 2f20  ARM_NEON..//.// 
-000018c0: 676c 6f62 616c 2064 6174 610a 2f2f 0a0a  global data.//..
-000018d0: 2f2f 2070 7265 636f 6d70 7574 6564 2067  // precomputed g
-000018e0: 656c 7520 7461 626c 6520 666f 7220 6631  elu table for f1
-000018f0: 3620 2831 3238 204b 4229 0a73 7461 7469  6 (128 KB).stati
-00001900: 6320 6767 6d6c 5f66 7031 365f 7420 7461  c ggml_fp16_t ta
-00001910: 626c 655f 6765 6c75 5f66 3136 5b31 203c  ble_gelu_f16[1 <
-00001920: 3c20 3136 5d3b 0a0a 2f2f 2070 7265 636f  < 16];..// preco
-00001930: 6d70 7574 6564 2073 696c 7520 7461 626c  mputed silu tabl
-00001940: 6520 666f 7220 6631 3620 2831 3238 204b  e for f16 (128 K
-00001950: 4229 0a73 7461 7469 6320 6767 6d6c 5f66  B).static ggml_f
-00001960: 7031 365f 7420 7461 626c 655f 7369 6c75  p16_t table_silu
-00001970: 5f66 3136 5b31 203c 3c20 3136 5d3b 0a0a  _f16[1 << 16];..
-00001980: 2f2f 2070 7265 636f 6d70 7574 6564 2065  // precomputed e
-00001990: 7870 2074 6162 6c65 2066 6f72 2066 3136  xp table for f16
-000019a0: 2028 3132 3820 4b42 290a 7374 6174 6963   (128 KB).static
-000019b0: 2067 676d 6c5f 6670 3136 5f74 2074 6162   ggml_fp16_t tab
-000019c0: 6c65 5f65 7870 5f66 3136 5b31 203c 3c20  le_exp_f16[1 << 
-000019d0: 3136 5d3b 0a0a 2f2f 2070 7265 636f 6d70  16];..// precomp
-000019e0: 7574 6564 2066 3332 2074 6162 6c65 2066  uted f32 table f
-000019f0: 6f72 2066 3136 2028 3235 3620 4b42 290a  or f16 (256 KB).
-00001a00: 7374 6174 6963 2066 6c6f 6174 2074 6162  static float tab
-00001a10: 6c65 5f66 3332 5f66 3136 5b31 203c 3c20  le_f32_f16[1 << 
-00001a20: 3136 5d3b 0a0a 2f2f 204f 6e20 4152 4d20  16];..// On ARM 
-00001a30: 4e45 4f4e 2c20 6974 2773 2071 7569 636b  NEON, it's quick
-00001a40: 6572 2074 6f20 6469 7265 6374 6c79 2063  er to directly c
-00001a50: 6f6e 7665 7274 2078 202d 3e20 7820 696e  onvert x -> x in
-00001a60: 7374 6561 6420 6f66 2063 616c 6c69 6e67  stead of calling
-00001a70: 2069 6e74 6f20 6767 6d6c 5f6c 6f6f 6b75   into ggml_looku
-00001a80: 705f 6670 3136 5f74 6f5f 6670 3332 2c0a  p_fp16_to_fp32,.
-00001a90: 2f2f 2073 6f20 7765 2064 6566 696e 6520  // so we define 
-00001aa0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-00001ab0: 3220 616e 6420 4747 4d4c 5f46 5033 325f  2 and GGML_FP32_
-00001ac0: 544f 5f46 5031 3620 656c 7365 7768 6572  TO_FP16 elsewher
-00001ad0: 6520 666f 7220 4e45 4f4e 2e0a 2369 6620  e for NEON..#if 
-00001ae0: 2164 6566 696e 6564 2847 474d 4c5f 4650  !defined(GGML_FP
-00001af0: 3136 5f54 4f5f 4650 3332 2920 7c7c 2021  16_TO_FP32) || !
-00001b00: 6465 6669 6e65 6428 4747 4d4c 5f46 5033  defined(GGML_FP3
-00001b10: 325f 544f 5f46 5031 3629 0a0a 696e 6c69  2_TO_FP16)..inli
-00001b20: 6e65 2073 7461 7469 6320 666c 6f61 7420  ne static float 
-00001b30: 6767 6d6c 5f6c 6f6f 6b75 705f 6670 3136  ggml_lookup_fp16
-00001b40: 5f74 6f5f 6670 3332 2867 676d 6c5f 6670  _to_fp32(ggml_fp
-00001b50: 3136 5f74 2066 2920 7b0a 2020 2020 7569  16_t f) {.    ui
-00001b60: 6e74 3136 5f74 2073 3b0a 2020 2020 6d65  nt16_t s;.    me
-00001b70: 6d63 7079 2826 732c 2026 662c 2073 697a  mcpy(&s, &f, siz
-00001b80: 656f 6628 7569 6e74 3136 5f74 2929 3b0a  eof(uint16_t));.
-00001b90: 2020 2020 7265 7475 726e 2074 6162 6c65      return table
-00001ba0: 5f66 3332 5f66 3136 5b73 5d3b 0a7d 0a0a  _f32_f16[s];.}..
-00001bb0: 2364 6566 696e 6520 4747 4d4c 5f46 5031  #define GGML_FP1
-00001bc0: 365f 544f 5f46 5033 3228 7829 2067 676d  6_TO_FP32(x) ggm
-00001bd0: 6c5f 6c6f 6f6b 7570 5f66 7031 365f 746f  l_lookup_fp16_to
-00001be0: 5f66 7033 3228 7829 0a23 6465 6669 6e65  _fp32(x).#define
-00001bf0: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
-00001c00: 3136 2878 2920 4747 4d4c 5f43 4f4d 5055  16(x) GGML_COMPU
-00001c10: 5445 5f46 5033 325f 544f 5f46 5031 3628  TE_FP32_TO_FP16(
-00001c20: 7829 0a0a 2365 6e64 6966 0a0a 2f2f 206e  x)..#endif..// n
-00001c30: 6f74 653a 2064 6f20 6e6f 7420 7573 6520  ote: do not use 
-00001c40: 7468 6573 6520 696e 7369 6465 2067 676d  these inside ggm
-00001c50: 6c2e 630a 2f2f 2074 6865 7365 2061 7265  l.c.// these are
-00001c60: 206d 6561 6e74 2074 6f20 6265 2075 7365   meant to be use
-00001c70: 6420 7669 6120 7468 6520 6767 6d6c 2e68  d via the ggml.h
-00001c80: 2041 5049 0a66 6c6f 6174 2067 676d 6c5f   API.float ggml_
-00001c90: 6670 3136 5f74 6f5f 6670 3332 2867 676d  fp16_to_fp32(ggm
-00001ca0: 6c5f 6670 3136 5f74 2078 2920 7b0a 2020  l_fp16_t x) {.  
-00001cb0: 2020 7265 7475 726e 2047 474d 4c5f 4650    return GGML_FP
-00001cc0: 3136 5f54 4f5f 4650 3332 2878 293b 0a7d  16_TO_FP32(x);.}
-00001cd0: 0a0a 6767 6d6c 5f66 7031 365f 7420 6767  ..ggml_fp16_t gg
-00001ce0: 6d6c 5f66 7033 325f 746f 5f66 7031 3628  ml_fp32_to_fp16(
-00001cf0: 666c 6f61 7420 7829 207b 0a20 2020 2072  float x) {.    r
-00001d00: 6574 7572 6e20 4747 4d4c 5f46 5033 325f  eturn GGML_FP32_
-00001d10: 544f 5f46 5031 3628 7829 3b0a 7d0a 0a2f  TO_FP16(x);.}../
-00001d20: 2f0a 2f2f 2074 696d 696e 670a 2f2f 0a0a  /.// timing.//..
-00001d30: 2369 6620 6465 6669 6e65 6428 5f4d 5343  #if defined(_MSC
-00001d40: 5f56 4552 2920 7c7c 2064 6566 696e 6564  _VER) || defined
-00001d50: 285f 5f4d 494e 4757 3332 5f5f 290a 7374  (__MINGW32__).st
-00001d60: 6174 6963 2069 6e74 3634 5f74 2074 696d  atic int64_t tim
-00001d70: 6572 5f66 7265 713b 0a76 6f69 6420 6767  er_freq;.void gg
-00001d80: 6d6c 5f74 696d 655f 696e 6974 2876 6f69  ml_time_init(voi
-00001d90: 6429 207b 0a20 2020 204c 4152 4745 5f49  d) {.    LARGE_I
-00001da0: 4e54 4547 4552 2066 7265 7175 656e 6379  NTEGER frequency
-00001db0: 3b0a 2020 2020 5175 6572 7950 6572 666f  ;.    QueryPerfo
-00001dc0: 726d 616e 6365 4672 6571 7565 6e63 7928  rmanceFrequency(
-00001dd0: 2666 7265 7175 656e 6379 293b 0a20 2020  &frequency);.   
-00001de0: 2074 696d 6572 5f66 7265 7120 3d20 6672   timer_freq = fr
-00001df0: 6571 7565 6e63 792e 5175 6164 5061 7274  equency.QuadPart
-00001e00: 3b0a 7d0a 696e 7436 345f 7420 6767 6d6c  ;.}.int64_t ggml
-00001e10: 5f74 696d 655f 6d73 2876 6f69 6429 207b  _time_ms(void) {
-00001e20: 0a20 2020 204c 4152 4745 5f49 4e54 4547  .    LARGE_INTEG
-00001e30: 4552 2074 3b0a 2020 2020 5175 6572 7950  ER t;.    QueryP
-00001e40: 6572 666f 726d 616e 6365 436f 756e 7465  erformanceCounte
-00001e50: 7228 2674 293b 0a20 2020 2072 6574 7572  r(&t);.    retur
-00001e60: 6e20 2874 2e51 7561 6450 6172 7420 2a20  n (t.QuadPart * 
-00001e70: 3130 3030 2920 2f20 7469 6d65 725f 6672  1000) / timer_fr
-00001e80: 6571 3b0a 7d0a 696e 7436 345f 7420 6767  eq;.}.int64_t gg
-00001e90: 6d6c 5f74 696d 655f 7573 2876 6f69 6429  ml_time_us(void)
-00001ea0: 207b 0a20 2020 204c 4152 4745 5f49 4e54   {.    LARGE_INT
-00001eb0: 4547 4552 2074 3b0a 2020 2020 5175 6572  EGER t;.    Quer
-00001ec0: 7950 6572 666f 726d 616e 6365 436f 756e  yPerformanceCoun
-00001ed0: 7465 7228 2674 293b 0a20 2020 2072 6574  ter(&t);.    ret
-00001ee0: 7572 6e20 2874 2e51 7561 6450 6172 7420  urn (t.QuadPart 
-00001ef0: 2a20 3130 3030 3030 3029 202f 2074 696d  * 1000000) / tim
-00001f00: 6572 5f66 7265 713b 0a7d 0a23 656c 7365  er_freq;.}.#else
-00001f10: 0a76 6f69 6420 6767 6d6c 5f74 696d 655f  .void ggml_time_
-00001f20: 696e 6974 2876 6f69 6429 207b 7d0a 696e  init(void) {}.in
-00001f30: 7436 345f 7420 6767 6d6c 5f74 696d 655f  t64_t ggml_time_
-00001f40: 6d73 2876 6f69 6429 207b 0a20 2020 2073  ms(void) {.    s
-00001f50: 7472 7563 7420 7469 6d65 7370 6563 2074  truct timespec t
-00001f60: 733b 0a20 2020 2063 6c6f 636b 5f67 6574  s;.    clock_get
-00001f70: 7469 6d65 2843 4c4f 434b 5f4d 4f4e 4f54  time(CLOCK_MONOT
-00001f80: 4f4e 4943 2c20 2674 7329 3b0a 2020 2020  ONIC, &ts);.    
-00001f90: 7265 7475 726e 2028 696e 7436 345f 7429  return (int64_t)
-00001fa0: 7473 2e74 765f 7365 632a 3130 3030 202b  ts.tv_sec*1000 +
-00001fb0: 2028 696e 7436 345f 7429 7473 2e74 765f   (int64_t)ts.tv_
-00001fc0: 6e73 6563 2f31 3030 3030 3030 3b0a 7d0a  nsec/1000000;.}.
-00001fd0: 0a69 6e74 3634 5f74 2067 676d 6c5f 7469  .int64_t ggml_ti
-00001fe0: 6d65 5f75 7328 766f 6964 2920 7b0a 2020  me_us(void) {.  
-00001ff0: 2020 7374 7275 6374 2074 696d 6573 7065    struct timespe
-00002000: 6320 7473 3b0a 2020 2020 636c 6f63 6b5f  c ts;.    clock_
-00002010: 6765 7474 696d 6528 434c 4f43 4b5f 4d4f  gettime(CLOCK_MO
-00002020: 4e4f 544f 4e49 432c 2026 7473 293b 0a20  NOTONIC, &ts);. 
-00002030: 2020 2072 6574 7572 6e20 2869 6e74 3634     return (int64
-00002040: 5f74 2974 732e 7476 5f73 6563 2a31 3030  _t)ts.tv_sec*100
-00002050: 3030 3030 202b 2028 696e 7436 345f 7429  0000 + (int64_t)
-00002060: 7473 2e74 765f 6e73 6563 2f31 3030 303b  ts.tv_nsec/1000;
-00002070: 0a7d 0a23 656e 6469 660a 0a69 6e74 3634  .}.#endif..int64
-00002080: 5f74 2067 676d 6c5f 6379 636c 6573 2876  _t ggml_cycles(v
-00002090: 6f69 6429 207b 0a20 2020 2072 6574 7572  oid) {.    retur
-000020a0: 6e20 636c 6f63 6b28 293b 0a7d 0a0a 696e  n clock();.}..in
-000020b0: 7436 345f 7420 6767 6d6c 5f63 7963 6c65  t64_t ggml_cycle
-000020c0: 735f 7065 725f 6d73 2876 6f69 6429 207b  s_per_ms(void) {
-000020d0: 0a20 2020 2072 6574 7572 6e20 434c 4f43  .    return CLOC
-000020e0: 4b53 5f50 4552 5f53 4543 2f31 3030 303b  KS_PER_SEC/1000;
-000020f0: 0a7d 0a0a 2369 6664 6566 2047 474d 4c5f  .}..#ifdef GGML_
-00002100: 5045 5246 0a23 6465 6669 6e65 2067 676d  PERF.#define ggm
-00002110: 6c5f 7065 7266 5f74 696d 655f 6d73 2829  l_perf_time_ms()
-00002120: 2020 2020 2020 2067 676d 6c5f 7469 6d65         ggml_time
-00002130: 5f6d 7328 290a 2364 6566 696e 6520 6767  _ms().#define gg
-00002140: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-00002150: 2920 2020 2020 2020 6767 6d6c 5f74 696d  )       ggml_tim
-00002160: 655f 7573 2829 0a23 6465 6669 6e65 2067  e_us().#define g
-00002170: 676d 6c5f 7065 7266 5f63 7963 6c65 7328  gml_perf_cycles(
-00002180: 2920 2020 2020 2020 2067 676d 6c5f 6379  )        ggml_cy
-00002190: 636c 6573 2829 0a23 6465 6669 6e65 2067  cles().#define g
-000021a0: 676d 6c5f 7065 7266 5f63 7963 6c65 735f  gml_perf_cycles_
-000021b0: 7065 725f 6d73 2829 2067 676d 6c5f 6379  per_ms() ggml_cy
-000021c0: 636c 6573 5f70 6572 5f6d 7328 290a 2365  cles_per_ms().#e
-000021d0: 6c73 650a 2364 6566 696e 6520 6767 6d6c  lse.#define ggml
-000021e0: 5f70 6572 665f 7469 6d65 5f6d 7328 2920  _perf_time_ms() 
-000021f0: 2020 2020 2020 300a 2364 6566 696e 6520        0.#define 
-00002200: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
-00002210: 7328 2920 2020 2020 2020 300a 2364 6566  s()       0.#def
-00002220: 696e 6520 6767 6d6c 5f70 6572 665f 6379  ine ggml_perf_cy
-00002230: 636c 6573 2829 2020 2020 2020 2020 300a  cles()        0.
-00002240: 2364 6566 696e 6520 6767 6d6c 5f70 6572  #define ggml_per
-00002250: 665f 6379 636c 6573 5f70 6572 5f6d 7328  f_cycles_per_ms(
-00002260: 2920 300a 2365 6e64 6966 0a0a 2f2f 0a2f  ) 0.#endif..//./
-00002270: 2f20 6361 6368 6520 6c69 6e65 0a2f 2f0a  / cache line.//.
-00002280: 0a23 6966 2064 6566 696e 6564 285f 5f63  .#if defined(__c
-00002290: 7070 5f6c 6962 5f68 6172 6477 6172 655f  pp_lib_hardware_
-000022a0: 696e 7465 7266 6572 656e 6365 5f73 697a  interference_siz
-000022b0: 6529 0a23 6465 6669 6e65 2043 4143 4845  e).#define CACHE
-000022c0: 5f4c 494e 455f 5349 5a45 2068 6172 6477  _LINE_SIZE hardw
-000022d0: 6172 655f 6465 7374 7275 6374 6976 655f  are_destructive_
-000022e0: 696e 7465 7266 6572 656e 6365 5f73 697a  interference_siz
-000022f0: 650a 2365 6c73 650a 2369 6620 6465 6669  e.#else.#if defi
-00002300: 6e65 6428 5f5f 504f 5745 5239 5f56 4543  ned(__POWER9_VEC
-00002310: 544f 525f 5f29 0a23 6465 6669 6e65 2043  TOR__).#define C
-00002320: 4143 4845 5f4c 494e 455f 5349 5a45 2031  ACHE_LINE_SIZE 1
-00002330: 3238 0a23 656c 7365 0a23 6465 6669 6e65  28.#else.#define
-00002340: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-00002350: 2036 340a 2365 6e64 6966 0a23 656e 6469   64.#endif.#endi
-00002360: 660a 0a73 7461 7469 6320 636f 6e73 7420  f..static const 
-00002370: 7369 7a65 5f74 2043 4143 4845 5f4c 494e  size_t CACHE_LIN
-00002380: 455f 5349 5a45 5f46 3332 203d 2043 4143  E_SIZE_F32 = CAC
-00002390: 4845 5f4c 494e 455f 5349 5a45 2f73 697a  HE_LINE_SIZE/siz
-000023a0: 656f 6628 666c 6f61 7429 3b0a 0a2f 2f0a  eof(float);..//.
-000023b0: 2f2f 2071 7561 6e74 697a 6174 696f 6e0a  // quantization.
-000023c0: 2f2f 0a0a 2364 6566 696e 6520 514b 2033  //..#define QK 3
-000023d0: 320a 0a2f 2f20 4156 5820 726f 7574 696e  2..// AVX routin
-000023e0: 6573 2070 726f 7669 6465 6420 6279 2047  es provided by G
-000023f0: 4820 7573 6572 2043 6f6e 7374 2d6d 650a  H user Const-me.
-00002400: 2f2f 2072 6566 3a20 6874 7470 733a 2f2f  // ref: https://
-00002410: 6769 7468 7562 2e63 6f6d 2f67 6765 7267  github.com/ggerg
-00002420: 616e 6f76 2f67 676d 6c2f 7075 6c6c 2f32  anov/ggml/pull/2
-00002430: 3723 6973 7375 6563 6f6d 6d65 6e74 2d31  7#issuecomment-1
-00002440: 3436 3439 3334 3630 300a 2369 6620 5f5f  464934600.#if __
-00002450: 4156 5832 5f5f 0a2f 2f20 556e 7061 636b  AVX2__.// Unpack
-00002460: 2033 3220 342d 6269 7420 6669 656c 6473   32 4-bit fields
-00002470: 2069 6e74 6f20 3332 2062 7974 6573 0a2f   into 32 bytes./
-00002480: 2f20 5468 6520 6f75 7470 7574 2076 6563  / The output vec
-00002490: 746f 7220 636f 6e74 6169 6e73 2033 3220  tor contains 32 
-000024a0: 6279 7465 732c 2065 6163 6820 6f6e 6520  bytes, each one 
-000024b0: 696e 205b 2030 202e 2e20 3135 205d 2069  in [ 0 .. 15 ] i
-000024c0: 6e74 6572 7661 6c0a 7374 6174 6963 2069  nterval.static i
-000024d0: 6e6c 696e 6520 5f5f 6d32 3536 6920 6279  nline __m256i by
-000024e0: 7465 7346 726f 6d4e 6962 626c 6573 2820  tesFromNibbles( 
-000024f0: 636f 6e73 7420 7569 6e74 385f 742a 2072  const uint8_t* r
-00002500: 7369 2029 0a7b 0a20 2020 202f 2f20 4c6f  si ).{.    // Lo
-00002510: 6164 2031 3620 6279 7465 7320 6672 6f6d  ad 16 bytes from
-00002520: 206d 656d 6f72 790a 2020 2020 5f5f 6d31   memory.    __m1
-00002530: 3238 6920 746d 7020 3d20 5f6d 6d5f 6c6f  28i tmp = _mm_lo
-00002540: 6164 755f 7369 3132 3828 2028 2063 6f6e  adu_si128( ( con
-00002550: 7374 205f 5f6d 3132 3869 2a20 2972 7369  st __m128i* )rsi
-00002560: 2029 3b0a 0a20 2020 202f 2f20 4578 7061   );..    // Expa
-00002570: 6e64 2062 7974 6573 2069 6e74 6f20 7569  nd bytes into ui
-00002580: 6e74 3136 5f74 2076 616c 7565 730a 2020  nt16_t values.  
-00002590: 2020 5f5f 6d32 3536 6920 6279 7465 7320    __m256i bytes 
-000025a0: 3d20 5f6d 6d32 3536 5f63 7674 6570 7538  = _mm256_cvtepu8
-000025b0: 5f65 7069 3136 2820 746d 7020 293b 0a0a  _epi16( tmp );..
-000025c0: 2020 2020 2f2f 2055 6e70 6163 6b20 7661      // Unpack va
-000025d0: 6c75 6573 2069 6e74 6f20 696e 6469 7669  lues into indivi
-000025e0: 6475 616c 2062 7974 6573 0a20 2020 2063  dual bytes.    c
-000025f0: 6f6e 7374 205f 5f6d 3235 3669 206c 6f77  onst __m256i low
-00002600: 4d61 736b 203d 205f 6d6d 3235 365f 7365  Mask = _mm256_se
-00002610: 7431 5f65 7069 3828 2030 7846 2029 3b0a  t1_epi8( 0xF );.
-00002620: 2020 2020 5f5f 6d32 3536 6920 6869 6768      __m256i high
-00002630: 203d 205f 6d6d 3235 365f 616e 646e 6f74   = _mm256_andnot
-00002640: 5f73 6932 3536 2820 6c6f 774d 6173 6b2c  _si256( lowMask,
-00002650: 2062 7974 6573 2029 3b0a 2020 2020 5f5f   bytes );.    __
-00002660: 6d32 3536 6920 6c6f 7720 3d20 5f6d 6d32  m256i low = _mm2
-00002670: 3536 5f61 6e64 5f73 6932 3536 2820 6c6f  56_and_si256( lo
-00002680: 774d 6173 6b2c 2062 7974 6573 2029 3b0a  wMask, bytes );.
-00002690: 2020 2020 6869 6768 203d 205f 6d6d 3235      high = _mm25
-000026a0: 365f 736c 6c69 5f65 7069 3136 2820 6869  6_slli_epi16( hi
-000026b0: 6768 2c20 3420 293b 0a20 2020 2062 7974  gh, 4 );.    byt
-000026c0: 6573 203d 205f 6d6d 3235 365f 6f72 5f73  es = _mm256_or_s
-000026d0: 6932 3536 2820 6c6f 772c 2068 6967 6820  i256( low, high 
-000026e0: 293b 0a20 2020 2072 6574 7572 6e20 6279  );.    return by
-000026f0: 7465 733b 0a7d 0a0a 7374 6174 6963 2069  tes;.}..static i
-00002700: 6e6c 696e 6520 5f5f 6d31 3238 6920 7061  nline __m128i pa
-00002710: 636b 4e69 6262 6c65 7328 205f 5f6d 3235  ckNibbles( __m25
-00002720: 3669 2062 7974 6573 2029 0a7b 0a20 2020  6i bytes ).{.   
-00002730: 202f 2f20 4d6f 7665 2062 6974 7320 7769   // Move bits wi
-00002740: 7468 696e 2031 362d 6269 7420 6c61 6e65  thin 16-bit lane
-00002750: 7320 6672 6f6d 2030 3030 305f 6162 6364  s from 0000_abcd
-00002760: 5f30 3030 305f 6566 6768 2069 6e74 6f20  _0000_efgh into 
-00002770: 3030 3030 5f30 3030 305f 6162 6364 5f65  0000_0000_abcd_e
-00002780: 6667 680a 2020 2020 636f 6e73 7420 5f5f  fgh.    const __
-00002790: 6d32 3536 6920 6c6f 7742 7974 6520 3d20  m256i lowByte = 
-000027a0: 5f6d 6d32 3536 5f73 6574 315f 6570 6931  _mm256_set1_epi1
-000027b0: 3628 2030 7846 4620 293b 0a20 2020 205f  6( 0xFF );.    _
-000027c0: 5f6d 3235 3669 2068 6967 6820 3d20 5f6d  _m256i high = _m
-000027d0: 6d32 3536 5f61 6e64 6e6f 745f 7369 3235  m256_andnot_si25
-000027e0: 3628 206c 6f77 4279 7465 2c20 6279 7465  6( lowByte, byte
-000027f0: 7320 293b 0a20 2020 205f 5f6d 3235 3669  s );.    __m256i
-00002800: 206c 6f77 203d 205f 6d6d 3235 365f 616e   low = _mm256_an
-00002810: 645f 7369 3235 3628 206c 6f77 4279 7465  d_si256( lowByte
-00002820: 2c20 6279 7465 7320 293b 0a20 2020 2068  , bytes );.    h
-00002830: 6967 6820 3d20 5f6d 6d32 3536 5f73 726c  igh = _mm256_srl
-00002840: 695f 6570 6931 3628 2068 6967 682c 2034  i_epi16( high, 4
-00002850: 2029 3b0a 2020 2020 6279 7465 7320 3d20   );.    bytes = 
-00002860: 5f6d 6d32 3536 5f6f 725f 7369 3235 3628  _mm256_or_si256(
-00002870: 206c 6f77 2c20 6869 6768 2029 3b0a 0a20   low, high );.. 
-00002880: 2020 202f 2f20 436f 6d70 7265 7373 2075     // Compress u
-00002890: 696e 7431 365f 7420 6c61 6e65 7320 696e  int16_t lanes in
-000028a0: 746f 2062 7974 6573 0a20 2020 205f 5f6d  to bytes.    __m
-000028b0: 3132 3869 2072 3020 3d20 5f6d 6d32 3536  128i r0 = _mm256
-000028c0: 5f63 6173 7473 6932 3536 5f73 6931 3238  _castsi256_si128
-000028d0: 2820 6279 7465 7320 293b 0a20 2020 205f  ( bytes );.    _
-000028e0: 5f6d 3132 3869 2072 3120 3d20 5f6d 6d32  _m128i r1 = _mm2
-000028f0: 3536 5f65 7874 7261 6374 6931 3238 5f73  56_extracti128_s
-00002900: 6932 3536 2820 6279 7465 732c 2031 2029  i256( bytes, 1 )
-00002910: 3b0a 2020 2020 7265 7475 726e 205f 6d6d  ;.    return _mm
-00002920: 5f70 6163 6b75 735f 6570 6931 3628 2072  _packus_epi16( r
-00002930: 302c 2072 3120 293b 0a7d 0a23 656e 6469  0, r1 );.}.#endi
-00002940: 660a 0a0a 2f2f 206d 6574 686f 6420 350a  f...// method 5.
-00002950: 2f2f 2062 6c6f 636b 7320 6f66 2051 4b20  // blocks of QK 
-00002960: 656c 656d 656e 7473 0a2f 2f20 7265 7072  elements.// repr
-00002970: 6573 656e 7465 6420 7769 7468 2061 2073  esented with a s
-00002980: 696e 676c 6520 666c 6f61 7420 2864 656c  ingle float (del
-00002990: 7461 2920 616e 6420 514b 2f32 2038 2d62  ta) and QK/2 8-b
-000029a0: 6974 2069 6e74 7320 2869 2e65 2051 4b20  it ints (i.e QK 
-000029b0: 342d 6269 7420 7369 676e 6564 2069 6e74  4-bit signed int
-000029c0: 6567 6572 2066 6163 746f 7273 290a 766f  eger factors).vo
-000029d0: 6964 2071 7561 6e74 697a 655f 726f 775f  id quantize_row_
-000029e0: 7134 5f30 2863 6f6e 7374 2066 6c6f 6174  q4_0(const float
-000029f0: 202a 2072 6573 7472 6963 7420 782c 2076   * restrict x, v
-00002a00: 6f69 6420 2a20 7265 7374 7269 6374 2079  oid * restrict y
-00002a10: 2c20 696e 7420 6b29 207b 0a20 2020 2061  , int k) {.    a
-00002a20: 7373 6572 7428 6b20 2520 514b 203d 3d20  ssert(k % QK == 
-00002a30: 3029 3b0a 0a20 2020 2063 6f6e 7374 2069  0);..    const i
-00002a40: 6e74 206e 6220 3d20 6b20 2f20 514b 3b0a  nt nb = k / QK;.
-00002a50: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00002a60: 2062 7320 3d20 7369 7a65 6f66 2866 6c6f   bs = sizeof(flo
-00002a70: 6174 2920 2b20 514b 2f32 3b0a 0a20 2020  at) + QK/2;..   
-00002a80: 2075 696e 7438 5f74 202a 2072 6573 7472   uint8_t * restr
-00002a90: 6963 7420 7064 203d 2028 2875 696e 7438  ict pd = ((uint8
-00002aa0: 5f74 202a 2979 202b 2030 2a62 7329 3b0a  _t *)y + 0*bs);.
-00002ab0: 2020 2020 7569 6e74 385f 7420 2a20 7265      uint8_t * re
-00002ac0: 7374 7269 6374 2070 6220 3d20 2828 7569  strict pb = ((ui
-00002ad0: 6e74 385f 7420 2a29 7920 2b20 302a 6273  nt8_t *)y + 0*bs
-00002ae0: 202b 2073 697a 656f 6628 666c 6f61 7429   + sizeof(float)
-00002af0: 293b 0a0a 2020 2020 7569 6e74 385f 7420  );..    uint8_t 
-00002b00: 7070 5b51 4b2f 325d 3b0a 0a23 6966 205f  pp[QK/2];..#if _
-00002b10: 5f41 524d 5f4e 454f 4e0a 2369 6620 514b  _ARM_NEON.#if QK
-00002b20: 203d 3d20 3332 0a20 2020 2066 6f72 2028   == 32.    for (
-00002b30: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00002b40: 623b 2069 2b2b 2920 7b0a 2020 2020 2020  b; i++) {.      
-00002b50: 2020 666c 6f61 7420 616d 6178 203d 2030    float amax = 0
-00002b60: 2e30 663b 202f 2f20 6162 736f 6c75 7465  .0f; // absolute
-00002b70: 206d 6178 0a0a 2020 2020 2020 2020 666c   max..        fl
-00002b80: 6f61 7433 3278 345f 7420 7372 6376 205b  oat32x4_t srcv [
-00002b90: 385d 3b0a 2020 2020 2020 2020 666c 6f61  8];.        floa
-00002ba0: 7433 3278 345f 7420 6173 7263 765b 385d  t32x4_t asrcv[8]
-00002bb0: 3b0a 2020 2020 2020 2020 666c 6f61 7433  ;.        float3
-00002bc0: 3278 345f 7420 616d 6178 765b 385d 3b0a  2x4_t amaxv[8];.
-00002bd0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-00002be0: 7420 6c20 3d20 303b 206c 203c 2038 3b20  t l = 0; l < 8; 
-00002bf0: 6c2b 2b29 2073 7263 765b 6c5d 2020 3d20  l++) srcv[l]  = 
-00002c00: 766c 6431 715f 6633 3228 7820 2b20 692a  vld1q_f32(x + i*
-00002c10: 3332 202b 2034 2a6c 293b 0a20 2020 2020  32 + 4*l);.     
-00002c20: 2020 2066 6f72 2028 696e 7420 6c20 3d20     for (int l = 
-00002c30: 303b 206c 203c 2038 3b20 6c2b 2b29 2061  0; l < 8; l++) a
-00002c40: 7372 6376 5b6c 5d20 3d20 7661 6273 715f  srcv[l] = vabsq_
-00002c50: 6633 3228 7372 6376 5b6c 5d29 3b0a 0a20  f32(srcv[l]);.. 
-00002c60: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00002c70: 6c20 3d20 303b 206c 203c 2034 3b20 6c2b  l = 0; l < 4; l+
-00002c80: 2b29 2061 6d61 7876 5b32 2a6c 5d20 3d20  +) amaxv[2*l] = 
-00002c90: 766d 6178 715f 6633 3228 6173 7263 765b  vmaxq_f32(asrcv[
-00002ca0: 322a 6c5d 2c20 6173 7263 765b 322a 6c2b  2*l], asrcv[2*l+
-00002cb0: 315d 293b 0a20 2020 2020 2020 2066 6f72  1]);.        for
-00002cc0: 2028 696e 7420 6c20 3d20 303b 206c 203c   (int l = 0; l <
-00002cd0: 2032 3b20 6c2b 2b29 2061 6d61 7876 5b34   2; l++) amaxv[4
-00002ce0: 2a6c 5d20 3d20 766d 6178 715f 6633 3228  *l] = vmaxq_f32(
-00002cf0: 616d 6178 765b 342a 6c5d 2c20 616d 6178  amaxv[4*l], amax
-00002d00: 765b 342a 6c2b 325d 293b 0a20 2020 2020  v[4*l+2]);.     
-00002d10: 2020 2066 6f72 2028 696e 7420 6c20 3d20     for (int l = 
-00002d20: 303b 206c 203c 2031 3b20 6c2b 2b29 2061  0; l < 1; l++) a
-00002d30: 6d61 7876 5b38 2a6c 5d20 3d20 766d 6178  maxv[8*l] = vmax
-00002d40: 715f 6633 3228 616d 6178 765b 382a 6c5d  q_f32(amaxv[8*l]
-00002d50: 2c20 616d 6178 765b 382a 6c2b 345d 293b  , amaxv[8*l+4]);
-00002d60: 0a0a 2020 2020 2020 2020 616d 6178 203d  ..        amax =
-00002d70: 204d 4158 280a 2020 2020 2020 2020 2020   MAX(.          
-00002d80: 2020 2020 2020 4d41 5828 7667 6574 715f        MAX(vgetq_
-00002d90: 6c61 6e65 5f66 3332 2861 6d61 7876 5b30  lane_f32(amaxv[0
-00002da0: 5d2c 2030 292c 2076 6765 7471 5f6c 616e  ], 0), vgetq_lan
-00002db0: 655f 6633 3228 616d 6178 765b 305d 2c20  e_f32(amaxv[0], 
-00002dc0: 3129 292c 0a20 2020 2020 2020 2020 2020  1)),.           
-00002dd0: 2020 2020 204d 4158 2876 6765 7471 5f6c       MAX(vgetq_l
-00002de0: 616e 655f 6633 3228 616d 6178 765b 305d  ane_f32(amaxv[0]
-00002df0: 2c20 3229 2c20 7667 6574 715f 6c61 6e65  , 2), vgetq_lane
-00002e00: 5f66 3332 2861 6d61 7876 5b30 5d2c 2033  _f32(amaxv[0], 3
-00002e10: 2929 293b 0a0a 2020 2020 2020 2020 636f  )));..        co
-00002e20: 6e73 7420 666c 6f61 7420 6420 3d20 616d  nst float d = am
-00002e30: 6178 202f 2028 2831 203c 3c20 3329 202d  ax / ((1 << 3) -
-00002e40: 2031 293b 0a20 2020 2020 2020 2063 6f6e   1);.        con
-00002e50: 7374 2066 6c6f 6174 2069 6420 3d20 6420  st float id = d 
-00002e60: 3f20 312e 302f 6420 3a20 302e 303b 0a0a  ? 1.0/d : 0.0;..
-00002e70: 2020 2020 2020 2020 2a28 666c 6f61 7420          *(float 
-00002e80: 2a29 7064 203d 2064 3b0a 2020 2020 2020  *)pd = d;.      
-00002e90: 2020 7064 202b 3d20 6273 3b0a 0a20 2020    pd += bs;..   
-00002ea0: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
-00002eb0: 3d20 303b 206c 203c 2038 3b20 6c2b 2b29  = 0; l < 8; l++)
-00002ec0: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
-00002ed0: 6f6e 7374 2066 6c6f 6174 3332 7834 5f74  onst float32x4_t
-00002ee0: 2076 2020 3d20 766d 756c 715f 6e5f 6633   v  = vmulq_n_f3
-00002ef0: 3228 7372 6376 5b6c 5d2c 2069 6429 3b0a  2(srcv[l], id);.
-00002f00: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00002f10: 7420 666c 6f61 7433 3278 345f 7420 7666  t float32x4_t vf
-00002f20: 203d 2076 6164 6471 5f66 3332 2876 2c20   = vaddq_f32(v, 
-00002f30: 7664 7570 715f 6e5f 6633 3228 382e 3566  vdupq_n_f32(8.5f
-00002f40: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-00002f50: 636f 6e73 7420 696e 7433 3278 345f 7420  const int32x4_t 
-00002f60: 2020 7669 203d 2076 6376 7471 5f73 3332    vi = vcvtq_s32
-00002f70: 5f66 3332 2876 6629 3b0a 0a20 2020 2020  _f32(vf);..     
-00002f80: 2020 2020 2020 2070 705b 322a 6c20 2b20         pp[2*l + 
-00002f90: 305d 203d 2076 6765 7471 5f6c 616e 655f  0] = vgetq_lane_
-00002fa0: 7333 3228 7669 2c20 3029 207c 2028 7667  s32(vi, 0) | (vg
-00002fb0: 6574 715f 6c61 6e65 5f73 3332 2876 692c  etq_lane_s32(vi,
-00002fc0: 2031 2920 3c3c 2034 293b 0a20 2020 2020   1) << 4);.     
-00002fd0: 2020 2020 2020 2070 705b 322a 6c20 2b20         pp[2*l + 
-00002fe0: 315d 203d 2076 6765 7471 5f6c 616e 655f  1] = vgetq_lane_
-00002ff0: 7333 3228 7669 2c20 3229 207c 2028 7667  s32(vi, 2) | (vg
-00003000: 6574 715f 6c61 6e65 5f73 3332 2876 692c  etq_lane_s32(vi,
-00003010: 2033 2920 3c3c 2034 293b 0a20 2020 2020   3) << 4);.     
-00003020: 2020 207d 0a0a 2020 2020 2020 2020 6d65     }..        me
-00003030: 6d63 7079 2870 622c 2070 702c 2073 697a  mcpy(pb, pp, siz
-00003040: 656f 6628 7070 2929 3b0a 2020 2020 2020  eof(pp));.      
-00003050: 2020 7062 202b 3d20 6273 3b0a 2020 2020    pb += bs;.    
-00003060: 7d0a 2365 6c73 650a 2365 7272 6f72 2022  }.#else.#error "
-00003070: 6e6f 7420 696d 706c 656d 656e 7465 6420  not implemented 
-00003080: 666f 7220 514b 220a 2365 6e64 6966 0a23  for QK".#endif.#
-00003090: 656c 6966 2064 6566 696e 6564 285f 5f41  elif defined(__A
-000030a0: 5658 325f 5f29 0a23 6966 2051 4b20 3d3d  VX2__).#if QK ==
-000030b0: 2033 320a 2020 2020 666f 7220 2869 6e74   32.    for (int
-000030c0: 2069 203d 2030 3b20 6920 3c20 6e62 3b20   i = 0; i < nb; 
-000030d0: 692b 2b29 207b 0a20 2020 2020 2020 202f  i++) {.        /
-000030e0: 2f20 4c6f 6164 2065 6c65 6d65 6e74 7320  / Load elements 
-000030f0: 696e 746f 2034 2041 5658 2076 6563 746f  into 4 AVX vecto
-00003100: 7273 0a20 2020 2020 2020 205f 5f6d 3235  rs.        __m25
-00003110: 3620 7630 203d 205f 6d6d 3235 365f 6c6f  6 v0 = _mm256_lo
-00003120: 6164 755f 7073 2820 7820 293b 0a20 2020  adu_ps( x );.   
-00003130: 2020 2020 205f 5f6d 3235 3620 7631 203d       __m256 v1 =
-00003140: 205f 6d6d 3235 365f 6c6f 6164 755f 7073   _mm256_loadu_ps
-00003150: 2820 7820 2b20 3820 293b 0a20 2020 2020  ( x + 8 );.     
-00003160: 2020 205f 5f6d 3235 3620 7632 203d 205f     __m256 v2 = _
-00003170: 6d6d 3235 365f 6c6f 6164 755f 7073 2820  mm256_loadu_ps( 
-00003180: 7820 2b20 3136 2029 3b0a 2020 2020 2020  x + 16 );.      
-00003190: 2020 5f5f 6d32 3536 2076 3320 3d20 5f6d    __m256 v3 = _m
-000031a0: 6d32 3536 5f6c 6f61 6475 5f70 7328 2078  m256_loadu_ps( x
-000031b0: 202b 2032 3420 293b 0a20 2020 2020 2020   + 24 );.       
-000031c0: 2078 202b 3d20 3332 3b0a 0a20 2020 2020   x += 32;..     
-000031d0: 2020 202f 2f20 436f 6d70 7574 6520 6d61     // Compute ma
-000031e0: 7828 6162 7328 6529 2920 666f 7220 7468  x(abs(e)) for th
-000031f0: 6520 626c 6f63 6b0a 2020 2020 2020 2020  e block.        
-00003200: 636f 6e73 7420 5f5f 6d32 3536 2073 6967  const __m256 sig
-00003210: 6e42 6974 203d 205f 6d6d 3235 365f 7365  nBit = _mm256_se
-00003220: 7431 5f70 7328 202d 302e 3066 2029 3b0a  t1_ps( -0.0f );.
-00003230: 2020 2020 2020 2020 5f5f 6d32 3536 206d          __m256 m
-00003240: 6178 4162 7320 3d20 5f6d 6d32 3536 5f61  axAbs = _mm256_a
-00003250: 6e64 6e6f 745f 7073 2820 7369 676e 4269  ndnot_ps( signBi
-00003260: 742c 2076 3020 293b 0a20 2020 2020 2020  t, v0 );.       
-00003270: 206d 6178 4162 7320 3d20 5f6d 6d32 3536   maxAbs = _mm256
-00003280: 5f6d 6178 5f70 7328 206d 6178 4162 732c  _max_ps( maxAbs,
-00003290: 205f 6d6d 3235 365f 616e 646e 6f74 5f70   _mm256_andnot_p
-000032a0: 7328 2073 6967 6e42 6974 2c20 7631 2029  s( signBit, v1 )
-000032b0: 2029 3b0a 2020 2020 2020 2020 6d61 7841   );.        maxA
-000032c0: 6273 203d 205f 6d6d 3235 365f 6d61 785f  bs = _mm256_max_
-000032d0: 7073 2820 6d61 7841 6273 2c20 5f6d 6d32  ps( maxAbs, _mm2
-000032e0: 3536 5f61 6e64 6e6f 745f 7073 2820 7369  56_andnot_ps( si
-000032f0: 676e 4269 742c 2076 3220 2920 293b 0a20  gnBit, v2 ) );. 
-00003300: 2020 2020 2020 206d 6178 4162 7320 3d20         maxAbs = 
-00003310: 5f6d 6d32 3536 5f6d 6178 5f70 7328 206d  _mm256_max_ps( m
-00003320: 6178 4162 732c 205f 6d6d 3235 365f 616e  axAbs, _mm256_an
-00003330: 646e 6f74 5f70 7328 2073 6967 6e42 6974  dnot_ps( signBit
-00003340: 2c20 7633 2029 2029 3b0a 0a20 2020 2020  , v3 ) );..     
-00003350: 2020 205f 5f6d 3132 3820 6d61 7834 203d     __m128 max4 =
-00003360: 205f 6d6d 5f6d 6178 5f70 7328 205f 6d6d   _mm_max_ps( _mm
-00003370: 3235 365f 6578 7472 6163 7466 3132 385f  256_extractf128_
-00003380: 7073 2820 6d61 7841 6273 2c20 3120 292c  ps( maxAbs, 1 ),
-00003390: 205f 6d6d 3235 365f 6361 7374 7073 3235   _mm256_castps25
-000033a0: 365f 7073 3132 3828 206d 6178 4162 7320  6_ps128( maxAbs 
-000033b0: 2920 293b 0a20 2020 2020 2020 206d 6178  ) );.        max
-000033c0: 3420 3d20 5f6d 6d5f 6d61 785f 7073 2820  4 = _mm_max_ps( 
-000033d0: 6d61 7834 2c20 5f6d 6d5f 6d6f 7665 686c  max4, _mm_movehl
-000033e0: 5f70 7328 206d 6178 342c 206d 6178 3420  _ps( max4, max4 
-000033f0: 2920 293b 0a20 2020 2020 2020 206d 6178  ) );.        max
-00003400: 3420 3d20 5f6d 6d5f 6d61 785f 7373 2820  4 = _mm_max_ss( 
-00003410: 6d61 7834 2c20 5f6d 6d5f 6d6f 7665 6864  max4, _mm_movehd
-00003420: 7570 5f70 7328 206d 6178 3420 2920 293b  up_ps( max4 ) );
-00003430: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-00003440: 6c6f 6174 206d 6178 5363 616c 6172 203d  loat maxScalar =
-00003450: 205f 6d6d 5f63 7674 7373 5f66 3332 2820   _mm_cvtss_f32( 
-00003460: 6d61 7834 2029 3b0a 0a20 2020 2020 2020  max4 );..       
-00003470: 202f 2f20 5175 616e 7469 7a65 2074 6865   // Quantize the
-00003480: 7365 2066 6c6f 6174 730a 2020 2020 2020  se floats.      
-00003490: 2020 636f 6e73 7420 666c 6f61 7420 6420    const float d 
-000034a0: 3d20 6d61 7853 6361 6c61 7220 2f20 372e  = maxScalar / 7.
-000034b0: 3066 3b0a 2020 2020 2020 2020 2a28 666c  0f;.        *(fl
-000034c0: 6f61 7420 2a29 7064 203d 2064 3b0a 2020  oat *)pd = d;.  
-000034d0: 2020 2020 2020 7064 202b 3d20 6273 3b0a        pd += bs;.
-000034e0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-000034f0: 6f61 7420 6964 203d 2028 206d 6178 5363  oat id = ( maxSc
-00003500: 616c 6172 2021 3d20 302e 3066 2029 203f  alar != 0.0f ) ?
-00003510: 2037 2e30 6620 2f20 6d61 7853 6361 6c61   7.0f / maxScala
-00003520: 7220 3a20 302e 3066 3b0a 2020 2020 2020  r : 0.0f;.      
-00003530: 2020 636f 6e73 7420 5f5f 6d32 3536 206d    const __m256 m
-00003540: 756c 203d 205f 6d6d 3235 365f 7365 7431  ul = _mm256_set1
-00003550: 5f70 7328 2069 6420 293b 0a0a 2020 2020  _ps( id );..    
-00003560: 2020 2020 2f2f 2041 7070 6c79 2074 6865      // Apply the
-00003570: 206d 756c 7469 706c 6965 720a 2020 2020   multiplier.    
-00003580: 2020 2020 7630 203d 205f 6d6d 3235 365f      v0 = _mm256_
-00003590: 6d75 6c5f 7073 2820 7630 2c20 6d75 6c20  mul_ps( v0, mul 
-000035a0: 293b 0a20 2020 2020 2020 2076 3120 3d20  );.        v1 = 
-000035b0: 5f6d 6d32 3536 5f6d 756c 5f70 7328 2076  _mm256_mul_ps( v
-000035c0: 312c 206d 756c 2029 3b0a 2020 2020 2020  1, mul );.      
-000035d0: 2020 7632 203d 205f 6d6d 3235 365f 6d75    v2 = _mm256_mu
-000035e0: 6c5f 7073 2820 7632 2c20 6d75 6c20 293b  l_ps( v2, mul );
-000035f0: 0a20 2020 2020 2020 2076 3320 3d20 5f6d  .        v3 = _m
-00003600: 6d32 3536 5f6d 756c 5f70 7328 2076 332c  m256_mul_ps( v3,
-00003610: 206d 756c 2029 3b0a 0a20 2020 2020 2020   mul );..       
-00003620: 202f 2f20 526f 756e 6420 746f 206e 6561   // Round to nea
-00003630: 7265 7374 2069 6e74 6567 6572 0a20 2020  rest integer.   
-00003640: 2020 2020 2076 3020 3d20 5f6d 6d32 3536       v0 = _mm256
-00003650: 5f72 6f75 6e64 5f70 7328 2076 302c 205f  _round_ps( v0, _
-00003660: 4d4d 5f52 4f55 4e44 5f4e 4541 5245 5354  MM_ROUND_NEAREST
-00003670: 2029 3b0a 2020 2020 2020 2020 7631 203d   );.        v1 =
-00003680: 205f 6d6d 3235 365f 726f 756e 645f 7073   _mm256_round_ps
-00003690: 2820 7631 2c20 5f4d 4d5f 524f 554e 445f  ( v1, _MM_ROUND_
-000036a0: 4e45 4152 4553 5420 293b 0a20 2020 2020  NEAREST );.     
-000036b0: 2020 2076 3220 3d20 5f6d 6d32 3536 5f72     v2 = _mm256_r
-000036c0: 6f75 6e64 5f70 7328 2076 322c 205f 4d4d  ound_ps( v2, _MM
-000036d0: 5f52 4f55 4e44 5f4e 4541 5245 5354 2029  _ROUND_NEAREST )
-000036e0: 3b0a 2020 2020 2020 2020 7633 203d 205f  ;.        v3 = _
-000036f0: 6d6d 3235 365f 726f 756e 645f 7073 2820  mm256_round_ps( 
-00003700: 7633 2c20 5f4d 4d5f 524f 554e 445f 4e45  v3, _MM_ROUND_NE
-00003710: 4152 4553 5420 293b 0a0a 2020 2020 2020  AREST );..      
-00003720: 2020 2f2f 2043 6f6e 7665 7274 2066 6c6f    // Convert flo
-00003730: 6174 7320 746f 2069 6e74 6567 6572 730a  ats to integers.
-00003740: 2020 2020 2020 2020 5f5f 6d32 3536 6920          __m256i 
-00003750: 6930 203d 205f 6d6d 3235 365f 6376 7470  i0 = _mm256_cvtp
-00003760: 735f 6570 6933 3228 2076 3020 293b 0a20  s_epi32( v0 );. 
-00003770: 2020 2020 2020 205f 5f6d 3235 3669 2069         __m256i i
-00003780: 3120 3d20 5f6d 6d32 3536 5f63 7674 7073  1 = _mm256_cvtps
-00003790: 5f65 7069 3332 2820 7631 2029 3b0a 2020  _epi32( v1 );.  
-000037a0: 2020 2020 2020 5f5f 6d32 3536 6920 6932        __m256i i2
-000037b0: 203d 205f 6d6d 3235 365f 6376 7470 735f   = _mm256_cvtps_
-000037c0: 6570 6933 3228 2076 3220 293b 0a20 2020  epi32( v2 );.   
-000037d0: 2020 2020 205f 5f6d 3235 3669 2069 3320       __m256i i3 
-000037e0: 3d20 5f6d 6d32 3536 5f63 7674 7073 5f65  = _mm256_cvtps_e
-000037f0: 7069 3332 2820 7633 2029 3b0a 0a20 2020  pi32( v3 );..   
-00003800: 2020 2020 202f 2f20 436f 6e76 6572 7420       // Convert 
-00003810: 696e 7433 3220 746f 2069 6e74 3136 0a20  int32 to int16. 
-00003820: 2020 2020 2020 2069 3020 3d20 5f6d 6d32         i0 = _mm2
-00003830: 3536 5f70 6163 6b73 5f65 7069 3332 2820  56_packs_epi32( 
-00003840: 6930 2c20 6931 2029 3b09 2f2f 2030 2c20  i0, i1 );.// 0, 
-00003850: 312c 2032 2c20 332c 2020 382c 2039 2c20  1, 2, 3,  8, 9, 
-00003860: 3130 2c20 3131 2c20 2034 2c20 352c 2036  10, 11,  4, 5, 6
-00003870: 2c20 372c 2031 322c 2031 332c 2031 342c  , 7, 12, 13, 14,
-00003880: 2031 350a 2020 2020 2020 2020 6932 203d   15.        i2 =
-00003890: 205f 6d6d 3235 365f 7061 636b 735f 6570   _mm256_packs_ep
-000038a0: 6933 3228 2069 322c 2069 3320 293b 092f  i32( i2, i3 );./
-000038b0: 2f20 3136 2c20 3137 2c20 3138 2c20 3139  / 16, 17, 18, 19
-000038c0: 2c20 2032 342c 2032 352c 2032 362c 2032  ,  24, 25, 26, 2
-000038d0: 372c 2020 3230 2c20 3231 2c20 3232 2c20  7,  20, 21, 22, 
-000038e0: 3233 2c20 3238 2c20 3239 2c20 3330 2c20  23, 28, 29, 30, 
-000038f0: 3331 0a20 2020 2020 2020 2020 2020 2020  31.             
-00003900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003910: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00003920: 2f20 436f 6e76 6572 7420 696e 7431 3620  / Convert int16 
-00003930: 746f 2069 6e74 380a 2020 2020 2020 2020  to int8.        
-00003940: 6930 203d 205f 6d6d 3235 365f 7061 636b  i0 = _mm256_pack
-00003950: 735f 6570 6931 3628 2069 302c 2069 3220  s_epi16( i0, i2 
-00003960: 293b 092f 2f20 302c 2031 2c20 322c 2033  );.// 0, 1, 2, 3
-00003970: 2c20 2038 2c20 392c 2031 302c 2031 312c  ,  8, 9, 10, 11,
-00003980: 2020 3136 2c20 3137 2c20 3138 2c20 3139    16, 17, 18, 19
-00003990: 2c20 2032 342c 2032 352c 2032 362c 2032  ,  24, 25, 26, 2
-000039a0: 372c 2020 342c 2035 2c20 362c 2037 2c20  7,  4, 5, 6, 7, 
-000039b0: 3132 2c20 3133 2c20 3134 2c20 3135 2c20  12, 13, 14, 15, 
-000039c0: 3230 2c20 3231 2c20 3232 2c20 3233 2c20  20, 21, 22, 23, 
-000039d0: 3238 2c20 3239 2c20 3330 2c20 3331 0a0a  28, 29, 30, 31..
-000039e0: 2020 2020 2020 2020 2f2f 2057 6520 676f          // We go
-000039f0: 7420 6f75 7220 7072 6563 696f 7573 2073  t our precious s
-00003a00: 6967 6e65 6420 6279 7465 732c 2062 7574  igned bytes, but
-00003a10: 2074 6865 206f 7264 6572 2069 7320 6e6f   the order is no
-00003a20: 7720 7772 6f6e 670a 2020 2020 2020 2020  w wrong.        
-00003a30: 2f2f 2054 6865 7365 2041 5658 3220 7061  // These AVX2 pa
-00003a40: 636b 2069 6e73 7472 7563 7469 6f6e 7320  ck instructions 
-00003a50: 7072 6f63 6573 7320 3136 2d62 7974 6520  process 16-byte 
-00003a60: 7069 6563 6573 2069 6e64 6570 656e 6465  pieces independe
-00003a70: 6e74 6c79 0a20 2020 2020 2020 202f 2f20  ntly.        // 
-00003a80: 5468 6520 666f 6c6c 6f77 696e 6720 696e  The following in
-00003a90: 7374 7275 6374 696f 6e20 6973 2066 6978  struction is fix
-00003aa0: 696e 6720 7468 6520 6f72 6465 720a 2020  ing the order.  
-00003ab0: 2020 2020 2020 636f 6e73 7420 5f5f 6d32        const __m2
-00003ac0: 3536 6920 7065 726d 203d 205f 6d6d 3235  56i perm = _mm25
-00003ad0: 365f 7365 7472 5f65 7069 3332 2820 302c  6_setr_epi32( 0,
-00003ae0: 2034 2c20 312c 2035 2c20 322c 2036 2c20   4, 1, 5, 2, 6, 
-00003af0: 332c 2037 2029 3b0a 2020 2020 2020 2020  3, 7 );.        
-00003b00: 6930 203d 205f 6d6d 3235 365f 7065 726d  i0 = _mm256_perm
-00003b10: 7574 6576 6172 3878 3332 5f65 7069 3332  utevar8x32_epi32
-00003b20: 2820 6930 2c20 7065 726d 2029 3b0a 0a20  ( i0, perm );.. 
-00003b30: 2020 2020 2020 202f 2f20 4170 706c 7920         // Apply 
-00003b40: 6f66 6673 6574 2074 6f20 7472 616e 736c  offset to transl
-00003b50: 6174 6520 7468 6520 7261 6e67 6520 6672  ate the range fr
-00003b60: 6f6d 205b 202d 3720 2e2e 202b 3720 5d20  om [ -7 .. +7 ] 
-00003b70: 696e 746f 205b 202b 3120 2e2e 202b 3135  into [ +1 .. +15
-00003b80: 205d 0a20 2020 2020 2020 2063 6f6e 7374   ].        const
-00003b90: 205f 5f6d 3235 3669 206f 6666 203d 205f   __m256i off = _
-00003ba0: 6d6d 3235 365f 7365 7431 5f65 7069 3828  mm256_set1_epi8(
-00003bb0: 2038 2029 3b0a 2020 2020 2020 2020 6930   8 );.        i0
-00003bc0: 203d 205f 6d6d 3235 365f 6164 645f 6570   = _mm256_add_ep
-00003bd0: 6938 2820 6930 2c20 6f66 6620 293b 0a0a  i8( i0, off );..
-00003be0: 2020 2020 2020 2020 2f2f 2043 6f6d 7072          // Compr
-00003bf0: 6573 7320 7468 6520 7665 6374 6f72 2069  ess the vector i
-00003c00: 6e74 6f20 3420 6269 742f 7661 6c75 652c  nto 4 bit/value,
-00003c10: 2061 6e64 2073 746f 7265 0a20 2020 2020   and store.     
-00003c20: 2020 205f 5f6d 3132 3869 2072 6573 203d     __m128i res =
-00003c30: 2070 6163 6b4e 6962 626c 6573 2820 6930   packNibbles( i0
-00003c40: 2029 3b0a 2020 2020 2020 2020 5f6d 6d5f   );.        _mm_
-00003c50: 7374 6f72 6575 5f73 6931 3238 2820 2820  storeu_si128( ( 
-00003c60: 5f5f 6d31 3238 692a 2029 7062 2c20 7265  __m128i* )pb, re
-00003c70: 7320 293b 0a20 2020 2020 2020 2070 6220  s );.        pb 
-00003c80: 2b3d 2062 733b 0a20 2020 207d 0a23 656c  += bs;.    }.#el
-00003c90: 7365 0a23 6572 726f 7220 226e 6f74 2069  se.#error "not i
-00003ca0: 6d70 6c65 6d65 6e74 6564 2066 6f72 2051  mplemented for Q
-00003cb0: 4b22 0a23 656e 6469 660a 2365 6c69 6620  K".#endif.#elif 
-00003cc0: 6465 6669 6e65 6428 5f5f 7761 736d 5f73  defined(__wasm_s
-00003cd0: 696d 6431 3238 5f5f 290a 2369 6620 514b  imd128__).#if QK
-00003ce0: 203d 3d20 3332 0a20 2020 2066 6f72 2028   == 32.    for (
-00003cf0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00003d00: 623b 2069 2b2b 2920 7b0a 2020 2020 2020  b; i++) {.      
-00003d10: 2020 666c 6f61 7420 616d 6178 203d 2030    float amax = 0
-00003d20: 2e30 663b 202f 2f20 6162 736f 6c75 7465  .0f; // absolute
-00003d30: 206d 6178 0a0a 2020 2020 2020 2020 7631   max..        v1
-00003d40: 3238 5f74 2073 7263 7620 5b38 5d3b 0a20  28_t srcv [8];. 
-00003d50: 2020 2020 2020 2076 3132 385f 7420 6173         v128_t as
-00003d60: 7263 765b 385d 3b0a 2020 2020 2020 2020  rcv[8];.        
-00003d70: 7631 3238 5f74 2061 6d61 7876 5b38 5d3b  v128_t amaxv[8];
-00003d80: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-00003d90: 6e74 206c 203d 2030 3b20 6c20 3c20 383b  nt l = 0; l < 8;
-00003da0: 206c 2b2b 2920 7372 6376 5b6c 5d20 203d   l++) srcv[l]  =
-00003db0: 2077 6173 6d5f 7631 3238 5f6c 6f61 6428   wasm_v128_load(
-00003dc0: 7820 2b20 692a 3332 202b 2034 2a6c 293b  x + i*32 + 4*l);
-00003dd0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-00003de0: 7420 6c20 3d20 303b 206c 203c 2038 3b20  t l = 0; l < 8; 
-00003df0: 6c2b 2b29 2061 7372 6376 5b6c 5d20 3d20  l++) asrcv[l] = 
-00003e00: 7761 736d 5f66 3332 7834 5f61 6273 2873  wasm_f32x4_abs(s
-00003e10: 7263 765b 6c5d 293b 0a0a 2020 2020 2020  rcv[l]);..      
-00003e20: 2020 666f 7220 2869 6e74 206c 203d 2030    for (int l = 0
-00003e30: 3b20 6c20 3c20 343b 206c 2b2b 2920 616d  ; l < 4; l++) am
-00003e40: 6178 765b 322a 6c5d 203d 2077 6173 6d5f  axv[2*l] = wasm_
-00003e50: 6633 3278 345f 6d61 7828 6173 7263 765b  f32x4_max(asrcv[
-00003e60: 322a 6c5d 2c20 6173 7263 765b 322a 6c2b  2*l], asrcv[2*l+
-00003e70: 315d 293b 0a20 2020 2020 2020 2066 6f72  1]);.        for
-00003e80: 2028 696e 7420 6c20 3d20 303b 206c 203c   (int l = 0; l <
-00003e90: 2032 3b20 6c2b 2b29 2061 6d61 7876 5b34   2; l++) amaxv[4
-00003ea0: 2a6c 5d20 3d20 7761 736d 5f66 3332 7834  *l] = wasm_f32x4
-00003eb0: 5f6d 6178 2861 6d61 7876 5b34 2a6c 5d2c  _max(amaxv[4*l],
-00003ec0: 2061 6d61 7876 5b34 2a6c 2b32 5d29 3b0a   amaxv[4*l+2]);.
-00003ed0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00003ee0: 206c 203d 2030 3b20 6c20 3c20 313b 206c   l = 0; l < 1; l
-00003ef0: 2b2b 2920 616d 6178 765b 382a 6c5d 203d  ++) amaxv[8*l] =
-00003f00: 2077 6173 6d5f 6633 3278 345f 6d61 7828   wasm_f32x4_max(
-00003f10: 616d 6178 765b 382a 6c5d 2c20 616d 6178  amaxv[8*l], amax
-00003f20: 765b 382a 6c2b 345d 293b 0a0a 2020 2020  v[8*l+4]);..    
-00003f30: 2020 2020 616d 6178 203d 204d 4158 280a      amax = MAX(.
-00003f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f50: 4d41 5828 7761 736d 5f66 3332 7834 5f65  MAX(wasm_f32x4_e
-00003f60: 7874 7261 6374 5f6c 616e 6528 616d 6178  xtract_lane(amax
-00003f70: 765b 305d 2c20 3029 2c20 7761 736d 5f66  v[0], 0), wasm_f
-00003f80: 3332 7834 5f65 7874 7261 6374 5f6c 616e  32x4_extract_lan
-00003f90: 6528 616d 6178 765b 305d 2c20 3129 292c  e(amaxv[0], 1)),
-00003fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003fb0: 204d 4158 2877 6173 6d5f 6633 3278 345f   MAX(wasm_f32x4_
-00003fc0: 6578 7472 6163 745f 6c61 6e65 2861 6d61  extract_lane(ama
-00003fd0: 7876 5b30 5d2c 2032 292c 2077 6173 6d5f  xv[0], 2), wasm_
-00003fe0: 6633 3278 345f 6578 7472 6163 745f 6c61  f32x4_extract_la
-00003ff0: 6e65 2861 6d61 7876 5b30 5d2c 2033 2929  ne(amaxv[0], 3))
-00004000: 293b 0a0a 2020 2020 2020 2020 636f 6e73  );..        cons
-00004010: 7420 666c 6f61 7420 6420 3d20 616d 6178  t float d = amax
-00004020: 202f 2028 2831 203c 3c20 3329 202d 2031   / ((1 << 3) - 1
-00004030: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-00004040: 2066 6c6f 6174 2069 6420 3d20 6420 3f20   float id = d ? 
-00004050: 312e 302f 6420 3a20 302e 303b 0a0a 2020  1.0/d : 0.0;..  
-00004060: 2020 2020 2020 2a28 666c 6f61 7420 2a29        *(float *)
-00004070: 7064 203d 2064 3b0a 2020 2020 2020 2020  pd = d;.        
-00004080: 7064 202b 3d20 6273 3b0a 0a20 2020 2020  pd += bs;..     
-00004090: 2020 2066 6f72 2028 696e 7420 6c20 3d20     for (int l = 
-000040a0: 303b 206c 203c 2038 3b20 6c2b 2b29 207b  0; l < 8; l++) {
-000040b0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-000040c0: 7374 2076 3132 385f 7420 7620 203d 2077  st v128_t v  = w
-000040d0: 6173 6d5f 6633 3278 345f 6d75 6c28 7372  asm_f32x4_mul(sr
-000040e0: 6376 5b6c 5d2c 2077 6173 6d5f 6633 3278  cv[l], wasm_f32x
-000040f0: 345f 7370 6c61 7428 6964 2929 3b0a 2020  4_splat(id));.  
-00004100: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00004110: 7631 3238 5f74 2076 6620 3d20 7761 736d  v128_t vf = wasm
-00004120: 5f66 3332 7834 5f61 6464 2876 2c20 7761  _f32x4_add(v, wa
-00004130: 736d 5f66 3332 7834 5f73 706c 6174 2838  sm_f32x4_splat(8
-00004140: 2e35 6629 293b 0a20 2020 2020 2020 2020  .5f));.         
-00004150: 2020 2063 6f6e 7374 2076 3132 385f 7420     const v128_t 
-00004160: 7669 203d 2077 6173 6d5f 6933 3278 345f  vi = wasm_i32x4_
-00004170: 7472 756e 635f 7361 745f 6633 3278 3428  trunc_sat_f32x4(
-00004180: 7666 293b 0a0a 2020 2020 2020 2020 2020  vf);..          
-00004190: 2020 7070 5b32 2a6c 202b 2030 5d20 3d20    pp[2*l + 0] = 
-000041a0: 7761 736d 5f69 3332 7834 5f65 7874 7261  wasm_i32x4_extra
-000041b0: 6374 5f6c 616e 6528 7669 2c20 3029 207c  ct_lane(vi, 0) |
-000041c0: 2028 7761 736d 5f69 3332 7834 5f65 7874   (wasm_i32x4_ext
-000041d0: 7261 6374 5f6c 616e 6528 7669 2c20 3129  ract_lane(vi, 1)
-000041e0: 203c 3c20 3429 3b0a 2020 2020 2020 2020   << 4);.        
-000041f0: 2020 2020 7070 5b32 2a6c 202b 2031 5d20      pp[2*l + 1] 
-00004200: 3d20 7761 736d 5f69 3332 7834 5f65 7874  = wasm_i32x4_ext
-00004210: 7261 6374 5f6c 616e 6528 7669 2c20 3229  ract_lane(vi, 2)
-00004220: 207c 2028 7761 736d 5f69 3332 7834 5f65   | (wasm_i32x4_e
-00004230: 7874 7261 6374 5f6c 616e 6528 7669 2c20  xtract_lane(vi, 
-00004240: 3329 203c 3c20 3429 3b0a 2020 2020 2020  3) << 4);.      
-00004250: 2020 7d0a 0a20 2020 2020 2020 206d 656d    }..        mem
-00004260: 6370 7928 7062 2c20 7070 2c20 7369 7a65  cpy(pb, pp, size
-00004270: 6f66 2870 7029 293b 0a20 2020 2020 2020  of(pp));.       
-00004280: 2070 6220 2b3d 2062 733b 0a20 2020 207d   pb += bs;.    }
-00004290: 0a23 656c 7365 0a23 6572 726f 7220 226e  .#else.#error "n
-000042a0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2066  ot implemented f
-000042b0: 6f72 2051 4b22 0a23 656e 6469 660a 2365  or QK".#endif.#e
-000042c0: 6c73 650a 2020 2020 2f2f 2073 6361 6c61  lse.    // scala
-000042d0: 720a 2020 2020 666f 7220 2869 6e74 2069  r.    for (int i
-000042e0: 203d 2030 3b20 6920 3c20 6e62 3b20 692b   = 0; i < nb; i+
-000042f0: 2b29 207b 0a20 2020 2020 2020 2066 6c6f  +) {.        flo
-00004300: 6174 2061 6d61 7820 3d20 302e 3066 3b20  at amax = 0.0f; 
-00004310: 2f2f 2061 6273 6f6c 7574 6520 6d61 780a  // absolute max.
-00004320: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-00004330: 7420 6c20 3d20 303b 206c 203c 2051 4b3b  t l = 0; l < QK;
-00004340: 206c 2b2b 2920 7b0a 2020 2020 2020 2020   l++) {.        
-00004350: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00004360: 7620 3d20 785b 692a 514b 202b 206c 5d3b  v = x[i*QK + l];
-00004370: 0a20 2020 2020 2020 2020 2020 2061 6d61  .            ama
-00004380: 7820 3d20 4d41 5828 616d 6178 2c20 6661  x = MAX(amax, fa
-00004390: 6273 6628 7629 293b 0a20 2020 2020 2020  bsf(v));.       
-000043a0: 207d 0a0a 2020 2020 2020 2020 636f 6e73   }..        cons
-000043b0: 7420 666c 6f61 7420 6420 3d20 616d 6178  t float d = amax
-000043c0: 202f 2028 2831 203c 3c20 3329 202d 2031   / ((1 << 3) - 1
-000043d0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-000043e0: 2066 6c6f 6174 2069 6420 3d20 6420 3f20   float id = d ? 
-000043f0: 312e 3066 2f64 203a 2030 2e30 663b 0a0a  1.0f/d : 0.0f;..
-00004400: 2020 2020 2020 2020 2a28 666c 6f61 7420          *(float 
-00004410: 2a29 7064 203d 2064 3b0a 2020 2020 2020  *)pd = d;.      
-00004420: 2020 7064 202b 3d20 6273 3b0a 0a20 2020    pd += bs;..   
-00004430: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
-00004440: 3d20 303b 206c 203c 2051 4b3b 206c 202b  = 0; l < QK; l +
-00004450: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
-00004460: 2020 2063 6f6e 7374 2066 6c6f 6174 2076     const float v
-00004470: 3020 3d20 785b 692a 514b 202b 206c 202b  0 = x[i*QK + l +
-00004480: 2030 5d2a 6964 3b0a 2020 2020 2020 2020   0]*id;.        
-00004490: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-000044a0: 7631 203d 2078 5b69 2a51 4b20 2b20 6c20  v1 = x[i*QK + l 
-000044b0: 2b20 315d 2a69 643b 0a0a 2020 2020 2020  + 1]*id;..      
-000044c0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-000044d0: 385f 7420 7669 3020 3d20 2828 696e 7438  8_t vi0 = ((int8
-000044e0: 5f74 2920 2872 6f75 6e64 2876 3029 2929  _t) (round(v0)))
-000044f0: 202b 2038 3b0a 2020 2020 2020 2020 2020   + 8;.          
-00004500: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
-00004510: 7669 3120 3d20 2828 696e 7438 5f74 2920  vi1 = ((int8_t) 
-00004520: 2872 6f75 6e64 2876 3129 2929 202b 2038  (round(v1))) + 8
-00004530: 3b0a 0a20 2020 2020 2020 2020 2020 2061  ;..            a
-00004540: 7373 6572 7428 7669 3020 3e3d 2030 2026  ssert(vi0 >= 0 &
-00004550: 2620 7669 3020 3c20 3136 293b 0a20 2020  & vi0 < 16);.   
-00004560: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00004570: 7669 3120 3e3d 2030 2026 2620 7669 3120  vi1 >= 0 && vi1 
-00004580: 3c20 3136 293b 0a0a 2020 2020 2020 2020  < 16);..        
-00004590: 2020 2020 7070 5b6c 2f32 5d20 3d20 7669      pp[l/2] = vi
-000045a0: 3020 7c20 2876 6931 203c 3c20 3429 3b0a  0 | (vi1 << 4);.
-000045b0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000045c0: 2020 206d 656d 6370 7928 7062 2c20 7070     memcpy(pb, pp
-000045d0: 2c20 7369 7a65 6f66 2870 7029 293b 0a20  , sizeof(pp));. 
-000045e0: 2020 2020 2020 2070 6220 2b3d 2062 733b         pb += bs;
-000045f0: 0a20 2020 207d 0a23 656e 6469 660a 7d0a  .    }.#endif.}.
-00004600: 0a2f 2f20 6d65 7468 6f64 2034 0a2f 2f20  .// method 4.// 
-00004610: 626c 6f63 6b73 206f 6620 514b 2065 6c65  blocks of QK ele
-00004620: 6d65 6e74 730a 2f2f 2072 6570 7265 7365  ments.// represe
-00004630: 6e74 6564 2077 6974 6820 3220 666c 6f61  nted with 2 floa
-00004640: 7473 2028 6d69 6e20 2b20 6465 6c74 6129  ts (min + delta)
-00004650: 2061 6e64 2051 4b2f 3220 382d 6269 7420   and QK/2 8-bit 
-00004660: 696e 7473 2028 692e 6520 514b 2034 2d62  ints (i.e QK 4-b
-00004670: 6974 2075 6e73 6967 6e65 6420 696e 7465  it unsigned inte
-00004680: 6765 7220 6661 6374 6f72 7329 0a76 6f69  ger factors).voi
-00004690: 6420 7175 616e 7469 7a65 5f72 6f77 5f71  d quantize_row_q
-000046a0: 345f 3128 636f 6e73 7420 666c 6f61 7420  4_1(const float 
-000046b0: 2a20 7265 7374 7269 6374 2078 2c20 766f  * restrict x, vo
-000046c0: 6964 202a 2072 6573 7472 6963 7420 792c  id * restrict y,
-000046d0: 2069 6e74 206b 2920 7b0a 2020 2020 6173   int k) {.    as
-000046e0: 7365 7274 286b 2025 2051 4b20 3d3d 2030  sert(k % QK == 0
-000046f0: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-00004700: 7420 6e62 203d 206b 202f 2051 4b3b 0a20  t nb = k / QK;. 
-00004710: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00004720: 6273 203d 2032 2a73 697a 656f 6628 666c  bs = 2*sizeof(fl
-00004730: 6f61 7429 202b 2051 4b2f 323b 0a0a 2020  oat) + QK/2;..  
-00004740: 2020 7569 6e74 385f 7420 2a20 7265 7374    uint8_t * rest
-00004750: 7269 6374 2070 6420 3d20 2828 7569 6e74  rict pd = ((uint
-00004760: 385f 7420 2a29 7920 2b20 302a 6273 293b  8_t *)y + 0*bs);
-00004770: 0a20 2020 2075 696e 7438 5f74 202a 2072  .    uint8_t * r
-00004780: 6573 7472 6963 7420 706d 203d 2028 2875  estrict pm = ((u
-00004790: 696e 7438 5f74 202a 2979 202b 2030 2a62  int8_t *)y + 0*b
-000047a0: 7320 2b20 2020 7369 7a65 6f66 2866 6c6f  s +   sizeof(flo
-000047b0: 6174 2929 3b0a 2020 2020 7569 6e74 385f  at));.    uint8_
-000047c0: 7420 2a20 7265 7374 7269 6374 2070 6220  t * restrict pb 
-000047d0: 3d20 2828 7569 6e74 385f 7420 2a29 7920  = ((uint8_t *)y 
-000047e0: 2b20 302a 6273 202b 2032 2a73 697a 656f  + 0*bs + 2*sizeo
-000047f0: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
-00004800: 7569 6e74 385f 7420 7070 5b51 4b2f 325d  uint8_t pp[QK/2]
-00004810: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-00004820: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
-00004830: 2b2b 2920 7b0a 2020 2020 2020 2020 666c  ++) {.        fl
-00004840: 6f61 7420 6d69 6e20 3d20 464c 545f 4d41  oat min = FLT_MA
-00004850: 583b 0a20 2020 2020 2020 2066 6c6f 6174  X;.        float
-00004860: 206d 6178 203d 202d 464c 545f 4d41 583b   max = -FLT_MAX;
-00004870: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-00004880: 6e74 206c 203d 2030 3b20 6c20 3c20 514b  nt l = 0; l < QK
-00004890: 3b20 6c2b 2b29 207b 0a20 2020 2020 2020  ; l++) {.       
-000048a0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-000048b0: 2076 203d 2078 5b69 2a51 4b20 2b20 6c5d   v = x[i*QK + l]
-000048c0: 3b0a 2020 2020 2020 2020 2020 2020 6966  ;.            if
-000048d0: 2028 7620 3c20 6d69 6e29 206d 696e 203d   (v < min) min =
-000048e0: 2076 3b0a 2020 2020 2020 2020 2020 2020   v;.            
-000048f0: 6966 2028 7620 3e20 6d61 7829 206d 6178  if (v > max) max
-00004900: 203d 2076 3b0a 2020 2020 2020 2020 7d0a   = v;.        }.
-00004910: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-00004920: 6c6f 6174 2064 203d 2028 6d61 7820 2d20  loat d = (max - 
-00004930: 6d69 6e29 202f 2028 2831 203c 3c20 3429  min) / ((1 << 4)
-00004940: 202d 2031 293b 0a20 2020 2020 2020 2063   - 1);.        c
-00004950: 6f6e 7374 2066 6c6f 6174 2069 6420 3d20  onst float id = 
-00004960: 6420 3f20 312e 3066 2f64 203a 2030 2e30  d ? 1.0f/d : 0.0
-00004970: 663b 0a0a 2020 2020 2020 2020 2a28 666c  f;..        *(fl
-00004980: 6f61 7420 2a29 706d 203d 206d 696e 3b0a  oat *)pm = min;.
-00004990: 2020 2020 2020 2020 2a28 666c 6f61 7420          *(float 
-000049a0: 2a29 7064 203d 2064 3b0a 2020 2020 2020  *)pd = d;.      
-000049b0: 2020 706d 202b 3d20 6273 3b0a 2020 2020    pm += bs;.    
-000049c0: 2020 2020 7064 202b 3d20 6273 3b0a 0a20      pd += bs;.. 
-000049d0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000049e0: 6c20 3d20 303b 206c 203c 2051 4b3b 206c  l = 0; l < QK; l
-000049f0: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
-00004a00: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-00004a10: 2076 3020 3d20 2878 5b69 2a51 4b20 2b20   v0 = (x[i*QK + 
-00004a20: 6c20 2b20 305d 202d 206d 696e 292a 6964  l + 0] - min)*id
-00004a30: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-00004a40: 6e73 7420 666c 6f61 7420 7631 203d 2028  nst float v1 = (
-00004a50: 785b 692a 514b 202b 206c 202b 2031 5d20  x[i*QK + l + 1] 
-00004a60: 2d20 6d69 6e29 2a69 643b 0a0a 2020 2020  - min)*id;..    
-00004a70: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00004a80: 6e74 385f 7420 7669 3020 3d20 726f 756e  nt8_t vi0 = roun
-00004a90: 6428 7630 293b 0a20 2020 2020 2020 2020  d(v0);.         
-00004aa0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
-00004ab0: 2076 6931 203d 2072 6f75 6e64 2876 3129   vi1 = round(v1)
-00004ac0: 3b0a 0a20 2020 2020 2020 2020 2020 2061  ;..            a
-00004ad0: 7373 6572 7428 7669 3020 3e3d 2030 2026  ssert(vi0 >= 0 &
-00004ae0: 2620 7669 3020 3c20 3136 293b 0a20 2020  & vi0 < 16);.   
-00004af0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00004b00: 7669 3120 3e3d 2030 2026 2620 7669 3120  vi1 >= 0 && vi1 
-00004b10: 3c20 3136 293b 0a0a 2020 2020 2020 2020  < 16);..        
-00004b20: 2020 2020 7070 5b6c 2f32 5d20 3d20 7669      pp[l/2] = vi
-00004b30: 3020 7c20 2876 6931 203c 3c20 3429 3b0a  0 | (vi1 << 4);.
-00004b40: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00004b50: 2020 206d 656d 6370 7928 7062 2c20 7070     memcpy(pb, pp
-00004b60: 2c20 7369 7a65 6f66 2870 7029 293b 0a20  , sizeof(pp));. 
-00004b70: 2020 2020 2020 2070 6220 2b3d 2062 733b         pb += bs;
-00004b80: 0a20 2020 207d 0a7d 0a0a 2f2f 2054 4f44  .    }.}..// TOD
-00004b90: 4f3a 2076 6563 746f 7269 7a65 0a76 6f69  O: vectorize.voi
-00004ba0: 6420 6465 7175 616e 7469 7a65 5f72 6f77  d dequantize_row
-00004bb0: 5f71 345f 3028 636f 6e73 7420 766f 6964  _q4_0(const void
-00004bc0: 202a 2072 6573 7472 6963 7420 782c 2066   * restrict x, f
-00004bd0: 6c6f 6174 202a 2072 6573 7472 6963 7420  loat * restrict 
-00004be0: 792c 2069 6e74 206b 2920 7b0a 2020 2020  y, int k) {.    
-00004bf0: 6173 7365 7274 286b 2025 2051 4b20 3d3d  assert(k % QK ==
-00004c00: 2030 293b 0a0a 2020 2020 636f 6e73 7420   0);..    const 
-00004c10: 696e 7420 6e62 203d 206b 202f 2051 4b3b  int nb = k / QK;
-00004c20: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00004c30: 7420 6273 203d 2073 697a 656f 6628 666c  t bs = sizeof(fl
-00004c40: 6f61 7429 202b 2051 4b2f 323b 0a0a 2020  oat) + QK/2;..  
-00004c50: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
-00004c60: 2a20 7265 7374 7269 6374 2070 6420 3d20  * restrict pd = 
-00004c70: 2828 636f 6e73 7420 7569 6e74 385f 7420  ((const uint8_t 
-00004c80: 2a29 7820 2b20 302a 6273 293b 0a20 2020  *)x + 0*bs);.   
-00004c90: 2063 6f6e 7374 2075 696e 7438 5f74 202a   const uint8_t *
-00004ca0: 2072 6573 7472 6963 7420 7062 203d 2028   restrict pb = (
-00004cb0: 2863 6f6e 7374 2075 696e 7438 5f74 202a  (const uint8_t *
-00004cc0: 2978 202b 2030 2a62 7320 2b20 7369 7a65  )x + 0*bs + size
-00004cd0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-00004ce0: 202f 2f20 7363 616c 6172 0a20 2020 2066   // scalar.    f
-00004cf0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00004d00: 203c 206e 623b 2069 2b2b 2920 7b0a 2020   < nb; i++) {.  
-00004d10: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-00004d20: 7420 6420 3d20 2a28 636f 6e73 7420 666c  t d = *(const fl
-00004d30: 6f61 7420 2a29 2028 7064 202b 2069 2a62  oat *) (pd + i*b
-00004d40: 7329 3b0a 0a20 2020 2020 2020 2063 6f6e  s);..        con
-00004d50: 7374 2075 696e 7438 5f74 202a 2072 6573  st uint8_t * res
-00004d60: 7472 6963 7420 7070 203d 2070 6220 2b20  trict pp = pb + 
-00004d70: 692a 6273 3b0a 0a20 2020 2020 2020 2066  i*bs;..        f
-00004d80: 6f72 2028 696e 7420 6c20 3d20 303b 206c  or (int l = 0; l
-00004d90: 203c 2051 4b3b 206c 202b 3d20 3229 207b   < QK; l += 2) {
-00004da0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00004db0: 7374 2075 696e 7438 5f74 2076 6920 3d20  st uint8_t vi = 
-00004dc0: 7070 5b6c 2f32 5d3b 0a0a 2020 2020 2020  pp[l/2];..      
-00004dd0: 2020 2020 2020 636f 6e73 7420 696e 7438        const int8
-00004de0: 5f74 2076 6930 203d 2076 6920 2620 3078  _t vi0 = vi & 0x
-00004df0: 663b 0a20 2020 2020 2020 2020 2020 2063  f;.            c
-00004e00: 6f6e 7374 2069 6e74 385f 7420 7669 3120  onst int8_t vi1 
-00004e10: 3d20 7669 203e 3e20 343b 0a0a 2020 2020  = vi >> 4;..    
-00004e20: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00004e30: 6f61 7420 7630 203d 2028 7669 3020 2d20  oat v0 = (vi0 - 
-00004e40: 3829 2a64 3b0a 2020 2020 2020 2020 2020  8)*d;.          
-00004e50: 2020 636f 6e73 7420 666c 6f61 7420 7631    const float v1
-00004e60: 203d 2028 7669 3120 2d20 3829 2a64 3b0a   = (vi1 - 8)*d;.
-00004e70: 0a20 2020 2020 2020 2020 2020 202f 2f70  .            //p
-00004e80: 7269 6e74 6628 2264 203d 2025 662c 2076  rintf("d = %f, v
-00004e90: 6920 3d20 2564 2c20 7669 3020 3d20 2564  i = %d, vi0 = %d
-00004ea0: 2c20 7669 3120 3d20 2564 2c20 7630 203d  , vi1 = %d, v0 =
-00004eb0: 2025 662c 2076 3120 3d20 2566 5c6e 222c   %f, v1 = %f\n",
-00004ec0: 2064 2c20 7669 2c20 7669 302c 2076 6931   d, vi, vi0, vi1
-00004ed0: 2c20 7630 2c20 7631 293b 0a0a 2020 2020  , v0, v1);..    
-00004ee0: 2020 2020 2020 2020 795b 692a 514b 202b          y[i*QK +
-00004ef0: 206c 202b 2030 5d20 3d20 7630 3b0a 2020   l + 0] = v0;.  
-00004f00: 2020 2020 2020 2020 2020 795b 692a 514b            y[i*QK
-00004f10: 202b 206c 202b 2031 5d20 3d20 7631 3b0a   + l + 1] = v1;.
-00004f20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00004f30: 6572 7428 2169 736e 616e 2879 5b69 2a51  ert(!isnan(y[i*Q
-00004f40: 4b20 2b20 6c20 2b20 305d 2929 3b0a 2020  K + l + 0]));.  
-00004f50: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00004f60: 2821 6973 6e61 6e28 795b 692a 514b 202b  (!isnan(y[i*QK +
-00004f70: 206c 202b 2031 5d29 293b 0a20 2020 2020   l + 1]));.     
-00004f80: 2020 207d 0a20 2020 207d 0a7d 0a0a 766f     }.    }.}..vo
-00004f90: 6964 2064 6571 7561 6e74 697a 655f 726f  id dequantize_ro
-00004fa0: 775f 7134 5f31 2863 6f6e 7374 2076 6f69  w_q4_1(const voi
-00004fb0: 6420 2a20 7265 7374 7269 6374 2078 2c20  d * restrict x, 
-00004fc0: 666c 6f61 7420 2a20 7265 7374 7269 6374  float * restrict
-00004fd0: 2079 2c20 696e 7420 6b29 207b 0a20 2020   y, int k) {.   
-00004fe0: 2061 7373 6572 7428 6b20 2520 514b 203d   assert(k % QK =
-00004ff0: 3d20 3029 3b0a 0a20 2020 2063 6f6e 7374  = 0);..    const
-00005000: 2069 6e74 206e 6220 3d20 6b20 2f20 514b   int nb = k / QK
-00005010: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00005020: 5f74 2062 7320 3d20 322a 7369 7a65 6f66  _t bs = 2*sizeof
-00005030: 2866 6c6f 6174 2920 2b20 514b 2f32 3b0a  (float) + QK/2;.
-00005040: 0a20 2020 2063 6f6e 7374 2075 696e 7438  .    const uint8
-00005050: 5f74 202a 2072 6573 7472 6963 7420 7064  _t * restrict pd
-00005060: 203d 2028 2863 6f6e 7374 2075 696e 7438   = ((const uint8
-00005070: 5f74 202a 2978 202b 2030 2a62 7329 3b0a  _t *)x + 0*bs);.
-00005080: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-00005090: 7420 2a20 7265 7374 7269 6374 2070 6d20  t * restrict pm 
-000050a0: 3d20 2828 636f 6e73 7420 7569 6e74 385f  = ((const uint8_
-000050b0: 7420 2a29 7820 2b20 302a 6273 202b 2073  t *)x + 0*bs + s
-000050c0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-000050d0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
-000050e0: 202a 2072 6573 7472 6963 7420 7062 203d   * restrict pb =
-000050f0: 2028 2863 6f6e 7374 2075 696e 7438 5f74   ((const uint8_t
-00005100: 202a 2978 202b 2030 2a62 7320 2b20 322a   *)x + 0*bs + 2*
-00005110: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00005120: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-00005130: 3d20 303b 2069 203c 206e 623b 2069 2b2b  = 0; i < nb; i++
-00005140: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
-00005150: 7420 666c 6f61 7420 6420 3d20 2a28 636f  t float d = *(co
-00005160: 6e73 7420 666c 6f61 7420 2a29 2028 7064  nst float *) (pd
-00005170: 202b 2069 2a62 7329 3b0a 2020 2020 2020   + i*bs);.      
-00005180: 2020 636f 6e73 7420 666c 6f61 7420 6d20    const float m 
-00005190: 3d20 2a28 636f 6e73 7420 666c 6f61 7420  = *(const float 
-000051a0: 2a29 2028 706d 202b 2069 2a62 7329 3b0a  *) (pm + i*bs);.
-000051b0: 0a20 2020 2020 2020 2063 6f6e 7374 2075  .        const u
-000051c0: 696e 7438 5f74 202a 2072 6573 7472 6963  int8_t * restric
-000051d0: 7420 7070 203d 2070 6220 2b20 692a 6273  t pp = pb + i*bs
-000051e0: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-000051f0: 696e 7420 6c20 3d20 303b 206c 203c 2051  int l = 0; l < Q
-00005200: 4b3b 206c 202b 3d20 3229 207b 0a20 2020  K; l += 2) {.   
-00005210: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-00005220: 696e 7438 5f74 2076 6920 3d20 7070 5b6c  int8_t vi = pp[l
-00005230: 2f32 5d3b 0a0a 2020 2020 2020 2020 2020  /2];..          
-00005240: 2020 636f 6e73 7420 696e 7438 5f74 2076    const int8_t v
-00005250: 6930 203d 2076 6920 2620 3078 663b 0a20  i0 = vi & 0xf;. 
-00005260: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00005270: 2069 6e74 385f 7420 7669 3120 3d20 7669   int8_t vi1 = vi
-00005280: 203e 3e20 343b 0a0a 2020 2020 2020 2020   >> 4;..        
-00005290: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-000052a0: 7630 203d 2076 6930 2a64 202b 206d 3b0a  v0 = vi0*d + m;.
-000052b0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000052c0: 7420 666c 6f61 7420 7631 203d 2076 6931  t float v1 = vi1
-000052d0: 2a64 202b 206d 3b0a 0a20 2020 2020 2020  *d + m;..       
-000052e0: 2020 2020 2079 5b69 2a51 4b20 2b20 6c20       y[i*QK + l 
-000052f0: 2b20 305d 203d 2076 303b 0a20 2020 2020  + 0] = v0;.     
-00005300: 2020 2020 2020 2079 5b69 2a51 4b20 2b20         y[i*QK + 
-00005310: 6c20 2b20 315d 203d 2076 313b 0a0a 2020  l + 1] = v1;..  
-00005320: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00005330: 2821 6973 6e61 6e28 795b 692a 514b 202b  (!isnan(y[i*QK +
-00005340: 206c 202b 2030 5d29 293b 0a20 2020 2020   l + 0]));.     
-00005350: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
-00005360: 736e 616e 2879 5b69 2a51 4b20 2b20 6c20  snan(y[i*QK + l 
-00005370: 2b20 315d 2929 3b0a 2020 2020 2020 2020  + 1]));.        
-00005380: 7d0a 2020 2020 7d0a 7d0a 0a2f 2f0a 2f2f  }.    }.}..//.//
-00005390: 2073 696d 6420 6d61 7070 696e 6773 0a2f   simd mappings./
-000053a0: 2f0a 0a2f 2f20 7765 2064 6566 696e 6520  /..// we define 
-000053b0: 6120 636f 6d6d 6f6e 2073 6574 206f 6620  a common set of 
-000053c0: 4320 6d61 6372 6f73 2077 6869 6368 206d  C macros which m
-000053d0: 6170 2074 6f20 7370 6563 6966 6963 2069  ap to specific i
-000053e0: 6e74 7269 6e73 6963 7320 6261 7365 6420  ntrinsics based 
-000053f0: 6f6e 2074 6865 2063 7572 7265 6e74 2061  on the current a
-00005400: 7263 6869 7465 6374 7572 650a 2f2f 2077  rchitecture.// w
-00005410: 6520 7468 656e 2069 6d70 6c65 6d65 6e74  e then implement
-00005420: 2074 6865 2066 756e 6461 6d65 6e74 616c   the fundamental
-00005430: 2063 6f6d 7075 7461 7469 6f6e 206f 7065   computation ope
-00005440: 7261 7469 6f6e 7320 6265 6c6f 7720 7573  rations below us
-00005450: 696e 6720 6f6e 6c79 2074 6865 7365 206d  ing only these m
-00005460: 6163 726f 730a 2f2f 2061 6464 696e 6720  acros.// adding 
-00005470: 7375 7070 6f72 7420 666f 7220 6e65 7720  support for new 
-00005480: 6172 6368 6974 6563 7475 7265 7320 7265  architectures re
-00005490: 7175 6972 6573 2074 6f20 6465 6669 6e65  quires to define
-000054a0: 2074 6865 2063 6f72 7265 7370 6f6e 6469   the correspondi
-000054b0: 6e67 2053 494d 4420 6d61 6372 6f73 0a2f  ng SIMD macros./
-000054c0: 2f0a 2f2f 2047 474d 4c5f 4633 325f 5354  /.// GGML_F32_ST
-000054d0: 4550 202f 2047 474d 4c5f 4631 365f 5354  EP / GGML_F16_ST
-000054e0: 4550 0a2f 2f20 2020 6e75 6d62 6572 206f  EP.//   number o
-000054f0: 6620 656c 656d 656e 7473 2074 6f20 7072  f elements to pr
-00005500: 6f63 6573 7320 696e 2061 2073 696e 676c  ocess in a singl
-00005510: 6520 7374 6570 0a2f 2f0a 2f2f 2047 474d  e step.//.// GGM
-00005520: 4c5f 4633 325f 4550 5220 2f20 4747 4d4c  L_F32_EPR / GGML
-00005530: 5f46 3136 5f45 5052 0a2f 2f20 2020 6e75  _F16_EPR.//   nu
-00005540: 6d62 6572 206f 6620 656c 656d 656e 7473  mber of elements
-00005550: 2074 6f20 6669 7420 696e 2061 2073 696e   to fit in a sin
-00005560: 676c 6520 7265 6769 7374 6572 0a2f 2f0a  gle register.//.
-00005570: 0a23 6966 2064 6566 696e 6564 285f 5f41  .#if defined(__A
-00005580: 524d 5f4e 454f 4e29 2026 2620 6465 6669  RM_NEON) && defi
-00005590: 6e65 6428 5f5f 4152 4d5f 4645 4154 5552  ned(__ARM_FEATUR
-000055a0: 455f 464d 4129 0a0a 2364 6566 696e 6520  E_FMA)..#define 
-000055b0: 4747 4d4c 5f53 494d 440a 0a2f 2f20 4633  GGML_SIMD..// F3
-000055c0: 3220 4e45 4f4e 0a0a 2364 6566 696e 6520  2 NEON..#define 
-000055d0: 4747 4d4c 5f46 3332 5f53 5445 5020 3136  GGML_F32_STEP 16
-000055e0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-000055f0: 325f 4550 5220 2034 0a0a 2364 6566 696e  2_EPR  4..#defin
-00005600: 6520 4747 4d4c 5f46 3332 7834 2020 2020  e GGML_F32x4    
-00005610: 2020 2020 2020 2020 2020 666c 6f61 7433            float3
-00005620: 3278 345f 740a 2364 6566 696e 6520 4747  2x4_t.#define GG
-00005630: 4d4c 5f46 3332 7834 5f5a 4552 4f20 2020  ML_F32x4_ZERO   
-00005640: 2020 2020 2020 7664 7570 715f 6e5f 6633        vdupq_n_f3
-00005650: 3228 302e 3066 290a 2364 6566 696e 6520  2(0.0f).#define 
-00005660: 4747 4d4c 5f46 3332 7834 5f53 4554 3128  GGML_F32x4_SET1(
-00005670: 7829 2020 2020 2020 7664 7570 715f 6e5f  x)      vdupq_n_
-00005680: 6633 3228 7829 0a23 6465 6669 6e65 2047  f32(x).#define G
-00005690: 474d 4c5f 4633 3278 345f 4c4f 4144 2020  GML_F32x4_LOAD  
-000056a0: 2020 2020 2020 2076 6c64 3171 5f66 3332         vld1q_f32
-000056b0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-000056c0: 3278 345f 5354 4f52 4520 2020 2020 2020  2x4_STORE       
-000056d0: 2076 7374 3171 5f66 3332 0a23 6465 6669   vst1q_f32.#defi
-000056e0: 6e65 2047 474d 4c5f 4633 3278 345f 464d  ne GGML_F32x4_FM
-000056f0: 4128 612c 2062 2c20 6329 2076 666d 6171  A(a, b, c) vfmaq
-00005700: 5f66 3332 2861 2c20 622c 2063 290a 2364  _f32(a, b, c).#d
-00005710: 6566 696e 6520 4747 4d4c 5f46 3332 7834  efine GGML_F32x4
-00005720: 5f41 4444 2020 2020 2020 2020 2020 7661  _ADD          va
-00005730: 6464 715f 6633 320a 2364 6566 696e 6520  ddq_f32.#define 
-00005740: 4747 4d4c 5f46 3332 7834 5f4d 554c 2020  GGML_F32x4_MUL  
-00005750: 2020 2020 2020 2020 766d 756c 715f 6633          vmulq_f3
-00005760: 320a 2369 6620 6465 6669 6e65 6428 5f5f  2.#if defined(__
-00005770: 4152 4d5f 4645 4154 5552 455f 5152 444d  ARM_FEATURE_QRDM
-00005780: 5829 0a20 2020 2023 6465 6669 6e65 2047  X).    #define G
-00005790: 474d 4c5f 4633 3278 345f 5245 4455 4345  GML_F32x4_REDUCE
-000057a0: 5f4f 4e45 2878 2920 7661 6464 7671 5f66  _ONE(x) vaddvq_f
-000057b0: 3332 2878 290a 2365 6c73 650a 2020 2020  32(x).#else.    
-000057c0: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-000057d0: 7834 5f52 4544 5543 455f 4f4e 4528 7829  x4_REDUCE_ONE(x)
-000057e0: 205c 0a20 2020 2028 7667 6574 715f 6c61   \.    (vgetq_la
-000057f0: 6e65 5f66 3332 2878 2c20 3029 202b 2020  ne_f32(x, 0) +  
-00005800: 2020 2020 2020 2020 5c0a 2020 2020 2076          \.     v
-00005810: 6765 7471 5f6c 616e 655f 6633 3228 782c  getq_lane_f32(x,
-00005820: 2031 2920 2b20 2020 2020 2020 2020 205c   1) +          \
-00005830: 0a20 2020 2020 7667 6574 715f 6c61 6e65  .     vgetq_lane
-00005840: 5f66 3332 2878 2c20 3229 202b 2020 2020  _f32(x, 2) +    
-00005850: 2020 2020 2020 5c0a 2020 2020 2076 6765        \.     vge
-00005860: 7471 5f6c 616e 655f 6633 3228 782c 2033  tq_lane_f32(x, 3
-00005870: 2929 0a23 656e 6469 660a 2364 6566 696e  )).#endif.#defin
-00005880: 6520 4747 4d4c 5f46 3332 7834 5f52 4544  e GGML_F32x4_RED
-00005890: 5543 4528 7265 732c 2078 2920 2020 2020  UCE(res, x)     
-000058a0: 2020 2020 2020 2020 205c 0a7b 2020 2020           \.{    
-000058b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058d0: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
-000058e0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000058f0: 6920 3c20 4747 4d4c 5f46 3332 5f41 5252  i < GGML_F32_ARR
-00005900: 2f32 3b20 2b2b 6929 207b 205c 0a20 2020  /2; ++i) { \.   
-00005910: 2020 2020 2078 5b32 2a69 5d20 3d20 7661       x[2*i] = va
-00005920: 6464 715f 6633 3228 785b 322a 695d 2c20  ddq_f32(x[2*i], 
-00005930: 785b 322a 692b 315d 293b 2020 5c0a 2020  x[2*i+1]);  \.  
-00005940: 2020 7d20 2020 2020 2020 2020 2020 2020    }             
-00005950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005960: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
-00005970: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00005980: 303b 2069 203c 2047 474d 4c5f 4633 325f  0; i < GGML_F32_
-00005990: 4152 522f 343b 202b 2b69 2920 7b20 5c0a  ARR/4; ++i) { \.
-000059a0: 2020 2020 2020 2020 785b 342a 695d 203d          x[4*i] =
-000059b0: 2076 6164 6471 5f66 3332 2878 5b34 2a69   vaddq_f32(x[4*i
-000059c0: 5d2c 2078 5b34 2a69 2b32 5d29 3b20 205c  ], x[4*i+2]);  \
-000059d0: 0a20 2020 207d 2020 2020 2020 2020 2020  .    }          
-000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a00: 5c0a 2020 2020 666f 7220 2869 6e74 2069  \.    for (int i
-00005a10: 203d 2030 3b20 6920 3c20 4747 4d4c 5f46   = 0; i < GGML_F
-00005a20: 3332 5f41 5252 2f38 3b20 2b2b 6929 207b  32_ARR/8; ++i) {
-00005a30: 205c 0a20 2020 2020 2020 2078 5b38 2a69   \.        x[8*i
-00005a40: 5d20 3d20 7661 6464 715f 6633 3228 785b  ] = vaddq_f32(x[
-00005a50: 382a 695d 2c20 785b 382a 692b 345d 293b  8*i], x[8*i+4]);
-00005a60: 2020 5c0a 2020 2020 7d20 2020 2020 2020    \.    }       
-00005a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a90: 2020 205c 0a20 2020 2072 6573 203d 2047     \.    res = G
-00005aa0: 474d 4c5f 4633 3278 345f 5245 4455 4345  GML_F32x4_REDUCE
-00005ab0: 5f4f 4e45 2878 5b30 5d29 3b20 2020 2020  _ONE(x[0]);     
-00005ac0: 2020 2020 5c0a 7d0a 0a23 6465 6669 6e65      \.}..#define
-00005ad0: 2047 474d 4c5f 4633 325f 5645 4320 2020   GGML_F32_VEC   
-00005ae0: 2020 2020 2047 474d 4c5f 4633 3278 340a       GGML_F32x4.
-00005af0: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-00005b00: 5f56 4543 5f5a 4552 4f20 2020 4747 4d4c  _VEC_ZERO   GGML
-00005b10: 5f46 3332 7834 5f5a 4552 4f0a 2364 6566  _F32x4_ZERO.#def
-00005b20: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
-00005b30: 5f53 4554 3120 2020 4747 4d4c 5f46 3332  _SET1   GGML_F32
-00005b40: 7834 5f53 4554 310a 2364 6566 696e 6520  x4_SET1.#define 
-00005b50: 4747 4d4c 5f46 3332 5f56 4543 5f4c 4f41  GGML_F32_VEC_LOA
-00005b60: 4420 2020 4747 4d4c 5f46 3332 7834 5f4c  D   GGML_F32x4_L
-00005b70: 4f41 440a 2364 6566 696e 6520 4747 4d4c  OAD.#define GGML
-00005b80: 5f46 3332 5f56 4543 5f53 544f 5245 2020  _F32_VEC_STORE  
-00005b90: 4747 4d4c 5f46 3332 7834 5f53 544f 5245  GGML_F32x4_STORE
-00005ba0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00005bb0: 325f 5645 435f 464d 4120 2020 2047 474d  2_VEC_FMA    GGM
-00005bc0: 4c5f 4633 3278 345f 464d 410a 2364 6566  L_F32x4_FMA.#def
-00005bd0: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
-00005be0: 5f41 4444 2020 2020 4747 4d4c 5f46 3332  _ADD    GGML_F32
-00005bf0: 7834 5f41 4444 0a23 6465 6669 6e65 2047  x4_ADD.#define G
-00005c00: 474d 4c5f 4633 325f 5645 435f 4d55 4c20  GML_F32_VEC_MUL 
-00005c10: 2020 2047 474d 4c5f 4633 3278 345f 4d55     GGML_F32x4_MU
-00005c20: 4c0a 2364 6566 696e 6520 4747 4d4c 5f46  L.#define GGML_F
-00005c30: 3332 5f56 4543 5f52 4544 5543 4520 4747  32_VEC_REDUCE GG
-00005c40: 4d4c 5f46 3332 7834 5f52 4544 5543 450a  ML_F32x4_REDUCE.
-00005c50: 0a2f 2f20 4631 3620 4e45 4f4e 0a0a 2369  .// F16 NEON..#i
-00005c60: 6620 6465 6669 6e65 6428 5f5f 4152 4d5f  f defined(__ARM_
-00005c70: 4645 4154 5552 455f 4650 3136 5f56 4543  FEATURE_FP16_VEC
-00005c80: 544f 525f 4152 4954 484d 4554 4943 290a  TOR_ARITHMETIC).
-00005c90: 2020 2020 2364 6566 696e 6520 4747 4d4c      #define GGML
-00005ca0: 5f46 3136 5f53 5445 5020 3332 0a20 2020  _F16_STEP 32.   
-00005cb0: 2023 6465 6669 6e65 2047 474d 4c5f 4631   #define GGML_F1
-00005cc0: 365f 4550 5220 2038 0a0a 2020 2020 2364  6_EPR  8..    #d
-00005cd0: 6566 696e 6520 4747 4d4c 5f46 3136 7838  efine GGML_F16x8
-00005ce0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-00005cf0: 6f61 7431 3678 385f 740a 2020 2020 2364  oat16x8_t.    #d
-00005d00: 6566 696e 6520 4747 4d4c 5f46 3136 7838  efine GGML_F16x8
-00005d10: 5f5a 4552 4f20 2020 2020 2020 2020 7664  _ZERO         vd
-00005d20: 7570 715f 6e5f 6631 3628 302e 3066 290a  upq_n_f16(0.0f).
-00005d30: 2020 2020 2364 6566 696e 6520 4747 4d4c      #define GGML
-00005d40: 5f46 3136 7838 5f53 4554 3128 7829 2020  _F16x8_SET1(x)  
-00005d50: 2020 2020 7664 7570 715f 6e5f 6631 3628      vdupq_n_f16(
-00005d60: 7829 0a20 2020 2023 6465 6669 6e65 2047  x).    #define G
-00005d70: 474d 4c5f 4631 3678 385f 4c4f 4144 2020  GML_F16x8_LOAD  
-00005d80: 2020 2020 2020 2076 6c64 3171 5f66 3136         vld1q_f16
-00005d90: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
-00005da0: 4c5f 4631 3678 385f 5354 4f52 4520 2020  L_F16x8_STORE   
-00005db0: 2020 2020 2076 7374 3171 5f66 3136 0a20       vst1q_f16. 
-00005dc0: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
-00005dd0: 4631 3678 385f 464d 4128 612c 2062 2c20  F16x8_FMA(a, b, 
-00005de0: 6329 2076 666d 6171 5f66 3136 2861 2c20  c) vfmaq_f16(a, 
-00005df0: 622c 2063 290a 2020 2020 2364 6566 696e  b, c).    #defin
-00005e00: 6520 4747 4d4c 5f46 3136 7838 5f41 4444  e GGML_F16x8_ADD
-00005e10: 2020 2020 2020 2020 2020 7661 6464 715f            vaddq_
-00005e20: 6631 360a 2020 2020 2364 6566 696e 6520  f16.    #define 
-00005e30: 4747 4d4c 5f46 3136 7838 5f4d 554c 2020  GGML_F16x8_MUL  
-00005e40: 2020 2020 2020 2020 766d 756c 715f 6631          vmulq_f1
-00005e50: 360a 2020 2020 2364 6566 696e 6520 4747  6.    #define GG
-00005e60: 4d4c 5f46 3136 7838 5f52 4544 5543 4528  ML_F16x8_REDUCE(
-00005e70: 7265 732c 2078 2920 2020 2020 2020 2020  res, x)         
-00005e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e90: 2020 2020 5c0a 2020 2020 7b20 2020 2020      \.    {     
-00005ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ed0: 2020 2020 2020 2020 5c0a 2020 2020 2020          \.      
-00005ee0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00005ef0: 3b20 6920 3c20 4747 4d4c 5f46 3136 5f41  ; i < GGML_F16_A
-00005f00: 5252 2f32 3b20 2b2b 6929 207b 2020 2020  RR/2; ++i) {    
-00005f10: 2020 2020 2020 2020 2020 2020 5c0a 2020              \.  
-00005f20: 2020 2020 2020 2020 2020 785b 322a 695d            x[2*i]
-00005f30: 203d 2076 6164 6471 5f66 3136 2878 5b32   = vaddq_f16(x[2
-00005f40: 2a69 5d2c 2078 5b32 2a69 2b31 5d29 3b20  *i], x[2*i+1]); 
-00005f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f60: 5c0a 2020 2020 2020 2020 7d20 2020 2020  \.        }     
-00005f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fa0: 2020 2020 5c0a 2020 2020 2020 2020 666f      \.        fo
-00005fb0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00005fc0: 3c20 4747 4d4c 5f46 3136 5f41 5252 2f34  < GGML_F16_ARR/4
-00005fd0: 3b20 2b2b 6929 207b 2020 2020 2020 2020  ; ++i) {        
-00005fe0: 2020 2020 2020 2020 5c0a 2020 2020 2020          \.      
-00005ff0: 2020 2020 2020 785b 342a 695d 203d 2076        x[4*i] = v
-00006000: 6164 6471 5f66 3136 2878 5b34 2a69 5d2c  addq_f16(x[4*i],
-00006010: 2078 5b34 2a69 2b32 5d29 3b20 2020 2020   x[4*i+2]);     
-00006020: 2020 2020 2020 2020 2020 2020 5c0a 2020              \.  
-00006030: 2020 2020 2020 7d20 2020 2020 2020 2020        }         
-00006040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006070: 5c0a 2020 2020 2020 2020 666f 7220 2869  \.        for (i
-00006080: 6e74 2069 203d 2030 3b20 6920 3c20 4747  nt i = 0; i < GG
-00006090: 4d4c 5f46 3136 5f41 5252 2f38 3b20 2b2b  ML_F16_ARR/8; ++
-000060a0: 6929 207b 2020 2020 2020 2020 2020 2020  i) {            
-000060b0: 2020 2020 5c0a 2020 2020 2020 2020 2020      \.          
-000060c0: 2020 785b 382a 695d 203d 2076 6164 6471    x[8*i] = vaddq
-000060d0: 5f66 3136 2878 5b38 2a69 5d2c 2078 5b38  _f16(x[8*i], x[8
-000060e0: 2a69 2b34 5d29 3b20 2020 2020 2020 2020  *i+4]);         
-000060f0: 2020 2020 2020 2020 5c0a 2020 2020 2020          \.      
-00006100: 2020 7d20 2020 2020 2020 2020 2020 2020    }             
-00006110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006130: 2020 2020 2020 2020 2020 2020 5c0a 2020              \.  
-00006140: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-00006150: 7433 3278 345f 7420 7430 203d 2076 6376  t32x4_t t0 = vcv
-00006160: 745f 6633 325f 6631 3628 7667 6574 5f6c  t_f32_f16(vget_l
-00006170: 6f77 5f66 3136 2028 785b 305d 2929 3b20  ow_f16 (x[0])); 
-00006180: 5c0a 2020 2020 2020 2020 636f 6e73 7420  \.        const 
-00006190: 666c 6f61 7433 3278 345f 7420 7431 203d  float32x4_t t1 =
-000061a0: 2076 6376 745f 6633 325f 6631 3628 7667   vcvt_f32_f16(vg
-000061b0: 6574 5f68 6967 685f 6631 3628 785b 305d  et_high_f16(x[0]
-000061c0: 2929 3b20 5c0a 2020 2020 2020 2020 7265  )); \.        re
-000061d0: 7320 3d20 7661 6464 7671 5f66 3332 2876  s = vaddvq_f32(v
-000061e0: 6164 6471 5f66 3332 2874 302c 2074 3129  addq_f32(t0, t1)
-000061f0: 293b 2020 2020 2020 2020 2020 2020 2020  );              
-00006200: 2020 2020 2020 2020 5c0a 2020 2020 7d0a          \.    }.
-00006210: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
-00006220: 4c5f 4631 365f 5645 4320 2020 2020 2020  L_F16_VEC       
-00006230: 2020 2020 2020 2020 2047 474d 4c5f 4631           GGML_F1
-00006240: 3678 380a 2020 2020 2364 6566 696e 6520  6x8.    #define 
-00006250: 4747 4d4c 5f46 3136 5f56 4543 5f5a 4552  GGML_F16_VEC_ZER
-00006260: 4f20 2020 2020 2020 2020 2020 4747 4d4c  O           GGML
-00006270: 5f46 3136 7838 5f5a 4552 4f0a 2020 2020  _F16x8_ZERO.    
-00006280: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
-00006290: 5f56 4543 5f53 4554 3120 2020 2020 2020  _VEC_SET1       
-000062a0: 2020 2020 4747 4d4c 5f46 3136 7838 5f53      GGML_F16x8_S
-000062b0: 4554 310a 2020 2020 2364 6566 696e 6520  ET1.    #define 
-000062c0: 4747 4d4c 5f46 3136 5f56 4543 5f4c 4f41  GGML_F16_VEC_LOA
-000062d0: 4428 702c 2069 2920 2020 2020 4747 4d4c  D(p, i)     GGML
-000062e0: 5f46 3136 7838 5f4c 4f41 4428 7029 0a20  _F16x8_LOAD(p). 
-000062f0: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
-00006300: 4631 365f 5645 435f 5354 4f52 4528 702c  F16_VEC_STORE(p,
-00006310: 2072 2c20 6929 2047 474d 4c5f 4631 3678   r, i) GGML_F16x
-00006320: 385f 5354 4f52 4528 702c 2072 5b69 5d29  8_STORE(p, r[i])
-00006330: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
-00006340: 4c5f 4631 365f 5645 435f 464d 4120 2020  L_F16_VEC_FMA   
-00006350: 2020 2020 2020 2020 2047 474d 4c5f 4631           GGML_F1
-00006360: 3678 385f 464d 410a 2020 2020 2364 6566  6x8_FMA.    #def
-00006370: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
-00006380: 5f41 4444 2020 2020 2020 2020 2020 2020  _ADD            
-00006390: 4747 4d4c 5f46 3136 7838 5f41 4444 0a20  GGML_F16x8_ADD. 
-000063a0: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
-000063b0: 4631 365f 5645 435f 4d55 4c20 2020 2020  F16_VEC_MUL     
-000063c0: 2020 2020 2020 2047 474d 4c5f 4631 3678         GGML_F16x
-000063d0: 385f 4d55 4c0a 2020 2020 2364 6566 696e  8_MUL.    #defin
-000063e0: 6520 4747 4d4c 5f46 3136 5f56 4543 5f52  e GGML_F16_VEC_R
-000063f0: 4544 5543 4520 2020 2020 2020 2020 4747  EDUCE         GG
-00006400: 4d4c 5f46 3136 7838 5f52 4544 5543 450a  ML_F16x8_REDUCE.
-00006410: 2365 6c73 650a 2020 2020 2f2f 2069 6620  #else.    // if 
-00006420: 4650 3136 2076 6563 746f 7220 6172 6974  FP16 vector arit
-00006430: 686d 6574 6963 2069 7320 6e6f 7420 7375  hmetic is not su
-00006440: 7070 6f72 7465 642c 2077 6520 7573 6520  pported, we use 
-00006450: 4650 3332 2069 6e73 7465 6164 0a20 2020  FP32 instead.   
-00006460: 202f 2f20 616e 6420 7461 6b65 2061 6476   // and take adv
-00006470: 616e 7461 6765 206f 6620 7468 6520 7663  antage of the vc
-00006480: 7674 5f20 6675 6e63 7469 6f6e 7320 746f  vt_ functions to
-00006490: 2063 6f6e 7665 7274 2074 6f2f 6672 6f6d   convert to/from
-000064a0: 2046 5031 360a 0a20 2020 2023 6465 6669   FP16..    #defi
-000064b0: 6e65 2047 474d 4c5f 4631 365f 5354 4550  ne GGML_F16_STEP
-000064c0: 2031 360a 2020 2020 2364 6566 696e 6520   16.    #define 
-000064d0: 4747 4d4c 5f46 3136 5f45 5052 2020 340a  GGML_F16_EPR  4.
-000064e0: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
-000064f0: 4c5f 4633 3243 7834 2020 2020 2020 2020  L_F32Cx4        
-00006500: 2020 2020 2020 666c 6f61 7433 3278 345f        float32x4_
-00006510: 740a 2020 2020 2364 6566 696e 6520 4747  t.    #define GG
-00006520: 4d4c 5f46 3332 4378 345f 5a45 524f 2020  ML_F32Cx4_ZERO  
-00006530: 2020 2020 2020 2076 6475 7071 5f6e 5f66         vdupq_n_f
-00006540: 3332 2830 2e30 6629 0a20 2020 2023 6465  32(0.0f).    #de
-00006550: 6669 6e65 2047 474d 4c5f 4633 3243 7834  fine GGML_F32Cx4
-00006560: 5f53 4554 3128 7829 2020 2020 2020 7664  _SET1(x)      vd
-00006570: 7570 715f 6e5f 6633 3228 7829 0a20 2020  upq_n_f32(x).   
-00006580: 2023 6465 6669 6e65 2047 474d 4c5f 4633   #define GGML_F3
-00006590: 3243 7834 5f4c 4f41 4428 7829 2020 2020  2Cx4_LOAD(x)    
-000065a0: 2020 7663 7674 5f66 3332 5f66 3136 2876    vcvt_f32_f16(v
-000065b0: 6c64 315f 6631 3628 7829 290a 2020 2020  ld1_f16(x)).    
-000065c0: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-000065d0: 4378 345f 5354 4f52 4528 782c 2079 2920  Cx4_STORE(x, y) 
-000065e0: 2076 7374 315f 6631 3628 782c 2076 6376   vst1_f16(x, vcv
-000065f0: 745f 6631 365f 6633 3228 7929 290a 2020  t_f16_f32(y)).  
-00006600: 2020 2364 6566 696e 6520 4747 4d4c 5f46    #define GGML_F
-00006610: 3332 4378 345f 464d 4128 612c 2062 2c20  32Cx4_FMA(a, b, 
-00006620: 6329 2076 666d 6171 5f66 3332 2861 2c20  c) vfmaq_f32(a, 
-00006630: 622c 2063 290a 2020 2020 2364 6566 696e  b, c).    #defin
-00006640: 6520 4747 4d4c 5f46 3332 4378 345f 4144  e GGML_F32Cx4_AD
-00006650: 4420 2020 2020 2020 2020 2076 6164 6471  D          vaddq
-00006660: 5f66 3332 0a20 2020 2023 6465 6669 6e65  _f32.    #define
-00006670: 2047 474d 4c5f 4633 3243 7834 5f4d 554c   GGML_F32Cx4_MUL
-00006680: 2020 2020 2020 2020 2020 766d 756c 715f            vmulq_
-00006690: 6633 320a 2020 2020 2364 6566 696e 6520  f32.    #define 
-000066a0: 4747 4d4c 5f46 3332 4378 345f 5245 4455  GGML_F32Cx4_REDU
-000066b0: 4345 2020 2020 2020 2047 474d 4c5f 4633  CE       GGML_F3
-000066c0: 3278 345f 5245 4455 4345 0a0a 2020 2020  2x4_REDUCE..    
-000066d0: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
-000066e0: 5f56 4543 2020 2020 2020 2020 2020 2020  _VEC            
-000066f0: 2020 2020 4747 4d4c 5f46 3332 4378 340a      GGML_F32Cx4.
-00006700: 2020 2020 2364 6566 696e 6520 4747 4d4c      #define GGML
-00006710: 5f46 3136 5f56 4543 5f5a 4552 4f20 2020  _F16_VEC_ZERO   
-00006720: 2020 2020 2020 2020 4747 4d4c 5f46 3332          GGML_F32
-00006730: 4378 345f 5a45 524f 0a20 2020 2023 6465  Cx4_ZERO.    #de
-00006740: 6669 6e65 2047 474d 4c5f 4631 365f 5645  fine GGML_F16_VE
-00006750: 435f 5345 5431 2020 2020 2020 2020 2020  C_SET1          
-00006760: 2047 474d 4c5f 4633 3243 7834 5f53 4554   GGML_F32Cx4_SET
-00006770: 310a 2020 2020 2364 6566 696e 6520 4747  1.    #define GG
-00006780: 4d4c 5f46 3136 5f56 4543 5f4c 4f41 4428  ML_F16_VEC_LOAD(
-00006790: 702c 2069 2920 2020 2020 4747 4d4c 5f46  p, i)     GGML_F
-000067a0: 3332 4378 345f 4c4f 4144 2870 290a 2020  32Cx4_LOAD(p).  
-000067b0: 2020 2364 6566 696e 6520 4747 4d4c 5f46    #define GGML_F
-000067c0: 3136 5f56 4543 5f53 544f 5245 2870 2c20  16_VEC_STORE(p, 
-000067d0: 722c 2069 2920 4747 4d4c 5f46 3332 4378  r, i) GGML_F32Cx
-000067e0: 345f 5354 4f52 4528 702c 2072 5b69 5d29  4_STORE(p, r[i])
-000067f0: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
-00006800: 4c5f 4631 365f 5645 435f 464d 4120 2020  L_F16_VEC_FMA   
-00006810: 2020 2020 2020 2020 2047 474d 4c5f 4633           GGML_F3
-00006820: 3243 7834 5f46 4d41 0a20 2020 2023 6465  2Cx4_FMA.    #de
-00006830: 6669 6e65 2047 474d 4c5f 4631 365f 5645  fine GGML_F16_VE
-00006840: 435f 4144 4420 2020 2020 2020 2020 2020  C_ADD           
-00006850: 2047 474d 4c5f 4633 3243 7834 5f41 4444   GGML_F32Cx4_ADD
-00006860: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
-00006870: 4c5f 4631 365f 5645 435f 4d55 4c20 2020  L_F16_VEC_MUL   
-00006880: 2020 2020 2020 2020 2047 474d 4c5f 4633           GGML_F3
-00006890: 3243 7834 5f4d 554c 0a20 2020 2023 6465  2Cx4_MUL.    #de
-000068a0: 6669 6e65 2047 474d 4c5f 4631 365f 5645  fine GGML_F16_VE
-000068b0: 435f 5245 4455 4345 2020 2020 2020 2020  C_REDUCE        
-000068c0: 2047 474d 4c5f 4633 3243 7834 5f52 4544   GGML_F32Cx4_RED
-000068d0: 5543 450a 2365 6e64 6966 0a0a 2365 6c69  UCE.#endif..#eli
-000068e0: 6620 6465 6669 6e65 6428 5f5f 4156 585f  f defined(__AVX_
-000068f0: 5f29 0a0a 2364 6566 696e 6520 4747 4d4c  _)..#define GGML
-00006900: 5f53 494d 440a 0a2f 2f20 4633 3220 4156  _SIMD..// F32 AV
-00006910: 580a 0a23 6465 6669 6e65 2047 474d 4c5f  X..#define GGML_
-00006920: 4633 325f 5354 4550 2033 320a 2364 6566  F32_STEP 32.#def
-00006930: 696e 6520 4747 4d4c 5f46 3332 5f45 5052  ine GGML_F32_EPR
-00006940: 2020 380a 0a23 6465 6669 6e65 2047 474d    8..#define GGM
-00006950: 4c5f 4633 3278 3820 2020 2020 2020 2020  L_F32x8         
-00006960: 5f5f 6d32 3536 0a23 6465 6669 6e65 2047  __m256.#define G
-00006970: 474d 4c5f 4633 3278 385f 5a45 524f 2020  GML_F32x8_ZERO  
-00006980: 2020 5f6d 6d32 3536 5f73 6574 7a65 726f    _mm256_setzero
-00006990: 5f70 7328 290a 2364 6566 696e 6520 4747  _ps().#define GG
-000069a0: 4d4c 5f46 3332 7838 5f53 4554 3128 7829  ML_F32x8_SET1(x)
-000069b0: 205f 6d6d 3235 365f 7365 7431 5f70 7328   _mm256_set1_ps(
-000069c0: 7829 0a23 6465 6669 6e65 2047 474d 4c5f  x).#define GGML_
-000069d0: 4633 3278 385f 4c4f 4144 2020 2020 5f6d  F32x8_LOAD    _m
-000069e0: 6d32 3536 5f6c 6f61 6475 5f70 730a 2364  m256_loadu_ps.#d
-000069f0: 6566 696e 6520 4747 4d4c 5f46 3332 7838  efine GGML_F32x8
-00006a00: 5f53 544f 5245 2020 205f 6d6d 3235 365f  _STORE   _mm256_
-00006a10: 7374 6f72 6575 5f70 730a 2369 6620 6465  storeu_ps.#if de
-00006a20: 6669 6e65 6428 5f5f 464d 415f 5f29 0a20  fined(__FMA__). 
-00006a30: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
-00006a40: 4633 3278 385f 464d 4128 612c 2062 2c20  F32x8_FMA(a, b, 
-00006a50: 6329 205f 6d6d 3235 365f 666d 6164 645f  c) _mm256_fmadd_
-00006a60: 7073 2862 2c20 632c 2061 290a 2365 6c73  ps(b, c, a).#els
-00006a70: 650a 2020 2020 2364 6566 696e 6520 4747  e.    #define GG
-00006a80: 4d4c 5f46 3332 7838 5f46 4d41 2861 2c20  ML_F32x8_FMA(a, 
-00006a90: 622c 2063 2920 5f6d 6d32 3536 5f61 6464  b, c) _mm256_add
-00006aa0: 5f70 7328 5f6d 6d32 3536 5f6d 756c 5f70  _ps(_mm256_mul_p
-00006ab0: 7328 622c 2063 292c 2061 290a 2365 6e64  s(b, c), a).#end
-00006ac0: 6966 0a23 6465 6669 6e65 2047 474d 4c5f  if.#define GGML_
-00006ad0: 4633 3278 385f 4144 4420 2020 2020 5f6d  F32x8_ADD     _m
-00006ae0: 6d32 3536 5f61 6464 5f70 730a 2364 6566  m256_add_ps.#def
-00006af0: 696e 6520 4747 4d4c 5f46 3332 7838 5f4d  ine GGML_F32x8_M
-00006b00: 554c 2020 2020 205f 6d6d 3235 365f 6d75  UL     _mm256_mu
-00006b10: 6c5f 7073 0a23 6465 6669 6e65 2047 474d  l_ps.#define GGM
-00006b20: 4c5f 4633 3278 385f 5245 4455 4345 2872  L_F32x8_REDUCE(r
-00006b30: 6573 2c20 7829 2020 2020 2020 2020 2020  es, x)          
-00006b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b50: 2020 2020 2020 205c 0a7b 2020 2020 2020         \.{      
-00006b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b90: 2020 2020 2020 2020 2020 205c 0a20 2020             \.   
-00006ba0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00006bb0: 2069 203c 2047 474d 4c5f 4633 325f 4152   i < GGML_F32_AR
-00006bc0: 522f 323b 202b 2b69 2920 7b20 2020 2020  R/2; ++i) {     
-00006bd0: 2020 2020 2020 2020 2020 2020 2020 205c                 \
-00006be0: 0a20 2020 2020 2020 2078 5b32 2a69 5d20  .        x[2*i] 
-00006bf0: 3d20 5f6d 6d32 3536 5f61 6464 5f70 7328  = _mm256_add_ps(
-00006c00: 785b 322a 695d 2c20 785b 322a 692b 315d  x[2*i], x[2*i+1]
-00006c10: 293b 2020 2020 2020 2020 2020 2020 2020  );              
-00006c20: 2020 205c 0a20 2020 207d 2020 2020 2020     \.    }      
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c60: 2020 2020 2020 205c 0a20 2020 2066 6f72         \.    for
-00006c70: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00006c80: 2047 474d 4c5f 4633 325f 4152 522f 343b   GGML_F32_ARR/4;
-00006c90: 202b 2b69 2920 7b20 2020 2020 2020 2020   ++i) {         
-00006ca0: 2020 2020 2020 2020 2020 205c 0a20 2020             \.   
-00006cb0: 2020 2020 2078 5b34 2a69 5d20 3d20 5f6d       x[4*i] = _m
-00006cc0: 6d32 3536 5f61 6464 5f70 7328 785b 342a  m256_add_ps(x[4*
-00006cd0: 695d 2c20 785b 342a 692b 325d 293b 2020  i], x[4*i+2]);  
-00006ce0: 2020 2020 2020 2020 2020 2020 2020 205c                 \
-00006cf0: 0a20 2020 207d 2020 2020 2020 2020 2020  .    }          
-00006d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d30: 2020 205c 0a20 2020 2066 6f72 2028 696e     \.    for (in
-00006d40: 7420 6920 3d20 303b 2069 203c 2047 474d  t i = 0; i < GGM
-00006d50: 4c5f 4633 325f 4152 522f 383b 202b 2b69  L_F32_ARR/8; ++i
-00006d60: 2920 7b20 2020 2020 2020 2020 2020 2020  ) {             
-00006d70: 2020 2020 2020 205c 0a20 2020 2020 2020         \.       
-00006d80: 2078 5b38 2a69 5d20 3d20 5f6d 6d32 3536   x[8*i] = _mm256
-00006d90: 5f61 6464 5f70 7328 785b 382a 695d 2c20  _add_ps(x[8*i], 
-00006da0: 785b 382a 692b 345d 293b 2020 2020 2020  x[8*i+4]);      
-00006db0: 2020 2020 2020 2020 2020 205c 0a20 2020             \.   
-00006dc0: 207d 2020 2020 2020 2020 2020 2020 2020   }              
-00006dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006df0: 2020 2020 2020 2020 2020 2020 2020 205c                 \
-00006e00: 0a20 2020 2063 6f6e 7374 205f 5f6d 3132  .    const __m12
-00006e10: 3820 7430 203d 205f 6d6d 5f61 6464 5f70  8 t0 = _mm_add_p
-00006e20: 7328 5f6d 6d32 3536 5f63 6173 7470 7332  s(_mm256_castps2
-00006e30: 3536 5f70 7331 3238 2878 5b30 5d29 2c20  56_ps128(x[0]), 
-00006e40: 2020 205c 0a20 2020 2020 2020 2020 2020     \.           
-00006e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e60: 2020 2020 2020 5f6d 6d32 3536 5f65 7874        _mm256_ext
-00006e70: 7261 6374 6631 3238 5f70 7328 785b 305d  ractf128_ps(x[0]
-00006e80: 2c20 3129 293b 205c 0a20 2020 2063 6f6e  , 1)); \.    con
-00006e90: 7374 205f 5f6d 3132 3820 7431 203d 205f  st __m128 t1 = _
-00006ea0: 6d6d 5f68 6164 645f 7073 2874 302c 2074  mm_hadd_ps(t0, t
-00006eb0: 3029 3b20 2020 2020 2020 2020 2020 2020  0);             
-00006ec0: 2020 2020 2020 2020 2020 205c 0a20 2020             \.   
-00006ed0: 2072 6573 203d 205f 6d6d 5f63 7674 7373   res = _mm_cvtss
-00006ee0: 5f66 3332 285f 6d6d 5f68 6164 645f 7073  _f32(_mm_hadd_ps
-00006ef0: 2874 312c 2074 3129 293b 2020 2020 2020  (t1, t1));      
-00006f00: 2020 2020 2020 2020 2020 2020 2020 205c                 \
-00006f10: 0a7d 0a2f 2f20 544f 444f 3a20 6973 2074  .}.// TODO: is t
-00006f20: 6869 7320 6f70 7469 6d61 6c20 3f0a 0a23  his optimal ?..#
-00006f30: 6465 6669 6e65 2047 474d 4c5f 4633 325f  define GGML_F32_
-00006f40: 5645 4320 2020 2020 2020 2047 474d 4c5f  VEC        GGML_
-00006f50: 4633 3278 380a 2364 6566 696e 6520 4747  F32x8.#define GG
-00006f60: 4d4c 5f46 3332 5f56 4543 5f5a 4552 4f20  ML_F32_VEC_ZERO 
-00006f70: 2020 4747 4d4c 5f46 3332 7838 5f5a 4552    GGML_F32x8_ZER
-00006f80: 4f0a 2364 6566 696e 6520 4747 4d4c 5f46  O.#define GGML_F
-00006f90: 3332 5f56 4543 5f53 4554 3120 2020 4747  32_VEC_SET1   GG
-00006fa0: 4d4c 5f46 3332 7838 5f53 4554 310a 2364  ML_F32x8_SET1.#d
-00006fb0: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
-00006fc0: 4543 5f4c 4f41 4420 2020 4747 4d4c 5f46  EC_LOAD   GGML_F
-00006fd0: 3332 7838 5f4c 4f41 440a 2364 6566 696e  32x8_LOAD.#defin
-00006fe0: 6520 4747 4d4c 5f46 3332 5f56 4543 5f53  e GGML_F32_VEC_S
-00006ff0: 544f 5245 2020 4747 4d4c 5f46 3332 7838  TORE  GGML_F32x8
-00007000: 5f53 544f 5245 0a23 6465 6669 6e65 2047  _STORE.#define G
-00007010: 474d 4c5f 4633 325f 5645 435f 464d 4120  GML_F32_VEC_FMA 
-00007020: 2020 2047 474d 4c5f 4633 3278 385f 464d     GGML_F32x8_FM
-00007030: 410a 2364 6566 696e 6520 4747 4d4c 5f46  A.#define GGML_F
-00007040: 3332 5f56 4543 5f41 4444 2020 2020 4747  32_VEC_ADD    GG
-00007050: 4d4c 5f46 3332 7838 5f41 4444 0a23 6465  ML_F32x8_ADD.#de
-00007060: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
-00007070: 435f 4d55 4c20 2020 2047 474d 4c5f 4633  C_MUL    GGML_F3
-00007080: 3278 385f 4d55 4c0a 2364 6566 696e 6520  2x8_MUL.#define 
-00007090: 4747 4d4c 5f46 3332 5f56 4543 5f52 4544  GGML_F32_VEC_RED
-000070a0: 5543 4520 4747 4d4c 5f46 3332 7838 5f52  UCE GGML_F32x8_R
-000070b0: 4544 5543 450a 0a2f 2f20 4631 3620 4156  EDUCE..// F16 AV
-000070c0: 580a 0a23 6465 6669 6e65 2047 474d 4c5f  X..#define GGML_
-000070d0: 4631 365f 5354 4550 2033 320a 2364 6566  F16_STEP 32.#def
-000070e0: 696e 6520 4747 4d4c 5f46 3136 5f45 5052  ine GGML_F16_EPR
-000070f0: 2020 380a 0a2f 2f20 4631 3620 6172 6974    8..// F16 arit
-00007100: 686d 6574 6963 2069 7320 6e6f 7420 7375  hmetic is not su
-00007110: 7070 6f72 7465 6420 6279 2041 5658 2c20  pported by AVX, 
-00007120: 736f 2077 6520 7573 6520 4633 3220 696e  so we use F32 in
-00007130: 7374 6561 640a 2f2f 2077 6520 7461 6b65  stead.// we take
-00007140: 2061 6476 616e 7461 6765 206f 6620 7468   advantage of th
-00007150: 6520 5f6d 6d32 3536 5f63 7674 2069 6e74  e _mm256_cvt int
-00007160: 7269 6e73 6963 7320 746f 2063 6f6e 7665  rinsics to conve
-00007170: 7274 2046 3136 203c 2d3e 2046 3332 0a0a  rt F16 <-> F32..
-00007180: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-00007190: 4378 3820 2020 2020 2020 2020 2020 2020  Cx8             
-000071a0: 5f5f 6d32 3536 0a23 6465 6669 6e65 2047  __m256.#define G
-000071b0: 474d 4c5f 4633 3243 7838 5f5a 4552 4f20  GML_F32Cx8_ZERO 
-000071c0: 2020 2020 2020 205f 6d6d 3235 365f 7365         _mm256_se
-000071d0: 747a 6572 6f5f 7073 2829 0a23 6465 6669  tzero_ps().#defi
-000071e0: 6e65 2047 474d 4c5f 4633 3243 7838 5f53  ne GGML_F32Cx8_S
-000071f0: 4554 3128 7829 2020 2020 205f 6d6d 3235  ET1(x)     _mm25
-00007200: 365f 7365 7431 5f70 7328 7829 0a23 6465  6_set1_ps(x).#de
-00007210: 6669 6e65 2047 474d 4c5f 4633 3243 7838  fine GGML_F32Cx8
-00007220: 5f4c 4f41 4428 7829 2020 2020 205f 6d6d  _LOAD(x)     _mm
-00007230: 3235 365f 6376 7470 685f 7073 285f 6d6d  256_cvtph_ps(_mm
-00007240: 5f6c 6f61 6475 5f73 6931 3238 2828 5f5f  _loadu_si128((__
-00007250: 6d31 3238 6920 2a29 2878 2929 290a 2364  m128i *)(x))).#d
-00007260: 6566 696e 6520 4747 4d4c 5f46 3332 4378  efine GGML_F32Cx
-00007270: 385f 5354 4f52 4528 782c 2079 2920 5f6d  8_STORE(x, y) _m
-00007280: 6d5f 7374 6f72 6575 5f73 6931 3238 2828  m_storeu_si128((
-00007290: 5f5f 6d31 3238 6920 2a29 2878 292c 205f  __m128i *)(x), _
-000072a0: 6d6d 3235 365f 6376 7470 735f 7068 2879  mm256_cvtps_ph(y
-000072b0: 2c20 3029 290a 2364 6566 696e 6520 4747  , 0)).#define GG
-000072c0: 4d4c 5f46 3332 4378 385f 464d 4120 2020  ML_F32Cx8_FMA   
-000072d0: 2020 2020 2020 4747 4d4c 5f46 3332 7838        GGML_F32x8
-000072e0: 5f46 4d41 0a23 6465 6669 6e65 2047 474d  _FMA.#define GGM
-000072f0: 4c5f 4633 3243 7838 5f41 4444 2020 2020  L_F32Cx8_ADD    
-00007300: 2020 2020 205f 6d6d 3235 365f 6164 645f       _mm256_add_
-00007310: 7073 0a23 6465 6669 6e65 2047 474d 4c5f  ps.#define GGML_
-00007320: 4633 3243 7838 5f4d 554c 2020 2020 2020  F32Cx8_MUL      
-00007330: 2020 205f 6d6d 3235 365f 6d75 6c5f 7073     _mm256_mul_ps
-00007340: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00007350: 3243 7838 5f52 4544 5543 4520 2020 2020  2Cx8_REDUCE     
-00007360: 2047 474d 4c5f 4633 3278 385f 5245 4455   GGML_F32x8_REDU
-00007370: 4345 0a0a 2364 6566 696e 6520 4747 4d4c  CE..#define GGML
-00007380: 5f46 3136 5f56 4543 2020 2020 2020 2020  _F16_VEC        
-00007390: 2020 2020 2020 2020 4747 4d4c 5f46 3332          GGML_F32
-000073a0: 4378 380a 2364 6566 696e 6520 4747 4d4c  Cx8.#define GGML
-000073b0: 5f46 3136 5f56 4543 5f5a 4552 4f20 2020  _F16_VEC_ZERO   
-000073c0: 2020 2020 2020 2020 4747 4d4c 5f46 3332          GGML_F32
-000073d0: 4378 385f 5a45 524f 0a23 6465 6669 6e65  Cx8_ZERO.#define
-000073e0: 2047 474d 4c5f 4631 365f 5645 435f 5345   GGML_F16_VEC_SE
-000073f0: 5431 2020 2020 2020 2020 2020 2047 474d  T1           GGM
-00007400: 4c5f 4633 3243 7838 5f53 4554 310a 2364  L_F32Cx8_SET1.#d
-00007410: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
-00007420: 4543 5f4c 4f41 4428 702c 2069 2920 2020  EC_LOAD(p, i)   
-00007430: 2020 4747 4d4c 5f46 3332 4378 385f 4c4f    GGML_F32Cx8_LO
-00007440: 4144 2870 290a 2364 6566 696e 6520 4747  AD(p).#define GG
-00007450: 4d4c 5f46 3136 5f56 4543 5f53 544f 5245  ML_F16_VEC_STORE
-00007460: 2870 2c20 722c 2069 2920 4747 4d4c 5f46  (p, r, i) GGML_F
-00007470: 3332 4378 385f 5354 4f52 4528 702c 2072  32Cx8_STORE(p, r
-00007480: 5b69 5d29 0a23 6465 6669 6e65 2047 474d  [i]).#define GGM
-00007490: 4c5f 4631 365f 5645 435f 464d 4120 2020  L_F16_VEC_FMA   
-000074a0: 2020 2020 2020 2020 2047 474d 4c5f 4633           GGML_F3
-000074b0: 3243 7838 5f46 4d41 0a23 6465 6669 6e65  2Cx8_FMA.#define
-000074c0: 2047 474d 4c5f 4631 365f 5645 435f 4144   GGML_F16_VEC_AD
-000074d0: 4420 2020 2020 2020 2020 2020 2047 474d  D            GGM
-000074e0: 4c5f 4633 3243 7838 5f41 4444 0a23 6465  L_F32Cx8_ADD.#de
-000074f0: 6669 6e65 2047 474d 4c5f 4631 365f 5645  fine GGML_F16_VE
-00007500: 435f 4d55 4c20 2020 2020 2020 2020 2020  C_MUL           
-00007510: 2047 474d 4c5f 4633 3243 7838 5f4d 554c   GGML_F32Cx8_MUL
-00007520: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
-00007530: 365f 5645 435f 5245 4455 4345 2020 2020  6_VEC_REDUCE    
-00007540: 2020 2020 2047 474d 4c5f 4633 3243 7838       GGML_F32Cx8
-00007550: 5f52 4544 5543 450a 0a23 656c 6966 2064  _REDUCE..#elif d
-00007560: 6566 696e 6564 285f 5f50 4f57 4552 395f  efined(__POWER9_
-00007570: 5645 4354 4f52 5f5f 290a 0a23 6465 6669  VECTOR__)..#defi
-00007580: 6e65 2047 474d 4c5f 5349 4d44 0a0a 2f2f  ne GGML_SIMD..//
-00007590: 2046 3332 2050 4f57 4552 390a 0a23 6465   F32 POWER9..#de
-000075a0: 6669 6e65 2047 474d 4c5f 4633 325f 5354  fine GGML_F32_ST
-000075b0: 4550 2033 320a 2364 6566 696e 6520 4747  EP 32.#define GG
-000075c0: 4d4c 5f46 3332 5f45 5052 2020 340a 0a23  ML_F32_EPR  4..#
-000075d0: 6465 6669 6e65 2047 474d 4c5f 4633 3278  define GGML_F32x
-000075e0: 3420 2020 2020 2020 2020 2020 2020 2076  4              v
-000075f0: 6563 746f 7220 666c 6f61 740a 2364 6566  ector float.#def
-00007600: 696e 6520 4747 4d4c 5f46 3332 7834 5f5a  ine GGML_F32x4_Z
-00007610: 4552 4f20 2020 2020 2020 2020 302e 3066  ERO         0.0f
-00007620: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00007630: 3278 345f 5345 5431 2020 2020 2020 2020  2x4_SET1        
-00007640: 2076 6563 5f73 706c 6174 730a 2364 6566   vec_splats.#def
-00007650: 696e 6520 4747 4d4c 5f46 3332 7834 5f4c  ine GGML_F32x4_L
-00007660: 4f41 4428 7029 2020 2020 2020 7665 635f  OAD(p)      vec_
-00007670: 786c 2830 2c20 7029 0a23 6465 6669 6e65  xl(0, p).#define
-00007680: 2047 474d 4c5f 4633 3278 345f 5354 4f52   GGML_F32x4_STOR
-00007690: 4528 702c 2072 2920 2076 6563 5f78 7374  E(p, r)  vec_xst
-000076a0: 2872 2c20 302c 2070 290a 2364 6566 696e  (r, 0, p).#defin
-000076b0: 6520 4747 4d4c 5f46 3332 7834 5f46 4d41  e GGML_F32x4_FMA
-000076c0: 2861 2c20 622c 2063 2920 7665 635f 6d61  (a, b, c) vec_ma
-000076d0: 6464 2862 2c20 632c 2061 290a 2364 6566  dd(b, c, a).#def
-000076e0: 696e 6520 4747 4d4c 5f46 3332 7834 5f41  ine GGML_F32x4_A
-000076f0: 4444 2020 2020 2020 2020 2020 7665 635f  DD          vec_
-00007700: 6164 640a 2364 6566 696e 6520 4747 4d4c  add.#define GGML
-00007710: 5f46 3332 7834 5f4d 554c 2020 2020 2020  _F32x4_MUL      
-00007720: 2020 2020 7665 635f 6d75 6c0a 2364 6566      vec_mul.#def
-00007730: 696e 6520 4747 4d4c 5f46 3332 7834 5f52  ine GGML_F32x4_R
-00007740: 4544 5543 4528 7265 732c 2078 2920 2020  EDUCE(res, x)   
-00007750: 2020 2020 2020 2020 2020 205c 0a7b 2020             \.{  
-00007760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007780: 2020 2020 2020 2020 2020 2020 5c0a 2020              \.  
-00007790: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-000077a0: 3b20 6920 3c20 4747 4d4c 5f46 3332 5f41  ; i < GGML_F32_A
-000077b0: 5252 2f32 3b20 2b2b 6929 207b 205c 0a20  RR/2; ++i) { \. 
-000077c0: 2020 2020 2020 2078 5b32 2a69 5d20 3d20         x[2*i] = 
-000077d0: 7665 635f 6164 6428 785b 322a 695d 2c20  vec_add(x[2*i], 
-000077e0: 785b 322a 692b 315d 293b 2020 2020 5c0a  x[2*i+1]);    \.
-000077f0: 2020 2020 7d20 2020 2020 2020 2020 2020      }           
-00007800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007810: 2020 2020 2020 2020 2020 2020 2020 205c                 \
-00007820: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-00007830: 3d20 303b 2069 203c 2047 474d 4c5f 4633  = 0; i < GGML_F3
-00007840: 325f 4152 522f 343b 202b 2b69 2920 7b20  2_ARR/4; ++i) { 
-00007850: 5c0a 2020 2020 2020 2020 785b 342a 695d  \.        x[4*i]
-00007860: 203d 2076 6563 5f61 6464 2878 5b34 2a69   = vec_add(x[4*i
-00007870: 5d2c 2078 5b34 2a69 2b32 5d29 3b20 2020  ], x[4*i+2]);   
-00007880: 205c 0a20 2020 207d 2020 2020 2020 2020   \.    }        
-00007890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078b0: 2020 5c0a 2020 2020 666f 7220 2869 6e74    \.    for (int
-000078c0: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
-000078d0: 5f46 3332 5f41 5252 2f38 3b20 2b2b 6929  _F32_ARR/8; ++i)
-000078e0: 207b 205c 0a20 2020 2020 2020 2078 5b38   { \.        x[8
-000078f0: 2a69 5d20 3d20 7665 635f 6164 6428 785b  *i] = vec_add(x[
-00007900: 382a 695d 2c20 785b 382a 692b 345d 293b  8*i], x[8*i+4]);
-00007910: 2020 2020 5c0a 2020 2020 7d20 2020 2020      \.    }     
-00007920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007940: 2020 2020 205c 0a20 2020 2072 6573 203d       \.    res =
-00007950: 2076 6563 5f65 7874 7261 6374 2878 5b30   vec_extract(x[0
-00007960: 5d2c 2030 2920 2b20 2020 2020 2020 2020  ], 0) +         
-00007970: 2020 2020 2020 5c0a 2020 2020 2020 2020        \.        
-00007980: 2020 7665 635f 6578 7472 6163 7428 785b    vec_extract(x[
-00007990: 305d 2c20 3129 202b 2020 2020 2020 2020  0], 1) +        
-000079a0: 2020 2020 2020 205c 0a20 2020 2020 2020         \.       
-000079b0: 2020 2076 6563 5f65 7874 7261 6374 2878     vec_extract(x
-000079c0: 5b30 5d2c 2032 2920 2b20 2020 2020 2020  [0], 2) +       
-000079d0: 2020 2020 2020 2020 5c0a 2020 2020 2020          \.      
-000079e0: 2020 2020 7665 635f 6578 7472 6163 7428      vec_extract(
-000079f0: 785b 305d 2c20 3329 3b20 2020 2020 2020  x[0], 3);       
-00007a00: 2020 2020 2020 2020 205c 0a7d 0a0a 2364           \.}..#d
-00007a10: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
-00007a20: 4543 2020 2020 2020 2020 4747 4d4c 5f46  EC        GGML_F
-00007a30: 3332 7834 0a23 6465 6669 6e65 2047 474d  32x4.#define GGM
-00007a40: 4c5f 4633 325f 5645 435f 5a45 524f 2020  L_F32_VEC_ZERO  
-00007a50: 2047 474d 4c5f 4633 3278 345f 5a45 524f   GGML_F32x4_ZERO
-00007a60: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00007a70: 325f 5645 435f 5345 5431 2020 2047 474d  2_VEC_SET1   GGM
-00007a80: 4c5f 4633 3278 345f 5345 5431 0a23 6465  L_F32x4_SET1.#de
-00007a90: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
-00007aa0: 435f 4c4f 4144 2020 2047 474d 4c5f 4633  C_LOAD   GGML_F3
-00007ab0: 3278 345f 4c4f 4144 0a23 6465 6669 6e65  2x4_LOAD.#define
-00007ac0: 2047 474d 4c5f 4633 325f 5645 435f 5354   GGML_F32_VEC_ST
-00007ad0: 4f52 4520 2047 474d 4c5f 4633 3278 345f  ORE  GGML_F32x4_
-00007ae0: 5354 4f52 450a 2364 6566 696e 6520 4747  STORE.#define GG
-00007af0: 4d4c 5f46 3332 5f56 4543 5f46 4d41 2020  ML_F32_VEC_FMA  
-00007b00: 2020 4747 4d4c 5f46 3332 7834 5f46 4d41    GGML_F32x4_FMA
-00007b10: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00007b20: 325f 5645 435f 4144 4420 2020 2047 474d  2_VEC_ADD    GGM
-00007b30: 4c5f 4633 3278 345f 4144 440a 2364 6566  L_F32x4_ADD.#def
-00007b40: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
-00007b50: 5f4d 554c 2020 2020 4747 4d4c 5f46 3332  _MUL    GGML_F32
-00007b60: 7834 5f4d 554c 0a23 6465 6669 6e65 2047  x4_MUL.#define G
-00007b70: 474d 4c5f 4633 325f 5645 435f 5245 4455  GML_F32_VEC_REDU
-00007b80: 4345 2047 474d 4c5f 4633 3278 345f 5245  CE GGML_F32x4_RE
-00007b90: 4455 4345 0a0a 2f2f 2046 3136 2050 4f57  DUCE..// F16 POW
-00007ba0: 4552 390a 2364 6566 696e 6520 4747 4d4c  ER9.#define GGML
-00007bb0: 5f46 3136 5f53 5445 5020 2020 2020 2020  _F16_STEP       
-00007bc0: 4747 4d4c 5f46 3332 5f53 5445 500a 2364  GGML_F32_STEP.#d
-00007bd0: 6566 696e 6520 4747 4d4c 5f46 3136 5f45  efine GGML_F16_E
-00007be0: 5052 2020 2020 2020 2020 4747 4d4c 5f46  PR        GGML_F
-00007bf0: 3332 5f45 5052 0a23 6465 6669 6e65 2047  32_EPR.#define G
-00007c00: 474d 4c5f 4631 365f 5645 4320 2020 2020  GML_F16_VEC     
-00007c10: 2020 2047 474d 4c5f 4633 3278 340a 2364     GGML_F32x4.#d
-00007c20: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
-00007c30: 4543 5f5a 4552 4f20 2020 4747 4d4c 5f46  EC_ZERO   GGML_F
-00007c40: 3332 7834 5f5a 4552 4f0a 2364 6566 696e  32x4_ZERO.#defin
-00007c50: 6520 4747 4d4c 5f46 3136 5f56 4543 5f53  e GGML_F16_VEC_S
-00007c60: 4554 3120 2020 4747 4d4c 5f46 3332 7834  ET1   GGML_F32x4
-00007c70: 5f53 4554 310a 2364 6566 696e 6520 4747  _SET1.#define GG
-00007c80: 4d4c 5f46 3136 5f56 4543 5f46 4d41 2020  ML_F16_VEC_FMA  
-00007c90: 2020 4747 4d4c 5f46 3332 7834 5f46 4d41    GGML_F32x4_FMA
-00007ca0: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
-00007cb0: 365f 5645 435f 5245 4455 4345 2047 474d  6_VEC_REDUCE GGM
-00007cc0: 4c5f 4633 3278 345f 5245 4455 4345 0a2f  L_F32x4_REDUCE./
-00007cd0: 2f20 5573 6520 7665 635f 786c 2c20 6e6f  / Use vec_xl, no
-00007ce0: 7420 7665 635f 6c64 2c20 696e 2063 6173  t vec_ld, in cas
-00007cf0: 6520 7468 6520 6c6f 6164 2061 6464 7265  e the load addre
-00007d00: 7373 2069 7320 6e6f 7420 616c 6967 6e65  ss is not aligne
-00007d10: 642e 0a23 6465 6669 6e65 2047 474d 4c5f  d..#define GGML_
-00007d20: 4631 365f 5645 435f 4c4f 4144 2870 2c20  F16_VEC_LOAD(p, 
-00007d30: 6929 2028 6920 2620 3078 3129 203f 2020  i) (i & 0x1) ?  
-00007d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d50: 205c 0a20 2076 6563 5f65 7874 7261 6374   \.  vec_extract
-00007d60: 5f66 7033 325f 6672 6f6d 5f73 686f 7274  _fp32_from_short
-00007d70: 6828 7665 635f 786c 2830 2c20 7020 2d20  h(vec_xl(0, p - 
-00007d80: 4747 4d4c 5f46 3136 5f45 5052 2929 203a  GGML_F16_EPR)) :
-00007d90: 205c 0a20 2076 6563 5f65 7874 7261 6374   \.  vec_extract
-00007da0: 5f66 7033 325f 6672 6f6d 5f73 686f 7274  _fp32_from_short
-00007db0: 6c28 7665 635f 786c 2830 2c20 7029 290a  l(vec_xl(0, p)).
-00007dc0: 2364 6566 696e 6520 4747 4d4c 5f45 4e44  #define GGML_END
-00007dd0: 4941 4e5f 4259 5445 2869 2920 2828 756e  IAN_BYTE(i) ((un
-00007de0: 7369 676e 6564 2063 6861 7220 2a29 2628  signed char *)&(
-00007df0: 7569 6e74 3136 5f74 297b 317d 295b 695d  uint16_t){1})[i]
-00007e00: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
-00007e10: 365f 5645 435f 5354 4f52 4528 702c 2072  6_VEC_STORE(p, r
-00007e20: 2c20 6929 2020 2020 2020 2020 2020 2020  , i)            
-00007e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e40: 205c 0a20 2069 6620 2869 2026 2030 7831   \.  if (i & 0x1
-00007e50: 2920 2020 2020 2020 2020 2020 2020 2020  )               
-00007e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e80: 2020 205c 0a20 2020 2076 6563 5f78 7374     \.    vec_xst
-00007e90: 2876 6563 5f70 6163 6b5f 746f 5f73 686f  (vec_pack_to_sho
-00007ea0: 7274 5f66 7033 3228 725b 6920 2d20 4747  rt_fp32(r[i - GG
-00007eb0: 4d4c 5f45 4e44 4941 4e5f 4259 5445 2831  ML_ENDIAN_BYTE(1
-00007ec0: 295d 2c20 205c 0a20 2020 2020 2020 2020  )],  \.         
-00007ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ee0: 2020 2020 2020 2020 2020 725b 6920 2d20            r[i - 
-00007ef0: 4747 4d4c 5f45 4e44 4941 4e5f 4259 5445  GGML_ENDIAN_BYTE
-00007f00: 2830 295d 292c 205c 0a20 2020 2020 2020  (0)]), \.       
-00007f10: 2020 2020 2030 2c20 7020 2d20 4747 4d4c       0, p - GGML
-00007f20: 5f46 3136 5f45 5052 290a 0a23 656c 6966  _F16_EPR)..#elif
-00007f30: 2064 6566 696e 6564 285f 5f77 6173 6d5f   defined(__wasm_
-00007f40: 7369 6d64 3132 385f 5f29 0a0a 2364 6566  simd128__)..#def
-00007f50: 696e 6520 4747 4d4c 5f53 494d 440a 0a2f  ine GGML_SIMD../
-00007f60: 2f20 4633 3220 5741 534d 0a0a 2364 6566  / F32 WASM..#def
-00007f70: 696e 6520 4747 4d4c 5f46 3332 5f53 5445  ine GGML_F32_STE
-00007f80: 5020 3136 0a23 6465 6669 6e65 2047 474d  P 16.#define GGM
-00007f90: 4c5f 4633 325f 4550 5220 2034 0a0a 2364  L_F32_EPR  4..#d
-00007fa0: 6566 696e 6520 4747 4d4c 5f46 3332 7834  efine GGML_F32x4
-00007fb0: 2020 2020 2020 2020 2020 2020 2020 7631                v1
-00007fc0: 3238 5f74 0a23 6465 6669 6e65 2047 474d  28_t.#define GGM
-00007fd0: 4c5f 4633 3278 345f 5a45 524f 2020 2020  L_F32x4_ZERO    
-00007fe0: 2020 2020 2077 6173 6d5f 6633 3278 345f       wasm_f32x4_
-00007ff0: 7370 6c61 7428 302e 3066 290a 2364 6566  splat(0.0f).#def
-00008000: 696e 6520 4747 4d4c 5f46 3332 7834 5f53  ine GGML_F32x4_S
-00008010: 4554 3128 7829 2020 2020 2020 7761 736d  ET1(x)      wasm
-00008020: 5f66 3332 7834 5f73 706c 6174 2878 290a  _f32x4_splat(x).
-00008030: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-00008040: 7834 5f4c 4f41 4420 2020 2020 2020 2020  x4_LOAD         
-00008050: 7761 736d 5f76 3132 385f 6c6f 6164 0a23  wasm_v128_load.#
-00008060: 6465 6669 6e65 2047 474d 4c5f 4633 3278  define GGML_F32x
-00008070: 345f 5354 4f52 4520 2020 2020 2020 2077  4_STORE        w
-00008080: 6173 6d5f 7631 3238 5f73 746f 7265 0a23  asm_v128_store.#
-00008090: 6465 6669 6e65 2047 474d 4c5f 4633 3278  define GGML_F32x
-000080a0: 345f 464d 4128 612c 2062 2c20 6329 2077  4_FMA(a, b, c) w
-000080b0: 6173 6d5f 6633 3278 345f 6164 6428 7761  asm_f32x4_add(wa
-000080c0: 736d 5f66 3332 7834 5f6d 756c 2862 2c20  sm_f32x4_mul(b, 
-000080d0: 6329 2c20 6129 0a23 6465 6669 6e65 2047  c), a).#define G
-000080e0: 474d 4c5f 4633 3278 345f 4144 4420 2020  GML_F32x4_ADD   
-000080f0: 2020 2020 2020 2077 6173 6d5f 6633 3278         wasm_f32x
-00008100: 345f 6164 640a 2364 6566 696e 6520 4747  4_add.#define GG
-00008110: 4d4c 5f46 3332 7834 5f4d 554c 2020 2020  ML_F32x4_MUL    
-00008120: 2020 2020 2020 7761 736d 5f66 3332 7834        wasm_f32x4
-00008130: 5f6d 756c 0a23 6465 6669 6e65 2047 474d  _mul.#define GGM
-00008140: 4c5f 4633 3278 345f 5245 4455 4345 2872  L_F32x4_REDUCE(r
-00008150: 6573 2c20 7829 2020 2020 2020 2020 2020  es, x)          
-00008160: 2020 2020 2020 2020 5c0a 7b20 2020 2020          \.{     
-00008170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008190: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
-000081a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000081b0: 303b 2069 203c 2047 474d 4c5f 4633 325f  0; i < GGML_F32_
-000081c0: 4152 522f 323b 202b 2b69 2920 7b20 2020  ARR/2; ++i) {   
-000081d0: 2020 5c0a 2020 2020 2020 2020 785b 322a    \.        x[2*
-000081e0: 695d 203d 2077 6173 6d5f 6633 3278 345f  i] = wasm_f32x4_
-000081f0: 6164 6428 785b 322a 695d 2c20 785b 322a  add(x[2*i], x[2*
-00008200: 692b 315d 293b 205c 0a20 2020 207d 2020  i+1]); \.    }  
-00008210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008230: 2020 2020 2020 2020 2020 2020 5c0a 2020              \.  
-00008240: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00008250: 3b20 6920 3c20 4747 4d4c 5f46 3332 5f41  ; i < GGML_F32_A
-00008260: 5252 2f34 3b20 2b2b 6929 207b 2020 2020  RR/4; ++i) {    
-00008270: 205c 0a20 2020 2020 2020 2078 5b34 2a69   \.        x[4*i
-00008280: 5d20 3d20 7761 736d 5f66 3332 7834 5f61  ] = wasm_f32x4_a
-00008290: 6464 2878 5b34 2a69 5d2c 2078 5b34 2a69  dd(x[4*i], x[4*i
-000082a0: 2b32 5d29 3b20 5c0a 2020 2020 7d20 2020  +2]); \.    }   
-000082b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082d0: 2020 2020 2020 2020 2020 205c 0a20 2020             \.   
-000082e0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-000082f0: 2069 203c 2047 474d 4c5f 4633 325f 4152   i < GGML_F32_AR
-00008300: 522f 383b 202b 2b69 2920 7b20 2020 2020  R/8; ++i) {     
-00008310: 5c0a 2020 2020 2020 2020 785b 382a 695d  \.        x[8*i]
-00008320: 203d 2077 6173 6d5f 6633 3278 345f 6164   = wasm_f32x4_ad
-00008330: 6428 785b 382a 695d 2c20 785b 382a 692b  d(x[8*i], x[8*i+
-00008340: 345d 293b 205c 0a20 2020 207d 2020 2020  4]); \.    }    
-00008350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
-00008380: 7265 7320 3d20 7761 736d 5f66 3332 7834  res = wasm_f32x4
-00008390: 5f65 7874 7261 6374 5f6c 616e 6528 785b  _extract_lane(x[
-000083a0: 305d 2c20 3029 202b 2020 2020 2020 205c  0], 0) +       \
-000083b0: 0a20 2020 2020 2020 2020 2077 6173 6d5f  .          wasm_
-000083c0: 6633 3278 345f 6578 7472 6163 745f 6c61  f32x4_extract_la
-000083d0: 6e65 2878 5b30 5d2c 2031 2920 2b20 2020  ne(x[0], 1) +   
-000083e0: 2020 2020 5c0a 2020 2020 2020 2020 2020      \.          
-000083f0: 7761 736d 5f66 3332 7834 5f65 7874 7261  wasm_f32x4_extra
-00008400: 6374 5f6c 616e 6528 785b 305d 2c20 3229  ct_lane(x[0], 2)
-00008410: 202b 2020 2020 2020 205c 0a20 2020 2020   +       \.     
-00008420: 2020 2020 2077 6173 6d5f 6633 3278 345f       wasm_f32x4_
-00008430: 6578 7472 6163 745f 6c61 6e65 2878 5b30  extract_lane(x[0
-00008440: 5d2c 2033 293b 2020 2020 2020 2020 5c0a  ], 3);        \.
-00008450: 7d0a 0a23 6465 6669 6e65 2047 474d 4c5f  }..#define GGML_
-00008460: 4633 325f 5645 4320 2020 2020 2020 2047  F32_VEC        G
-00008470: 474d 4c5f 4633 3278 340a 2364 6566 696e  GML_F32x4.#defin
-00008480: 6520 4747 4d4c 5f46 3332 5f56 4543 5f5a  e GGML_F32_VEC_Z
-00008490: 4552 4f20 2020 4747 4d4c 5f46 3332 7834  ERO   GGML_F32x4
-000084a0: 5f5a 4552 4f0a 2364 6566 696e 6520 4747  _ZERO.#define GG
-000084b0: 4d4c 5f46 3332 5f56 4543 5f53 4554 3120  ML_F32_VEC_SET1 
-000084c0: 2020 4747 4d4c 5f46 3332 7834 5f53 4554    GGML_F32x4_SET
-000084d0: 310a 2364 6566 696e 6520 4747 4d4c 5f46  1.#define GGML_F
-000084e0: 3332 5f56 4543 5f4c 4f41 4420 2020 4747  32_VEC_LOAD   GG
-000084f0: 4d4c 5f46 3332 7834 5f4c 4f41 440a 2364  ML_F32x4_LOAD.#d
-00008500: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
-00008510: 4543 5f53 544f 5245 2020 4747 4d4c 5f46  EC_STORE  GGML_F
-00008520: 3332 7834 5f53 544f 5245 0a23 6465 6669  32x4_STORE.#defi
-00008530: 6e65 2047 474d 4c5f 4633 325f 5645 435f  ne GGML_F32_VEC_
-00008540: 464d 4120 2020 2047 474d 4c5f 4633 3278  FMA    GGML_F32x
-00008550: 345f 464d 410a 2364 6566 696e 6520 4747  4_FMA.#define GG
-00008560: 4d4c 5f46 3332 5f56 4543 5f41 4444 2020  ML_F32_VEC_ADD  
-00008570: 2020 4747 4d4c 5f46 3332 7834 5f41 4444    GGML_F32x4_ADD
-00008580: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00008590: 325f 5645 435f 4d55 4c20 2020 2047 474d  2_VEC_MUL    GGM
-000085a0: 4c5f 4633 3278 345f 4d55 4c0a 2364 6566  L_F32x4_MUL.#def
-000085b0: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
-000085c0: 5f52 4544 5543 4520 4747 4d4c 5f46 3332  _REDUCE GGML_F32
-000085d0: 7834 5f52 4544 5543 450a 0a2f 2f20 4631  x4_REDUCE..// F1
-000085e0: 3620 5741 534d 0a0a 2364 6566 696e 6520  6 WASM..#define 
-000085f0: 4747 4d4c 5f46 3136 5f53 5445 5020 3136  GGML_F16_STEP 16
-00008600: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
-00008610: 365f 4550 5220 2034 0a0a 696e 6c69 6e65  6_EPR  4..inline
-00008620: 2073 7461 7469 6320 7631 3238 5f74 205f   static v128_t _
-00008630: 5f77 6173 6d5f 6631 3678 345f 6c6f 6164  _wasm_f16x4_load
-00008640: 2863 6f6e 7374 2067 676d 6c5f 6670 3136  (const ggml_fp16
-00008650: 5f74 202a 2070 2920 7b0a 2020 2020 666c  _t * p) {.    fl
-00008660: 6f61 7420 746d 705b 345d 3b0a 0a20 2020  oat tmp[4];..   
-00008670: 2074 6d70 5b30 5d20 3d20 4747 4d4c 5f46   tmp[0] = GGML_F
-00008680: 5031 365f 544f 5f46 5033 3228 705b 305d  P16_TO_FP32(p[0]
-00008690: 293b 0a20 2020 2074 6d70 5b31 5d20 3d20  );.    tmp[1] = 
-000086a0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-000086b0: 3228 705b 315d 293b 0a20 2020 2074 6d70  2(p[1]);.    tmp
-000086c0: 5b32 5d20 3d20 4747 4d4c 5f46 5031 365f  [2] = GGML_FP16_
-000086d0: 544f 5f46 5033 3228 705b 325d 293b 0a20  TO_FP32(p[2]);. 
-000086e0: 2020 2074 6d70 5b33 5d20 3d20 4747 4d4c     tmp[3] = GGML
-000086f0: 5f46 5031 365f 544f 5f46 5033 3228 705b  _FP16_TO_FP32(p[
-00008700: 335d 293b 0a0a 2020 2020 7265 7475 726e  3]);..    return
-00008710: 2077 6173 6d5f 7631 3238 5f6c 6f61 6428   wasm_v128_load(
-00008720: 746d 7029 3b0a 7d0a 0a69 6e6c 696e 6520  tmp);.}..inline 
-00008730: 7374 6174 6963 2076 6f69 6420 5f5f 7761  static void __wa
-00008740: 736d 5f66 3136 7834 5f73 746f 7265 2867  sm_f16x4_store(g
-00008750: 676d 6c5f 6670 3136 5f74 202a 2070 2c20  gml_fp16_t * p, 
-00008760: 7631 3238 5f74 2078 2920 7b0a 2020 2020  v128_t x) {.    
-00008770: 666c 6f61 7420 746d 705b 345d 3b0a 0a20  float tmp[4];.. 
-00008780: 2020 2077 6173 6d5f 7631 3238 5f73 746f     wasm_v128_sto
-00008790: 7265 2874 6d70 2c20 7829 3b0a 0a20 2020  re(tmp, x);..   
-000087a0: 2070 5b30 5d20 3d20 4747 4d4c 5f46 5033   p[0] = GGML_FP3
-000087b0: 325f 544f 5f46 5031 3628 746d 705b 305d  2_TO_FP16(tmp[0]
-000087c0: 293b 0a20 2020 2070 5b31 5d20 3d20 4747  );.    p[1] = GG
-000087d0: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-000087e0: 746d 705b 315d 293b 0a20 2020 2070 5b32  tmp[1]);.    p[2
-000087f0: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
-00008800: 5f46 5031 3628 746d 705b 325d 293b 0a20  _FP16(tmp[2]);. 
-00008810: 2020 2070 5b33 5d20 3d20 4747 4d4c 5f46     p[3] = GGML_F
-00008820: 5033 325f 544f 5f46 5031 3628 746d 705b  P32_TO_FP16(tmp[
-00008830: 335d 293b 0a7d 0a0a 2364 6566 696e 6520  3]);.}..#define 
-00008840: 4747 4d4c 5f46 3136 7834 2020 2020 2020  GGML_F16x4      
-00008850: 2020 2020 2020 2076 3132 385f 740a 2364         v128_t.#d
-00008860: 6566 696e 6520 4747 4d4c 5f46 3136 7834  efine GGML_F16x4
-00008870: 5f5a 4552 4f20 2020 2020 2020 2077 6173  _ZERO        was
-00008880: 6d5f 6633 3278 345f 7370 6c61 7428 302e  m_f32x4_splat(0.
-00008890: 3066 290a 2364 6566 696e 6520 4747 4d4c  0f).#define GGML
-000088a0: 5f46 3136 7834 5f53 4554 3128 7829 2020  _F16x4_SET1(x)  
-000088b0: 2020 2077 6173 6d5f 6633 3278 345f 7370     wasm_f32x4_sp
-000088c0: 6c61 7428 7829 0a23 6465 6669 6e65 2047  lat(x).#define G
-000088d0: 474d 4c5f 4631 3678 345f 4c4f 4144 2878  GML_F16x4_LOAD(x
-000088e0: 2920 2020 2020 5f5f 7761 736d 5f66 3136  )     __wasm_f16
-000088f0: 7834 5f6c 6f61 6428 7829 0a23 6465 6669  x4_load(x).#defi
-00008900: 6e65 2047 474d 4c5f 4631 3678 345f 5354  ne GGML_F16x4_ST
-00008910: 4f52 4528 782c 2079 2920 5f5f 7761 736d  ORE(x, y) __wasm
-00008920: 5f66 3136 7834 5f73 746f 7265 2878 2c20  _f16x4_store(x, 
-00008930: 7929 0a23 6465 6669 6e65 2047 474d 4c5f  y).#define GGML_
-00008940: 4631 3678 345f 464d 4120 2020 2020 2020  F16x4_FMA       
-00008950: 2020 4747 4d4c 5f46 3332 7834 5f46 4d41    GGML_F32x4_FMA
-00008960: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
-00008970: 3678 345f 4144 4420 2020 2020 2020 2020  6x4_ADD         
-00008980: 7761 736d 5f66 3332 7834 5f61 6464 0a23  wasm_f32x4_add.#
-00008990: 6465 6669 6e65 2047 474d 4c5f 4631 3678  define GGML_F16x
-000089a0: 345f 4d55 4c20 2020 2020 2020 2020 7761  4_MUL         wa
-000089b0: 736d 5f66 3332 7834 5f6d 756c 0a23 6465  sm_f32x4_mul.#de
-000089c0: 6669 6e65 2047 474d 4c5f 4631 3678 345f  fine GGML_F16x4_
-000089d0: 5245 4455 4345 2872 6573 2c20 7829 2020  REDUCE(res, x)  
-000089e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089f0: 5c0a 7b20 2020 2020 2020 2020 2020 2020  \.{             
-00008a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a20: 2020 2020 205c 0a20 2020 2066 6f72 2028       \.    for (
-00008a30: 696e 7420 6920 3d20 303b 2069 203c 2047  int i = 0; i < G
-00008a40: 474d 4c5f 4631 365f 4152 522f 323b 202b  GML_F16_ARR/2; +
-00008a50: 2b69 2920 7b20 2020 2020 5c0a 2020 2020  +i) {     \.    
-00008a60: 2020 2020 785b 322a 695d 203d 2077 6173      x[2*i] = was
-00008a70: 6d5f 6633 3278 345f 6164 6428 785b 322a  m_f32x4_add(x[2*
-00008a80: 695d 2c20 785b 322a 692b 315d 293b 205c  i], x[2*i+1]); \
-00008a90: 0a20 2020 207d 2020 2020 2020 2020 2020  .    }          
+000003f0: 6f6d 6963 5f6c 6f61 6428 6174 6f6d 6963  omic_load(atomic
+00000400: 5f69 6e74 2a20 7074 7229 207b 0a20 2020  _int* ptr) {.   
+00000410: 2072 6574 7572 6e20 496e 7465 726c 6f63   return Interloc
+00000420: 6b65 6443 6f6d 7061 7265 4578 6368 616e  kedCompareExchan
+00000430: 6765 2870 7472 2c20 302c 2030 293b 0a7d  ge(ptr, 0, 0);.}
+00000440: 0a73 7461 7469 6320 4c4f 4e47 2061 746f  .static LONG ato
+00000450: 6d69 635f 6665 7463 685f 6164 6428 6174  mic_fetch_add(at
+00000460: 6f6d 6963 5f69 6e74 2a20 7074 722c 204c  omic_int* ptr, L
+00000470: 4f4e 4720 696e 6329 207b 0a20 2020 2072  ONG inc) {.    r
+00000480: 6574 7572 6e20 496e 7465 726c 6f63 6b65  eturn Interlocke
+00000490: 6445 7863 6861 6e67 6541 6464 2870 7472  dExchangeAdd(ptr
+000004a0: 2c20 696e 6329 3b0a 7d0a 7374 6174 6963  , inc);.}.static
+000004b0: 204c 4f4e 4720 6174 6f6d 6963 5f66 6574   LONG atomic_fet
+000004c0: 6368 5f73 7562 2861 746f 6d69 635f 696e  ch_sub(atomic_in
+000004d0: 742a 2070 7472 2c20 4c4f 4e47 2064 6563  t* ptr, LONG dec
+000004e0: 2920 7b0a 2020 2020 7265 7475 726e 2061  ) {.    return a
+000004f0: 746f 6d69 635f 6665 7463 685f 6164 6428  tomic_fetch_add(
+00000500: 7074 722c 202d 2864 6563 2929 3b0a 7d0a  ptr, -(dec));.}.
+00000510: 0a74 7970 6564 6566 2048 414e 444c 4520  .typedef HANDLE 
+00000520: 7074 6872 6561 645f 743b 0a0a 7479 7065  pthread_t;..type
+00000530: 6465 6620 4457 4f52 4420 7468 7265 6164  def DWORD thread
+00000540: 5f72 6574 5f74 3b0a 7374 6174 6963 2069  _ret_t;.static i
+00000550: 6e74 2070 7468 7265 6164 5f63 7265 6174  nt pthread_creat
+00000560: 6528 7074 6872 6561 645f 742a 206f 7574  e(pthread_t* out
+00000570: 2c20 766f 6964 2a20 756e 7573 6564 2c20  , void* unused, 
+00000580: 7468 7265 6164 5f72 6574 5f74 282a 6675  thread_ret_t(*fu
+00000590: 6e63 2928 766f 6964 2a29 2c20 766f 6964  nc)(void*), void
+000005a0: 2a20 6172 6729 207b 0a20 2020 2048 414e  * arg) {.    HAN
+000005b0: 444c 4520 6861 6e64 6c65 203d 2043 7265  DLE handle = Cre
+000005c0: 6174 6554 6872 6561 6428 4e55 4c4c 2c20  ateThread(NULL, 
+000005d0: 302c 2028 4c50 5448 5245 4144 5f53 5441  0, (LPTHREAD_STA
+000005e0: 5254 5f52 4f55 5449 4e45 2920 6675 6e63  RT_ROUTINE) func
+000005f0: 2c20 6172 672c 2030 2c20 4e55 4c4c 293b  , arg, 0, NULL);
+00000600: 0a20 2020 2069 6620 2868 616e 646c 6520  .    if (handle 
+00000610: 3d3d 204e 554c 4c29 0a20 2020 207b 0a20  == NULL).    {. 
+00000620: 2020 2020 2020 2072 6574 7572 6e20 4541         return EA
+00000630: 4741 494e 3b0a 2020 2020 7d0a 0a20 2020  GAIN;.    }..   
+00000640: 202a 6f75 7420 3d20 6861 6e64 6c65 3b0a   *out = handle;.
+00000650: 2020 2020 7265 7475 726e 2030 3b0a 7d0a      return 0;.}.
+00000660: 0a73 7461 7469 6320 696e 7420 7074 6872  .static int pthr
+00000670: 6561 645f 6a6f 696e 2870 7468 7265 6164  ead_join(pthread
+00000680: 5f74 2074 6872 6561 642c 2076 6f69 642a  _t thread, void*
+00000690: 2075 6e75 7365 6429 207b 0a20 2020 2072   unused) {.    r
+000006a0: 6574 7572 6e20 2869 6e74 2920 5761 6974  eturn (int) Wait
+000006b0: 466f 7253 696e 676c 654f 626a 6563 7428  ForSingleObject(
+000006c0: 7468 7265 6164 2c20 494e 4649 4e49 5445  thread, INFINITE
+000006d0: 293b 0a7d 0a0a 7374 6174 6963 2069 6e74  );.}..static int
+000006e0: 2073 6368 6564 5f79 6965 6c64 2028 766f   sched_yield (vo
+000006f0: 6964 2920 7b0a 2020 2020 536c 6565 7020  id) {.    Sleep 
+00000700: 2830 293b 0a20 2020 2072 6574 7572 6e20  (0);.    return 
+00000710: 303b 0a7d 0a23 656c 7365 0a23 696e 636c  0;.}.#else.#incl
+00000720: 7564 6520 3c70 7468 7265 6164 2e68 3e0a  ude <pthread.h>.
+00000730: 2369 6e63 6c75 6465 203c 7374 6461 746f  #include <stdato
+00000740: 6d69 632e 683e 0a0a 7479 7065 6465 6620  mic.h>..typedef 
+00000750: 766f 6964 2a20 7468 7265 6164 5f72 6574  void* thread_ret
+00000760: 5f74 3b0a 2365 6e64 6966 0a0a 2f2f 205f  _t;.#endif..// _
+00000770: 5f46 4d41 5f5f 2061 6e64 205f 5f46 3136  _FMA__ and __F16
+00000780: 435f 5f20 6172 6520 6e6f 7420 6465 6669  C__ are not defi
+00000790: 6e65 6420 696e 204d 5356 432c 2068 6f77  ned in MSVC, how
+000007a0: 6576 6572 2074 6865 7920 6172 6520 696d  ever they are im
+000007b0: 706c 6965 6420 7769 7468 2041 5658 322f  plied with AVX2/
+000007c0: 4156 5835 3132 0a23 6966 2064 6566 696e  AVX512.#if defin
+000007d0: 6564 285f 4d53 435f 5645 5229 2026 2620  ed(_MSC_VER) && 
+000007e0: 2864 6566 696e 6564 285f 5f41 5658 325f  (defined(__AVX2_
+000007f0: 5f29 207c 7c20 6465 6669 6e65 6428 5f5f  _) || defined(__
+00000800: 4156 5835 3132 465f 5f29 290a 2369 666e  AVX512F__)).#ifn
+00000810: 6465 6620 5f5f 464d 415f 5f0a 2364 6566  def __FMA__.#def
+00000820: 696e 6520 5f5f 464d 415f 5f0a 2365 6e64  ine __FMA__.#end
+00000830: 6966 0a23 6966 6e64 6566 205f 5f46 3136  if.#ifndef __F16
+00000840: 435f 5f0a 2364 6566 696e 6520 5f5f 4631  C__.#define __F1
+00000850: 3643 5f5f 0a23 656e 6469 660a 2369 666e  6C__.#endif.#ifn
+00000860: 6465 6620 5f5f 5353 4533 5f5f 0a23 6465  def __SSE3__.#de
+00000870: 6669 6e65 205f 5f53 5345 335f 5f0a 2365  fine __SSE3__.#e
+00000880: 6e64 6966 0a23 656e 6469 660a 0a23 6966  ndif.#endif..#if
+00000890: 6465 6620 5f5f 4841 494b 555f 5f0a 2364  def __HAIKU__.#d
+000008a0: 6566 696e 6520 7374 6174 6963 5f61 7373  efine static_ass
+000008b0: 6572 7428 636f 6e64 2c20 6d73 6729 205f  ert(cond, msg) _
+000008c0: 5374 6174 6963 5f61 7373 6572 7428 636f  Static_assert(co
+000008d0: 6e64 2c20 6d73 6729 0a23 656e 6469 660a  nd, msg).#endif.
+000008e0: 0a23 6465 6669 6e65 2047 474d 4c5f 4d4c  .#define GGML_ML
+000008f0: 4f43 4b5f 5355 5050 4f52 5420 300a 0a23  OCK_SUPPORT 0..#
+00000900: 6966 6465 6620 5f5f 6861 735f 696e 636c  ifdef __has_incl
+00000910: 7564 650a 2020 2020 2369 6620 5f5f 6861  ude.    #if __ha
+00000920: 735f 696e 636c 7564 6528 3c73 7973 2f6d  s_include(<sys/m
+00000930: 6d61 6e2e 683e 290a 2020 2020 2020 2020  man.h>).        
+00000940: 2375 6e64 6566 2047 474d 4c5f 4d4c 4f43  #undef GGML_MLOC
+00000950: 4b5f 5355 5050 4f52 540a 2020 2020 2020  K_SUPPORT.      
+00000960: 2020 2364 6566 696e 6520 4747 4d4c 5f4d    #define GGML_M
+00000970: 4c4f 434b 5f53 5550 504f 5254 2031 0a20  LOCK_SUPPORT 1. 
+00000980: 2020 2020 2020 2023 696e 636c 7564 6520         #include 
+00000990: 3c73 7973 2f6d 6d61 6e2e 683e 0a20 2020  <sys/mman.h>.   
+000009a0: 2023 656e 6469 660a 2365 6e64 6966 0a0a   #endif.#endif..
+000009b0: 0a2f 2a23 6465 6669 6e65 2047 474d 4c5f  ./*#define GGML_
+000009c0: 5045 5246 2a2f 0a23 6465 6669 6e65 2047  PERF*/.#define G
+000009d0: 474d 4c5f 4445 4255 4720 300a 2364 6566  GML_DEBUG 0.#def
+000009e0: 696e 6520 4747 4d4c 5f47 454c 555f 4650  ine GGML_GELU_FP
+000009f0: 3136 0a23 6465 6669 6e65 2047 474d 4c5f  16.#define GGML_
+00000a00: 5349 4c55 5f46 5031 360a 0a23 6465 6669  SILU_FP16..#defi
+00000a10: 6e65 2047 474d 4c5f 534f 4654 5f4d 4158  ne GGML_SOFT_MAX
+00000a20: 5f55 4e52 4f4c 4c20 340a 2364 6566 696e  _UNROLL 4.#defin
+00000a30: 6520 4747 4d4c 5f56 4543 5f44 4f54 5f55  e GGML_VEC_DOT_U
+00000a40: 4e52 4f4c 4c20 2032 0a0a 2369 6664 6566  NROLL  2..#ifdef
+00000a50: 2047 474d 4c5f 5553 455f 4143 4345 4c45   GGML_USE_ACCELE
+00000a60: 5241 5445 0a2f 2f20 756e 636f 6d6d 656e  RATE.// uncommen
+00000a70: 7420 746f 2075 7365 2076 4453 5020 666f  t to use vDSP fo
+00000a80: 7220 736f 6674 206d 6178 2063 6f6d 7075  r soft max compu
+00000a90: 7461 7469 6f6e 0a2f 2f20 6e6f 7465 3a20  tation.// note: 
+00000aa0: 6e6f 7420 7375 7265 2069 6620 6974 2069  not sure if it i
+00000ab0: 7320 6163 7475 616c 6c79 2066 6173 7465  s actually faste
+00000ac0: 720a 2f2f 2364 6566 696e 6520 4747 4d4c  r.//#define GGML
+00000ad0: 5f53 4f46 545f 4d41 585f 4143 4345 4c45  _SOFT_MAX_ACCELE
+00000ae0: 5241 5445 0a23 656e 6469 660a 0a23 6966  RATE.#endif..#if
+00000af0: 2055 494e 5450 5452 5f4d 4158 203d 3d20   UINTPTR_MAX == 
+00000b00: 3078 4646 4646 4646 4646 0a20 2020 2023  0xFFFFFFFF.    #
+00000b10: 6465 6669 6e65 2047 474d 4c5f 4d45 4d5f  define GGML_MEM_
+00000b20: 414c 4947 4e20 340a 2365 6c73 650a 2020  ALIGN 4.#else.  
+00000b30: 2020 2364 6566 696e 6520 4747 4d4c 5f4d    #define GGML_M
+00000b40: 454d 5f41 4c49 474e 2031 360a 2365 6e64  EM_ALIGN 16.#end
+00000b50: 6966 0a0a 2364 6566 696e 6520 554e 5553  if..#define UNUS
+00000b60: 4544 2878 2920 2876 6f69 6429 2878 290a  ED(x) (void)(x).
+00000b70: 2364 6566 696e 6520 5357 4150 2878 2c20  #define SWAP(x, 
+00000b80: 792c 2054 2920 646f 207b 2054 2053 5741  y, T) do { T SWA
+00000b90: 5020 3d20 783b 2078 203d 2079 3b20 7920  P = x; x = y; y 
+00000ba0: 3d20 5357 4150 3b20 7d20 7768 696c 6520  = SWAP; } while 
+00000bb0: 2830 290a 0a23 6465 6669 6e65 2047 474d  (0)..#define GGM
+00000bc0: 4c5f 4153 5345 5254 2878 2920 5c0a 2020  L_ASSERT(x) \.  
+00000bd0: 2020 646f 207b 205c 0a20 2020 2020 2020    do { \.       
+00000be0: 2069 6620 2821 2878 2929 207b 205c 0a20   if (!(x)) { \. 
+00000bf0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+00000c00: 7466 2873 7464 6572 722c 2022 4747 4d4c  tf(stderr, "GGML
+00000c10: 5f41 5353 4552 543a 2025 733a 2564 3a20  _ASSERT: %s:%d: 
+00000c20: 2573 5c6e 222c 205f 5f46 494c 455f 5f2c  %s\n", __FILE__,
+00000c30: 205f 5f4c 494e 455f 5f2c 2023 7829 3b20   __LINE__, #x); 
+00000c40: 5c0a 2020 2020 2020 2020 2020 2020 6162  \.            ab
+00000c50: 6f72 7428 293b 205c 0a20 2020 2020 2020  ort(); \.       
+00000c60: 207d 205c 0a20 2020 207d 2077 6869 6c65   } \.    } while
+00000c70: 2028 3029 0a0a 2369 6664 6566 2047 474d   (0)..#ifdef GGM
+00000c80: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
+00000c90: 0a23 696e 636c 7564 6520 3c41 6363 656c  .#include <Accel
+00000ca0: 6572 6174 652f 4163 6365 6c65 7261 7465  erate/Accelerate
+00000cb0: 2e68 3e0a 2365 6c69 6620 4747 4d4c 5f55  .h>.#elif GGML_U
+00000cc0: 5345 5f4f 5045 4e42 4c41 530a 2369 6e63  SE_OPENBLAS.#inc
+00000cd0: 6c75 6465 203c 6362 6c61 732e 683e 0a23  lude <cblas.h>.#
+00000ce0: 656e 6469 660a 0a23 756e 6465 6620 4d49  endif..#undef MI
+00000cf0: 4e0a 2375 6e64 6566 204d 4158 0a23 6465  N.#undef MAX.#de
+00000d00: 6669 6e65 204d 494e 2861 2c20 6229 2028  fine MIN(a, b) (
+00000d10: 2861 2920 3c20 2862 2920 3f20 2861 2920  (a) < (b) ? (a) 
+00000d20: 3a20 2862 2929 0a23 6465 6669 6e65 204d  : (b)).#define M
+00000d30: 4158 2861 2c20 6229 2028 2861 2920 3e20  AX(a, b) ((a) > 
+00000d40: 2862 2920 3f20 2861 2920 3a20 2862 2929  (b) ? (a) : (b))
+00000d50: 0a0a 2f2f 2066 6c6f 6174 696e 6720 706f  ..// floating po
+00000d60: 696e 7420 7479 7065 2075 7365 6420 746f  int type used to
+00000d70: 2061 6363 756d 756c 6174 6520 7375 6d73   accumulate sums
+00000d80: 0a74 7970 6564 6566 2064 6f75 626c 6520  .typedef double 
+00000d90: 6767 6d6c 5f66 6c6f 6174 3b0a 0a2f 2f20  ggml_float;..// 
+00000da0: 3136 2d62 6974 2066 6c6f 6174 0a2f 2f20  16-bit float.// 
+00000db0: 6f6e 2041 726d 2c20 7765 2075 7365 205f  on Arm, we use _
+00000dc0: 5f66 7031 360a 2f2f 206f 6e20 7838 362c  _fp16.// on x86,
+00000dd0: 2077 6520 7573 6520 7569 6e74 3136 5f74   we use uint16_t
+00000de0: 0a23 6966 6465 6620 5f5f 4152 4d5f 4e45  .#ifdef __ARM_NE
+00000df0: 4f4e 0a0a 2f2f 2069 6620 5943 4d20 6361  ON..// if YCM ca
+00000e00: 6e6e 6f74 2066 696e 6420 3c61 726d 5f6e  nnot find <arm_n
+00000e10: 656f 6e2e 683e 2c20 6d61 6b65 2061 2073  eon.h>, make a s
+00000e20: 796d 626f 6c69 6320 6c69 6e6b 2074 6f20  ymbolic link to 
+00000e30: 6974 2c20 666f 7220 6578 616d 706c 653a  it, for example:
+00000e40: 0a2f 2f0a 2f2f 2020 2024 206c 6e20 2d73  .//.//   $ ln -s
+00000e50: 666e 202f 4c69 6272 6172 792f 4465 7665  fn /Library/Deve
+00000e60: 6c6f 7065 722f 436f 6d6d 616e 644c 696e  loper/CommandLin
+00000e70: 6554 6f6f 6c73 2f75 7372 2f6c 6962 2f63  eTools/usr/lib/c
+00000e80: 6c61 6e67 2f31 332e 312e 362f 696e 636c  lang/13.1.6/incl
+00000e90: 7564 652f 6172 6d5f 6e65 6f6e 2e68 202e  ude/arm_neon.h .
+00000ea0: 2f73 7263 2f0a 2f2f 0a23 696e 636c 7564  /src/.//.#includ
+00000eb0: 6520 3c61 726d 5f6e 656f 6e2e 683e 0a0a  e <arm_neon.h>..
+00000ec0: 2364 6566 696e 6520 4747 4d4c 5f43 4f4d  #define GGML_COM
+00000ed0: 5055 5445 5f46 5031 365f 544f 5f46 5033  PUTE_FP16_TO_FP3
+00000ee0: 3228 7829 2028 2866 6c6f 6174 2920 2878  2(x) ((float) (x
+00000ef0: 2929 0a23 6465 6669 6e65 2047 474d 4c5f  )).#define GGML_
+00000f00: 434f 4d50 5554 455f 4650 3332 5f54 4f5f  COMPUTE_FP32_TO_
+00000f10: 4650 3136 2878 2920 2878 290a 0a23 6465  FP16(x) (x)..#de
+00000f20: 6669 6e65 2047 474d 4c5f 4650 3136 5f54  fine GGML_FP16_T
+00000f30: 4f5f 4650 3332 2878 2920 2828 666c 6f61  O_FP32(x) ((floa
+00000f40: 7429 2028 7829 290a 2364 6566 696e 6520  t) (x)).#define 
+00000f50: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
+00000f60: 3628 7829 2028 7829 0a0a 2365 6c73 650a  6(x) (x)..#else.
+00000f70: 0a23 6966 6465 6620 5f5f 7761 736d 5f73  .#ifdef __wasm_s
+00000f80: 696d 6431 3238 5f5f 0a23 696e 636c 7564  imd128__.#includ
+00000f90: 6520 3c77 6173 6d5f 7369 6d64 3132 382e  e <wasm_simd128.
+00000fa0: 683e 0a23 656c 7365 0a23 6966 6465 6620  h>.#else.#ifdef 
+00000fb0: 5f5f 504f 5745 5239 5f56 4543 544f 525f  __POWER9_VECTOR_
+00000fc0: 5f0a 2369 6e63 6c75 6465 203c 616c 7469  _.#include <alti
+00000fd0: 7665 632e 683e 0a23 756e 6465 6620 626f  vec.h>.#undef bo
+00000fe0: 6f6c 0a23 6465 6669 6e65 2062 6f6f 6c20  ol.#define bool 
+00000ff0: 5f42 6f6f 6c0a 2365 6c73 650a 2369 6e63  _Bool.#else.#inc
+00001000: 6c75 6465 203c 696d 6d69 6e74 7269 6e2e  lude <immintrin.
+00001010: 683e 0a23 656e 6469 660a 2365 6e64 6966  h>.#endif.#endif
+00001020: 0a0a 2369 6664 6566 205f 5f46 3136 435f  ..#ifdef __F16C_
+00001030: 5f0a 0a23 6966 6465 6620 5f4d 5343 5f56  _..#ifdef _MSC_V
+00001040: 4552 0a23 6465 6669 6e65 2047 474d 4c5f  ER.#define GGML_
+00001050: 434f 4d50 5554 455f 4650 3136 5f54 4f5f  COMPUTE_FP16_TO_
+00001060: 4650 3332 2878 2920 5f6d 6d5f 6376 7473  FP32(x) _mm_cvts
+00001070: 735f 6633 3228 5f6d 6d5f 6376 7470 685f  s_f32(_mm_cvtph_
+00001080: 7073 285f 6d6d 5f63 7674 7369 3332 5f73  ps(_mm_cvtsi32_s
+00001090: 6931 3238 2878 2929 290a 2364 6566 696e  i128(x))).#defin
+000010a0: 6520 4747 4d4c 5f43 4f4d 5055 5445 5f46  e GGML_COMPUTE_F
+000010b0: 5033 325f 544f 5f46 5031 3628 7829 205f  P32_TO_FP16(x) _
+000010c0: 6d6d 5f65 7874 7261 6374 5f65 7069 3136  mm_extract_epi16
+000010d0: 285f 6d6d 5f63 7674 7073 5f70 6828 5f6d  (_mm_cvtps_ph(_m
+000010e0: 6d5f 7365 745f 7373 2878 292c 2030 292c  m_set_ss(x), 0),
+000010f0: 2030 290a 2365 6c73 650a 2364 6566 696e   0).#else.#defin
+00001100: 6520 4747 4d4c 5f43 4f4d 5055 5445 5f46  e GGML_COMPUTE_F
+00001110: 5031 365f 544f 5f46 5033 3228 7829 205f  P16_TO_FP32(x) _
+00001120: 6376 7473 685f 7373 2878 290a 2364 6566  cvtsh_ss(x).#def
+00001130: 696e 6520 4747 4d4c 5f43 4f4d 5055 5445  ine GGML_COMPUTE
+00001140: 5f46 5033 325f 544f 5f46 5031 3628 7829  _FP32_TO_FP16(x)
+00001150: 205f 6376 7473 735f 7368 2878 2c20 3029   _cvtss_sh(x, 0)
+00001160: 0a23 656e 6469 660a 0a23 656c 6966 2064  .#endif..#elif d
+00001170: 6566 696e 6564 285f 5f50 4f57 4552 395f  efined(__POWER9_
+00001180: 5645 4354 4f52 5f5f 290a 0a23 6465 6669  VECTOR__)..#defi
+00001190: 6e65 2047 474d 4c5f 434f 4d50 5554 455f  ne GGML_COMPUTE_
+000011a0: 4650 3136 5f54 4f5f 4650 3332 2878 2920  FP16_TO_FP32(x) 
+000011b0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 7031  ggml_compute_fp1
+000011c0: 365f 746f 5f66 7033 3228 7829 0a23 6465  6_to_fp32(x).#de
+000011d0: 6669 6e65 2047 474d 4c5f 434f 4d50 5554  fine GGML_COMPUT
+000011e0: 455f 4650 3332 5f54 4f5f 4650 3136 2878  E_FP32_TO_FP16(x
+000011f0: 2920 6767 6d6c 5f63 6f6d 7075 7465 5f66  ) ggml_compute_f
+00001200: 7033 325f 746f 5f66 7031 3628 7829 0a2f  p32_to_fp16(x)./
+00001210: 2a20 7468 6520 696e 6c69 6e65 2061 736d  * the inline asm
+00001220: 2062 656c 6f77 2069 7320 6162 6f75 7420   below is about 
+00001230: 3132 2520 6661 7374 6572 2074 6861 6e20  12% faster than 
+00001240: 7468 6520 6c6f 6f6b 7570 206d 6574 686f  the lookup metho
+00001250: 6420 2a2f 0a23 6465 6669 6e65 2047 474d  d */.#define GGM
+00001260: 4c5f 4650 3136 5f54 4f5f 4650 3332 2878  L_FP16_TO_FP32(x
+00001270: 2920 4747 4d4c 5f43 4f4d 5055 5445 5f46  ) GGML_COMPUTE_F
+00001280: 5031 365f 544f 5f46 5033 3228 7829 0a23  P16_TO_FP32(x).#
+00001290: 6465 6669 6e65 2047 474d 4c5f 4650 3332  define GGML_FP32
+000012a0: 5f54 4f5f 4650 3136 2878 2920 4747 4d4c  _TO_FP16(x) GGML
+000012b0: 5f43 4f4d 5055 5445 5f46 5033 325f 544f  _COMPUTE_FP32_TO
+000012c0: 5f46 5031 3628 7829 0a0a 7374 6174 6963  _FP16(x)..static
+000012d0: 2069 6e6c 696e 6520 666c 6f61 7420 6767   inline float gg
+000012e0: 6d6c 5f63 6f6d 7075 7465 5f66 7031 365f  ml_compute_fp16_
+000012f0: 746f 5f66 7033 3228 6767 6d6c 5f66 7031  to_fp32(ggml_fp1
+00001300: 365f 7420 6829 207b 0a20 2020 2072 6567  6_t h) {.    reg
+00001310: 6973 7465 7220 666c 6f61 7420 663b 0a20  ister float f;. 
+00001320: 2020 2072 6567 6973 7465 7220 646f 7562     register doub
+00001330: 6c65 2064 3b0a 2020 2020 5f5f 6173 6d5f  le d;.    __asm_
+00001340: 5f28 0a20 2020 2020 2020 2022 6d74 6670  _(.        "mtfp
+00001350: 7264 2025 302c 2532 5c6e 220a 2020 2020  rd %0,%2\n".    
+00001360: 2020 2020 2278 7363 7668 7064 7020 2530      "xscvhpdp %0
+00001370: 2c25 305c 6e22 0a20 2020 2020 2020 2022  ,%0\n".        "
+00001380: 6672 7370 2025 312c 2530 5c6e 2220 3a0a  frsp %1,%0\n" :.
+00001390: 2020 2020 2020 2020 2f2a 2074 656d 7020          /* temp 
+000013a0: 2a2f 2022 3d64 2228 6429 2c0a 2020 2020  */ "=d"(d),.    
+000013b0: 2020 2020 2f2a 206f 7574 202a 2f20 2022      /* out */  "
+000013c0: 3d66 2228 6629 3a0a 2020 2020 2020 2020  =f"(f):.        
+000013d0: 2f2a 2069 6e20 2a2f 2020 2022 7222 2868  /* in */   "r"(h
+000013e0: 2929 3b0a 2020 2020 7265 7475 726e 2066  ));.    return f
+000013f0: 3b0a 7d0a 0a73 7461 7469 6320 696e 6c69  ;.}..static inli
+00001400: 6e65 2067 676d 6c5f 6670 3136 5f74 2067  ne ggml_fp16_t g
+00001410: 676d 6c5f 636f 6d70 7574 655f 6670 3332  gml_compute_fp32
+00001420: 5f74 6f5f 6670 3136 2866 6c6f 6174 2066  _to_fp16(float f
+00001430: 2920 7b0a 2020 2020 7265 6769 7374 6572  ) {.    register
+00001440: 2064 6f75 626c 6520 643b 0a20 2020 2072   double d;.    r
+00001450: 6567 6973 7465 7220 6767 6d6c 5f66 7031  egister ggml_fp1
+00001460: 365f 7420 723b 0a20 2020 205f 5f61 736d  6_t r;.    __asm
+00001470: 5f5f 2820 2f2a 2078 7363 7664 7068 7020  __( /* xscvdphp 
+00001480: 6361 6e20 776f 726b 206f 6e20 646f 7562  can work on doub
+00001490: 6c65 206f 7220 7369 6e67 6c65 2070 7265  le or single pre
+000014a0: 6369 7369 6f6e 202a 2f0a 2020 2020 2020  cision */.      
+000014b0: 2020 2278 7363 7664 7068 7020 2530 2c25    "xscvdphp %0,%
+000014c0: 325c 6e22 0a20 2020 2020 2020 2022 6d66  2\n".        "mf
+000014d0: 6670 7264 2025 312c 2530 5c6e 2220 3a0a  fprd %1,%0\n" :.
+000014e0: 2020 2020 2020 2020 2f2a 2074 656d 7020          /* temp 
+000014f0: 2a2f 2022 3d64 2228 6429 2c0a 2020 2020  */ "=d"(d),.    
+00001500: 2020 2020 2f2a 206f 7574 202a 2f20 2022      /* out */  "
+00001510: 3d72 2228 7229 3a0a 2020 2020 2020 2020  =r"(r):.        
+00001520: 2f2a 2069 6e20 2a2f 2020 2022 6622 2866  /* in */   "f"(f
+00001530: 2929 3b0a 2020 2020 7265 7475 726e 2072  ));.    return r
+00001540: 3b0a 7d0a 0a23 656c 7365 0a0a 2f2f 2046  ;.}..#else..// F
+00001550: 5031 3620 3c2d 3e20 4650 3332 0a2f 2f20  P16 <-> FP32.// 
+00001560: 7265 663a 2068 7474 7073 3a2f 2f67 6974  ref: https://git
+00001570: 6875 622e 636f 6d2f 4d61 7261 7479 737a  hub.com/Maratysz
+00001580: 637a 612f 4650 3136 0a0a 7374 6174 6963  cza/FP16..static
+00001590: 2069 6e6c 696e 6520 666c 6f61 7420 6670   inline float fp
+000015a0: 3332 5f66 726f 6d5f 6269 7473 2875 696e  32_from_bits(uin
+000015b0: 7433 325f 7420 7729 207b 0a20 2020 2075  t32_t w) {.    u
+000015c0: 6e69 6f6e 207b 0a20 2020 2020 2020 2075  nion {.        u
+000015d0: 696e 7433 325f 7420 6173 5f62 6974 733b  int32_t as_bits;
+000015e0: 0a20 2020 2020 2020 2066 6c6f 6174 2061  .        float a
+000015f0: 735f 7661 6c75 653b 0a20 2020 207d 2066  s_value;.    } f
+00001600: 7033 323b 0a20 2020 2066 7033 322e 6173  p32;.    fp32.as
+00001610: 5f62 6974 7320 3d20 773b 0a20 2020 2072  _bits = w;.    r
+00001620: 6574 7572 6e20 6670 3332 2e61 735f 7661  eturn fp32.as_va
+00001630: 6c75 653b 0a7d 0a0a 7374 6174 6963 2069  lue;.}..static i
+00001640: 6e6c 696e 6520 7569 6e74 3332 5f74 2066  nline uint32_t f
+00001650: 7033 325f 746f 5f62 6974 7328 666c 6f61  p32_to_bits(floa
+00001660: 7420 6629 207b 0a09 756e 696f 6e20 7b0a  t f) {..union {.
+00001670: 0909 666c 6f61 7420 6173 5f76 616c 7565  ..float as_value
+00001680: 3b0a 0909 7569 6e74 3332 5f74 2061 735f  ;...uint32_t as_
+00001690: 6269 7473 3b0a 097d 2066 7033 323b 0a09  bits;..} fp32;..
+000016a0: 6670 3332 2e61 735f 7661 6c75 6520 3d20  fp32.as_value = 
+000016b0: 663b 0a09 7265 7475 726e 2066 7033 322e  f;..return fp32.
+000016c0: 6173 5f62 6974 733b 0a7d 0a0a 7374 6174  as_bits;.}..stat
+000016d0: 6963 2069 6e6c 696e 6520 666c 6f61 7420  ic inline float 
+000016e0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 7031  ggml_compute_fp1
+000016f0: 365f 746f 5f66 7033 3228 6767 6d6c 5f66  6_to_fp32(ggml_f
+00001700: 7031 365f 7420 6829 207b 0a20 2020 2063  p16_t h) {.    c
+00001710: 6f6e 7374 2075 696e 7433 325f 7420 7720  onst uint32_t w 
+00001720: 3d20 2875 696e 7433 325f 7429 2068 203c  = (uint32_t) h <
+00001730: 3c20 3136 3b0a 2020 2020 636f 6e73 7420  < 16;.    const 
+00001740: 7569 6e74 3332 5f74 2073 6967 6e20 3d20  uint32_t sign = 
+00001750: 7720 2620 5549 4e54 3332 5f43 2830 7838  w & UINT32_C(0x8
+00001760: 3030 3030 3030 3029 3b0a 2020 2020 636f  0000000);.    co
+00001770: 6e73 7420 7569 6e74 3332 5f74 2074 776f  nst uint32_t two
+00001780: 5f77 203d 2077 202b 2077 3b0a 0a20 2020  _w = w + w;..   
+00001790: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
+000017a0: 6578 705f 6f66 6673 6574 203d 2055 494e  exp_offset = UIN
+000017b0: 5433 325f 4328 3078 4530 2920 3c3c 2032  T32_C(0xE0) << 2
+000017c0: 333b 0a23 6966 2064 6566 696e 6564 285f  3;.#if defined(_
+000017d0: 5f53 5444 435f 5645 5253 494f 4e5f 5f29  _STDC_VERSION__)
+000017e0: 2026 2620 285f 5f53 5444 435f 5645 5253   && (__STDC_VERS
+000017f0: 494f 4e5f 5f20 3e3d 2031 3939 3930 314c  ION__ >= 199901L
+00001800: 2920 7c7c 2064 6566 696e 6564 285f 5f47  ) || defined(__G
+00001810: 4e55 435f 5f29 2026 2620 2164 6566 696e  NUC__) && !defin
+00001820: 6564 285f 5f53 5452 4943 545f 414e 5349  ed(__STRICT_ANSI
+00001830: 5f5f 290a 2020 2020 636f 6e73 7420 666c  __).    const fl
+00001840: 6f61 7420 6578 705f 7363 616c 6520 3d20  oat exp_scale = 
+00001850: 3078 312e 3070 2d31 3132 663b 0a23 656c  0x1.0p-112f;.#el
+00001860: 7365 0a20 2020 2063 6f6e 7374 2066 6c6f  se.    const flo
+00001870: 6174 2065 7870 5f73 6361 6c65 203d 2066  at exp_scale = f
+00001880: 7033 325f 6672 6f6d 5f62 6974 7328 5549  p32_from_bits(UI
+00001890: 4e54 3332 5f43 2830 7837 3830 3030 3030  NT32_C(0x7800000
+000018a0: 2929 3b0a 2365 6e64 6966 0a20 2020 2063  ));.#endif.    c
+000018b0: 6f6e 7374 2066 6c6f 6174 206e 6f72 6d61  onst float norma
+000018c0: 6c69 7a65 645f 7661 6c75 6520 3d20 6670  lized_value = fp
+000018d0: 3332 5f66 726f 6d5f 6269 7473 2828 7477  32_from_bits((tw
+000018e0: 6f5f 7720 3e3e 2034 2920 2b20 6578 705f  o_w >> 4) + exp_
+000018f0: 6f66 6673 6574 2920 2a20 6578 705f 7363  offset) * exp_sc
+00001900: 616c 653b 0a0a 2020 2020 636f 6e73 7420  ale;..    const 
+00001910: 7569 6e74 3332 5f74 206d 6167 6963 5f6d  uint32_t magic_m
+00001920: 6173 6b20 3d20 5549 4e54 3332 5f43 2831  ask = UINT32_C(1
+00001930: 3236 2920 3c3c 2032 333b 0a20 2020 2063  26) << 23;.    c
+00001940: 6f6e 7374 2066 6c6f 6174 206d 6167 6963  onst float magic
+00001950: 5f62 6961 7320 3d20 302e 3566 3b0a 2020  _bias = 0.5f;.  
+00001960: 2020 636f 6e73 7420 666c 6f61 7420 6465    const float de
+00001970: 6e6f 726d 616c 697a 6564 5f76 616c 7565  normalized_value
+00001980: 203d 2066 7033 325f 6672 6f6d 5f62 6974   = fp32_from_bit
+00001990: 7328 2874 776f 5f77 203e 3e20 3137 2920  s((two_w >> 17) 
+000019a0: 7c20 6d61 6769 635f 6d61 736b 2920 2d20  | magic_mask) - 
+000019b0: 6d61 6769 635f 6269 6173 3b0a 0a20 2020  magic_bias;..   
+000019c0: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
+000019d0: 6465 6e6f 726d 616c 697a 6564 5f63 7574  denormalized_cut
+000019e0: 6f66 6620 3d20 5549 4e54 3332 5f43 2831  off = UINT32_C(1
+000019f0: 2920 3c3c 2032 373b 0a20 2020 2063 6f6e  ) << 27;.    con
+00001a00: 7374 2075 696e 7433 325f 7420 7265 7375  st uint32_t resu
+00001a10: 6c74 203d 2073 6967 6e20 7c0a 2020 2020  lt = sign |.    
+00001a20: 2020 2020 2874 776f 5f77 203c 2064 656e      (two_w < den
+00001a30: 6f72 6d61 6c69 7a65 645f 6375 746f 6666  ormalized_cutoff
+00001a40: 203f 2066 7033 325f 746f 5f62 6974 7328   ? fp32_to_bits(
+00001a50: 6465 6e6f 726d 616c 697a 6564 5f76 616c  denormalized_val
+00001a60: 7565 2920 3a20 6670 3332 5f74 6f5f 6269  ue) : fp32_to_bi
+00001a70: 7473 286e 6f72 6d61 6c69 7a65 645f 7661  ts(normalized_va
+00001a80: 6c75 6529 293b 0a20 2020 2072 6574 7572  lue));.    retur
+00001a90: 6e20 6670 3332 5f66 726f 6d5f 6269 7473  n fp32_from_bits
+00001aa0: 2872 6573 756c 7429 3b0a 7d0a 0a73 7461  (result);.}..sta
+00001ab0: 7469 6320 696e 6c69 6e65 2067 676d 6c5f  tic inline ggml_
+00001ac0: 6670 3136 5f74 2067 676d 6c5f 636f 6d70  fp16_t ggml_comp
+00001ad0: 7574 655f 6670 3332 5f74 6f5f 6670 3136  ute_fp32_to_fp16
+00001ae0: 2866 6c6f 6174 2066 2920 7b0a 2369 6620  (float f) {.#if 
+00001af0: 6465 6669 6e65 6428 5f5f 5354 4443 5f56  defined(__STDC_V
+00001b00: 4552 5349 4f4e 5f5f 2920 2626 2028 5f5f  ERSION__) && (__
+00001b10: 5354 4443 5f56 4552 5349 4f4e 5f5f 203e  STDC_VERSION__ >
+00001b20: 3d20 3139 3939 3031 4c29 207c 7c20 6465  = 199901L) || de
+00001b30: 6669 6e65 6428 5f5f 474e 5543 5f5f 2920  fined(__GNUC__) 
+00001b40: 2626 2021 6465 6669 6e65 6428 5f5f 5354  && !defined(__ST
+00001b50: 5249 4354 5f41 4e53 495f 5f29 0a20 2020  RICT_ANSI__).   
+00001b60: 2063 6f6e 7374 2066 6c6f 6174 2073 6361   const float sca
+00001b70: 6c65 5f74 6f5f 696e 6620 3d20 3078 312e  le_to_inf = 0x1.
+00001b80: 3070 2b31 3132 663b 0a20 2020 2063 6f6e  0p+112f;.    con
+00001b90: 7374 2066 6c6f 6174 2073 6361 6c65 5f74  st float scale_t
+00001ba0: 6f5f 7a65 726f 203d 2030 7831 2e30 702d  o_zero = 0x1.0p-
+00001bb0: 3131 3066 3b0a 2365 6c73 650a 2020 2020  110f;.#else.    
+00001bc0: 636f 6e73 7420 666c 6f61 7420 7363 616c  const float scal
+00001bd0: 655f 746f 5f69 6e66 203d 2066 7033 325f  e_to_inf = fp32_
+00001be0: 6672 6f6d 5f62 6974 7328 5549 4e54 3332  from_bits(UINT32
+00001bf0: 5f43 2830 7837 3738 3030 3030 3029 293b  _C(0x77800000));
+00001c00: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
+00001c10: 2073 6361 6c65 5f74 6f5f 7a65 726f 203d   scale_to_zero =
+00001c20: 2066 7033 325f 6672 6f6d 5f62 6974 7328   fp32_from_bits(
+00001c30: 5549 4e54 3332 5f43 2830 7830 3838 3030  UINT32_C(0x08800
+00001c40: 3030 3029 293b 0a23 656e 6469 660a 2020  000));.#endif.  
+00001c50: 2020 666c 6f61 7420 6261 7365 203d 2028    float base = (
+00001c60: 6661 6273 6628 6629 202a 2073 6361 6c65  fabsf(f) * scale
+00001c70: 5f74 6f5f 696e 6629 202a 2073 6361 6c65  _to_inf) * scale
+00001c80: 5f74 6f5f 7a65 726f 3b0a 0a20 2020 2063  _to_zero;..    c
+00001c90: 6f6e 7374 2075 696e 7433 325f 7420 7720  onst uint32_t w 
+00001ca0: 3d20 6670 3332 5f74 6f5f 6269 7473 2866  = fp32_to_bits(f
+00001cb0: 293b 0a20 2020 2063 6f6e 7374 2075 696e  );.    const uin
+00001cc0: 7433 325f 7420 7368 6c31 5f77 203d 2077  t32_t shl1_w = w
+00001cd0: 202b 2077 3b0a 2020 2020 636f 6e73 7420   + w;.    const 
+00001ce0: 7569 6e74 3332 5f74 2073 6967 6e20 3d20  uint32_t sign = 
+00001cf0: 7720 2620 5549 4e54 3332 5f43 2830 7838  w & UINT32_C(0x8
+00001d00: 3030 3030 3030 3029 3b0a 2020 2020 7569  0000000);.    ui
+00001d10: 6e74 3332 5f74 2062 6961 7320 3d20 7368  nt32_t bias = sh
+00001d20: 6c31 5f77 2026 2055 494e 5433 325f 4328  l1_w & UINT32_C(
+00001d30: 3078 4646 3030 3030 3030 293b 0a20 2020  0xFF000000);.   
+00001d40: 2069 6620 2862 6961 7320 3c20 5549 4e54   if (bias < UINT
+00001d50: 3332 5f43 2830 7837 3130 3030 3030 3029  32_C(0x71000000)
+00001d60: 2920 7b0a 2020 2020 2020 2020 6269 6173  ) {.        bias
+00001d70: 203d 2055 494e 5433 325f 4328 3078 3731   = UINT32_C(0x71
+00001d80: 3030 3030 3030 293b 0a20 2020 207d 0a0a  000000);.    }..
+00001d90: 2020 2020 6261 7365 203d 2066 7033 325f      base = fp32_
+00001da0: 6672 6f6d 5f62 6974 7328 2862 6961 7320  from_bits((bias 
+00001db0: 3e3e 2031 2920 2b20 5549 4e54 3332 5f43  >> 1) + UINT32_C
+00001dc0: 2830 7830 3738 3030 3030 3029 2920 2b20  (0x07800000)) + 
+00001dd0: 6261 7365 3b0a 2020 2020 636f 6e73 7420  base;.    const 
+00001de0: 7569 6e74 3332 5f74 2062 6974 7320 3d20  uint32_t bits = 
+00001df0: 6670 3332 5f74 6f5f 6269 7473 2862 6173  fp32_to_bits(bas
+00001e00: 6529 3b0a 2020 2020 636f 6e73 7420 7569  e);.    const ui
+00001e10: 6e74 3332 5f74 2065 7870 5f62 6974 7320  nt32_t exp_bits 
+00001e20: 3d20 2862 6974 7320 3e3e 2031 3329 2026  = (bits >> 13) &
+00001e30: 2055 494e 5433 325f 4328 3078 3030 3030   UINT32_C(0x0000
+00001e40: 3743 3030 293b 0a20 2020 2063 6f6e 7374  7C00);.    const
+00001e50: 2075 696e 7433 325f 7420 6d61 6e74 6973   uint32_t mantis
+00001e60: 7361 5f62 6974 7320 3d20 6269 7473 2026  sa_bits = bits &
+00001e70: 2055 494e 5433 325f 4328 3078 3030 3030   UINT32_C(0x0000
+00001e80: 3046 4646 293b 0a20 2020 2063 6f6e 7374  0FFF);.    const
+00001e90: 2075 696e 7433 325f 7420 6e6f 6e73 6967   uint32_t nonsig
+00001ea0: 6e20 3d20 6578 705f 6269 7473 202b 206d  n = exp_bits + m
+00001eb0: 616e 7469 7373 615f 6269 7473 3b0a 2020  antissa_bits;.  
+00001ec0: 2020 7265 7475 726e 2028 7369 676e 203e    return (sign >
+00001ed0: 3e20 3136 2920 7c20 2873 686c 315f 7720  > 16) | (shl1_w 
+00001ee0: 3e20 5549 4e54 3332 5f43 2830 7846 4630  > UINT32_C(0xFF0
+00001ef0: 3030 3030 3029 203f 2055 494e 5431 365f  00000) ? UINT16_
+00001f00: 4328 3078 3745 3030 2920 3a20 6e6f 6e73  C(0x7E00) : nons
+00001f10: 6967 6e29 3b0a 7d0a 0a23 6465 6669 6e65  ign);.}..#define
+00001f20: 2047 474d 4c5f 434f 4d50 5554 455f 4650   GGML_COMPUTE_FP
+00001f30: 3136 5f54 4f5f 4650 3332 2878 2920 6767  16_TO_FP32(x) gg
+00001f40: 6d6c 5f63 6f6d 7075 7465 5f66 7031 365f  ml_compute_fp16_
+00001f50: 746f 5f66 7033 3228 7829 0a23 6465 6669  to_fp32(x).#defi
+00001f60: 6e65 2047 474d 4c5f 434f 4d50 5554 455f  ne GGML_COMPUTE_
+00001f70: 4650 3332 5f54 4f5f 4650 3136 2878 2920  FP32_TO_FP16(x) 
+00001f80: 6767 6d6c 5f63 6f6d 7075 7465 5f66 7033  ggml_compute_fp3
+00001f90: 325f 746f 5f66 7031 3628 7829 0a0a 2365  2_to_fp16(x)..#e
+00001fa0: 6e64 6966 202f 2f20 5f5f 4631 3643 5f5f  ndif // __F16C__
+00001fb0: 0a0a 2365 6e64 6966 202f 2f20 5f5f 4152  ..#endif // __AR
+00001fc0: 4d5f 4e45 4f4e 0a0a 2f2f 0a2f 2f20 676c  M_NEON..//.// gl
+00001fd0: 6f62 616c 2064 6174 610a 2f2f 0a0a 2f2f  obal data.//..//
+00001fe0: 2070 7265 636f 6d70 7574 6564 2067 656c   precomputed gel
+00001ff0: 7520 7461 626c 6520 666f 7220 6631 3620  u table for f16 
+00002000: 2831 3238 204b 4229 0a73 7461 7469 6320  (128 KB).static 
+00002010: 6767 6d6c 5f66 7031 365f 7420 7461 626c  ggml_fp16_t tabl
+00002020: 655f 6765 6c75 5f66 3136 5b31 203c 3c20  e_gelu_f16[1 << 
+00002030: 3136 5d3b 0a0a 2f2f 2070 7265 636f 6d70  16];..// precomp
+00002040: 7574 6564 2073 696c 7520 7461 626c 6520  uted silu table 
+00002050: 666f 7220 6631 3620 2831 3238 204b 4229  for f16 (128 KB)
+00002060: 0a73 7461 7469 6320 6767 6d6c 5f66 7031  .static ggml_fp1
+00002070: 365f 7420 7461 626c 655f 7369 6c75 5f66  6_t table_silu_f
+00002080: 3136 5b31 203c 3c20 3136 5d3b 0a0a 2f2f  16[1 << 16];..//
+00002090: 2070 7265 636f 6d70 7574 6564 2065 7870   precomputed exp
+000020a0: 2074 6162 6c65 2066 6f72 2066 3136 2028   table for f16 (
+000020b0: 3132 3820 4b42 290a 7374 6174 6963 2067  128 KB).static g
+000020c0: 676d 6c5f 6670 3136 5f74 2074 6162 6c65  gml_fp16_t table
+000020d0: 5f65 7870 5f66 3136 5b31 203c 3c20 3136  _exp_f16[1 << 16
+000020e0: 5d3b 0a0a 2f2f 2070 7265 636f 6d70 7574  ];..// precomput
+000020f0: 6564 2066 3332 2074 6162 6c65 2066 6f72  ed f32 table for
+00002100: 2066 3136 2028 3235 3620 4b42 290a 7374   f16 (256 KB).st
+00002110: 6174 6963 2066 6c6f 6174 2074 6162 6c65  atic float table
+00002120: 5f66 3332 5f66 3136 5b31 203c 3c20 3136  _f32_f16[1 << 16
+00002130: 5d3b 0a0a 2f2f 204f 6e20 4152 4d20 4e45  ];..// On ARM NE
+00002140: 4f4e 2c20 6974 2773 2071 7569 636b 6572  ON, it's quicker
+00002150: 2074 6f20 6469 7265 6374 6c79 2063 6f6e   to directly con
+00002160: 7665 7274 2078 202d 3e20 7820 696e 7374  vert x -> x inst
+00002170: 6561 6420 6f66 2063 616c 6c69 6e67 2069  ead of calling i
+00002180: 6e74 6f20 6767 6d6c 5f6c 6f6f 6b75 705f  nto ggml_lookup_
+00002190: 6670 3136 5f74 6f5f 6670 3332 2c0a 2f2f  fp16_to_fp32,.//
+000021a0: 2073 6f20 7765 2064 6566 696e 6520 4747   so we define GG
+000021b0: 4d4c 5f46 5031 365f 544f 5f46 5033 3220  ML_FP16_TO_FP32 
+000021c0: 616e 6420 4747 4d4c 5f46 5033 325f 544f  and GGML_FP32_TO
+000021d0: 5f46 5031 3620 656c 7365 7768 6572 6520  _FP16 elsewhere 
+000021e0: 666f 7220 4e45 4f4e 2e0a 2f2f 2054 6869  for NEON..// Thi
+000021f0: 7320 6973 2061 6c73 6f20 7472 7565 2066  s is also true f
+00002200: 6f72 2050 4f57 4552 392e 0a23 6966 2021  or POWER9..#if !
+00002210: 6465 6669 6e65 6428 4747 4d4c 5f46 5031  defined(GGML_FP1
+00002220: 365f 544f 5f46 5033 3229 207c 7c20 2164  6_TO_FP32) || !d
+00002230: 6566 696e 6564 2847 474d 4c5f 4650 3332  efined(GGML_FP32
+00002240: 5f54 4f5f 4650 3136 290a 0a69 6e6c 696e  _TO_FP16)..inlin
+00002250: 6520 7374 6174 6963 2066 6c6f 6174 2067  e static float g
+00002260: 676d 6c5f 6c6f 6f6b 7570 5f66 7031 365f  gml_lookup_fp16_
+00002270: 746f 5f66 7033 3228 6767 6d6c 5f66 7031  to_fp32(ggml_fp1
+00002280: 365f 7420 6629 207b 0a20 2020 2075 696e  6_t f) {.    uin
+00002290: 7431 365f 7420 733b 0a20 2020 206d 656d  t16_t s;.    mem
+000022a0: 6370 7928 2673 2c20 2666 2c20 7369 7a65  cpy(&s, &f, size
+000022b0: 6f66 2875 696e 7431 365f 7429 293b 0a20  of(uint16_t));. 
+000022c0: 2020 2072 6574 7572 6e20 7461 626c 655f     return table_
+000022d0: 6633 325f 6631 365b 735d 3b0a 7d0a 0a23  f32_f16[s];.}..#
+000022e0: 6465 6669 6e65 2047 474d 4c5f 4650 3136  define GGML_FP16
+000022f0: 5f54 4f5f 4650 3332 2878 2920 6767 6d6c  _TO_FP32(x) ggml
+00002300: 5f6c 6f6f 6b75 705f 6670 3136 5f74 6f5f  _lookup_fp16_to_
+00002310: 6670 3332 2878 290a 2364 6566 696e 6520  fp32(x).#define 
+00002320: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
+00002330: 3628 7829 2047 474d 4c5f 434f 4d50 5554  6(x) GGML_COMPUT
+00002340: 455f 4650 3332 5f54 4f5f 4650 3136 2878  E_FP32_TO_FP16(x
+00002350: 290a 0a23 656e 6469 660a 0a2f 2f20 6e6f  )..#endif..// no
+00002360: 7465 3a20 646f 206e 6f74 2075 7365 2074  te: do not use t
+00002370: 6865 7365 2069 6e73 6964 6520 6767 6d6c  hese inside ggml
+00002380: 2e63 0a2f 2f20 7468 6573 6520 6172 6520  .c.// these are 
+00002390: 6d65 616e 7420 746f 2062 6520 7573 6564  meant to be used
+000023a0: 2076 6961 2074 6865 2067 676d 6c2e 6820   via the ggml.h 
+000023b0: 4150 490a 666c 6f61 7420 6767 6d6c 5f66  API.float ggml_f
+000023c0: 7031 365f 746f 5f66 7033 3228 6767 6d6c  p16_to_fp32(ggml
+000023d0: 5f66 7031 365f 7420 7829 207b 0a20 2020  _fp16_t x) {.   
+000023e0: 2072 6574 7572 6e20 2866 6c6f 6174 2920   return (float) 
+000023f0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+00002400: 3228 7829 3b0a 7d0a 0a67 676d 6c5f 6670  2(x);.}..ggml_fp
+00002410: 3136 5f74 2067 676d 6c5f 6670 3332 5f74  16_t ggml_fp32_t
+00002420: 6f5f 6670 3136 2866 6c6f 6174 2078 2920  o_fp16(float x) 
+00002430: 7b0a 2020 2020 7265 7475 726e 2047 474d  {.    return GGM
+00002440: 4c5f 4650 3332 5f54 4f5f 4650 3136 2878  L_FP32_TO_FP16(x
+00002450: 293b 0a7d 0a0a 2f2f 0a2f 2f20 7469 6d69  );.}..//.// timi
+00002460: 6e67 0a2f 2f0a 0a23 6966 2064 6566 696e  ng.//..#if defin
+00002470: 6564 285f 4d53 435f 5645 5229 207c 7c20  ed(_MSC_VER) || 
+00002480: 6465 6669 6e65 6428 5f5f 4d49 4e47 5733  defined(__MINGW3
+00002490: 325f 5f29 0a73 7461 7469 6320 696e 7436  2__).static int6
+000024a0: 345f 7420 7469 6d65 725f 6672 6571 3b0a  4_t timer_freq;.
+000024b0: 766f 6964 2067 676d 6c5f 7469 6d65 5f69  void ggml_time_i
+000024c0: 6e69 7428 766f 6964 2920 7b0a 2020 2020  nit(void) {.    
+000024d0: 4c41 5247 455f 494e 5445 4745 5220 6672  LARGE_INTEGER fr
+000024e0: 6571 7565 6e63 793b 0a20 2020 2051 7565  equency;.    Que
+000024f0: 7279 5065 7266 6f72 6d61 6e63 6546 7265  ryPerformanceFre
+00002500: 7175 656e 6379 2826 6672 6571 7565 6e63  quency(&frequenc
+00002510: 7929 3b0a 2020 2020 7469 6d65 725f 6672  y);.    timer_fr
+00002520: 6571 203d 2066 7265 7175 656e 6379 2e51  eq = frequency.Q
+00002530: 7561 6450 6172 743b 0a7d 0a69 6e74 3634  uadPart;.}.int64
+00002540: 5f74 2067 676d 6c5f 7469 6d65 5f6d 7328  _t ggml_time_ms(
+00002550: 766f 6964 2920 7b0a 2020 2020 4c41 5247  void) {.    LARG
+00002560: 455f 494e 5445 4745 5220 743b 0a20 2020  E_INTEGER t;.   
+00002570: 2051 7565 7279 5065 7266 6f72 6d61 6e63   QueryPerformanc
+00002580: 6543 6f75 6e74 6572 2826 7429 3b0a 2020  eCounter(&t);.  
+00002590: 2020 7265 7475 726e 2028 742e 5175 6164    return (t.Quad
+000025a0: 5061 7274 202a 2031 3030 3029 202f 2074  Part * 1000) / t
+000025b0: 696d 6572 5f66 7265 713b 0a7d 0a69 6e74  imer_freq;.}.int
+000025c0: 3634 5f74 2067 676d 6c5f 7469 6d65 5f75  64_t ggml_time_u
+000025d0: 7328 766f 6964 2920 7b0a 2020 2020 4c41  s(void) {.    LA
+000025e0: 5247 455f 494e 5445 4745 5220 743b 0a20  RGE_INTEGER t;. 
+000025f0: 2020 2051 7565 7279 5065 7266 6f72 6d61     QueryPerforma
+00002600: 6e63 6543 6f75 6e74 6572 2826 7429 3b0a  nceCounter(&t);.
+00002610: 2020 2020 7265 7475 726e 2028 742e 5175      return (t.Qu
+00002620: 6164 5061 7274 202a 2031 3030 3030 3030  adPart * 1000000
+00002630: 2920 2f20 7469 6d65 725f 6672 6571 3b0a  ) / timer_freq;.
+00002640: 7d0a 2365 6c73 650a 766f 6964 2067 676d  }.#else.void ggm
+00002650: 6c5f 7469 6d65 5f69 6e69 7428 766f 6964  l_time_init(void
+00002660: 2920 7b7d 0a69 6e74 3634 5f74 2067 676d  ) {}.int64_t ggm
+00002670: 6c5f 7469 6d65 5f6d 7328 766f 6964 2920  l_time_ms(void) 
+00002680: 7b0a 2020 2020 7374 7275 6374 2074 696d  {.    struct tim
+00002690: 6573 7065 6320 7473 3b0a 2020 2020 636c  espec ts;.    cl
+000026a0: 6f63 6b5f 6765 7474 696d 6528 434c 4f43  ock_gettime(CLOC
+000026b0: 4b5f 4d4f 4e4f 544f 4e49 432c 2026 7473  K_MONOTONIC, &ts
+000026c0: 293b 0a20 2020 2072 6574 7572 6e20 2869  );.    return (i
+000026d0: 6e74 3634 5f74 2974 732e 7476 5f73 6563  nt64_t)ts.tv_sec
+000026e0: 2a31 3030 3020 2b20 2869 6e74 3634 5f74  *1000 + (int64_t
+000026f0: 2974 732e 7476 5f6e 7365 632f 3130 3030  )ts.tv_nsec/1000
+00002700: 3030 303b 0a7d 0a0a 696e 7436 345f 7420  000;.}..int64_t 
+00002710: 6767 6d6c 5f74 696d 655f 7573 2876 6f69  ggml_time_us(voi
+00002720: 6429 207b 0a20 2020 2073 7472 7563 7420  d) {.    struct 
+00002730: 7469 6d65 7370 6563 2074 733b 0a20 2020  timespec ts;.   
+00002740: 2063 6c6f 636b 5f67 6574 7469 6d65 2843   clock_gettime(C
+00002750: 4c4f 434b 5f4d 4f4e 4f54 4f4e 4943 2c20  LOCK_MONOTONIC, 
+00002760: 2674 7329 3b0a 2020 2020 7265 7475 726e  &ts);.    return
+00002770: 2028 696e 7436 345f 7429 7473 2e74 765f   (int64_t)ts.tv_
+00002780: 7365 632a 3130 3030 3030 3020 2b20 2869  sec*1000000 + (i
+00002790: 6e74 3634 5f74 2974 732e 7476 5f6e 7365  nt64_t)ts.tv_nse
+000027a0: 632f 3130 3030 3b0a 7d0a 2365 6e64 6966  c/1000;.}.#endif
+000027b0: 0a0a 696e 7436 345f 7420 6767 6d6c 5f63  ..int64_t ggml_c
+000027c0: 7963 6c65 7328 766f 6964 2920 7b0a 2020  ycles(void) {.  
+000027d0: 2020 7265 7475 726e 2063 6c6f 636b 2829    return clock()
+000027e0: 3b0a 7d0a 0a69 6e74 3634 5f74 2067 676d  ;.}..int64_t ggm
+000027f0: 6c5f 6379 636c 6573 5f70 6572 5f6d 7328  l_cycles_per_ms(
+00002800: 766f 6964 2920 7b0a 2020 2020 7265 7475  void) {.    retu
+00002810: 726e 2043 4c4f 434b 535f 5045 525f 5345  rn CLOCKS_PER_SE
+00002820: 432f 3130 3030 3b0a 7d0a 0a23 6966 6465  C/1000;.}..#ifde
+00002830: 6620 4747 4d4c 5f50 4552 460a 2364 6566  f GGML_PERF.#def
+00002840: 696e 6520 6767 6d6c 5f70 6572 665f 7469  ine ggml_perf_ti
+00002850: 6d65 5f6d 7328 2920 2020 2020 2020 6767  me_ms()       gg
+00002860: 6d6c 5f74 696d 655f 6d73 2829 0a23 6465  ml_time_ms().#de
+00002870: 6669 6e65 2067 676d 6c5f 7065 7266 5f74  fine ggml_perf_t
+00002880: 696d 655f 7573 2829 2020 2020 2020 2067  ime_us()       g
+00002890: 676d 6c5f 7469 6d65 5f75 7328 290a 2364  gml_time_us().#d
+000028a0: 6566 696e 6520 6767 6d6c 5f70 6572 665f  efine ggml_perf_
+000028b0: 6379 636c 6573 2829 2020 2020 2020 2020  cycles()        
+000028c0: 6767 6d6c 5f63 7963 6c65 7328 290a 2364  ggml_cycles().#d
+000028d0: 6566 696e 6520 6767 6d6c 5f70 6572 665f  efine ggml_perf_
+000028e0: 6379 636c 6573 5f70 6572 5f6d 7328 2920  cycles_per_ms() 
+000028f0: 6767 6d6c 5f63 7963 6c65 735f 7065 725f  ggml_cycles_per_
+00002900: 6d73 2829 0a23 656c 7365 0a23 6465 6669  ms().#else.#defi
+00002910: 6e65 2067 676d 6c5f 7065 7266 5f74 696d  ne ggml_perf_tim
+00002920: 655f 6d73 2829 2020 2020 2020 2030 0a23  e_ms()       0.#
+00002930: 6465 6669 6e65 2067 676d 6c5f 7065 7266  define ggml_perf
+00002940: 5f74 696d 655f 7573 2829 2020 2020 2020  _time_us()      
+00002950: 2030 0a23 6465 6669 6e65 2067 676d 6c5f   0.#define ggml_
+00002960: 7065 7266 5f63 7963 6c65 7328 2920 2020  perf_cycles()   
+00002970: 2020 2020 2030 0a23 6465 6669 6e65 2067       0.#define g
+00002980: 676d 6c5f 7065 7266 5f63 7963 6c65 735f  gml_perf_cycles_
+00002990: 7065 725f 6d73 2829 2030 0a23 656e 6469  per_ms() 0.#endi
+000029a0: 660a 0a2f 2f0a 2f2f 2063 6163 6865 206c  f..//.// cache l
+000029b0: 696e 650a 2f2f 0a0a 2369 6620 6465 6669  ine.//..#if defi
+000029c0: 6e65 6428 5f5f 6370 705f 6c69 625f 6861  ned(__cpp_lib_ha
+000029d0: 7264 7761 7265 5f69 6e74 6572 6665 7265  rdware_interfere
+000029e0: 6e63 655f 7369 7a65 290a 2364 6566 696e  nce_size).#defin
+000029f0: 6520 4341 4348 455f 4c49 4e45 5f53 495a  e CACHE_LINE_SIZ
+00002a00: 4520 6861 7264 7761 7265 5f64 6573 7472  E hardware_destr
+00002a10: 7563 7469 7665 5f69 6e74 6572 6665 7265  uctive_interfere
+00002a20: 6e63 655f 7369 7a65 0a23 656c 7365 0a23  nce_size.#else.#
+00002a30: 6966 2064 6566 696e 6564 285f 5f50 4f57  if defined(__POW
+00002a40: 4552 395f 5645 4354 4f52 5f5f 290a 2364  ER9_VECTOR__).#d
+00002a50: 6566 696e 6520 4341 4348 455f 4c49 4e45  efine CACHE_LINE
+00002a60: 5f53 495a 4520 3132 380a 2365 6c73 650a  _SIZE 128.#else.
+00002a70: 2364 6566 696e 6520 4341 4348 455f 4c49  #define CACHE_LI
+00002a80: 4e45 5f53 495a 4520 3634 0a23 656e 6469  NE_SIZE 64.#endi
+00002a90: 660a 2365 6e64 6966 0a0a 7374 6174 6963  f.#endif..static
+00002aa0: 2063 6f6e 7374 2073 697a 655f 7420 4341   const size_t CA
+00002ab0: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
+00002ac0: 3220 3d20 4341 4348 455f 4c49 4e45 5f53  2 = CACHE_LINE_S
+00002ad0: 495a 452f 7369 7a65 6f66 2866 6c6f 6174  IZE/sizeof(float
+00002ae0: 293b 0a0a 2f2f 0a2f 2f20 7175 616e 7469  );..//.// quanti
+00002af0: 7a61 7469 6f6e 0a2f 2f0a 0a23 6465 6669  zation.//..#defi
+00002b00: 6e65 2051 4b20 3332 0a0a 2f2f 2041 5658  ne QK 32..// AVX
+00002b10: 2072 6f75 7469 6e65 7320 7072 6f76 6964   routines provid
+00002b20: 6564 2062 7920 4748 2075 7365 7220 436f  ed by GH user Co
+00002b30: 6e73 742d 6d65 0a2f 2f20 7265 663a 2068  nst-me.// ref: h
+00002b40: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+00002b50: 6d2f 6767 6572 6761 6e6f 762f 6767 6d6c  m/ggerganov/ggml
+00002b60: 2f70 756c 6c2f 3237 2369 7373 7565 636f  /pull/27#issueco
+00002b70: 6d6d 656e 742d 3134 3634 3933 3436 3030  mment-1464934600
+00002b80: 0a23 6966 205f 5f41 5658 325f 5f20 7c7c  .#if __AVX2__ ||
+00002b90: 205f 5f41 5658 3531 3246 5f5f 0a2f 2f20   __AVX512F__.// 
+00002ba0: 556e 7061 636b 2033 3220 342d 6269 7420  Unpack 32 4-bit 
+00002bb0: 6669 656c 6473 2069 6e74 6f20 3332 2062  fields into 32 b
+00002bc0: 7974 6573 0a2f 2f20 5468 6520 6f75 7470  ytes.// The outp
+00002bd0: 7574 2076 6563 746f 7220 636f 6e74 6169  ut vector contai
+00002be0: 6e73 2033 3220 6279 7465 732c 2065 6163  ns 32 bytes, eac
+00002bf0: 6820 6f6e 6520 696e 205b 2030 202e 2e20  h one in [ 0 .. 
+00002c00: 3135 205d 2069 6e74 6572 7661 6c0a 7374  15 ] interval.st
+00002c10: 6174 6963 2069 6e6c 696e 6520 5f5f 6d32  atic inline __m2
+00002c20: 3536 6920 6279 7465 7346 726f 6d4e 6962  56i bytesFromNib
+00002c30: 626c 6573 2820 636f 6e73 7420 7569 6e74  bles( const uint
+00002c40: 385f 742a 2072 7369 2029 0a7b 0a20 2020  8_t* rsi ).{.   
+00002c50: 202f 2f20 4c6f 6164 2031 3620 6279 7465   // Load 16 byte
+00002c60: 7320 6672 6f6d 206d 656d 6f72 790a 2020  s from memory.  
+00002c70: 2020 5f5f 6d31 3238 6920 746d 7020 3d20    __m128i tmp = 
+00002c80: 5f6d 6d5f 6c6f 6164 755f 7369 3132 3828  _mm_loadu_si128(
+00002c90: 2028 2063 6f6e 7374 205f 5f6d 3132 3869   ( const __m128i
+00002ca0: 2a20 2972 7369 2029 3b0a 0a20 2020 202f  * )rsi );..    /
+00002cb0: 2f20 4578 7061 6e64 2062 7974 6573 2069  / Expand bytes i
+00002cc0: 6e74 6f20 7569 6e74 3136 5f74 2076 616c  nto uint16_t val
+00002cd0: 7565 730a 2020 2020 5f5f 6d32 3536 6920  ues.    __m256i 
+00002ce0: 6279 7465 7320 3d20 5f6d 6d32 3536 5f63  bytes = _mm256_c
+00002cf0: 7674 6570 7538 5f65 7069 3136 2820 746d  vtepu8_epi16( tm
+00002d00: 7020 293b 0a0a 2020 2020 2f2f 2055 6e70  p );..    // Unp
+00002d10: 6163 6b20 7661 6c75 6573 2069 6e74 6f20  ack values into 
+00002d20: 696e 6469 7669 6475 616c 2062 7974 6573  individual bytes
+00002d30: 0a20 2020 2063 6f6e 7374 205f 5f6d 3235  .    const __m25
+00002d40: 3669 206c 6f77 4d61 736b 203d 205f 6d6d  6i lowMask = _mm
+00002d50: 3235 365f 7365 7431 5f65 7069 3828 2030  256_set1_epi8( 0
+00002d60: 7846 2029 3b0a 2020 2020 5f5f 6d32 3536  xF );.    __m256
+00002d70: 6920 6869 6768 203d 205f 6d6d 3235 365f  i high = _mm256_
+00002d80: 616e 646e 6f74 5f73 6932 3536 2820 6c6f  andnot_si256( lo
+00002d90: 774d 6173 6b2c 2062 7974 6573 2029 3b0a  wMask, bytes );.
+00002da0: 2020 2020 5f5f 6d32 3536 6920 6c6f 7720      __m256i low 
+00002db0: 3d20 5f6d 6d32 3536 5f61 6e64 5f73 6932  = _mm256_and_si2
+00002dc0: 3536 2820 6c6f 774d 6173 6b2c 2062 7974  56( lowMask, byt
+00002dd0: 6573 2029 3b0a 2020 2020 6869 6768 203d  es );.    high =
+00002de0: 205f 6d6d 3235 365f 736c 6c69 5f65 7069   _mm256_slli_epi
+00002df0: 3136 2820 6869 6768 2c20 3420 293b 0a20  16( high, 4 );. 
+00002e00: 2020 2062 7974 6573 203d 205f 6d6d 3235     bytes = _mm25
+00002e10: 365f 6f72 5f73 6932 3536 2820 6c6f 772c  6_or_si256( low,
+00002e20: 2068 6967 6820 293b 0a20 2020 2072 6574   high );.    ret
+00002e30: 7572 6e20 6279 7465 733b 0a7d 0a0a 7374  urn bytes;.}..st
+00002e40: 6174 6963 2069 6e6c 696e 6520 5f5f 6d31  atic inline __m1
+00002e50: 3238 6920 7061 636b 4e69 6262 6c65 7328  28i packNibbles(
+00002e60: 205f 5f6d 3235 3669 2062 7974 6573 2029   __m256i bytes )
+00002e70: 0a7b 0a20 2020 202f 2f20 4d6f 7665 2062  .{.    // Move b
+00002e80: 6974 7320 7769 7468 696e 2031 362d 6269  its within 16-bi
+00002e90: 7420 6c61 6e65 7320 6672 6f6d 2030 3030  t lanes from 000
+00002ea0: 305f 6162 6364 5f30 3030 305f 6566 6768  0_abcd_0000_efgh
+00002eb0: 2069 6e74 6f20 3030 3030 5f30 3030 305f   into 0000_0000_
+00002ec0: 6162 6364 5f65 6667 680a 2020 2020 636f  abcd_efgh.    co
+00002ed0: 6e73 7420 5f5f 6d32 3536 6920 6c6f 7742  nst __m256i lowB
+00002ee0: 7974 6520 3d20 5f6d 6d32 3536 5f73 6574  yte = _mm256_set
+00002ef0: 315f 6570 6931 3628 2030 7846 4620 293b  1_epi16( 0xFF );
+00002f00: 0a20 2020 205f 5f6d 3235 3669 2068 6967  .    __m256i hig
+00002f10: 6820 3d20 5f6d 6d32 3536 5f61 6e64 6e6f  h = _mm256_andno
+00002f20: 745f 7369 3235 3628 206c 6f77 4279 7465  t_si256( lowByte
+00002f30: 2c20 6279 7465 7320 293b 0a20 2020 205f  , bytes );.    _
+00002f40: 5f6d 3235 3669 206c 6f77 203d 205f 6d6d  _m256i low = _mm
+00002f50: 3235 365f 616e 645f 7369 3235 3628 206c  256_and_si256( l
+00002f60: 6f77 4279 7465 2c20 6279 7465 7320 293b  owByte, bytes );
+00002f70: 0a20 2020 2068 6967 6820 3d20 5f6d 6d32  .    high = _mm2
+00002f80: 3536 5f73 726c 695f 6570 6931 3628 2068  56_srli_epi16( h
+00002f90: 6967 682c 2034 2029 3b0a 2020 2020 6279  igh, 4 );.    by
+00002fa0: 7465 7320 3d20 5f6d 6d32 3536 5f6f 725f  tes = _mm256_or_
+00002fb0: 7369 3235 3628 206c 6f77 2c20 6869 6768  si256( low, high
+00002fc0: 2029 3b0a 0a20 2020 202f 2f20 436f 6d70   );..    // Comp
+00002fd0: 7265 7373 2075 696e 7431 365f 7420 6c61  ress uint16_t la
+00002fe0: 6e65 7320 696e 746f 2062 7974 6573 0a20  nes into bytes. 
+00002ff0: 2020 205f 5f6d 3132 3869 2072 3020 3d20     __m128i r0 = 
+00003000: 5f6d 6d32 3536 5f63 6173 7473 6932 3536  _mm256_castsi256
+00003010: 5f73 6931 3238 2820 6279 7465 7320 293b  _si128( bytes );
+00003020: 0a20 2020 205f 5f6d 3132 3869 2072 3120  .    __m128i r1 
+00003030: 3d20 5f6d 6d32 3536 5f65 7874 7261 6374  = _mm256_extract
+00003040: 6931 3238 5f73 6932 3536 2820 6279 7465  i128_si256( byte
+00003050: 732c 2031 2029 3b0a 2020 2020 7265 7475  s, 1 );.    retu
+00003060: 726e 205f 6d6d 5f70 6163 6b75 735f 6570  rn _mm_packus_ep
+00003070: 6931 3628 2072 302c 2072 3120 293b 0a7d  i16( r0, r1 );.}
+00003080: 0a23 656e 6469 660a 0a2f 2f20 6d65 7468  .#endif..// meth
+00003090: 6f64 2035 0a2f 2f20 626c 6f63 6b73 206f  od 5.// blocks o
+000030a0: 6620 514b 2065 6c65 6d65 6e74 730a 2f2f  f QK elements.//
+000030b0: 2072 6570 7265 7365 6e74 6564 2077 6974   represented wit
+000030c0: 6820 6120 7369 6e67 6c65 2066 6c6f 6174  h a single float
+000030d0: 2028 6465 6c74 6129 2061 6e64 2051 4b2f   (delta) and QK/
+000030e0: 3220 382d 6269 7420 696e 7473 2028 692e  2 8-bit ints (i.
+000030f0: 6520 514b 2034 2d62 6974 2073 6967 6e65  e QK 4-bit signe
+00003100: 6420 696e 7465 6765 7220 6661 6374 6f72  d integer factor
+00003110: 7329 0a74 7970 6564 6566 2073 7472 7563  s).typedef struc
+00003120: 7420 7b0a 2020 2020 666c 6f61 7420 2020  t {.    float   
+00003130: 643b 202f 2f20 6465 6c74 610a 2020 2020  d; // delta.    
+00003140: 7569 6e74 385f 7420 7173 5b51 4b20 2f20  uint8_t qs[QK / 
+00003150: 325d 3b20 2f2f 206e 6962 626c 6573 202f  2]; // nibbles /
+00003160: 2071 7561 6e74 730a 7d20 626c 6f63 6b5f   quants.} block_
+00003170: 7134 5f30 3b0a 7374 6174 6963 5f61 7373  q4_0;.static_ass
+00003180: 6572 7428 7369 7a65 6f66 2862 6c6f 636b  ert(sizeof(block
+00003190: 5f71 345f 3029 203d 3d20 7369 7a65 6f66  _q4_0) == sizeof
+000031a0: 2866 6c6f 6174 2920 2b20 514b 202f 2032  (float) + QK / 2
+000031b0: 2c20 2277 726f 6e67 2071 345f 3020 626c  , "wrong q4_0 bl
+000031c0: 6f63 6b20 7369 7a65 2f70 6164 6469 6e67  ock size/padding
+000031d0: 2229 3b0a 0a2f 2f20 6d65 7468 6f64 2034  ");..// method 4
+000031e0: 0a2f 2f20 626c 6f63 6b73 206f 6620 514b  .// blocks of QK
+000031f0: 2065 6c65 6d65 6e74 730a 2f2f 2072 6570   elements.// rep
+00003200: 7265 7365 6e74 6564 2077 6974 6820 3220  resented with 2 
+00003210: 666c 6f61 7473 2028 6465 6c74 6120 2b20  floats (delta + 
+00003220: 6d69 6e29 2061 6e64 2051 4b2f 3220 382d  min) and QK/2 8-
+00003230: 6269 7420 696e 7473 2028 692e 6520 514b  bit ints (i.e QK
+00003240: 2034 2d62 6974 2075 6e73 6967 6e65 6420   4-bit unsigned 
+00003250: 696e 7465 6765 7220 6661 6374 6f72 7329  integer factors)
+00003260: 0a74 7970 6564 6566 2073 7472 7563 7420  .typedef struct 
+00003270: 7b0a 2020 2020 666c 6f61 7420 2020 643b  {.    float   d;
+00003280: 0a20 2020 2066 6c6f 6174 2020 206d 3b0a  .    float   m;.
+00003290: 2020 2020 7569 6e74 385f 7420 7173 5b51      uint8_t qs[Q
+000032a0: 4b20 2f20 325d 3b20 2f2f 206e 6962 626c  K / 2]; // nibbl
+000032b0: 6573 202f 2071 7561 6e74 730a 7d20 626c  es / quants.} bl
+000032c0: 6f63 6b5f 7134 5f31 3b0a 7374 6174 6963  ock_q4_1;.static
+000032d0: 5f61 7373 6572 7428 7369 7a65 6f66 2862  _assert(sizeof(b
+000032e0: 6c6f 636b 5f71 345f 3129 203d 3d20 7369  lock_q4_1) == si
+000032f0: 7a65 6f66 2866 6c6f 6174 2920 2a20 3220  zeof(float) * 2 
+00003300: 2b20 514b 202f 2032 2c20 2277 726f 6e67  + QK / 2, "wrong
+00003310: 2071 345f 3120 626c 6f63 6b20 7369 7a65   q4_1 block size
+00003320: 2f70 6164 6469 6e67 2229 3b0a 0a2f 2f20  /padding");..// 
+00003330: 7265 6665 7265 6e63 6520 696d 706c 656d  reference implem
+00003340: 656e 7461 7469 6f6e 2066 6f72 2064 6574  entation for det
+00003350: 6572 6d69 6e69 7374 6963 2063 7265 6174  erministic creat
+00003360: 696f 6e20 6f66 206d 6f64 656c 2066 696c  ion of model fil
+00003370: 6573 0a73 7461 7469 6320 766f 6964 2071  es.static void q
+00003380: 7561 6e74 697a 655f 726f 775f 7134 5f30  uantize_row_q4_0
+00003390: 5f72 6566 6572 656e 6365 2863 6f6e 7374  _reference(const
+000033a0: 2066 6c6f 6174 202a 2072 6573 7472 6963   float * restric
+000033b0: 7420 782c 2062 6c6f 636b 5f71 345f 3020  t x, block_q4_0 
+000033c0: 2a20 7265 7374 7269 6374 2079 2c20 696e  * restrict y, in
+000033d0: 7420 6b29 207b 0a20 2020 2061 7373 6572  t k) {.    asser
+000033e0: 7428 6b20 2520 514b 203d 3d20 3029 3b0a  t(k % QK == 0);.
+000033f0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00003400: 203d 206b 202f 2051 4b3b 0a0a 2020 2020   = k / QK;..    
+00003410: 7569 6e74 385f 7420 7070 5b51 4b2f 325d  uint8_t pp[QK/2]
+00003420: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00003430: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
+00003440: 2b2b 2920 7b0a 2020 2020 2020 2020 666c  ++) {.        fl
+00003450: 6f61 7420 616d 6178 203d 2030 2e30 663b  oat amax = 0.0f;
+00003460: 202f 2f20 6162 736f 6c75 7465 206d 6178   // absolute max
+00003470: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+00003480: 6e74 206c 203d 2030 3b20 6c20 3c20 514b  nt l = 0; l < QK
+00003490: 3b20 6c2b 2b29 207b 0a20 2020 2020 2020  ; l++) {.       
+000034a0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+000034b0: 2076 203d 2078 5b69 2a51 4b20 2b20 6c5d   v = x[i*QK + l]
+000034c0: 3b0a 2020 2020 2020 2020 2020 2020 616d  ;.            am
+000034d0: 6178 203d 204d 4158 2861 6d61 782c 2066  ax = MAX(amax, f
+000034e0: 6162 7366 2876 2929 3b0a 2020 2020 2020  absf(v));.      
+000034f0: 2020 7d0a 0a20 2020 2020 2020 2063 6f6e    }..        con
+00003500: 7374 2066 6c6f 6174 2064 203d 2061 6d61  st float d = ama
+00003510: 7820 2f20 2828 3120 3c3c 2033 2920 2d20  x / ((1 << 3) - 
+00003520: 3129 3b0a 2020 2020 2020 2020 636f 6e73  1);.        cons
+00003530: 7420 666c 6f61 7420 6964 203d 2064 203f  t float id = d ?
+00003540: 2031 2e30 662f 6420 3a20 302e 3066 3b0a   1.0f/d : 0.0f;.
+00003550: 0a20 2020 2020 2020 2079 5b69 5d2e 6420  .        y[i].d 
+00003560: 3d20 643b 0a0a 2020 2020 2020 2020 666f  = d;..        fo
+00003570: 7220 2869 6e74 206c 203d 2030 3b20 6c20  r (int l = 0; l 
+00003580: 3c20 514b 3b20 6c20 2b3d 2032 2920 7b0a  < QK; l += 2) {.
+00003590: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000035a0: 7420 666c 6f61 7420 7630 203d 2078 5b69  t float v0 = x[i
+000035b0: 2a51 4b20 2b20 6c20 2b20 305d 2a69 643b  *QK + l + 0]*id;
+000035c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000035d0: 7374 2066 6c6f 6174 2076 3120 3d20 785b  st float v1 = x[
+000035e0: 692a 514b 202b 206c 202b 2031 5d2a 6964  i*QK + l + 1]*id
+000035f0: 3b0a 0a20 2020 2020 2020 2020 2020 2063  ;..            c
+00003600: 6f6e 7374 2075 696e 7438 5f74 2076 6930  onst uint8_t vi0
+00003610: 203d 2028 696e 7438 5f74 2972 6f75 6e64   = (int8_t)round
+00003620: 6628 7630 2920 2b20 383b 0a20 2020 2020  f(v0) + 8;.     
+00003630: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+00003640: 7438 5f74 2076 6931 203d 2028 696e 7438  t8_t vi1 = (int8
+00003650: 5f74 2972 6f75 6e64 6628 7631 2920 2b20  _t)roundf(v1) + 
+00003660: 383b 0a0a 2020 2020 2020 2020 2020 2020  8;..            
+00003670: 6173 7365 7274 2876 6930 203e 3d20 3020  assert(vi0 >= 0 
+00003680: 2626 2076 6930 203c 2031 3629 3b0a 2020  && vi0 < 16);.  
+00003690: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000036a0: 2876 6931 203e 3d20 3020 2626 2076 6931  (vi1 >= 0 && vi1
+000036b0: 203c 2031 3629 3b0a 0a20 2020 2020 2020   < 16);..       
+000036c0: 2020 2020 2070 705b 6c2f 325d 203d 2076       pp[l/2] = v
+000036d0: 6930 207c 2028 7669 3120 3c3c 2034 293b  i0 | (vi1 << 4);
+000036e0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+000036f0: 2020 2020 6d65 6d63 7079 2879 5b69 5d2e      memcpy(y[i].
+00003700: 7173 2c20 7070 2c20 7369 7a65 6f66 2870  qs, pp, sizeof(p
+00003710: 7029 293b 0a20 2020 207d 0a7d 0a0a 7374  p));.    }.}..st
+00003720: 6174 6963 2076 6f69 6420 7175 616e 7469  atic void quanti
+00003730: 7a65 5f72 6f77 5f71 345f 3028 636f 6e73  ze_row_q4_0(cons
+00003740: 7420 666c 6f61 7420 2a20 7265 7374 7269  t float * restri
+00003750: 6374 2078 2c20 766f 6964 202a 2072 6573  ct x, void * res
+00003760: 7472 6963 7420 7679 2c20 696e 7420 6b29  trict vy, int k)
+00003770: 207b 0a20 2020 2061 7373 6572 7428 6b20   {.    assert(k 
+00003780: 2520 514b 203d 3d20 3029 3b0a 2020 2020  % QK == 0);.    
+00003790: 636f 6e73 7420 696e 7420 6e62 203d 206b  const int nb = k
+000037a0: 202f 2051 4b3b 0a0a 2020 2020 626c 6f63   / QK;..    bloc
+000037b0: 6b5f 7134 5f30 202a 2072 6573 7472 6963  k_q4_0 * restric
+000037c0: 7420 7920 3d20 7679 3b0a 0a23 6966 2064  t y = vy;..#if d
+000037d0: 6566 696e 6564 285f 5f50 4f57 4552 395f  efined(__POWER9_
+000037e0: 5645 4354 4f52 5f5f 290a 2020 2020 636f  VECTOR__).    co
+000037f0: 6e73 7420 7665 6374 6f72 2066 6c6f 6174  nst vector float
+00003800: 2076 3835 203d 2076 6563 5f73 706c 6174   v85 = vec_splat
+00003810: 7328 382e 3566 293b 0a20 2020 2066 6f72  s(8.5f);.    for
+00003820: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00003830: 206e 623b 2069 2b2b 2920 7b0a 2020 2020   nb; i++) {.    
+00003840: 2020 2020 666c 6f61 7420 616d 6178 203d      float amax =
+00003850: 2030 2e30 663b 202f 2f20 6162 736f 6c75   0.0f; // absolu
+00003860: 7465 206d 6178 0a0a 2020 2020 2020 2020  te max..        
+00003870: 7665 6374 6f72 2066 6c6f 6174 2073 7263  vector float src
+00003880: 7620 5b38 5d3b 0a20 2020 2020 2020 2076  v [8];.        v
+00003890: 6563 746f 7220 666c 6f61 7420 6173 7263  ector float asrc
+000038a0: 765b 385d 3b0a 2020 2020 2020 2020 7665  v[8];.        ve
+000038b0: 6374 6f72 2066 6c6f 6174 2061 6d61 7876  ctor float amaxv
+000038c0: 5b38 5d3b 0a0a 2020 2020 2020 2020 666f  [8];..        fo
+000038d0: 7220 2869 6e74 206c 203d 2030 3b20 6c20  r (int l = 0; l 
+000038e0: 3c20 383b 206c 2b2b 2920 7372 6376 5b6c  < 8; l++) srcv[l
+000038f0: 5d20 203d 202a 2876 6563 746f 7220 666c  ]  = *(vector fl
+00003900: 6f61 7420 2a29 2878 202b 2069 2a33 3220  oat *)(x + i*32 
+00003910: 2b20 342a 6c29 3b0a 2020 2020 2020 2020  + 4*l);.        
+00003920: 666f 7220 2869 6e74 206c 203d 2030 3b20  for (int l = 0; 
+00003930: 6c20 3c20 383b 206c 2b2b 2920 6173 7263  l < 8; l++) asrc
+00003940: 765b 6c5d 203d 2076 6563 5f61 6273 2873  v[l] = vec_abs(s
+00003950: 7263 765b 6c5d 293b 0a0a 2020 2020 2020  rcv[l]);..      
+00003960: 2020 666f 7220 2869 6e74 206c 203d 2030    for (int l = 0
+00003970: 3b20 6c20 3c20 343b 206c 2b2b 2920 616d  ; l < 4; l++) am
+00003980: 6178 765b 322a 6c5d 203d 2076 6563 5f6d  axv[2*l] = vec_m
+00003990: 6178 2861 7372 6376 5b32 2a6c 5d2c 2061  ax(asrcv[2*l], a
+000039a0: 7372 6376 5b32 2a6c 2b31 5d29 3b0a 2020  srcv[2*l+1]);.  
+000039b0: 2020 2020 2020 2f2f 666f 7220 2869 6e74        //for (int
+000039c0: 206c 203d 2030 3b20 6c20 3c20 323b 206c   l = 0; l < 2; l
+000039d0: 2b2b 2920 616d 6178 765b 342a 6c5d 203d  ++) amaxv[4*l] =
+000039e0: 2076 6563 5f6d 6178 2861 6d61 7876 5b34   vec_max(amaxv[4
+000039f0: 2a6c 5d2c 2061 6d61 7876 5b34 2a6c 2b32  *l], amaxv[4*l+2
+00003a00: 5d29 3b0a 2020 2020 2020 2020 616d 6178  ]);.        amax
+00003a10: 765b 305d 203d 2076 6563 5f6d 6178 2861  v[0] = vec_max(a
+00003a20: 6d61 7876 5b30 5d2c 2061 6d61 7876 5b32  maxv[0], amaxv[2
+00003a30: 5d29 3b0a 2020 2020 2020 2020 616d 6178  ]);.        amax
+00003a40: 765b 345d 203d 2076 6563 5f6d 6178 2861  v[4] = vec_max(a
+00003a50: 6d61 7876 5b34 5d2c 2061 6d61 7876 5b36  maxv[4], amaxv[6
+00003a60: 5d29 3b0a 2020 2020 2020 2020 2f2f 666f  ]);.        //fo
+00003a70: 7220 2869 6e74 206c 203d 2030 3b20 6c20  r (int l = 0; l 
+00003a80: 3c20 313b 206c 2b2b 2920 616d 6178 765b  < 1; l++) amaxv[
+00003a90: 382a 6c5d 203d 2076 6563 5f6d 6178 2861  8*l] = vec_max(a
+00003aa0: 6d61 7876 5b38 2a6c 5d2c 2061 6d61 7876  maxv[8*l], amaxv
+00003ab0: 5b38 2a6c 2b34 5d29 3b0a 2020 2020 2020  [8*l+4]);.      
+00003ac0: 2020 616d 6178 765b 305d 203d 2076 6563    amaxv[0] = vec
+00003ad0: 5f6d 6178 2861 6d61 7876 5b30 5d2c 2061  _max(amaxv[0], a
+00003ae0: 6d61 7876 5b34 5d29 3b0a 0a20 2020 2020  maxv[4]);..     
+00003af0: 2020 2061 6d61 7820 3d20 4d41 5828 0a20     amax = MAX(. 
+00003b00: 2020 2020 2020 2020 2020 2020 2020 204d                 M
+00003b10: 4158 2876 6563 5f65 7874 7261 6374 2861  AX(vec_extract(a
+00003b20: 6d61 7876 5b30 5d2c 2030 292c 2076 6563  maxv[0], 0), vec
+00003b30: 5f65 7874 7261 6374 2861 6d61 7876 5b30  _extract(amaxv[0
+00003b40: 5d2c 2031 2929 2c0a 2020 2020 2020 2020  ], 1)),.        
+00003b50: 2020 2020 2020 2020 4d41 5828 7665 635f          MAX(vec_
+00003b60: 6578 7472 6163 7428 616d 6178 765b 305d  extract(amaxv[0]
+00003b70: 2c20 3229 2c20 7665 635f 6578 7472 6163  , 2), vec_extrac
+00003b80: 7428 616d 6178 765b 305d 2c20 3329 2929  t(amaxv[0], 3)))
+00003b90: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
+00003ba0: 2066 6c6f 6174 2064 203d 2061 6d61 7820   float d = amax 
+00003bb0: 2f20 2828 3120 3c3c 2033 2920 2d20 3129  / ((1 << 3) - 1)
+00003bc0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+00003bd0: 666c 6f61 7420 6964 203d 2064 203f 2031  float id = d ? 1
+00003be0: 2e30 2f64 203a 2030 2e30 3b0a 0a20 2020  .0/d : 0.0;..   
+00003bf0: 2020 2020 2079 5b69 5d2e 6420 3d20 643b       y[i].d = d;
+00003c00: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+00003c10: 7665 6374 6f72 2066 6c6f 6174 2076 6964  vector float vid
+00003c20: 203d 2076 6563 5f73 706c 6174 7328 6964   = vec_splats(id
+00003c30: 293b 0a20 2020 2020 2020 2075 696e 7438  );.        uint8
+00003c40: 5f74 202a 2072 6573 7472 6963 7420 7062  _t * restrict pb
+00003c50: 203d 2079 5b69 5d2e 7173 3b0a 2020 2020   = y[i].qs;.    
+00003c60: 2020 2020 666f 7220 2869 6e74 206c 203d      for (int l =
+00003c70: 2030 3b20 6c20 3c20 383b 206c 2b2b 2920   0; l < 8; l++) 
+00003c80: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
+00003c90: 6e73 7420 7665 6374 6f72 2066 6c6f 6174  nst vector float
+00003ca0: 2076 6620 203d 2076 6563 5f6d 6164 6428   vf  = vec_madd(
+00003cb0: 7372 6376 5b6c 5d2c 2076 6964 2c20 7638  srcv[l], vid, v8
+00003cc0: 3529 3b0a 2020 2020 2020 2020 2020 2020  5);.            
+00003cd0: 636f 6e73 7420 7665 6374 6f72 2073 6967  const vector sig
+00003ce0: 6e65 6420 696e 7420 7669 203d 2076 6563  ned int vi = vec
+00003cf0: 5f73 6967 6e65 6428 7666 293b 0a0a 2020  _signed(vf);..  
+00003d00: 2020 2020 2020 2020 2020 7062 5b32 2a6c            pb[2*l
+00003d10: 202b 2030 5d20 3d20 7665 635f 6578 7472   + 0] = vec_extr
+00003d20: 6163 7428 7669 2c20 3029 207c 2028 7665  act(vi, 0) | (ve
+00003d30: 635f 6578 7472 6163 7428 7669 2c20 3129  c_extract(vi, 1)
+00003d40: 203c 3c20 3429 3b0a 2020 2020 2020 2020   << 4);.        
+00003d50: 2020 2020 7062 5b32 2a6c 202b 2031 5d20      pb[2*l + 1] 
+00003d60: 3d20 7665 635f 6578 7472 6163 7428 7669  = vec_extract(vi
+00003d70: 2c20 3229 207c 2028 7665 635f 6578 7472  , 2) | (vec_extr
+00003d80: 6163 7428 7669 2c20 3329 203c 3c20 3429  act(vi, 3) << 4)
+00003d90: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00003da0: 7d0a 2365 6c69 6620 5f5f 4152 4d5f 4e45  }.#elif __ARM_NE
+00003db0: 4f4e 0a20 2020 2075 696e 7438 5f74 2070  ON.    uint8_t p
+00003dc0: 705b 514b 2f32 5d3b 0a20 2020 2066 6f72  p[QK/2];.    for
+00003dd0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00003de0: 206e 623b 2069 2b2b 2920 7b0a 2020 2020   nb; i++) {.    
+00003df0: 2020 2020 666c 6f61 7420 616d 6178 203d      float amax =
+00003e00: 2030 2e30 663b 202f 2f20 6162 736f 6c75   0.0f; // absolu
+00003e10: 7465 206d 6178 0a0a 2020 2020 2020 2020  te max..        
+00003e20: 666c 6f61 7433 3278 345f 7420 7372 6376  float32x4_t srcv
+00003e30: 205b 385d 3b0a 2020 2020 2020 2020 666c   [8];.        fl
+00003e40: 6f61 7433 3278 345f 7420 6173 7263 765b  oat32x4_t asrcv[
+00003e50: 385d 3b0a 2020 2020 2020 2020 666c 6f61  8];.        floa
+00003e60: 7433 3278 345f 7420 616d 6178 765b 385d  t32x4_t amaxv[8]
+00003e70: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
+00003e80: 696e 7420 6c20 3d20 303b 206c 203c 2038  int l = 0; l < 8
+00003e90: 3b20 6c2b 2b29 2073 7263 765b 6c5d 2020  ; l++) srcv[l]  
+00003ea0: 3d20 766c 6431 715f 6633 3228 7820 2b20  = vld1q_f32(x + 
+00003eb0: 692a 3332 202b 2034 2a6c 293b 0a20 2020  i*32 + 4*l);.   
+00003ec0: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
+00003ed0: 3d20 303b 206c 203c 2038 3b20 6c2b 2b29  = 0; l < 8; l++)
+00003ee0: 2061 7372 6376 5b6c 5d20 3d20 7661 6273   asrcv[l] = vabs
+00003ef0: 715f 6633 3228 7372 6376 5b6c 5d29 3b0a  q_f32(srcv[l]);.
+00003f00: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00003f10: 7420 6c20 3d20 303b 206c 203c 2034 3b20  t l = 0; l < 4; 
+00003f20: 6c2b 2b29 2061 6d61 7876 5b32 2a6c 5d20  l++) amaxv[2*l] 
+00003f30: 3d20 766d 6178 715f 6633 3228 6173 7263  = vmaxq_f32(asrc
+00003f40: 765b 322a 6c5d 2c20 6173 7263 765b 322a  v[2*l], asrcv[2*
+00003f50: 6c2b 315d 293b 0a20 2020 2020 2020 2066  l+1]);.        f
+00003f60: 6f72 2028 696e 7420 6c20 3d20 303b 206c  or (int l = 0; l
+00003f70: 203c 2032 3b20 6c2b 2b29 2061 6d61 7876   < 2; l++) amaxv
+00003f80: 5b34 2a6c 5d20 3d20 766d 6178 715f 6633  [4*l] = vmaxq_f3
+00003f90: 3228 616d 6178 765b 342a 6c5d 2c20 616d  2(amaxv[4*l], am
+00003fa0: 6178 765b 342a 6c2b 325d 293b 0a20 2020  axv[4*l+2]);.   
+00003fb0: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
+00003fc0: 3d20 303b 206c 203c 2031 3b20 6c2b 2b29  = 0; l < 1; l++)
+00003fd0: 2061 6d61 7876 5b38 2a6c 5d20 3d20 766d   amaxv[8*l] = vm
+00003fe0: 6178 715f 6633 3228 616d 6178 765b 382a  axq_f32(amaxv[8*
+00003ff0: 6c5d 2c20 616d 6178 765b 382a 6c2b 345d  l], amaxv[8*l+4]
+00004000: 293b 0a0a 2020 2020 2020 2020 616d 6178  );..        amax
+00004010: 203d 204d 4158 280a 2020 2020 2020 2020   = MAX(.        
+00004020: 2020 2020 2020 2020 4d41 5828 7667 6574          MAX(vget
+00004030: 715f 6c61 6e65 5f66 3332 2861 6d61 7876  q_lane_f32(amaxv
+00004040: 5b30 5d2c 2030 292c 2076 6765 7471 5f6c  [0], 0), vgetq_l
+00004050: 616e 655f 6633 3228 616d 6178 765b 305d  ane_f32(amaxv[0]
+00004060: 2c20 3129 292c 0a20 2020 2020 2020 2020  , 1)),.         
+00004070: 2020 2020 2020 204d 4158 2876 6765 7471         MAX(vgetq
+00004080: 5f6c 616e 655f 6633 3228 616d 6178 765b  _lane_f32(amaxv[
+00004090: 305d 2c20 3229 2c20 7667 6574 715f 6c61  0], 2), vgetq_la
+000040a0: 6e65 5f66 3332 2861 6d61 7876 5b30 5d2c  ne_f32(amaxv[0],
+000040b0: 2033 2929 293b 0a0a 2020 2020 2020 2020   3)));..        
+000040c0: 636f 6e73 7420 666c 6f61 7420 6420 3d20  const float d = 
+000040d0: 616d 6178 202f 2028 2831 203c 3c20 3329  amax / ((1 << 3)
+000040e0: 202d 2031 293b 0a20 2020 2020 2020 2063   - 1);.        c
+000040f0: 6f6e 7374 2066 6c6f 6174 2069 6420 3d20  onst float id = 
+00004100: 6420 3f20 312e 3066 2f64 203a 2030 2e30  d ? 1.0f/d : 0.0
+00004110: 663b 0a0a 2020 2020 2020 2020 795b 695d  f;..        y[i]
+00004120: 2e64 203d 2064 3b0a 0a20 2020 2020 2020  .d = d;..       
+00004130: 2066 6f72 2028 696e 7420 6c20 3d20 303b   for (int l = 0;
+00004140: 206c 203c 2038 3b20 6c2b 2b29 207b 0a20   l < 8; l++) {. 
+00004150: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00004160: 2066 6c6f 6174 3332 7834 5f74 2076 2020   float32x4_t v  
+00004170: 3d20 766d 756c 715f 6e5f 6633 3228 7372  = vmulq_n_f32(sr
+00004180: 6376 5b6c 5d2c 2069 6429 3b0a 2020 2020  cv[l], id);.    
+00004190: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+000041a0: 6f61 7433 3278 345f 7420 7666 203d 2076  oat32x4_t vf = v
+000041b0: 6164 6471 5f66 3332 2876 2c20 7664 7570  addq_f32(v, vdup
+000041c0: 715f 6e5f 6633 3228 382e 3566 2929 3b0a  q_n_f32(8.5f));.
+000041d0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000041e0: 7420 696e 7433 3278 345f 7420 2020 7669  t int32x4_t   vi
+000041f0: 203d 2076 6376 7471 5f73 3332 5f66 3332   = vcvtq_s32_f32
+00004200: 2876 6629 3b0a 0a20 2020 2020 2020 2020  (vf);..         
+00004210: 2020 2070 705b 322a 6c20 2b20 305d 203d     pp[2*l + 0] =
+00004220: 2076 6765 7471 5f6c 616e 655f 7333 3228   vgetq_lane_s32(
+00004230: 7669 2c20 3029 207c 2028 7667 6574 715f  vi, 0) | (vgetq_
+00004240: 6c61 6e65 5f73 3332 2876 692c 2031 2920  lane_s32(vi, 1) 
+00004250: 3c3c 2034 293b 0a20 2020 2020 2020 2020  << 4);.         
+00004260: 2020 2070 705b 322a 6c20 2b20 315d 203d     pp[2*l + 1] =
+00004270: 2076 6765 7471 5f6c 616e 655f 7333 3228   vgetq_lane_s32(
+00004280: 7669 2c20 3229 207c 2028 7667 6574 715f  vi, 2) | (vgetq_
+00004290: 6c61 6e65 5f73 3332 2876 692c 2033 2920  lane_s32(vi, 3) 
+000042a0: 3c3c 2034 293b 0a20 2020 2020 2020 207d  << 4);.        }
+000042b0: 0a0a 2020 2020 2020 2020 6d65 6d63 7079  ..        memcpy
+000042c0: 2879 5b69 5d2e 7173 2c20 7070 2c20 7369  (y[i].qs, pp, si
+000042d0: 7a65 6f66 2870 7029 293b 0a20 2020 207d  zeof(pp));.    }
+000042e0: 0a23 656c 6966 2064 6566 696e 6564 285f  .#elif defined(_
+000042f0: 5f41 5658 325f 5f29 0a20 2020 2066 6f72  _AVX2__).    for
+00004300: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00004310: 206e 623b 2069 2b2b 2920 7b0a 2020 2020   nb; i++) {.    
+00004320: 2020 2020 2f2f 204c 6f61 6420 656c 656d      // Load elem
+00004330: 656e 7473 2069 6e74 6f20 3420 4156 5820  ents into 4 AVX 
+00004340: 7665 6374 6f72 730a 2020 2020 2020 2020  vectors.        
+00004350: 5f5f 6d32 3536 2076 3020 3d20 5f6d 6d32  __m256 v0 = _mm2
+00004360: 3536 5f6c 6f61 6475 5f70 7328 2078 2029  56_loadu_ps( x )
+00004370: 3b0a 2020 2020 2020 2020 5f5f 6d32 3536  ;.        __m256
+00004380: 2076 3120 3d20 5f6d 6d32 3536 5f6c 6f61   v1 = _mm256_loa
+00004390: 6475 5f70 7328 2078 202b 2038 2029 3b0a  du_ps( x + 8 );.
+000043a0: 2020 2020 2020 2020 5f5f 6d32 3536 2076          __m256 v
+000043b0: 3220 3d20 5f6d 6d32 3536 5f6c 6f61 6475  2 = _mm256_loadu
+000043c0: 5f70 7328 2078 202b 2031 3620 293b 0a20  _ps( x + 16 );. 
+000043d0: 2020 2020 2020 205f 5f6d 3235 3620 7633         __m256 v3
+000043e0: 203d 205f 6d6d 3235 365f 6c6f 6164 755f   = _mm256_loadu_
+000043f0: 7073 2820 7820 2b20 3234 2029 3b0a 2020  ps( x + 24 );.  
+00004400: 2020 2020 2020 7820 2b3d 2033 323b 0a0a        x += 32;..
+00004410: 2020 2020 2020 2020 2f2f 2043 6f6d 7075          // Compu
+00004420: 7465 206d 6178 2861 6273 2865 2929 2066  te max(abs(e)) f
+00004430: 6f72 2074 6865 2062 6c6f 636b 0a20 2020  or the block.   
+00004440: 2020 2020 2063 6f6e 7374 205f 5f6d 3235       const __m25
+00004450: 3620 7369 676e 4269 7420 3d20 5f6d 6d32  6 signBit = _mm2
+00004460: 3536 5f73 6574 315f 7073 2820 2d30 2e30  56_set1_ps( -0.0
+00004470: 6620 293b 0a20 2020 2020 2020 205f 5f6d  f );.        __m
+00004480: 3235 3620 6d61 7841 6273 203d 205f 6d6d  256 maxAbs = _mm
+00004490: 3235 365f 616e 646e 6f74 5f70 7328 2073  256_andnot_ps( s
+000044a0: 6967 6e42 6974 2c20 7630 2029 3b0a 2020  ignBit, v0 );.  
+000044b0: 2020 2020 2020 6d61 7841 6273 203d 205f        maxAbs = _
+000044c0: 6d6d 3235 365f 6d61 785f 7073 2820 6d61  mm256_max_ps( ma
+000044d0: 7841 6273 2c20 5f6d 6d32 3536 5f61 6e64  xAbs, _mm256_and
+000044e0: 6e6f 745f 7073 2820 7369 676e 4269 742c  not_ps( signBit,
+000044f0: 2076 3120 2920 293b 0a20 2020 2020 2020   v1 ) );.       
+00004500: 206d 6178 4162 7320 3d20 5f6d 6d32 3536   maxAbs = _mm256
+00004510: 5f6d 6178 5f70 7328 206d 6178 4162 732c  _max_ps( maxAbs,
+00004520: 205f 6d6d 3235 365f 616e 646e 6f74 5f70   _mm256_andnot_p
+00004530: 7328 2073 6967 6e42 6974 2c20 7632 2029  s( signBit, v2 )
+00004540: 2029 3b0a 2020 2020 2020 2020 6d61 7841   );.        maxA
+00004550: 6273 203d 205f 6d6d 3235 365f 6d61 785f  bs = _mm256_max_
+00004560: 7073 2820 6d61 7841 6273 2c20 5f6d 6d32  ps( maxAbs, _mm2
+00004570: 3536 5f61 6e64 6e6f 745f 7073 2820 7369  56_andnot_ps( si
+00004580: 676e 4269 742c 2076 3320 2920 293b 0a0a  gnBit, v3 ) );..
+00004590: 2020 2020 2020 2020 5f5f 6d31 3238 206d          __m128 m
+000045a0: 6178 3420 3d20 5f6d 6d5f 6d61 785f 7073  ax4 = _mm_max_ps
+000045b0: 2820 5f6d 6d32 3536 5f65 7874 7261 6374  ( _mm256_extract
+000045c0: 6631 3238 5f70 7328 206d 6178 4162 732c  f128_ps( maxAbs,
+000045d0: 2031 2029 2c20 5f6d 6d32 3536 5f63 6173   1 ), _mm256_cas
+000045e0: 7470 7332 3536 5f70 7331 3238 2820 6d61  tps256_ps128( ma
+000045f0: 7841 6273 2029 2029 3b0a 2020 2020 2020  xAbs ) );.      
+00004600: 2020 6d61 7834 203d 205f 6d6d 5f6d 6178    max4 = _mm_max
+00004610: 5f70 7328 206d 6178 342c 205f 6d6d 5f6d  _ps( max4, _mm_m
+00004620: 6f76 6568 6c5f 7073 2820 6d61 7834 2c20  ovehl_ps( max4, 
+00004630: 6d61 7834 2029 2029 3b0a 2020 2020 2020  max4 ) );.      
+00004640: 2020 6d61 7834 203d 205f 6d6d 5f6d 6178    max4 = _mm_max
+00004650: 5f73 7328 206d 6178 342c 205f 6d6d 5f6d  _ss( max4, _mm_m
+00004660: 6f76 6568 6475 705f 7073 2820 6d61 7834  ovehdup_ps( max4
+00004670: 2029 2029 3b0a 2020 2020 2020 2020 636f   ) );.        co
+00004680: 6e73 7420 666c 6f61 7420 6d61 7853 6361  nst float maxSca
+00004690: 6c61 7220 3d20 5f6d 6d5f 6376 7473 735f  lar = _mm_cvtss_
+000046a0: 6633 3228 206d 6178 3420 293b 0a0a 2020  f32( max4 );..  
+000046b0: 2020 2020 2020 2f2f 2051 7561 6e74 697a        // Quantiz
+000046c0: 6520 7468 6573 6520 666c 6f61 7473 0a20  e these floats. 
+000046d0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+000046e0: 6174 2064 203d 206d 6178 5363 616c 6172  at d = maxScalar
+000046f0: 202f 2037 2e30 663b 0a20 2020 2020 2020   / 7.0f;.       
+00004700: 2079 5b69 5d2e 6420 3d20 643b 0a20 2020   y[i].d = d;.   
+00004710: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00004720: 2069 6420 3d20 2820 6d61 7853 6361 6c61   id = ( maxScala
+00004730: 7220 213d 2030 2e30 6620 2920 3f20 372e  r != 0.0f ) ? 7.
+00004740: 3066 202f 206d 6178 5363 616c 6172 203a  0f / maxScalar :
+00004750: 2030 2e30 663b 0a20 2020 2020 2020 2063   0.0f;.        c
+00004760: 6f6e 7374 205f 5f6d 3235 3620 6d75 6c20  onst __m256 mul 
+00004770: 3d20 5f6d 6d32 3536 5f73 6574 315f 7073  = _mm256_set1_ps
+00004780: 2820 6964 2029 3b0a 0a20 2020 2020 2020  ( id );..       
+00004790: 202f 2f20 4170 706c 7920 7468 6520 6d75   // Apply the mu
+000047a0: 6c74 6970 6c69 6572 0a20 2020 2020 2020  ltiplier.       
+000047b0: 2076 3020 3d20 5f6d 6d32 3536 5f6d 756c   v0 = _mm256_mul
+000047c0: 5f70 7328 2076 302c 206d 756c 2029 3b0a  _ps( v0, mul );.
+000047d0: 2020 2020 2020 2020 7631 203d 205f 6d6d          v1 = _mm
+000047e0: 3235 365f 6d75 6c5f 7073 2820 7631 2c20  256_mul_ps( v1, 
+000047f0: 6d75 6c20 293b 0a20 2020 2020 2020 2076  mul );.        v
+00004800: 3220 3d20 5f6d 6d32 3536 5f6d 756c 5f70  2 = _mm256_mul_p
+00004810: 7328 2076 322c 206d 756c 2029 3b0a 2020  s( v2, mul );.  
+00004820: 2020 2020 2020 7633 203d 205f 6d6d 3235        v3 = _mm25
+00004830: 365f 6d75 6c5f 7073 2820 7633 2c20 6d75  6_mul_ps( v3, mu
+00004840: 6c20 293b 0a0a 2020 2020 2020 2020 2f2f  l );..        //
+00004850: 2052 6f75 6e64 2074 6f20 6e65 6172 6573   Round to neares
+00004860: 7420 696e 7465 6765 720a 2020 2020 2020  t integer.      
+00004870: 2020 7630 203d 205f 6d6d 3235 365f 726f    v0 = _mm256_ro
+00004880: 756e 645f 7073 2820 7630 2c20 5f4d 4d5f  und_ps( v0, _MM_
+00004890: 524f 554e 445f 4e45 4152 4553 5420 293b  ROUND_NEAREST );
+000048a0: 0a20 2020 2020 2020 2076 3120 3d20 5f6d  .        v1 = _m
+000048b0: 6d32 3536 5f72 6f75 6e64 5f70 7328 2076  m256_round_ps( v
+000048c0: 312c 205f 4d4d 5f52 4f55 4e44 5f4e 4541  1, _MM_ROUND_NEA
+000048d0: 5245 5354 2029 3b0a 2020 2020 2020 2020  REST );.        
+000048e0: 7632 203d 205f 6d6d 3235 365f 726f 756e  v2 = _mm256_roun
+000048f0: 645f 7073 2820 7632 2c20 5f4d 4d5f 524f  d_ps( v2, _MM_RO
+00004900: 554e 445f 4e45 4152 4553 5420 293b 0a20  UND_NEAREST );. 
+00004910: 2020 2020 2020 2076 3320 3d20 5f6d 6d32         v3 = _mm2
+00004920: 3536 5f72 6f75 6e64 5f70 7328 2076 332c  56_round_ps( v3,
+00004930: 205f 4d4d 5f52 4f55 4e44 5f4e 4541 5245   _MM_ROUND_NEARE
+00004940: 5354 2029 3b0a 0a20 2020 2020 2020 202f  ST );..        /
+00004950: 2f20 436f 6e76 6572 7420 666c 6f61 7473  / Convert floats
+00004960: 2074 6f20 696e 7465 6765 7273 0a20 2020   to integers.   
+00004970: 2020 2020 205f 5f6d 3235 3669 2069 3020       __m256i i0 
+00004980: 3d20 5f6d 6d32 3536 5f63 7674 7073 5f65  = _mm256_cvtps_e
+00004990: 7069 3332 2820 7630 2029 3b0a 2020 2020  pi32( v0 );.    
+000049a0: 2020 2020 5f5f 6d32 3536 6920 6931 203d      __m256i i1 =
+000049b0: 205f 6d6d 3235 365f 6376 7470 735f 6570   _mm256_cvtps_ep
+000049c0: 6933 3228 2076 3120 293b 0a20 2020 2020  i32( v1 );.     
+000049d0: 2020 205f 5f6d 3235 3669 2069 3220 3d20     __m256i i2 = 
+000049e0: 5f6d 6d32 3536 5f63 7674 7073 5f65 7069  _mm256_cvtps_epi
+000049f0: 3332 2820 7632 2029 3b0a 2020 2020 2020  32( v2 );.      
+00004a00: 2020 5f5f 6d32 3536 6920 6933 203d 205f    __m256i i3 = _
+00004a10: 6d6d 3235 365f 6376 7470 735f 6570 6933  mm256_cvtps_epi3
+00004a20: 3228 2076 3320 293b 0a0a 2020 2020 2020  2( v3 );..      
+00004a30: 2020 2f2f 2043 6f6e 7665 7274 2069 6e74    // Convert int
+00004a40: 3332 2074 6f20 696e 7431 360a 2020 2020  32 to int16.    
+00004a50: 2020 2020 6930 203d 205f 6d6d 3235 365f      i0 = _mm256_
+00004a60: 7061 636b 735f 6570 6933 3228 2069 302c  packs_epi32( i0,
+00004a70: 2069 3120 293b 092f 2f20 302c 2031 2c20   i1 );.// 0, 1, 
+00004a80: 322c 2033 2c20 2038 2c20 392c 2031 302c  2, 3,  8, 9, 10,
+00004a90: 2031 312c 2020 342c 2035 2c20 362c 2037   11,  4, 5, 6, 7
+00004aa0: 2c20 3132 2c20 3133 2c20 3134 2c20 3135  , 12, 13, 14, 15
+00004ab0: 0a20 2020 2020 2020 2069 3220 3d20 5f6d  .        i2 = _m
+00004ac0: 6d32 3536 5f70 6163 6b73 5f65 7069 3332  m256_packs_epi32
+00004ad0: 2820 6932 2c20 6933 2029 3b09 2f2f 2031  ( i2, i3 );.// 1
+00004ae0: 362c 2031 372c 2031 382c 2031 392c 2020  6, 17, 18, 19,  
+00004af0: 3234 2c20 3235 2c20 3236 2c20 3237 2c20  24, 25, 26, 27, 
+00004b00: 2032 302c 2032 312c 2032 322c 2032 332c   20, 21, 22, 23,
+00004b10: 2032 382c 2032 392c 2033 302c 2033 310a   28, 29, 30, 31.
+00004b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b40: 2020 2020 2020 2020 2020 2020 2f2f 2043              // C
+00004b50: 6f6e 7665 7274 2069 6e74 3136 2074 6f20  onvert int16 to 
+00004b60: 696e 7438 0a20 2020 2020 2020 2069 3020  int8.        i0 
+00004b70: 3d20 5f6d 6d32 3536 5f70 6163 6b73 5f65  = _mm256_packs_e
+00004b80: 7069 3136 2820 6930 2c20 6932 2029 3b09  pi16( i0, i2 );.
+00004b90: 2f2f 2030 2c20 312c 2032 2c20 332c 2020  // 0, 1, 2, 3,  
+00004ba0: 382c 2039 2c20 3130 2c20 3131 2c20 2031  8, 9, 10, 11,  1
+00004bb0: 362c 2031 372c 2031 382c 2031 392c 2020  6, 17, 18, 19,  
+00004bc0: 3234 2c20 3235 2c20 3236 2c20 3237 2c20  24, 25, 26, 27, 
+00004bd0: 2034 2c20 352c 2036 2c20 372c 2031 322c   4, 5, 6, 7, 12,
+00004be0: 2031 332c 2031 342c 2031 352c 2032 302c   13, 14, 15, 20,
+00004bf0: 2032 312c 2032 322c 2032 332c 2032 382c   21, 22, 23, 28,
+00004c00: 2032 392c 2033 302c 2033 310a 0a20 2020   29, 30, 31..   
+00004c10: 2020 2020 202f 2f20 5765 2067 6f74 206f       // We got o
+00004c20: 7572 2070 7265 6369 6f75 7320 7369 676e  ur precious sign
+00004c30: 6564 2062 7974 6573 2c20 6275 7420 7468  ed bytes, but th
+00004c40: 6520 6f72 6465 7220 6973 206e 6f77 2077  e order is now w
+00004c50: 726f 6e67 0a20 2020 2020 2020 202f 2f20  rong.        // 
+00004c60: 5468 6573 6520 4156 5832 2070 6163 6b20  These AVX2 pack 
+00004c70: 696e 7374 7275 6374 696f 6e73 2070 726f  instructions pro
+00004c80: 6365 7373 2031 362d 6279 7465 2070 6965  cess 16-byte pie
+00004c90: 6365 7320 696e 6465 7065 6e64 656e 746c  ces independentl
+00004ca0: 790a 2020 2020 2020 2020 2f2f 2054 6865  y.        // The
+00004cb0: 2066 6f6c 6c6f 7769 6e67 2069 6e73 7472   following instr
+00004cc0: 7563 7469 6f6e 2069 7320 6669 7869 6e67  uction is fixing
+00004cd0: 2074 6865 206f 7264 6572 0a20 2020 2020   the order.     
+00004ce0: 2020 2063 6f6e 7374 205f 5f6d 3235 3669     const __m256i
+00004cf0: 2070 6572 6d20 3d20 5f6d 6d32 3536 5f73   perm = _mm256_s
+00004d00: 6574 725f 6570 6933 3228 2030 2c20 342c  etr_epi32( 0, 4,
+00004d10: 2031 2c20 352c 2032 2c20 362c 2033 2c20   1, 5, 2, 6, 3, 
+00004d20: 3720 293b 0a20 2020 2020 2020 2069 3020  7 );.        i0 
+00004d30: 3d20 5f6d 6d32 3536 5f70 6572 6d75 7465  = _mm256_permute
+00004d40: 7661 7238 7833 325f 6570 6933 3228 2069  var8x32_epi32( i
+00004d50: 302c 2070 6572 6d20 293b 0a0a 2020 2020  0, perm );..    
+00004d60: 2020 2020 2f2f 2041 7070 6c79 206f 6666      // Apply off
+00004d70: 7365 7420 746f 2074 7261 6e73 6c61 7465  set to translate
+00004d80: 2074 6865 2072 616e 6765 2066 726f 6d20   the range from 
+00004d90: 5b20 2d37 202e 2e20 2b37 205d 2069 6e74  [ -7 .. +7 ] int
+00004da0: 6f20 5b20 2b31 202e 2e20 2b31 3520 5d0a  o [ +1 .. +15 ].
+00004db0: 2020 2020 2020 2020 636f 6e73 7420 5f5f          const __
+00004dc0: 6d32 3536 6920 6f66 6620 3d20 5f6d 6d32  m256i off = _mm2
+00004dd0: 3536 5f73 6574 315f 6570 6938 2820 3820  56_set1_epi8( 8 
+00004de0: 293b 0a20 2020 2020 2020 2069 3020 3d20  );.        i0 = 
+00004df0: 5f6d 6d32 3536 5f61 6464 5f65 7069 3828  _mm256_add_epi8(
+00004e00: 2069 302c 206f 6666 2029 3b0a 0a20 2020   i0, off );..   
+00004e10: 2020 2020 202f 2f20 436f 6d70 7265 7373       // Compress
+00004e20: 2074 6865 2076 6563 746f 7220 696e 746f   the vector into
+00004e30: 2034 2062 6974 2f76 616c 7565 2c20 616e   4 bit/value, an
+00004e40: 6420 7374 6f72 650a 2020 2020 2020 2020  d store.        
+00004e50: 5f5f 6d31 3238 6920 7265 7320 3d20 7061  __m128i res = pa
+00004e60: 636b 4e69 6262 6c65 7328 2069 3020 293b  ckNibbles( i0 );
+00004e70: 0a20 2020 2020 2020 205f 6d6d 5f73 746f  .        _mm_sto
+00004e80: 7265 755f 7369 3132 3828 2028 205f 5f6d  reu_si128( ( __m
+00004e90: 3132 3869 2a20 2979 5b69 5d2e 7173 2c20  128i* )y[i].qs, 
+00004ea0: 7265 7320 293b 0a20 2020 207d 0a23 656c  res );.    }.#el
+00004eb0: 6966 2064 6566 696e 6564 285f 5f77 6173  if defined(__was
+00004ec0: 6d5f 7369 6d64 3132 385f 5f29 0a20 2020  m_simd128__).   
+00004ed0: 2075 696e 7438 5f74 2070 705b 514b 2f32   uint8_t pp[QK/2
+00004ee0: 5d3b 0a20 2020 2066 6f72 2028 696e 7420  ];.    for (int 
+00004ef0: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
+00004f00: 2b2b 2920 7b0a 2020 2020 2020 2020 666c  ++) {.        fl
+00004f10: 6f61 7420 616d 6178 203d 2030 2e30 663b  oat amax = 0.0f;
+00004f20: 202f 2f20 6162 736f 6c75 7465 206d 6178   // absolute max
+00004f30: 0a0a 2020 2020 2020 2020 7631 3238 5f74  ..        v128_t
+00004f40: 2073 7263 7620 5b38 5d3b 0a20 2020 2020   srcv [8];.     
+00004f50: 2020 2076 3132 385f 7420 6173 7263 765b     v128_t asrcv[
+00004f60: 385d 3b0a 2020 2020 2020 2020 7631 3238  8];.        v128
+00004f70: 5f74 2061 6d61 7876 5b38 5d3b 0a0a 2020  _t amaxv[8];..  
+00004f80: 2020 2020 2020 666f 7220 2869 6e74 206c        for (int l
+00004f90: 203d 2030 3b20 6c20 3c20 383b 206c 2b2b   = 0; l < 8; l++
+00004fa0: 2920 7372 6376 5b6c 5d20 203d 2077 6173  ) srcv[l]  = was
+00004fb0: 6d5f 7631 3238 5f6c 6f61 6428 7820 2b20  m_v128_load(x + 
+00004fc0: 692a 3332 202b 2034 2a6c 293b 0a20 2020  i*32 + 4*l);.   
+00004fd0: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
+00004fe0: 3d20 303b 206c 203c 2038 3b20 6c2b 2b29  = 0; l < 8; l++)
+00004ff0: 2061 7372 6376 5b6c 5d20 3d20 7761 736d   asrcv[l] = wasm
+00005000: 5f66 3332 7834 5f61 6273 2873 7263 765b  _f32x4_abs(srcv[
+00005010: 6c5d 293b 0a0a 2020 2020 2020 2020 666f  l]);..        fo
+00005020: 7220 2869 6e74 206c 203d 2030 3b20 6c20  r (int l = 0; l 
+00005030: 3c20 343b 206c 2b2b 2920 616d 6178 765b  < 4; l++) amaxv[
+00005040: 322a 6c5d 203d 2077 6173 6d5f 6633 3278  2*l] = wasm_f32x
+00005050: 345f 6d61 7828 6173 7263 765b 322a 6c5d  4_max(asrcv[2*l]
+00005060: 2c20 6173 7263 765b 322a 6c2b 315d 293b  , asrcv[2*l+1]);
+00005070: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00005080: 7420 6c20 3d20 303b 206c 203c 2032 3b20  t l = 0; l < 2; 
+00005090: 6c2b 2b29 2061 6d61 7876 5b34 2a6c 5d20  l++) amaxv[4*l] 
+000050a0: 3d20 7761 736d 5f66 3332 7834 5f6d 6178  = wasm_f32x4_max
+000050b0: 2861 6d61 7876 5b34 2a6c 5d2c 2061 6d61  (amaxv[4*l], ama
+000050c0: 7876 5b34 2a6c 2b32 5d29 3b0a 2020 2020  xv[4*l+2]);.    
+000050d0: 2020 2020 666f 7220 2869 6e74 206c 203d      for (int l =
+000050e0: 2030 3b20 6c20 3c20 313b 206c 2b2b 2920   0; l < 1; l++) 
+000050f0: 616d 6178 765b 382a 6c5d 203d 2077 6173  amaxv[8*l] = was
+00005100: 6d5f 6633 3278 345f 6d61 7828 616d 6178  m_f32x4_max(amax
+00005110: 765b 382a 6c5d 2c20 616d 6178 765b 382a  v[8*l], amaxv[8*
+00005120: 6c2b 345d 293b 0a0a 2020 2020 2020 2020  l+4]);..        
+00005130: 616d 6178 203d 204d 4158 280a 2020 2020  amax = MAX(.    
+00005140: 2020 2020 2020 2020 2020 2020 4d41 5828              MAX(
+00005150: 7761 736d 5f66 3332 7834 5f65 7874 7261  wasm_f32x4_extra
+00005160: 6374 5f6c 616e 6528 616d 6178 765b 305d  ct_lane(amaxv[0]
+00005170: 2c20 3029 2c20 7761 736d 5f66 3332 7834  , 0), wasm_f32x4
+00005180: 5f65 7874 7261 6374 5f6c 616e 6528 616d  _extract_lane(am
+00005190: 6178 765b 305d 2c20 3129 292c 0a20 2020  axv[0], 1)),.   
+000051a0: 2020 2020 2020 2020 2020 2020 204d 4158               MAX
+000051b0: 2877 6173 6d5f 6633 3278 345f 6578 7472  (wasm_f32x4_extr
+000051c0: 6163 745f 6c61 6e65 2861 6d61 7876 5b30  act_lane(amaxv[0
+000051d0: 5d2c 2032 292c 2077 6173 6d5f 6633 3278  ], 2), wasm_f32x
+000051e0: 345f 6578 7472 6163 745f 6c61 6e65 2861  4_extract_lane(a
+000051f0: 6d61 7876 5b30 5d2c 2033 2929 293b 0a0a  maxv[0], 3)));..
+00005200: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00005210: 6f61 7420 6420 3d20 616d 6178 202f 2028  oat d = amax / (
+00005220: 2831 203c 3c20 3329 202d 2031 293b 0a20  (1 << 3) - 1);. 
+00005230: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+00005240: 6174 2069 6420 3d20 6420 3f20 312e 302f  at id = d ? 1.0/
+00005250: 6420 3a20 302e 303b 0a0a 2020 2020 2020  d : 0.0;..      
+00005260: 2020 795b 695d 2e64 203d 2064 3b0a 0a20    y[i].d = d;.. 
+00005270: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00005280: 6c20 3d20 303b 206c 203c 2038 3b20 6c2b  l = 0; l < 8; l+
+00005290: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000052a0: 2063 6f6e 7374 2076 3132 385f 7420 7620   const v128_t v 
+000052b0: 203d 2077 6173 6d5f 6633 3278 345f 6d75   = wasm_f32x4_mu
+000052c0: 6c28 7372 6376 5b6c 5d2c 2077 6173 6d5f  l(srcv[l], wasm_
+000052d0: 6633 3278 345f 7370 6c61 7428 6964 2929  f32x4_splat(id))
+000052e0: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+000052f0: 6e73 7420 7631 3238 5f74 2076 6620 3d20  nst v128_t vf = 
+00005300: 7761 736d 5f66 3332 7834 5f61 6464 2876  wasm_f32x4_add(v
+00005310: 2c20 7761 736d 5f66 3332 7834 5f73 706c  , wasm_f32x4_spl
+00005320: 6174 2838 2e35 6629 293b 0a20 2020 2020  at(8.5f));.     
+00005330: 2020 2020 2020 2063 6f6e 7374 2076 3132         const v12
+00005340: 385f 7420 7669 203d 2077 6173 6d5f 6933  8_t vi = wasm_i3
+00005350: 3278 345f 7472 756e 635f 7361 745f 6633  2x4_trunc_sat_f3
+00005360: 3278 3428 7666 293b 0a0a 2020 2020 2020  2x4(vf);..      
+00005370: 2020 2020 2020 7070 5b32 2a6c 202b 2030        pp[2*l + 0
+00005380: 5d20 3d20 7761 736d 5f69 3332 7834 5f65  ] = wasm_i32x4_e
+00005390: 7874 7261 6374 5f6c 616e 6528 7669 2c20  xtract_lane(vi, 
+000053a0: 3029 207c 2028 7761 736d 5f69 3332 7834  0) | (wasm_i32x4
+000053b0: 5f65 7874 7261 6374 5f6c 616e 6528 7669  _extract_lane(vi
+000053c0: 2c20 3129 203c 3c20 3429 3b0a 2020 2020  , 1) << 4);.    
+000053d0: 2020 2020 2020 2020 7070 5b32 2a6c 202b          pp[2*l +
+000053e0: 2031 5d20 3d20 7761 736d 5f69 3332 7834   1] = wasm_i32x4
+000053f0: 5f65 7874 7261 6374 5f6c 616e 6528 7669  _extract_lane(vi
+00005400: 2c20 3229 207c 2028 7761 736d 5f69 3332  , 2) | (wasm_i32
+00005410: 7834 5f65 7874 7261 6374 5f6c 616e 6528  x4_extract_lane(
+00005420: 7669 2c20 3329 203c 3c20 3429 3b0a 2020  vi, 3) << 4);.  
+00005430: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00005440: 206d 656d 6370 7928 795b 695d 2e71 732c   memcpy(y[i].qs,
+00005450: 2070 702c 2073 697a 656f 6628 7070 2929   pp, sizeof(pp))
+00005460: 3b0a 2020 2020 7d0a 2365 6c73 650a 2020  ;.    }.#else.  
+00005470: 2020 2f2f 2073 6361 6c61 720a 2020 2020    // scalar.    
+00005480: 7175 616e 7469 7a65 5f72 6f77 5f71 345f  quantize_row_q4_
+00005490: 305f 7265 6665 7265 6e63 6528 782c 2079  0_reference(x, y
+000054a0: 2c20 6b29 3b0a 2365 6e64 6966 0a7d 0a0a  , k);.#endif.}..
+000054b0: 7374 6174 6963 2076 6f69 6420 7175 616e  static void quan
+000054c0: 7469 7a65 5f72 6f77 5f71 345f 315f 7265  tize_row_q4_1_re
+000054d0: 6665 7265 6e63 6528 636f 6e73 7420 666c  ference(const fl
+000054e0: 6f61 7420 2a20 7265 7374 7269 6374 2078  oat * restrict x
+000054f0: 2c20 766f 6964 202a 2072 6573 7472 6963  , void * restric
+00005500: 7420 7679 2c20 696e 7420 6b29 207b 0a20  t vy, int k) {. 
+00005510: 2020 2061 7373 6572 7428 6b20 2520 514b     assert(k % QK
+00005520: 203d 3d20 3029 3b0a 2020 2020 636f 6e73   == 0);.    cons
+00005530: 7420 696e 7420 6e62 203d 206b 202f 2051  t int nb = k / Q
+00005540: 4b3b 0a0a 2020 2020 626c 6f63 6b5f 7134  K;..    block_q4
+00005550: 5f31 202a 2072 6573 7472 6963 7420 7920  _1 * restrict y 
+00005560: 3d20 7679 3b0a 0a20 2020 2075 696e 7438  = vy;..    uint8
+00005570: 5f74 2070 705b 514b 2f32 5d3b 0a0a 2020  _t pp[QK/2];..  
+00005580: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00005590: 3b20 6920 3c20 6e62 3b20 692b 2b29 207b  ; i < nb; i++) {
+000055a0: 0a20 2020 2020 2020 2066 6c6f 6174 206d  .        float m
+000055b0: 696e 203d 2046 4c54 5f4d 4158 3b0a 2020  in = FLT_MAX;.  
+000055c0: 2020 2020 2020 666c 6f61 7420 6d61 7820        float max 
+000055d0: 3d20 2d46 4c54 5f4d 4158 3b0a 0a20 2020  = -FLT_MAX;..   
+000055e0: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
+000055f0: 3d20 303b 206c 203c 2051 4b3b 206c 2b2b  = 0; l < QK; l++
+00005600: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00005610: 636f 6e73 7420 666c 6f61 7420 7620 3d20  const float v = 
+00005620: 785b 692a 514b 202b 206c 5d3b 0a20 2020  x[i*QK + l];.   
+00005630: 2020 2020 2020 2020 2069 6620 2876 203c           if (v <
+00005640: 206d 696e 2920 6d69 6e20 3d20 763b 0a20   min) min = v;. 
+00005650: 2020 2020 2020 2020 2020 2069 6620 2876             if (v
+00005660: 203e 206d 6178 2920 6d61 7820 3d20 763b   > max) max = v;
+00005670: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00005680: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00005690: 6420 3d20 286d 6178 202d 206d 696e 2920  d = (max - min) 
+000056a0: 2f20 2828 3120 3c3c 2034 2920 2d20 3129  / ((1 << 4) - 1)
+000056b0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+000056c0: 666c 6f61 7420 6964 203d 2064 203f 2031  float id = d ? 1
+000056d0: 2e30 662f 6420 3a20 302e 3066 3b0a 0a20  .0f/d : 0.0f;.. 
+000056e0: 2020 2020 2020 2079 5b69 5d2e 6420 3d20         y[i].d = 
+000056f0: 643b 0a20 2020 2020 2020 2079 5b69 5d2e  d;.        y[i].
+00005700: 6d20 3d20 6d69 6e3b 0a0a 2020 2020 2020  m = min;..      
+00005710: 2020 666f 7220 2869 6e74 206c 203d 2030    for (int l = 0
+00005720: 3b20 6c20 3c20 514b 3b20 6c20 2b3d 2032  ; l < QK; l += 2
+00005730: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00005740: 636f 6e73 7420 666c 6f61 7420 7630 203d  const float v0 =
+00005750: 2028 785b 692a 514b 202b 206c 202b 2030   (x[i*QK + l + 0
+00005760: 5d20 2d20 6d69 6e29 2a69 643b 0a20 2020  ] - min)*id;.   
+00005770: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00005780: 6c6f 6174 2076 3120 3d20 2878 5b69 2a51  loat v1 = (x[i*Q
+00005790: 4b20 2b20 6c20 2b20 315d 202d 206d 696e  K + l + 1] - min
+000057a0: 292a 6964 3b0a 0a20 2020 2020 2020 2020  )*id;..         
+000057b0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
+000057c0: 2076 6930 203d 2072 6f75 6e64 6628 7630   vi0 = roundf(v0
+000057d0: 293b 0a20 2020 2020 2020 2020 2020 2063  );.            c
+000057e0: 6f6e 7374 2075 696e 7438 5f74 2076 6931  onst uint8_t vi1
+000057f0: 203d 2072 6f75 6e64 6628 7631 293b 0a0a   = roundf(v1);..
+00005800: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00005810: 7274 2876 6930 203e 3d20 3020 2626 2076  rt(vi0 >= 0 && v
+00005820: 6930 203c 2031 3629 3b0a 2020 2020 2020  i0 < 16);.      
+00005830: 2020 2020 2020 6173 7365 7274 2876 6931        assert(vi1
+00005840: 203e 3d20 3020 2626 2076 6931 203c 2031   >= 0 && vi1 < 1
+00005850: 3629 3b0a 0a20 2020 2020 2020 2020 2020  6);..           
+00005860: 2070 705b 6c2f 325d 203d 2076 6930 207c   pp[l/2] = vi0 |
+00005870: 2028 7669 3120 3c3c 2034 293b 0a20 2020   (vi1 << 4);.   
+00005880: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00005890: 6d65 6d63 7079 2879 5b69 5d2e 7173 2c20  memcpy(y[i].qs, 
+000058a0: 7070 2c20 7369 7a65 6f66 2870 7029 293b  pp, sizeof(pp));
+000058b0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+000058c0: 2076 6f69 6420 7175 616e 7469 7a65 5f72   void quantize_r
+000058d0: 6f77 5f71 345f 3128 636f 6e73 7420 666c  ow_q4_1(const fl
+000058e0: 6f61 7420 2a20 7265 7374 7269 6374 2078  oat * restrict x
+000058f0: 2c20 766f 6964 202a 2072 6573 7472 6963  , void * restric
+00005900: 7420 7679 2c20 696e 7420 6b29 207b 0a20  t vy, int k) {. 
+00005910: 2020 2061 7373 6572 7428 6b20 2520 514b     assert(k % QK
+00005920: 203d 3d20 3029 3b0a 0a23 6966 2064 6566   == 0);..#if def
+00005930: 696e 6564 285f 5f41 5658 325f 5f29 0a20  ined(__AVX2__). 
+00005940: 2020 2063 6f6e 7374 2069 6e74 206e 6220     const int nb 
+00005950: 3d20 6b20 2f20 514b 3b0a 0a20 2020 2062  = k / QK;..    b
+00005960: 6c6f 636b 5f71 345f 3120 2a20 7265 7374  lock_q4_1 * rest
+00005970: 7269 6374 2079 203d 2076 793b 0a0a 2020  rict y = vy;..  
+00005980: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00005990: 3b20 6920 3c20 6e62 3b20 692b 2b29 207b  ; i < nb; i++) {
+000059a0: 0a20 2020 2020 2020 202f 2f20 4c6f 6164  .        // Load
+000059b0: 2065 6c65 6d65 6e74 7320 696e 746f 2034   elements into 4
+000059c0: 2041 5658 2076 6563 746f 7273 0a20 2020   AVX vectors.   
+000059d0: 2020 2020 205f 5f6d 3235 3620 7630 203d       __m256 v0 =
+000059e0: 205f 6d6d 3235 365f 6c6f 6164 755f 7073   _mm256_loadu_ps
+000059f0: 2820 7820 293b 0a20 2020 2020 2020 205f  ( x );.        _
+00005a00: 5f6d 3235 3620 7631 203d 205f 6d6d 3235  _m256 v1 = _mm25
+00005a10: 365f 6c6f 6164 755f 7073 2820 7820 2b20  6_loadu_ps( x + 
+00005a20: 3820 293b 0a20 2020 2020 2020 205f 5f6d  8 );.        __m
+00005a30: 3235 3620 7632 203d 205f 6d6d 3235 365f  256 v2 = _mm256_
+00005a40: 6c6f 6164 755f 7073 2820 7820 2b20 3136  loadu_ps( x + 16
+00005a50: 2029 3b0a 2020 2020 2020 2020 5f5f 6d32   );.        __m2
+00005a60: 3536 2076 3320 3d20 5f6d 6d32 3536 5f6c  56 v3 = _mm256_l
+00005a70: 6f61 6475 5f70 7328 2078 202b 2032 3420  oadu_ps( x + 24 
+00005a80: 293b 0a20 2020 2020 2020 2078 202b 3d20  );.        x += 
+00005a90: 3332 3b0a 0a20 2020 2020 2020 202f 2f20  32;..        // 
+00005aa0: 436f 6d70 7574 6520 6d61 7820 666f 7220  Compute max for 
+00005ab0: 7468 6520 626c 6f63 6b0a 2020 2020 2020  the block.      
+00005ac0: 2020 5f5f 6d32 3536 2076 6d61 783b 0a20    __m256 vmax;. 
+00005ad0: 2020 2020 2020 2076 6d61 7820 3d20 5f6d         vmax = _m
+00005ae0: 6d32 3536 5f6d 6178 5f70 7328 2076 302c  m256_max_ps( v0,
+00005af0: 2076 3120 293b 0a20 2020 2020 2020 2076   v1 );.        v
+00005b00: 6d61 7820 3d20 5f6d 6d32 3536 5f6d 6178  max = _mm256_max
+00005b10: 5f70 7328 2076 6d61 782c 2076 3220 293b  _ps( vmax, v2 );
+00005b20: 0a20 2020 2020 2020 2076 6d61 7820 3d20  .        vmax = 
+00005b30: 5f6d 6d32 3536 5f6d 6178 5f70 7328 2076  _mm256_max_ps( v
+00005b40: 6d61 782c 2076 3320 293b 0a0a 2020 2020  max, v3 );..    
+00005b50: 2020 2020 5f5f 6d31 3238 206d 6178 3420      __m128 max4 
+00005b60: 3d20 5f6d 6d5f 6d61 785f 7073 2820 5f6d  = _mm_max_ps( _m
+00005b70: 6d32 3536 5f65 7874 7261 6374 6631 3238  m256_extractf128
+00005b80: 5f70 7328 2076 6d61 782c 2031 2029 2c20  _ps( vmax, 1 ), 
+00005b90: 5f6d 6d32 3536 5f63 6173 7470 7332 3536  _mm256_castps256
+00005ba0: 5f70 7331 3238 2820 766d 6178 2029 2029  _ps128( vmax ) )
+00005bb0: 3b0a 2020 2020 2020 2020 6d61 7834 203d  ;.        max4 =
+00005bc0: 205f 6d6d 5f6d 6178 5f70 7328 206d 6178   _mm_max_ps( max
+00005bd0: 342c 205f 6d6d 5f6d 6f76 6568 6c5f 7073  4, _mm_movehl_ps
+00005be0: 2820 6d61 7834 2c20 6d61 7834 2029 2029  ( max4, max4 ) )
+00005bf0: 3b0a 2020 2020 2020 2020 6d61 7834 203d  ;.        max4 =
+00005c00: 205f 6d6d 5f6d 6178 5f73 7328 206d 6178   _mm_max_ss( max
+00005c10: 342c 205f 6d6d 5f6d 6f76 6568 6475 705f  4, _mm_movehdup_
+00005c20: 7073 2820 6d61 7834 2029 2029 3b0a 2020  ps( max4 ) );.  
+00005c30: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+00005c40: 7420 6d61 7853 6361 6c61 7220 3d20 5f6d  t maxScalar = _m
+00005c50: 6d5f 6376 7473 735f 6633 3228 206d 6178  m_cvtss_f32( max
+00005c60: 3420 293b 0a0a 2020 2020 2020 2020 2f2f  4 );..        //
+00005c70: 2043 6f6d 7075 7465 206d 696e 2066 6f72   Compute min for
+00005c80: 2074 6865 2062 6c6f 636b 0a20 2020 2020   the block.     
+00005c90: 2020 205f 5f6d 3235 3620 766d 696e 3b0a     __m256 vmin;.
+00005ca0: 2020 2020 2020 2020 766d 696e 203d 205f          vmin = _
+00005cb0: 6d6d 3235 365f 6d69 6e5f 7073 2820 7630  mm256_min_ps( v0
+00005cc0: 2c20 7631 2029 3b0a 2020 2020 2020 2020  , v1 );.        
+00005cd0: 766d 696e 203d 205f 6d6d 3235 365f 6d69  vmin = _mm256_mi
+00005ce0: 6e5f 7073 2820 766d 696e 2c20 7632 2029  n_ps( vmin, v2 )
+00005cf0: 3b0a 2020 2020 2020 2020 766d 696e 203d  ;.        vmin =
+00005d00: 205f 6d6d 3235 365f 6d69 6e5f 7073 2820   _mm256_min_ps( 
+00005d10: 766d 696e 2c20 7633 2029 3b0a 0a20 2020  vmin, v3 );..   
+00005d20: 2020 2020 205f 5f6d 3132 3820 6d69 6e34       __m128 min4
+00005d30: 203d 205f 6d6d 5f6d 696e 5f70 7328 205f   = _mm_min_ps( _
+00005d40: 6d6d 3235 365f 6578 7472 6163 7466 3132  mm256_extractf12
+00005d50: 385f 7073 2820 766d 696e 2c20 3120 292c  8_ps( vmin, 1 ),
+00005d60: 205f 6d6d 3235 365f 6361 7374 7073 3235   _mm256_castps25
+00005d70: 365f 7073 3132 3828 2076 6d69 6e20 2920  6_ps128( vmin ) 
+00005d80: 293b 0a20 2020 2020 2020 206d 696e 3420  );.        min4 
+00005d90: 3d20 5f6d 6d5f 6d69 6e5f 7073 2820 6d69  = _mm_min_ps( mi
+00005da0: 6e34 2c20 5f6d 6d5f 6d6f 7665 686c 5f70  n4, _mm_movehl_p
+00005db0: 7328 206d 696e 342c 206d 696e 3420 2920  s( min4, min4 ) 
+00005dc0: 293b 0a20 2020 2020 2020 206d 696e 3420  );.        min4 
+00005dd0: 3d20 5f6d 6d5f 6d69 6e5f 7373 2820 6d69  = _mm_min_ss( mi
+00005de0: 6e34 2c20 5f6d 6d5f 6d6f 7665 6864 7570  n4, _mm_movehdup
+00005df0: 5f70 7328 206d 696e 3420 2920 293b 0a20  _ps( min4 ) );. 
+00005e00: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+00005e10: 6174 206d 696e 5363 616c 6172 203d 205f  at minScalar = _
+00005e20: 6d6d 5f63 7674 7373 5f66 3332 2820 6d69  mm_cvtss_f32( mi
+00005e30: 6e34 2029 3b0a 0a20 2020 2020 2020 202f  n4 );..        /
+00005e40: 2f20 5175 616e 7469 7a65 2074 6865 7365  / Quantize these
+00005e50: 2066 6c6f 6174 730a 2020 2020 2020 2020   floats.        
+00005e60: 636f 6e73 7420 666c 6f61 7420 6420 3d20  const float d = 
+00005e70: 286d 6178 5363 616c 6172 202d 206d 696e  (maxScalar - min
+00005e80: 5363 616c 6172 2920 2f20 2828 3120 3c3c  Scalar) / ((1 <<
+00005e90: 2034 2920 2d20 3129 3b0a 2020 2020 2020   4) - 1);.      
+00005ea0: 2020 636f 6e73 7420 666c 6f61 7420 6964    const float id
+00005eb0: 203d 2064 203f 2031 2e30 662f 6420 3a20   = d ? 1.0f/d : 
+00005ec0: 302e 3066 3b0a 0a20 2020 2020 2020 2079  0.0f;..        y
+00005ed0: 5b69 5d2e 6d20 3d20 6d69 6e53 6361 6c61  [i].m = minScala
+00005ee0: 723b 0a20 2020 2020 2020 2079 5b69 5d2e  r;.        y[i].
+00005ef0: 6420 3d20 643b 0a0a 2020 2020 2020 2020  d = d;..        
+00005f00: 2f2f 2078 203d 2028 782d 6d69 6e29 2a69  // x = (x-min)*i
+00005f10: 640a 2020 2020 2020 2020 636f 6e73 7420  d.        const 
+00005f20: 5f5f 6d32 3536 206d 756c 203d 205f 6d6d  __m256 mul = _mm
+00005f30: 3235 365f 7365 7431 5f70 7328 2069 6420  256_set1_ps( id 
+00005f40: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+00005f50: 205f 5f6d 3235 3620 6f66 6620 3d20 5f6d   __m256 off = _m
+00005f60: 6d32 3536 5f73 6574 315f 7073 2820 6d69  m256_set1_ps( mi
+00005f70: 6e53 6361 6c61 7220 293b 0a20 2020 2020  nScalar );.     
+00005f80: 2020 2076 3020 3d20 5f6d 6d32 3536 5f6d     v0 = _mm256_m
+00005f90: 756c 5f70 7328 205f 6d6d 3235 365f 7375  ul_ps( _mm256_su
+00005fa0: 625f 7073 2820 7630 2c20 6f66 6620 292c  b_ps( v0, off ),
+00005fb0: 206d 756c 2029 3b0a 2020 2020 2020 2020   mul );.        
+00005fc0: 7631 203d 205f 6d6d 3235 365f 6d75 6c5f  v1 = _mm256_mul_
+00005fd0: 7073 2820 5f6d 6d32 3536 5f73 7562 5f70  ps( _mm256_sub_p
+00005fe0: 7328 2076 312c 206f 6666 2029 2c20 6d75  s( v1, off ), mu
+00005ff0: 6c20 293b 0a20 2020 2020 2020 2076 3220  l );.        v2 
+00006000: 3d20 5f6d 6d32 3536 5f6d 756c 5f70 7328  = _mm256_mul_ps(
+00006010: 205f 6d6d 3235 365f 7375 625f 7073 2820   _mm256_sub_ps( 
+00006020: 7632 2c20 6f66 6620 292c 206d 756c 2029  v2, off ), mul )
+00006030: 3b0a 2020 2020 2020 2020 7633 203d 205f  ;.        v3 = _
+00006040: 6d6d 3235 365f 6d75 6c5f 7073 2820 5f6d  mm256_mul_ps( _m
+00006050: 6d32 3536 5f73 7562 5f70 7328 2076 332c  m256_sub_ps( v3,
+00006060: 206f 6666 2029 2c20 6d75 6c20 293b 0a0a   off ), mul );..
+00006070: 2020 2020 2020 2020 2f2f 2052 6f75 6e64          // Round
+00006080: 2074 6f20 6e65 6172 6573 7420 696e 7465   to nearest inte
+00006090: 6765 720a 2020 2020 2020 2020 7630 203d  ger.        v0 =
+000060a0: 205f 6d6d 3235 365f 726f 756e 645f 7073   _mm256_round_ps
+000060b0: 2820 7630 2c20 5f4d 4d5f 524f 554e 445f  ( v0, _MM_ROUND_
+000060c0: 4e45 4152 4553 5420 293b 0a20 2020 2020  NEAREST );.     
+000060d0: 2020 2076 3120 3d20 5f6d 6d32 3536 5f72     v1 = _mm256_r
+000060e0: 6f75 6e64 5f70 7328 2076 312c 205f 4d4d  ound_ps( v1, _MM
+000060f0: 5f52 4f55 4e44 5f4e 4541 5245 5354 2029  _ROUND_NEAREST )
+00006100: 3b0a 2020 2020 2020 2020 7632 203d 205f  ;.        v2 = _
+00006110: 6d6d 3235 365f 726f 756e 645f 7073 2820  mm256_round_ps( 
+00006120: 7632 2c20 5f4d 4d5f 524f 554e 445f 4e45  v2, _MM_ROUND_NE
+00006130: 4152 4553 5420 293b 0a20 2020 2020 2020  AREST );.       
+00006140: 2076 3320 3d20 5f6d 6d32 3536 5f72 6f75   v3 = _mm256_rou
+00006150: 6e64 5f70 7328 2076 332c 205f 4d4d 5f52  nd_ps( v3, _MM_R
+00006160: 4f55 4e44 5f4e 4541 5245 5354 2029 3b0a  OUND_NEAREST );.
+00006170: 0a20 2020 2020 2020 202f 2f20 436f 6e76  .        // Conv
+00006180: 6572 7420 666c 6f61 7473 2074 6f20 696e  ert floats to in
+00006190: 7465 6765 7273 0a20 2020 2020 2020 205f  tegers.        _
+000061a0: 5f6d 3235 3669 2069 3020 3d20 5f6d 6d32  _m256i i0 = _mm2
+000061b0: 3536 5f63 7674 7073 5f65 7069 3332 2820  56_cvtps_epi32( 
+000061c0: 7630 2029 3b0a 2020 2020 2020 2020 5f5f  v0 );.        __
+000061d0: 6d32 3536 6920 6931 203d 205f 6d6d 3235  m256i i1 = _mm25
+000061e0: 365f 6376 7470 735f 6570 6933 3228 2076  6_cvtps_epi32( v
+000061f0: 3120 293b 0a20 2020 2020 2020 205f 5f6d  1 );.        __m
+00006200: 3235 3669 2069 3220 3d20 5f6d 6d32 3536  256i i2 = _mm256
+00006210: 5f63 7674 7073 5f65 7069 3332 2820 7632  _cvtps_epi32( v2
+00006220: 2029 3b0a 2020 2020 2020 2020 5f5f 6d32   );.        __m2
+00006230: 3536 6920 6933 203d 205f 6d6d 3235 365f  56i i3 = _mm256_
+00006240: 6376 7470 735f 6570 6933 3228 2076 3320  cvtps_epi32( v3 
+00006250: 293b 0a0a 2020 2020 2020 2020 2f2f 2043  );..        // C
+00006260: 6f6e 7665 7274 2069 6e74 3332 2074 6f20  onvert int32 to 
+00006270: 696e 7431 360a 2020 2020 2020 2020 6930  int16.        i0
+00006280: 203d 205f 6d6d 3235 365f 7061 636b 735f   = _mm256_packs_
+00006290: 6570 6933 3228 2069 302c 2069 3120 293b  epi32( i0, i1 );
+000062a0: 092f 2f20 302c 2031 2c20 322c 2033 2c20  .// 0, 1, 2, 3, 
+000062b0: 2038 2c20 392c 2031 302c 2031 312c 2020   8, 9, 10, 11,  
+000062c0: 342c 2035 2c20 362c 2037 2c20 3132 2c20  4, 5, 6, 7, 12, 
+000062d0: 3133 2c20 3134 2c20 3135 0a20 2020 2020  13, 14, 15.     
+000062e0: 2020 2069 3220 3d20 5f6d 6d32 3536 5f70     i2 = _mm256_p
+000062f0: 6163 6b73 5f65 7069 3332 2820 6932 2c20  acks_epi32( i2, 
+00006300: 6933 2029 3b09 2f2f 2031 362c 2031 372c  i3 );.// 16, 17,
+00006310: 2031 382c 2031 392c 2020 3234 2c20 3235   18, 19,  24, 25
+00006320: 2c20 3236 2c20 3237 2c20 2032 302c 2032  , 26, 27,  20, 2
+00006330: 312c 2032 322c 2032 332c 2032 382c 2032  1, 22, 23, 28, 2
+00006340: 392c 2033 302c 2033 310a 2020 2020 2020  9, 30, 31.      
+00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006370: 2020 2020 2020 2f2f 2043 6f6e 7665 7274        // Convert
+00006380: 2069 6e74 3136 2074 6f20 696e 7438 0a20   int16 to int8. 
+00006390: 2020 2020 2020 2069 3020 3d20 5f6d 6d32         i0 = _mm2
+000063a0: 3536 5f70 6163 6b73 5f65 7069 3136 2820  56_packs_epi16( 
+000063b0: 6930 2c20 6932 2029 3b09 2f2f 2030 2c20  i0, i2 );.// 0, 
+000063c0: 312c 2032 2c20 332c 2020 382c 2039 2c20  1, 2, 3,  8, 9, 
+000063d0: 3130 2c20 3131 2c20 2031 362c 2031 372c  10, 11,  16, 17,
+000063e0: 2031 382c 2031 392c 2020 3234 2c20 3235   18, 19,  24, 25
+000063f0: 2c20 3236 2c20 3237 2c20 2034 2c20 352c  , 26, 27,  4, 5,
+00006400: 2036 2c20 372c 2031 322c 2031 332c 2031   6, 7, 12, 13, 1
+00006410: 342c 2031 352c 2032 302c 2032 312c 2032  4, 15, 20, 21, 2
+00006420: 322c 2032 332c 2032 382c 2032 392c 2033  2, 23, 28, 29, 3
+00006430: 302c 2033 310a 0a20 2020 2020 2020 202f  0, 31..        /
+00006440: 2f20 5765 2067 6f74 206f 7572 2070 7265  / We got our pre
+00006450: 6369 6f75 7320 7369 676e 6564 2062 7974  cious signed byt
+00006460: 6573 2c20 6275 7420 7468 6520 6f72 6465  es, but the orde
+00006470: 7220 6973 206e 6f77 2077 726f 6e67 0a20  r is now wrong. 
+00006480: 2020 2020 2020 202f 2f20 5468 6573 6520         // These 
+00006490: 4156 5832 2070 6163 6b20 696e 7374 7275  AVX2 pack instru
+000064a0: 6374 696f 6e73 2070 726f 6365 7373 2031  ctions process 1
+000064b0: 362d 6279 7465 2070 6965 6365 7320 696e  6-byte pieces in
+000064c0: 6465 7065 6e64 656e 746c 790a 2020 2020  dependently.    
+000064d0: 2020 2020 2f2f 2054 6865 2066 6f6c 6c6f      // The follo
+000064e0: 7769 6e67 2069 6e73 7472 7563 7469 6f6e  wing instruction
+000064f0: 2069 7320 6669 7869 6e67 2074 6865 206f   is fixing the o
+00006500: 7264 6572 0a20 2020 2020 2020 2063 6f6e  rder.        con
+00006510: 7374 205f 5f6d 3235 3669 2070 6572 6d20  st __m256i perm 
+00006520: 3d20 5f6d 6d32 3536 5f73 6574 725f 6570  = _mm256_setr_ep
+00006530: 6933 3228 2030 2c20 342c 2031 2c20 352c  i32( 0, 4, 1, 5,
+00006540: 2032 2c20 362c 2033 2c20 3720 293b 0a20   2, 6, 3, 7 );. 
+00006550: 2020 2020 2020 2069 3020 3d20 5f6d 6d32         i0 = _mm2
+00006560: 3536 5f70 6572 6d75 7465 7661 7238 7833  56_permutevar8x3
+00006570: 325f 6570 6933 3228 2069 302c 2070 6572  2_epi32( i0, per
+00006580: 6d20 293b 0a0a 2020 2020 2020 2020 2f2f  m );..        //
+00006590: 2043 6f6d 7072 6573 7320 7468 6520 7665   Compress the ve
+000065a0: 6374 6f72 2069 6e74 6f20 3420 6269 742f  ctor into 4 bit/
+000065b0: 7661 6c75 652c 2061 6e64 2073 746f 7265  value, and store
+000065c0: 0a20 2020 2020 2020 205f 5f6d 3132 3869  .        __m128i
+000065d0: 2072 6573 203d 2070 6163 6b4e 6962 626c   res = packNibbl
+000065e0: 6573 2820 6930 2029 3b0a 2020 2020 2020  es( i0 );.      
+000065f0: 2020 5f6d 6d5f 7374 6f72 6575 5f73 6931    _mm_storeu_si1
+00006600: 3238 2820 2820 5f5f 6d31 3238 692a 2029  28( ( __m128i* )
+00006610: 795b 695d 2e71 732c 2072 6573 2029 3b0a  y[i].qs, res );.
+00006620: 2020 2020 7d0a 2365 6c73 650a 2020 2020      }.#else.    
+00006630: 2f2f 2073 6361 6c61 720a 2020 2020 7175  // scalar.    qu
+00006640: 616e 7469 7a65 5f72 6f77 5f71 345f 315f  antize_row_q4_1_
+00006650: 7265 6665 7265 6e63 6528 782c 2076 792c  reference(x, vy,
+00006660: 206b 293b 0a23 656e 6469 660a 7d0a 0a73   k);.#endif.}..s
+00006670: 7461 7469 6320 766f 6964 2064 6571 7561  tatic void dequa
+00006680: 6e74 697a 655f 726f 775f 7134 5f30 2863  ntize_row_q4_0(c
+00006690: 6f6e 7374 2076 6f69 6420 2a20 7265 7374  onst void * rest
+000066a0: 7269 6374 2076 782c 2066 6c6f 6174 202a  rict vx, float *
+000066b0: 2072 6573 7472 6963 7420 792c 2069 6e74   restrict y, int
+000066c0: 206b 2920 7b0a 2020 2020 6173 7365 7274   k) {.    assert
+000066d0: 286b 2025 2051 4b20 3d3d 2030 293b 0a20  (k % QK == 0);. 
+000066e0: 2020 2063 6f6e 7374 2069 6e74 206e 6220     const int nb 
+000066f0: 3d20 6b20 2f20 514b 3b0a 0a20 2020 2063  = k / QK;..    c
+00006700: 6f6e 7374 2062 6c6f 636b 5f71 345f 3020  onst block_q4_0 
+00006710: 2a20 7265 7374 7269 6374 2078 203d 2076  * restrict x = v
+00006720: 783b 0a0a 2369 6620 6465 6669 6e65 6428  x;..#if defined(
+00006730: 5f5f 4156 5832 5f5f 290a 2020 2020 666f  __AVX2__).    fo
+00006740: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00006750: 3c20 6e62 3b20 692b 2b29 207b 0a20 2020  < nb; i++) {.   
+00006760: 2020 2020 202f 2f20 7363 616c 6520 6661       // scale fa
+00006770: 6374 6f72 0a20 2020 2020 2020 2063 6f6e  ctor.        con
+00006780: 7374 205f 5f6d 3235 3620 645f 7620 3d20  st __m256 d_v = 
+00006790: 5f6d 6d32 3536 5f62 726f 6164 6361 7374  _mm256_broadcast
+000067a0: 5f73 7328 2678 5b69 5d2e 6429 3b0a 0a20  _ss(&x[i].d);.. 
+000067b0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+000067c0: 7438 5f74 202a 2072 6573 7472 6963 7420  t8_t * restrict 
+000067d0: 7070 203d 2078 5b69 5d2e 7173 3b0a 0a20  pp = x[i].qs;.. 
+000067e0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+000067f0: 6c20 3d20 303b 206c 203c 2051 4b3b 206c  l = 0; l < QK; l
+00006800: 202b 3d20 3332 2920 7b0a 2020 2020 2020   += 32) {.      
+00006810: 2020 2020 2020 2f2f 204c 6f61 6420 3332        // Load 32
+00006820: 7834 2d62 6974 2069 6e74 6567 6572 7320  x4-bit integers 
+00006830: 696e 746f 2033 3278 382d 6269 7420 696e  into 32x8-bit in
+00006840: 7465 6765 7273 0a20 2020 2020 2020 2020  tegers.         
+00006850: 2020 205f 5f6d 3235 3669 2076 7838 203d     __m256i vx8 =
+00006860: 2062 7974 6573 4672 6f6d 4e69 6262 6c65   bytesFromNibble
+00006870: 7328 7070 2b6c 2f32 293b 0a0a 2020 2020  s(pp+l/2);..    
+00006880: 2020 2020 2020 2020 2f2f 2053 7562 7472          // Subtr
+00006890: 6163 7420 3820 6672 6f6d 2074 6865 2069  act 8 from the i
+000068a0: 6e74 6567 6572 730a 2020 2020 2020 2020  ntegers.        
+000068b0: 2020 2020 7678 3820 3d20 5f6d 6d32 3536      vx8 = _mm256
+000068c0: 5f73 7562 5f65 7069 3828 7678 382c 205f  _sub_epi8(vx8, _
+000068d0: 6d6d 3235 365f 7365 7431 5f65 7069 3828  mm256_set1_epi8(
+000068e0: 3829 293b 0a0a 2020 2020 2020 2020 2020  8));..          
+000068f0: 2020 2f2f 2043 6f6e 7665 7274 2074 6f20    // Convert to 
+00006900: 3136 2d62 6974 2069 6e74 0a20 2020 2020  16-bit int.     
+00006910: 2020 2020 2020 2063 6f6e 7374 205f 5f6d         const __m
+00006920: 3235 3669 2076 7831 365f 6c6f 203d 205f  256i vx16_lo = _
+00006930: 6d6d 3235 365f 6376 7465 7069 385f 6570  mm256_cvtepi8_ep
+00006940: 6931 3628 5f6d 6d32 3536 5f65 7874 7261  i16(_mm256_extra
+00006950: 6374 6931 3238 5f73 6932 3536 2876 7838  cti128_si256(vx8
+00006960: 2c20 3029 293b 0a20 2020 2020 2020 2020  , 0));.         
+00006970: 2020 2063 6f6e 7374 205f 5f6d 3235 3669     const __m256i
+00006980: 2076 7831 365f 6869 203d 205f 6d6d 3235   vx16_hi = _mm25
+00006990: 365f 6376 7465 7069 385f 6570 6931 3628  6_cvtepi8_epi16(
+000069a0: 5f6d 6d32 3536 5f65 7874 7261 6374 6931  _mm256_extracti1
+000069b0: 3238 5f73 6932 3536 2876 7838 2c20 3129  28_si256(vx8, 1)
+000069c0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+000069d0: 2f2f 2043 6f6e 7665 7274 2074 6f20 3332  // Convert to 32
+000069e0: 2d62 6974 2069 6e74 202d 3e20 666c 6f61  -bit int -> floa
+000069f0: 7420 3332 0a20 2020 2020 2020 2020 2020  t 32.           
+00006a00: 2063 6f6e 7374 205f 5f6d 3235 3620 7666   const __m256 vf
+00006a10: 5b34 5d20 3d20 7b0a 2020 2020 2020 2020  [4] = {.        
+00006a20: 2020 2020 2020 2020 5f6d 6d32 3536 5f63          _mm256_c
+00006a30: 7674 6570 6933 325f 7073 285f 6d6d 3235  vtepi32_ps(_mm25
+00006a40: 365f 6376 7465 7069 3136 5f65 7069 3332  6_cvtepi16_epi32
+00006a50: 285f 6d6d 3235 365f 6578 7472 6163 7469  (_mm256_extracti
+00006a60: 3132 385f 7369 3235 3628 7678 3136 5f6c  128_si256(vx16_l
+00006a70: 6f2c 2030 2929 292c 0a20 2020 2020 2020  o, 0))),.       
+00006a80: 2020 2020 2020 2020 205f 6d6d 3235 365f           _mm256_
+00006a90: 6376 7465 7069 3332 5f70 7328 5f6d 6d32  cvtepi32_ps(_mm2
+00006aa0: 3536 5f63 7674 6570 6931 365f 6570 6933  56_cvtepi16_epi3
+00006ab0: 3228 5f6d 6d32 3536 5f65 7874 7261 6374  2(_mm256_extract
+00006ac0: 6931 3238 5f73 6932 3536 2876 7831 365f  i128_si256(vx16_
+00006ad0: 6c6f 2c20 3129 2929 2c0a 2020 2020 2020  lo, 1))),.      
+00006ae0: 2020 2020 2020 2020 2020 5f6d 6d32 3536            _mm256
+00006af0: 5f63 7674 6570 6933 325f 7073 285f 6d6d  _cvtepi32_ps(_mm
+00006b00: 3235 365f 6376 7465 7069 3136 5f65 7069  256_cvtepi16_epi
+00006b10: 3332 285f 6d6d 3235 365f 6578 7472 6163  32(_mm256_extrac
+00006b20: 7469 3132 385f 7369 3235 3628 7678 3136  ti128_si256(vx16
+00006b30: 5f68 692c 2030 2929 292c 0a20 2020 2020  _hi, 0))),.     
+00006b40: 2020 2020 2020 2020 2020 205f 6d6d 3235             _mm25
+00006b50: 365f 6376 7465 7069 3332 5f70 7328 5f6d  6_cvtepi32_ps(_m
+00006b60: 6d32 3536 5f63 7674 6570 6931 365f 6570  m256_cvtepi16_ep
+00006b70: 6933 3228 5f6d 6d32 3536 5f65 7874 7261  i32(_mm256_extra
+00006b80: 6374 6931 3238 5f73 6932 3536 2876 7831  cti128_si256(vx1
+00006b90: 365f 6869 2c20 3129 2929 0a20 2020 2020  6_hi, 1))).     
+00006ba0: 2020 2020 2020 207d 3b0a 0a20 2020 2020         };..     
+00006bb0: 2020 2020 2020 202f 2f20 5363 616c 6520         // Scale 
+00006bc0: 616e 6420 7374 6f72 650a 2020 2020 2020  and store.      
+00006bd0: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00006be0: 203d 2030 3b20 6a20 3c20 343b 206a 2b2b   = 0; j < 4; j++
+00006bf0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00006c00: 2020 2020 636f 6e73 7420 5f5f 6d32 3536      const __m256
+00006c10: 2072 6573 756c 7420 3d20 5f6d 6d32 3536   result = _mm256
+00006c20: 5f6d 756c 5f70 7328 7666 5b6a 5d2c 2064  _mul_ps(vf[j], d
+00006c30: 5f76 293b 0a20 2020 2020 2020 2020 2020  _v);.           
+00006c40: 2020 2020 205f 6d6d 3235 365f 7374 6f72       _mm256_stor
+00006c50: 6575 5f70 7328 7920 2b20 6920 2a20 514b  eu_ps(y + i * QK
+00006c60: 202b 206c 202b 206a 2a38 2c20 7265 7375   + l + j*8, resu
+00006c70: 6c74 293b 0a20 2020 2020 2020 2020 2020  lt);.           
+00006c80: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+00006c90: 207d 0a23 656c 6966 2064 6566 696e 6564   }.#elif defined
+00006ca0: 285f 5f41 524d 5f4e 454f 4e29 0a20 2020  (__ARM_NEON).   
+00006cb0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00006cc0: 2069 203c 206e 623b 2069 2b2b 2920 7b0a   i < nb; i++) {.
+00006cd0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00006ce0: 6f61 7433 3278 345f 7420 7664 203d 2076  oat32x4_t vd = v
+00006cf0: 6475 7071 5f6e 5f66 3332 2878 5b69 5d2e  dupq_n_f32(x[i].
+00006d00: 6429 3b0a 0a20 2020 2020 2020 2063 6f6e  d);..        con
+00006d10: 7374 2075 696e 7438 5f74 202a 2072 6573  st uint8_t * res
+00006d20: 7472 6963 7420 7070 203d 2078 5b69 5d2e  trict pp = x[i].
+00006d30: 7173 3b0a 0a20 2020 2020 2020 2066 6f72  qs;..        for
+00006d40: 2028 696e 7420 6c20 3d20 303b 206c 203c   (int l = 0; l <
+00006d50: 2051 4b3b 206c 202b 3d20 3136 2920 7b0a   QK; l += 16) {.
+00006d60: 2020 2020 2020 2020 2020 2020 2f2f 204c              // L
+00006d70: 6f61 6420 3136 7834 2d62 6974 2069 6e74  oad 16x4-bit int
+00006d80: 6567 6572 7320 696e 746f 2038 7838 2d62  egers into 8x8-b
+00006d90: 6974 2069 6e74 6567 6572 730a 2020 2020  it integers.    
+00006da0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+00006db0: 6e74 3878 385f 7420 7638 203d 2076 6c64  nt8x8_t v8 = vld
+00006dc0: 315f 7538 2870 7020 2b20 6c2f 3229 3b0a  1_u8(pp + l/2);.
+00006dd0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+00006de0: 4578 7061 6e64 2034 2d62 6974 2071 7320  Expand 4-bit qs 
+00006df0: 746f 2038 2d62 6974 2062 7974 6573 0a20  to 8-bit bytes. 
+00006e00: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00006e10: 2075 696e 7438 7838 5f74 2076 3020 3d20   uint8x8_t v0 = 
+00006e20: 7661 6e64 5f75 3828 7638 2c20 7664 7570  vand_u8(v8, vdup
+00006e30: 5f6e 5f75 3828 3078 3066 2929 3b0a 2020  _n_u8(0x0f));.  
+00006e40: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00006e50: 7569 6e74 3878 385f 7420 7631 203d 2076  uint8x8_t v1 = v
+00006e60: 7368 725f 6e5f 7538 2876 382c 2034 293b  shr_n_u8(v8, 4);
+00006e70: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+00006e80: 2043 6f6e 7665 7274 2074 6f20 7369 676e   Convert to sign
+00006e90: 6564 2038 2d62 6974 2069 6e74 6567 6572  ed 8-bit integer
+00006ea0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
+00006eb0: 6e73 7420 696e 7438 7838 5f74 2076 735f  nst int8x8_t vs_
+00006ec0: 3020 3d20 7672 6569 6e74 6572 7072 6574  0 = vreinterpret
+00006ed0: 5f73 385f 7538 2876 3029 3b0a 2020 2020  _s8_u8(v0);.    
+00006ee0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00006ef0: 7438 7838 5f74 2076 735f 3120 3d20 7672  t8x8_t vs_1 = vr
+00006f00: 6569 6e74 6572 7072 6574 5f73 385f 7538  einterpret_s8_u8
+00006f10: 2876 3129 3b0a 0a20 2020 2020 2020 2020  (v1);..         
+00006f20: 2020 202f 2f20 5375 6274 7261 6374 2038     // Subtract 8
+00006f30: 2066 726f 6d20 6561 6368 2062 7974 650a   from each byte.
+00006f40: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00006f50: 7420 696e 7438 7838 5f74 2076 625f 3020  t int8x8_t vb_0 
+00006f60: 3d20 7673 7562 5f73 3828 7673 5f30 2c20  = vsub_s8(vs_0, 
+00006f70: 7664 7570 5f6e 5f73 3828 3829 293b 0a20  vdup_n_s8(8));. 
+00006f80: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00006f90: 2069 6e74 3878 385f 7420 7662 5f31 203d   int8x8_t vb_1 =
+00006fa0: 2076 7375 625f 7338 2876 735f 312c 2076   vsub_s8(vs_1, v
+00006fb0: 6475 705f 6e5f 7338 2838 2929 3b0a 0a20  dup_n_s8(8));.. 
+00006fc0: 2020 2020 2020 2020 2020 202f 2f20 496e             // In
+00006fd0: 7465 726c 6561 7665 2061 6e64 2063 6f6d  terleave and com
+00006fe0: 6269 6e65 0a20 2020 2020 2020 2020 2020  bine.           
+00006ff0: 2063 6f6e 7374 2069 6e74 3878 385f 7420   const int8x8_t 
+00007000: 7678 5f30 203d 2076 7a69 7031 5f73 3828  vx_0 = vzip1_s8(
+00007010: 7662 5f30 2c20 7662 5f31 293b 0a20 2020  vb_0, vb_1);.   
+00007020: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00007030: 6e74 3878 385f 7420 7678 5f31 203d 2076  nt8x8_t vx_1 = v
+00007040: 7a69 7032 5f73 3828 7662 5f30 2c20 7662  zip2_s8(vb_0, vb
+00007050: 5f31 293b 0a0a 2020 2020 2020 2020 2020  _1);..          
+00007060: 2020 636f 6e73 7420 696e 7438 7831 365f    const int8x16_
+00007070: 7420 7671 203d 2076 636f 6d62 696e 655f  t vq = vcombine_
+00007080: 7338 2876 785f 302c 2076 785f 3129 3b0a  s8(vx_0, vx_1);.
+00007090: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000070a0: 636f 6e76 6572 7420 746f 2032 7820 696e  convert to 2x in
+000070b0: 7431 3678 385f 740a 2020 2020 2020 2020  t16x8_t.        
+000070c0: 2020 2020 636f 6e73 7420 696e 7431 3678      const int16x
+000070d0: 385f 7420 7669 5f30 203d 2076 6d6f 766c  8_t vi_0 = vmovl
+000070e0: 5f73 3828 7667 6574 5f6c 6f77 5f73 3820  _s8(vget_low_s8 
+000070f0: 2876 7129 293b 0a20 2020 2020 2020 2020  (vq));.         
+00007100: 2020 2063 6f6e 7374 2069 6e74 3136 7838     const int16x8
+00007110: 5f74 2076 695f 3120 3d20 766d 6f76 6c5f  _t vi_1 = vmovl_
+00007120: 7338 2876 6765 745f 6869 6768 5f73 3828  s8(vget_high_s8(
+00007130: 7671 2929 3b0a 0a20 2020 2020 2020 2020  vq));..         
+00007140: 2020 202f 2f20 636f 6e76 6572 7420 746f     // convert to
+00007150: 2034 7820 666c 6f61 7433 3278 345f 740a   4x float32x4_t.
+00007160: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00007170: 7420 666c 6f61 7433 3278 345f 7420 7666  t float32x4_t vf
+00007180: 5f30 203d 2076 6376 7471 5f66 3332 5f73  _0 = vcvtq_f32_s
+00007190: 3332 2876 6d6f 766c 5f73 3136 2876 6765  32(vmovl_s16(vge
+000071a0: 745f 6c6f 775f 7331 3620 2876 695f 3029  t_low_s16 (vi_0)
+000071b0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+000071c0: 636f 6e73 7420 666c 6f61 7433 3278 345f  const float32x4_
+000071d0: 7420 7666 5f31 203d 2076 6376 7471 5f66  t vf_1 = vcvtq_f
+000071e0: 3332 5f73 3332 2876 6d6f 766c 5f73 3136  32_s32(vmovl_s16
+000071f0: 2876 6765 745f 6869 6768 5f73 3136 2876  (vget_high_s16(v
+00007200: 695f 3029 2929 3b0a 2020 2020 2020 2020  i_0)));.        
+00007210: 2020 2020 636f 6e73 7420 666c 6f61 7433      const float3
+00007220: 3278 345f 7420 7666 5f32 203d 2076 6376  2x4_t vf_2 = vcv
+00007230: 7471 5f66 3332 5f73 3332 2876 6d6f 766c  tq_f32_s32(vmovl
+00007240: 5f73 3136 2876 6765 745f 6c6f 775f 7331  _s16(vget_low_s1
+00007250: 3620 2876 695f 3129 2929 3b0a 2020 2020  6 (vi_1)));.    
+00007260: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00007270: 6f61 7433 3278 345f 7420 7666 5f33 203d  oat32x4_t vf_3 =
+00007280: 2076 6376 7471 5f66 3332 5f73 3332 2876   vcvtq_f32_s32(v
+00007290: 6d6f 766c 5f73 3136 2876 6765 745f 6869  movl_s16(vget_hi
+000072a0: 6768 5f73 3136 2876 695f 3129 2929 3b0a  gh_s16(vi_1)));.
+000072b0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000072c0: 4d75 6c74 6970 6c79 2062 7920 640a 2020  Multiply by d.  
+000072d0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+000072e0: 666c 6f61 7433 3278 345f 7420 7230 203d  float32x4_t r0 =
+000072f0: 2076 6d75 6c71 5f66 3332 2876 665f 302c   vmulq_f32(vf_0,
+00007300: 2076 6429 3b0a 2020 2020 2020 2020 2020   vd);.          
+00007310: 2020 636f 6e73 7420 666c 6f61 7433 3278    const float32x
+00007320: 345f 7420 7231 203d 2076 6d75 6c71 5f66  4_t r1 = vmulq_f
+00007330: 3332 2876 665f 312c 2076 6429 3b0a 2020  32(vf_1, vd);.  
+00007340: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00007350: 666c 6f61 7433 3278 345f 7420 7232 203d  float32x4_t r2 =
+00007360: 2076 6d75 6c71 5f66 3332 2876 665f 322c   vmulq_f32(vf_2,
+00007370: 2076 6429 3b0a 2020 2020 2020 2020 2020   vd);.          
+00007380: 2020 636f 6e73 7420 666c 6f61 7433 3278    const float32x
+00007390: 345f 7420 7233 203d 2076 6d75 6c71 5f66  4_t r3 = vmulq_f
+000073a0: 3332 2876 665f 332c 2076 6429 3b0a 0a20  32(vf_3, vd);.. 
+000073b0: 2020 2020 2020 2020 2020 202f 2f20 5374             // St
+000073c0: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+000073d0: 7673 7431 715f 6633 3228 7920 2b20 692a  vst1q_f32(y + i*
+000073e0: 514b 202b 206c 202b 2020 302c 2072 3029  QK + l +  0, r0)
+000073f0: 3b0a 2020 2020 2020 2020 2020 2020 7673  ;.            vs
+00007400: 7431 715f 6633 3228 7920 2b20 692a 514b  t1q_f32(y + i*QK
+00007410: 202b 206c 202b 2020 342c 2072 3129 3b0a   + l +  4, r1);.
+00007420: 2020 2020 2020 2020 2020 2020 7673 7431              vst1
+00007430: 715f 6633 3228 7920 2b20 692a 514b 202b  q_f32(y + i*QK +
+00007440: 206c 202b 2020 382c 2072 3229 3b0a 2020   l +  8, r2);.  
+00007450: 2020 2020 2020 2020 2020 7673 7431 715f            vst1q_
+00007460: 6633 3228 7920 2b20 692a 514b 202b 206c  f32(y + i*QK + l
+00007470: 202b 2031 322c 2072 3329 3b0a 2020 2020   + 12, r3);.    
+00007480: 2020 2020 7d0a 2020 2020 7d0a 2365 6c73      }.    }.#els
+00007490: 650a 2020 2020 2f2f 2073 6361 6c61 720a  e.    // scalar.
+000074a0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+000074b0: 2030 3b20 6920 3c20 6e62 3b20 692b 2b29   0; i < nb; i++)
+000074c0: 207b 0a20 2020 2020 2020 2063 6f6e 7374   {.        const
+000074d0: 2066 6c6f 6174 2064 203d 2078 5b69 5d2e   float d = x[i].
+000074e0: 643b 0a0a 2020 2020 2020 2020 636f 6e73  d;..        cons
+000074f0: 7420 7569 6e74 385f 7420 2a20 7265 7374  t uint8_t * rest
+00007500: 7269 6374 2070 7020 3d20 785b 695d 2e71  rict pp = x[i].q
+00007510: 733b 0a0a 2020 2020 2020 2020 666f 7220  s;..        for 
+00007520: 2869 6e74 206c 203d 2030 3b20 6c20 3c20  (int l = 0; l < 
+00007530: 514b 3b20 6c20 2b3d 2032 2920 7b0a 2020  QK; l += 2) {.  
+00007540: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00007550: 7569 6e74 385f 7420 7669 203d 2070 705b  uint8_t vi = pp[
+00007560: 6c2f 325d 3b0a 0a20 2020 2020 2020 2020  l/2];..         
+00007570: 2020 2063 6f6e 7374 2069 6e74 385f 7420     const int8_t 
+00007580: 7669 3020 3d20 7669 2026 2030 7866 3b0a  vi0 = vi & 0xf;.
+00007590: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000075a0: 7420 696e 7438 5f74 2076 6931 203d 2076  t int8_t vi1 = v
+000075b0: 6920 3e3e 2034 3b0a 0a20 2020 2020 2020  i >> 4;..       
+000075c0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+000075d0: 2076 3020 3d20 2876 6930 202d 2038 292a   v0 = (vi0 - 8)*
+000075e0: 643b 0a20 2020 2020 2020 2020 2020 2063  d;.            c
+000075f0: 6f6e 7374 2066 6c6f 6174 2076 3120 3d20  onst float v1 = 
+00007600: 2876 6931 202d 2038 292a 643b 0a0a 2020  (vi1 - 8)*d;..  
+00007610: 2020 2020 2020 2020 2020 2f2f 7072 696e            //prin
+00007620: 7466 2822 6420 3d20 2566 2c20 7669 203d  tf("d = %f, vi =
+00007630: 2025 642c 2076 6930 203d 2025 642c 2076   %d, vi0 = %d, v
+00007640: 6931 203d 2025 642c 2076 3020 3d20 2566  i1 = %d, v0 = %f
+00007650: 2c20 7631 203d 2025 665c 6e22 2c20 642c  , v1 = %f\n", d,
+00007660: 2076 692c 2076 6930 2c20 7669 312c 2076   vi, vi0, vi1, v
+00007670: 302c 2076 3129 3b0a 0a20 2020 2020 2020  0, v1);..       
+00007680: 2020 2020 2079 5b69 2a51 4b20 2b20 6c20       y[i*QK + l 
+00007690: 2b20 305d 203d 2076 303b 0a20 2020 2020  + 0] = v0;.     
+000076a0: 2020 2020 2020 2079 5b69 2a51 4b20 2b20         y[i*QK + 
+000076b0: 6c20 2b20 315d 203d 2076 313b 0a0a 2020  l + 1] = v1;..  
+000076c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000076d0: 2821 6973 6e61 6e28 795b 692a 514b 202b  (!isnan(y[i*QK +
+000076e0: 206c 202b 2030 5d29 293b 0a20 2020 2020   l + 0]));.     
+000076f0: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
+00007700: 736e 616e 2879 5b69 2a51 4b20 2b20 6c20  snan(y[i*QK + l 
+00007710: 2b20 315d 2929 3b0a 2020 2020 2020 2020  + 1]));.        
+00007720: 7d0a 2020 2020 7d0a 2365 6e64 6966 0a7d  }.    }.#endif.}
+00007730: 0a0a 7374 6174 6963 2076 6f69 6420 6465  ..static void de
+00007740: 7175 616e 7469 7a65 5f72 6f77 5f71 345f  quantize_row_q4_
+00007750: 3128 636f 6e73 7420 766f 6964 202a 2072  1(const void * r
+00007760: 6573 7472 6963 7420 7678 2c20 666c 6f61  estrict vx, floa
+00007770: 7420 2a20 7265 7374 7269 6374 2079 2c20  t * restrict y, 
+00007780: 696e 7420 6b29 207b 0a20 2020 2061 7373  int k) {.    ass
+00007790: 6572 7428 6b20 2520 514b 203d 3d20 3029  ert(k % QK == 0)
+000077a0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000077b0: 6e62 203d 206b 202f 2051 4b3b 0a0a 2020  nb = k / QK;..  
+000077c0: 2020 636f 6e73 7420 626c 6f63 6b5f 7134    const block_q4
+000077d0: 5f31 202a 2072 6573 7472 6963 7420 7820  _1 * restrict x 
+000077e0: 3d20 7678 3b0a 0a23 6966 2064 6566 696e  = vx;..#if defin
+000077f0: 6564 285f 5f41 5658 325f 5f29 0a20 2020  ed(__AVX2__).   
+00007800: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00007810: 2069 203c 206e 623b 2069 2b2b 2920 7b0a   i < nb; i++) {.
+00007820: 2020 2020 2020 2020 636f 6e73 7420 5f5f          const __
+00007830: 6d32 3536 2064 5f76 203d 205f 6d6d 3235  m256 d_v = _mm25
+00007840: 365f 6272 6f61 6463 6173 745f 7373 2826  6_broadcast_ss(&
+00007850: 785b 695d 2e64 293b 0a20 2020 2020 2020  x[i].d);.       
+00007860: 2063 6f6e 7374 205f 5f6d 3235 3620 645f   const __m256 d_
+00007870: 6d20 3d20 5f6d 6d32 3536 5f62 726f 6164  m = _mm256_broad
+00007880: 6361 7374 5f73 7328 2678 5b69 5d2e 6d29  cast_ss(&x[i].m)
+00007890: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
+000078a0: 2075 696e 7438 5f74 202a 2072 6573 7472   uint8_t * restr
+000078b0: 6963 7420 7070 203d 2078 5b69 5d2e 7173  ict pp = x[i].qs
+000078c0: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
+000078d0: 696e 7420 6c20 3d20 303b 206c 203c 2051  int l = 0; l < Q
+000078e0: 4b3b 206c 202b 3d20 3332 2920 7b0a 2020  K; l += 32) {.  
+000078f0: 2020 2020 2020 2020 2020 2f2f 204c 6f61            // Loa
+00007900: 6420 3332 7834 2d62 6974 2069 6e74 6567  d 32x4-bit integ
+00007910: 6572 7320 696e 746f 2033 3278 382d 6269  ers into 32x8-bi
+00007920: 7420 696e 7465 6765 7273 0a20 2020 2020  t integers.     
+00007930: 2020 2020 2020 205f 5f6d 3235 3669 2076         __m256i v
+00007940: 7838 203d 2062 7974 6573 4672 6f6d 4e69  x8 = bytesFromNi
+00007950: 6262 6c65 7328 7070 2b6c 2f32 293b 0a0a  bbles(pp+l/2);..
+00007960: 2020 2020 2020 2020 2020 2020 2f2f 2043              // C
+00007970: 6f6e 7665 7274 2074 6f20 3136 2d62 6974  onvert to 16-bit
+00007980: 2069 6e74 0a20 2020 2020 2020 2020 2020   int.           
+00007990: 2063 6f6e 7374 205f 5f6d 3235 3669 2076   const __m256i v
+000079a0: 7831 365f 6c6f 203d 205f 6d6d 3235 365f  x16_lo = _mm256_
+000079b0: 6376 7465 7069 385f 6570 6931 3628 5f6d  cvtepi8_epi16(_m
+000079c0: 6d32 3536 5f65 7874 7261 6374 6931 3238  m256_extracti128
+000079d0: 5f73 6932 3536 2876 7838 2c20 3029 293b  _si256(vx8, 0));
+000079e0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000079f0: 7374 205f 5f6d 3235 3669 2076 7831 365f  st __m256i vx16_
+00007a00: 6869 203d 205f 6d6d 3235 365f 6376 7465  hi = _mm256_cvte
+00007a10: 7069 385f 6570 6931 3628 5f6d 6d32 3536  pi8_epi16(_mm256
+00007a20: 5f65 7874 7261 6374 6931 3238 5f73 6932  _extracti128_si2
+00007a30: 3536 2876 7838 2c20 3129 293b 0a0a 2020  56(vx8, 1));..  
+00007a40: 2020 2020 2020 2020 2020 2f2f 2043 6f6e            // Con
+00007a50: 7665 7274 2074 6f20 3332 2d62 6974 2069  vert to 32-bit i
+00007a60: 6e74 202d 3e20 666c 6f61 7420 3332 0a20  nt -> float 32. 
+00007a70: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00007a80: 205f 5f6d 3235 3620 7666 5b34 5d20 3d20   __m256 vf[4] = 
+00007a90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00007aa0: 2020 5f6d 6d32 3536 5f63 7674 6570 6933    _mm256_cvtepi3
+00007ab0: 325f 7073 285f 6d6d 3235 365f 6376 7465  2_ps(_mm256_cvte
+00007ac0: 7069 3136 5f65 7069 3332 285f 6d6d 3235  pi16_epi32(_mm25
+00007ad0: 365f 6578 7472 6163 7469 3132 385f 7369  6_extracti128_si
+00007ae0: 3235 3628 7678 3136 5f6c 6f2c 2030 2929  256(vx16_lo, 0))
+00007af0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00007b00: 2020 205f 6d6d 3235 365f 6376 7465 7069     _mm256_cvtepi
+00007b10: 3332 5f70 7328 5f6d 6d32 3536 5f63 7674  32_ps(_mm256_cvt
+00007b20: 6570 6931 365f 6570 6933 3228 5f6d 6d32  epi16_epi32(_mm2
+00007b30: 3536 5f65 7874 7261 6374 6931 3238 5f73  56_extracti128_s
+00007b40: 6932 3536 2876 7831 365f 6c6f 2c20 3129  i256(vx16_lo, 1)
+00007b50: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00007b60: 2020 2020 5f6d 6d32 3536 5f63 7674 6570      _mm256_cvtep
+00007b70: 6933 325f 7073 285f 6d6d 3235 365f 6376  i32_ps(_mm256_cv
+00007b80: 7465 7069 3136 5f65 7069 3332 285f 6d6d  tepi16_epi32(_mm
+00007b90: 3235 365f 6578 7472 6163 7469 3132 385f  256_extracti128_
+00007ba0: 7369 3235 3628 7678 3136 5f68 692c 2030  si256(vx16_hi, 0
+00007bb0: 2929 292c 0a20 2020 2020 2020 2020 2020  ))),.           
+00007bc0: 2020 2020 205f 6d6d 3235 365f 6376 7465       _mm256_cvte
+00007bd0: 7069 3332 5f70 7328 5f6d 6d32 3536 5f63  pi32_ps(_mm256_c
+00007be0: 7674 6570 6931 365f 6570 6933 3228 5f6d  vtepi16_epi32(_m
+00007bf0: 6d32 3536 5f65 7874 7261 6374 6931 3238  m256_extracti128
+00007c00: 5f73 6932 3536 2876 7831 365f 6869 2c20  _si256(vx16_hi, 
+00007c10: 3129 2929 0a20 2020 2020 2020 2020 2020  1))).           
+00007c20: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
+00007c30: 202f 2f20 5363 616c 652c 2061 6464 206d   // Scale, add m
+00007c40: 2061 6e64 2073 746f 7265 0a20 2020 2020   and store.     
+00007c50: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00007c60: 6a20 3d20 303b 206a 203c 2034 3b20 6a2b  j = 0; j < 4; j+
+00007c70: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00007c80: 2020 2020 2063 6f6e 7374 205f 5f6d 3235       const __m25
+00007c90: 3620 7265 7375 6c74 203d 205f 6d6d 3235  6 result = _mm25
+00007ca0: 365f 6164 645f 7073 285f 6d6d 3235 365f  6_add_ps(_mm256_
+00007cb0: 6d75 6c5f 7073 2876 665b 6a5d 2c20 645f  mul_ps(vf[j], d_
+00007cc0: 7629 2c20 645f 6d29 3b0a 2020 2020 2020  v), d_m);.      
+00007cd0: 2020 2020 2020 2020 2020 5f6d 6d32 3536            _mm256
+00007ce0: 5f73 746f 7265 755f 7073 2879 202b 2069  _storeu_ps(y + i
+00007cf0: 202a 2051 4b20 2b20 6c20 2b20 6a2a 382c   * QK + l + j*8,
+00007d00: 2072 6573 756c 7429 3b0a 2020 2020 2020   result);.      
+00007d10: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00007d20: 7d0a 2020 2020 7d0a 2365 6c73 650a 2020  }.    }.#else.  
+00007d30: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00007d40: 3b20 6920 3c20 6e62 3b20 692b 2b29 207b  ; i < nb; i++) {
+00007d50: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
+00007d60: 6c6f 6174 2064 203d 2078 5b69 5d2e 643b  loat d = x[i].d;
+00007d70: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
+00007d80: 6c6f 6174 206d 203d 2078 5b69 5d2e 6d3b  loat m = x[i].m;
+00007d90: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+00007da0: 7569 6e74 385f 7420 2a20 7265 7374 7269  uint8_t * restri
+00007db0: 6374 2070 7020 3d20 785b 695d 2e71 733b  ct pp = x[i].qs;
+00007dc0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+00007dd0: 6e74 206c 203d 2030 3b20 6c20 3c20 514b  nt l = 0; l < QK
+00007de0: 3b20 6c20 2b3d 2032 2920 7b0a 2020 2020  ; l += 2) {.    
+00007df0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+00007e00: 6e74 385f 7420 7669 203d 2070 705b 6c2f  nt8_t vi = pp[l/
+00007e10: 325d 3b0a 0a20 2020 2020 2020 2020 2020  2];..           
+00007e20: 2063 6f6e 7374 2069 6e74 385f 7420 7669   const int8_t vi
+00007e30: 3020 3d20 7669 2026 2030 7866 3b0a 2020  0 = vi & 0xf;.  
+00007e40: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00007e50: 696e 7438 5f74 2076 6931 203d 2076 6920  int8_t vi1 = vi 
+00007e60: 3e3e 2034 3b0a 0a20 2020 2020 2020 2020  >> 4;..         
+00007e70: 2020 2063 6f6e 7374 2066 6c6f 6174 2076     const float v
+00007e80: 3020 3d20 7669 302a 6420 2b20 6d3b 0a20  0 = vi0*d + m;. 
+00007e90: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00007ea0: 2066 6c6f 6174 2076 3120 3d20 7669 312a   float v1 = vi1*
+00007eb0: 6420 2b20 6d3b 0a0a 2020 2020 2020 2020  d + m;..        
+00007ec0: 2020 2020 795b 692a 514b 202b 206c 202b      y[i*QK + l +
+00007ed0: 2030 5d20 3d20 7630 3b0a 2020 2020 2020   0] = v0;.      
+00007ee0: 2020 2020 2020 795b 692a 514b 202b 206c        y[i*QK + l
+00007ef0: 202b 2031 5d20 3d20 7631 3b0a 0a20 2020   + 1] = v1;..   
+00007f00: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+00007f10: 2169 736e 616e 2879 5b69 2a51 4b20 2b20  !isnan(y[i*QK + 
+00007f20: 6c20 2b20 305d 2929 3b0a 2020 2020 2020  l + 0]));.      
+00007f30: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
+00007f40: 6e61 6e28 795b 692a 514b 202b 206c 202b  nan(y[i*QK + l +
+00007f50: 2031 5d29 293b 0a20 2020 2020 2020 207d   1]));.        }
+00007f60: 0a20 2020 207d 0a23 656e 6469 660a 7d0a  .    }.#endif.}.
+00007f70: 0a2f 2f0a 2f2f 2073 696d 6420 6d61 7070  .//.// simd mapp
+00007f80: 696e 6773 0a2f 2f0a 0a2f 2f20 7765 2064  ings.//..// we d
+00007f90: 6566 696e 6520 6120 636f 6d6d 6f6e 2073  efine a common s
+00007fa0: 6574 206f 6620 4320 6d61 6372 6f73 2077  et of C macros w
+00007fb0: 6869 6368 206d 6170 2074 6f20 7370 6563  hich map to spec
+00007fc0: 6966 6963 2069 6e74 7269 6e73 6963 7320  ific intrinsics 
+00007fd0: 6261 7365 6420 6f6e 2074 6865 2063 7572  based on the cur
+00007fe0: 7265 6e74 2061 7263 6869 7465 6374 7572  rent architectur
+00007ff0: 650a 2f2f 2077 6520 7468 656e 2069 6d70  e.// we then imp
+00008000: 6c65 6d65 6e74 2074 6865 2066 756e 6461  lement the funda
+00008010: 6d65 6e74 616c 2063 6f6d 7075 7461 7469  mental computati
+00008020: 6f6e 206f 7065 7261 7469 6f6e 7320 6265  on operations be
+00008030: 6c6f 7720 7573 696e 6720 6f6e 6c79 2074  low using only t
+00008040: 6865 7365 206d 6163 726f 730a 2f2f 2061  hese macros.// a
+00008050: 6464 696e 6720 7375 7070 6f72 7420 666f  dding support fo
+00008060: 7220 6e65 7720 6172 6368 6974 6563 7475  r new architectu
+00008070: 7265 7320 7265 7175 6972 6573 2074 6f20  res requires to 
+00008080: 6465 6669 6e65 2074 6865 2063 6f72 7265  define the corre
+00008090: 7370 6f6e 6469 6e67 2053 494d 4420 6d61  sponding SIMD ma
+000080a0: 6372 6f73 0a2f 2f0a 2f2f 2047 474d 4c5f  cros.//.// GGML_
+000080b0: 4633 325f 5354 4550 202f 2047 474d 4c5f  F32_STEP / GGML_
+000080c0: 4631 365f 5354 4550 0a2f 2f20 2020 6e75  F16_STEP.//   nu
+000080d0: 6d62 6572 206f 6620 656c 656d 656e 7473  mber of elements
+000080e0: 2074 6f20 7072 6f63 6573 7320 696e 2061   to process in a
+000080f0: 2073 696e 676c 6520 7374 6570 0a2f 2f0a   single step.//.
+00008100: 2f2f 2047 474d 4c5f 4633 325f 4550 5220  // GGML_F32_EPR 
+00008110: 2f20 4747 4d4c 5f46 3136 5f45 5052 0a2f  / GGML_F16_EPR./
+00008120: 2f20 2020 6e75 6d62 6572 206f 6620 656c  /   number of el
+00008130: 656d 656e 7473 2074 6f20 6669 7420 696e  ements to fit in
+00008140: 2061 2073 696e 676c 6520 7265 6769 7374   a single regist
+00008150: 6572 0a2f 2f0a 0a23 6966 2064 6566 696e  er.//..#if defin
+00008160: 6564 285f 5f41 524d 5f4e 454f 4e29 2026  ed(__ARM_NEON) &
+00008170: 2620 6465 6669 6e65 6428 5f5f 4152 4d5f  & defined(__ARM_
+00008180: 4645 4154 5552 455f 464d 4129 0a0a 2364  FEATURE_FMA)..#d
+00008190: 6566 696e 6520 4747 4d4c 5f53 494d 440a  efine GGML_SIMD.
+000081a0: 0a2f 2f20 4633 3220 4e45 4f4e 0a0a 2364  .// F32 NEON..#d
+000081b0: 6566 696e 6520 4747 4d4c 5f46 3332 5f53  efine GGML_F32_S
+000081c0: 5445 5020 3136 0a23 6465 6669 6e65 2047  TEP 16.#define G
+000081d0: 474d 4c5f 4633 325f 4550 5220 2034 0a0a  GML_F32_EPR  4..
+000081e0: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
+000081f0: 7834 2020 2020 2020 2020 2020 2020 2020  x4              
+00008200: 666c 6f61 7433 3278 345f 740a 2364 6566  float32x4_t.#def
+00008210: 696e 6520 4747 4d4c 5f46 3332 7834 5f5a  ine GGML_F32x4_Z
+00008220: 4552 4f20 2020 2020 2020 2020 7664 7570  ERO         vdup
+00008230: 715f 6e5f 6633 3228 302e 3066 290a 2364  q_n_f32(0.0f).#d
+00008240: 6566 696e 6520 4747 4d4c 5f46 3332 7834  efine GGML_F32x4
+00008250: 5f53 4554 3128 7829 2020 2020 2020 7664  _SET1(x)      vd
+00008260: 7570 715f 6e5f 6633 3228 7829 0a23 6465  upq_n_f32(x).#de
+00008270: 6669 6e65 2047 474d 4c5f 4633 3278 345f  fine GGML_F32x4_
+00008280: 4c4f 4144 2020 2020 2020 2020 2076 6c64  LOAD         vld
+00008290: 3171 5f66 3332 0a23 6465 6669 6e65 2047  1q_f32.#define G
+000082a0: 474d 4c5f 4633 3278 345f 5354 4f52 4520  GML_F32x4_STORE 
+000082b0: 2020 2020 2020 2076 7374 3171 5f66 3332         vst1q_f32
+000082c0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+000082d0: 3278 345f 464d 4128 612c 2062 2c20 6329  2x4_FMA(a, b, c)
+000082e0: 2076 666d 6171 5f66 3332 2861 2c20 622c   vfmaq_f32(a, b,
+000082f0: 2063 290a 2364 6566 696e 6520 4747 4d4c   c).#define GGML
+00008300: 5f46 3332 7834 5f41 4444 2020 2020 2020  _F32x4_ADD      
+00008310: 2020 2020 7661 6464 715f 6633 320a 2364      vaddq_f32.#d
+00008320: 6566 696e 6520 4747 4d4c 5f46 3332 7834  efine GGML_F32x4
+00008330: 5f4d 554c 2020 2020 2020 2020 2020 766d  _MUL          vm
+00008340: 756c 715f 6633 320a 2369 6620 6465 6669  ulq_f32.#if defi
+00008350: 6e65 6428 5f5f 4152 4d5f 4645 4154 5552  ned(__ARM_FEATUR
+00008360: 455f 5152 444d 5829 0a20 2020 2023 6465  E_QRDMX).    #de
+00008370: 6669 6e65 2047 474d 4c5f 4633 3278 345f  fine GGML_F32x4_
+00008380: 5245 4455 4345 5f4f 4e45 2878 2920 7661  REDUCE_ONE(x) va
+00008390: 6464 7671 5f66 3332 2878 290a 2365 6c73  ddvq_f32(x).#els
+000083a0: 650a 2020 2020 2364 6566 696e 6520 4747  e.    #define GG
+000083b0: 4d4c 5f46 3332 7834 5f52 4544 5543 455f  ML_F32x4_REDUCE_
+000083c0: 4f4e 4528 7829 205c 0a20 2020 2028 7667  ONE(x) \.    (vg
+000083d0: 6574 715f 6c61 6e65 5f66 3332 2878 2c20  etq_lane_f32(x, 
+000083e0: 3029 202b 2020 2020 2020 2020 2020 5c0a  0) +          \.
+000083f0: 2020 2020 2076 6765 7471 5f6c 616e 655f       vgetq_lane_
+00008400: 6633 3228 782c 2031 2920 2b20 2020 2020  f32(x, 1) +     
+00008410: 2020 2020 205c 0a20 2020 2020 7667 6574       \.     vget
+00008420: 715f 6c61 6e65 5f66 3332 2878 2c20 3229  q_lane_f32(x, 2)
+00008430: 202b 2020 2020 2020 2020 2020 5c0a 2020   +          \.  
+00008440: 2020 2076 6765 7471 5f6c 616e 655f 6633     vgetq_lane_f3
+00008450: 3228 782c 2033 2929 0a23 656e 6469 660a  2(x, 3)).#endif.
+00008460: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
+00008470: 7834 5f52 4544 5543 4528 7265 732c 2078  x4_REDUCE(res, x
+00008480: 2920 2020 2020 2020 2020 2020 2020 205c  )              \
+00008490: 0a7b 2020 2020 2020 2020 2020 2020 2020  .{              
+000084a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084c0: 5c0a 2020 2020 666f 7220 2869 6e74 2069  \.    for (int i
+000084d0: 203d 2030 3b20 6920 3c20 4747 4d4c 5f46   = 0; i < GGML_F
+000084e0: 3332 5f41 5252 2f32 3b20 2b2b 6929 207b  32_ARR/2; ++i) {
+000084f0: 205c 0a20 2020 2020 2020 2078 5b32 2a69   \.        x[2*i
+00008500: 5d20 3d20 7661 6464 715f 6633 3228 785b  ] = vaddq_f32(x[
+00008510: 322a 695d 2c20 785b 322a 692b 315d 293b  2*i], x[2*i+1]);
+00008520: 2020 5c0a 2020 2020 7d20 2020 2020 2020    \.    }       
+00008530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008550: 2020 205c 0a20 2020 2066 6f72 2028 696e     \.    for (in
+00008560: 7420 6920 3d20 303b 2069 203c 2047 474d  t i = 0; i < GGM
+00008570: 4c5f 4633 325f 4152 522f 343b 202b 2b69  L_F32_ARR/4; ++i
+00008580: 2920 7b20 5c0a 2020 2020 2020 2020 785b  ) { \.        x[
+00008590: 342a 695d 203d 2076 6164 6471 5f66 3332  4*i] = vaddq_f32
+000085a0: 2878 5b34 2a69 5d2c 2078 5b34 2a69 2b32  (x[4*i], x[4*i+2
+000085b0: 5d29 3b20 205c 0a20 2020 207d 2020 2020  ]);  \.    }    
+000085c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085e0: 2020 2020 2020 5c0a 2020 2020 666f 7220        \.    for 
+000085f0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00008600: 4747 4d4c 5f46 3332 5f41 5252 2f38 3b20  GGML_F32_ARR/8; 
+00008610: 2b2b 6929 207b 205c 0a20 2020 2020 2020  ++i) { \.       
+00008620: 2078 5b38 2a69 5d20 3d20 7661 6464 715f   x[8*i] = vaddq_
+00008630: 6633 3228 785b 382a 695d 2c20 785b 382a  f32(x[8*i], x[8*
+00008640: 692b 345d 293b 2020 5c0a 2020 2020 7d20  i+4]);  \.    } 
+00008650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008670: 2020 2020 2020 2020 205c 0a20 2020 2072           \.    r
+00008680: 6573 203d 2047 474d 4c5f 4633 3278 345f  es = GGML_F32x4_
+00008690: 5245 4455 4345 5f4f 4e45 2878 5b30 5d29  REDUCE_ONE(x[0])
+000086a0: 3b20 2020 2020 2020 2020 5c0a 7d0a 0a23  ;         \.}..#
+000086b0: 6465 6669 6e65 2047 474d 4c5f 4633 325f  define GGML_F32_
+000086c0: 5645 4320 2020 2020 2020 2047 474d 4c5f  VEC        GGML_
+000086d0: 4633 3278 340a 2364 6566 696e 6520 4747  F32x4.#define GG
+000086e0: 4d4c 5f46 3332 5f56 4543 5f5a 4552 4f20  ML_F32_VEC_ZERO 
+000086f0: 2020 4747 4d4c 5f46 3332 7834 5f5a 4552    GGML_F32x4_ZER
+00008700: 4f0a 2364 6566 696e 6520 4747 4d4c 5f46  O.#define GGML_F
+00008710: 3332 5f56 4543 5f53 4554 3120 2020 4747  32_VEC_SET1   GG
+00008720: 4d4c 5f46 3332 7834 5f53 4554 310a 2364  ML_F32x4_SET1.#d
+00008730: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
+00008740: 4543 5f4c 4f41 4420 2020 4747 4d4c 5f46  EC_LOAD   GGML_F
+00008750: 3332 7834 5f4c 4f41 440a 2364 6566 696e  32x4_LOAD.#defin
+00008760: 6520 4747 4d4c 5f46 3332 5f56 4543 5f53  e GGML_F32_VEC_S
+00008770: 544f 5245 2020 4747 4d4c 5f46 3332 7834  TORE  GGML_F32x4
+00008780: 5f53 544f 5245 0a23 6465 6669 6e65 2047  _STORE.#define G
+00008790: 474d 4c5f 4633 325f 5645 435f 464d 4120  GML_F32_VEC_FMA 
+000087a0: 2020 2047 474d 4c5f 4633 3278 345f 464d     GGML_F32x4_FM
+000087b0: 410a 2364 6566 696e 6520 4747 4d4c 5f46  A.#define GGML_F
+000087c0: 3332 5f56 4543 5f41 4444 2020 2020 4747  32_VEC_ADD    GG
+000087d0: 4d4c 5f46 3332 7834 5f41 4444 0a23 6465  ML_F32x4_ADD.#de
+000087e0: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
+000087f0: 435f 4d55 4c20 2020 2047 474d 4c5f 4633  C_MUL    GGML_F3
+00008800: 3278 345f 4d55 4c0a 2364 6566 696e 6520  2x4_MUL.#define 
+00008810: 4747 4d4c 5f46 3332 5f56 4543 5f52 4544  GGML_F32_VEC_RED
+00008820: 5543 4520 4747 4d4c 5f46 3332 7834 5f52  UCE GGML_F32x4_R
+00008830: 4544 5543 450a 0a2f 2f20 4631 3620 4e45  EDUCE..// F16 NE
+00008840: 4f4e 0a0a 2369 6620 6465 6669 6e65 6428  ON..#if defined(
+00008850: 5f5f 4152 4d5f 4645 4154 5552 455f 4650  __ARM_FEATURE_FP
+00008860: 3136 5f56 4543 544f 525f 4152 4954 484d  16_VECTOR_ARITHM
+00008870: 4554 4943 290a 2020 2020 2364 6566 696e  ETIC).    #defin
+00008880: 6520 4747 4d4c 5f46 3136 5f53 5445 5020  e GGML_F16_STEP 
+00008890: 3332 0a20 2020 2023 6465 6669 6e65 2047  32.    #define G
+000088a0: 474d 4c5f 4631 365f 4550 5220 2038 0a0a  GML_F16_EPR  8..
+000088b0: 2020 2020 2364 6566 696e 6520 4747 4d4c      #define GGML
+000088c0: 5f46 3136 7838 2020 2020 2020 2020 2020  _F16x8          
+000088d0: 2020 2020 666c 6f61 7431 3678 385f 740a      float16x8_t.
+000088e0: 2020 2020 2364 6566 696e 6520 4747 4d4c      #define GGML
+000088f0: 5f46 3136 7838 5f5a 4552 4f20 2020 2020  _F16x8_ZERO     
+00008900: 2020 2020 7664 7570 715f 6e5f 6631 3628      vdupq_n_f16(
+00008910: 302e 3066 290a 2020 2020 2364 6566 696e  0.0f).    #defin
+00008920: 6520 4747 4d4c 5f46 3136 7838 5f53 4554  e GGML_F16x8_SET
+00008930: 3128 7829 2020 2020 2020 7664 7570 715f  1(x)      vdupq_
+00008940: 6e5f 6631 3628 7829 0a20 2020 2023 6465  n_f16(x).    #de
+00008950: 6669 6e65 2047 474d 4c5f 4631 3678 385f  fine GGML_F16x8_
+00008960: 4c4f 4144 2020 2020 2020 2020 2076 6c64  LOAD         vld
+00008970: 3171 5f66 3136 0a20 2020 2023 6465 6669  1q_f16.    #defi
+00008980: 6e65 2047 474d 4c5f 4631 3678 385f 5354  ne GGML_F16x8_ST
+00008990: 4f52 4520 2020 2020 2020 2076 7374 3171  ORE        vst1q
+000089a0: 5f66 3136 0a20 2020 2023 6465 6669 6e65  _f16.    #define
+000089b0: 2047 474d 4c5f 4631 3678 385f 464d 4128   GGML_F16x8_FMA(
+000089c0: 612c 2062 2c20 6329 2076 666d 6171 5f66  a, b, c) vfmaq_f
+000089d0: 3136 2861 2c20 622c 2063 290a 2020 2020  16(a, b, c).    
+000089e0: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
+000089f0: 7838 5f41 4444 2020 2020 2020 2020 2020  x8_ADD          
+00008a00: 7661 6464 715f 6631 360a 2020 2020 2364  vaddq_f16.    #d
+00008a10: 6566 696e 6520 4747 4d4c 5f46 3136 7838  efine GGML_F16x8
+00008a20: 5f4d 554c 2020 2020 2020 2020 2020 766d  _MUL          vm
+00008a30: 756c 715f 6631 360a 2020 2020 2364 6566  ulq_f16.    #def
+00008a40: 696e 6520 4747 4d4c 5f46 3136 7838 5f52  ine GGML_F16x8_R
+00008a50: 4544 5543 4528 7265 732c 2078 2920 2020  EDUCE(res, x)   
+00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a70: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+00008a80: 7b20 2020 2020 2020 2020 2020 2020 2020  {               
+00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ac0: 2020 2020 5c0a 2020 2020 666f 7220 2869      \.    for (i
-00008ad0: 6e74 2069 203d 2030 3b20 6920 3c20 4747  nt i = 0; i < GG
-00008ae0: 4d4c 5f46 3136 5f41 5252 2f34 3b20 2b2b  ML_F16_ARR/4; ++
-00008af0: 6929 207b 2020 2020 205c 0a20 2020 2020  i) {     \.     
-00008b00: 2020 2078 5b34 2a69 5d20 3d20 7761 736d     x[4*i] = wasm
-00008b10: 5f66 3332 7834 5f61 6464 2878 5b34 2a69  _f32x4_add(x[4*i
-00008b20: 5d2c 2078 5b34 2a69 2b32 5d29 3b20 5c0a  ], x[4*i+2]); \.
-00008b30: 2020 2020 7d20 2020 2020 2020 2020 2020      }           
-00008b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b60: 2020 205c 0a20 2020 2066 6f72 2028 696e     \.    for (in
-00008b70: 7420 6920 3d20 303b 2069 203c 2047 474d  t i = 0; i < GGM
-00008b80: 4c5f 4631 365f 4152 522f 383b 202b 2b69  L_F16_ARR/8; ++i
-00008b90: 2920 7b20 2020 2020 5c0a 2020 2020 2020  ) {     \.      
-00008ba0: 2020 785b 382a 695d 203d 2077 6173 6d5f    x[8*i] = wasm_
-00008bb0: 6633 3278 345f 6164 6428 785b 382a 695d  f32x4_add(x[8*i]
-00008bc0: 2c20 785b 382a 692b 345d 293b 205c 0a20  , x[8*i+4]); \. 
-00008bd0: 2020 207d 2020 2020 2020 2020 2020 2020     }            
-00008be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c00: 2020 5c0a 2020 2020 7265 7320 3d20 7761    \.    res = wa
-00008c10: 736d 5f66 3332 7834 5f65 7874 7261 6374  sm_f32x4_extract
-00008c20: 5f6c 616e 6528 785b 305d 2c20 3029 202b  _lane(x[0], 0) +
-00008c30: 2020 2020 2020 205c 0a20 2020 2020 2020         \.       
-00008c40: 2020 2077 6173 6d5f 6633 3278 345f 6578     wasm_f32x4_ex
-00008c50: 7472 6163 745f 6c61 6e65 2878 5b30 5d2c  tract_lane(x[0],
-00008c60: 2031 2920 2b20 2020 2020 2020 5c0a 2020   1) +       \.  
-00008c70: 2020 2020 2020 2020 7761 736d 5f66 3332          wasm_f32
-00008c80: 7834 5f65 7874 7261 6374 5f6c 616e 6528  x4_extract_lane(
-00008c90: 785b 305d 2c20 3229 202b 2020 2020 2020  x[0], 2) +      
-00008ca0: 205c 0a20 2020 2020 2020 2020 2077 6173   \.          was
-00008cb0: 6d5f 6633 3278 345f 6578 7472 6163 745f  m_f32x4_extract_
-00008cc0: 6c61 6e65 2878 5b30 5d2c 2033 293b 2020  lane(x[0], 3);  
-00008cd0: 2020 2020 2020 5c0a 7d0a 0a23 6465 6669        \.}..#defi
-00008ce0: 6e65 2047 474d 4c5f 4631 365f 5645 4320  ne GGML_F16_VEC 
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00008d00: 474d 4c5f 4631 3678 340a 2364 6566 696e  GML_F16x4.#defin
-00008d10: 6520 4747 4d4c 5f46 3136 5f56 4543 5f5a  e GGML_F16_VEC_Z
-00008d20: 4552 4f20 2020 2020 2020 2020 2020 4747  ERO           GG
-00008d30: 4d4c 5f46 3136 7834 5f5a 4552 4f0a 2364  ML_F16x4_ZERO.#d
-00008d40: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
-00008d50: 4543 5f53 4554 3120 2020 2020 2020 2020  EC_SET1         
-00008d60: 2020 4747 4d4c 5f46 3136 7834 5f53 4554    GGML_F16x4_SET
-00008d70: 310a 2364 6566 696e 6520 4747 4d4c 5f46  1.#define GGML_F
-00008d80: 3136 5f56 4543 5f4c 4f41 4428 702c 2069  16_VEC_LOAD(p, i
-00008d90: 2920 2020 2020 4747 4d4c 5f46 3136 7834  )     GGML_F16x4
-00008da0: 5f4c 4f41 4428 7029 0a23 6465 6669 6e65  _LOAD(p).#define
-00008db0: 2047 474d 4c5f 4631 365f 5645 435f 5354   GGML_F16_VEC_ST
-00008dc0: 4f52 4528 702c 2072 2c20 6929 2047 474d  ORE(p, r, i) GGM
-00008dd0: 4c5f 4631 3678 345f 5354 4f52 4528 702c  L_F16x4_STORE(p,
-00008de0: 2072 5b69 5d29 0a23 6465 6669 6e65 2047   r[i]).#define G
-00008df0: 474d 4c5f 4631 365f 5645 435f 464d 4120  GML_F16_VEC_FMA 
-00008e00: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00008e10: 4631 3678 345f 464d 410a 2364 6566 696e  F16x4_FMA.#defin
-00008e20: 6520 4747 4d4c 5f46 3136 5f56 4543 5f41  e GGML_F16_VEC_A
-00008e30: 4444 2020 2020 2020 2020 2020 2020 4747  DD            GG
-00008e40: 4d4c 5f46 3136 7834 5f41 4444 0a23 6465  ML_F16x4_ADD.#de
-00008e50: 6669 6e65 2047 474d 4c5f 4631 365f 5645  fine GGML_F16_VE
-00008e60: 435f 4d55 4c20 2020 2020 2020 2020 2020  C_MUL           
-00008e70: 2047 474d 4c5f 4631 3678 345f 4d55 4c0a   GGML_F16x4_MUL.
-00008e80: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
-00008e90: 5f56 4543 5f52 4544 5543 4520 2020 2020  _VEC_REDUCE     
-00008ea0: 2020 2020 4747 4d4c 5f46 3136 7834 5f52      GGML_F16x4_R
-00008eb0: 4544 5543 450a 0a23 656c 6966 2064 6566  EDUCE..#elif def
-00008ec0: 696e 6564 285f 5f53 5345 335f 5f29 0a0a  ined(__SSE3__)..
-00008ed0: 2364 6566 696e 6520 4747 4d4c 5f53 494d  #define GGML_SIM
-00008ee0: 440a 0a2f 2f20 4633 3220 5353 450a 0a23  D..// F32 SSE..#
-00008ef0: 6465 6669 6e65 2047 474d 4c5f 4633 325f  define GGML_F32_
-00008f00: 5354 4550 2033 320a 2364 6566 696e 6520  STEP 32.#define 
-00008f10: 4747 4d4c 5f46 3332 5f45 5052 2020 340a  GGML_F32_EPR  4.
-00008f20: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00008f30: 3278 3420 2020 2020 2020 2020 5f5f 6d31  2x4         __m1
-00008f40: 3238 0a23 6465 6669 6e65 2047 474d 4c5f  28.#define GGML_
-00008f50: 4633 3278 345f 5a45 524f 2020 2020 5f6d  F32x4_ZERO    _m
-00008f60: 6d5f 7365 747a 6572 6f5f 7073 2829 0a23  m_setzero_ps().#
-00008f70: 6465 6669 6e65 2047 474d 4c5f 4633 3278  define GGML_F32x
-00008f80: 345f 5345 5431 2878 2920 5f6d 6d5f 7365  4_SET1(x) _mm_se
-00008f90: 7431 5f70 7328 7829 0a23 6465 6669 6e65  t1_ps(x).#define
-00008fa0: 2047 474d 4c5f 4633 3278 345f 4c4f 4144   GGML_F32x4_LOAD
-00008fb0: 2020 2020 5f6d 6d5f 6c6f 6164 755f 7073      _mm_loadu_ps
-00008fc0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
-00008fd0: 3278 345f 5354 4f52 4520 2020 5f6d 6d5f  2x4_STORE   _mm_
-00008fe0: 7374 6f72 6575 5f70 730a 2369 6620 6465  storeu_ps.#if de
-00008ff0: 6669 6e65 6428 5f5f 464d 415f 5f29 0a20  fined(__FMA__). 
-00009000: 2020 202f 2f20 544f 444f 3a20 446f 6573     // TODO: Does
-00009010: 2074 6869 7320 776f 726b 3f0a 2020 2020   this work?.    
-00009020: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-00009030: 7834 5f46 4d41 2861 2c20 622c 2063 2920  x4_FMA(a, b, c) 
-00009040: 5f6d 6d5f 666d 6164 645f 7073 2862 2c20  _mm_fmadd_ps(b, 
-00009050: 632c 2061 290a 2365 6c73 650a 2020 2020  c, a).#else.    
-00009060: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-00009070: 7834 5f46 4d41 2861 2c20 622c 2063 2920  x4_FMA(a, b, c) 
-00009080: 5f6d 6d5f 6164 645f 7073 285f 6d6d 5f6d  _mm_add_ps(_mm_m
-00009090: 756c 5f70 7328 622c 2063 292c 2061 290a  ul_ps(b, c), a).
-000090a0: 2365 6e64 6966 0a23 6465 6669 6e65 2047  #endif.#define G
-000090b0: 474d 4c5f 4633 3278 345f 4144 4420 2020  GML_F32x4_ADD   
-000090c0: 2020 5f6d 6d5f 6164 645f 7073 0a23 6465    _mm_add_ps.#de
-000090d0: 6669 6e65 2047 474d 4c5f 4633 3278 345f  fine GGML_F32x4_
-000090e0: 4d55 4c20 2020 2020 5f6d 6d5f 6d75 6c5f  MUL     _mm_mul_
-000090f0: 7073 0a23 6465 6669 6e65 2047 474d 4c5f  ps.#define GGML_
-00009100: 4633 3278 345f 5245 4455 4345 2872 6573  F32x4_REDUCE(res
-00009110: 2c20 7829 2020 2020 2020 2020 2020 2020  , x)            
-00009120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009130: 2020 2020 205c 0a7b 2020 2020 2020 2020       \.{        
-00009140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009170: 2020 2020 2020 2020 205c 0a20 2020 2066           \.    f
-00009180: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00009190: 203c 2047 474d 4c5f 4633 325f 4152 522f   < GGML_F32_ARR/
-000091a0: 323b 202b 2b69 2920 7b20 2020 2020 2020  2; ++i) {       
-000091b0: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
-000091c0: 2020 2020 2020 2078 5b32 2a69 5d20 3d20         x[2*i] = 
-000091d0: 5f6d 6d5f 6164 645f 7073 2878 5b32 2a69  _mm_add_ps(x[2*i
-000091e0: 5d2c 2078 5b32 2a69 2b31 5d29 3b20 2020  ], x[2*i+1]);   
-000091f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009200: 205c 0a20 2020 207d 2020 2020 2020 2020   \.    }        
-00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009240: 2020 2020 205c 0a20 2020 2066 6f72 2028       \.    for (
-00009250: 696e 7420 6920 3d20 303b 2069 203c 2047  int i = 0; i < G
-00009260: 474d 4c5f 4633 325f 4152 522f 343b 202b  GML_F32_ARR/4; +
-00009270: 2b69 2920 7b20 2020 2020 2020 2020 2020  +i) {           
-00009280: 2020 2020 2020 2020 205c 0a20 2020 2020           \.     
-00009290: 2020 2078 5b34 2a69 5d20 3d20 5f6d 6d5f     x[4*i] = _mm_
-000092a0: 6164 645f 7073 2878 5b34 2a69 5d2c 2078  add_ps(x[4*i], x
-000092b0: 5b34 2a69 2b32 5d29 3b20 2020 2020 2020  [4*i+2]);       
-000092c0: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
-000092d0: 2020 207d 2020 2020 2020 2020 2020 2020     }            
-000092e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009310: 205c 0a20 2020 2066 6f72 2028 696e 7420   \.    for (int 
-00009320: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
-00009330: 4633 325f 4152 522f 383b 202b 2b69 2920  F32_ARR/8; ++i) 
-00009340: 7b20 2020 2020 2020 2020 2020 2020 2020  {               
-00009350: 2020 2020 205c 0a20 2020 2020 2020 2078       \.        x
-00009360: 5b38 2a69 5d20 3d20 5f6d 6d5f 6164 645f  [8*i] = _mm_add_
-00009370: 7073 2878 5b38 2a69 5d2c 2078 5b38 2a69  ps(x[8*i], x[8*i
-00009380: 2b34 5d29 3b20 2020 2020 2020 2020 2020  +4]);           
-00009390: 2020 2020 2020 2020 205c 0a20 2020 207d           \.    }
-000093a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093d0: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
-000093e0: 2020 2063 6f6e 7374 205f 5f6d 3132 3820     const __m128 
-000093f0: 7430 203d 205f 6d6d 5f68 6164 645f 7073  t0 = _mm_hadd_ps
-00009400: 2878 5b30 5d2c 2078 5b30 5d29 3b20 2020  (x[0], x[0]);   
-00009410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009420: 205c 0a20 2020 2072 6573 203d 205f 6d6d   \.    res = _mm
-00009430: 5f63 7674 7373 5f66 3332 285f 6d6d 5f68  _cvtss_f32(_mm_h
-00009440: 6164 645f 7073 2874 302c 2074 3029 293b  add_ps(t0, t0));
-00009450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009460: 2020 2020 205c 0a7d 0a2f 2f20 544f 444f       \.}.// TODO
-00009470: 3a20 6973 2074 6869 7320 6f70 7469 6d61  : is this optima
-00009480: 6c20 3f0a 0a23 6465 6669 6e65 2047 474d  l ?..#define GGM
-00009490: 4c5f 4633 325f 5645 4320 2020 2020 2020  L_F32_VEC       
-000094a0: 2047 474d 4c5f 4633 3278 340a 2364 6566   GGML_F32x4.#def
-000094b0: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
-000094c0: 5f5a 4552 4f20 2020 4747 4d4c 5f46 3332  _ZERO   GGML_F32
-000094d0: 7834 5f5a 4552 4f0a 2364 6566 696e 6520  x4_ZERO.#define 
-000094e0: 4747 4d4c 5f46 3332 5f56 4543 5f53 4554  GGML_F32_VEC_SET
-000094f0: 3120 2020 4747 4d4c 5f46 3332 7834 5f53  1   GGML_F32x4_S
-00009500: 4554 310a 2364 6566 696e 6520 4747 4d4c  ET1.#define GGML
-00009510: 5f46 3332 5f56 4543 5f4c 4f41 4420 2020  _F32_VEC_LOAD   
-00009520: 4747 4d4c 5f46 3332 7834 5f4c 4f41 440a  GGML_F32x4_LOAD.
-00009530: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
-00009540: 5f56 4543 5f53 544f 5245 2020 4747 4d4c  _VEC_STORE  GGML
-00009550: 5f46 3332 7834 5f53 544f 5245 0a23 6465  _F32x4_STORE.#de
-00009560: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
-00009570: 435f 464d 4120 2020 2047 474d 4c5f 4633  C_FMA    GGML_F3
-00009580: 3278 345f 464d 410a 2364 6566 696e 6520  2x4_FMA.#define 
-00009590: 4747 4d4c 5f46 3332 5f56 4543 5f41 4444  GGML_F32_VEC_ADD
-000095a0: 2020 2020 4747 4d4c 5f46 3332 7834 5f41      GGML_F32x4_A
-000095b0: 4444 0a23 6465 6669 6e65 2047 474d 4c5f  DD.#define GGML_
-000095c0: 4633 325f 5645 435f 4d55 4c20 2020 2047  F32_VEC_MUL    G
-000095d0: 474d 4c5f 4633 3278 345f 4d55 4c0a 2364  GML_F32x4_MUL.#d
-000095e0: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
-000095f0: 4543 5f52 4544 5543 4520 4747 4d4c 5f46  EC_REDUCE GGML_F
-00009600: 3332 7834 5f52 4544 5543 450a 0a2f 2f20  32x4_REDUCE..// 
-00009610: 4631 3620 5353 450a 0a23 6465 6669 6e65  F16 SSE..#define
-00009620: 2047 474d 4c5f 4631 365f 5354 4550 2033   GGML_F16_STEP 3
-00009630: 320a 2364 6566 696e 6520 4747 4d4c 5f46  2.#define GGML_F
-00009640: 3136 5f45 5052 2020 340a 0a73 7461 7469  16_EPR  4..stati
-00009650: 6320 696e 6c69 6e65 205f 5f6d 3132 3820  c inline __m128 
-00009660: 5f5f 7373 655f 6631 3678 345f 6c6f 6164  __sse_f16x4_load
-00009670: 2867 676d 6c5f 6670 3136 5f74 202a 7829  (ggml_fp16_t *x)
-00009680: 207b 0a20 2020 2066 6c6f 6174 2074 6d70   {.    float tmp
-00009690: 5b34 5d3b 0a0a 2020 2020 746d 705b 305d  [4];..    tmp[0]
-000096a0: 203d 2047 474d 4c5f 4650 3136 5f54 4f5f   = GGML_FP16_TO_
-000096b0: 4650 3332 2878 5b30 5d29 3b0a 2020 2020  FP32(x[0]);.    
-000096c0: 746d 705b 315d 203d 2047 474d 4c5f 4650  tmp[1] = GGML_FP
-000096d0: 3136 5f54 4f5f 4650 3332 2878 5b31 5d29  16_TO_FP32(x[1])
-000096e0: 3b0a 2020 2020 746d 705b 325d 203d 2047  ;.    tmp[2] = G
-000096f0: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
-00009700: 2878 5b32 5d29 3b0a 2020 2020 746d 705b  (x[2]);.    tmp[
-00009710: 335d 203d 2047 474d 4c5f 4650 3136 5f54  3] = GGML_FP16_T
-00009720: 4f5f 4650 3332 2878 5b33 5d29 3b0a 0a20  O_FP32(x[3]);.. 
-00009730: 2020 2072 6574 7572 6e20 5f6d 6d5f 6c6f     return _mm_lo
-00009740: 6164 755f 7073 2874 6d70 293b 0a7d 0a0a  adu_ps(tmp);.}..
-00009750: 7374 6174 6963 2069 6e6c 696e 6520 766f  static inline vo
-00009760: 6964 205f 5f73 7365 5f66 3136 7834 5f73  id __sse_f16x4_s
-00009770: 746f 7265 2867 676d 6c5f 6670 3136 5f74  tore(ggml_fp16_t
-00009780: 202a 782c 205f 5f6d 3132 3820 7929 207b   *x, __m128 y) {
-00009790: 0a20 2020 2066 6c6f 6174 2061 7272 5b34  .    float arr[4
-000097a0: 5d3b 0a0a 2020 2020 5f6d 6d5f 7374 6f72  ];..    _mm_stor
-000097b0: 6575 5f70 7328 6172 722c 2079 293b 0a0a  eu_ps(arr, y);..
-000097c0: 2020 2020 785b 305d 203d 2047 474d 4c5f      x[0] = GGML_
-000097d0: 4650 3332 5f54 4f5f 4650 3136 2861 7272  FP32_TO_FP16(arr
-000097e0: 5b30 5d29 3b0a 2020 2020 785b 315d 203d  [0]);.    x[1] =
-000097f0: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
-00009800: 3136 2861 7272 5b31 5d29 3b0a 2020 2020  16(arr[1]);.    
-00009810: 785b 325d 203d 2047 474d 4c5f 4650 3332  x[2] = GGML_FP32
-00009820: 5f54 4f5f 4650 3136 2861 7272 5b32 5d29  _TO_FP16(arr[2])
-00009830: 3b0a 2020 2020 785b 335d 203d 2047 474d  ;.    x[3] = GGM
-00009840: 4c5f 4650 3332 5f54 4f5f 4650 3136 2861  L_FP32_TO_FP16(a
-00009850: 7272 5b33 5d29 3b0a 7d0a 0a23 6465 6669  rr[3]);.}..#defi
-00009860: 6e65 2047 474d 4c5f 4633 3243 7834 2020  ne GGML_F32Cx4  
-00009870: 2020 2020 2020 2020 2020 205f 5f6d 3132             __m12
-00009880: 380a 2364 6566 696e 6520 4747 4d4c 5f46  8.#define GGML_F
-00009890: 3332 4378 345f 5a45 524f 2020 2020 2020  32Cx4_ZERO      
-000098a0: 2020 5f6d 6d5f 7365 747a 6572 6f5f 7073    _mm_setzero_ps
-000098b0: 2829 0a23 6465 6669 6e65 2047 474d 4c5f  ().#define GGML_
-000098c0: 4633 3243 7834 5f53 4554 3128 7829 2020  F32Cx4_SET1(x)  
-000098d0: 2020 205f 6d6d 5f73 6574 315f 7073 2878     _mm_set1_ps(x
-000098e0: 290a 2364 6566 696e 6520 4747 4d4c 5f46  ).#define GGML_F
-000098f0: 3332 4378 345f 4c4f 4144 2878 2920 2020  32Cx4_LOAD(x)   
-00009900: 2020 5f5f 7373 655f 6631 3678 345f 6c6f    __sse_f16x4_lo
-00009910: 6164 2878 290a 2364 6566 696e 6520 4747  ad(x).#define GG
-00009920: 4d4c 5f46 3332 4378 345f 5354 4f52 4528  ML_F32Cx4_STORE(
-00009930: 782c 2079 2920 5f5f 7373 655f 6631 3678  x, y) __sse_f16x
-00009940: 345f 7374 6f72 6528 782c 2079 290a 2364  4_store(x, y).#d
-00009950: 6566 696e 6520 4747 4d4c 5f46 3332 4378  efine GGML_F32Cx
-00009960: 345f 464d 4120 2020 2020 2020 2020 4747  4_FMA         GG
-00009970: 4d4c 5f46 3332 7834 5f46 4d41 0a23 6465  ML_F32x4_FMA.#de
-00009980: 6669 6e65 2047 474d 4c5f 4633 3243 7834  fine GGML_F32Cx4
-00009990: 5f41 4444 2020 2020 2020 2020 205f 6d6d  _ADD         _mm
-000099a0: 5f61 6464 5f70 730a 2364 6566 696e 6520  _add_ps.#define 
-000099b0: 4747 4d4c 5f46 3332 4378 345f 4d55 4c20  GGML_F32Cx4_MUL 
-000099c0: 2020 2020 2020 2020 5f6d 6d5f 6d75 6c5f          _mm_mul_
-000099d0: 7073 0a23 6465 6669 6e65 2047 474d 4c5f  ps.#define GGML_
-000099e0: 4633 3243 7834 5f52 4544 5543 4520 2020  F32Cx4_REDUCE   
-000099f0: 2020 2047 474d 4c5f 4633 3278 345f 5245     GGML_F32x4_RE
-00009a00: 4455 4345 0a0a 2364 6566 696e 6520 4747  DUCE..#define GG
-00009a10: 4d4c 5f46 3136 5f56 4543 2020 2020 2020  ML_F16_VEC      
-00009a20: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00009a30: 4633 3243 7834 0a23 6465 6669 6e65 2047  F32Cx4.#define G
-00009a40: 474d 4c5f 4631 365f 5645 435f 5a45 524f  GML_F16_VEC_ZERO
-00009a50: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00009a60: 5f46 3332 4378 345f 5a45 524f 0a23 6465  _F32Cx4_ZERO.#de
-00009a70: 6669 6e65 2047 474d 4c5f 4631 365f 5645  fine GGML_F16_VE
-00009a80: 435f 5345 5431 2020 2020 2020 2020 2020  C_SET1          
-00009a90: 2020 4747 4d4c 5f46 3332 4378 345f 5345    GGML_F32Cx4_SE
-00009aa0: 5431 0a23 6465 6669 6e65 2047 474d 4c5f  T1.#define GGML_
-00009ab0: 4631 365f 5645 435f 4c4f 4144 2870 2c20  F16_VEC_LOAD(p, 
-00009ac0: 6929 2020 2020 2020 4747 4d4c 5f46 3332  i)      GGML_F32
-00009ad0: 4378 345f 4c4f 4144 2870 290a 2364 6566  Cx4_LOAD(p).#def
-00009ae0: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
-00009af0: 5f53 544f 5245 2870 2c20 722c 2069 2920  _STORE(p, r, i) 
-00009b00: 2047 474d 4c5f 4633 3243 7834 5f53 544f   GGML_F32Cx4_STO
-00009b10: 5245 2870 2c20 725b 695d 290a 2364 6566  RE(p, r[i]).#def
-00009b20: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
-00009b30: 5f46 4d41 2020 2020 2020 2020 2020 2020  _FMA            
-00009b40: 2047 474d 4c5f 4633 3243 7834 5f46 4d41   GGML_F32Cx4_FMA
-00009b50: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
-00009b60: 365f 5645 435f 4144 4420 2020 2020 2020  6_VEC_ADD       
-00009b70: 2020 2020 2020 4747 4d4c 5f46 3332 4378        GGML_F32Cx
-00009b80: 345f 4144 440a 2364 6566 696e 6520 4747  4_ADD.#define GG
-00009b90: 4d4c 5f46 3136 5f56 4543 5f4d 554c 2020  ML_F16_VEC_MUL  
-00009ba0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00009bb0: 4633 3243 7834 5f4d 554c 0a23 6465 6669  F32Cx4_MUL.#defi
-00009bc0: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
-00009bd0: 5245 4455 4345 2020 2020 2020 2020 2020  REDUCE          
-00009be0: 4747 4d4c 5f46 3332 4378 345f 5245 4455  GGML_F32Cx4_REDU
-00009bf0: 4345 0a0a 2365 6e64 6966 0a0a 2f2f 2047  CE..#endif..// G
-00009c00: 474d 4c5f 4633 325f 4152 5220 2f20 4747  GML_F32_ARR / GG
-00009c10: 4d4c 5f46 3136 5f41 5252 0a2f 2f20 2020  ML_F16_ARR.//   
-00009c20: 6e75 6d62 6572 206f 6620 7265 6769 7374  number of regist
-00009c30: 6572 7320 746f 2075 7365 2070 6572 2073  ers to use per s
-00009c40: 7465 700a 2369 6664 6566 2047 474d 4c5f  tep.#ifdef GGML_
-00009c50: 5349 4d44 0a23 6465 6669 6e65 2047 474d  SIMD.#define GGM
-00009c60: 4c5f 4633 325f 4152 5220 2847 474d 4c5f  L_F32_ARR (GGML_
-00009c70: 4633 325f 5354 4550 2f47 474d 4c5f 4633  F32_STEP/GGML_F3
-00009c80: 325f 4550 5229 0a23 6465 6669 6e65 2047  2_EPR).#define G
-00009c90: 474d 4c5f 4631 365f 4152 5220 2847 474d  GML_F16_ARR (GGM
-00009ca0: 4c5f 4631 365f 5354 4550 2f47 474d 4c5f  L_F16_STEP/GGML_
-00009cb0: 4631 365f 4550 5229 0a23 656e 6469 660a  F16_EPR).#endif.
-00009cc0: 0a2f 2f0a 2f2f 2066 756e 6461 6d65 6e74  .//.// fundament
-00009cd0: 616c 206f 7065 7261 7469 6f6e 730a 2f2f  al operations.//
-00009ce0: 0a0a 696e 6c69 6e65 2073 7461 7469 6320  ..inline static 
-00009cf0: 766f 6964 2067 676d 6c5f 7665 635f 7365  void ggml_vec_se
-00009d00: 745f 6938 2863 6f6e 7374 2069 6e74 206e  t_i8(const int n
-00009d10: 2c20 696e 7438 5f74 202a 2078 2c20 636f  , int8_t * x, co
-00009d20: 6e73 7420 696e 7438 5f74 2076 2920 7b20  nst int8_t v) { 
-00009d30: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00009d40: 6920 3c20 6e3b 202b 2b69 2920 785b 695d  i < n; ++i) x[i]
-00009d50: 203d 2076 3b20 7d0a 0a69 6e6c 696e 6520   = v; }..inline 
-00009d60: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00009d70: 5f76 6563 5f73 6574 5f69 3136 2863 6f6e  _vec_set_i16(con
-00009d80: 7374 2069 6e74 206e 2c20 696e 7431 365f  st int n, int16_
-00009d90: 7420 2a20 782c 2063 6f6e 7374 2069 6e74  t * x, const int
-00009da0: 3136 5f74 2076 2920 7b20 666f 7220 2869  16_t v) { for (i
-00009db0: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
-00009dc0: 202b 2b69 2920 785b 695d 203d 2076 3b20   ++i) x[i] = v; 
-00009dd0: 7d0a 0a69 6e6c 696e 6520 7374 6174 6963  }..inline static
-00009de0: 2076 6f69 6420 6767 6d6c 5f76 6563 5f73   void ggml_vec_s
-00009df0: 6574 5f69 3332 2863 6f6e 7374 2069 6e74  et_i32(const int
-00009e00: 206e 2c20 696e 7433 325f 7420 2a20 782c   n, int32_t * x,
-00009e10: 2063 6f6e 7374 2069 6e74 3332 5f74 2076   const int32_t v
-00009e20: 2920 7b20 666f 7220 2869 6e74 2069 203d  ) { for (int i =
-00009e30: 2030 3b20 6920 3c20 6e3b 202b 2b69 2920   0; i < n; ++i) 
-00009e40: 785b 695d 203d 2076 3b20 7d0a 0a69 6e6c  x[i] = v; }..inl
-00009e50: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
-00009e60: 6767 6d6c 5f76 6563 5f73 6574 5f66 3136  ggml_vec_set_f16
-00009e70: 2863 6f6e 7374 2069 6e74 206e 2c20 6767  (const int n, gg
-00009e80: 6d6c 5f66 7031 365f 7420 2a20 782c 2063  ml_fp16_t * x, c
-00009e90: 6f6e 7374 2069 6e74 3332 5f74 2076 2920  onst int32_t v) 
-00009ea0: 7b20 666f 7220 2869 6e74 2069 203d 2030  { for (int i = 0
-00009eb0: 3b20 6920 3c20 6e3b 202b 2b69 2920 785b  ; i < n; ++i) x[
-00009ec0: 695d 203d 2076 3b20 7d0a 0a69 6e6c 696e  i] = v; }..inlin
-00009ed0: 6520 7374 6174 6963 2076 6f69 6420 6767  e static void gg
-00009ee0: 6d6c 5f76 6563 5f61 6464 5f66 3332 2028  ml_vec_add_f32 (
-00009ef0: 636f 6e73 7420 696e 7420 6e2c 2066 6c6f  const int n, flo
-00009f00: 6174 202a 207a 2c20 636f 6e73 7420 666c  at * z, const fl
-00009f10: 6f61 7420 2a20 782c 2063 6f6e 7374 2066  oat * x, const f
-00009f20: 6c6f 6174 202a 2079 2920 7b20 666f 7220  loat * y) { for 
-00009f30: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00009f40: 6e3b 202b 2b69 2920 7a5b 695d 2020 3d20  n; ++i) z[i]  = 
-00009f50: 785b 695d 202b 2079 5b69 5d3b 207d 0a69  x[i] + y[i]; }.i
-00009f60: 6e6c 696e 6520 7374 6174 6963 2076 6f69  nline static voi
-00009f70: 6420 6767 6d6c 5f76 6563 5f61 6363 5f66  d ggml_vec_acc_f
-00009f80: 3332 2028 636f 6e73 7420 696e 7420 6e2c  32 (const int n,
-00009f90: 2066 6c6f 6174 202a 2079 2c20 636f 6e73   float * y, cons
-00009fa0: 7420 666c 6f61 7420 2a20 7829 2020 2020  t float * x)    
-00009fb0: 2020 2020 2020 2020 2020 2020 2020 7b20                { 
-00009fc0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00009fd0: 6920 3c20 6e3b 202b 2b69 2920 795b 695d  i < n; ++i) y[i]
-00009fe0: 202b 3d20 785b 695d 3b20 2020 2020 2020   += x[i];       
-00009ff0: 207d 0a69 6e6c 696e 6520 7374 6174 6963   }.inline static
-0000a000: 2076 6f69 6420 6767 6d6c 5f76 6563 5f61   void ggml_vec_a
-0000a010: 6363 315f 6633 3228 636f 6e73 7420 696e  cc1_f32(const in
-0000a020: 7420 6e2c 2066 6c6f 6174 202a 2079 2c20  t n, float * y, 
-0000a030: 636f 6e73 7420 666c 6f61 7420 2020 7629  const float   v)
-0000a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a050: 2020 7b20 666f 7220 2869 6e74 2069 203d    { for (int i =
-0000a060: 2030 3b20 6920 3c20 6e3b 202b 2b69 2920   0; i < n; ++i) 
-0000a070: 795b 695d 202b 3d20 763b 2020 2020 2020  y[i] += v;      
-0000a080: 2020 2020 207d 0a69 6e6c 696e 6520 7374       }.inline st
-0000a090: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
-0000a0a0: 6563 5f73 7562 5f66 3332 2028 636f 6e73  ec_sub_f32 (cons
-0000a0b0: 7420 696e 7420 6e2c 2066 6c6f 6174 202a  t int n, float *
-0000a0c0: 207a 2c20 636f 6e73 7420 666c 6f61 7420   z, const float 
-0000a0d0: 2a20 782c 2063 6f6e 7374 2066 6c6f 6174  * x, const float
-0000a0e0: 202a 2079 2920 7b20 666f 7220 2869 6e74   * y) { for (int
-0000a0f0: 2069 203d 2030 3b20 6920 3c20 6e3b 202b   i = 0; i < n; +
-0000a100: 2b69 2920 7a5b 695d 2020 3d20 785b 695d  +i) z[i]  = x[i]
-0000a110: 202d 2079 5b69 5d3b 207d 0a69 6e6c 696e   - y[i]; }.inlin
-0000a120: 6520 7374 6174 6963 2076 6f69 6420 6767  e static void gg
-0000a130: 6d6c 5f76 6563 5f73 6574 5f66 3332 2028  ml_vec_set_f32 (
-0000a140: 636f 6e73 7420 696e 7420 6e2c 2066 6c6f  const int n, flo
-0000a150: 6174 202a 2078 2c20 636f 6e73 7420 666c  at * x, const fl
-0000a160: 6f61 7420 2020 7629 2020 2020 2020 2020  oat   v)        
-0000a170: 2020 2020 2020 2020 2020 7b20 666f 7220            { for 
-0000a180: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0000a190: 6e3b 202b 2b69 2920 785b 695d 2020 3d20  n; ++i) x[i]  = 
-0000a1a0: 763b 2020 2020 2020 2020 2020 207d 0a69  v;           }.i
-0000a1b0: 6e6c 696e 6520 7374 6174 6963 2076 6f69  nline static voi
-0000a1c0: 6420 6767 6d6c 5f76 6563 5f63 7079 5f66  d ggml_vec_cpy_f
-0000a1d0: 3332 2028 636f 6e73 7420 696e 7420 6e2c  32 (const int n,
-0000a1e0: 2066 6c6f 6174 202a 2079 2c20 636f 6e73   float * y, cons
-0000a1f0: 7420 666c 6f61 7420 2a20 7829 2020 2020  t float * x)    
-0000a200: 2020 2020 2020 2020 2020 2020 2020 7b20                { 
-0000a210: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0000a220: 6920 3c20 6e3b 202b 2b69 2920 795b 695d  i < n; ++i) y[i]
-0000a230: 2020 3d20 785b 695d 3b20 2020 2020 2020    = x[i];       
-0000a240: 207d 0a69 6e6c 696e 6520 7374 6174 6963   }.inline static
-0000a250: 2076 6f69 6420 6767 6d6c 5f76 6563 5f6e   void ggml_vec_n
-0000a260: 6567 5f66 3332 2028 636f 6e73 7420 696e  eg_f32 (const in
-0000a270: 7420 6e2c 2066 6c6f 6174 202a 2079 2c20  t n, float * y, 
-0000a280: 636f 6e73 7420 666c 6f61 7420 2a20 7829  const float * x)
-0000a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2a0: 2020 7b20 666f 7220 2869 6e74 2069 203d    { for (int i =
-0000a2b0: 2030 3b20 6920 3c20 6e3b 202b 2b69 2920   0; i < n; ++i) 
-0000a2c0: 795b 695d 2020 3d20 2d78 5b69 5d3b 2020  y[i]  = -x[i];  
-0000a2d0: 2020 2020 207d 0a69 6e6c 696e 6520 7374       }.inline st
-0000a2e0: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
-0000a2f0: 6563 5f6d 756c 5f66 3332 2028 636f 6e73  ec_mul_f32 (cons
-0000a300: 7420 696e 7420 6e2c 2066 6c6f 6174 202a  t int n, float *
-0000a310: 207a 2c20 636f 6e73 7420 666c 6f61 7420   z, const float 
-0000a320: 2a20 782c 2063 6f6e 7374 2066 6c6f 6174  * x, const float
-0000a330: 202a 2079 2920 7b20 666f 7220 2869 6e74   * y) { for (int
-0000a340: 2069 203d 2030 3b20 6920 3c20 6e3b 202b   i = 0; i < n; +
-0000a350: 2b69 2920 7a5b 695d 2020 3d20 785b 695d  +i) z[i]  = x[i]
-0000a360: 2a79 5b69 5d3b 2020 207d 0a69 6e6c 696e  *y[i];   }.inlin
-0000a370: 6520 7374 6174 6963 2076 6f69 6420 6767  e static void gg
-0000a380: 6d6c 5f76 6563 5f64 6976 5f66 3332 2028  ml_vec_div_f32 (
-0000a390: 636f 6e73 7420 696e 7420 6e2c 2066 6c6f  const int n, flo
-0000a3a0: 6174 202a 207a 2c20 636f 6e73 7420 666c  at * z, const fl
-0000a3b0: 6f61 7420 2a20 782c 2063 6f6e 7374 2066  oat * x, const f
-0000a3c0: 6c6f 6174 202a 2079 2920 7b20 666f 7220  loat * y) { for 
-0000a3d0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0000a3e0: 6e3b 202b 2b69 2920 7a5b 695d 2020 3d20  n; ++i) z[i]  = 
-0000a3f0: 785b 695d 2f79 5b69 5d3b 2020 207d 0a0a  x[i]/y[i];   }..
-0000a400: 696e 6c69 6e65 2073 7461 7469 6320 766f  inline static vo
-0000a410: 6964 2067 676d 6c5f 7665 635f 646f 745f  id ggml_vec_dot_
-0000a420: 6633 3228 636f 6e73 7420 696e 7420 6e2c  f32(const int n,
-0000a430: 2066 6c6f 6174 202a 2072 6573 7472 6963   float * restric
-0000a440: 7420 732c 2063 6f6e 7374 2066 6c6f 6174  t s, const float
-0000a450: 202a 2072 6573 7472 6963 7420 782c 2063   * restrict x, c
-0000a460: 6f6e 7374 2066 6c6f 6174 202a 2072 6573  onst float * res
-0000a470: 7472 6963 7420 7929 207b 0a20 2020 2067  trict y) {.    g
-0000a480: 676d 6c5f 666c 6f61 7420 7375 6d66 203d  gml_float sumf =
-0000a490: 2030 2e30 3b0a 0a23 6966 6465 6620 4747   0.0;..#ifdef GG
-0000a4a0: 4d4c 5f53 494d 440a 2020 2020 636f 6e73  ML_SIMD.    cons
-0000a4b0: 7420 696e 7420 6e70 203d 2028 6e20 2620  t int np = (n & 
-0000a4c0: 7e28 4747 4d4c 5f46 3332 5f53 5445 5020  ~(GGML_F32_STEP 
-0000a4d0: 2d20 3129 293b 0a0a 2020 2020 4747 4d4c  - 1));..    GGML
-0000a4e0: 5f46 3332 5f56 4543 2073 756d 5b47 474d  _F32_VEC sum[GGM
-0000a4f0: 4c5f 4633 325f 4152 525d 203d 207b 2047  L_F32_ARR] = { G
-0000a500: 474d 4c5f 4633 325f 5645 435f 5a45 524f  GML_F32_VEC_ZERO
-0000a510: 207d 3b0a 0a20 2020 2047 474d 4c5f 4633   };..    GGML_F3
-0000a520: 325f 5645 4320 6178 5b47 474d 4c5f 4633  2_VEC ax[GGML_F3
-0000a530: 325f 4152 525d 3b0a 2020 2020 4747 4d4c  2_ARR];.    GGML
-0000a540: 5f46 3332 5f56 4543 2061 795b 4747 4d4c  _F32_VEC ay[GGML
-0000a550: 5f46 3332 5f41 5252 5d3b 0a0a 2020 2020  _F32_ARR];..    
-0000a560: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0000a570: 6920 3c20 6e70 3b20 6920 2b3d 2047 474d  i < np; i += GGM
-0000a580: 4c5f 4633 325f 5354 4550 2920 7b0a 2020  L_F32_STEP) {.  
-0000a590: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-0000a5a0: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f46   = 0; j < GGML_F
-0000a5b0: 3332 5f41 5252 3b20 6a2b 2b29 207b 0a20  32_ARR; j++) {. 
-0000a5c0: 2020 2020 2020 2020 2020 2061 785b 6a5d             ax[j]
-0000a5d0: 203d 2047 474d 4c5f 4633 325f 5645 435f   = GGML_F32_VEC_
-0000a5e0: 4c4f 4144 2878 202b 2069 202b 206a 2a47  LOAD(x + i + j*G
-0000a5f0: 474d 4c5f 4633 325f 4550 5229 3b0a 2020  GML_F32_EPR);.  
-0000a600: 2020 2020 2020 2020 2020 6179 5b6a 5d20            ay[j] 
-0000a610: 3d20 4747 4d4c 5f46 3332 5f56 4543 5f4c  = GGML_F32_VEC_L
-0000a620: 4f41 4428 7920 2b20 6920 2b20 6a2a 4747  OAD(y + i + j*GG
-0000a630: 4d4c 5f46 3332 5f45 5052 293b 0a0a 2020  ML_F32_EPR);..  
-0000a640: 2020 2020 2020 2020 2020 7375 6d5b 6a5d            sum[j]
-0000a650: 203d 2047 474d 4c5f 4633 325f 5645 435f   = GGML_F32_VEC_
-0000a660: 464d 4128 7375 6d5b 6a5d 2c20 6178 5b6a  FMA(sum[j], ax[j
-0000a670: 5d2c 2061 795b 6a5d 293b 0a20 2020 2020  ], ay[j]);.     
-0000a680: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
-0000a690: 2f2f 2072 6564 7563 6520 7375 6d30 2e2e  // reduce sum0..
-0000a6a0: 7375 6d33 2074 6f20 7375 6d30 0a20 2020  sum3 to sum0.   
-0000a6b0: 2047 474d 4c5f 4633 325f 5645 435f 5245   GGML_F32_VEC_RE
-0000a6c0: 4455 4345 2873 756d 662c 2073 756d 293b  DUCE(sumf, sum);
-0000a6d0: 0a0a 2020 2020 2f2f 206c 6566 746f 7665  ..    // leftove
-0000a6e0: 7273 0a20 2020 2066 6f72 2028 696e 7420  rs.    for (int 
-0000a6f0: 6920 3d20 6e70 3b20 6920 3c20 6e3b 202b  i = np; i < n; +
-0000a700: 2b69 2920 7b0a 2020 2020 2020 2020 7375  +i) {.        su
-0000a710: 6d66 202b 3d20 785b 695d 2a79 5b69 5d3b  mf += x[i]*y[i];
-0000a720: 0a20 2020 207d 0a23 656c 7365 0a20 2020  .    }.#else.   
-0000a730: 202f 2f20 7363 616c 6172 0a20 2020 2066   // scalar.    f
-0000a740: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0000a750: 203c 206e 3b20 2b2b 6929 207b 0a20 2020   < n; ++i) {.   
-0000a760: 2020 2020 2073 756d 6620 2b3d 2078 5b69       sumf += x[i
-0000a770: 5d2a 795b 695d 3b0a 2020 2020 7d0a 2365  ]*y[i];.    }.#e
-0000a780: 6e64 6966 0a0a 2020 2020 2a73 203d 2073  ndif..    *s = s
-0000a790: 756d 663b 0a7d 0a0a 696e 6c69 6e65 2073  umf;.}..inline s
-0000a7a0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0000a7b0: 7665 635f 646f 745f 6631 3628 636f 6e73  vec_dot_f16(cons
-0000a7c0: 7420 696e 7420 6e2c 2066 6c6f 6174 202a  t int n, float *
-0000a7d0: 2072 6573 7472 6963 7420 732c 2067 676d   restrict s, ggm
-0000a7e0: 6c5f 6670 3136 5f74 202a 2072 6573 7472  l_fp16_t * restr
-0000a7f0: 6963 7420 782c 2067 676d 6c5f 6670 3136  ict x, ggml_fp16
-0000a800: 5f74 202a 2072 6573 7472 6963 7420 7929  _t * restrict y)
-0000a810: 207b 0a20 2020 2067 676d 6c5f 666c 6f61   {.    ggml_floa
-0000a820: 7420 7375 6d66 203d 2030 2e30 3b0a 0a23  t sumf = 0.0;..#
-0000a830: 6966 2064 6566 696e 6564 2847 474d 4c5f  if defined(GGML_
-0000a840: 5349 4d44 290a 2020 2020 636f 6e73 7420  SIMD).    const 
-0000a850: 696e 7420 6e70 203d 2028 6e20 2620 7e28  int np = (n & ~(
-0000a860: 4747 4d4c 5f46 3136 5f53 5445 5020 2d20  GGML_F16_STEP - 
-0000a870: 3129 293b 0a0a 2020 2020 4747 4d4c 5f46  1));..    GGML_F
-0000a880: 3136 5f56 4543 2073 756d 5b47 474d 4c5f  16_VEC sum[GGML_
-0000a890: 4631 365f 4152 525d 203d 207b 2047 474d  F16_ARR] = { GGM
-0000a8a0: 4c5f 4631 365f 5645 435f 5a45 524f 207d  L_F16_VEC_ZERO }
-0000a8b0: 3b0a 0a20 2020 2047 474d 4c5f 4631 365f  ;..    GGML_F16_
-0000a8c0: 5645 4320 6178 5b47 474d 4c5f 4631 365f  VEC ax[GGML_F16_
-0000a8d0: 4152 525d 3b0a 2020 2020 4747 4d4c 5f46  ARR];.    GGML_F
-0000a8e0: 3136 5f56 4543 2061 795b 4747 4d4c 5f46  16_VEC ay[GGML_F
-0000a8f0: 3136 5f41 5252 5d3b 0a0a 2020 2020 666f  16_ARR];..    fo
-0000a900: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0000a910: 3c20 6e70 3b20 6920 2b3d 2047 474d 4c5f  < np; i += GGML_
-0000a920: 4631 365f 5354 4550 2920 7b0a 2020 2020  F16_STEP) {.    
-0000a930: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-0000a940: 2030 3b20 6a20 3c20 4747 4d4c 5f46 3136   0; j < GGML_F16
-0000a950: 5f41 5252 3b20 6a2b 2b29 207b 0a20 2020  _ARR; j++) {.   
-0000a960: 2020 2020 2020 2020 2061 785b 6a5d 203d           ax[j] =
-0000a970: 2047 474d 4c5f 4631 365f 5645 435f 4c4f   GGML_F16_VEC_LO
-0000a980: 4144 2878 202b 2069 202b 206a 2a47 474d  AD(x + i + j*GGM
-0000a990: 4c5f 4631 365f 4550 522c 206a 293b 0a20  L_F16_EPR, j);. 
-0000a9a0: 2020 2020 2020 2020 2020 2061 795b 6a5d             ay[j]
-0000a9b0: 203d 2047 474d 4c5f 4631 365f 5645 435f   = GGML_F16_VEC_
-0000a9c0: 4c4f 4144 2879 202b 2069 202b 206a 2a47  LOAD(y + i + j*G
-0000a9d0: 474d 4c5f 4631 365f 4550 522c 206a 293b  GML_F16_EPR, j);
-0000a9e0: 0a0a 2020 2020 2020 2020 2020 2020 7375  ..            su
-0000a9f0: 6d5b 6a5d 203d 2047 474d 4c5f 4631 365f  m[j] = GGML_F16_
-0000aa00: 5645 435f 464d 4128 7375 6d5b 6a5d 2c20  VEC_FMA(sum[j], 
-0000aa10: 6178 5b6a 5d2c 2061 795b 6a5d 293b 0a20  ax[j], ay[j]);. 
-0000aa20: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-0000aa30: 2020 2020 2f2f 2072 6564 7563 6520 7375      // reduce su
-0000aa40: 6d30 2e2e 7375 6d33 2074 6f20 7375 6d30  m0..sum3 to sum0
-0000aa50: 0a20 2020 2047 474d 4c5f 4631 365f 5645  .    GGML_F16_VE
-0000aa60: 435f 5245 4455 4345 2873 756d 662c 2073  C_REDUCE(sumf, s
-0000aa70: 756d 293b 0a0a 2020 2020 2f2f 206c 6566  um);..    // lef
-0000aa80: 746f 7665 7273 0a20 2020 2066 6f72 2028  tovers.    for (
-0000aa90: 696e 7420 6920 3d20 6e70 3b20 6920 3c20  int i = np; i < 
-0000aaa0: 6e3b 202b 2b69 2920 7b0a 2020 2020 2020  n; ++i) {.      
-0000aab0: 2020 7375 6d66 202b 3d20 4747 4d4c 5f46    sumf += GGML_F
-0000aac0: 5031 365f 544f 5f46 5033 3228 785b 695d  P16_TO_FP32(x[i]
-0000aad0: 292a 4747 4d4c 5f46 5031 365f 544f 5f46  )*GGML_FP16_TO_F
-0000aae0: 5033 3228 795b 695d 293b 0a20 2020 207d  P32(y[i]);.    }
-0000aaf0: 0a23 656c 7365 0a20 2020 2066 6f72 2028  .#else.    for (
-0000ab00: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-0000ab10: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-0000ab20: 2073 756d 6620 2b3d 2047 474d 4c5f 4650   sumf += GGML_FP
-0000ab30: 3136 5f54 4f5f 4650 3332 2878 5b69 5d29  16_TO_FP32(x[i])
-0000ab40: 2a47 474d 4c5f 4650 3136 5f54 4f5f 4650  *GGML_FP16_TO_FP
-0000ab50: 3332 2879 5b69 5d29 3b0a 2020 2020 7d0a  32(y[i]);.    }.
-0000ab60: 2365 6e64 6966 0a0a 2020 2020 2a73 203d  #endif..    *s =
-0000ab70: 2073 756d 663b 0a7d 0a0a 696e 6c69 6e65   sumf;.}..inline
-0000ab80: 2073 7461 7469 6320 766f 6964 2067 676d   static void ggm
-0000ab90: 6c5f 7665 635f 646f 745f 7134 5f30 2863  l_vec_dot_q4_0(c
-0000aba0: 6f6e 7374 2069 6e74 206e 2c20 666c 6f61  onst int n, floa
-0000abb0: 7420 2a20 7265 7374 7269 6374 2073 2c20  t * restrict s, 
-0000abc0: 636f 6e73 7420 766f 6964 202a 2072 6573  const void * res
-0000abd0: 7472 6963 7420 782c 2063 6f6e 7374 2076  trict x, const v
-0000abe0: 6f69 6420 2a20 7265 7374 7269 6374 2079  oid * restrict y
-0000abf0: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
-0000ac00: 7420 6e62 203d 206e 202f 2051 4b3b 0a0a  t nb = n / QK;..
-0000ac10: 2020 2020 6173 7365 7274 286e 2025 2051      assert(n % Q
-0000ac20: 4b20 3d3d 2030 293b 0a20 2020 2061 7373  K == 0);.    ass
-0000ac30: 6572 7428 6e62 2025 2032 203d 3d20 3029  ert(nb % 2 == 0)
-0000ac40: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-0000ac50: 655f 7420 6273 203d 2073 697a 656f 6628  e_t bs = sizeof(
-0000ac60: 666c 6f61 7429 202b 2051 4b2f 323b 0a0a  float) + QK/2;..
-0000ac70: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-0000ac80: 7420 2a20 7265 7374 7269 6374 2070 6430  t * restrict pd0
-0000ac90: 203d 2028 2863 6f6e 7374 2075 696e 7438   = ((const uint8
-0000aca0: 5f74 202a 2978 202b 2030 2a62 7329 3b0a  _t *)x + 0*bs);.
-0000acb0: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-0000acc0: 7420 2a20 7265 7374 7269 6374 2070 6431  t * restrict pd1
-0000acd0: 203d 2028 2863 6f6e 7374 2075 696e 7438   = ((const uint8
-0000ace0: 5f74 202a 2979 202b 2030 2a62 7329 3b0a  _t *)y + 0*bs);.
-0000acf0: 0a20 2020 2063 6f6e 7374 2075 696e 7438  .    const uint8
-0000ad00: 5f74 202a 2072 6573 7472 6963 7420 7062  _t * restrict pb
-0000ad10: 3020 3d20 2828 636f 6e73 7420 7569 6e74  0 = ((const uint
-0000ad20: 385f 7420 2a29 7820 2b20 302a 6273 202b  8_t *)x + 0*bs +
-0000ad30: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0000ad40: 0a20 2020 2063 6f6e 7374 2075 696e 7438  .    const uint8
-0000ad50: 5f74 202a 2072 6573 7472 6963 7420 7062  _t * restrict pb
-0000ad60: 3120 3d20 2828 636f 6e73 7420 7569 6e74  1 = ((const uint
-0000ad70: 385f 7420 2a29 7920 2b20 302a 6273 202b  8_t *)y + 0*bs +
-0000ad80: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0000ad90: 0a0a 2020 2020 666c 6f61 7420 7375 6d66  ..    float sumf
-0000ada0: 203d 2030 2e30 3b0a 0a23 6966 6465 6620   = 0.0;..#ifdef 
-0000adb0: 5f5f 4152 4d5f 4e45 4f4e 0a23 6966 2051  __ARM_NEON.#if Q
-0000adc0: 4b20 3d3d 2033 320a 2020 2020 666c 6f61  K == 32.    floa
-0000add0: 7420 7375 6d30 203d 2030 2e30 663b 0a20  t sum0 = 0.0f;. 
-0000ade0: 2020 2066 6c6f 6174 2073 756d 3120 3d20     float sum1 = 
-0000adf0: 302e 3066 3b0a 0a20 2020 2066 6f72 2028  0.0f;..    for (
-0000ae00: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-0000ae10: 623b 2069 202b 3d20 3229 207b 0a20 2020  b; i += 2) {.   
-0000ae20: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-0000ae30: 2064 305f 3020 3d20 2a28 636f 6e73 7420   d0_0 = *(const 
-0000ae40: 666c 6f61 7420 2a29 2028 7064 3020 2b20  float *) (pd0 + 
-0000ae50: 692a 6273 293b 0a20 2020 2020 2020 2063  i*bs);.        c
-0000ae60: 6f6e 7374 2066 6c6f 6174 2064 315f 3020  onst float d1_0 
-0000ae70: 3d20 2a28 636f 6e73 7420 666c 6f61 7420  = *(const float 
-0000ae80: 2a29 2028 7064 3120 2b20 692a 6273 293b  *) (pd1 + i*bs);
-0000ae90: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-0000aea0: 6c6f 6174 2064 305f 3120 3d20 2a28 636f  loat d0_1 = *(co
-0000aeb0: 6e73 7420 666c 6f61 7420 2a29 2028 7064  nst float *) (pd
-0000aec0: 3020 2b20 2869 202b 2031 292a 6273 293b  0 + (i + 1)*bs);
-0000aed0: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-0000aee0: 6c6f 6174 2064 315f 3120 3d20 2a28 636f  loat d1_1 = *(co
-0000aef0: 6e73 7420 666c 6f61 7420 2a29 2028 7064  nst float *) (pd
-0000af00: 3120 2b20 2869 202b 2031 292a 6273 293b  1 + (i + 1)*bs);
-0000af10: 0a0a 2020 2020 2020 2020 2f2f 7072 696e  ..        //prin
-0000af20: 7466 2822 6430 5f30 3a20 2566 2c20 6431  tf("d0_0: %f, d1
-0000af30: 5f30 3a20 2566 2c20 6430 5f31 3a20 2566  _0: %f, d0_1: %f
-0000af40: 2c20 6431 5f31 3a20 2566 5c6e 222c 2064  , d1_1: %f\n", d
-0000af50: 305f 302c 2064 315f 302c 2064 305f 312c  0_0, d1_0, d0_1,
-0000af60: 2064 315f 3129 3b0a 0a20 2020 2020 2020   d1_1);..       
-0000af70: 2063 6f6e 7374 2075 696e 7438 5f74 202a   const uint8_t *
-0000af80: 2072 6573 7472 6963 7420 7030 203d 2070   restrict p0 = p
-0000af90: 6230 202b 2069 2a62 733b 0a20 2020 2020  b0 + i*bs;.     
-0000afa0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
-0000afb0: 202a 2072 6573 7472 6963 7420 7031 203d   * restrict p1 =
-0000afc0: 2070 6231 202b 2069 2a62 733b 0a0a 2020   pb1 + i*bs;..  
-0000afd0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-0000afe0: 3878 3136 5f74 206d 3462 203d 2076 6475  8x16_t m4b = vdu
-0000aff0: 7071 5f6e 5f75 3828 3078 6629 3b0a 2020  pq_n_u8(0xf);.  
-0000b000: 2020 2020 2020 636f 6e73 7420 696e 7438        const int8
-0000b010: 7831 365f 7420 2073 3862 203d 2076 6475  x16_t  s8b = vdu
-0000b020: 7071 5f6e 5f73 3828 3078 3829 3b0a 0a20  pq_n_s8(0x8);.. 
-0000b030: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-0000b040: 7438 7831 365f 7420 7630 5f30 203d 2076  t8x16_t v0_0 = v
-0000b050: 6c64 3171 5f75 3828 7030 293b 0a20 2020  ld1q_u8(p0);.   
-0000b060: 2020 2020 2063 6f6e 7374 2075 696e 7438       const uint8
-0000b070: 7831 365f 7420 7631 5f30 203d 2076 6c64  x16_t v1_0 = vld
-0000b080: 3171 5f75 3828 7031 293b 0a20 2020 2020  1q_u8(p1);.     
-0000b090: 2020 2063 6f6e 7374 2075 696e 7438 7831     const uint8x1
-0000b0a0: 365f 7420 7630 5f31 203d 2076 6c64 3171  6_t v0_1 = vld1q
-0000b0b0: 5f75 3828 7030 202b 2062 7329 3b0a 2020  _u8(p0 + bs);.  
-0000b0c0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-0000b0d0: 3878 3136 5f74 2076 315f 3120 3d20 766c  8x16_t v1_1 = vl
-0000b0e0: 6431 715f 7538 2870 3120 2b20 6273 293b  d1q_u8(p1 + bs);
-0000b0f0: 0a0a 2020 2020 2020 2020 2f2f 2034 2d62  ..        // 4-b
-0000b100: 6974 202d 3e20 382d 6269 740a 2020 2020  it -> 8-bit.    
-0000b110: 2020 2020 636f 6e73 7420 696e 7438 7831      const int8x1
-0000b120: 365f 7420 7630 5f30 6c20 3d20 7672 6569  6_t v0_0l = vrei
-0000b130: 6e74 6572 7072 6574 715f 7338 5f75 3828  nterpretq_s8_u8(
-0000b140: 7661 6e64 715f 7538 2876 305f 302c 206d  vandq_u8(v0_0, m
-0000b150: 3462 2929 3b0a 2020 2020 2020 2020 636f  4b));.        co
-0000b160: 6e73 7420 696e 7438 7831 365f 7420 7631  nst int8x16_t v1
-0000b170: 5f30 6c20 3d20 7672 6569 6e74 6572 7072  _0l = vreinterpr
-0000b180: 6574 715f 7338 5f75 3828 7661 6e64 715f  etq_s8_u8(vandq_
-0000b190: 7538 2876 315f 302c 206d 3462 2929 3b0a  u8(v1_0, m4b));.
-0000b1a0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-0000b1b0: 6e74 3878 3136 5f74 2076 305f 3068 203d  nt8x16_t v0_0h =
-0000b1c0: 2076 7265 696e 7465 7270 7265 7471 5f73   vreinterpretq_s
-0000b1d0: 385f 7538 2876 7368 7271 5f6e 5f75 3828  8_u8(vshrq_n_u8(
-0000b1e0: 7630 5f30 2c20 3429 293b 0a20 2020 2020  v0_0, 4));.     
-0000b1f0: 2020 2063 6f6e 7374 2069 6e74 3878 3136     const int8x16
-0000b200: 5f74 2076 315f 3068 203d 2076 7265 696e  _t v1_0h = vrein
-0000b210: 7465 7270 7265 7471 5f73 385f 7538 2876  terpretq_s8_u8(v
-0000b220: 7368 7271 5f6e 5f75 3828 7631 5f30 2c20  shrq_n_u8(v1_0, 
-0000b230: 3429 293b 0a0a 2020 2020 2020 2020 636f  4));..        co
-0000b240: 6e73 7420 696e 7438 7831 365f 7420 7630  nst int8x16_t v0
-0000b250: 5f31 6c20 3d20 7672 6569 6e74 6572 7072  _1l = vreinterpr
-0000b260: 6574 715f 7338 5f75 3828 7661 6e64 715f  etq_s8_u8(vandq_
-0000b270: 7538 2876 305f 312c 206d 3462 2929 3b0a  u8(v0_1, m4b));.
-0000b280: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0000b290: 7438 7831 365f 7420 7631 5f31 6c20 3d20  t8x16_t v1_1l = 
-0000b2a0: 7672 6569 6e74 6572 7072 6574 715f 7338  vreinterpretq_s8
-0000b2b0: 5f75 3828 7661 6e64 715f 7538 2876 315f  _u8(vandq_u8(v1_
-0000b2c0: 312c 206d 3462 2929 3b0a 0a20 2020 2020  1, m4b));..     
-0000b2d0: 2020 2063 6f6e 7374 2069 6e74 3878 3136     const int8x16
-0000b2e0: 5f74 2076 305f 3168 203d 2076 7265 696e  _t v0_1h = vrein
-0000b2f0: 7465 7270 7265 7471 5f73 385f 7538 2876  terpretq_s8_u8(v
-0000b300: 7368 7271 5f6e 5f75 3828 7630 5f31 2c20  shrq_n_u8(v0_1, 
-0000b310: 3429 293b 0a20 2020 2020 2020 2063 6f6e  4));.        con
-0000b320: 7374 2069 6e74 3878 3136 5f74 2076 315f  st int8x16_t v1_
-0000b330: 3168 203d 2076 7265 696e 7465 7270 7265  1h = vreinterpre
-0000b340: 7471 5f73 385f 7538 2876 7368 7271 5f6e  tq_s8_u8(vshrq_n
-0000b350: 5f75 3828 7631 5f31 2c20 3429 293b 0a0a  _u8(v1_1, 4));..
-0000b360: 2020 2020 2020 2020 2f2f 2073 7562 2038          // sub 8
-0000b370: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-0000b380: 6e74 3878 3136 5f74 2076 305f 306c 7320  nt8x16_t v0_0ls 
-0000b390: 3d20 7673 7562 715f 7338 2876 305f 306c  = vsubq_s8(v0_0l
-0000b3a0: 2c20 7338 6229 3b0a 2020 2020 2020 2020  , s8b);.        
-0000b3b0: 636f 6e73 7420 696e 7438 7831 365f 7420  const int8x16_t 
-0000b3c0: 7631 5f30 6c73 203d 2076 7375 6271 5f73  v1_0ls = vsubq_s
-0000b3d0: 3828 7631 5f30 6c2c 2073 3862 293b 0a0a  8(v1_0l, s8b);..
-0000b3e0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0000b3f0: 7438 7831 365f 7420 7630 5f30 6873 203d  t8x16_t v0_0hs =
-0000b400: 2076 7375 6271 5f73 3828 7630 5f30 682c   vsubq_s8(v0_0h,
-0000b410: 2073 3862 293b 0a20 2020 2020 2020 2063   s8b);.        c
-0000b420: 6f6e 7374 2069 6e74 3878 3136 5f74 2076  onst int8x16_t v
-0000b430: 315f 3068 7320 3d20 7673 7562 715f 7338  1_0hs = vsubq_s8
-0000b440: 2876 315f 3068 2c20 7338 6229 3b0a 0a20  (v1_0h, s8b);.. 
-0000b450: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0000b460: 3878 3136 5f74 2076 305f 316c 7320 3d20  8x16_t v0_1ls = 
-0000b470: 7673 7562 715f 7338 2876 305f 316c 2c20  vsubq_s8(v0_1l, 
-0000b480: 7338 6229 3b0a 2020 2020 2020 2020 636f  s8b);.        co
-0000b490: 6e73 7420 696e 7438 7831 365f 7420 7631  nst int8x16_t v1
-0000b4a0: 5f31 6c73 203d 2076 7375 6271 5f73 3828  _1ls = vsubq_s8(
-0000b4b0: 7631 5f31 6c2c 2073 3862 293b 0a0a 2020  v1_1l, s8b);..  
-0000b4c0: 2020 2020 2020 636f 6e73 7420 696e 7438        const int8
-0000b4d0: 7831 365f 7420 7630 5f31 6873 203d 2076  x16_t v0_1hs = v
-0000b4e0: 7375 6271 5f73 3828 7630 5f31 682c 2073  subq_s8(v0_1h, s
-0000b4f0: 3862 293b 0a20 2020 2020 2020 2063 6f6e  8b);.        con
-0000b500: 7374 2069 6e74 3878 3136 5f74 2076 315f  st int8x16_t v1_
-0000b510: 3168 7320 3d20 7673 7562 715f 7338 2876  1hs = vsubq_s8(v
-0000b520: 315f 3168 2c20 7338 6229 3b0a 0a23 6966  1_1h, s8b);..#if
-0000b530: 2064 6566 696e 6564 285f 5f41 524d 5f46   defined(__ARM_F
-0000b540: 4541 5455 5245 5f44 4f54 5052 4f44 290a  EATURE_DOTPROD).
-0000b550: 2020 2020 2020 2020 2f2f 2064 6f74 2070          // dot p
-0000b560: 726f 6475 6374 2069 6e74 6f20 696e 7431  roduct into int1
-0000b570: 3678 385f 740a 2020 2020 2020 2020 696e  6x8_t.        in
-0000b580: 7433 3278 345f 7420 705f 3020 3d20 7664  t32x4_t p_0 = vd
-0000b590: 6f74 715f 7333 3228 7664 7570 715f 6e5f  otq_s32(vdupq_n_
-0000b5a0: 7333 3228 3029 2c20 7630 5f30 6c73 2c20  s32(0), v0_0ls, 
-0000b5b0: 7631 5f30 6c73 293b 0a20 2020 2020 2020  v1_0ls);.       
-0000b5c0: 2069 6e74 3332 7834 5f74 2070 5f31 203d   int32x4_t p_1 =
-0000b5d0: 2076 646f 7471 5f73 3332 2876 6475 7071   vdotq_s32(vdupq
-0000b5e0: 5f6e 5f73 3332 2830 292c 2076 305f 316c  _n_s32(0), v0_1l
-0000b5f0: 732c 2076 315f 316c 7329 3b0a 0a20 2020  s, v1_1ls);..   
-0000b600: 2020 2020 2070 5f30 203d 2076 646f 7471       p_0 = vdotq
-0000b610: 5f73 3332 2870 5f30 2c20 7630 5f30 6873  _s32(p_0, v0_0hs
-0000b620: 2c20 7631 5f30 6873 293b 0a20 2020 2020  , v1_0hs);.     
-0000b630: 2020 2070 5f31 203d 2076 646f 7471 5f73     p_1 = vdotq_s
-0000b640: 3332 2870 5f31 2c20 7630 5f31 6873 2c20  32(p_1, v0_1hs, 
-0000b650: 7631 5f31 6873 293b 0a0a 2020 2020 2020  v1_1hs);..      
-0000b660: 2020 2f2f 2073 6361 6c61 720a 2369 6620    // scalar.#if 
-0000b670: 6465 6669 6e65 6428 5f5f 4152 4d5f 4645  defined(__ARM_FE
-0000b680: 4154 5552 455f 5152 444d 5829 0a20 2020  ATURE_QRDMX).   
-0000b690: 2020 2020 2073 756d 3020 2b3d 2064 305f       sum0 += d0_
-0000b6a0: 302a 6431 5f30 2a76 6164 6476 715f 7333  0*d1_0*vaddvq_s3
-0000b6b0: 3228 705f 3029 3b0a 2020 2020 2020 2020  2(p_0);.        
-0000b6c0: 7375 6d31 202b 3d20 6430 5f31 2a64 315f  sum1 += d0_1*d1_
-0000b6d0: 312a 7661 6464 7671 5f73 3332 2870 5f31  1*vaddvq_s32(p_1
-0000b6e0: 293b 0a23 656c 7365 0a20 2020 2020 2020  );.#else.       
-0000b6f0: 2073 756d 3020 2b3d 2064 305f 302a 6431   sum0 += d0_0*d1
-0000b700: 5f30 2a28 7667 6574 715f 6c61 6e65 5f73  _0*(vgetq_lane_s
-0000b710: 3332 2870 5f30 2c20 3029 202b 2076 6765  32(p_0, 0) + vge
-0000b720: 7471 5f6c 616e 655f 7333 3228 705f 302c  tq_lane_s32(p_0,
-0000b730: 2031 2920 2b20 7667 6574 715f 6c61 6e65   1) + vgetq_lane
-0000b740: 5f73 3332 2870 5f30 2c20 3229 202b 2076  _s32(p_0, 2) + v
-0000b750: 6765 7471 5f6c 616e 655f 7333 3228 705f  getq_lane_s32(p_
-0000b760: 302c 2033 2929 3b0a 2020 2020 2020 2020  0, 3));.        
-0000b770: 7375 6d31 202b 3d20 6430 5f31 2a64 315f  sum1 += d0_1*d1_
-0000b780: 312a 2876 6765 7471 5f6c 616e 655f 7333  1*(vgetq_lane_s3
-0000b790: 3228 705f 312c 2030 2920 2b20 7667 6574  2(p_1, 0) + vget
-0000b7a0: 715f 6c61 6e65 5f73 3332 2870 5f31 2c20  q_lane_s32(p_1, 
-0000b7b0: 3129 202b 2076 6765 7471 5f6c 616e 655f  1) + vgetq_lane_
-0000b7c0: 7333 3228 705f 312c 2032 2920 2b20 7667  s32(p_1, 2) + vg
-0000b7d0: 6574 715f 6c61 6e65 5f73 3332 2870 5f31  etq_lane_s32(p_1
-0000b7e0: 2c20 3329 293b 0a23 656e 6469 660a 2365  , 3));.#endif.#e
-0000b7f0: 6c73 650a 0920 2020 2063 6f6e 7374 2069  lse..    const i
-0000b800: 6e74 3136 7838 5f74 2070 6c30 6c20 3d20  nt16x8_t pl0l = 
-0000b810: 766d 756c 6c5f 7338 2876 6765 745f 6c6f  vmull_s8(vget_lo
-0000b820: 775f 7338 2028 7630 5f30 6c73 292c 2076  w_s8 (v0_0ls), v
-0000b830: 6765 745f 6c6f 775f 7338 2028 7631 5f30  get_low_s8 (v1_0
-0000b840: 6c73 2929 3b0a 2020 2020 2020 2020 636f  ls));.        co
-0000b850: 6e73 7420 696e 7431 3678 385f 7420 706c  nst int16x8_t pl
-0000b860: 3068 203d 2076 6d75 6c6c 5f73 3828 7667  0h = vmull_s8(vg
-0000b870: 6574 5f68 6967 685f 7338 2876 305f 306c  et_high_s8(v0_0l
-0000b880: 7329 2c20 7667 6574 5f68 6967 685f 7338  s), vget_high_s8
-0000b890: 2876 315f 306c 7329 293b 0a0a 2020 2020  (v1_0ls));..    
-0000b8a0: 2020 2020 636f 6e73 7420 696e 7431 3678      const int16x
-0000b8b0: 385f 7420 7068 306c 203d 2076 6d75 6c6c  8_t ph0l = vmull
-0000b8c0: 5f73 3828 7667 6574 5f6c 6f77 5f73 3820  _s8(vget_low_s8 
-0000b8d0: 2876 305f 3068 7329 2c20 7667 6574 5f6c  (v0_0hs), vget_l
-0000b8e0: 6f77 5f73 3820 2876 315f 3068 7329 293b  ow_s8 (v1_0hs));
-0000b8f0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-0000b900: 6e74 3136 7838 5f74 2070 6830 6820 3d20  nt16x8_t ph0h = 
-0000b910: 766d 756c 6c5f 7338 2876 6765 745f 6869  vmull_s8(vget_hi
-0000b920: 6768 5f73 3828 7630 5f30 6873 292c 2076  gh_s8(v0_0hs), v
-0000b930: 6765 745f 6869 6768 5f73 3828 7631 5f30  get_high_s8(v1_0
-0000b940: 6873 2929 3b0a 0a20 2020 2020 2020 2063  hs));..        c
-0000b950: 6f6e 7374 2069 6e74 3136 7838 5f74 2070  onst int16x8_t p
-0000b960: 6c31 6c20 3d20 766d 756c 6c5f 7338 2876  l1l = vmull_s8(v
-0000b970: 6765 745f 6c6f 775f 7338 2028 7630 5f31  get_low_s8 (v0_1
-0000b980: 6c73 292c 2076 6765 745f 6c6f 775f 7338  ls), vget_low_s8
-0000b990: 2028 7631 5f31 6c73 2929 3b0a 2020 2020   (v1_1ls));.    
-0000b9a0: 2020 2020 636f 6e73 7420 696e 7431 3678      const int16x
-0000b9b0: 385f 7420 706c 3168 203d 2076 6d75 6c6c  8_t pl1h = vmull
-0000b9c0: 5f73 3828 7667 6574 5f68 6967 685f 7338  _s8(vget_high_s8
-0000b9d0: 2876 305f 316c 7329 2c20 7667 6574 5f68  (v0_1ls), vget_h
-0000b9e0: 6967 685f 7338 2876 315f 316c 7329 293b  igh_s8(v1_1ls));
-0000b9f0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
-0000ba00: 696e 7431 3678 385f 7420 7068 316c 203d  int16x8_t ph1l =
-0000ba10: 2076 6d75 6c6c 5f73 3828 7667 6574 5f6c   vmull_s8(vget_l
-0000ba20: 6f77 5f73 3820 2876 305f 3168 7329 2c20  ow_s8 (v0_1hs), 
-0000ba30: 7667 6574 5f6c 6f77 5f73 3820 2876 315f  vget_low_s8 (v1_
-0000ba40: 3168 7329 293b 0a20 2020 2020 2020 2063  1hs));.        c
-0000ba50: 6f6e 7374 2069 6e74 3136 7838 5f74 2070  onst int16x8_t p
-0000ba60: 6831 6820 3d20 766d 756c 6c5f 7338 2876  h1h = vmull_s8(v
-0000ba70: 6765 745f 6869 6768 5f73 3828 7630 5f31  get_high_s8(v0_1
-0000ba80: 6873 292c 2076 6765 745f 6869 6768 5f73  hs), vget_high_s
-0000ba90: 3828 7631 5f31 6873 2929 3b0a 0a20 2020  8(v1_1hs));..   
-0000baa0: 2020 2020 2063 6f6e 7374 2069 6e74 3136       const int16
-0000bab0: 7838 5f74 2070 6c5f 3020 3d20 7661 6464  x8_t pl_0 = vadd
-0000bac0: 715f 7331 3628 706c 306c 2c20 706c 3068  q_s16(pl0l, pl0h
-0000bad0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-0000bae0: 2069 6e74 3136 7838 5f74 2070 685f 3020   int16x8_t ph_0 
-0000baf0: 3d20 7661 6464 715f 7331 3628 7068 306c  = vaddq_s16(ph0l
-0000bb00: 2c20 7068 3068 293b 0a0a 2020 2020 2020  , ph0h);..      
-0000bb10: 2020 636f 6e73 7420 696e 7431 3678 385f    const int16x8_
-0000bb20: 7420 706c 5f31 203d 2076 6164 6471 5f73  t pl_1 = vaddq_s
-0000bb30: 3136 2870 6c31 6c2c 2070 6c31 6829 3b0a  16(pl1l, pl1h);.
-0000bb40: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0000bb50: 7431 3678 385f 7420 7068 5f31 203d 2076  t16x8_t ph_1 = v
-0000bb60: 6164 6471 5f73 3136 2870 6831 6c2c 2070  addq_s16(ph1l, p
-0000bb70: 6831 6829 3b0a 0a20 2020 2020 2020 2063  h1h);..        c
-0000bb80: 6f6e 7374 2069 6e74 3136 7838 5f74 2070  onst int16x8_t p
-0000bb90: 5f30 203d 2076 6164 6471 5f73 3136 2870  _0 = vaddq_s16(p
-0000bba0: 6c5f 302c 2070 685f 3029 3b0a 2020 2020  l_0, ph_0);.    
-0000bbb0: 2020 2020 636f 6e73 7420 696e 7431 3678      const int16x
-0000bbc0: 385f 7420 705f 3120 3d20 7661 6464 715f  8_t p_1 = vaddq_
-0000bbd0: 7331 3628 706c 5f31 2c20 7068 5f31 293b  s16(pl_1, ph_1);
-0000bbe0: 0a0a 2020 2020 2020 2020 2f2f 2073 6361  ..        // sca
-0000bbf0: 6c61 720a 2369 6620 6465 6669 6e65 6428  lar.#if defined(
-0000bc00: 5f5f 4152 4d5f 4645 4154 5552 455f 5152  __ARM_FEATURE_QR
-0000bc10: 444d 5829 0a20 2020 2020 2020 2073 756d  DMX).        sum
-0000bc20: 3020 2b3d 2064 305f 302a 6431 5f30 2a76  0 += d0_0*d1_0*v
-0000bc30: 6164 6476 715f 7331 3628 705f 3029 3b0a  addvq_s16(p_0);.
-0000bc40: 2020 2020 2020 2020 7375 6d31 202b 3d20          sum1 += 
-0000bc50: 6430 5f31 2a64 315f 312a 7661 6464 7671  d0_1*d1_1*vaddvq
-0000bc60: 5f73 3136 2870 5f31 293b 0a23 656c 7365  _s16(p_1);.#else
-0000bc70: 0a20 2020 2020 2020 2073 756d 3020 2b3d  .        sum0 +=
-0000bc80: 2064 305f 302a 6431 5f30 2a28 7667 6574   d0_0*d1_0*(vget
-0000bc90: 715f 6c61 6e65 5f73 3136 2870 5f30 2c20  q_lane_s16(p_0, 
-0000bca0: 3029 202b 2076 6765 7471 5f6c 616e 655f  0) + vgetq_lane_
-0000bcb0: 7331 3628 705f 302c 2031 2920 2b20 7667  s16(p_0, 1) + vg
-0000bcc0: 6574 715f 6c61 6e65 5f73 3136 2870 5f30  etq_lane_s16(p_0
-0000bcd0: 2c20 3229 202b 2076 6765 7471 5f6c 616e  , 2) + vgetq_lan
-0000bce0: 655f 7331 3628 705f 302c 2033 2920 2b20  e_s16(p_0, 3) + 
-0000bcf0: 7667 6574 715f 6c61 6e65 5f73 3136 2870  vgetq_lane_s16(p
-0000bd00: 5f30 2c20 3429 202b 2076 6765 7471 5f6c  _0, 4) + vgetq_l
-0000bd10: 616e 655f 7331 3628 705f 302c 2035 2920  ane_s16(p_0, 5) 
-0000bd20: 2b20 7667 6574 715f 6c61 6e65 5f73 3136  + vgetq_lane_s16
-0000bd30: 2870 5f30 2c20 3629 202b 2076 6765 7471  (p_0, 6) + vgetq
-0000bd40: 5f6c 616e 655f 7331 3628 705f 302c 2037  _lane_s16(p_0, 7
-0000bd50: 2929 3b0a 2020 2020 2020 2020 7375 6d31  ));.        sum1
-0000bd60: 202b 3d20 6430 5f31 2a64 315f 312a 2876   += d0_1*d1_1*(v
-0000bd70: 6765 7471 5f6c 616e 655f 7331 3628 705f  getq_lane_s16(p_
-0000bd80: 312c 2030 2920 2b20 7667 6574 715f 6c61  1, 0) + vgetq_la
-0000bd90: 6e65 5f73 3136 2870 5f31 2c20 3129 202b  ne_s16(p_1, 1) +
-0000bda0: 2076 6765 7471 5f6c 616e 655f 7331 3628   vgetq_lane_s16(
-0000bdb0: 705f 312c 2032 2920 2b20 7667 6574 715f  p_1, 2) + vgetq_
-0000bdc0: 6c61 6e65 5f73 3136 2870 5f31 2c20 3329  lane_s16(p_1, 3)
-0000bdd0: 202b 2076 6765 7471 5f6c 616e 655f 7331   + vgetq_lane_s1
-0000bde0: 3628 705f 312c 2034 2920 2b20 7667 6574  6(p_1, 4) + vget
-0000bdf0: 715f 6c61 6e65 5f73 3136 2870 5f31 2c20  q_lane_s16(p_1, 
-0000be00: 3529 202b 2076 6765 7471 5f6c 616e 655f  5) + vgetq_lane_
-0000be10: 7331 3628 705f 312c 2036 2920 2b20 7667  s16(p_1, 6) + vg
-0000be20: 6574 715f 6c61 6e65 5f73 3136 2870 5f31  etq_lane_s16(p_1
-0000be30: 2c20 3729 293b 0a23 656e 6469 660a 2365  , 7));.#endif.#e
-0000be40: 6e64 6966 0a20 2020 207d 0a0a 2020 2020  ndif.    }..    
-0000be50: 7375 6d66 203d 2073 756d 3020 2b20 7375  sumf = sum0 + su
-0000be60: 6d31 3b0a 2365 6c73 650a 2365 7272 6f72  m1;.#else.#error
-0000be70: 2022 6e6f 7420 696d 706c 656d 656e 7465   "not implemente
-0000be80: 6420 666f 7220 514b 220a 2365 6e64 6966  d for QK".#endif
-0000be90: 0a23 656c 6966 2064 6566 696e 6564 285f  .#elif defined(_
-0000bea0: 5f41 5658 325f 5f29 0a23 6966 2051 4b20  _AVX2__).#if QK 
-0000beb0: 3d3d 2033 320a 2020 2020 636f 6e73 7420  == 32.    const 
-0000bec0: 7369 7a65 5f74 2063 6f75 6e74 426c 6f63  size_t countBloc
-0000bed0: 6b73 203d 206e 623b 0a0a 2020 2020 2f2f  ks = nb;..    //
-0000bee0: 2049 6e69 7469 616c 697a 6520 6163 6375   Initialize accu
-0000bef0: 6d75 6c61 746f 7220 7769 7468 207a 6572  mulator with zer
-0000bf00: 6f73 0a20 2020 205f 5f6d 3235 3620 6163  os.    __m256 ac
-0000bf10: 6320 3d20 5f6d 6d32 3536 5f73 6574 7a65  c = _mm256_setze
-0000bf20: 726f 5f70 7328 293b 0a0a 2020 2020 2f2f  ro_ps();..    //
-0000bf30: 204d 6169 6e20 6c6f 6f70 0a20 2020 2066   Main loop.    f
-0000bf40: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0000bf50: 203c 206e 623b 202b 2b69 2920 7b0a 2020   < nb; ++i) {.  
-0000bf60: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0000bf70: 7420 2a20 6430 5f30 203d 2028 636f 6e73  t * d0_0 = (cons
-0000bf80: 7420 666c 6f61 7420 2a29 2028 7064 3020  t float *) (pd0 
-0000bf90: 2b20 692a 6273 293b 0a20 2020 2020 2020  + i*bs);.       
-0000bfa0: 2063 6f6e 7374 2066 6c6f 6174 202a 2064   const float * d
-0000bfb0: 315f 3020 3d20 2863 6f6e 7374 2066 6c6f  1_0 = (const flo
-0000bfc0: 6174 202a 2920 2870 6431 202b 2069 2a62  at *) (pd1 + i*b
-0000bfd0: 7329 3b0a 0a20 2020 2020 2020 2063 6f6e  s);..        con
-0000bfe0: 7374 2075 696e 7438 5f74 202a 2072 6573  st uint8_t * res
-0000bff0: 7472 6963 7420 7030 203d 2070 6230 202b  trict p0 = pb0 +
-0000c000: 2069 2a62 733b 0a20 2020 2020 2020 2063   i*bs;.        c
-0000c010: 6f6e 7374 2075 696e 7438 5f74 202a 2072  onst uint8_t * r
-0000c020: 6573 7472 6963 7420 7031 203d 2070 6231  estrict p1 = pb1
-0000c030: 202b 2069 2a62 733b 0a0a 2020 2020 2020   + i*bs;..      
-0000c040: 2020 2f2f 2043 6f6d 7075 7465 2063 6f6d    // Compute com
-0000c050: 6269 6e65 6420 7363 616c 6520 666f 7220  bined scale for 
-0000c060: 7468 6520 626c 6f63 6b0a 2020 2020 2020  the block.      
-0000c070: 2020 636f 6e73 7420 5f5f 6d32 3536 2073    const __m256 s
-0000c080: 6361 6c65 203d 205f 6d6d 3235 365f 6d75  cale = _mm256_mu
-0000c090: 6c5f 7073 2820 5f6d 6d32 3536 5f62 726f  l_ps( _mm256_bro
-0000c0a0: 6164 6361 7374 5f73 7328 2064 305f 3020  adcast_ss( d0_0 
-0000c0b0: 292c 205f 6d6d 3235 365f 6272 6f61 6463  ), _mm256_broadc
-0000c0c0: 6173 745f 7373 2820 6431 5f30 2029 2029  ast_ss( d1_0 ) )
-0000c0d0: 3b0a 0a20 2020 2020 2020 202f 2f20 4c6f  ;..        // Lo
-0000c0e0: 6164 2031 3620 6279 7465 732c 2061 6e64  ad 16 bytes, and
-0000c0f0: 2075 6e70 6163 6b20 3420 6269 7420 6669   unpack 4 bit fi
-0000c100: 656c 6473 2069 6e74 6f20 6279 7465 732c  elds into bytes,
-0000c110: 206d 616b 696e 6720 3332 2062 7974 6573   making 32 bytes
-0000c120: 0a20 2020 2020 2020 205f 5f6d 3235 3669  .        __m256i
-0000c130: 2062 7820 3d20 6279 7465 7346 726f 6d4e   bx = bytesFromN
-0000c140: 6962 626c 6573 2820 7030 2029 3b0a 2020  ibbles( p0 );.  
-0000c150: 2020 2020 2020 5f5f 6d32 3536 6920 6279        __m256i by
-0000c160: 203d 2062 7974 6573 4672 6f6d 4e69 6262   = bytesFromNibb
-0000c170: 6c65 7328 2070 3120 293b 0a0a 2020 2020  les( p1 );..    
-0000c180: 2020 2020 2f2f 204e 6f77 2077 6520 6861      // Now we ha
-0000c190: 7665 2061 2076 6563 746f 7220 7769 7468  ve a vector with
-0000c1a0: 2062 7974 6573 2069 6e20 5b20 3020 2e2e   bytes in [ 0 ..
-0000c1b0: 2031 3520 5d20 696e 7465 7276 616c 2e20   15 ] interval. 
-0000c1c0: 4f66 6673 6574 2074 6865 6d20 696e 746f  Offset them into
-0000c1d0: 205b 202d 3820 2e2e 202b 3720 5d20 696e   [ -8 .. +7 ] in
-0000c1e0: 7465 7276 616c 2e0a 2020 2020 2020 2020  terval..        
-0000c1f0: 636f 6e73 7420 5f5f 6d32 3536 6920 6f66  const __m256i of
-0000c200: 6620 3d20 5f6d 6d32 3536 5f73 6574 315f  f = _mm256_set1_
-0000c210: 6570 6938 2820 3820 293b 0a20 2020 2020  epi8( 8 );.     
-0000c220: 2020 2062 7820 3d20 5f6d 6d32 3536 5f73     bx = _mm256_s
-0000c230: 7562 5f65 7069 3828 2062 782c 206f 6666  ub_epi8( bx, off
-0000c240: 2029 3b0a 2020 2020 2020 2020 6279 203d   );.        by =
-0000c250: 205f 6d6d 3235 365f 7375 625f 6570 6938   _mm256_sub_epi8
-0000c260: 2820 6279 2c20 6f66 6620 293b 0a0a 2020  ( by, off );..  
-0000c270: 2020 2020 2020 2f2f 2053 6967 6e2d 6578        // Sign-ex
-0000c280: 7465 6e64 2066 6972 7374 2031 3620 7369  tend first 16 si
-0000c290: 676e 6564 2062 7974 6573 2069 6e74 6f20  gned bytes into 
-0000c2a0: 696e 7431 365f 740a 2020 2020 2020 2020  int16_t.        
-0000c2b0: 5f5f 6d32 3536 6920 7831 3620 3d20 5f6d  __m256i x16 = _m
-0000c2c0: 6d32 3536 5f63 7674 6570 6938 5f65 7069  m256_cvtepi8_epi
-0000c2d0: 3136 2820 5f6d 6d32 3536 5f63 6173 7473  16( _mm256_casts
-0000c2e0: 6932 3536 5f73 6931 3238 2820 6278 2029  i256_si128( bx )
-0000c2f0: 2029 3b0a 2020 2020 2020 2020 5f5f 6d32   );.        __m2
-0000c300: 3536 6920 7931 3620 3d20 5f6d 6d32 3536  56i y16 = _mm256
-0000c310: 5f63 7674 6570 6938 5f65 7069 3136 2820  _cvtepi8_epi16( 
-0000c320: 5f6d 6d32 3536 5f63 6173 7473 6932 3536  _mm256_castsi256
-0000c330: 5f73 6931 3238 2820 6279 2029 2029 3b0a  _si128( by ) );.
-0000c340: 2020 2020 2020 2020 2f2f 2043 6f6d 7075          // Compu
-0000c350: 7465 2070 726f 6475 6374 7320 6f66 2069  te products of i
-0000c360: 6e74 3136 5f74 2069 6e74 6567 6572 732c  nt16_t integers,
-0000c370: 2061 6464 2070 6169 7277 6973 650a 2020   add pairwise.  
-0000c380: 2020 2020 2020 5f5f 6d32 3536 6920 6933        __m256i i3
-0000c390: 3220 3d20 5f6d 6d32 3536 5f6d 6164 645f  2 = _mm256_madd_
-0000c3a0: 6570 6931 3628 2078 3136 2c20 7931 3620  epi16( x16, y16 
-0000c3b0: 293b 0a0a 2020 2020 2020 2020 2f2f 2053  );..        // S
-0000c3c0: 6967 6e2d 6578 7465 6e64 206c 6173 7420  ign-extend last 
-0000c3d0: 3136 2073 6967 6e65 6420 6279 7465 7320  16 signed bytes 
-0000c3e0: 696e 746f 2069 6e74 3136 5f74 2076 6563  into int16_t vec
-0000c3f0: 746f 7273 0a20 2020 2020 2020 2078 3136  tors.        x16
-0000c400: 203d 205f 6d6d 3235 365f 6376 7465 7069   = _mm256_cvtepi
-0000c410: 385f 6570 6931 3628 205f 6d6d 3235 365f  8_epi16( _mm256_
-0000c420: 6578 7472 6163 7469 3132 385f 7369 3235  extracti128_si25
-0000c430: 3628 2062 782c 2031 2029 2029 3b0a 2020  6( bx, 1 ) );.  
-0000c440: 2020 2020 2020 7931 3620 3d20 5f6d 6d32        y16 = _mm2
-0000c450: 3536 5f63 7674 6570 6938 5f65 7069 3136  56_cvtepi8_epi16
-0000c460: 2820 5f6d 6d32 3536 5f65 7874 7261 6374  ( _mm256_extract
-0000c470: 6931 3238 5f73 6932 3536 2820 6279 2c20  i128_si256( by, 
-0000c480: 3120 2920 293b 0a20 2020 2020 2020 202f  1 ) );.        /
-0000c490: 2f20 4163 6375 6d75 6c61 7465 2070 726f  / Accumulate pro
-0000c4a0: 6475 6374 7320 6f66 2069 6e74 3136 5f74  ducts of int16_t
-0000c4b0: 2069 6e74 6567 6572 730a 2020 2020 2020   integers.      
-0000c4c0: 2020 6933 3220 3d20 5f6d 6d32 3536 5f61    i32 = _mm256_a
-0000c4d0: 6464 5f65 7069 3332 2820 6933 322c 205f  dd_epi32( i32, _
-0000c4e0: 6d6d 3235 365f 6d61 6464 5f65 7069 3136  mm256_madd_epi16
-0000c4f0: 2820 7831 362c 2079 3136 2029 2029 3b0a  ( x16, y16 ) );.
-0000c500: 0a20 2020 2020 2020 202f 2f20 436f 6e76  .        // Conv
-0000c510: 6572 7420 696e 7433 325f 7420 746f 2066  ert int32_t to f
-0000c520: 6c6f 6174 0a20 2020 2020 2020 205f 5f6d  loat.        __m
-0000c530: 3235 3620 7020 3d20 5f6d 6d32 3536 5f63  256 p = _mm256_c
-0000c540: 7674 6570 6933 325f 7073 2820 6933 3220  vtepi32_ps( i32 
-0000c550: 293b 0a20 2020 2020 2020 202f 2f20 4170  );.        // Ap
-0000c560: 706c 7920 7468 6520 7363 616c 652c 2061  ply the scale, a
-0000c570: 6e64 2061 6363 756d 756c 6174 650a 2020  nd accumulate.  
-0000c580: 2020 2020 2020 6163 6320 3d20 5f6d 6d32        acc = _mm2
-0000c590: 3536 5f66 6d61 6464 5f70 7328 2073 6361  56_fmadd_ps( sca
-0000c5a0: 6c65 2c20 702c 2061 6363 2029 3b0a 2020  le, p, acc );.  
-0000c5b0: 2020 7d0a 0a20 2020 202f 2f20 5265 7475    }..    // Retu
-0000c5c0: 726e 2068 6f72 697a 6f6e 7461 6c20 7375  rn horizontal su
-0000c5d0: 6d20 6f66 2074 6865 2061 6363 2076 6563  m of the acc vec
-0000c5e0: 746f 720a 2020 2020 5f5f 6d31 3238 2072  tor.    __m128 r
-0000c5f0: 6573 203d 205f 6d6d 3235 365f 6578 7472  es = _mm256_extr
-0000c600: 6163 7466 3132 385f 7073 2820 6163 632c  actf128_ps( acc,
-0000c610: 2031 2029 3b0a 2020 2020 7265 7320 3d20   1 );.    res = 
-0000c620: 5f6d 6d5f 6164 645f 7073 2820 7265 732c  _mm_add_ps( res,
-0000c630: 205f 6d6d 3235 365f 6361 7374 7073 3235   _mm256_castps25
-0000c640: 365f 7073 3132 3828 2061 6363 2029 2029  6_ps128( acc ) )
-0000c650: 3b0a 2020 2020 7265 7320 3d20 5f6d 6d5f  ;.    res = _mm_
-0000c660: 6164 645f 7073 2820 7265 732c 205f 6d6d  add_ps( res, _mm
-0000c670: 5f6d 6f76 6568 6c5f 7073 2820 7265 732c  _movehl_ps( res,
-0000c680: 2072 6573 2029 2029 3b0a 2020 2020 7265   res ) );.    re
-0000c690: 7320 3d20 5f6d 6d5f 6164 645f 7373 2820  s = _mm_add_ss( 
-0000c6a0: 7265 732c 205f 6d6d 5f6d 6f76 6568 6475  res, _mm_movehdu
-0000c6b0: 705f 7073 2820 7265 7320 2920 293b 0a0a  p_ps( res ) );..
-0000c6c0: 2020 2020 7375 6d66 203d 205f 6d6d 5f63      sumf = _mm_c
-0000c6d0: 7674 7373 5f66 3332 2820 7265 7320 293b  vtss_f32( res );
-0000c6e0: 0a23 656c 7365 0a23 6572 726f 7220 226e  .#else.#error "n
-0000c6f0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2066  ot implemented f
-0000c700: 6f72 2051 4b22 0a23 656e 6469 660a 2365  or QK".#endif.#e
-0000c710: 6c69 6620 6465 6669 6e65 6428 5f5f 7761  lif defined(__wa
-0000c720: 736d 5f73 696d 6431 3238 5f5f 290a 2369  sm_simd128__).#i
-0000c730: 6620 514b 203d 3d20 3332 0a20 2020 202f  f QK == 32.    /
-0000c740: 2f20 7761 736d 2073 696d 640a 2020 2020  / wasm simd.    
-0000c750: 666c 6f61 7420 7375 6d30 203d 2030 2e30  float sum0 = 0.0
-0000c760: 663b 0a20 2020 2066 6c6f 6174 2073 756d  f;.    float sum
-0000c770: 3120 3d20 302e 3066 3b0a 0a20 2020 2066  1 = 0.0f;..    f
-0000c780: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0000c790: 203c 206e 623b 2069 202b 3d20 3229 207b   < nb; i += 2) {
-0000c7a0: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-0000c7b0: 6c6f 6174 2064 305f 3020 3d20 2a28 636f  loat d0_0 = *(co
-0000c7c0: 6e73 7420 666c 6f61 7420 2a29 2028 7064  nst float *) (pd
-0000c7d0: 3020 2b20 692a 6273 293b 0a20 2020 2020  0 + i*bs);.     
-0000c7e0: 2020 2063 6f6e 7374 2066 6c6f 6174 2064     const float d
-0000c7f0: 315f 3020 3d20 2a28 636f 6e73 7420 666c  1_0 = *(const fl
-0000c800: 6f61 7420 2a29 2028 7064 3120 2b20 692a  oat *) (pd1 + i*
-0000c810: 6273 293b 0a20 2020 2020 2020 2063 6f6e  bs);.        con
-0000c820: 7374 2066 6c6f 6174 2064 305f 3120 3d20  st float d0_1 = 
-0000c830: 2a28 636f 6e73 7420 666c 6f61 7420 2a29  *(const float *)
-0000c840: 2028 7064 3020 2b20 2869 202b 2031 292a   (pd0 + (i + 1)*
-0000c850: 6273 293b 0a20 2020 2020 2020 2063 6f6e  bs);.        con
-0000c860: 7374 2066 6c6f 6174 2064 315f 3120 3d20  st float d1_1 = 
-0000c870: 2a28 636f 6e73 7420 666c 6f61 7420 2a29  *(const float *)
-0000c880: 2028 7064 3120 2b20 2869 202b 2031 292a   (pd1 + (i + 1)*
-0000c890: 6273 293b 0a0a 2020 2020 2020 2020 636f  bs);..        co
-0000c8a0: 6e73 7420 7569 6e74 385f 7420 2a20 7265  nst uint8_t * re
-0000c8b0: 7374 7269 6374 2070 3020 3d20 7062 3020  strict p0 = pb0 
-0000c8c0: 2b20 692a 6273 3b0a 2020 2020 2020 2020  + i*bs;.        
-0000c8d0: 636f 6e73 7420 7569 6e74 385f 7420 2a20  const uint8_t * 
-0000c8e0: 7265 7374 7269 6374 2070 3120 3d20 7062  restrict p1 = pb
-0000c8f0: 3120 2b20 692a 6273 3b0a 0a20 2020 2020  1 + i*bs;..     
-0000c900: 2020 2063 6f6e 7374 2076 3132 385f 7420     const v128_t 
-0000c910: 6d34 6220 3d20 7761 736d 5f75 3878 3136  m4b = wasm_u8x16
-0000c920: 5f73 706c 6174 2830 7866 293b 0a20 2020  _splat(0xf);.   
-0000c930: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
-0000c940: 7420 7338 6220 3d20 7761 736d 5f69 3878  t s8b = wasm_i8x
-0000c950: 3136 5f73 706c 6174 2830 7838 293b 0a0a  16_splat(0x8);..
-0000c960: 2020 2020 2020 2020 636f 6e73 7420 7631          const v1
-0000c970: 3238 5f74 2076 305f 3020 3d20 7761 736d  28_t v0_0 = wasm
-0000c980: 5f76 3132 385f 6c6f 6164 2870 3029 3b0a  _v128_load(p0);.
-0000c990: 2020 2020 2020 2020 636f 6e73 7420 7631          const v1
-0000c9a0: 3238 5f74 2076 305f 3120 3d20 7761 736d  28_t v0_1 = wasm
-0000c9b0: 5f76 3132 385f 6c6f 6164 2870 3020 2b20  _v128_load(p0 + 
-0000c9c0: 6273 293b 0a20 2020 2020 2020 2063 6f6e  bs);.        con
-0000c9d0: 7374 2076 3132 385f 7420 7631 5f30 203d  st v128_t v1_0 =
-0000c9e0: 2077 6173 6d5f 7631 3238 5f6c 6f61 6428   wasm_v128_load(
-0000c9f0: 7031 293b 0a20 2020 2020 2020 2063 6f6e  p1);.        con
-0000ca00: 7374 2076 3132 385f 7420 7631 5f31 203d  st v128_t v1_1 =
-0000ca10: 2077 6173 6d5f 7631 3238 5f6c 6f61 6428   wasm_v128_load(
-0000ca20: 7031 202b 2062 7329 3b0a 0a20 2020 2020  p1 + bs);..     
-0000ca30: 2020 202f 2f20 342d 6269 7420 2d3e 2038     // 4-bit -> 8
-0000ca40: 2d62 6974 0a20 2020 2020 2020 2063 6f6e  -bit.        con
-0000ca50: 7374 2076 3132 385f 7420 7630 5f30 6c20  st v128_t v0_0l 
-0000ca60: 3d20 7761 736d 5f76 3132 385f 616e 6428  = wasm_v128_and(
-0000ca70: 7630 5f30 2c20 6d34 6229 3b0a 2020 2020  v0_0, m4b);.    
-0000ca80: 2020 2020 636f 6e73 7420 7631 3238 5f74      const v128_t
-0000ca90: 2076 315f 306c 203d 2077 6173 6d5f 7631   v1_0l = wasm_v1
-0000caa0: 3238 5f61 6e64 2876 315f 302c 206d 3462  28_and(v1_0, m4b
-0000cab0: 293b 0a0a 2020 2020 2020 2020 636f 6e73  );..        cons
-0000cac0: 7420 7631 3238 5f74 2076 305f 3068 203d  t v128_t v0_0h =
-0000cad0: 2077 6173 6d5f 7538 7831 365f 7368 7228   wasm_u8x16_shr(
-0000cae0: 7630 5f30 2c20 3429 3b0a 2020 2020 2020  v0_0, 4);.      
-0000caf0: 2020 636f 6e73 7420 7631 3238 5f74 2076    const v128_t v
-0000cb00: 315f 3068 203d 2077 6173 6d5f 7538 7831  1_0h = wasm_u8x1
-0000cb10: 365f 7368 7228 7631 5f30 2c20 3429 3b0a  6_shr(v1_0, 4);.
-0000cb20: 0a20 2020 2020 2020 2063 6f6e 7374 2076  .        const v
-0000cb30: 3132 385f 7420 7630 5f31 6c20 3d20 7761  128_t v0_1l = wa
-0000cb40: 736d 5f76 3132 385f 616e 6428 7630 5f31  sm_v128_and(v0_1
-0000cb50: 2c20 6d34 6229 3b0a 2020 2020 2020 2020  , m4b);.        
-0000cb60: 636f 6e73 7420 7631 3238 5f74 2076 315f  const v128_t v1_
-0000cb70: 316c 203d 2077 6173 6d5f 7631 3238 5f61  1l = wasm_v128_a
-0000cb80: 6e64 2876 315f 312c 206d 3462 293b 0a0a  nd(v1_1, m4b);..
-0000cb90: 2020 2020 2020 2020 636f 6e73 7420 7631          const v1
-0000cba0: 3238 5f74 2076 305f 3168 203d 2077 6173  28_t v0_1h = was
-0000cbb0: 6d5f 7538 7831 365f 7368 7228 7630 5f31  m_u8x16_shr(v0_1
-0000cbc0: 2c20 3429 3b0a 2020 2020 2020 2020 636f  , 4);.        co
-0000cbd0: 6e73 7420 7631 3238 5f74 2076 315f 3168  nst v128_t v1_1h
-0000cbe0: 203d 2077 6173 6d5f 7538 7831 365f 7368   = wasm_u8x16_sh
-0000cbf0: 7228 7631 5f31 2c20 3429 3b0a 0a20 2020  r(v1_1, 4);..   
-0000cc00: 2020 2020 202f 2f20 7375 6220 380a 2020       // sub 8.  
-0000cc10: 2020 2020 2020 636f 6e73 7420 7631 3238        const v128
-0000cc20: 5f74 2076 305f 306c 7320 3d20 7761 736d  _t v0_0ls = wasm
-0000cc30: 5f69 3878 3136 5f73 7562 2876 305f 306c  _i8x16_sub(v0_0l
-0000cc40: 2c20 7338 6229 3b0a 2020 2020 2020 2020  , s8b);.        
-0000cc50: 636f 6e73 7420 7631 3238 5f74 2076 315f  const v128_t v1_
-0000cc60: 306c 7320 3d20 7761 736d 5f69 3878 3136  0ls = wasm_i8x16
-0000cc70: 5f73 7562 2876 315f 306c 2c20 7338 6229  _sub(v1_0l, s8b)
-0000cc80: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
-0000cc90: 2076 3132 385f 7420 7630 5f30 6873 203d   v128_t v0_0hs =
-0000cca0: 2077 6173 6d5f 6938 7831 365f 7375 6228   wasm_i8x16_sub(
-0000ccb0: 7630 5f30 682c 2073 3862 293b 0a20 2020  v0_0h, s8b);.   
-0000ccc0: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
-0000ccd0: 7420 7631 5f30 6873 203d 2077 6173 6d5f  t v1_0hs = wasm_
-0000cce0: 6938 7831 365f 7375 6228 7631 5f30 682c  i8x16_sub(v1_0h,
-0000ccf0: 2073 3862 293b 0a0a 2020 2020 2020 2020   s8b);..        
-0000cd00: 636f 6e73 7420 7631 3238 5f74 2076 305f  const v128_t v0_
-0000cd10: 316c 7320 3d20 7761 736d 5f69 3878 3136  1ls = wasm_i8x16
-0000cd20: 5f73 7562 2876 305f 316c 2c20 7338 6229  _sub(v0_1l, s8b)
-0000cd30: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0000cd40: 7631 3238 5f74 2076 315f 316c 7320 3d20  v128_t v1_1ls = 
-0000cd50: 7761 736d 5f69 3878 3136 5f73 7562 2876  wasm_i8x16_sub(v
-0000cd60: 315f 316c 2c20 7338 6229 3b0a 0a20 2020  1_1l, s8b);..   
-0000cd70: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
-0000cd80: 7420 7630 5f31 6873 203d 2077 6173 6d5f  t v0_1hs = wasm_
-0000cd90: 6938 7831 365f 7375 6228 7630 5f31 682c  i8x16_sub(v0_1h,
-0000cda0: 2073 3862 293b 0a20 2020 2020 2020 2063   s8b);.        c
-0000cdb0: 6f6e 7374 2076 3132 385f 7420 7631 5f31  onst v128_t v1_1
-0000cdc0: 6873 203d 2077 6173 6d5f 6938 7831 365f  hs = wasm_i8x16_
-0000cdd0: 7375 6228 7631 5f31 682c 2073 3862 293b  sub(v1_1h, s8b);
-0000cde0: 0a0a 2020 2020 2020 2020 2f2f 2064 6f74  ..        // dot
-0000cdf0: 2070 726f 6475 6374 2069 6e74 6f20 696e   product into in
-0000ce00: 7431 3678 385f 740a 2020 2020 2020 2020  t16x8_t.        
-0000ce10: 636f 6e73 7420 7631 3238 5f74 2070 6c30  const v128_t pl0
-0000ce20: 6c20 3d20 7761 736d 5f69 3136 7838 5f6d  l = wasm_i16x8_m
-0000ce30: 756c 2877 6173 6d5f 6931 3678 385f 6578  ul(wasm_i16x8_ex
-0000ce40: 7465 6e64 5f6c 6f77 5f69 3878 3136 2876  tend_low_i8x16(v
-0000ce50: 305f 306c 7329 2c20 7761 736d 5f69 3136  0_0ls), wasm_i16
-0000ce60: 7838 5f65 7874 656e 645f 6c6f 775f 6938  x8_extend_low_i8
-0000ce70: 7831 3628 7631 5f30 6c73 2929 3b0a 2020  x16(v1_0ls));.  
-0000ce80: 2020 2020 2020 636f 6e73 7420 7631 3238        const v128
-0000ce90: 5f74 2070 6c30 6820 3d20 7761 736d 5f69  _t pl0h = wasm_i
-0000cea0: 3136 7838 5f6d 756c 2877 6173 6d5f 6931  16x8_mul(wasm_i1
-0000ceb0: 3678 385f 6578 7465 6e64 5f68 6967 685f  6x8_extend_high_
-0000cec0: 6938 7831 3628 7630 5f30 6c73 292c 2077  i8x16(v0_0ls), w
-0000ced0: 6173 6d5f 6931 3678 385f 6578 7465 6e64  asm_i16x8_extend
-0000cee0: 5f68 6967 685f 6938 7831 3628 7631 5f30  _high_i8x16(v1_0
-0000cef0: 6c73 2929 3b0a 0a20 2020 2020 2020 2063  ls));..        c
-0000cf00: 6f6e 7374 2076 3132 385f 7420 7068 306c  onst v128_t ph0l
-0000cf10: 203d 2077 6173 6d5f 6931 3678 385f 6d75   = wasm_i16x8_mu
-0000cf20: 6c28 7761 736d 5f69 3136 7838 5f65 7874  l(wasm_i16x8_ext
-0000cf30: 656e 645f 6c6f 775f 6938 7831 3628 7630  end_low_i8x16(v0
-0000cf40: 5f30 6873 292c 2077 6173 6d5f 6931 3678  _0hs), wasm_i16x
-0000cf50: 385f 6578 7465 6e64 5f6c 6f77 5f69 3878  8_extend_low_i8x
-0000cf60: 3136 2876 315f 3068 7329 293b 0a20 2020  16(v1_0hs));.   
-0000cf70: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
-0000cf80: 7420 7068 3068 203d 2077 6173 6d5f 6931  t ph0h = wasm_i1
-0000cf90: 3678 385f 6d75 6c28 7761 736d 5f69 3136  6x8_mul(wasm_i16
-0000cfa0: 7838 5f65 7874 656e 645f 6869 6768 5f69  x8_extend_high_i
-0000cfb0: 3878 3136 2876 305f 3068 7329 2c20 7761  8x16(v0_0hs), wa
-0000cfc0: 736d 5f69 3136 7838 5f65 7874 656e 645f  sm_i16x8_extend_
-0000cfd0: 6869 6768 5f69 3878 3136 2876 315f 3068  high_i8x16(v1_0h
-0000cfe0: 7329 293b 0a0a 2020 2020 2020 2020 636f  s));..        co
-0000cff0: 6e73 7420 7631 3238 5f74 2070 6c31 6c20  nst v128_t pl1l 
-0000d000: 3d20 7761 736d 5f69 3136 7838 5f6d 756c  = wasm_i16x8_mul
-0000d010: 2877 6173 6d5f 6931 3678 385f 6578 7465  (wasm_i16x8_exte
-0000d020: 6e64 5f6c 6f77 5f69 3878 3136 2876 305f  nd_low_i8x16(v0_
-0000d030: 316c 7329 2c20 7761 736d 5f69 3136 7838  1ls), wasm_i16x8
-0000d040: 5f65 7874 656e 645f 6c6f 775f 6938 7831  _extend_low_i8x1
-0000d050: 3628 7631 5f31 6c73 2929 3b0a 2020 2020  6(v1_1ls));.    
-0000d060: 2020 2020 636f 6e73 7420 7631 3238 5f74      const v128_t
-0000d070: 2070 6c31 6820 3d20 7761 736d 5f69 3136   pl1h = wasm_i16
-0000d080: 7838 5f6d 756c 2877 6173 6d5f 6931 3678  x8_mul(wasm_i16x
-0000d090: 385f 6578 7465 6e64 5f68 6967 685f 6938  8_extend_high_i8
-0000d0a0: 7831 3628 7630 5f31 6c73 292c 2077 6173  x16(v0_1ls), was
-0000d0b0: 6d5f 6931 3678 385f 6578 7465 6e64 5f68  m_i16x8_extend_h
-0000d0c0: 6967 685f 6938 7831 3628 7631 5f31 6c73  igh_i8x16(v1_1ls
-0000d0d0: 2929 3b0a 0a20 2020 2020 2020 2063 6f6e  ));..        con
-0000d0e0: 7374 2076 3132 385f 7420 7068 316c 203d  st v128_t ph1l =
-0000d0f0: 2077 6173 6d5f 6931 3678 385f 6d75 6c28   wasm_i16x8_mul(
-0000d100: 7761 736d 5f69 3136 7838 5f65 7874 656e  wasm_i16x8_exten
-0000d110: 645f 6c6f 775f 6938 7831 3628 7630 5f31  d_low_i8x16(v0_1
-0000d120: 6873 292c 2077 6173 6d5f 6931 3678 385f  hs), wasm_i16x8_
-0000d130: 6578 7465 6e64 5f6c 6f77 5f69 3878 3136  extend_low_i8x16
-0000d140: 2876 315f 3168 7329 293b 0a20 2020 2020  (v1_1hs));.     
-0000d150: 2020 2063 6f6e 7374 2076 3132 385f 7420     const v128_t 
-0000d160: 7068 3168 203d 2077 6173 6d5f 6931 3678  ph1h = wasm_i16x
-0000d170: 385f 6d75 6c28 7761 736d 5f69 3136 7838  8_mul(wasm_i16x8
-0000d180: 5f65 7874 656e 645f 6869 6768 5f69 3878  _extend_high_i8x
-0000d190: 3136 2876 305f 3168 7329 2c20 7761 736d  16(v0_1hs), wasm
-0000d1a0: 5f69 3136 7838 5f65 7874 656e 645f 6869  _i16x8_extend_hi
-0000d1b0: 6768 5f69 3878 3136 2876 315f 3168 7329  gh_i8x16(v1_1hs)
-0000d1c0: 293b 0a0a 2020 2020 2020 2020 636f 6e73  );..        cons
-0000d1d0: 7420 7631 3238 5f74 2070 6c5f 3020 3d20  t v128_t pl_0 = 
-0000d1e0: 7761 736d 5f69 3136 7838 5f61 6464 2870  wasm_i16x8_add(p
-0000d1f0: 6c30 6c2c 2070 6c30 6829 3b0a 2020 2020  l0l, pl0h);.    
-0000d200: 2020 2020 636f 6e73 7420 7631 3238 5f74      const v128_t
-0000d210: 2070 685f 3020 3d20 7761 736d 5f69 3136   ph_0 = wasm_i16
-0000d220: 7838 5f61 6464 2870 6830 6c2c 2070 6830  x8_add(ph0l, ph0
-0000d230: 6829 3b0a 0a20 2020 2020 2020 2063 6f6e  h);..        con
-0000d240: 7374 2076 3132 385f 7420 706c 5f31 203d  st v128_t pl_1 =
-0000d250: 2077 6173 6d5f 6931 3678 385f 6164 6428   wasm_i16x8_add(
-0000d260: 706c 316c 2c20 706c 3168 293b 0a20 2020  pl1l, pl1h);.   
-0000d270: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
-0000d280: 7420 7068 5f31 203d 2077 6173 6d5f 6931  t ph_1 = wasm_i1
-0000d290: 3678 385f 6164 6428 7068 316c 2c20 7068  6x8_add(ph1l, ph
-0000d2a0: 3168 293b 0a0a 2020 2020 2020 2020 636f  1h);..        co
-0000d2b0: 6e73 7420 7631 3238 5f74 2070 5f30 203d  nst v128_t p_0 =
-0000d2c0: 2077 6173 6d5f 6931 3678 385f 6164 6428   wasm_i16x8_add(
-0000d2d0: 706c 5f30 2c20 7068 5f30 293b 0a20 2020  pl_0, ph_0);.   
-0000d2e0: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
-0000d2f0: 7420 705f 3120 3d20 7761 736d 5f69 3136  t p_1 = wasm_i16
-0000d300: 7838 5f61 6464 2870 6c5f 312c 2070 685f  x8_add(pl_1, ph_
-0000d310: 3129 3b0a 0a20 2020 2020 2020 2073 756d  1);..        sum
-0000d320: 3020 2b3d 2064 305f 302a 6431 5f30 2a28  0 += d0_0*d1_0*(
-0000d330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d340: 2077 6173 6d5f 6931 3678 385f 6578 7472   wasm_i16x8_extr
-0000d350: 6163 745f 6c61 6e65 2870 5f30 2c20 3029  act_lane(p_0, 0)
-0000d360: 202b 2077 6173 6d5f 6931 3678 385f 6578   + wasm_i16x8_ex
-0000d370: 7472 6163 745f 6c61 6e65 2870 5f30 2c20  tract_lane(p_0, 
-0000d380: 3129 202b 0a20 2020 2020 2020 2020 2020  1) +.           
-0000d390: 2020 2020 2077 6173 6d5f 6931 3678 385f       wasm_i16x8_
-0000d3a0: 6578 7472 6163 745f 6c61 6e65 2870 5f30  extract_lane(p_0
-0000d3b0: 2c20 3229 202b 2077 6173 6d5f 6931 3678  , 2) + wasm_i16x
-0000d3c0: 385f 6578 7472 6163 745f 6c61 6e65 2870  8_extract_lane(p
-0000d3d0: 5f30 2c20 3329 202b 0a20 2020 2020 2020  _0, 3) +.       
-0000d3e0: 2020 2020 2020 2020 2077 6173 6d5f 6931           wasm_i1
-0000d3f0: 3678 385f 6578 7472 6163 745f 6c61 6e65  6x8_extract_lane
-0000d400: 2870 5f30 2c20 3429 202b 2077 6173 6d5f  (p_0, 4) + wasm_
-0000d410: 6931 3678 385f 6578 7472 6163 745f 6c61  i16x8_extract_la
-0000d420: 6e65 2870 5f30 2c20 3529 202b 0a20 2020  ne(p_0, 5) +.   
-0000d430: 2020 2020 2020 2020 2020 2020 2077 6173               was
-0000d440: 6d5f 6931 3678 385f 6578 7472 6163 745f  m_i16x8_extract_
-0000d450: 6c61 6e65 2870 5f30 2c20 3629 202b 2077  lane(p_0, 6) + w
-0000d460: 6173 6d5f 6931 3678 385f 6578 7472 6163  asm_i16x8_extrac
-0000d470: 745f 6c61 6e65 2870 5f30 2c20 3729 293b  t_lane(p_0, 7));
-0000d480: 0a20 2020 2020 2020 2073 756d 3120 2b3d  .        sum1 +=
-0000d490: 2064 305f 312a 6431 5f31 2a28 0a20 2020   d0_1*d1_1*(.   
-0000d4a0: 2020 2020 2020 2020 2020 2020 2077 6173               was
-0000d4b0: 6d5f 6931 3678 385f 6578 7472 6163 745f  m_i16x8_extract_
-0000d4c0: 6c61 6e65 2870 5f31 2c20 3029 202b 2077  lane(p_1, 0) + w
-0000d4d0: 6173 6d5f 6931 3678 385f 6578 7472 6163  asm_i16x8_extrac
-0000d4e0: 745f 6c61 6e65 2870 5f31 2c20 3129 202b  t_lane(p_1, 1) +
-0000d4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d500: 2077 6173 6d5f 6931 3678 385f 6578 7472   wasm_i16x8_extr
-0000d510: 6163 745f 6c61 6e65 2870 5f31 2c20 3229  act_lane(p_1, 2)
-0000d520: 202b 2077 6173 6d5f 6931 3678 385f 6578   + wasm_i16x8_ex
-0000d530: 7472 6163 745f 6c61 6e65 2870 5f31 2c20  tract_lane(p_1, 
-0000d540: 3329 202b 0a20 2020 2020 2020 2020 2020  3) +.           
-0000d550: 2020 2020 2077 6173 6d5f 6931 3678 385f       wasm_i16x8_
-0000d560: 6578 7472 6163 745f 6c61 6e65 2870 5f31  extract_lane(p_1
-0000d570: 2c20 3429 202b 2077 6173 6d5f 6931 3678  , 4) + wasm_i16x
-0000d580: 385f 6578 7472 6163 745f 6c61 6e65 2870  8_extract_lane(p
-0000d590: 5f31 2c20 3529 202b 0a20 2020 2020 2020  _1, 5) +.       
-0000d5a0: 2020 2020 2020 2020 2077 6173 6d5f 6931           wasm_i1
-0000d5b0: 3678 385f 6578 7472 6163 745f 6c61 6e65  6x8_extract_lane
-0000d5c0: 2870 5f31 2c20 3629 202b 2077 6173 6d5f  (p_1, 6) + wasm_
-0000d5d0: 6931 3678 385f 6578 7472 6163 745f 6c61  i16x8_extract_la
-0000d5e0: 6e65 2870 5f31 2c20 3729 293b 0a20 2020  ne(p_1, 7));.   
-0000d5f0: 207d 0a0a 2020 2020 7375 6d66 203d 2073   }..    sumf = s
-0000d600: 756d 3020 2b20 7375 6d31 3b0a 2365 6c73  um0 + sum1;.#els
-0000d610: 650a 2365 7272 6f72 2022 6e6f 7420 696d  e.#error "not im
-0000d620: 706c 656d 656e 7465 6420 666f 7220 514b  plemented for QK
-0000d630: 220a 2365 6e64 6966 0a23 656c 7365 0a20  ".#endif.#else. 
-0000d640: 2020 202f 2f20 7363 616c 6172 0a20 2020     // scalar.   
-0000d650: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0000d660: 2069 203c 206e 623b 2069 2b2b 2920 7b0a   i < nb; i++) {.
-0000d670: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0000d680: 6f61 7420 6430 203d 202a 2863 6f6e 7374  oat d0 = *(const
-0000d690: 2066 6c6f 6174 202a 2920 2870 6430 202b   float *) (pd0 +
-0000d6a0: 2069 2a62 7329 3b0a 2020 2020 2020 2020   i*bs);.        
-0000d6b0: 636f 6e73 7420 666c 6f61 7420 6431 203d  const float d1 =
-0000d6c0: 202a 2863 6f6e 7374 2066 6c6f 6174 202a   *(const float *
-0000d6d0: 2920 2870 6431 202b 2069 2a62 7329 3b0a  ) (pd1 + i*bs);.
-0000d6e0: 0a20 2020 2020 2020 2063 6f6e 7374 2075  .        const u
-0000d6f0: 696e 7438 5f74 202a 2072 6573 7472 6963  int8_t * restric
-0000d700: 7420 7030 203d 2070 6230 202b 2069 2a62  t p0 = pb0 + i*b
-0000d710: 733b 0a20 2020 2020 2020 2063 6f6e 7374  s;.        const
-0000d720: 2075 696e 7438 5f74 202a 2072 6573 7472   uint8_t * restr
-0000d730: 6963 7420 7031 203d 2070 6231 202b 2069  ict p1 = pb1 + i
-0000d740: 2a62 733b 0a0a 2020 2020 2020 2020 666f  *bs;..        fo
-0000d750: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-0000d760: 3c20 514b 2f32 3b20 6a2b 2b29 207b 0a20  < QK/2; j++) {. 
-0000d770: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0000d780: 2075 696e 7438 5f74 2076 3020 3d20 7030   uint8_t v0 = p0
-0000d790: 5b6a 5d3b 0a20 2020 2020 2020 2020 2020  [j];.           
-0000d7a0: 2063 6f6e 7374 2075 696e 7438 5f74 2076   const uint8_t v
-0000d7b0: 3120 3d20 7031 5b6a 5d3b 0a0a 2020 2020  1 = p1[j];..    
-0000d7c0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0000d7d0: 6f61 7420 6630 203d 2064 302a 2828 696e  oat f0 = d0*((in
-0000d7e0: 7438 5f74 2920 2876 3020 2620 3078 6629  t8_t) (v0 & 0xf)
-0000d7f0: 202d 2038 293b 0a20 2020 2020 2020 2020   - 8);.         
-0000d800: 2020 2063 6f6e 7374 2066 6c6f 6174 2066     const float f
-0000d810: 3120 3d20 6430 2a28 2869 6e74 385f 7429  1 = d0*((int8_t)
-0000d820: 2028 7630 203e 3e20 3429 2020 2d20 3829   (v0 >> 4)  - 8)
-0000d830: 3b0a 0a20 2020 2020 2020 2020 2020 2063  ;..            c
-0000d840: 6f6e 7374 2066 6c6f 6174 2066 3220 3d20  onst float f2 = 
-0000d850: 6431 2a28 2869 6e74 385f 7429 2028 7631  d1*((int8_t) (v1
-0000d860: 2026 2030 7866 2920 2d20 3829 3b0a 2020   & 0xf) - 8);.  
-0000d870: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0000d880: 666c 6f61 7420 6633 203d 2064 312a 2828  float f3 = d1*((
-0000d890: 696e 7438 5f74 2920 2876 3120 3e3e 2034  int8_t) (v1 >> 4
-0000d8a0: 2920 202d 2038 293b 0a0a 2020 2020 2020  )  - 8);..      
-0000d8b0: 2020 2020 2020 7375 6d66 202b 3d20 6630        sumf += f0
-0000d8c0: 2a66 3220 2b20 6631 2a66 333b 0a20 2020  *f2 + f1*f3;.   
-0000d8d0: 2020 2020 207d 0a20 2020 207d 0a23 656e       }.    }.#en
-0000d8e0: 6469 660a 0a20 2020 202a 7320 3d20 7375  dif..    *s = su
-0000d8f0: 6d66 3b0a 7d0a 0a69 6e6c 696e 6520 7374  mf;.}..inline st
-0000d900: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
-0000d910: 6563 5f64 6f74 5f71 345f 3128 636f 6e73  ec_dot_q4_1(cons
-0000d920: 7420 696e 7420 6e2c 2066 6c6f 6174 202a  t int n, float *
-0000d930: 2072 6573 7472 6963 7420 732c 2063 6f6e   restrict s, con
-0000d940: 7374 2076 6f69 6420 2a20 7265 7374 7269  st void * restri
-0000d950: 6374 2078 2c20 636f 6e73 7420 766f 6964  ct x, const void
-0000d960: 202a 2072 6573 7472 6963 7420 7929 207b   * restrict y) {
-0000d970: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0000d980: 6220 3d20 6e20 2f20 514b 3b0a 0a20 2020  b = n / QK;..   
-0000d990: 2063 6f6e 7374 2073 697a 655f 7420 6273   const size_t bs
-0000d9a0: 203d 2032 2a73 697a 656f 6628 666c 6f61   = 2*sizeof(floa
-0000d9b0: 7429 202b 2051 4b2f 323b 0a0a 2020 2020  t) + QK/2;..    
-0000d9c0: 636f 6e73 7420 7569 6e74 385f 7420 2a20  const uint8_t * 
-0000d9d0: 7265 7374 7269 6374 2070 6430 203d 2028  restrict pd0 = (
-0000d9e0: 2863 6f6e 7374 2075 696e 7438 5f74 202a  (const uint8_t *
-0000d9f0: 2978 202b 2030 2a62 7329 3b0a 2020 2020  )x + 0*bs);.    
-0000da00: 636f 6e73 7420 7569 6e74 385f 7420 2a20  const uint8_t * 
-0000da10: 7265 7374 7269 6374 2070 6431 203d 2028  restrict pd1 = (
-0000da20: 2863 6f6e 7374 2075 696e 7438 5f74 202a  (const uint8_t *
-0000da30: 2979 202b 2030 2a62 7329 3b0a 0a20 2020  )y + 0*bs);..   
-0000da40: 2063 6f6e 7374 2075 696e 7438 5f74 202a   const uint8_t *
-0000da50: 2072 6573 7472 6963 7420 706d 3020 3d20   restrict pm0 = 
-0000da60: 2828 636f 6e73 7420 7569 6e74 385f 7420  ((const uint8_t 
-0000da70: 2a29 7820 2b20 302a 6273 202b 2073 697a  *)x + 0*bs + siz
-0000da80: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-0000da90: 2063 6f6e 7374 2075 696e 7438 5f74 202a   const uint8_t *
-0000daa0: 2072 6573 7472 6963 7420 706d 3120 3d20   restrict pm1 = 
-0000dab0: 2828 636f 6e73 7420 7569 6e74 385f 7420  ((const uint8_t 
-0000dac0: 2a29 7920 2b20 302a 6273 202b 2073 697a  *)y + 0*bs + siz
-0000dad0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-0000dae0: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
-0000daf0: 2a20 7265 7374 7269 6374 2070 6230 203d  * restrict pb0 =
-0000db00: 2028 2863 6f6e 7374 2075 696e 7438 5f74   ((const uint8_t
-0000db10: 202a 2978 202b 2030 2a62 7320 2b20 322a   *)x + 0*bs + 2*
-0000db20: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-0000db30: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-0000db40: 7420 2a20 7265 7374 7269 6374 2070 6231  t * restrict pb1
-0000db50: 203d 2028 2863 6f6e 7374 2075 696e 7438   = ((const uint8
-0000db60: 5f74 202a 2979 202b 2030 2a62 7320 2b20  _t *)y + 0*bs + 
-0000db70: 322a 7369 7a65 6f66 2866 6c6f 6174 2929  2*sizeof(float))
-0000db80: 3b0a 0a20 2020 2066 6c6f 6174 2073 756d  ;..    float sum
-0000db90: 6620 3d20 302e 303b 0a0a 2369 6620 6465  f = 0.0;..#if de
-0000dba0: 6669 6e65 6428 5f5f 4156 5832 5f5f 290a  fined(__AVX2__).
-0000dbb0: 2369 6620 514b 203d 3d20 3332 0a20 2020  #if QK == 32.   
-0000dbc0: 202f 2f20 496e 6974 6961 6c69 7a65 2061   // Initialize a
-0000dbd0: 6363 756d 756c 6174 6f72 2077 6974 6820  ccumulator with 
-0000dbe0: 7a65 726f 730a 2020 2020 5f5f 6d32 3536  zeros.    __m256
-0000dbf0: 2061 6363 203d 205f 6d6d 3235 365f 7365   acc = _mm256_se
-0000dc00: 747a 6572 6f5f 7073 2829 3b0a 2020 2020  tzero_ps();.    
-0000dc10: 2f2f 2041 6363 756d 756c 6174 6f72 2066  // Accumulator f
-0000dc20: 6f72 2063 6f6e 7374 616e 7420 6f66 6673  or constant offs
-0000dc30: 6574 730a 2020 2020 666c 6f61 7420 6163  ets.    float ac
-0000dc40: 635f 6f66 6673 6574 203d 2030 2e30 663b  c_offset = 0.0f;
-0000dc50: 0a0a 2020 2020 2f2f 204d 6169 6e20 6c6f  ..    // Main lo
-0000dc60: 6f70 0a20 2020 2066 6f72 2028 696e 7420  op.    for (int 
-0000dc70: 6920 3d20 303b 2069 203c 206e 623b 202b  i = 0; i < nb; +
-0000dc80: 2b69 2920 7b0a 2020 2020 2020 2020 636f  +i) {.        co
-0000dc90: 6e73 7420 666c 6f61 7420 2a20 6d30 203d  nst float * m0 =
-0000dca0: 2028 636f 6e73 7420 666c 6f61 7420 2a29   (const float *)
-0000dcb0: 2028 706d 3020 2b20 692a 6273 293b 0a20   (pm0 + i*bs);. 
-0000dcc0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0000dcd0: 6174 202a 206d 3120 3d20 2863 6f6e 7374  at * m1 = (const
-0000dce0: 2066 6c6f 6174 202a 2920 2870 6d31 202b   float *) (pm1 +
-0000dcf0: 2069 2a62 7329 3b0a 0a20 2020 2020 2020   i*bs);..       
-0000dd00: 2063 6f6e 7374 2066 6c6f 6174 202a 2064   const float * d
-0000dd10: 3020 3d20 2863 6f6e 7374 2066 6c6f 6174  0 = (const float
-0000dd20: 202a 2920 2870 6430 202b 2069 2a62 7329   *) (pd0 + i*bs)
-0000dd30: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0000dd40: 666c 6f61 7420 2a20 6431 203d 2028 636f  float * d1 = (co
-0000dd50: 6e73 7420 666c 6f61 7420 2a29 2028 7064  nst float *) (pd
-0000dd60: 3120 2b20 692a 6273 293b 0a0a 2020 2020  1 + i*bs);..    
-0000dd70: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-0000dd80: 7420 2a20 7265 7374 7269 6374 2070 3020  t * restrict p0 
-0000dd90: 3d20 7062 3020 2b20 692a 6273 3b0a 2020  = pb0 + i*bs;.  
-0000dda0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-0000ddb0: 385f 7420 2a20 7265 7374 7269 6374 2070  8_t * restrict p
-0000ddc0: 3120 3d20 7062 3120 2b20 692a 6273 3b0a  1 = pb1 + i*bs;.
-0000ddd0: 0a20 2020 2020 2020 2063 6f6e 7374 205f  .        const _
-0000dde0: 5f6d 3235 3620 6430 7620 3d20 5f6d 6d32  _m256 d0v = _mm2
-0000ddf0: 3536 5f62 726f 6164 6361 7374 5f73 7328  56_broadcast_ss(
-0000de00: 2064 3020 293b 0a20 2020 2020 2020 2063   d0 );.        c
-0000de10: 6f6e 7374 205f 5f6d 3235 3620 6431 7620  onst __m256 d1v 
-0000de20: 3d20 5f6d 6d32 3536 5f62 726f 6164 6361  = _mm256_broadca
-0000de30: 7374 5f73 7328 2064 3120 293b 0a20 2020  st_ss( d1 );.   
-0000de40: 2020 2020 2063 6f6e 7374 205f 5f6d 3235       const __m25
-0000de50: 3620 6d30 7620 3d20 5f6d 6d32 3536 5f62  6 m0v = _mm256_b
-0000de60: 726f 6164 6361 7374 5f73 7328 206d 3020  roadcast_ss( m0 
-0000de70: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-0000de80: 205f 5f6d 3235 3620 6d31 7620 3d20 5f6d   __m256 m1v = _m
-0000de90: 6d32 3536 5f62 726f 6164 6361 7374 5f73  m256_broadcast_s
-0000dea0: 7328 206d 3120 293b 0a0a 0a20 2020 2020  s( m1 );...     
-0000deb0: 2020 202f 2f20 436f 6d70 7574 6520 636f     // Compute co
-0000dec0: 6d62 696e 6564 2073 6361 6c65 2066 6f72  mbined scale for
-0000ded0: 2074 6865 2062 6c6f 636b 0a20 2020 2020   the block.     
-0000dee0: 2020 2063 6f6e 7374 205f 5f6d 3235 3620     const __m256 
-0000def0: 7363 616c 655f 3031 203d 205f 6d6d 3235  scale_01 = _mm25
-0000df00: 365f 6d75 6c5f 7073 2820 6430 762c 2064  6_mul_ps( d0v, d
-0000df10: 3176 2029 3b0a 0a20 2020 2020 2020 202f  1v );..        /
-0000df20: 2f20 436f 6d70 7574 6520 6372 6f73 7320  / Compute cross 
-0000df30: 7363 616c 6573 2066 6f72 2074 6865 2062  scales for the b
-0000df40: 6c6f 636b 0a20 2020 2020 2020 2063 6f6e  lock.        con
-0000df50: 7374 205f 5f6d 3235 3620 7363 616c 655f  st __m256 scale_
-0000df60: 3020 3d20 5f6d 6d32 3536 5f6d 756c 5f70  0 = _mm256_mul_p
-0000df70: 7328 2064 3076 2c20 6d31 7620 293b 0a20  s( d0v, m1v );. 
-0000df80: 2020 2020 2020 2063 6f6e 7374 205f 5f6d         const __m
-0000df90: 3235 3620 7363 616c 655f 3120 3d20 5f6d  256 scale_1 = _m
-0000dfa0: 6d32 3536 5f6d 756c 5f70 7328 206d 3076  m256_mul_ps( m0v
-0000dfb0: 2c20 6431 7620 293b 0a20 2020 2020 2020  , d1v );.       
-0000dfc0: 2063 6f6e 7374 205f 5f6d 3235 3620 6372   const __m256 cr
-0000dfd0: 6f73 735f 7363 616c 6573 203d 205f 6d6d  oss_scales = _mm
-0000dfe0: 3235 365f 626c 656e 645f 7073 2820 7363  256_blend_ps( sc
-0000dff0: 616c 655f 302c 2073 6361 6c65 5f31 2c20  ale_0, scale_1, 
-0000e000: 3062 3130 3130 3130 3130 2029 3b0a 0a20  0b10101010 );.. 
-0000e010: 2020 2020 2020 202f 2f20 4c6f 6164 2031         // Load 1
-0000e020: 3620 6279 7465 732c 2061 6e64 2075 6e70  6 bytes, and unp
-0000e030: 6163 6b20 3420 6269 7420 6669 656c 6473  ack 4 bit fields
-0000e040: 2069 6e74 6f20 6279 7465 732c 206d 616b   into bytes, mak
-0000e050: 696e 6720 3332 2062 7974 6573 0a20 2020  ing 32 bytes.   
-0000e060: 2020 2020 205f 5f6d 3235 3669 2062 7820       __m256i bx 
-0000e070: 3d20 6279 7465 7346 726f 6d4e 6962 626c  = bytesFromNibbl
-0000e080: 6573 2820 7030 2029 3b0a 2020 2020 2020  es( p0 );.      
-0000e090: 2020 5f5f 6d32 3536 6920 6279 203d 2062    __m256i by = b
-0000e0a0: 7974 6573 4672 6f6d 4e69 6262 6c65 7328  ytesFromNibbles(
-0000e0b0: 2070 3120 293b 0a0a 2020 2020 2020 2020   p1 );..        
-0000e0c0: 2f2f 204e 6f77 2077 6520 6861 7665 2061  // Now we have a
-0000e0d0: 2076 6563 746f 7220 7769 7468 2062 7974   vector with byt
-0000e0e0: 6573 2069 6e20 5b20 3020 2e2e 2031 3520  es in [ 0 .. 15 
-0000e0f0: 5d20 696e 7465 7276 616c 2e0a 0a20 2020  ] interval...   
-0000e100: 2020 2020 202f 2f20 5369 676e 2d65 7874       // Sign-ext
-0000e110: 656e 6420 6669 7273 7420 3136 2073 6967  end first 16 sig
-0000e120: 6e65 6420 6279 7465 7320 696e 746f 2069  ned bytes into i
-0000e130: 6e74 3136 5f74 0a20 2020 2020 2020 205f  nt16_t.        _
-0000e140: 5f6d 3235 3669 2078 3136 203d 205f 6d6d  _m256i x16 = _mm
-0000e150: 3235 365f 6376 7465 7069 385f 6570 6931  256_cvtepi8_epi1
-0000e160: 3628 205f 6d6d 3235 365f 6361 7374 7369  6( _mm256_castsi
-0000e170: 3235 365f 7369 3132 3828 2062 7820 2920  256_si128( bx ) 
-0000e180: 293b 0a20 2020 2020 2020 205f 5f6d 3235  );.        __m25
-0000e190: 3669 2079 3136 203d 205f 6d6d 3235 365f  6i y16 = _mm256_
-0000e1a0: 6376 7465 7069 385f 6570 6931 3628 205f  cvtepi8_epi16( _
-0000e1b0: 6d6d 3235 365f 6361 7374 7369 3235 365f  mm256_castsi256_
-0000e1c0: 7369 3132 3828 2062 7920 2920 293b 0a20  si128( by ) );. 
-0000e1d0: 2020 2020 2020 202f 2f20 436f 6d70 7574         // Comput
-0000e1e0: 6520 7072 6f64 7563 7473 206f 6620 696e  e products of in
-0000e1f0: 7431 365f 7420 696e 7465 6765 7273 2c20  t16_t integers, 
-0000e200: 6164 6420 7061 6972 7769 7365 0a20 2020  add pairwise.   
-0000e210: 2020 2020 205f 5f6d 3235 3669 2069 3332       __m256i i32
-0000e220: 203d 205f 6d6d 3235 365f 6d61 6464 5f65   = _mm256_madd_e
-0000e230: 7069 3136 2820 7831 362c 2079 3136 2029  pi16( x16, y16 )
-0000e240: 3b0a 0a20 2020 2020 2020 202f 2f20 5369  ;..        // Si
-0000e250: 676e 2d65 7874 656e 6420 6c61 7374 2031  gn-extend last 1
-0000e260: 3620 7369 676e 6564 2062 7974 6573 2069  6 signed bytes i
-0000e270: 6e74 6f20 696e 7431 365f 7420 7665 6374  nto int16_t vect
-0000e280: 6f72 730a 2020 2020 2020 2020 5f5f 6d32  ors.        __m2
-0000e290: 3536 6920 7831 365f 6820 3d20 5f6d 6d32  56i x16_h = _mm2
-0000e2a0: 3536 5f63 7674 6570 6938 5f65 7069 3136  56_cvtepi8_epi16
-0000e2b0: 2820 5f6d 6d32 3536 5f65 7874 7261 6374  ( _mm256_extract
-0000e2c0: 6931 3238 5f73 6932 3536 2820 6278 2c20  i128_si256( bx, 
-0000e2d0: 3120 2920 293b 0a20 2020 2020 2020 205f  1 ) );.        _
-0000e2e0: 5f6d 3235 3669 2079 3136 5f68 203d 205f  _m256i y16_h = _
-0000e2f0: 6d6d 3235 365f 6376 7465 7069 385f 6570  mm256_cvtepi8_ep
-0000e300: 6931 3628 205f 6d6d 3235 365f 6578 7472  i16( _mm256_extr
-0000e310: 6163 7469 3132 385f 7369 3235 3628 2062  acti128_si256( b
-0000e320: 792c 2031 2029 2029 3b0a 2020 2020 2020  y, 1 ) );.      
-0000e330: 2020 2f2f 2041 6363 756d 756c 6174 6520    // Accumulate 
-0000e340: 7072 6f64 7563 7473 206f 6620 696e 7431  products of int1
-0000e350: 365f 7420 696e 7465 6765 7273 0a20 2020  6_t integers.   
-0000e360: 2020 2020 2069 3332 203d 205f 6d6d 3235       i32 = _mm25
-0000e370: 365f 6164 645f 6570 6933 3228 2069 3332  6_add_epi32( i32
-0000e380: 2c20 5f6d 6d32 3536 5f6d 6164 645f 6570  , _mm256_madd_ep
-0000e390: 6931 3628 2078 3136 5f68 2c20 7931 365f  i16( x16_h, y16_
-0000e3a0: 6820 2920 293b 0a0a 2020 2020 2020 2020  h ) );..        
-0000e3b0: 2f2f 2063 6f6d 7075 7465 2073 756d 7320  // compute sums 
-0000e3c0: 6f66 2075 6e73 6967 6e65 6420 6279 7465  of unsigned byte
-0000e3d0: 7320 696e 2062 782c 2062 7920 696e 2062  s in bx, by in b
-0000e3e0: 6c6f 636b 7320 6f66 2038 2e0a 2020 2020  locks of 8..    
-0000e3f0: 2020 2020 2f2f 2054 6869 7320 7265 7375      // This resu
-0000e400: 6c74 7320 696e 2061 206c 6179 6f75 7420  lts in a layout 
-0000e410: 6c69 6b65 2058 3130 3020 3030 3030 2058  like X100 0000 X
-0000e420: 3230 3020 3030 3030 2058 3330 3020 3030  200 0000 X300 00
-0000e430: 3030 2058 3430 3020 3030 3030 2c0a 2020  00 X400 0000,.  
-0000e440: 2020 2020 2020 2f2f 2077 6869 6368 2077        // which w
-0000e450: 6520 7468 656e 2069 6e74 6572 6c65 6176  e then interleav
-0000e460: 6520 6173 2058 3130 3020 5931 3030 2058  e as X100 Y100 X
-0000e470: 3230 3020 5932 3030 2058 3330 3020 5933  200 Y200 X300 Y3
-0000e480: 3030 2058 3430 3020 5934 3030 2e0a 2020  00 X400 Y400..  
-0000e490: 2020 2020 2020 2f2f 2073 6f20 6966 2077        // so if w
-0000e4a0: 6520 7468 656e 2063 6173 7420 746f 2038  e then cast to 8
-0000e4b0: 2073 696e 676c 6573 2c20 7765 2067 6574   singles, we get
-0000e4c0: 2038 2066 6c6f 6174 7320 6c69 6b65 205b   8 floats like [
-0000e4d0: 2078 305f 372c 2079 305f 372c 2078 385f   x0_7, y0_7, x8_
-0000e4e0: 3135 2c20 7938 5f31 352c 2078 3136 5f32  15, y8_15, x16_2
-0000e4f0: 332c 2079 3136 5f32 332c 2078 3234 5f33  3, y16_23, x24_3
-0000e500: 312c 2079 3234 5f33 3120 5d0a 2020 2020  1, y24_31 ].    
-0000e510: 2020 2020 5f5f 6d32 3536 6920 7873 756d      __m256i xsum
-0000e520: 6920 3d20 5f6d 6d32 3536 5f73 6164 5f65  i = _mm256_sad_e
-0000e530: 7075 3828 2062 782c 205f 6d6d 3235 365f  pu8( bx, _mm256_
-0000e540: 7365 747a 6572 6f5f 7369 3235 3628 2920  setzero_si256() 
-0000e550: 293b 0a20 2020 2020 2020 205f 5f6d 3235  );.        __m25
-0000e560: 3669 2079 7375 6d69 203d 205f 6d6d 3235  6i ysumi = _mm25
-0000e570: 365f 7361 645f 6570 7538 2820 6279 2c20  6_sad_epu8( by, 
-0000e580: 5f6d 6d32 3536 5f73 6574 7a65 726f 5f73  _mm256_setzero_s
-0000e590: 6932 3536 2829 2029 3b0a 2020 2020 2020  i256() );.      
-0000e5a0: 2020 5f5f 6d32 3536 6920 7375 6d73 6920    __m256i sumsi 
-0000e5b0: 3d20 5f6d 6d32 3536 5f6f 725f 7369 3235  = _mm256_or_si25
-0000e5c0: 3628 2078 7375 6d69 2c20 5f6d 6d32 3536  6( xsumi, _mm256
-0000e5d0: 5f73 6c6c 695f 7369 3235 3628 2079 7375  _slli_si256( ysu
-0000e5e0: 6d69 2c20 3420 2920 293b 0a20 2020 2020  mi, 4 ) );.     
-0000e5f0: 2020 205f 5f6d 3235 3620 2073 756d 7320     __m256  sums 
-0000e600: 203d 205f 6d6d 3235 365f 6376 7465 7069   = _mm256_cvtepi
-0000e610: 3332 5f70 7328 2073 756d 7369 2029 3b0a  32_ps( sumsi );.
-0000e620: 0a20 2020 2020 2020 202f 2f20 436f 6e76  .        // Conv
-0000e630: 6572 7420 696e 7433 325f 7420 746f 2066  ert int32_t to f
-0000e640: 6c6f 6174 0a20 2020 2020 2020 205f 5f6d  loat.        __m
-0000e650: 3235 3620 7020 3d20 5f6d 6d32 3536 5f63  256 p = _mm256_c
-0000e660: 7674 6570 6933 325f 7073 2820 6933 3220  vtepi32_ps( i32 
-0000e670: 293b 0a20 2020 2020 2020 202f 2f20 4170  );.        // Ap
-0000e680: 706c 7920 7468 6520 7363 616c 652c 2061  ply the scale, a
-0000e690: 6e64 2061 6363 756d 756c 6174 650a 2020  nd accumulate.  
-0000e6a0: 2020 2020 2020 2f2f 2061 6363 202b 3d20        // acc += 
-0000e6b0: 6430 2a64 312a 782a 7920 2b20 6430 2a6d  d0*d1*x*y + d0*m
-0000e6c0: 312a 7820 2b20 6431 2a6d 302a 790a 2020  1*x + d1*m0*y.  
-0000e6d0: 2020 2020 2020 6163 6320 3d20 5f6d 6d32        acc = _mm2
-0000e6e0: 3536 5f66 6d61 6464 5f70 7328 2073 6361  56_fmadd_ps( sca
-0000e6f0: 6c65 5f30 312c 2070 2c20 6163 6320 293b  le_01, p, acc );
-0000e700: 0a20 2020 2020 2020 2061 6363 203d 205f  .        acc = _
-0000e710: 6d6d 3235 365f 666d 6164 645f 7073 2820  mm256_fmadd_ps( 
-0000e720: 6372 6f73 735f 7363 616c 6573 2c20 7375  cross_scales, su
-0000e730: 6d73 2c20 6163 6320 293b 0a20 2020 2020  ms, acc );.     
-0000e740: 2020 202f 2f20 6163 635f 6f66 6673 6574     // acc_offset
-0000e750: 202b 3d20 6d30 2a6d 3120 2866 6f72 2065   += m0*m1 (for e
-0000e760: 6163 6820 656e 7472 7920 696e 2074 6865  ach entry in the
-0000e770: 2062 6c6f 636b 290a 2020 2020 2020 2020   block).        
-0000e780: 6163 635f 6f66 6673 6574 202b 3d20 282a  acc_offset += (*
-0000e790: 6d30 292a 282a 6d31 293b 0a20 2020 207d  m0)*(*m1);.    }
-0000e7a0: 0a0a 2020 2020 2f2f 2052 6574 7572 6e20  ..    // Return 
-0000e7b0: 686f 7269 7a6f 6e74 616c 2073 756d 206f  horizontal sum o
-0000e7c0: 6620 7468 6520 6163 6320 7665 6374 6f72  f the acc vector
-0000e7d0: 0a20 2020 205f 5f6d 3132 3820 7265 7320  .    __m128 res 
-0000e7e0: 3d20 5f6d 6d32 3536 5f65 7874 7261 6374  = _mm256_extract
-0000e7f0: 6631 3238 5f70 7328 2061 6363 2c20 3120  f128_ps( acc, 1 
-0000e800: 293b 0a20 2020 2072 6573 203d 205f 6d6d  );.    res = _mm
-0000e810: 5f61 6464 5f70 7328 2072 6573 2c20 5f6d  _add_ps( res, _m
-0000e820: 6d32 3536 5f63 6173 7470 7332 3536 5f70  m256_castps256_p
-0000e830: 7331 3238 2820 6163 6320 2920 293b 0a20  s128( acc ) );. 
-0000e840: 2020 2072 6573 203d 205f 6d6d 5f61 6464     res = _mm_add
-0000e850: 5f70 7328 2072 6573 2c20 5f6d 6d5f 6d6f  _ps( res, _mm_mo
-0000e860: 7665 686c 5f70 7328 2072 6573 2c20 7265  vehl_ps( res, re
-0000e870: 7320 2920 293b 0a20 2020 2072 6573 203d  s ) );.    res =
-0000e880: 205f 6d6d 5f61 6464 5f73 7328 2072 6573   _mm_add_ss( res
-0000e890: 2c20 5f6d 6d5f 6d6f 7665 6864 7570 5f70  , _mm_movehdup_p
-0000e8a0: 7328 2072 6573 2029 2029 3b0a 0a20 2020  s( res ) );..   
-0000e8b0: 2073 756d 6620 3d20 5f6d 6d5f 6376 7473   sumf = _mm_cvts
-0000e8c0: 735f 6633 3228 2072 6573 2029 202b 2061  s_f32( res ) + a
-0000e8d0: 6363 5f6f 6666 7365 7420 2a20 514b 3b0a  cc_offset * QK;.
-0000e8e0: 2365 6c73 650a 2365 7272 6f72 2022 6e6f  #else.#error "no
-0000e8f0: 7420 696d 706c 656d 656e 7465 6420 666f  t implemented fo
-0000e900: 7220 514b 220a 2365 6e64 6966 0a23 656c  r QK".#endif.#el
-0000e910: 7365 0a20 2020 202f 2f20 7363 616c 6172  se.    // scalar
-0000e920: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0000e930: 3d20 303b 2069 203c 206e 623b 2069 2b2b  = 0; i < nb; i++
-0000e940: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
-0000e950: 7420 666c 6f61 7420 6d30 203d 202a 2863  t float m0 = *(c
-0000e960: 6f6e 7374 2066 6c6f 6174 202a 2920 2870  onst float *) (p
-0000e970: 6d30 202b 2069 2a62 7329 3b0a 2020 2020  m0 + i*bs);.    
-0000e980: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0000e990: 6d31 203d 202a 2863 6f6e 7374 2066 6c6f  m1 = *(const flo
-0000e9a0: 6174 202a 2920 2870 6d31 202b 2069 2a62  at *) (pm1 + i*b
-0000e9b0: 7329 3b0a 0a20 2020 2020 2020 2063 6f6e  s);..        con
-0000e9c0: 7374 2066 6c6f 6174 2064 3020 3d20 2a28  st float d0 = *(
-0000e9d0: 636f 6e73 7420 666c 6f61 7420 2a29 2028  const float *) (
-0000e9e0: 7064 3020 2b20 692a 6273 293b 0a20 2020  pd0 + i*bs);.   
-0000e9f0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-0000ea00: 2064 3120 3d20 2a28 636f 6e73 7420 666c   d1 = *(const fl
-0000ea10: 6f61 7420 2a29 2028 7064 3120 2b20 692a  oat *) (pd1 + i*
-0000ea20: 6273 293b 0a0a 2020 2020 2020 2020 636f  bs);..        co
-0000ea30: 6e73 7420 7569 6e74 385f 7420 2a20 7265  nst uint8_t * re
-0000ea40: 7374 7269 6374 2070 3020 3d20 7062 3020  strict p0 = pb0 
-0000ea50: 2b20 692a 6273 3b0a 2020 2020 2020 2020  + i*bs;.        
-0000ea60: 636f 6e73 7420 7569 6e74 385f 7420 2a20  const uint8_t * 
-0000ea70: 7265 7374 7269 6374 2070 3120 3d20 7062  restrict p1 = pb
-0000ea80: 3120 2b20 692a 6273 3b0a 0a20 2020 2020  1 + i*bs;..     
-0000ea90: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-0000eaa0: 303b 206a 203c 2051 4b2f 323b 206a 2b2b  0; j < QK/2; j++
-0000eab0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0000eac0: 636f 6e73 7420 7569 6e74 385f 7420 7630  const uint8_t v0
-0000ead0: 203d 2070 305b 6a5d 3b0a 2020 2020 2020   = p0[j];.      
-0000eae0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-0000eaf0: 385f 7420 7631 203d 2070 315b 6a5d 3b0a  8_t v1 = p1[j];.
-0000eb00: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0000eb10: 7374 2066 6c6f 6174 2066 3020 3d20 6430  st float f0 = d0
-0000eb20: 2a28 7630 2026 2030 7866 2920 2b20 6d30  *(v0 & 0xf) + m0
-0000eb30: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0000eb40: 6e73 7420 666c 6f61 7420 6631 203d 2064  nst float f1 = d
-0000eb50: 302a 2876 3020 3e3e 2034 2920 202b 206d  0*(v0 >> 4)  + m
-0000eb60: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
-0000eb70: 636f 6e73 7420 666c 6f61 7420 6632 203d  const float f2 =
-0000eb80: 2064 312a 2876 3120 2620 3078 6629 202b   d1*(v1 & 0xf) +
-0000eb90: 206d 313b 0a20 2020 2020 2020 2020 2020   m1;.           
-0000eba0: 2063 6f6e 7374 2066 6c6f 6174 2066 3320   const float f3 
-0000ebb0: 3d20 6431 2a28 7631 203e 3e20 3429 2020  = d1*(v1 >> 4)  
-0000ebc0: 2b20 6d31 3b0a 0a20 2020 2020 2020 2020  + m1;..         
-0000ebd0: 2020 2073 756d 6620 2b3d 2066 302a 6632     sumf += f0*f2
-0000ebe0: 202b 2066 312a 6633 3b0a 2020 2020 2020   + f1*f3;.      
-0000ebf0: 2020 7d0a 2020 2020 7d0a 2365 6e64 6966    }.    }.#endif
-0000ec00: 0a0a 2020 2020 2a73 203d 2073 756d 663b  ..    *s = sumf;
-0000ec10: 0a7d 0a0a 2f2f 2063 6f6d 7075 7465 2047  .}..// compute G
-0000ec20: 474d 4c5f 5645 435f 444f 545f 554e 524f  GML_VEC_DOT_UNRO
-0000ec30: 4c4c 2064 6f74 2070 726f 6475 6374 7320  LL dot products 
-0000ec40: 6174 206f 6e63 650a 2f2f 2078 7320 2d20  at once.// xs - 
-0000ec50: 7820 726f 7720 7374 7269 6465 2069 6e20  x row stride in 
-0000ec60: 6279 7465 730a 696e 6c69 6e65 2073 7461  bytes.inline sta
-0000ec70: 7469 6320 766f 6964 2067 676d 6c5f 7665  tic void ggml_ve
-0000ec80: 635f 646f 745f 6631 365f 756e 726f 6c6c  c_dot_f16_unroll
-0000ec90: 2863 6f6e 7374 2069 6e74 206e 2c20 636f  (const int n, co
-0000eca0: 6e73 7420 696e 7420 7873 2c20 666c 6f61  nst int xs, floa
-0000ecb0: 7420 2a20 7265 7374 7269 6374 2073 2c20  t * restrict s, 
-0000ecc0: 766f 6964 202a 2072 6573 7472 6963 7420  void * restrict 
-0000ecd0: 7876 2c20 6767 6d6c 5f66 7031 365f 7420  xv, ggml_fp16_t 
-0000ece0: 2a20 7265 7374 7269 6374 2079 2920 7b0a  * restrict y) {.
-0000ecf0: 2020 2020 6767 6d6c 5f66 6c6f 6174 2073      ggml_float s
-0000ed00: 756d 665b 4747 4d4c 5f56 4543 5f44 4f54  umf[GGML_VEC_DOT
-0000ed10: 5f55 4e52 4f4c 4c5d 203d 207b 2030 2e30  _UNROLL] = { 0.0
-0000ed20: 207d 3b0a 0a20 2020 2067 676d 6c5f 6670   };..    ggml_fp
-0000ed30: 3136 5f74 202a 2072 6573 7472 6963 7420  16_t * restrict 
-0000ed40: 785b 4747 4d4c 5f56 4543 5f44 4f54 5f55  x[GGML_VEC_DOT_U
-0000ed50: 4e52 4f4c 4c5d 3b0a 0a20 2020 2066 6f72  NROLL];..    for
-0000ed60: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-0000ed70: 2047 474d 4c5f 5645 435f 444f 545f 554e   GGML_VEC_DOT_UN
-0000ed80: 524f 4c4c 3b20 2b2b 6929 207b 0a20 2020  ROLL; ++i) {.   
-0000ed90: 2020 2020 2078 5b69 5d20 3d20 2867 676d       x[i] = (ggm
-0000eda0: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
-0000edb0: 6172 202a 2920 7876 202b 2069 2a78 7329  ar *) xv + i*xs)
-0000edc0: 3b0a 2020 2020 7d0a 0a23 6966 2064 6566  ;.    }..#if def
-0000edd0: 696e 6564 2847 474d 4c5f 5349 4d44 290a  ined(GGML_SIMD).
-0000ede0: 2020 2020 636f 6e73 7420 696e 7420 6e70      const int np
-0000edf0: 203d 2028 6e20 2620 7e28 4747 4d4c 5f46   = (n & ~(GGML_F
-0000ee00: 3136 5f53 5445 5020 2d20 3129 293b 0a0a  16_STEP - 1));..
-0000ee10: 2020 2020 4747 4d4c 5f46 3136 5f56 4543      GGML_F16_VEC
-0000ee20: 2073 756d 5b47 474d 4c5f 5645 435f 444f   sum[GGML_VEC_DO
-0000ee30: 545f 554e 524f 4c4c 5d5b 4747 4d4c 5f46  T_UNROLL][GGML_F
-0000ee40: 3136 5f41 5252 5d20 3d20 7b20 7b20 4747  16_ARR] = { { GG
-0000ee50: 4d4c 5f46 3136 5f56 4543 5f5a 4552 4f20  ML_F16_VEC_ZERO 
-0000ee60: 7d20 7d3b 0a0a 2020 2020 4747 4d4c 5f46  } };..    GGML_F
-0000ee70: 3136 5f56 4543 2061 785b 4747 4d4c 5f46  16_VEC ax[GGML_F
-0000ee80: 3136 5f41 5252 5d3b 0a20 2020 2047 474d  16_ARR];.    GGM
-0000ee90: 4c5f 4631 365f 5645 4320 6179 5b47 474d  L_F16_VEC ay[GGM
-0000eea0: 4c5f 4631 365f 4152 525d 3b0a 0a20 2020  L_F16_ARR];..   
-0000eeb0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0000eec0: 2069 203c 206e 703b 2069 202b 3d20 4747   i < np; i += GG
-0000eed0: 4d4c 5f46 3136 5f53 5445 5029 207b 0a20  ML_F16_STEP) {. 
-0000eee0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0000eef0: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
-0000ef00: 4631 365f 4152 523b 206a 2b2b 2920 7b0a  F16_ARR; j++) {.
-0000ef10: 2020 2020 2020 2020 2020 2020 6179 5b6a              ay[j
-0000ef20: 5d20 3d20 4747 4d4c 5f46 3136 5f56 4543  ] = GGML_F16_VEC
-0000ef30: 5f4c 4f41 4428 7920 2b20 6920 2b20 6a2a  _LOAD(y + i + j*
-0000ef40: 4747 4d4c 5f46 3136 5f45 5052 2c20 6a29  GGML_F16_EPR, j)
-0000ef50: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
-0000ef60: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
-0000ef70: 203c 2047 474d 4c5f 5645 435f 444f 545f   < GGML_VEC_DOT_
-0000ef80: 554e 524f 4c4c 3b20 2b2b 6b29 207b 0a20  UNROLL; ++k) {. 
-0000ef90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000efa0: 785b 6a5d 203d 2047 474d 4c5f 4631 365f  x[j] = GGML_F16_
-0000efb0: 5645 435f 4c4f 4144 2878 5b6b 5d20 2b20  VEC_LOAD(x[k] + 
-0000efc0: 6920 2b20 6a2a 4747 4d4c 5f46 3136 5f45  i + j*GGML_F16_E
-0000efd0: 5052 2c20 6a29 3b0a 0a20 2020 2020 2020  PR, j);..       
-0000efe0: 2020 2020 2020 2020 2073 756d 5b6b 5d5b           sum[k][
-0000eff0: 6a5d 203d 2047 474d 4c5f 4631 365f 5645  j] = GGML_F16_VE
-0000f000: 435f 464d 4128 7375 6d5b 6b5d 5b6a 5d2c  C_FMA(sum[k][j],
-0000f010: 2061 785b 6a5d 2c20 6179 5b6a 5d29 3b0a   ax[j], ay[j]);.
-0000f020: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0000f030: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-0000f040: 2020 202f 2f20 7265 6475 6365 2073 756d     // reduce sum
-0000f050: 302e 2e73 756d 3320 746f 2073 756d 300a  0..sum3 to sum0.
-0000f060: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
-0000f070: 2030 3b20 6b20 3c20 4747 4d4c 5f56 4543   0; k < GGML_VEC
-0000f080: 5f44 4f54 5f55 4e52 4f4c 4c3b 202b 2b6b  _DOT_UNROLL; ++k
-0000f090: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
-0000f0a0: 5f46 3136 5f56 4543 5f52 4544 5543 4528  _F16_VEC_REDUCE(
-0000f0b0: 7375 6d66 5b6b 5d2c 2073 756d 5b6b 5d29  sumf[k], sum[k])
-0000f0c0: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-0000f0d0: 6c65 6674 6f76 6572 730a 2020 2020 666f  leftovers.    fo
-0000f0e0: 7220 2869 6e74 2069 203d 206e 703b 2069  r (int i = np; i
-0000f0f0: 203c 206e 3b20 2b2b 6929 207b 0a20 2020   < n; ++i) {.   
-0000f100: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-0000f110: 3d20 303b 206a 203c 2047 474d 4c5f 5645  = 0; j < GGML_VE
-0000f120: 435f 444f 545f 554e 524f 4c4c 3b20 2b2b  C_DOT_UNROLL; ++
-0000f130: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-0000f140: 2073 756d 665b 6a5d 202b 3d20 4747 4d4c   sumf[j] += GGML
-0000f150: 5f46 5031 365f 544f 5f46 5033 3228 785b  _FP16_TO_FP32(x[
-0000f160: 6a5d 5b69 5d29 2a47 474d 4c5f 4650 3136  j][i])*GGML_FP16
-0000f170: 5f54 4f5f 4650 3332 2879 5b69 5d29 3b0a  _TO_FP32(y[i]);.
-0000f180: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0000f190: 2365 6c73 650a 2020 2020 666f 7220 2869  #else.    for (i
-0000f1a0: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
-0000f1b0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0000f1c0: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-0000f1d0: 6a20 3c20 4747 4d4c 5f56 4543 5f44 4f54  j < GGML_VEC_DOT
-0000f1e0: 5f55 4e52 4f4c 4c3b 202b 2b6a 2920 7b0a  _UNROLL; ++j) {.
-0000f1f0: 2020 2020 2020 2020 2020 2020 7375 6d66              sumf
-0000f200: 5b6a 5d20 2b3d 2047 474d 4c5f 4650 3136  [j] += GGML_FP16
-0000f210: 5f54 4f5f 4650 3332 2878 5b6a 5d5b 695d  _TO_FP32(x[j][i]
-0000f220: 292a 4747 4d4c 5f46 5031 365f 544f 5f46  )*GGML_FP16_TO_F
-0000f230: 5033 3228 795b 695d 293b 0a20 2020 2020  P32(y[i]);.     
-0000f240: 2020 207d 0a20 2020 207d 0a23 656e 6469     }.    }.#endi
-0000f250: 660a 0a20 2020 2066 6f72 2028 696e 7420  f..    for (int 
-0000f260: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
-0000f270: 5645 435f 444f 545f 554e 524f 4c4c 3b20  VEC_DOT_UNROLL; 
-0000f280: 2b2b 6929 207b 0a20 2020 2020 2020 2073  ++i) {.        s
-0000f290: 5b69 5d20 3d20 7375 6d66 5b69 5d3b 0a20  [i] = sumf[i];. 
-0000f2a0: 2020 207d 0a7d 0a0a 696e 6c69 6e65 2073     }.}..inline s
-0000f2b0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0000f2c0: 7665 635f 6d61 645f 6633 3228 636f 6e73  vec_mad_f32(cons
-0000f2d0: 7420 696e 7420 6e2c 2066 6c6f 6174 202a  t int n, float *
-0000f2e0: 2072 6573 7472 6963 7420 792c 2063 6f6e   restrict y, con
-0000f2f0: 7374 2066 6c6f 6174 202a 2072 6573 7472  st float * restr
-0000f300: 6963 7420 782c 2063 6f6e 7374 2066 6c6f  ict x, const flo
-0000f310: 6174 2076 2920 7b0a 2369 6620 6465 6669  at v) {.#if defi
-0000f320: 6e65 6428 4747 4d4c 5f53 494d 4429 0a20  ned(GGML_SIMD). 
-0000f330: 2020 2063 6f6e 7374 2069 6e74 206e 7020     const int np 
-0000f340: 3d20 286e 2026 207e 2847 474d 4c5f 4633  = (n & ~(GGML_F3
-0000f350: 325f 5354 4550 202d 2031 2929 3b0a 0a20  2_STEP - 1));.. 
-0000f360: 2020 2047 474d 4c5f 4633 325f 5645 4320     GGML_F32_VEC 
-0000f370: 7678 203d 2047 474d 4c5f 4633 325f 5645  vx = GGML_F32_VE
-0000f380: 435f 5345 5431 2876 293b 0a0a 2020 2020  C_SET1(v);..    
-0000f390: 4747 4d4c 5f46 3332 5f56 4543 2061 785b  GGML_F32_VEC ax[
-0000f3a0: 4747 4d4c 5f46 3332 5f41 5252 5d3b 0a20  GGML_F32_ARR];. 
-0000f3b0: 2020 2047 474d 4c5f 4633 325f 5645 4320     GGML_F32_VEC 
-0000f3c0: 6179 5b47 474d 4c5f 4633 325f 4152 525d  ay[GGML_F32_ARR]
-0000f3d0: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-0000f3e0: 6920 3d20 303b 2069 203c 206e 703b 2069  i = 0; i < np; i
-0000f3f0: 202b 3d20 4747 4d4c 5f46 3332 5f53 5445   += GGML_F32_STE
-0000f400: 5029 207b 0a20 2020 2020 2020 2066 6f72  P) {.        for
-0000f410: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-0000f420: 2047 474d 4c5f 4633 325f 4152 523b 206a   GGML_F32_ARR; j
-0000f430: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0000f440: 2020 6178 5b6a 5d20 3d20 4747 4d4c 5f46    ax[j] = GGML_F
-0000f450: 3332 5f56 4543 5f4c 4f41 4428 7820 2b20  32_VEC_LOAD(x + 
-0000f460: 6920 2b20 6a2a 4747 4d4c 5f46 3332 5f45  i + j*GGML_F32_E
-0000f470: 5052 293b 0a20 2020 2020 2020 2020 2020  PR);.           
-0000f480: 2061 795b 6a5d 203d 2047 474d 4c5f 4633   ay[j] = GGML_F3
-0000f490: 325f 5645 435f 4c4f 4144 2879 202b 2069  2_VEC_LOAD(y + i
-0000f4a0: 202b 206a 2a47 474d 4c5f 4633 325f 4550   + j*GGML_F32_EP
-0000f4b0: 5229 3b0a 2020 2020 2020 2020 2020 2020  R);.            
-0000f4c0: 6179 5b6a 5d20 3d20 4747 4d4c 5f46 3332  ay[j] = GGML_F32
-0000f4d0: 5f56 4543 5f46 4d41 2861 795b 6a5d 2c20  _VEC_FMA(ay[j], 
-0000f4e0: 6178 5b6a 5d2c 2076 7829 3b0a 0a20 2020  ax[j], vx);..   
-0000f4f0: 2020 2020 2020 2020 2047 474d 4c5f 4633           GGML_F3
-0000f500: 325f 5645 435f 5354 4f52 4528 7920 2b20  2_VEC_STORE(y + 
-0000f510: 6920 2b20 6a2a 4747 4d4c 5f46 3332 5f45  i + j*GGML_F32_E
-0000f520: 5052 2c20 6179 5b6a 5d29 3b0a 2020 2020  PR, ay[j]);.    
-0000f530: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-0000f540: 202f 2f20 6c65 6674 6f76 6572 730a 2020   // leftovers.  
-0000f550: 2020 666f 7220 2869 6e74 2069 203d 206e    for (int i = n
-0000f560: 703b 2069 203c 206e 3b20 2b2b 6929 207b  p; i < n; ++i) {
-0000f570: 0a20 2020 2020 2020 2079 5b69 5d20 2b3d  .        y[i] +=
-0000f580: 2078 5b69 5d2a 763b 0a20 2020 207d 0a23   x[i]*v;.    }.#
-0000f590: 656c 7365 0a20 2020 202f 2f20 7363 616c  else.    // scal
-0000f5a0: 6172 0a20 2020 2066 6f72 2028 696e 7420  ar.    for (int 
-0000f5b0: 6920 3d20 303b 2069 203c 206e 3b20 2b2b  i = 0; i < n; ++
-0000f5c0: 6929 207b 0a20 2020 2020 2020 2079 5b69  i) {.        y[i
-0000f5d0: 5d20 2b3d 2078 5b69 5d2a 763b 0a20 2020  ] += x[i]*v;.   
-0000f5e0: 207d 0a23 656e 6469 660a 7d0a 0a69 6e6c   }.#endif.}..inl
-0000f5f0: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
-0000f600: 6767 6d6c 5f76 6563 5f6d 6164 5f66 3136  ggml_vec_mad_f16
-0000f610: 2863 6f6e 7374 2069 6e74 206e 2c20 6767  (const int n, gg
-0000f620: 6d6c 5f66 7031 365f 7420 2a20 7265 7374  ml_fp16_t * rest
-0000f630: 7269 6374 2079 2c20 6767 6d6c 5f66 7031  rict y, ggml_fp1
-0000f640: 365f 7420 2a20 7265 7374 7269 6374 2078  6_t * restrict x
-0000f650: 2c20 636f 6e73 7420 666c 6f61 7420 7629  , const float v)
-0000f660: 207b 0a23 6966 2064 6566 696e 6564 2847   {.#if defined(G
-0000f670: 474d 4c5f 5349 4d44 290a 2020 2020 636f  GML_SIMD).    co
-0000f680: 6e73 7420 696e 7420 6e70 203d 2028 6e20  nst int np = (n 
-0000f690: 2620 7e28 4747 4d4c 5f46 3136 5f53 5445  & ~(GGML_F16_STE
-0000f6a0: 5020 2d20 3129 293b 0a0a 2020 2020 4747  P - 1));..    GG
-0000f6b0: 4d4c 5f46 3136 5f56 4543 2076 7820 3d20  ML_F16_VEC vx = 
-0000f6c0: 4747 4d4c 5f46 3136 5f56 4543 5f53 4554  GGML_F16_VEC_SET
-0000f6d0: 3128 7629 3b0a 0a20 2020 2047 474d 4c5f  1(v);..    GGML_
-0000f6e0: 4631 365f 5645 4320 6178 5b47 474d 4c5f  F16_VEC ax[GGML_
-0000f6f0: 4631 365f 4152 525d 3b0a 2020 2020 4747  F16_ARR];.    GG
-0000f700: 4d4c 5f46 3136 5f56 4543 2061 795b 4747  ML_F16_VEC ay[GG
-0000f710: 4d4c 5f46 3136 5f41 5252 5d3b 0a0a 2020  ML_F16_ARR];..  
-0000f720: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0000f730: 3b20 6920 3c20 6e70 3b20 6920 2b3d 2047  ; i < np; i += G
-0000f740: 474d 4c5f 4631 365f 5354 4550 2920 7b0a  GML_F16_STEP) {.
-0000f750: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0000f760: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
-0000f770: 5f46 3136 5f41 5252 3b20 6a2b 2b29 207b  _F16_ARR; j++) {
-0000f780: 0a20 2020 2020 2020 2020 2020 2061 785b  .            ax[
-0000f790: 6a5d 203d 2047 474d 4c5f 4631 365f 5645  j] = GGML_F16_VE
-0000f7a0: 435f 4c4f 4144 2878 202b 2069 202b 206a  C_LOAD(x + i + j
-0000f7b0: 2a47 474d 4c5f 4631 365f 4550 522c 206a  *GGML_F16_EPR, j
-0000f7c0: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
-0000f7d0: 795b 6a5d 203d 2047 474d 4c5f 4631 365f  y[j] = GGML_F16_
-0000f7e0: 5645 435f 4c4f 4144 2879 202b 2069 202b  VEC_LOAD(y + i +
-0000f7f0: 206a 2a47 474d 4c5f 4631 365f 4550 522c   j*GGML_F16_EPR,
-0000f800: 206a 293b 0a20 2020 2020 2020 2020 2020   j);.           
-0000f810: 2061 795b 6a5d 203d 2047 474d 4c5f 4631   ay[j] = GGML_F1
-0000f820: 365f 5645 435f 464d 4128 6179 5b6a 5d2c  6_VEC_FMA(ay[j],
-0000f830: 2061 785b 6a5d 2c20 7678 293b 0a0a 2020   ax[j], vx);..  
-0000f840: 2020 2020 2020 2020 2020 4747 4d4c 5f46            GGML_F
-0000f850: 3136 5f56 4543 5f53 544f 5245 2879 202b  16_VEC_STORE(y +
-0000f860: 2069 202b 206a 2a47 474d 4c5f 4631 365f   i + j*GGML_F16_
-0000f870: 4550 522c 2061 792c 206a 293b 0a20 2020  EPR, ay, j);.   
-0000f880: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0000f890: 2020 2f2f 206c 6566 746f 7665 7273 0a20    // leftovers. 
-0000f8a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0000f8b0: 6e70 3b20 6920 3c20 6e3b 202b 2b69 2920  np; i < n; ++i) 
-0000f8c0: 7b0a 2020 2020 2020 2020 4747 4d4c 5f41  {.        GGML_A
-0000f8d0: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-0000f8e0: 2020 2020 2020 795b 695d 203d 2047 474d        y[i] = GGM
-0000f8f0: 4c5f 4650 3332 5f54 4f5f 4650 3136 2847  L_FP32_TO_FP16(G
-0000f900: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
-0000f910: 2879 5b69 5d29 202b 2047 474d 4c5f 4650  (y[i]) + GGML_FP
-0000f920: 3136 5f54 4f5f 4650 3332 2878 5b69 5d29  16_TO_FP32(x[i])
-0000f930: 2a76 293b 0a20 2020 207d 0a23 656c 7365  *v);.    }.#else
-0000f940: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0000f950: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
-0000f960: 207b 0a20 2020 2020 2020 2079 5b69 5d20   {.        y[i] 
-0000f970: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
-0000f980: 5031 3628 4747 4d4c 5f46 5031 365f 544f  P16(GGML_FP16_TO
-0000f990: 5f46 5033 3228 795b 695d 2920 2b20 4747  _FP32(y[i]) + GG
-0000f9a0: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-0000f9b0: 785b 695d 292a 7629 3b0a 2020 2020 7d0a  x[i])*v);.    }.
-0000f9c0: 2365 6e64 6966 0a7d 0a0a 696e 6c69 6e65  #endif.}..inline
-0000f9d0: 2073 7461 7469 6320 766f 6964 2067 676d   static void ggm
-0000f9e0: 6c5f 7665 635f 6d61 645f 7134 5f30 2863  l_vec_mad_q4_0(c
-0000f9f0: 6f6e 7374 2069 6e74 206e 2c20 666c 6f61  onst int n, floa
-0000fa00: 7420 2a20 7265 7374 7269 6374 2079 2c20  t * restrict y, 
-0000fa10: 766f 6964 202a 2072 6573 7472 6963 7420  void * restrict 
-0000fa20: 782c 2063 6f6e 7374 2066 6c6f 6174 2076  x, const float v
-0000fa30: 2920 7b0a 2020 2020 6173 7365 7274 286e  ) {.    assert(n
-0000fa40: 2025 2051 4b20 3d3d 2030 293b 0a0a 2020   % QK == 0);..  
-0000fa50: 2020 636f 6e73 7420 696e 7420 6e62 203d    const int nb =
-0000fa60: 206e 202f 2051 4b3b 0a20 2020 2063 6f6e   n / QK;.    con
-0000fa70: 7374 2073 697a 655f 7420 6273 203d 2073  st size_t bs = s
-0000fa80: 697a 656f 6628 666c 6f61 7429 202b 2051  izeof(float) + Q
-0000fa90: 4b2f 323b 0a0a 2020 2020 636f 6e73 7420  K/2;..    const 
-0000faa0: 7569 6e74 385f 7420 2a20 7265 7374 7269  uint8_t * restri
-0000fab0: 6374 2070 6420 3d20 2828 636f 6e73 7420  ct pd = ((const 
-0000fac0: 7569 6e74 385f 7420 2a29 7820 2b20 302a  uint8_t *)x + 0*
-0000fad0: 6273 293b 0a20 2020 2063 6f6e 7374 2075  bs);.    const u
-0000fae0: 696e 7438 5f74 202a 2072 6573 7472 6963  int8_t * restric
-0000faf0: 7420 7062 203d 2028 2863 6f6e 7374 2075  t pb = ((const u
-0000fb00: 696e 7438 5f74 202a 2978 202b 2030 2a62  int8_t *)x + 0*b
-0000fb10: 7320 2b20 7369 7a65 6f66 2866 6c6f 6174  s + sizeof(float
-0000fb20: 2929 3b0a 0a23 6966 205f 5f41 524d 5f4e  ));..#if __ARM_N
-0000fb30: 454f 4e0a 2369 6620 514b 203d 3d20 3332  EON.#if QK == 32
-0000fb40: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0000fb50: 3d20 303b 2069 203c 206e 623b 202b 2b69  = 0; i < nb; ++i
-0000fb60: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
-0000fb70: 7420 666c 6f61 7420 6430 203d 2076 2a28  t float d0 = v*(
-0000fb80: 2a28 636f 6e73 7420 666c 6f61 7420 2a29  *(const float *)
-0000fb90: 2028 7064 202b 2069 2a62 7329 293b 0a0a   (pd + i*bs));..
-0000fba0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-0000fbb0: 6e74 385f 7420 2a20 7265 7374 7269 6374  nt8_t * restrict
-0000fbc0: 2070 7020 3d20 7062 202b 2069 2a62 733b   pp = pb + i*bs;
-0000fbd0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
-0000fbe0: 7569 6e74 3878 385f 7420 6d34 6220 3d20  uint8x8_t m4b = 
-0000fbf0: 7664 7570 5f6e 5f75 3828 3078 6629 3b0a  vdup_n_u8(0xf);.
-0000fc00: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0000fc10: 7438 7838 5f74 2020 7338 6220 3d20 7664  t8x8_t  s8b = vd
-0000fc20: 7570 5f6e 5f73 3828 3078 3829 3b0a 0a20  up_n_s8(0x8);.. 
-0000fc30: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0000fc40: 6174 3332 7834 5f74 2076 6420 3d20 7664  at32x4_t vd = vd
-0000fc50: 7570 715f 6e5f 6633 3228 6430 293b 0a0a  upq_n_f32(d0);..
-0000fc60: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0000fc70: 206a 203d 2030 3b20 6a20 3c20 323b 206a   j = 0; j < 2; j
-0000fc80: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0000fc90: 2020 636f 6e73 7420 7569 6e74 3878 385f    const uint8x8_
-0000fca0: 7420 7678 203d 2076 6c64 315f 7538 2870  t vx = vld1_u8(p
-0000fcb0: 7020 2b20 6a2a 3829 3b0a 0a20 2020 2020  p + j*8);..     
-0000fcc0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0000fcd0: 3878 385f 7420 7678 6c20 3d20 7672 6569  8x8_t vxl = vrei
-0000fce0: 6e74 6572 7072 6574 5f73 385f 7538 2876  nterpret_s8_u8(v
-0000fcf0: 616e 645f 7538 2876 782c 206d 3462 2929  and_u8(vx, m4b))
-0000fd00: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0000fd10: 6e73 7420 696e 7438 7838 5f74 2076 7868  nst int8x8_t vxh
-0000fd20: 203d 2076 7265 696e 7465 7270 7265 745f   = vreinterpret_
-0000fd30: 7338 5f75 3828 7673 6872 5f6e 5f75 3828  s8_u8(vshr_n_u8(
-0000fd40: 7678 2c20 3429 293b 0a0a 2020 2020 2020  vx, 4));..      
-0000fd50: 2020 2020 2020 2f2f 2073 7562 2038 0a20        // sub 8. 
-0000fd60: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0000fd70: 2069 6e74 3878 385f 7420 7678 6c73 203d   int8x8_t vxls =
-0000fd80: 2076 7375 625f 7338 2876 786c 2c20 7338   vsub_s8(vxl, s8
-0000fd90: 6229 3b0a 2020 2020 2020 2020 2020 2020  b);.            
-0000fda0: 636f 6e73 7420 696e 7438 7838 5f74 2076  const int8x8_t v
-0000fdb0: 7868 7320 3d20 7673 7562 5f73 3828 7678  xhs = vsub_s8(vx
-0000fdc0: 682c 2073 3862 293b 0a0a 2020 2020 2020  h, s8b);..      
-0000fdd0: 2020 2020 2020 2f2f 636f 6e73 7420 696e        //const in
-0000fde0: 7438 7838 5f74 2076 786c 7420 3d20 767a  t8x8_t vxlt = vz
-0000fdf0: 6970 5f73 3828 7678 6c73 2c20 7678 6873  ip_s8(vxls, vxhs
-0000fe00: 295b 305d 3b0a 2020 2020 2020 2020 2020  )[0];.          
-0000fe10: 2020 2f2f 636f 6e73 7420 696e 7438 7838    //const int8x8
-0000fe20: 5f74 2076 7868 7420 3d20 767a 6970 5f73  _t vxht = vzip_s
-0000fe30: 3828 7678 6c73 2c20 7678 6873 295b 315d  8(vxls, vxhs)[1]
-0000fe40: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0000fe50: 6e73 7420 696e 7438 7838 5f74 2076 786c  nst int8x8_t vxl
-0000fe60: 7420 3d20 767a 6970 315f 7338 2876 786c  t = vzip1_s8(vxl
-0000fe70: 732c 2076 7868 7329 3b0a 2020 2020 2020  s, vxhs);.      
-0000fe80: 2020 2020 2020 636f 6e73 7420 696e 7438        const int8
-0000fe90: 7838 5f74 2076 7868 7420 3d20 767a 6970  x8_t vxht = vzip
-0000fea0: 325f 7338 2876 786c 732c 2076 7868 7329  2_s8(vxls, vxhs)
-0000feb0: 3b0a 0a20 2020 2020 2020 2020 2020 2063  ;..            c
-0000fec0: 6f6e 7374 2069 6e74 3878 3136 5f74 2076  onst int8x16_t v
-0000fed0: 7871 203d 2076 636f 6d62 696e 655f 7338  xq = vcombine_s8
-0000fee0: 2876 786c 742c 2076 7868 7429 3b0a 0a20  (vxlt, vxht);.. 
-0000fef0: 2020 2020 2020 2020 2020 202f 2f20 636f             // co
-0000ff00: 6e76 6572 7420 746f 2032 7820 696e 7431  nvert to 2x int1
-0000ff10: 3678 385f 740a 2020 2020 2020 2020 2020  6x8_t.          
-0000ff20: 2020 636f 6e73 7420 696e 7431 3678 385f    const int16x8_
-0000ff30: 7420 7678 7130 203d 2076 6d6f 766c 5f73  t vxq0 = vmovl_s
-0000ff40: 3828 7667 6574 5f6c 6f77 5f73 3820 2876  8(vget_low_s8 (v
-0000ff50: 7871 2929 3b0a 2020 2020 2020 2020 2020  xq));.          
-0000ff60: 2020 636f 6e73 7420 696e 7431 3678 385f    const int16x8_
-0000ff70: 7420 7678 7131 203d 2076 6d6f 766c 5f73  t vxq1 = vmovl_s
-0000ff80: 3828 7667 6574 5f68 6967 685f 7338 2876  8(vget_high_s8(v
-0000ff90: 7871 2929 3b0a 0a20 2020 2020 2020 2020  xq));..         
-0000ffa0: 2020 202f 2f20 636f 6e76 6572 7420 746f     // convert to
-0000ffb0: 2034 7820 666c 6f61 7433 3278 345f 740a   4x float32x4_t.
-0000ffc0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0000ffd0: 7420 666c 6f61 7433 3278 345f 7420 7678  t float32x4_t vx
-0000ffe0: 3020 3d20 7663 7674 715f 6633 325f 7333  0 = vcvtq_f32_s3
-0000fff0: 3228 766d 6f76 6c5f 7331 3628 7667 6574  2(vmovl_s16(vget
-00010000: 5f6c 6f77 5f73 3136 2028 7678 7130 2929  _low_s16 (vxq0))
-00010010: 293b 0a20 2020 2020 2020 2020 2020 2063  );.            c
-00010020: 6f6e 7374 2066 6c6f 6174 3332 7834 5f74  onst float32x4_t
-00010030: 2076 7831 203d 2076 6376 7471 5f66 3332   vx1 = vcvtq_f32
-00010040: 5f73 3332 2876 6d6f 766c 5f73 3136 2876  _s32(vmovl_s16(v
-00010050: 6765 745f 6869 6768 5f73 3136 2876 7871  get_high_s16(vxq
-00010060: 3029 2929 3b0a 2020 2020 2020 2020 2020  0)));.          
-00010070: 2020 636f 6e73 7420 666c 6f61 7433 3278    const float32x
-00010080: 345f 7420 7678 3220 3d20 7663 7674 715f  4_t vx2 = vcvtq_
-00010090: 6633 325f 7333 3228 766d 6f76 6c5f 7331  f32_s32(vmovl_s1
-000100a0: 3628 7667 6574 5f6c 6f77 5f73 3136 2028  6(vget_low_s16 (
-000100b0: 7678 7131 2929 293b 0a20 2020 2020 2020  vxq1)));.       
-000100c0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-000100d0: 3332 7834 5f74 2076 7833 203d 2076 6376  32x4_t vx3 = vcv
-000100e0: 7471 5f66 3332 5f73 3332 2876 6d6f 766c  tq_f32_s32(vmovl
-000100f0: 5f73 3136 2876 6765 745f 6869 6768 5f73  _s16(vget_high_s
-00010100: 3136 2876 7871 3129 2929 3b0a 0a20 2020  16(vxq1)));..   
-00010110: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00010120: 6c6f 6174 3332 7834 5f74 2076 7930 203d  loat32x4_t vy0 =
-00010130: 2076 6c64 3171 5f66 3332 2879 202b 2069   vld1q_f32(y + i
-00010140: 2a33 3220 2b20 6a2a 3136 202b 2030 293b  *32 + j*16 + 0);
-00010150: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00010160: 7374 2066 6c6f 6174 3332 7834 5f74 2076  st float32x4_t v
-00010170: 7931 203d 2076 6c64 3171 5f66 3332 2879  y1 = vld1q_f32(y
-00010180: 202b 2069 2a33 3220 2b20 6a2a 3136 202b   + i*32 + j*16 +
-00010190: 2034 293b 0a20 2020 2020 2020 2020 2020   4);.           
-000101a0: 2063 6f6e 7374 2066 6c6f 6174 3332 7834   const float32x4
-000101b0: 5f74 2076 7932 203d 2076 6c64 3171 5f66  _t vy2 = vld1q_f
-000101c0: 3332 2879 202b 2069 2a33 3220 2b20 6a2a  32(y + i*32 + j*
-000101d0: 3136 202b 2038 293b 0a20 2020 2020 2020  16 + 8);.       
-000101e0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-000101f0: 3332 7834 5f74 2076 7933 203d 2076 6c64  32x4_t vy3 = vld
-00010200: 3171 5f66 3332 2879 202b 2069 2a33 3220  1q_f32(y + i*32 
-00010210: 2b20 6a2a 3136 202b 2031 3229 3b0a 0a20  + j*16 + 12);.. 
-00010220: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00010230: 2066 6c6f 6174 3332 7834 5f74 2076 7230   float32x4_t vr0
-00010240: 203d 2076 666d 6171 5f66 3332 2876 7930   = vfmaq_f32(vy0
-00010250: 2c20 7678 302c 2076 6429 3b0a 2020 2020  , vx0, vd);.    
-00010260: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00010270: 6f61 7433 3278 345f 7420 7672 3120 3d20  oat32x4_t vr1 = 
-00010280: 7666 6d61 715f 6633 3228 7679 312c 2076  vfmaq_f32(vy1, v
-00010290: 7831 2c20 7664 293b 0a20 2020 2020 2020  x1, vd);.       
-000102a0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-000102b0: 3332 7834 5f74 2076 7232 203d 2076 666d  32x4_t vr2 = vfm
-000102c0: 6171 5f66 3332 2876 7932 2c20 7678 322c  aq_f32(vy2, vx2,
-000102d0: 2076 6429 3b0a 2020 2020 2020 2020 2020   vd);.          
-000102e0: 2020 636f 6e73 7420 666c 6f61 7433 3278    const float32x
-000102f0: 345f 7420 7672 3320 3d20 7666 6d61 715f  4_t vr3 = vfmaq_
-00010300: 6633 3228 7679 332c 2076 7833 2c20 7664  f32(vy3, vx3, vd
-00010310: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00010320: 7673 7431 715f 6633 3228 7920 2b20 692a  vst1q_f32(y + i*
-00010330: 3332 202b 206a 2a31 3620 2b20 302c 2020  32 + j*16 + 0,  
-00010340: 7672 3029 3b0a 2020 2020 2020 2020 2020  vr0);.          
-00010350: 2020 7673 7431 715f 6633 3228 7920 2b20    vst1q_f32(y + 
-00010360: 692a 3332 202b 206a 2a31 3620 2b20 342c  i*32 + j*16 + 4,
-00010370: 2020 7672 3129 3b0a 2020 2020 2020 2020    vr1);.        
-00010380: 2020 2020 7673 7431 715f 6633 3228 7920      vst1q_f32(y 
-00010390: 2b20 692a 3332 202b 206a 2a31 3620 2b20  + i*32 + j*16 + 
-000103a0: 382c 2020 7672 3229 3b0a 2020 2020 2020  8,  vr2);.      
-000103b0: 2020 2020 2020 7673 7431 715f 6633 3228        vst1q_f32(
-000103c0: 7920 2b20 692a 3332 202b 206a 2a31 3620  y + i*32 + j*16 
-000103d0: 2b20 3132 2c20 7672 3329 3b0a 2020 2020  + 12, vr3);.    
-000103e0: 2020 2020 7d0a 2020 2020 7d0a 2365 6e64      }.    }.#end
-000103f0: 6966 0a23 656c 7365 0a20 2020 202f 2f20  if.#else.    // 
-00010400: 7363 616c 6172 0a20 2020 2066 6f72 2028  scalar.    for (
-00010410: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00010420: 623b 2069 2b2b 2920 7b0a 2020 2020 2020  b; i++) {.      
-00010430: 2020 636f 6e73 7420 666c 6f61 7420 6420    const float d 
-00010440: 3d20 2a28 636f 6e73 7420 666c 6f61 7420  = *(const float 
-00010450: 2a29 2028 7064 202b 2069 2a62 7329 3b0a  *) (pd + i*bs);.
-00010460: 0a20 2020 2020 2020 2063 6f6e 7374 2075  .        const u
-00010470: 696e 7438 5f74 202a 2072 6573 7472 6963  int8_t * restric
-00010480: 7420 7070 203d 2070 6220 2b20 692a 6273  t pp = pb + i*bs
-00010490: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-000104a0: 696e 7420 6c20 3d20 303b 206c 203c 2051  int l = 0; l < Q
-000104b0: 4b3b 206c 202b 3d20 3229 207b 0a20 2020  K; l += 2) {.   
-000104c0: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-000104d0: 696e 7438 5f74 2076 6920 3d20 7070 5b6c  int8_t vi = pp[l
-000104e0: 2f32 5d3b 0a0a 2020 2020 2020 2020 2020  /2];..          
-000104f0: 2020 636f 6e73 7420 696e 7438 5f74 2076    const int8_t v
-00010500: 6930 203d 2076 6920 2620 3078 663b 0a20  i0 = vi & 0xf;. 
-00010510: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00010520: 2069 6e74 385f 7420 7669 3120 3d20 7669   int8_t vi1 = vi
-00010530: 203e 3e20 343b 0a0a 2020 2020 2020 2020   >> 4;..        
-00010540: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00010550: 7630 203d 2028 7669 3020 2d20 3829 2a64  v0 = (vi0 - 8)*d
-00010560: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-00010570: 6e73 7420 666c 6f61 7420 7631 203d 2028  nst float v1 = (
-00010580: 7669 3120 2d20 3829 2a64 3b0a 0a20 2020  vi1 - 8)*d;..   
-00010590: 2020 2020 2020 2020 2079 5b69 2a51 4b20           y[i*QK 
-000105a0: 2b20 6c20 2b20 305d 202b 3d20 7630 2a76  + l + 0] += v0*v
-000105b0: 3b0a 2020 2020 2020 2020 2020 2020 795b  ;.            y[
-000105c0: 692a 514b 202b 206c 202b 2031 5d20 2b3d  i*QK + l + 1] +=
-000105d0: 2076 312a 763b 0a0a 2020 2020 2020 2020   v1*v;..        
-000105e0: 2020 2020 6173 7365 7274 2821 6973 6e61      assert(!isna
-000105f0: 6e28 795b 692a 514b 202b 206c 202b 2030  n(y[i*QK + l + 0
-00010600: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
-00010610: 2061 7373 6572 7428 2169 736e 616e 2879   assert(!isnan(y
-00010620: 5b69 2a51 4b20 2b20 6c20 2b20 315d 2929  [i*QK + l + 1]))
-00010630: 3b0a 2020 2020 2020 2020 2020 2020 6173  ;.            as
-00010640: 7365 7274 2821 6973 696e 6628 795b 692a  sert(!isinf(y[i*
-00010650: 514b 202b 206c 202b 2030 5d29 293b 0a20  QK + l + 0]));. 
-00010660: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00010670: 7428 2169 7369 6e66 2879 5b69 2a51 4b20  t(!isinf(y[i*QK 
-00010680: 2b20 6c20 2b20 315d 2929 3b0a 2020 2020  + l + 1]));.    
-00010690: 2020 2020 7d0a 2020 2020 7d0a 2365 6e64      }.    }.#end
-000106a0: 6966 0a7d 0a0a 696e 6c69 6e65 2073 7461  if.}..inline sta
-000106b0: 7469 6320 766f 6964 2067 676d 6c5f 7665  tic void ggml_ve
-000106c0: 635f 6d61 645f 7134 5f31 2863 6f6e 7374  c_mad_q4_1(const
-000106d0: 2069 6e74 206e 2c20 666c 6f61 7420 2a20   int n, float * 
-000106e0: 7265 7374 7269 6374 2079 2c20 766f 6964  restrict y, void
-000106f0: 202a 2072 6573 7472 6963 7420 782c 2063   * restrict x, c
-00010700: 6f6e 7374 2066 6c6f 6174 2076 2920 7b0a  onst float v) {.
-00010710: 2020 2020 6173 7365 7274 286e 2025 2051      assert(n % Q
-00010720: 4b20 3d3d 2030 293b 0a0a 2020 2020 636f  K == 0);..    co
-00010730: 6e73 7420 696e 7420 6e62 203d 206e 202f  nst int nb = n /
-00010740: 2051 4b3b 0a20 2020 2063 6f6e 7374 2073   QK;.    const s
-00010750: 697a 655f 7420 6273 203d 2032 2a73 697a  ize_t bs = 2*siz
-00010760: 656f 6628 666c 6f61 7429 202b 2051 4b2f  eof(float) + QK/
-00010770: 323b 0a0a 2020 2020 636f 6e73 7420 7569  2;..    const ui
-00010780: 6e74 385f 7420 2a20 7265 7374 7269 6374  nt8_t * restrict
-00010790: 2070 6420 3d20 2828 636f 6e73 7420 7569   pd = ((const ui
-000107a0: 6e74 385f 7420 2a29 7820 2b20 302a 6273  nt8_t *)x + 0*bs
-000107b0: 293b 0a20 2020 2063 6f6e 7374 2075 696e  );.    const uin
-000107c0: 7438 5f74 202a 2072 6573 7472 6963 7420  t8_t * restrict 
-000107d0: 706d 203d 2028 2863 6f6e 7374 2075 696e  pm = ((const uin
-000107e0: 7438 5f74 202a 2978 202b 2030 2a62 7320  t8_t *)x + 0*bs 
-000107f0: 2b20 2020 7369 7a65 6f66 2866 6c6f 6174  +   sizeof(float
-00010800: 2929 3b20 0a20 2020 2063 6f6e 7374 2075  )); .    const u
-00010810: 696e 7438 5f74 202a 2072 6573 7472 6963  int8_t * restric
-00010820: 7420 7062 203d 2028 2863 6f6e 7374 2075  t pb = ((const u
-00010830: 696e 7438 5f74 202a 2978 202b 2030 2a62  int8_t *)x + 0*b
-00010840: 7320 2b20 322a 7369 7a65 6f66 2866 6c6f  s + 2*sizeof(flo
-00010850: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
-00010860: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00010870: 623b 2069 2b2b 2920 7b0a 2020 2020 2020  b; i++) {.      
-00010880: 2020 636f 6e73 7420 666c 6f61 7420 6420    const float d 
-00010890: 3d20 2a28 636f 6e73 7420 666c 6f61 7420  = *(const float 
-000108a0: 2a29 2028 7064 202b 2069 2a62 7329 3b0a  *) (pd + i*bs);.
-000108b0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-000108c0: 6f61 7420 6d20 3d20 2a28 636f 6e73 7420  oat m = *(const 
-000108d0: 666c 6f61 7420 2a29 2028 706d 202b 2069  float *) (pm + i
-000108e0: 2a62 7329 3b0a 0a20 2020 2020 2020 2063  *bs);..        c
-000108f0: 6f6e 7374 2075 696e 7438 5f74 202a 2072  onst uint8_t * r
-00010900: 6573 7472 6963 7420 7070 203d 2070 6220  estrict pp = pb 
-00010910: 2b20 692a 6273 3b0a 0a20 2020 2020 2020  + i*bs;..       
-00010920: 2066 6f72 2028 696e 7420 6c20 3d20 303b   for (int l = 0;
-00010930: 206c 203c 2051 4b3b 206c 202b 3d20 3229   l < QK; l += 2)
-00010940: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
-00010950: 6f6e 7374 2075 696e 7438 5f74 2076 6920  onst uint8_t vi 
-00010960: 3d20 7070 5b6c 2f32 5d3b 0a0a 2020 2020  = pp[l/2];..    
-00010970: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00010980: 6e74 385f 7420 7669 3020 3d20 7669 2026  nt8_t vi0 = vi &
-00010990: 2030 7866 3b0a 2020 2020 2020 2020 2020   0xf;.          
-000109a0: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
-000109b0: 7669 3120 3d20 7669 203e 3e20 343b 0a0a  vi1 = vi >> 4;..
-000109c0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000109d0: 7420 666c 6f61 7420 7630 203d 2064 2a76  t float v0 = d*v
-000109e0: 6930 202b 206d 3b0a 2020 2020 2020 2020  i0 + m;.        
-000109f0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00010a00: 7631 203d 2064 2a76 6931 202b 206d 3b0a  v1 = d*vi1 + m;.
-00010a10: 0a20 2020 2020 2020 2020 2020 2079 5b69  .            y[i
-00010a20: 2a51 4b20 2b20 6c20 2b20 305d 202b 3d20  *QK + l + 0] += 
-00010a30: 7630 2a76 3b0a 2020 2020 2020 2020 2020  v0*v;.          
-00010a40: 2020 795b 692a 514b 202b 206c 202b 2031    y[i*QK + l + 1
-00010a50: 5d20 2b3d 2076 312a 763b 0a0a 2020 2020  ] += v1*v;..    
-00010a60: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
-00010a70: 6973 6e61 6e28 795b 692a 514b 202b 206c  isnan(y[i*QK + l
-00010a80: 202b 2030 5d29 293b 0a20 2020 2020 2020   + 0]));.       
-00010a90: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
-00010aa0: 616e 2879 5b69 2a51 4b20 2b20 6c20 2b20  an(y[i*QK + l + 
-00010ab0: 315d 2929 3b0a 2020 2020 2020 2020 2020  1]));.          
-00010ac0: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
-00010ad0: 795b 692a 514b 202b 206c 202b 2030 5d29  y[i*QK + l + 0])
-00010ae0: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
-00010af0: 7373 6572 7428 2169 7369 6e66 2879 5b69  ssert(!isinf(y[i
-00010b00: 2a51 4b20 2b20 6c20 2b20 315d 2929 3b0a  *QK + l + 1]));.
-00010b10: 2020 2020 2020 2020 2020 2020 2f2f 7072              //pr
-00010b20: 696e 7466 2822 6d61 643a 2076 3020 2566  intf("mad: v0 %f
-00010b30: 2076 3120 2566 2c20 6920 3d20 2564 2c20   v1 %f, i = %d, 
-00010b40: 6c20 3d20 2564 2c20 6420 3d20 2566 2c20  l = %d, d = %f, 
-00010b50: 7669 203d 2025 642c 2076 6930 203d 2025  vi = %d, vi0 = %
-00010b60: 642c 2076 6931 203d 2025 645c 6e22 2c20  d, vi1 = %d\n", 
-00010b70: 7630 2c20 7631 2c20 692c 206c 2c20 642c  v0, v1, i, l, d,
-00010b80: 2076 692c 2076 6930 2c20 7669 3129 3b0a   vi, vi0, vi1);.
-00010b90: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00010ba0: 7d0a 0a2f 2f69 6e6c 696e 6520 7374 6174  }..//inline stat
-00010bb0: 6963 2076 6f69 6420 6767 6d6c 5f76 6563  ic void ggml_vec
-00010bc0: 5f73 6361 6c65 5f66 3332 2863 6f6e 7374  _scale_f32(const
-00010bd0: 2069 6e74 206e 2c20 666c 6f61 7420 2a20   int n, float * 
-00010be0: 792c 2063 6f6e 7374 2066 6c6f 6174 2020  y, const float  
-00010bf0: 2076 2920 7b20 666f 7220 2869 6e74 2069   v) { for (int i
-00010c00: 203d 2030 3b20 6920 3c20 6e3b 202b 2b69   = 0; i < n; ++i
-00010c10: 2920 795b 695d 202a 3d20 763b 2020 2020  ) y[i] *= v;    
-00010c20: 2020 2020 2020 7d0a 696e 6c69 6e65 2073        }.inline s
-00010c30: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00010c40: 7665 635f 7363 616c 655f 6633 3228 636f  vec_scale_f32(co
-00010c50: 6e73 7420 696e 7420 6e2c 2066 6c6f 6174  nst int n, float
-00010c60: 202a 2079 2c20 636f 6e73 7420 666c 6f61   * y, const floa
-00010c70: 7420 2020 7629 207b 0a23 6966 2064 6566  t   v) {.#if def
-00010c80: 696e 6564 2847 474d 4c5f 5349 4d44 290a  ined(GGML_SIMD).
-00010c90: 2020 2020 636f 6e73 7420 696e 7420 6e70      const int np
-00010ca0: 203d 2028 6e20 2620 7e28 4747 4d4c 5f46   = (n & ~(GGML_F
-00010cb0: 3332 5f53 5445 5020 2d20 3129 293b 0a0a  32_STEP - 1));..
-00010cc0: 2020 2020 4747 4d4c 5f46 3332 5f56 4543      GGML_F32_VEC
-00010cd0: 2076 7820 3d20 4747 4d4c 5f46 3332 5f56   vx = GGML_F32_V
-00010ce0: 4543 5f53 4554 3128 7629 3b0a 0a20 2020  EC_SET1(v);..   
-00010cf0: 2047 474d 4c5f 4633 325f 5645 4320 6179   GGML_F32_VEC ay
-00010d00: 5b47 474d 4c5f 4633 325f 4152 525d 3b0a  [GGML_F32_ARR];.
-00010d10: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-00010d20: 3d20 303b 2069 203c 206e 703b 2069 202b  = 0; i < np; i +
-00010d30: 3d20 4747 4d4c 5f46 3332 5f53 5445 5029  = GGML_F32_STEP)
-00010d40: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
-00010d50: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
-00010d60: 474d 4c5f 4633 325f 4152 523b 206a 2b2b  GML_F32_ARR; j++
-00010d70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00010d80: 6179 5b6a 5d20 3d20 4747 4d4c 5f46 3332  ay[j] = GGML_F32
-00010d90: 5f56 4543 5f4c 4f41 4428 7920 2b20 6920  _VEC_LOAD(y + i 
-00010da0: 2b20 6a2a 4747 4d4c 5f46 3332 5f45 5052  + j*GGML_F32_EPR
-00010db0: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
-00010dc0: 795b 6a5d 203d 2047 474d 4c5f 4633 325f  y[j] = GGML_F32_
-00010dd0: 5645 435f 4d55 4c28 6179 5b6a 5d2c 2076  VEC_MUL(ay[j], v
-00010de0: 7829 3b0a 0a20 2020 2020 2020 2020 2020  x);..           
-00010df0: 2047 474d 4c5f 4633 325f 5645 435f 5354   GGML_F32_VEC_ST
-00010e00: 4f52 4528 7920 2b20 6920 2b20 6a2a 4747  ORE(y + i + j*GG
-00010e10: 4d4c 5f46 3332 5f45 5052 2c20 6179 5b6a  ML_F32_EPR, ay[j
-00010e20: 5d29 3b0a 2020 2020 2020 2020 7d0a 2020  ]);.        }.  
-00010e30: 2020 7d0a 0a20 2020 202f 2f20 6c65 6674    }..    // left
-00010e40: 6f76 6572 730a 2020 2020 666f 7220 2869  overs.    for (i
-00010e50: 6e74 2069 203d 206e 703b 2069 203c 206e  nt i = np; i < n
-00010e60: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00010e70: 2079 5b69 5d20 2a3d 2076 3b0a 2020 2020   y[i] *= v;.    
-00010e80: 7d0a 2365 6c73 650a 2020 2020 2f2f 2073  }.#else.    // s
-00010e90: 6361 6c61 720a 2020 2020 666f 7220 2869  calar.    for (i
-00010ea0: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
-00010eb0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-00010ec0: 795b 695d 202a 3d20 763b 0a20 2020 207d  y[i] *= v;.    }
-00010ed0: 0a23 656e 6469 660a 7d0a 0a69 6e6c 696e  .#endif.}..inlin
-00010ee0: 6520 7374 6174 6963 2076 6f69 6420 6767  e static void gg
-00010ef0: 6d6c 5f76 6563 5f6e 6f72 6d5f 6633 3220  ml_vec_norm_f32 
-00010f00: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
-00010f10: 6f61 7420 2a20 732c 2063 6f6e 7374 2066  oat * s, const f
-00010f20: 6c6f 6174 202a 2078 2920 7b20 6767 6d6c  loat * x) { ggml
-00010f30: 5f76 6563 5f64 6f74 5f66 3332 286e 2c20  _vec_dot_f32(n, 
-00010f40: 732c 2078 2c20 7829 3b20 2a73 203d 2073  s, x, x); *s = s
-00010f50: 7172 7428 2a73 293b 2020 207d 0a69 6e6c  qrt(*s);   }.inl
-00010f60: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
-00010f70: 6767 6d6c 5f76 6563 5f73 7172 5f66 3332  ggml_vec_sqr_f32
-00010f80: 2020 2863 6f6e 7374 2069 6e74 206e 2c20    (const int n, 
-00010f90: 666c 6f61 7420 2a20 792c 2063 6f6e 7374  float * y, const
-00010fa0: 2066 6c6f 6174 202a 2078 2920 7b20 666f   float * x) { fo
-00010fb0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00010fc0: 3c20 6e3b 202b 2b69 2920 795b 695d 203d  < n; ++i) y[i] =
-00010fd0: 2078 5b69 5d2a 785b 695d 3b20 2020 7d0a   x[i]*x[i];   }.
-00010fe0: 696e 6c69 6e65 2073 7461 7469 6320 766f  inline static vo
-00010ff0: 6964 2067 676d 6c5f 7665 635f 7371 7274  id ggml_vec_sqrt
-00011000: 5f66 3332 2028 636f 6e73 7420 696e 7420  _f32 (const int 
-00011010: 6e2c 2066 6c6f 6174 202a 2079 2c20 636f  n, float * y, co
-00011020: 6e73 7420 666c 6f61 7420 2a20 7829 207b  nst float * x) {
-00011030: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00011040: 2069 203c 206e 3b20 2b2b 6929 2079 5b69   i < n; ++i) y[i
-00011050: 5d20 3d20 7371 7274 2878 5b69 5d29 3b20  ] = sqrt(x[i]); 
-00011060: 7d0a 696e 6c69 6e65 2073 7461 7469 6320  }.inline static 
-00011070: 766f 6964 2067 676d 6c5f 7665 635f 6162  void ggml_vec_ab
-00011080: 735f 6633 3220 2028 636f 6e73 7420 696e  s_f32  (const in
-00011090: 7420 6e2c 2066 6c6f 6174 202a 2079 2c20  t n, float * y, 
-000110a0: 636f 6e73 7420 666c 6f61 7420 2a20 7829  const float * x)
-000110b0: 207b 2066 6f72 2028 696e 7420 6920 3d20   { for (int i = 
-000110c0: 303b 2069 203c 206e 3b20 2b2b 6929 2079  0; i < n; ++i) y
-000110d0: 5b69 5d20 3d20 6661 6273 6628 785b 695d  [i] = fabsf(x[i]
-000110e0: 293b 207d 0a69 6e6c 696e 6520 7374 6174  ); }.inline stat
-000110f0: 6963 2076 6f69 6420 6767 6d6c 5f76 6563  ic void ggml_vec
-00011100: 5f73 676e 5f66 3332 2020 2863 6f6e 7374  _sgn_f32  (const
-00011110: 2069 6e74 206e 2c20 666c 6f61 7420 2a20   int n, float * 
-00011120: 792c 2063 6f6e 7374 2066 6c6f 6174 202a  y, const float *
-00011130: 2078 2920 7b20 666f 7220 2869 6e74 2069   x) { for (int i
-00011140: 203d 2030 3b20 6920 3c20 6e3b 202b 2b69   = 0; i < n; ++i
-00011150: 2920 795b 695d 203d 2028 785b 695d 203e  ) y[i] = (x[i] >
-00011160: 2030 2e66 2920 3f20 312e 6620 3a20 2828   0.f) ? 1.f : ((
-00011170: 785b 695d 203c 2030 2e66 2920 3f20 2d31  x[i] < 0.f) ? -1
-00011180: 2e66 203a 2030 2e66 293b 207d 0a69 6e6c  .f : 0.f); }.inl
-00011190: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
-000111a0: 6767 6d6c 5f76 6563 5f73 7465 705f 6633  ggml_vec_step_f3
-000111b0: 3220 2863 6f6e 7374 2069 6e74 206e 2c20  2 (const int n, 
-000111c0: 666c 6f61 7420 2a20 792c 2063 6f6e 7374  float * y, const
-000111d0: 2066 6c6f 6174 202a 2078 2920 7b20 666f   float * x) { fo
-000111e0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-000111f0: 3c20 6e3b 202b 2b69 2920 795b 695d 203d  < n; ++i) y[i] =
-00011200: 2028 785b 695d 203e 2030 2e66 2920 3f20   (x[i] > 0.f) ? 
-00011210: 312e 6620 3a20 302e 663b 207d 0a69 6e6c  1.f : 0.f; }.inl
-00011220: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
-00011230: 6767 6d6c 5f76 6563 5f72 656c 755f 6633  ggml_vec_relu_f3
-00011240: 3220 2863 6f6e 7374 2069 6e74 206e 2c20  2 (const int n, 
-00011250: 666c 6f61 7420 2a20 792c 2063 6f6e 7374  float * y, const
-00011260: 2066 6c6f 6174 202a 2078 2920 7b20 666f   float * x) { fo
-00011270: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00011280: 3c20 6e3b 202b 2b69 2920 795b 695d 203d  < n; ++i) y[i] =
-00011290: 2028 785b 695d 203e 2030 2e66 2920 3f20   (x[i] > 0.f) ? 
-000112a0: 785b 695d 203a 2030 2e66 3b20 7d0a 0a73  x[i] : 0.f; }..s
-000112b0: 7461 7469 6320 636f 6e73 7420 6767 6d6c  tatic const ggml
-000112c0: 5f66 6c6f 6174 2047 454c 555f 434f 4546  _float GELU_COEF
-000112d0: 5f41 2020 2020 3d20 302e 3034 3437 3135  _A    = 0.044715
-000112e0: 3b0a 7374 6174 6963 2063 6f6e 7374 2067  ;.static const g
-000112f0: 676d 6c5f 666c 6f61 7420 5351 5254 5f32  gml_float SQRT_2
-00011300: 5f4f 5645 525f 5049 203d 2030 2e37 3937  _OVER_PI = 0.797
-00011310: 3838 3435 3630 3830 3238 3635 3335 3538  8845608028653558
-00011320: 3739 3839 3231 3139 3836 3837 363b 0a0a  7989211986876;..
-00011330: 696e 6c69 6e65 2073 7461 7469 6320 666c  inline static fl
-00011340: 6f61 7420 6767 6d6c 5f67 656c 755f 6633  oat ggml_gelu_f3
-00011350: 3228 666c 6f61 7420 7829 207b 0a20 2020  2(float x) {.   
-00011360: 2072 6574 7572 6e20 302e 352a 782a 2831   return 0.5*x*(1
-00011370: 2e30 202b 2074 616e 6828 5351 5254 5f32  .0 + tanh(SQRT_2
-00011380: 5f4f 5645 525f 5049 2a78 2a28 312e 3020  _OVER_PI*x*(1.0 
-00011390: 2b20 4745 4c55 5f43 4f45 465f 412a 782a  + GELU_COEF_A*x*
-000113a0: 7829 2929 3b0a 7d0a 0a69 6e6c 696e 6520  x)));.}..inline 
-000113b0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000113c0: 5f76 6563 5f67 656c 755f 6631 3628 636f  _vec_gelu_f16(co
-000113d0: 6e73 7420 696e 7420 6e2c 2067 676d 6c5f  nst int n, ggml_
-000113e0: 6670 3136 5f74 202a 2079 2c20 636f 6e73  fp16_t * y, cons
-000113f0: 7420 6767 6d6c 5f66 7031 365f 7420 2a20  t ggml_fp16_t * 
-00011400: 7829 207b 0a20 2020 2063 6f6e 7374 2075  x) {.    const u
-00011410: 696e 7431 365f 7420 2a20 6931 3620 3d20  int16_t * i16 = 
-00011420: 2863 6f6e 7374 2075 696e 7431 365f 7420  (const uint16_t 
-00011430: 2a29 2078 3b0a 2020 2020 666f 7220 2869  *) x;.    for (i
-00011440: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
-00011450: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-00011460: 795b 695d 203d 2074 6162 6c65 5f67 656c  y[i] = table_gel
-00011470: 755f 6631 365b 6931 365b 695d 5d3b 0a20  u_f16[i16[i]];. 
-00011480: 2020 207d 0a7d 0a0a 2369 6664 6566 2047     }.}..#ifdef G
-00011490: 474d 4c5f 4745 4c55 5f46 5031 360a 696e  GML_GELU_FP16.in
-000114a0: 6c69 6e65 2073 7461 7469 6320 766f 6964  line static void
-000114b0: 2067 676d 6c5f 7665 635f 6765 6c75 5f66   ggml_vec_gelu_f
-000114c0: 3332 2863 6f6e 7374 2069 6e74 206e 2c20  32(const int n, 
-000114d0: 666c 6f61 7420 2a20 792c 2063 6f6e 7374  float * y, const
-000114e0: 2066 6c6f 6174 202a 2078 2920 7b0a 2020   float * x) {.  
-000114f0: 2020 7569 6e74 3136 5f74 2074 3b0a 2020    uint16_t t;.  
-00011500: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00011510: 3b20 6920 3c20 6e3b 202b 2b69 2920 7b0a  ; i < n; ++i) {.
-00011520: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-00011530: 365f 7420 6670 3136 203d 2047 474d 4c5f  6_t fp16 = GGML_
-00011540: 4650 3332 5f54 4f5f 4650 3136 2878 5b69  FP32_TO_FP16(x[i
-00011550: 5d29 3b0a 2020 2020 2020 2020 6d65 6d63  ]);.        memc
-00011560: 7079 2826 742c 2026 6670 3136 2c20 7369  py(&t, &fp16, si
-00011570: 7a65 6f66 2875 696e 7431 365f 7429 293b  zeof(uint16_t));
-00011580: 0a20 2020 2020 2020 2079 5b69 5d20 3d20  .        y[i] = 
-00011590: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-000115a0: 3228 7461 626c 655f 6765 6c75 5f66 3136  2(table_gelu_f16
-000115b0: 5b74 5d29 3b0a 2020 2020 7d0a 7d0a 2365  [t]);.    }.}.#e
-000115c0: 6c73 650a 696e 6c69 6e65 2073 7461 7469  lse.inline stati
-000115d0: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
-000115e0: 6765 6c75 5f66 3332 2863 6f6e 7374 2069  gelu_f32(const i
-000115f0: 6e74 206e 2c20 666c 6f61 7420 2a20 792c  nt n, float * y,
-00011600: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
-00011610: 2920 7b0a 2020 2020 666f 7220 2869 6e74  ) {.    for (int
-00011620: 2069 203d 2030 3b20 6920 3c20 6e3b 202b   i = 0; i < n; +
-00011630: 2b69 2920 7b0a 2020 2020 2020 2020 795b  +i) {.        y[
-00011640: 695d 203d 2067 676d 6c5f 6765 6c75 5f66  i] = ggml_gelu_f
-00011650: 3332 2878 5b69 5d29 3b0a 2020 2020 7d0a  32(x[i]);.    }.
-00011660: 7d0a 2365 6e64 6966 0a0a 2f2f 2053 6967  }.#endif..// Sig
-00011670: 6d6f 6964 204c 696e 6561 7220 556e 6974  moid Linear Unit
-00011680: 2028 5369 4c55 2920 6675 6e63 7469 6f6e   (SiLU) function
-00011690: 0a69 6e6c 696e 6520 7374 6174 6963 2066  .inline static f
-000116a0: 6c6f 6174 2067 676d 6c5f 7369 6c75 5f66  loat ggml_silu_f
-000116b0: 3332 2866 6c6f 6174 2078 2920 7b0a 2020  32(float x) {.  
-000116c0: 2020 7265 7475 726e 2078 2f28 312e 3020    return x/(1.0 
-000116d0: 2b20 6578 7028 2d78 2929 3b0a 7d0a 0a69  + exp(-x));.}..i
-000116e0: 6e6c 696e 6520 7374 6174 6963 2076 6f69  nline static voi
-000116f0: 6420 6767 6d6c 5f76 6563 5f73 696c 755f  d ggml_vec_silu_
-00011700: 6631 3628 636f 6e73 7420 696e 7420 6e2c  f16(const int n,
-00011710: 2067 676d 6c5f 6670 3136 5f74 202a 2079   ggml_fp16_t * y
-00011720: 2c20 636f 6e73 7420 6767 6d6c 5f66 7031  , const ggml_fp1
-00011730: 365f 7420 2a20 7829 207b 0a20 2020 2063  6_t * x) {.    c
-00011740: 6f6e 7374 2075 696e 7431 365f 7420 2a20  onst uint16_t * 
-00011750: 6931 3620 3d20 2863 6f6e 7374 2075 696e  i16 = (const uin
-00011760: 7431 365f 7420 2a29 2078 3b0a 2020 2020  t16_t *) x;.    
-00011770: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00011780: 6920 3c20 6e3b 202b 2b69 2920 7b0a 2020  i < n; ++i) {.  
-00011790: 2020 2020 2020 795b 695d 203d 2074 6162        y[i] = tab
-000117a0: 6c65 5f73 696c 755f 6631 365b 6931 365b  le_silu_f16[i16[
-000117b0: 695d 5d3b 0a20 2020 207d 0a7d 0a0a 2369  i]];.    }.}..#i
-000117c0: 6664 6566 2047 474d 4c5f 5349 4c55 5f46  fdef GGML_SILU_F
-000117d0: 5031 360a 696e 6c69 6e65 2073 7461 7469  P16.inline stati
-000117e0: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
-000117f0: 7369 6c75 5f66 3332 2863 6f6e 7374 2069  silu_f32(const i
-00011800: 6e74 206e 2c20 666c 6f61 7420 2a20 792c  nt n, float * y,
-00011810: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
-00011820: 2920 7b0a 2020 2020 7569 6e74 3136 5f74  ) {.    uint16_t
-00011830: 2074 3b0a 2020 2020 666f 7220 2869 6e74   t;.    for (int
-00011840: 2069 203d 2030 3b20 6920 3c20 6e3b 202b   i = 0; i < n; +
-00011850: 2b69 2920 7b0a 2020 2020 2020 2020 6767  +i) {.        gg
-00011860: 6d6c 5f66 7031 365f 7420 6670 3136 203d  ml_fp16_t fp16 =
-00011870: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
-00011880: 3136 2878 5b69 5d29 3b0a 2020 2020 2020  16(x[i]);.      
-00011890: 2020 6d65 6d63 7079 2826 742c 2026 6670    memcpy(&t, &fp
-000118a0: 3136 2c20 7369 7a65 6f66 2875 696e 7431  16, sizeof(uint1
-000118b0: 365f 7429 293b 0a20 2020 2020 2020 2079  6_t));.        y
-000118c0: 5b69 5d20 3d20 4747 4d4c 5f46 5031 365f  [i] = GGML_FP16_
-000118d0: 544f 5f46 5033 3228 7461 626c 655f 7369  TO_FP32(table_si
-000118e0: 6c75 5f66 3136 5b74 5d29 3b0a 2020 2020  lu_f16[t]);.    
-000118f0: 7d0a 7d0a 2365 6c73 650a 696e 6c69 6e65  }.}.#else.inline
-00011900: 2073 7461 7469 6320 766f 6964 2067 676d   static void ggm
-00011910: 6c5f 7665 635f 7369 6c75 5f66 3332 2863  l_vec_silu_f32(c
-00011920: 6f6e 7374 2069 6e74 206e 2c20 666c 6f61  onst int n, floa
-00011930: 7420 2a20 792c 2063 6f6e 7374 2066 6c6f  t * y, const flo
-00011940: 6174 202a 2078 2920 7b0a 2020 2020 666f  at * x) {.    fo
+00008ab0: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+00008ac0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00008ad0: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
+00008ae0: 5f46 3136 5f41 5252 2f32 3b20 2b2b 6929  _F16_ARR/2; ++i)
+00008af0: 207b 2020 2020 2020 2020 2020 2020 2020   {              
+00008b00: 2020 5c0a 2020 2020 2020 2020 2020 2020    \.            
+00008b10: 785b 322a 695d 203d 2076 6164 6471 5f66  x[2*i] = vaddq_f
+00008b20: 3136 2878 5b32 2a69 5d2c 2078 5b32 2a69  16(x[2*i], x[2*i
+00008b30: 2b31 5d29 3b20 2020 2020 2020 2020 2020  +1]);           
+00008b40: 2020 2020 2020 5c0a 2020 2020 2020 2020        \.        
+00008b50: 7d20 2020 2020 2020 2020 2020 2020 2020  }               
+00008b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b80: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+00008b90: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00008ba0: 2030 3b20 6920 3c20 4747 4d4c 5f46 3136   0; i < GGML_F16
+00008bb0: 5f41 5252 2f34 3b20 2b2b 6929 207b 2020  _ARR/4; ++i) {  
+00008bc0: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+00008bd0: 2020 2020 2020 2020 2020 2020 785b 342a              x[4*
+00008be0: 695d 203d 2076 6164 6471 5f66 3136 2878  i] = vaddq_f16(x
+00008bf0: 5b34 2a69 5d2c 2078 5b34 2a69 2b32 5d29  [4*i], x[4*i+2])
+00008c00: 3b20 2020 2020 2020 2020 2020 2020 2020  ;               
+00008c10: 2020 5c0a 2020 2020 2020 2020 7d20 2020    \.        }   
+00008c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c50: 2020 2020 2020 5c0a 2020 2020 2020 2020        \.        
+00008c60: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00008c70: 6920 3c20 4747 4d4c 5f46 3136 5f41 5252  i < GGML_F16_ARR
+00008c80: 2f38 3b20 2b2b 6929 207b 2020 2020 2020  /8; ++i) {      
+00008c90: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+00008ca0: 2020 2020 2020 2020 785b 382a 695d 203d          x[8*i] =
+00008cb0: 2076 6164 6471 5f66 3136 2878 5b38 2a69   vaddq_f16(x[8*i
+00008cc0: 5d2c 2078 5b38 2a69 2b34 5d29 3b20 2020  ], x[8*i+4]);   
+00008cd0: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+00008ce0: 2020 2020 2020 2020 7d20 2020 2020 2020          }       
+00008cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d20: 2020 5c0a 2020 2020 2020 2020 636f 6e73    \.        cons
+00008d30: 7420 666c 6f61 7433 3278 345f 7420 7430  t float32x4_t t0
+00008d40: 203d 2076 6376 745f 6633 325f 6631 3628   = vcvt_f32_f16(
+00008d50: 7667 6574 5f6c 6f77 5f66 3136 2028 785b  vget_low_f16 (x[
+00008d60: 305d 2929 3b20 5c0a 2020 2020 2020 2020  0])); \.        
+00008d70: 636f 6e73 7420 666c 6f61 7433 3278 345f  const float32x4_
+00008d80: 7420 7431 203d 2076 6376 745f 6633 325f  t t1 = vcvt_f32_
+00008d90: 6631 3628 7667 6574 5f68 6967 685f 6631  f16(vget_high_f1
+00008da0: 3628 785b 305d 2929 3b20 5c0a 2020 2020  6(x[0])); \.    
+00008db0: 2020 2020 7265 7320 3d20 2867 676d 6c5f      res = (ggml_
+00008dc0: 666c 6f61 7429 2076 6164 6476 715f 6633  float) vaddvq_f3
+00008dd0: 3228 7661 6464 715f 6633 3228 7430 2c20  2(vaddq_f32(t0, 
+00008de0: 7431 2929 3b20 2020 2020 2020 2020 5c0a  t1));         \.
+00008df0: 2020 2020 7d0a 0a20 2020 2023 6465 6669      }..    #defi
+00008e00: 6e65 2047 474d 4c5f 4631 365f 5645 4320  ne GGML_F16_VEC 
+00008e10: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00008e20: 474d 4c5f 4631 3678 380a 2020 2020 2364  GML_F16x8.    #d
+00008e30: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
+00008e40: 4543 5f5a 4552 4f20 2020 2020 2020 2020  EC_ZERO         
+00008e50: 2020 4747 4d4c 5f46 3136 7838 5f5a 4552    GGML_F16x8_ZER
+00008e60: 4f0a 2020 2020 2364 6566 696e 6520 4747  O.    #define GG
+00008e70: 4d4c 5f46 3136 5f56 4543 5f53 4554 3120  ML_F16_VEC_SET1 
+00008e80: 2020 2020 2020 2020 2020 4747 4d4c 5f46            GGML_F
+00008e90: 3136 7838 5f53 4554 310a 2020 2020 2364  16x8_SET1.    #d
+00008ea0: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
+00008eb0: 4543 5f4c 4f41 4428 702c 2069 2920 2020  EC_LOAD(p, i)   
+00008ec0: 2020 4747 4d4c 5f46 3136 7838 5f4c 4f41    GGML_F16x8_LOA
+00008ed0: 4428 7029 0a20 2020 2023 6465 6669 6e65  D(p).    #define
+00008ee0: 2047 474d 4c5f 4631 365f 5645 435f 5354   GGML_F16_VEC_ST
+00008ef0: 4f52 4528 702c 2072 2c20 6929 2047 474d  ORE(p, r, i) GGM
+00008f00: 4c5f 4631 3678 385f 5354 4f52 4528 702c  L_F16x8_STORE(p,
+00008f10: 2072 5b69 5d29 0a20 2020 2023 6465 6669   r[i]).    #defi
+00008f20: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
+00008f30: 464d 4120 2020 2020 2020 2020 2020 2047  FMA            G
+00008f40: 474d 4c5f 4631 3678 385f 464d 410a 2020  GML_F16x8_FMA.  
+00008f50: 2020 2364 6566 696e 6520 4747 4d4c 5f46    #define GGML_F
+00008f60: 3136 5f56 4543 5f41 4444 2020 2020 2020  16_VEC_ADD      
+00008f70: 2020 2020 2020 4747 4d4c 5f46 3136 7838        GGML_F16x8
+00008f80: 5f41 4444 0a20 2020 2023 6465 6669 6e65  _ADD.    #define
+00008f90: 2047 474d 4c5f 4631 365f 5645 435f 4d55   GGML_F16_VEC_MU
+00008fa0: 4c20 2020 2020 2020 2020 2020 2047 474d  L            GGM
+00008fb0: 4c5f 4631 3678 385f 4d55 4c0a 2020 2020  L_F16x8_MUL.    
+00008fc0: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
+00008fd0: 5f56 4543 5f52 4544 5543 4520 2020 2020  _VEC_REDUCE     
+00008fe0: 2020 2020 4747 4d4c 5f46 3136 7838 5f52      GGML_F16x8_R
+00008ff0: 4544 5543 450a 2365 6c73 650a 2020 2020  EDUCE.#else.    
+00009000: 2f2f 2069 6620 4650 3136 2076 6563 746f  // if FP16 vecto
+00009010: 7220 6172 6974 686d 6574 6963 2069 7320  r arithmetic is 
+00009020: 6e6f 7420 7375 7070 6f72 7465 642c 2077  not supported, w
+00009030: 6520 7573 6520 4650 3332 2069 6e73 7465  e use FP32 inste
+00009040: 6164 0a20 2020 202f 2f20 616e 6420 7461  ad.    // and ta
+00009050: 6b65 2061 6476 616e 7461 6765 206f 6620  ke advantage of 
+00009060: 7468 6520 7663 7674 5f20 6675 6e63 7469  the vcvt_ functi
+00009070: 6f6e 7320 746f 2063 6f6e 7665 7274 2074  ons to convert t
+00009080: 6f2f 6672 6f6d 2046 5031 360a 0a20 2020  o/from FP16..   
+00009090: 2023 6465 6669 6e65 2047 474d 4c5f 4631   #define GGML_F1
+000090a0: 365f 5354 4550 2031 360a 2020 2020 2364  6_STEP 16.    #d
+000090b0: 6566 696e 6520 4747 4d4c 5f46 3136 5f45  efine GGML_F16_E
+000090c0: 5052 2020 340a 0a20 2020 2023 6465 6669  PR  4..    #defi
+000090d0: 6e65 2047 474d 4c5f 4633 3243 7834 2020  ne GGML_F32Cx4  
+000090e0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000090f0: 7433 3278 345f 740a 2020 2020 2364 6566  t32x4_t.    #def
+00009100: 696e 6520 4747 4d4c 5f46 3332 4378 345f  ine GGML_F32Cx4_
+00009110: 5a45 524f 2020 2020 2020 2020 2076 6475  ZERO         vdu
+00009120: 7071 5f6e 5f66 3332 2830 2e30 6629 0a20  pq_n_f32(0.0f). 
+00009130: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
+00009140: 4633 3243 7834 5f53 4554 3128 7829 2020  F32Cx4_SET1(x)  
+00009150: 2020 2020 7664 7570 715f 6e5f 6633 3228      vdupq_n_f32(
+00009160: 7829 0a20 2020 2023 6465 6669 6e65 2047  x).    #define G
+00009170: 474d 4c5f 4633 3243 7834 5f4c 4f41 4428  GML_F32Cx4_LOAD(
+00009180: 7829 2020 2020 2020 7663 7674 5f66 3332  x)      vcvt_f32
+00009190: 5f66 3136 2876 6c64 315f 6631 3628 7829  _f16(vld1_f16(x)
+000091a0: 290a 2020 2020 2364 6566 696e 6520 4747  ).    #define GG
+000091b0: 4d4c 5f46 3332 4378 345f 5354 4f52 4528  ML_F32Cx4_STORE(
+000091c0: 782c 2079 2920 2076 7374 315f 6631 3628  x, y)  vst1_f16(
+000091d0: 782c 2076 6376 745f 6631 365f 6633 3228  x, vcvt_f16_f32(
+000091e0: 7929 290a 2020 2020 2364 6566 696e 6520  y)).    #define 
+000091f0: 4747 4d4c 5f46 3332 4378 345f 464d 4128  GGML_F32Cx4_FMA(
+00009200: 612c 2062 2c20 6329 2076 666d 6171 5f66  a, b, c) vfmaq_f
+00009210: 3332 2861 2c20 622c 2063 290a 2020 2020  32(a, b, c).    
+00009220: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
+00009230: 4378 345f 4144 4420 2020 2020 2020 2020  Cx4_ADD         
+00009240: 2076 6164 6471 5f66 3332 0a20 2020 2023   vaddq_f32.    #
+00009250: 6465 6669 6e65 2047 474d 4c5f 4633 3243  define GGML_F32C
+00009260: 7834 5f4d 554c 2020 2020 2020 2020 2020  x4_MUL          
+00009270: 766d 756c 715f 6633 320a 2020 2020 2364  vmulq_f32.    #d
+00009280: 6566 696e 6520 4747 4d4c 5f46 3332 4378  efine GGML_F32Cx
+00009290: 345f 5245 4455 4345 2020 2020 2020 2047  4_REDUCE       G
+000092a0: 474d 4c5f 4633 3278 345f 5245 4455 4345  GML_F32x4_REDUCE
+000092b0: 0a0a 2020 2020 2364 6566 696e 6520 4747  ..    #define GG
+000092c0: 4d4c 5f46 3136 5f56 4543 2020 2020 2020  ML_F16_VEC      
+000092d0: 2020 2020 2020 2020 2020 4747 4d4c 5f46            GGML_F
+000092e0: 3332 4378 340a 2020 2020 2364 6566 696e  32Cx4.    #defin
+000092f0: 6520 4747 4d4c 5f46 3136 5f56 4543 5f5a  e GGML_F16_VEC_Z
+00009300: 4552 4f20 2020 2020 2020 2020 2020 4747  ERO           GG
+00009310: 4d4c 5f46 3332 4378 345f 5a45 524f 0a20  ML_F32Cx4_ZERO. 
+00009320: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
+00009330: 4631 365f 5645 435f 5345 5431 2020 2020  F16_VEC_SET1    
+00009340: 2020 2020 2020 2047 474d 4c5f 4633 3243         GGML_F32C
+00009350: 7834 5f53 4554 310a 2020 2020 2364 6566  x4_SET1.    #def
+00009360: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
+00009370: 5f4c 4f41 4428 702c 2069 2920 2020 2020  _LOAD(p, i)     
+00009380: 4747 4d4c 5f46 3332 4378 345f 4c4f 4144  GGML_F32Cx4_LOAD
+00009390: 2870 290a 2020 2020 2364 6566 696e 6520  (p).    #define 
+000093a0: 4747 4d4c 5f46 3136 5f56 4543 5f53 544f  GGML_F16_VEC_STO
+000093b0: 5245 2870 2c20 722c 2069 2920 4747 4d4c  RE(p, r, i) GGML
+000093c0: 5f46 3332 4378 345f 5354 4f52 4528 702c  _F32Cx4_STORE(p,
+000093d0: 2072 5b69 5d29 0a20 2020 2023 6465 6669   r[i]).    #defi
+000093e0: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
+000093f0: 464d 4120 2020 2020 2020 2020 2020 2047  FMA            G
+00009400: 474d 4c5f 4633 3243 7834 5f46 4d41 0a20  GML_F32Cx4_FMA. 
+00009410: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
+00009420: 4631 365f 5645 435f 4144 4420 2020 2020  F16_VEC_ADD     
+00009430: 2020 2020 2020 2047 474d 4c5f 4633 3243         GGML_F32C
+00009440: 7834 5f41 4444 0a20 2020 2023 6465 6669  x4_ADD.    #defi
+00009450: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
+00009460: 4d55 4c20 2020 2020 2020 2020 2020 2047  MUL            G
+00009470: 474d 4c5f 4633 3243 7834 5f4d 554c 0a20  GML_F32Cx4_MUL. 
+00009480: 2020 2023 6465 6669 6e65 2047 474d 4c5f     #define GGML_
+00009490: 4631 365f 5645 435f 5245 4455 4345 2020  F16_VEC_REDUCE  
+000094a0: 2020 2020 2020 2047 474d 4c5f 4633 3243         GGML_F32C
+000094b0: 7834 5f52 4544 5543 450a 2365 6e64 6966  x4_REDUCE.#endif
+000094c0: 0a0a 2365 6c69 6620 6465 6669 6e65 6428  ..#elif defined(
+000094d0: 5f5f 4156 585f 5f29 0a0a 2364 6566 696e  __AVX__)..#defin
+000094e0: 6520 4747 4d4c 5f53 494d 440a 0a2f 2f20  e GGML_SIMD..// 
+000094f0: 4633 3220 4156 580a 0a23 6465 6669 6e65  F32 AVX..#define
+00009500: 2047 474d 4c5f 4633 325f 5354 4550 2033   GGML_F32_STEP 3
+00009510: 320a 2364 6566 696e 6520 4747 4d4c 5f46  2.#define GGML_F
+00009520: 3332 5f45 5052 2020 380a 0a23 6465 6669  32_EPR  8..#defi
+00009530: 6e65 2047 474d 4c5f 4633 3278 3820 2020  ne GGML_F32x8   
+00009540: 2020 2020 2020 5f5f 6d32 3536 0a23 6465        __m256.#de
+00009550: 6669 6e65 2047 474d 4c5f 4633 3278 385f  fine GGML_F32x8_
+00009560: 5a45 524f 2020 2020 5f6d 6d32 3536 5f73  ZERO    _mm256_s
+00009570: 6574 7a65 726f 5f70 7328 290a 2364 6566  etzero_ps().#def
+00009580: 696e 6520 4747 4d4c 5f46 3332 7838 5f53  ine GGML_F32x8_S
+00009590: 4554 3128 7829 205f 6d6d 3235 365f 7365  ET1(x) _mm256_se
+000095a0: 7431 5f70 7328 7829 0a23 6465 6669 6e65  t1_ps(x).#define
+000095b0: 2047 474d 4c5f 4633 3278 385f 4c4f 4144   GGML_F32x8_LOAD
+000095c0: 2020 2020 5f6d 6d32 3536 5f6c 6f61 6475      _mm256_loadu
+000095d0: 5f70 730a 2364 6566 696e 6520 4747 4d4c  _ps.#define GGML
+000095e0: 5f46 3332 7838 5f53 544f 5245 2020 205f  _F32x8_STORE   _
+000095f0: 6d6d 3235 365f 7374 6f72 6575 5f70 730a  mm256_storeu_ps.
+00009600: 2369 6620 6465 6669 6e65 6428 5f5f 464d  #if defined(__FM
+00009610: 415f 5f29 0a20 2020 2023 6465 6669 6e65  A__).    #define
+00009620: 2047 474d 4c5f 4633 3278 385f 464d 4128   GGML_F32x8_FMA(
+00009630: 612c 2062 2c20 6329 205f 6d6d 3235 365f  a, b, c) _mm256_
+00009640: 666d 6164 645f 7073 2862 2c20 632c 2061  fmadd_ps(b, c, a
+00009650: 290a 2365 6c73 650a 2020 2020 2364 6566  ).#else.    #def
+00009660: 696e 6520 4747 4d4c 5f46 3332 7838 5f46  ine GGML_F32x8_F
+00009670: 4d41 2861 2c20 622c 2063 2920 5f6d 6d32  MA(a, b, c) _mm2
+00009680: 3536 5f61 6464 5f70 7328 5f6d 6d32 3536  56_add_ps(_mm256
+00009690: 5f6d 756c 5f70 7328 622c 2063 292c 2061  _mul_ps(b, c), a
+000096a0: 290a 2365 6e64 6966 0a23 6465 6669 6e65  ).#endif.#define
+000096b0: 2047 474d 4c5f 4633 3278 385f 4144 4420   GGML_F32x8_ADD 
+000096c0: 2020 2020 5f6d 6d32 3536 5f61 6464 5f70      _mm256_add_p
+000096d0: 730a 2364 6566 696e 6520 4747 4d4c 5f46  s.#define GGML_F
+000096e0: 3332 7838 5f4d 554c 2020 2020 205f 6d6d  32x8_MUL     _mm
+000096f0: 3235 365f 6d75 6c5f 7073 0a23 6465 6669  256_mul_ps.#defi
+00009700: 6e65 2047 474d 4c5f 4633 3278 385f 5245  ne GGML_F32x8_RE
+00009710: 4455 4345 2872 6573 2c20 7829 2020 2020  DUCE(res, x)    
+00009720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009730: 2020 2020 2020 2020 2020 2020 205c 0a7b               \.{
+00009740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009780: 205c 0a20 2020 2066 6f72 2028 696e 7420   \.    for (int 
+00009790: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
+000097a0: 4633 325f 4152 522f 323b 202b 2b69 2920  F32_ARR/2; ++i) 
+000097b0: 7b20 2020 2020 2020 2020 2020 2020 2020  {               
+000097c0: 2020 2020 205c 0a20 2020 2020 2020 2078       \.        x
+000097d0: 5b32 2a69 5d20 3d20 5f6d 6d32 3536 5f61  [2*i] = _mm256_a
+000097e0: 6464 5f70 7328 785b 322a 695d 2c20 785b  dd_ps(x[2*i], x[
+000097f0: 322a 692b 315d 293b 2020 2020 2020 2020  2*i+1]);        
+00009800: 2020 2020 2020 2020 205c 0a20 2020 207d           \.    }
+00009810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009840: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
+00009850: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00009860: 303b 2069 203c 2047 474d 4c5f 4633 325f  0; i < GGML_F32_
+00009870: 4152 522f 343b 202b 2b69 2920 7b20 2020  ARR/4; ++i) {   
+00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009890: 205c 0a20 2020 2020 2020 2078 5b34 2a69   \.        x[4*i
+000098a0: 5d20 3d20 5f6d 6d32 3536 5f61 6464 5f70  ] = _mm256_add_p
+000098b0: 7328 785b 342a 695d 2c20 785b 342a 692b  s(x[4*i], x[4*i+
+000098c0: 325d 293b 2020 2020 2020 2020 2020 2020  2]);            
+000098d0: 2020 2020 205c 0a20 2020 207d 2020 2020       \.    }    
+000098e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009910: 2020 2020 2020 2020 205c 0a20 2020 2066           \.    f
+00009920: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00009930: 203c 2047 474d 4c5f 4633 325f 4152 522f   < GGML_F32_ARR/
+00009940: 383b 202b 2b69 2920 7b20 2020 2020 2020  8; ++i) {       
+00009950: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
+00009960: 2020 2020 2020 2078 5b38 2a69 5d20 3d20         x[8*i] = 
+00009970: 5f6d 6d32 3536 5f61 6464 5f70 7328 785b  _mm256_add_ps(x[
+00009980: 382a 695d 2c20 785b 382a 692b 345d 293b  8*i], x[8*i+4]);
+00009990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099a0: 205c 0a20 2020 207d 2020 2020 2020 2020   \.    }        
+000099b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099e0: 2020 2020 205c 0a20 2020 2063 6f6e 7374       \.    const
+000099f0: 205f 5f6d 3132 3820 7430 203d 205f 6d6d   __m128 t0 = _mm
+00009a00: 5f61 6464 5f70 7328 5f6d 6d32 3536 5f63  _add_ps(_mm256_c
+00009a10: 6173 7470 7332 3536 5f70 7331 3238 2878  astps256_ps128(x
+00009a20: 5b30 5d29 2c20 2020 205c 0a20 2020 2020  [0]),    \.     
+00009a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a40: 2020 2020 2020 2020 2020 2020 5f6d 6d32              _mm2
+00009a50: 3536 5f65 7874 7261 6374 6631 3238 5f70  56_extractf128_p
+00009a60: 7328 785b 305d 2c20 3129 293b 205c 0a20  s(x[0], 1)); \. 
+00009a70: 2020 2063 6f6e 7374 205f 5f6d 3132 3820     const __m128 
+00009a80: 7431 203d 205f 6d6d 5f68 6164 645f 7073  t1 = _mm_hadd_ps
+00009a90: 2874 302c 2074 3029 3b20 2020 2020 2020  (t0, t0);       
+00009aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ab0: 205c 0a20 2020 2072 6573 203d 205f 6d6d   \.    res = _mm
+00009ac0: 5f63 7674 7373 5f66 3332 285f 6d6d 5f68  _cvtss_f32(_mm_h
+00009ad0: 6164 645f 7073 2874 312c 2074 3129 293b  add_ps(t1, t1));
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009af0: 2020 2020 205c 0a7d 0a2f 2f20 544f 444f       \.}.// TODO
+00009b00: 3a20 6973 2074 6869 7320 6f70 7469 6d61  : is this optima
+00009b10: 6c20 3f0a 0a23 6465 6669 6e65 2047 474d  l ?..#define GGM
+00009b20: 4c5f 4633 325f 5645 4320 2020 2020 2020  L_F32_VEC       
+00009b30: 2047 474d 4c5f 4633 3278 380a 2364 6566   GGML_F32x8.#def
+00009b40: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
+00009b50: 5f5a 4552 4f20 2020 4747 4d4c 5f46 3332  _ZERO   GGML_F32
+00009b60: 7838 5f5a 4552 4f0a 2364 6566 696e 6520  x8_ZERO.#define 
+00009b70: 4747 4d4c 5f46 3332 5f56 4543 5f53 4554  GGML_F32_VEC_SET
+00009b80: 3120 2020 4747 4d4c 5f46 3332 7838 5f53  1   GGML_F32x8_S
+00009b90: 4554 310a 2364 6566 696e 6520 4747 4d4c  ET1.#define GGML
+00009ba0: 5f46 3332 5f56 4543 5f4c 4f41 4420 2020  _F32_VEC_LOAD   
+00009bb0: 4747 4d4c 5f46 3332 7838 5f4c 4f41 440a  GGML_F32x8_LOAD.
+00009bc0: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
+00009bd0: 5f56 4543 5f53 544f 5245 2020 4747 4d4c  _VEC_STORE  GGML
+00009be0: 5f46 3332 7838 5f53 544f 5245 0a23 6465  _F32x8_STORE.#de
+00009bf0: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
+00009c00: 435f 464d 4120 2020 2047 474d 4c5f 4633  C_FMA    GGML_F3
+00009c10: 3278 385f 464d 410a 2364 6566 696e 6520  2x8_FMA.#define 
+00009c20: 4747 4d4c 5f46 3332 5f56 4543 5f41 4444  GGML_F32_VEC_ADD
+00009c30: 2020 2020 4747 4d4c 5f46 3332 7838 5f41      GGML_F32x8_A
+00009c40: 4444 0a23 6465 6669 6e65 2047 474d 4c5f  DD.#define GGML_
+00009c50: 4633 325f 5645 435f 4d55 4c20 2020 2047  F32_VEC_MUL    G
+00009c60: 474d 4c5f 4633 3278 385f 4d55 4c0a 2364  GML_F32x8_MUL.#d
+00009c70: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
+00009c80: 4543 5f52 4544 5543 4520 4747 4d4c 5f46  EC_REDUCE GGML_F
+00009c90: 3332 7838 5f52 4544 5543 450a 0a2f 2f20  32x8_REDUCE..// 
+00009ca0: 4631 3620 4156 580a 0a23 6465 6669 6e65  F16 AVX..#define
+00009cb0: 2047 474d 4c5f 4631 365f 5354 4550 2033   GGML_F16_STEP 3
+00009cc0: 320a 2364 6566 696e 6520 4747 4d4c 5f46  2.#define GGML_F
+00009cd0: 3136 5f45 5052 2020 380a 0a2f 2f20 4631  16_EPR  8..// F1
+00009ce0: 3620 6172 6974 686d 6574 6963 2069 7320  6 arithmetic is 
+00009cf0: 6e6f 7420 7375 7070 6f72 7465 6420 6279  not supported by
+00009d00: 2041 5658 2c20 736f 2077 6520 7573 6520   AVX, so we use 
+00009d10: 4633 3220 696e 7374 6561 640a 0a23 6465  F32 instead..#de
+00009d20: 6669 6e65 2047 474d 4c5f 4633 3243 7838  fine GGML_F32Cx8
+00009d30: 2020 2020 2020 2020 2020 2020 205f 5f6d               __m
+00009d40: 3235 360a 2364 6566 696e 6520 4747 4d4c  256.#define GGML
+00009d50: 5f46 3332 4378 385f 5a45 524f 2020 2020  _F32Cx8_ZERO    
+00009d60: 2020 2020 5f6d 6d32 3536 5f73 6574 7a65      _mm256_setze
+00009d70: 726f 5f70 7328 290a 2364 6566 696e 6520  ro_ps().#define 
+00009d80: 4747 4d4c 5f46 3332 4378 385f 5345 5431  GGML_F32Cx8_SET1
+00009d90: 2878 2920 2020 2020 5f6d 6d32 3536 5f73  (x)     _mm256_s
+00009da0: 6574 315f 7073 2878 290a 0a23 6966 2064  et1_ps(x)..#if d
+00009db0: 6566 696e 6564 285f 5f46 3136 435f 5f29  efined(__F16C__)
+00009dc0: 0a2f 2f20 7468 6520 205f 6d6d 3235 365f  .// the  _mm256_
+00009dd0: 6376 7420 696e 7472 696e 7369 6373 2072  cvt intrinsics r
+00009de0: 6571 7569 7265 2046 3136 430a 2364 6566  equire F16C.#def
+00009df0: 696e 6520 4747 4d4c 5f46 3332 4378 385f  ine GGML_F32Cx8_
+00009e00: 4c4f 4144 2878 2920 2020 2020 5f6d 6d32  LOAD(x)     _mm2
+00009e10: 3536 5f63 7674 7068 5f70 7328 5f6d 6d5f  56_cvtph_ps(_mm_
+00009e20: 6c6f 6164 755f 7369 3132 3828 285f 5f6d  loadu_si128((__m
+00009e30: 3132 3869 202a 2928 7829 2929 0a23 6465  128i *)(x))).#de
+00009e40: 6669 6e65 2047 474d 4c5f 4633 3243 7838  fine GGML_F32Cx8
+00009e50: 5f53 544f 5245 2878 2c20 7929 205f 6d6d  _STORE(x, y) _mm
+00009e60: 5f73 746f 7265 755f 7369 3132 3828 285f  _storeu_si128((_
+00009e70: 5f6d 3132 3869 202a 2928 7829 2c20 5f6d  _m128i *)(x), _m
+00009e80: 6d32 3536 5f63 7674 7073 5f70 6828 792c  m256_cvtps_ph(y,
+00009e90: 2030 2929 0a23 656c 7365 0a73 7461 7469   0)).#else.stati
+00009ea0: 6320 696e 6c69 6e65 205f 5f6d 3235 3620  c inline __m256 
+00009eb0: 5f5f 6176 785f 6633 3263 7838 5f6c 6f61  __avx_f32cx8_loa
+00009ec0: 6428 6767 6d6c 5f66 7031 365f 7420 2a78  d(ggml_fp16_t *x
+00009ed0: 2920 7b0a 2020 2020 666c 6f61 7420 746d  ) {.    float tm
+00009ee0: 705b 385d 3b0a 0a20 2020 2066 6f72 2028  p[8];..    for (
+00009ef0: 696e 7420 6920 3d20 303b 2069 203c 2038  int i = 0; i < 8
+00009f00: 3b20 692b 2b29 0a20 2020 2020 2020 2074  ; i++).        t
+00009f10: 6d70 5b69 5d20 3d20 4747 4d4c 5f46 5031  mp[i] = GGML_FP1
+00009f20: 365f 544f 5f46 5033 3228 785b 695d 293b  6_TO_FP32(x[i]);
+00009f30: 0a0a 2020 2020 7265 7475 726e 205f 6d6d  ..    return _mm
+00009f40: 3235 365f 6c6f 6164 755f 7073 2874 6d70  256_loadu_ps(tmp
+00009f50: 293b 0a7d 0a73 7461 7469 6320 696e 6c69  );.}.static inli
+00009f60: 6e65 2076 6f69 6420 5f5f 6176 785f 6633  ne void __avx_f3
+00009f70: 3263 7838 5f73 746f 7265 2867 676d 6c5f  2cx8_store(ggml_
+00009f80: 6670 3136 5f74 202a 782c 205f 5f6d 3235  fp16_t *x, __m25
+00009f90: 3620 7929 207b 0a20 2020 2066 6c6f 6174  6 y) {.    float
+00009fa0: 2061 7272 5b38 5d3b 0a0a 2020 2020 5f6d   arr[8];..    _m
+00009fb0: 6d32 3536 5f73 746f 7265 755f 7073 2861  m256_storeu_ps(a
+00009fc0: 7272 2c20 7929 3b0a 0a20 2020 2066 6f72  rr, y);..    for
+00009fd0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00009fe0: 2038 3b20 692b 2b29 0a20 2020 2020 2020   8; i++).       
+00009ff0: 2078 5b69 5d20 3d20 4747 4d4c 5f46 5031   x[i] = GGML_FP1
+0000a000: 365f 544f 5f46 5033 3228 6172 725b 695d  6_TO_FP32(arr[i]
+0000a010: 293b 0a7d 0a23 6465 6669 6e65 2047 474d  );.}.#define GGM
+0000a020: 4c5f 4633 3243 7838 5f4c 4f41 4428 7829  L_F32Cx8_LOAD(x)
+0000a030: 2020 2020 205f 5f61 7678 5f66 3332 6378       __avx_f32cx
+0000a040: 385f 6c6f 6164 2878 290a 2364 6566 696e  8_load(x).#defin
+0000a050: 6520 4747 4d4c 5f46 3332 4378 385f 5354  e GGML_F32Cx8_ST
+0000a060: 4f52 4528 782c 2079 2920 5f5f 6176 785f  ORE(x, y) __avx_
+0000a070: 6633 3263 7838 5f73 746f 7265 2878 2c20  f32cx8_store(x, 
+0000a080: 7929 0a23 656e 6469 660a 0a23 6465 6669  y).#endif..#defi
+0000a090: 6e65 2047 474d 4c5f 4633 3243 7838 5f46  ne GGML_F32Cx8_F
+0000a0a0: 4d41 2020 2020 2020 2020 2047 474d 4c5f  MA         GGML_
+0000a0b0: 4633 3278 385f 464d 410a 2364 6566 696e  F32x8_FMA.#defin
+0000a0c0: 6520 4747 4d4c 5f46 3332 4378 385f 4144  e GGML_F32Cx8_AD
+0000a0d0: 4420 2020 2020 2020 2020 5f6d 6d32 3536  D         _mm256
+0000a0e0: 5f61 6464 5f70 730a 2364 6566 696e 6520  _add_ps.#define 
+0000a0f0: 4747 4d4c 5f46 3332 4378 385f 4d55 4c20  GGML_F32Cx8_MUL 
+0000a100: 2020 2020 2020 2020 5f6d 6d32 3536 5f6d          _mm256_m
+0000a110: 756c 5f70 730a 2364 6566 696e 6520 4747  ul_ps.#define GG
+0000a120: 4d4c 5f46 3332 4378 385f 5245 4455 4345  ML_F32Cx8_REDUCE
+0000a130: 2020 2020 2020 4747 4d4c 5f46 3332 7838        GGML_F32x8
+0000a140: 5f52 4544 5543 450a 0a23 6465 6669 6e65  _REDUCE..#define
+0000a150: 2047 474d 4c5f 4631 365f 5645 4320 2020   GGML_F16_VEC   
+0000a160: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+0000a170: 4c5f 4633 3243 7838 0a23 6465 6669 6e65  L_F32Cx8.#define
+0000a180: 2047 474d 4c5f 4631 365f 5645 435f 5a45   GGML_F16_VEC_ZE
+0000a190: 524f 2020 2020 2020 2020 2020 2047 474d  RO           GGM
+0000a1a0: 4c5f 4633 3243 7838 5f5a 4552 4f0a 2364  L_F32Cx8_ZERO.#d
+0000a1b0: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
+0000a1c0: 4543 5f53 4554 3120 2020 2020 2020 2020  EC_SET1         
+0000a1d0: 2020 4747 4d4c 5f46 3332 4378 385f 5345    GGML_F32Cx8_SE
+0000a1e0: 5431 0a23 6465 6669 6e65 2047 474d 4c5f  T1.#define GGML_
+0000a1f0: 4631 365f 5645 435f 4c4f 4144 2870 2c20  F16_VEC_LOAD(p, 
+0000a200: 6929 2020 2020 2047 474d 4c5f 4633 3243  i)     GGML_F32C
+0000a210: 7838 5f4c 4f41 4428 7029 0a23 6465 6669  x8_LOAD(p).#defi
+0000a220: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
+0000a230: 5354 4f52 4528 702c 2072 2c20 6929 2047  STORE(p, r, i) G
+0000a240: 474d 4c5f 4633 3243 7838 5f53 544f 5245  GML_F32Cx8_STORE
+0000a250: 2870 2c20 725b 695d 290a 2364 6566 696e  (p, r[i]).#defin
+0000a260: 6520 4747 4d4c 5f46 3136 5f56 4543 5f46  e GGML_F16_VEC_F
+0000a270: 4d41 2020 2020 2020 2020 2020 2020 4747  MA            GG
+0000a280: 4d4c 5f46 3332 4378 385f 464d 410a 2364  ML_F32Cx8_FMA.#d
+0000a290: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
+0000a2a0: 4543 5f41 4444 2020 2020 2020 2020 2020  EC_ADD          
+0000a2b0: 2020 4747 4d4c 5f46 3332 4378 385f 4144    GGML_F32Cx8_AD
+0000a2c0: 440a 2364 6566 696e 6520 4747 4d4c 5f46  D.#define GGML_F
+0000a2d0: 3136 5f56 4543 5f4d 554c 2020 2020 2020  16_VEC_MUL      
+0000a2e0: 2020 2020 2020 4747 4d4c 5f46 3332 4378        GGML_F32Cx
+0000a2f0: 385f 4d55 4c0a 2364 6566 696e 6520 4747  8_MUL.#define GG
+0000a300: 4d4c 5f46 3136 5f56 4543 5f52 4544 5543  ML_F16_VEC_REDUC
+0000a310: 4520 2020 2020 2020 2020 4747 4d4c 5f46  E         GGML_F
+0000a320: 3332 4378 385f 5245 4455 4345 0a0a 2365  32Cx8_REDUCE..#e
+0000a330: 6c69 6620 6465 6669 6e65 6428 5f5f 504f  lif defined(__PO
+0000a340: 5745 5239 5f56 4543 544f 525f 5f29 0a0a  WER9_VECTOR__)..
+0000a350: 2364 6566 696e 6520 4747 4d4c 5f53 494d  #define GGML_SIM
+0000a360: 440a 0a2f 2f20 4633 3220 504f 5745 5239  D..// F32 POWER9
+0000a370: 0a0a 2364 6566 696e 6520 4747 4d4c 5f46  ..#define GGML_F
+0000a380: 3332 5f53 5445 5020 3332 0a23 6465 6669  32_STEP 32.#defi
+0000a390: 6e65 2047 474d 4c5f 4633 325f 4550 5220  ne GGML_F32_EPR 
+0000a3a0: 2034 0a0a 2364 6566 696e 6520 4747 4d4c   4..#define GGML
+0000a3b0: 5f46 3332 7834 2020 2020 2020 2020 2020  _F32x4          
+0000a3c0: 2020 2020 7665 6374 6f72 2066 6c6f 6174      vector float
+0000a3d0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000a3e0: 3278 345f 5a45 524f 2020 2020 2020 2020  2x4_ZERO        
+0000a3f0: 2030 2e30 660a 2364 6566 696e 6520 4747   0.0f.#define GG
+0000a400: 4d4c 5f46 3332 7834 5f53 4554 3120 2020  ML_F32x4_SET1   
+0000a410: 2020 2020 2020 7665 635f 7370 6c61 7473        vec_splats
+0000a420: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000a430: 3278 345f 4c4f 4144 2870 2920 2020 2020  2x4_LOAD(p)     
+0000a440: 2076 6563 5f78 6c28 302c 2070 290a 2364   vec_xl(0, p).#d
+0000a450: 6566 696e 6520 4747 4d4c 5f46 3332 7834  efine GGML_F32x4
+0000a460: 5f53 544f 5245 2870 2c20 7229 2020 7665  _STORE(p, r)  ve
+0000a470: 635f 7873 7428 722c 2030 2c20 7029 0a23  c_xst(r, 0, p).#
+0000a480: 6465 6669 6e65 2047 474d 4c5f 4633 3278  define GGML_F32x
+0000a490: 345f 464d 4128 612c 2062 2c20 6329 2076  4_FMA(a, b, c) v
+0000a4a0: 6563 5f6d 6164 6428 622c 2063 2c20 6129  ec_madd(b, c, a)
+0000a4b0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000a4c0: 3278 345f 4144 4420 2020 2020 2020 2020  2x4_ADD         
+0000a4d0: 2076 6563 5f61 6464 0a23 6465 6669 6e65   vec_add.#define
+0000a4e0: 2047 474d 4c5f 4633 3278 345f 4d55 4c20   GGML_F32x4_MUL 
+0000a4f0: 2020 2020 2020 2020 2076 6563 5f6d 756c           vec_mul
+0000a500: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000a510: 3278 345f 5245 4455 4345 2872 6573 2c20  2x4_REDUCE(res, 
+0000a520: 7829 2020 2020 2020 2020 2020 2020 2020  x)              
+0000a530: 5c0a 7b20 2020 2020 2020 2020 2020 2020  \.{             
+0000a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a560: 205c 0a20 2020 2066 6f72 2028 696e 7420   \.    for (int 
+0000a570: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
+0000a580: 4633 325f 4152 522f 323b 202b 2b69 2920  F32_ARR/2; ++i) 
+0000a590: 7b20 5c0a 2020 2020 2020 2020 785b 322a  { \.        x[2*
+0000a5a0: 695d 203d 2076 6563 5f61 6464 2878 5b32  i] = vec_add(x[2
+0000a5b0: 2a69 5d2c 2078 5b32 2a69 2b31 5d29 3b20  *i], x[2*i+1]); 
+0000a5c0: 2020 205c 0a20 2020 207d 2020 2020 2020     \.    }      
+0000a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5f0: 2020 2020 5c0a 2020 2020 666f 7220 2869      \.    for (i
+0000a600: 6e74 2069 203d 2030 3b20 6920 3c20 4747  nt i = 0; i < GG
+0000a610: 4d4c 5f46 3332 5f41 5252 2f34 3b20 2b2b  ML_F32_ARR/4; ++
+0000a620: 6929 207b 205c 0a20 2020 2020 2020 2078  i) { \.        x
+0000a630: 5b34 2a69 5d20 3d20 7665 635f 6164 6428  [4*i] = vec_add(
+0000a640: 785b 342a 695d 2c20 785b 342a 692b 325d  x[4*i], x[4*i+2]
+0000a650: 293b 2020 2020 5c0a 2020 2020 7d20 2020  );    \.    }   
+0000a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a680: 2020 2020 2020 205c 0a20 2020 2066 6f72         \.    for
+0000a690: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0000a6a0: 2047 474d 4c5f 4633 325f 4152 522f 383b   GGML_F32_ARR/8;
+0000a6b0: 202b 2b69 2920 7b20 5c0a 2020 2020 2020   ++i) { \.      
+0000a6c0: 2020 785b 382a 695d 203d 2076 6563 5f61    x[8*i] = vec_a
+0000a6d0: 6464 2878 5b38 2a69 5d2c 2078 5b38 2a69  dd(x[8*i], x[8*i
+0000a6e0: 2b34 5d29 3b20 2020 205c 0a20 2020 207d  +4]);    \.    }
+0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a710: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+0000a720: 7265 7320 3d20 7665 635f 6578 7472 6163  res = vec_extrac
+0000a730: 7428 785b 305d 2c20 3029 202b 2020 2020  t(x[0], 0) +    
+0000a740: 2020 2020 2020 2020 2020 205c 0a20 2020             \.   
+0000a750: 2020 2020 2020 2076 6563 5f65 7874 7261         vec_extra
+0000a760: 6374 2878 5b30 5d2c 2031 2920 2b20 2020  ct(x[0], 1) +   
+0000a770: 2020 2020 2020 2020 2020 2020 5c0a 2020              \.  
+0000a780: 2020 2020 2020 2020 7665 635f 6578 7472          vec_extr
+0000a790: 6163 7428 785b 305d 2c20 3229 202b 2020  act(x[0], 2) +  
+0000a7a0: 2020 2020 2020 2020 2020 2020 205c 0a20               \. 
+0000a7b0: 2020 2020 2020 2020 2076 6563 5f65 7874           vec_ext
+0000a7c0: 7261 6374 2878 5b30 5d2c 2033 293b 2020  ract(x[0], 3);  
+0000a7d0: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+0000a7e0: 7d0a 0a23 6465 6669 6e65 2047 474d 4c5f  }..#define GGML_
+0000a7f0: 4633 325f 5645 4320 2020 2020 2020 2047  F32_VEC        G
+0000a800: 474d 4c5f 4633 3278 340a 2364 6566 696e  GML_F32x4.#defin
+0000a810: 6520 4747 4d4c 5f46 3332 5f56 4543 5f5a  e GGML_F32_VEC_Z
+0000a820: 4552 4f20 2020 4747 4d4c 5f46 3332 7834  ERO   GGML_F32x4
+0000a830: 5f5a 4552 4f0a 2364 6566 696e 6520 4747  _ZERO.#define GG
+0000a840: 4d4c 5f46 3332 5f56 4543 5f53 4554 3120  ML_F32_VEC_SET1 
+0000a850: 2020 4747 4d4c 5f46 3332 7834 5f53 4554    GGML_F32x4_SET
+0000a860: 310a 2364 6566 696e 6520 4747 4d4c 5f46  1.#define GGML_F
+0000a870: 3332 5f56 4543 5f4c 4f41 4420 2020 4747  32_VEC_LOAD   GG
+0000a880: 4d4c 5f46 3332 7834 5f4c 4f41 440a 2364  ML_F32x4_LOAD.#d
+0000a890: 6566 696e 6520 4747 4d4c 5f46 3332 5f56  efine GGML_F32_V
+0000a8a0: 4543 5f53 544f 5245 2020 4747 4d4c 5f46  EC_STORE  GGML_F
+0000a8b0: 3332 7834 5f53 544f 5245 0a23 6465 6669  32x4_STORE.#defi
+0000a8c0: 6e65 2047 474d 4c5f 4633 325f 5645 435f  ne GGML_F32_VEC_
+0000a8d0: 464d 4120 2020 2047 474d 4c5f 4633 3278  FMA    GGML_F32x
+0000a8e0: 345f 464d 410a 2364 6566 696e 6520 4747  4_FMA.#define GG
+0000a8f0: 4d4c 5f46 3332 5f56 4543 5f41 4444 2020  ML_F32_VEC_ADD  
+0000a900: 2020 4747 4d4c 5f46 3332 7834 5f41 4444    GGML_F32x4_ADD
+0000a910: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000a920: 325f 5645 435f 4d55 4c20 2020 2047 474d  2_VEC_MUL    GGM
+0000a930: 4c5f 4633 3278 345f 4d55 4c0a 2364 6566  L_F32x4_MUL.#def
+0000a940: 696e 6520 4747 4d4c 5f46 3332 5f56 4543  ine GGML_F32_VEC
+0000a950: 5f52 4544 5543 4520 4747 4d4c 5f46 3332  _REDUCE GGML_F32
+0000a960: 7834 5f52 4544 5543 450a 0a2f 2f20 4631  x4_REDUCE..// F1
+0000a970: 3620 504f 5745 5239 0a23 6465 6669 6e65  6 POWER9.#define
+0000a980: 2047 474d 4c5f 4631 365f 5354 4550 2020   GGML_F16_STEP  
+0000a990: 2020 2020 2047 474d 4c5f 4633 325f 5354       GGML_F32_ST
+0000a9a0: 4550 0a23 6465 6669 6e65 2047 474d 4c5f  EP.#define GGML_
+0000a9b0: 4631 365f 4550 5220 2020 2020 2020 2047  F16_EPR        G
+0000a9c0: 474d 4c5f 4633 325f 4550 520a 2364 6566  GML_F32_EPR.#def
+0000a9d0: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
+0000a9e0: 2020 2020 2020 2020 4747 4d4c 5f46 3332          GGML_F32
+0000a9f0: 7834 0a23 6465 6669 6e65 2047 474d 4c5f  x4.#define GGML_
+0000aa00: 4631 365f 5645 435f 5a45 524f 2020 2047  F16_VEC_ZERO   G
+0000aa10: 474d 4c5f 4633 3278 345f 5a45 524f 0a23  GML_F32x4_ZERO.#
+0000aa20: 6465 6669 6e65 2047 474d 4c5f 4631 365f  define GGML_F16_
+0000aa30: 5645 435f 5345 5431 2020 2047 474d 4c5f  VEC_SET1   GGML_
+0000aa40: 4633 3278 345f 5345 5431 0a23 6465 6669  F32x4_SET1.#defi
+0000aa50: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
+0000aa60: 464d 4120 2020 2047 474d 4c5f 4633 3278  FMA    GGML_F32x
+0000aa70: 345f 464d 410a 2364 6566 696e 6520 4747  4_FMA.#define GG
+0000aa80: 4d4c 5f46 3136 5f56 4543 5f52 4544 5543  ML_F16_VEC_REDUC
+0000aa90: 4520 4747 4d4c 5f46 3332 7834 5f52 4544  E GGML_F32x4_RED
+0000aaa0: 5543 450a 2f2f 2055 7365 2076 6563 5f78  UCE.// Use vec_x
+0000aab0: 6c2c 206e 6f74 2076 6563 5f6c 642c 2069  l, not vec_ld, i
+0000aac0: 6e20 6361 7365 2074 6865 206c 6f61 6420  n case the load 
+0000aad0: 6164 6472 6573 7320 6973 206e 6f74 2061  address is not a
+0000aae0: 6c69 676e 6564 2e0a 2364 6566 696e 6520  ligned..#define 
+0000aaf0: 4747 4d4c 5f46 3136 5f56 4543 5f4c 4f41  GGML_F16_VEC_LOA
+0000ab00: 4428 702c 2069 2920 2869 2026 2030 7831  D(p, i) (i & 0x1
+0000ab10: 2920 3f20 2020 2020 2020 2020 2020 2020  ) ?             
+0000ab20: 2020 2020 2020 5c0a 2020 7665 635f 6578        \.  vec_ex
+0000ab30: 7472 6163 745f 6670 3332 5f66 726f 6d5f  tract_fp32_from_
+0000ab40: 7368 6f72 7468 2876 6563 5f78 6c28 302c  shorth(vec_xl(0,
+0000ab50: 2070 202d 2047 474d 4c5f 4631 365f 4550   p - GGML_F16_EP
+0000ab60: 5229 2920 3a20 5c0a 2020 7665 635f 6578  R)) : \.  vec_ex
+0000ab70: 7472 6163 745f 6670 3332 5f66 726f 6d5f  tract_fp32_from_
+0000ab80: 7368 6f72 746c 2876 6563 5f78 6c28 302c  shortl(vec_xl(0,
+0000ab90: 2070 2929 0a23 6465 6669 6e65 2047 474d   p)).#define GGM
+0000aba0: 4c5f 454e 4449 414e 5f42 5954 4528 6929  L_ENDIAN_BYTE(i)
+0000abb0: 2028 2875 6e73 6967 6e65 6420 6368 6172   ((unsigned char
+0000abc0: 202a 2926 2875 696e 7431 365f 7429 7b31   *)&(uint16_t){1
+0000abd0: 7d29 5b69 5d0a 2364 6566 696e 6520 4747  })[i].#define GG
+0000abe0: 4d4c 5f46 3136 5f56 4543 5f53 544f 5245  ML_F16_VEC_STORE
+0000abf0: 2870 2c20 722c 2069 2920 2020 2020 2020  (p, r, i)       
+0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac10: 2020 2020 2020 5c0a 2020 6966 2028 6920        \.  if (i 
+0000ac20: 2620 3078 3129 2020 2020 2020 2020 2020  & 0x1)          
+0000ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac50: 2020 2020 2020 2020 5c0a 2020 2020 7665          \.    ve
+0000ac60: 635f 7873 7428 7665 635f 7061 636b 5f74  c_xst(vec_pack_t
+0000ac70: 6f5f 7368 6f72 745f 6670 3332 2872 5b69  o_short_fp32(r[i
+0000ac80: 202d 2047 474d 4c5f 454e 4449 414e 5f42   - GGML_ENDIAN_B
+0000ac90: 5954 4528 3129 5d2c 2020 5c0a 2020 2020  YTE(1)],  \.    
+0000aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000acc0: 5b69 202d 2047 474d 4c5f 454e 4449 414e  [i - GGML_ENDIAN
+0000acd0: 5f42 5954 4528 3029 5d29 2c20 5c0a 2020  _BYTE(0)]), \.  
+0000ace0: 2020 2020 2020 2020 2020 302c 2070 202d            0, p -
+0000acf0: 2047 474d 4c5f 4631 365f 4550 5229 0a0a   GGML_F16_EPR)..
+0000ad00: 2365 6c69 6620 6465 6669 6e65 6428 5f5f  #elif defined(__
+0000ad10: 7761 736d 5f73 696d 6431 3238 5f5f 290a  wasm_simd128__).
+0000ad20: 0a23 6465 6669 6e65 2047 474d 4c5f 5349  .#define GGML_SI
+0000ad30: 4d44 0a0a 2f2f 2046 3332 2057 4153 4d0a  MD..// F32 WASM.
+0000ad40: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000ad50: 325f 5354 4550 2031 360a 2364 6566 696e  2_STEP 16.#defin
+0000ad60: 6520 4747 4d4c 5f46 3332 5f45 5052 2020  e GGML_F32_EPR  
+0000ad70: 340a 0a23 6465 6669 6e65 2047 474d 4c5f  4..#define GGML_
+0000ad80: 4633 3278 3420 2020 2020 2020 2020 2020  F32x4           
+0000ad90: 2020 2076 3132 385f 740a 2364 6566 696e     v128_t.#defin
+0000ada0: 6520 4747 4d4c 5f46 3332 7834 5f5a 4552  e GGML_F32x4_ZER
+0000adb0: 4f20 2020 2020 2020 2020 7761 736d 5f66  O         wasm_f
+0000adc0: 3332 7834 5f73 706c 6174 2830 2e30 6629  32x4_splat(0.0f)
+0000add0: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000ade0: 3278 345f 5345 5431 2878 2920 2020 2020  2x4_SET1(x)     
+0000adf0: 2077 6173 6d5f 6633 3278 345f 7370 6c61   wasm_f32x4_spla
+0000ae00: 7428 7829 0a23 6465 6669 6e65 2047 474d  t(x).#define GGM
+0000ae10: 4c5f 4633 3278 345f 4c4f 4144 2020 2020  L_F32x4_LOAD    
+0000ae20: 2020 2020 2077 6173 6d5f 7631 3238 5f6c       wasm_v128_l
+0000ae30: 6f61 640a 2364 6566 696e 6520 4747 4d4c  oad.#define GGML
+0000ae40: 5f46 3332 7834 5f53 544f 5245 2020 2020  _F32x4_STORE    
+0000ae50: 2020 2020 7761 736d 5f76 3132 385f 7374      wasm_v128_st
+0000ae60: 6f72 650a 2364 6566 696e 6520 4747 4d4c  ore.#define GGML
+0000ae70: 5f46 3332 7834 5f46 4d41 2861 2c20 622c  _F32x4_FMA(a, b,
+0000ae80: 2063 2920 7761 736d 5f66 3332 7834 5f61   c) wasm_f32x4_a
+0000ae90: 6464 2877 6173 6d5f 6633 3278 345f 6d75  dd(wasm_f32x4_mu
+0000aea0: 6c28 622c 2063 292c 2061 290a 2364 6566  l(b, c), a).#def
+0000aeb0: 696e 6520 4747 4d4c 5f46 3332 7834 5f41  ine GGML_F32x4_A
+0000aec0: 4444 2020 2020 2020 2020 2020 7761 736d  DD          wasm
+0000aed0: 5f66 3332 7834 5f61 6464 0a23 6465 6669  _f32x4_add.#defi
+0000aee0: 6e65 2047 474d 4c5f 4633 3278 345f 4d55  ne GGML_F32x4_MU
+0000aef0: 4c20 2020 2020 2020 2020 2077 6173 6d5f  L          wasm_
+0000af00: 6633 3278 345f 6d75 6c0a 2364 6566 696e  f32x4_mul.#defin
+0000af10: 6520 4747 4d4c 5f46 3332 7834 5f52 4544  e GGML_F32x4_RED
+0000af20: 5543 4528 7265 732c 2078 2920 2020 2020  UCE(res, x)     
+0000af30: 2020 2020 2020 2020 2020 2020 205c 0a7b               \.{
+0000af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af70: 2020 5c0a 2020 2020 666f 7220 2869 6e74    \.    for (int
+0000af80: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
+0000af90: 5f46 3332 5f41 5252 2f32 3b20 2b2b 6929  _F32_ARR/2; ++i)
+0000afa0: 207b 2020 2020 205c 0a20 2020 2020 2020   {     \.       
+0000afb0: 2078 5b32 2a69 5d20 3d20 7761 736d 5f66   x[2*i] = wasm_f
+0000afc0: 3332 7834 5f61 6464 2878 5b32 2a69 5d2c  32x4_add(x[2*i],
+0000afd0: 2078 5b32 2a69 2b31 5d29 3b20 5c0a 2020   x[2*i+1]); \.  
+0000afe0: 2020 7d20 2020 2020 2020 2020 2020 2020    }             
+0000aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b010: 205c 0a20 2020 2066 6f72 2028 696e 7420   \.    for (int 
+0000b020: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
+0000b030: 4633 325f 4152 522f 343b 202b 2b69 2920  F32_ARR/4; ++i) 
+0000b040: 7b20 2020 2020 5c0a 2020 2020 2020 2020  {     \.        
+0000b050: 785b 342a 695d 203d 2077 6173 6d5f 6633  x[4*i] = wasm_f3
+0000b060: 3278 345f 6164 6428 785b 342a 695d 2c20  2x4_add(x[4*i], 
+0000b070: 785b 342a 692b 325d 293b 205c 0a20 2020  x[4*i+2]); \.   
+0000b080: 207d 2020 2020 2020 2020 2020 2020 2020   }              
+0000b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0b0: 5c0a 2020 2020 666f 7220 2869 6e74 2069  \.    for (int i
+0000b0c0: 203d 2030 3b20 6920 3c20 4747 4d4c 5f46   = 0; i < GGML_F
+0000b0d0: 3332 5f41 5252 2f38 3b20 2b2b 6929 207b  32_ARR/8; ++i) {
+0000b0e0: 2020 2020 205c 0a20 2020 2020 2020 2078       \.        x
+0000b0f0: 5b38 2a69 5d20 3d20 7761 736d 5f66 3332  [8*i] = wasm_f32
+0000b100: 7834 5f61 6464 2878 5b38 2a69 5d2c 2078  x4_add(x[8*i], x
+0000b110: 5b38 2a69 2b34 5d29 3b20 5c0a 2020 2020  [8*i+4]); \.    
+0000b120: 7d20 2020 2020 2020 2020 2020 2020 2020  }               
+0000b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b140: 2020 2020 2020 2020 2020 2020 2020 205c                 \
+0000b150: 0a20 2020 2072 6573 203d 2077 6173 6d5f  .    res = wasm_
+0000b160: 6633 3278 345f 6578 7472 6163 745f 6c61  f32x4_extract_la
+0000b170: 6e65 2878 5b30 5d2c 2030 2920 2b20 2020  ne(x[0], 0) +   
+0000b180: 2020 2020 5c0a 2020 2020 2020 2020 2020      \.          
+0000b190: 7761 736d 5f66 3332 7834 5f65 7874 7261  wasm_f32x4_extra
+0000b1a0: 6374 5f6c 616e 6528 785b 305d 2c20 3129  ct_lane(x[0], 1)
+0000b1b0: 202b 2020 2020 2020 205c 0a20 2020 2020   +       \.     
+0000b1c0: 2020 2020 2077 6173 6d5f 6633 3278 345f       wasm_f32x4_
+0000b1d0: 6578 7472 6163 745f 6c61 6e65 2878 5b30  extract_lane(x[0
+0000b1e0: 5d2c 2032 2920 2b20 2020 2020 2020 5c0a  ], 2) +       \.
+0000b1f0: 2020 2020 2020 2020 2020 7761 736d 5f66            wasm_f
+0000b200: 3332 7834 5f65 7874 7261 6374 5f6c 616e  32x4_extract_lan
+0000b210: 6528 785b 305d 2c20 3329 3b20 2020 2020  e(x[0], 3);     
+0000b220: 2020 205c 0a7d 0a0a 2364 6566 696e 6520     \.}..#define 
+0000b230: 4747 4d4c 5f46 3332 5f56 4543 2020 2020  GGML_F32_VEC    
+0000b240: 2020 2020 4747 4d4c 5f46 3332 7834 0a23      GGML_F32x4.#
+0000b250: 6465 6669 6e65 2047 474d 4c5f 4633 325f  define GGML_F32_
+0000b260: 5645 435f 5a45 524f 2020 2047 474d 4c5f  VEC_ZERO   GGML_
+0000b270: 4633 3278 345f 5a45 524f 0a23 6465 6669  F32x4_ZERO.#defi
+0000b280: 6e65 2047 474d 4c5f 4633 325f 5645 435f  ne GGML_F32_VEC_
+0000b290: 5345 5431 2020 2047 474d 4c5f 4633 3278  SET1   GGML_F32x
+0000b2a0: 345f 5345 5431 0a23 6465 6669 6e65 2047  4_SET1.#define G
+0000b2b0: 474d 4c5f 4633 325f 5645 435f 4c4f 4144  GML_F32_VEC_LOAD
+0000b2c0: 2020 2047 474d 4c5f 4633 3278 345f 4c4f     GGML_F32x4_LO
+0000b2d0: 4144 0a23 6465 6669 6e65 2047 474d 4c5f  AD.#define GGML_
+0000b2e0: 4633 325f 5645 435f 5354 4f52 4520 2047  F32_VEC_STORE  G
+0000b2f0: 474d 4c5f 4633 3278 345f 5354 4f52 450a  GML_F32x4_STORE.
+0000b300: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
+0000b310: 5f56 4543 5f46 4d41 2020 2020 4747 4d4c  _VEC_FMA    GGML
+0000b320: 5f46 3332 7834 5f46 4d41 0a23 6465 6669  _F32x4_FMA.#defi
+0000b330: 6e65 2047 474d 4c5f 4633 325f 5645 435f  ne GGML_F32_VEC_
+0000b340: 4144 4420 2020 2047 474d 4c5f 4633 3278  ADD    GGML_F32x
+0000b350: 345f 4144 440a 2364 6566 696e 6520 4747  4_ADD.#define GG
+0000b360: 4d4c 5f46 3332 5f56 4543 5f4d 554c 2020  ML_F32_VEC_MUL  
+0000b370: 2020 4747 4d4c 5f46 3332 7834 5f4d 554c    GGML_F32x4_MUL
+0000b380: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000b390: 325f 5645 435f 5245 4455 4345 2047 474d  2_VEC_REDUCE GGM
+0000b3a0: 4c5f 4633 3278 345f 5245 4455 4345 0a0a  L_F32x4_REDUCE..
+0000b3b0: 2f2f 2046 3136 2057 4153 4d0a 0a23 6465  // F16 WASM..#de
+0000b3c0: 6669 6e65 2047 474d 4c5f 4631 365f 5354  fine GGML_F16_ST
+0000b3d0: 4550 2031 360a 2364 6566 696e 6520 4747  EP 16.#define GG
+0000b3e0: 4d4c 5f46 3136 5f45 5052 2020 340a 0a69  ML_F16_EPR  4..i
+0000b3f0: 6e6c 696e 6520 7374 6174 6963 2076 3132  nline static v12
+0000b400: 385f 7420 5f5f 7761 736d 5f66 3136 7834  8_t __wasm_f16x4
+0000b410: 5f6c 6f61 6428 636f 6e73 7420 6767 6d6c  _load(const ggml
+0000b420: 5f66 7031 365f 7420 2a20 7029 207b 0a20  _fp16_t * p) {. 
+0000b430: 2020 2066 6c6f 6174 2074 6d70 5b34 5d3b     float tmp[4];
+0000b440: 0a0a 2020 2020 746d 705b 305d 203d 2047  ..    tmp[0] = G
+0000b450: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+0000b460: 2870 5b30 5d29 3b0a 2020 2020 746d 705b  (p[0]);.    tmp[
+0000b470: 315d 203d 2047 474d 4c5f 4650 3136 5f54  1] = GGML_FP16_T
+0000b480: 4f5f 4650 3332 2870 5b31 5d29 3b0a 2020  O_FP32(p[1]);.  
+0000b490: 2020 746d 705b 325d 203d 2047 474d 4c5f    tmp[2] = GGML_
+0000b4a0: 4650 3136 5f54 4f5f 4650 3332 2870 5b32  FP16_TO_FP32(p[2
+0000b4b0: 5d29 3b0a 2020 2020 746d 705b 335d 203d  ]);.    tmp[3] =
+0000b4c0: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
+0000b4d0: 3332 2870 5b33 5d29 3b0a 0a20 2020 2072  32(p[3]);..    r
+0000b4e0: 6574 7572 6e20 7761 736d 5f76 3132 385f  eturn wasm_v128_
+0000b4f0: 6c6f 6164 2874 6d70 293b 0a7d 0a0a 696e  load(tmp);.}..in
+0000b500: 6c69 6e65 2073 7461 7469 6320 766f 6964  line static void
+0000b510: 205f 5f77 6173 6d5f 6631 3678 345f 7374   __wasm_f16x4_st
+0000b520: 6f72 6528 6767 6d6c 5f66 7031 365f 7420  ore(ggml_fp16_t 
+0000b530: 2a20 702c 2076 3132 385f 7420 7829 207b  * p, v128_t x) {
+0000b540: 0a20 2020 2066 6c6f 6174 2074 6d70 5b34  .    float tmp[4
+0000b550: 5d3b 0a0a 2020 2020 7761 736d 5f76 3132  ];..    wasm_v12
+0000b560: 385f 7374 6f72 6528 746d 702c 2078 293b  8_store(tmp, x);
+0000b570: 0a0a 2020 2020 705b 305d 203d 2047 474d  ..    p[0] = GGM
+0000b580: 4c5f 4650 3332 5f54 4f5f 4650 3136 2874  L_FP32_TO_FP16(t
+0000b590: 6d70 5b30 5d29 3b0a 2020 2020 705b 315d  mp[0]);.    p[1]
+0000b5a0: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
+0000b5b0: 4650 3136 2874 6d70 5b31 5d29 3b0a 2020  FP16(tmp[1]);.  
+0000b5c0: 2020 705b 325d 203d 2047 474d 4c5f 4650    p[2] = GGML_FP
+0000b5d0: 3332 5f54 4f5f 4650 3136 2874 6d70 5b32  32_TO_FP16(tmp[2
+0000b5e0: 5d29 3b0a 2020 2020 705b 335d 203d 2047  ]);.    p[3] = G
+0000b5f0: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+0000b600: 2874 6d70 5b33 5d29 3b0a 7d0a 0a23 6465  (tmp[3]);.}..#de
+0000b610: 6669 6e65 2047 474d 4c5f 4631 3678 3420  fine GGML_F16x4 
+0000b620: 2020 2020 2020 2020 2020 2020 7631 3238              v128
+0000b630: 5f74 0a23 6465 6669 6e65 2047 474d 4c5f  _t.#define GGML_
+0000b640: 4631 3678 345f 5a45 524f 2020 2020 2020  F16x4_ZERO      
+0000b650: 2020 7761 736d 5f66 3332 7834 5f73 706c    wasm_f32x4_spl
+0000b660: 6174 2830 2e30 6629 0a23 6465 6669 6e65  at(0.0f).#define
+0000b670: 2047 474d 4c5f 4631 3678 345f 5345 5431   GGML_F16x4_SET1
+0000b680: 2878 2920 2020 2020 7761 736d 5f66 3332  (x)     wasm_f32
+0000b690: 7834 5f73 706c 6174 2878 290a 2364 6566  x4_splat(x).#def
+0000b6a0: 696e 6520 4747 4d4c 5f46 3136 7834 5f4c  ine GGML_F16x4_L
+0000b6b0: 4f41 4428 7829 2020 2020 205f 5f77 6173  OAD(x)     __was
+0000b6c0: 6d5f 6631 3678 345f 6c6f 6164 2878 290a  m_f16x4_load(x).
+0000b6d0: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
+0000b6e0: 7834 5f53 544f 5245 2878 2c20 7929 205f  x4_STORE(x, y) _
+0000b6f0: 5f77 6173 6d5f 6631 3678 345f 7374 6f72  _wasm_f16x4_stor
+0000b700: 6528 782c 2079 290a 2364 6566 696e 6520  e(x, y).#define 
+0000b710: 4747 4d4c 5f46 3136 7834 5f46 4d41 2020  GGML_F16x4_FMA  
+0000b720: 2020 2020 2020 2047 474d 4c5f 4633 3278         GGML_F32x
+0000b730: 345f 464d 410a 2364 6566 696e 6520 4747  4_FMA.#define GG
+0000b740: 4d4c 5f46 3136 7834 5f41 4444 2020 2020  ML_F16x4_ADD    
+0000b750: 2020 2020 2077 6173 6d5f 6633 3278 345f       wasm_f32x4_
+0000b760: 6164 640a 2364 6566 696e 6520 4747 4d4c  add.#define GGML
+0000b770: 5f46 3136 7834 5f4d 554c 2020 2020 2020  _F16x4_MUL      
+0000b780: 2020 2077 6173 6d5f 6633 3278 345f 6d75     wasm_f32x4_mu
+0000b790: 6c0a 2364 6566 696e 6520 4747 4d4c 5f46  l.#define GGML_F
+0000b7a0: 3136 7834 5f52 4544 5543 4528 7265 732c  16x4_REDUCE(res,
+0000b7b0: 2078 2920 2020 2020 2020 2020 2020 2020   x)             
+0000b7c0: 2020 2020 205c 0a7b 2020 2020 2020 2020       \.{        
+0000b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7f0: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+0000b800: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0000b810: 6920 3c20 4747 4d4c 5f46 3136 5f41 5252  i < GGML_F16_ARR
+0000b820: 2f32 3b20 2b2b 6929 207b 2020 2020 205c  /2; ++i) {     \
+0000b830: 0a20 2020 2020 2020 2078 5b32 2a69 5d20  .        x[2*i] 
+0000b840: 3d20 7761 736d 5f66 3332 7834 5f61 6464  = wasm_f32x4_add
+0000b850: 2878 5b32 2a69 5d2c 2078 5b32 2a69 2b31  (x[2*i], x[2*i+1
+0000b860: 5d29 3b20 5c0a 2020 2020 7d20 2020 2020  ]); \.    }     
+0000b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b890: 2020 2020 2020 2020 205c 0a20 2020 2066           \.    f
+0000b8a0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0000b8b0: 203c 2047 474d 4c5f 4631 365f 4152 522f   < GGML_F16_ARR/
+0000b8c0: 343b 202b 2b69 2920 7b20 2020 2020 5c0a  4; ++i) {     \.
+0000b8d0: 2020 2020 2020 2020 785b 342a 695d 203d          x[4*i] =
+0000b8e0: 2077 6173 6d5f 6633 3278 345f 6164 6428   wasm_f32x4_add(
+0000b8f0: 785b 342a 695d 2c20 785b 342a 692b 325d  x[4*i], x[4*i+2]
+0000b900: 293b 205c 0a20 2020 207d 2020 2020 2020  ); \.    }      
+0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b930: 2020 2020 2020 2020 5c0a 2020 2020 666f          \.    fo
+0000b940: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0000b950: 3c20 4747 4d4c 5f46 3136 5f41 5252 2f38  < GGML_F16_ARR/8
+0000b960: 3b20 2b2b 6929 207b 2020 2020 205c 0a20  ; ++i) {     \. 
+0000b970: 2020 2020 2020 2078 5b38 2a69 5d20 3d20         x[8*i] = 
+0000b980: 7761 736d 5f66 3332 7834 5f61 6464 2878  wasm_f32x4_add(x
+0000b990: 5b38 2a69 5d2c 2078 5b38 2a69 2b34 5d29  [8*i], x[8*i+4])
+0000b9a0: 3b20 5c0a 2020 2020 7d20 2020 2020 2020  ; \.    }       
+0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9d0: 2020 2020 2020 205c 0a20 2020 2072 6573         \.    res
+0000b9e0: 203d 2077 6173 6d5f 6633 3278 345f 6578   = wasm_f32x4_ex
+0000b9f0: 7472 6163 745f 6c61 6e65 2878 5b30 5d2c  tract_lane(x[0],
+0000ba00: 2030 2920 2b20 2020 2020 2020 5c0a 2020   0) +       \.  
+0000ba10: 2020 2020 2020 2020 7761 736d 5f66 3332          wasm_f32
+0000ba20: 7834 5f65 7874 7261 6374 5f6c 616e 6528  x4_extract_lane(
+0000ba30: 785b 305d 2c20 3129 202b 2020 2020 2020  x[0], 1) +      
+0000ba40: 205c 0a20 2020 2020 2020 2020 2077 6173   \.          was
+0000ba50: 6d5f 6633 3278 345f 6578 7472 6163 745f  m_f32x4_extract_
+0000ba60: 6c61 6e65 2878 5b30 5d2c 2032 2920 2b20  lane(x[0], 2) + 
+0000ba70: 2020 2020 2020 5c0a 2020 2020 2020 2020        \.        
+0000ba80: 2020 7761 736d 5f66 3332 7834 5f65 7874    wasm_f32x4_ext
+0000ba90: 7261 6374 5f6c 616e 6528 785b 305d 2c20  ract_lane(x[0], 
+0000baa0: 3329 3b20 2020 2020 2020 205c 0a7d 0a0a  3);        \.}..
+0000bab0: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
+0000bac0: 5f56 4543 2020 2020 2020 2020 2020 2020  _VEC            
+0000bad0: 2020 2020 4747 4d4c 5f46 3136 7834 0a23      GGML_F16x4.#
+0000bae0: 6465 6669 6e65 2047 474d 4c5f 4631 365f  define GGML_F16_
+0000baf0: 5645 435f 5a45 524f 2020 2020 2020 2020  VEC_ZERO        
+0000bb00: 2020 2047 474d 4c5f 4631 3678 345f 5a45     GGML_F16x4_ZE
+0000bb10: 524f 0a23 6465 6669 6e65 2047 474d 4c5f  RO.#define GGML_
+0000bb20: 4631 365f 5645 435f 5345 5431 2020 2020  F16_VEC_SET1    
+0000bb30: 2020 2020 2020 2047 474d 4c5f 4631 3678         GGML_F16x
+0000bb40: 345f 5345 5431 0a23 6465 6669 6e65 2047  4_SET1.#define G
+0000bb50: 474d 4c5f 4631 365f 5645 435f 4c4f 4144  GML_F16_VEC_LOAD
+0000bb60: 2870 2c20 6929 2020 2020 2047 474d 4c5f  (p, i)     GGML_
+0000bb70: 4631 3678 345f 4c4f 4144 2870 290a 2364  F16x4_LOAD(p).#d
+0000bb80: 6566 696e 6520 4747 4d4c 5f46 3136 5f56  efine GGML_F16_V
+0000bb90: 4543 5f53 544f 5245 2870 2c20 722c 2069  EC_STORE(p, r, i
+0000bba0: 2920 4747 4d4c 5f46 3136 7834 5f53 544f  ) GGML_F16x4_STO
+0000bbb0: 5245 2870 2c20 725b 695d 290a 2364 6566  RE(p, r[i]).#def
+0000bbc0: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
+0000bbd0: 5f46 4d41 2020 2020 2020 2020 2020 2020  _FMA            
+0000bbe0: 4747 4d4c 5f46 3136 7834 5f46 4d41 0a23  GGML_F16x4_FMA.#
+0000bbf0: 6465 6669 6e65 2047 474d 4c5f 4631 365f  define GGML_F16_
+0000bc00: 5645 435f 4144 4420 2020 2020 2020 2020  VEC_ADD         
+0000bc10: 2020 2047 474d 4c5f 4631 3678 345f 4144     GGML_F16x4_AD
+0000bc20: 440a 2364 6566 696e 6520 4747 4d4c 5f46  D.#define GGML_F
+0000bc30: 3136 5f56 4543 5f4d 554c 2020 2020 2020  16_VEC_MUL      
+0000bc40: 2020 2020 2020 4747 4d4c 5f46 3136 7834        GGML_F16x4
+0000bc50: 5f4d 554c 0a23 6465 6669 6e65 2047 474d  _MUL.#define GGM
+0000bc60: 4c5f 4631 365f 5645 435f 5245 4455 4345  L_F16_VEC_REDUCE
+0000bc70: 2020 2020 2020 2020 2047 474d 4c5f 4631           GGML_F1
+0000bc80: 3678 345f 5245 4455 4345 0a0a 2365 6c69  6x4_REDUCE..#eli
+0000bc90: 6620 6465 6669 6e65 6428 5f5f 5353 4533  f defined(__SSE3
+0000bca0: 5f5f 290a 0a23 6465 6669 6e65 2047 474d  __)..#define GGM
+0000bcb0: 4c5f 5349 4d44 0a0a 2f2f 2046 3332 2053  L_SIMD..// F32 S
+0000bcc0: 5345 0a0a 2364 6566 696e 6520 4747 4d4c  SE..#define GGML
+0000bcd0: 5f46 3332 5f53 5445 5020 3332 0a23 6465  _F32_STEP 32.#de
+0000bce0: 6669 6e65 2047 474d 4c5f 4633 325f 4550  fine GGML_F32_EP
+0000bcf0: 5220 2034 0a0a 2364 6566 696e 6520 4747  R  4..#define GG
+0000bd00: 4d4c 5f46 3332 7834 2020 2020 2020 2020  ML_F32x4        
+0000bd10: 205f 5f6d 3132 380a 2364 6566 696e 6520   __m128.#define 
+0000bd20: 4747 4d4c 5f46 3332 7834 5f5a 4552 4f20  GGML_F32x4_ZERO 
+0000bd30: 2020 205f 6d6d 5f73 6574 7a65 726f 5f70     _mm_setzero_p
+0000bd40: 7328 290a 2364 6566 696e 6520 4747 4d4c  s().#define GGML
+0000bd50: 5f46 3332 7834 5f53 4554 3128 7829 205f  _F32x4_SET1(x) _
+0000bd60: 6d6d 5f73 6574 315f 7073 2878 290a 2364  mm_set1_ps(x).#d
+0000bd70: 6566 696e 6520 4747 4d4c 5f46 3332 7834  efine GGML_F32x4
+0000bd80: 5f4c 4f41 4420 2020 205f 6d6d 5f6c 6f61  _LOAD    _mm_loa
+0000bd90: 6475 5f70 730a 2364 6566 696e 6520 4747  du_ps.#define GG
+0000bda0: 4d4c 5f46 3332 7834 5f53 544f 5245 2020  ML_F32x4_STORE  
+0000bdb0: 205f 6d6d 5f73 746f 7265 755f 7073 0a23   _mm_storeu_ps.#
+0000bdc0: 6966 2064 6566 696e 6564 285f 5f46 4d41  if defined(__FMA
+0000bdd0: 5f5f 290a 2020 2020 2f2f 2054 4f44 4f3a  __).    // TODO:
+0000bde0: 2044 6f65 7320 7468 6973 2077 6f72 6b3f   Does this work?
+0000bdf0: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
+0000be00: 4c5f 4633 3278 345f 464d 4128 612c 2062  L_F32x4_FMA(a, b
+0000be10: 2c20 6329 205f 6d6d 5f66 6d61 6464 5f70  , c) _mm_fmadd_p
+0000be20: 7328 622c 2063 2c20 6129 0a23 656c 7365  s(b, c, a).#else
+0000be30: 0a20 2020 2023 6465 6669 6e65 2047 474d  .    #define GGM
+0000be40: 4c5f 4633 3278 345f 464d 4128 612c 2062  L_F32x4_FMA(a, b
+0000be50: 2c20 6329 205f 6d6d 5f61 6464 5f70 7328  , c) _mm_add_ps(
+0000be60: 5f6d 6d5f 6d75 6c5f 7073 2862 2c20 6329  _mm_mul_ps(b, c)
+0000be70: 2c20 6129 0a23 656e 6469 660a 2364 6566  , a).#endif.#def
+0000be80: 696e 6520 4747 4d4c 5f46 3332 7834 5f41  ine GGML_F32x4_A
+0000be90: 4444 2020 2020 205f 6d6d 5f61 6464 5f70  DD     _mm_add_p
+0000bea0: 730a 2364 6566 696e 6520 4747 4d4c 5f46  s.#define GGML_F
+0000beb0: 3332 7834 5f4d 554c 2020 2020 205f 6d6d  32x4_MUL     _mm
+0000bec0: 5f6d 756c 5f70 730a 2364 6566 696e 6520  _mul_ps.#define 
+0000bed0: 4747 4d4c 5f46 3332 7834 5f52 4544 5543  GGML_F32x4_REDUC
+0000bee0: 4528 7265 732c 2078 2920 2020 2020 2020  E(res, x)       
+0000bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf00: 2020 2020 2020 2020 2020 5c0a 7b20 2020            \.{   
+0000bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf40: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+0000bf50: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0000bf60: 2030 3b20 6920 3c20 4747 4d4c 5f46 3332   0; i < GGML_F32
+0000bf70: 5f41 5252 2f32 3b20 2b2b 6929 207b 2020  _ARR/2; ++i) {  
+0000bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf90: 2020 5c0a 2020 2020 2020 2020 785b 322a    \.        x[2*
+0000bfa0: 695d 203d 205f 6d6d 5f61 6464 5f70 7328  i] = _mm_add_ps(
+0000bfb0: 785b 322a 695d 2c20 785b 322a 692b 315d  x[2*i], x[2*i+1]
+0000bfc0: 293b 2020 2020 2020 2020 2020 2020 2020  );              
+0000bfd0: 2020 2020 2020 5c0a 2020 2020 7d20 2020        \.    }   
+0000bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c010: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+0000c020: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0000c030: 6920 3c20 4747 4d4c 5f46 3332 5f41 5252  i < GGML_F32_ARR
+0000c040: 2f34 3b20 2b2b 6929 207b 2020 2020 2020  /4; ++i) {      
+0000c050: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+0000c060: 2020 2020 2020 2020 785b 342a 695d 203d          x[4*i] =
+0000c070: 205f 6d6d 5f61 6464 5f70 7328 785b 342a   _mm_add_ps(x[4*
+0000c080: 695d 2c20 785b 342a 692b 325d 293b 2020  i], x[4*i+2]);  
+0000c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0a0: 2020 5c0a 2020 2020 7d20 2020 2020 2020    \.    }       
+0000c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0e0: 2020 2020 2020 5c0a 2020 2020 666f 7220        \.    for 
+0000c0f0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+0000c100: 4747 4d4c 5f46 3332 5f41 5252 2f38 3b20  GGML_F32_ARR/8; 
+0000c110: 2b2b 6929 207b 2020 2020 2020 2020 2020  ++i) {          
+0000c120: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
+0000c130: 2020 2020 785b 382a 695d 203d 205f 6d6d      x[8*i] = _mm
+0000c140: 5f61 6464 5f70 7328 785b 382a 695d 2c20  _add_ps(x[8*i], 
+0000c150: 785b 382a 692b 345d 293b 2020 2020 2020  x[8*i+4]);      
+0000c160: 2020 2020 2020 2020 2020 2020 2020 5c0a                \.
+0000c170: 2020 2020 7d20 2020 2020 2020 2020 2020      }           
+0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1b0: 2020 5c0a 2020 2020 636f 6e73 7420 5f5f    \.    const __
+0000c1c0: 6d31 3238 2074 3020 3d20 5f6d 6d5f 6861  m128 t0 = _mm_ha
+0000c1d0: 6464 5f70 7328 785b 305d 2c20 785b 305d  dd_ps(x[0], x[0]
+0000c1e0: 293b 2020 2020 2020 2020 2020 2020 2020  );              
+0000c1f0: 2020 2020 2020 5c0a 2020 2020 7265 7320        \.    res 
+0000c200: 3d20 5f6d 6d5f 6376 7473 735f 6633 3228  = _mm_cvtss_f32(
+0000c210: 5f6d 6d5f 6861 6464 5f70 7328 7430 2c20  _mm_hadd_ps(t0, 
+0000c220: 7430 2929 3b20 2020 2020 2020 2020 2020  t0));           
+0000c230: 2020 2020 2020 2020 2020 5c0a 7d0a 2f2f            \.}.//
+0000c240: 2054 4f44 4f3a 2069 7320 7468 6973 206f   TODO: is this o
+0000c250: 7074 696d 616c 203f 0a0a 2364 6566 696e  ptimal ?..#defin
+0000c260: 6520 4747 4d4c 5f46 3332 5f56 4543 2020  e GGML_F32_VEC  
+0000c270: 2020 2020 2020 4747 4d4c 5f46 3332 7834        GGML_F32x4
+0000c280: 0a23 6465 6669 6e65 2047 474d 4c5f 4633  .#define GGML_F3
+0000c290: 325f 5645 435f 5a45 524f 2020 2047 474d  2_VEC_ZERO   GGM
+0000c2a0: 4c5f 4633 3278 345f 5a45 524f 0a23 6465  L_F32x4_ZERO.#de
+0000c2b0: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
+0000c2c0: 435f 5345 5431 2020 2047 474d 4c5f 4633  C_SET1   GGML_F3
+0000c2d0: 3278 345f 5345 5431 0a23 6465 6669 6e65  2x4_SET1.#define
+0000c2e0: 2047 474d 4c5f 4633 325f 5645 435f 4c4f   GGML_F32_VEC_LO
+0000c2f0: 4144 2020 2047 474d 4c5f 4633 3278 345f  AD   GGML_F32x4_
+0000c300: 4c4f 4144 0a23 6465 6669 6e65 2047 474d  LOAD.#define GGM
+0000c310: 4c5f 4633 325f 5645 435f 5354 4f52 4520  L_F32_VEC_STORE 
+0000c320: 2047 474d 4c5f 4633 3278 345f 5354 4f52   GGML_F32x4_STOR
+0000c330: 450a 2364 6566 696e 6520 4747 4d4c 5f46  E.#define GGML_F
+0000c340: 3332 5f56 4543 5f46 4d41 2020 2020 4747  32_VEC_FMA    GG
+0000c350: 4d4c 5f46 3332 7834 5f46 4d41 0a23 6465  ML_F32x4_FMA.#de
+0000c360: 6669 6e65 2047 474d 4c5f 4633 325f 5645  fine GGML_F32_VE
+0000c370: 435f 4144 4420 2020 2047 474d 4c5f 4633  C_ADD    GGML_F3
+0000c380: 3278 345f 4144 440a 2364 6566 696e 6520  2x4_ADD.#define 
+0000c390: 4747 4d4c 5f46 3332 5f56 4543 5f4d 554c  GGML_F32_VEC_MUL
+0000c3a0: 2020 2020 4747 4d4c 5f46 3332 7834 5f4d      GGML_F32x4_M
+0000c3b0: 554c 0a23 6465 6669 6e65 2047 474d 4c5f  UL.#define GGML_
+0000c3c0: 4633 325f 5645 435f 5245 4455 4345 2047  F32_VEC_REDUCE G
+0000c3d0: 474d 4c5f 4633 3278 345f 5245 4455 4345  GML_F32x4_REDUCE
+0000c3e0: 0a0a 2f2f 2046 3136 2053 5345 0a0a 2364  ..// F16 SSE..#d
+0000c3f0: 6566 696e 6520 4747 4d4c 5f46 3136 5f53  efine GGML_F16_S
+0000c400: 5445 5020 3332 0a23 6465 6669 6e65 2047  TEP 32.#define G
+0000c410: 474d 4c5f 4631 365f 4550 5220 2034 0a0a  GML_F16_EPR  4..
+0000c420: 7374 6174 6963 2069 6e6c 696e 6520 5f5f  static inline __
+0000c430: 6d31 3238 205f 5f73 7365 5f66 3136 7834  m128 __sse_f16x4
+0000c440: 5f6c 6f61 6428 6767 6d6c 5f66 7031 365f  _load(ggml_fp16_
+0000c450: 7420 2a78 2920 7b0a 2020 2020 666c 6f61  t *x) {.    floa
+0000c460: 7420 746d 705b 345d 3b0a 0a20 2020 2074  t tmp[4];..    t
+0000c470: 6d70 5b30 5d20 3d20 4747 4d4c 5f46 5031  mp[0] = GGML_FP1
+0000c480: 365f 544f 5f46 5033 3228 785b 305d 293b  6_TO_FP32(x[0]);
+0000c490: 0a20 2020 2074 6d70 5b31 5d20 3d20 4747  .    tmp[1] = GG
+0000c4a0: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+0000c4b0: 785b 315d 293b 0a20 2020 2074 6d70 5b32  x[1]);.    tmp[2
+0000c4c0: 5d20 3d20 4747 4d4c 5f46 5031 365f 544f  ] = GGML_FP16_TO
+0000c4d0: 5f46 5033 3228 785b 325d 293b 0a20 2020  _FP32(x[2]);.   
+0000c4e0: 2074 6d70 5b33 5d20 3d20 4747 4d4c 5f46   tmp[3] = GGML_F
+0000c4f0: 5031 365f 544f 5f46 5033 3228 785b 335d  P16_TO_FP32(x[3]
+0000c500: 293b 0a0a 2020 2020 7265 7475 726e 205f  );..    return _
+0000c510: 6d6d 5f6c 6f61 6475 5f70 7328 746d 7029  mm_loadu_ps(tmp)
+0000c520: 3b0a 7d0a 0a73 7461 7469 6320 696e 6c69  ;.}..static inli
+0000c530: 6e65 2076 6f69 6420 5f5f 7373 655f 6631  ne void __sse_f1
+0000c540: 3678 345f 7374 6f72 6528 6767 6d6c 5f66  6x4_store(ggml_f
+0000c550: 7031 365f 7420 2a78 2c20 5f5f 6d31 3238  p16_t *x, __m128
+0000c560: 2079 2920 7b0a 2020 2020 666c 6f61 7420   y) {.    float 
+0000c570: 6172 725b 345d 3b0a 0a20 2020 205f 6d6d  arr[4];..    _mm
+0000c580: 5f73 746f 7265 755f 7073 2861 7272 2c20  _storeu_ps(arr, 
+0000c590: 7929 3b0a 0a20 2020 2078 5b30 5d20 3d20  y);..    x[0] = 
+0000c5a0: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
+0000c5b0: 3628 6172 725b 305d 293b 0a20 2020 2078  6(arr[0]);.    x
+0000c5c0: 5b31 5d20 3d20 4747 4d4c 5f46 5033 325f  [1] = GGML_FP32_
+0000c5d0: 544f 5f46 5031 3628 6172 725b 315d 293b  TO_FP16(arr[1]);
+0000c5e0: 0a20 2020 2078 5b32 5d20 3d20 4747 4d4c  .    x[2] = GGML
+0000c5f0: 5f46 5033 325f 544f 5f46 5031 3628 6172  _FP32_TO_FP16(ar
+0000c600: 725b 325d 293b 0a20 2020 2078 5b33 5d20  r[2]);.    x[3] 
+0000c610: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+0000c620: 5031 3628 6172 725b 335d 293b 0a7d 0a0a  P16(arr[3]);.}..
+0000c630: 2364 6566 696e 6520 4747 4d4c 5f46 3332  #define GGML_F32
+0000c640: 4378 3420 2020 2020 2020 2020 2020 2020  Cx4             
+0000c650: 5f5f 6d31 3238 0a23 6465 6669 6e65 2047  __m128.#define G
+0000c660: 474d 4c5f 4633 3243 7834 5f5a 4552 4f20  GML_F32Cx4_ZERO 
+0000c670: 2020 2020 2020 205f 6d6d 5f73 6574 7a65         _mm_setze
+0000c680: 726f 5f70 7328 290a 2364 6566 696e 6520  ro_ps().#define 
+0000c690: 4747 4d4c 5f46 3332 4378 345f 5345 5431  GGML_F32Cx4_SET1
+0000c6a0: 2878 2920 2020 2020 5f6d 6d5f 7365 7431  (x)     _mm_set1
+0000c6b0: 5f70 7328 7829 0a23 6465 6669 6e65 2047  _ps(x).#define G
+0000c6c0: 474d 4c5f 4633 3243 7834 5f4c 4f41 4428  GML_F32Cx4_LOAD(
+0000c6d0: 7829 2020 2020 205f 5f73 7365 5f66 3136  x)     __sse_f16
+0000c6e0: 7834 5f6c 6f61 6428 7829 0a23 6465 6669  x4_load(x).#defi
+0000c6f0: 6e65 2047 474d 4c5f 4633 3243 7834 5f53  ne GGML_F32Cx4_S
+0000c700: 544f 5245 2878 2c20 7929 205f 5f73 7365  TORE(x, y) __sse
+0000c710: 5f66 3136 7834 5f73 746f 7265 2878 2c20  _f16x4_store(x, 
+0000c720: 7929 0a23 6465 6669 6e65 2047 474d 4c5f  y).#define GGML_
+0000c730: 4633 3243 7834 5f46 4d41 2020 2020 2020  F32Cx4_FMA      
+0000c740: 2020 2047 474d 4c5f 4633 3278 345f 464d     GGML_F32x4_FM
+0000c750: 410a 2364 6566 696e 6520 4747 4d4c 5f46  A.#define GGML_F
+0000c760: 3332 4378 345f 4144 4420 2020 2020 2020  32Cx4_ADD       
+0000c770: 2020 5f6d 6d5f 6164 645f 7073 0a23 6465    _mm_add_ps.#de
+0000c780: 6669 6e65 2047 474d 4c5f 4633 3243 7834  fine GGML_F32Cx4
+0000c790: 5f4d 554c 2020 2020 2020 2020 205f 6d6d  _MUL         _mm
+0000c7a0: 5f6d 756c 5f70 730a 2364 6566 696e 6520  _mul_ps.#define 
+0000c7b0: 4747 4d4c 5f46 3332 4378 345f 5245 4455  GGML_F32Cx4_REDU
+0000c7c0: 4345 2020 2020 2020 4747 4d4c 5f46 3332  CE      GGML_F32
+0000c7d0: 7834 5f52 4544 5543 450a 0a23 6465 6669  x4_REDUCE..#defi
+0000c7e0: 6e65 2047 474d 4c5f 4631 365f 5645 4320  ne GGML_F16_VEC 
+0000c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c800: 4747 4d4c 5f46 3332 4378 340a 2364 6566  GGML_F32Cx4.#def
+0000c810: 696e 6520 4747 4d4c 5f46 3136 5f56 4543  ine GGML_F16_VEC
+0000c820: 5f5a 4552 4f20 2020 2020 2020 2020 2020  _ZERO           
+0000c830: 2047 474d 4c5f 4633 3243 7834 5f5a 4552   GGML_F32Cx4_ZER
+0000c840: 4f0a 2364 6566 696e 6520 4747 4d4c 5f46  O.#define GGML_F
+0000c850: 3136 5f56 4543 5f53 4554 3120 2020 2020  16_VEC_SET1     
+0000c860: 2020 2020 2020 2047 474d 4c5f 4633 3243         GGML_F32C
+0000c870: 7834 5f53 4554 310a 2364 6566 696e 6520  x4_SET1.#define 
+0000c880: 4747 4d4c 5f46 3136 5f56 4543 5f4c 4f41  GGML_F16_VEC_LOA
+0000c890: 4428 702c 2069 2920 2020 2020 2047 474d  D(p, i)      GGM
+0000c8a0: 4c5f 4633 3243 7834 5f4c 4f41 4428 7029  L_F32Cx4_LOAD(p)
+0000c8b0: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
+0000c8c0: 365f 5645 435f 5354 4f52 4528 702c 2072  6_VEC_STORE(p, r
+0000c8d0: 2c20 6929 2020 4747 4d4c 5f46 3332 4378  , i)  GGML_F32Cx
+0000c8e0: 345f 5354 4f52 4528 702c 2072 5b69 5d29  4_STORE(p, r[i])
+0000c8f0: 0a23 6465 6669 6e65 2047 474d 4c5f 4631  .#define GGML_F1
+0000c900: 365f 5645 435f 464d 4120 2020 2020 2020  6_VEC_FMA       
+0000c910: 2020 2020 2020 4747 4d4c 5f46 3332 4378        GGML_F32Cx
+0000c920: 345f 464d 410a 2364 6566 696e 6520 4747  4_FMA.#define GG
+0000c930: 4d4c 5f46 3136 5f56 4543 5f41 4444 2020  ML_F16_VEC_ADD  
+0000c940: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0000c950: 4633 3243 7834 5f41 4444 0a23 6465 6669  F32Cx4_ADD.#defi
+0000c960: 6e65 2047 474d 4c5f 4631 365f 5645 435f  ne GGML_F16_VEC_
+0000c970: 4d55 4c20 2020 2020 2020 2020 2020 2020  MUL             
+0000c980: 4747 4d4c 5f46 3332 4378 345f 4d55 4c0a  GGML_F32Cx4_MUL.
+0000c990: 2364 6566 696e 6520 4747 4d4c 5f46 3136  #define GGML_F16
+0000c9a0: 5f56 4543 5f52 4544 5543 4520 2020 2020  _VEC_REDUCE     
+0000c9b0: 2020 2020 2047 474d 4c5f 4633 3243 7834       GGML_F32Cx4
+0000c9c0: 5f52 4544 5543 450a 0a23 656e 6469 660a  _REDUCE..#endif.
+0000c9d0: 0a2f 2f20 4747 4d4c 5f46 3332 5f41 5252  .// GGML_F32_ARR
+0000c9e0: 202f 2047 474d 4c5f 4631 365f 4152 520a   / GGML_F16_ARR.
+0000c9f0: 2f2f 2020 206e 756d 6265 7220 6f66 2072  //   number of r
+0000ca00: 6567 6973 7465 7273 2074 6f20 7573 6520  egisters to use 
+0000ca10: 7065 7220 7374 6570 0a23 6966 6465 6620  per step.#ifdef 
+0000ca20: 4747 4d4c 5f53 494d 440a 2364 6566 696e  GGML_SIMD.#defin
+0000ca30: 6520 4747 4d4c 5f46 3332 5f41 5252 2028  e GGML_F32_ARR (
+0000ca40: 4747 4d4c 5f46 3332 5f53 5445 502f 4747  GGML_F32_STEP/GG
+0000ca50: 4d4c 5f46 3332 5f45 5052 290a 2364 6566  ML_F32_EPR).#def
+0000ca60: 696e 6520 4747 4d4c 5f46 3136 5f41 5252  ine GGML_F16_ARR
+0000ca70: 2028 4747 4d4c 5f46 3136 5f53 5445 502f   (GGML_F16_STEP/
+0000ca80: 4747 4d4c 5f46 3136 5f45 5052 290a 2365  GGML_F16_EPR).#e
+0000ca90: 6e64 6966 0a0a 2f2f 0a2f 2f20 6675 6e64  ndif..//.// fund
+0000caa0: 616d 656e 7461 6c20 6f70 6572 6174 696f  amental operatio
+0000cab0: 6e73 0a2f 2f0a 0a69 6e6c 696e 6520 7374  ns.//..inline st
+0000cac0: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
+0000cad0: 6563 5f73 6574 5f69 3828 636f 6e73 7420  ec_set_i8(const 
+0000cae0: 696e 7420 6e2c 2069 6e74 385f 7420 2a20  int n, int8_t * 
+0000caf0: 782c 2063 6f6e 7374 2069 6e74 385f 7420  x, const int8_t 
+0000cb00: 7629 207b 2066 6f72 2028 696e 7420 6920  v) { for (int i 
+0000cb10: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
+0000cb20: 2078 5b69 5d20 3d20 763b 207d 0a0a 696e   x[i] = v; }..in
+0000cb30: 6c69 6e65 2073 7461 7469 6320 766f 6964  line static void
+0000cb40: 2067 676d 6c5f 7665 635f 7365 745f 6931   ggml_vec_set_i1
+0000cb50: 3628 636f 6e73 7420 696e 7420 6e2c 2069  6(const int n, i
+0000cb60: 6e74 3136 5f74 202a 2078 2c20 636f 6e73  nt16_t * x, cons
+0000cb70: 7420 696e 7431 365f 7420 7629 207b 2066  t int16_t v) { f
+0000cb80: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0000cb90: 203c 206e 3b20 2b2b 6929 2078 5b69 5d20   < n; ++i) x[i] 
+0000cba0: 3d20 763b 207d 0a0a 696e 6c69 6e65 2073  = v; }..inline s
+0000cbb0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0000cbc0: 7665 635f 7365 745f 6933 3228 636f 6e73  vec_set_i32(cons
+0000cbd0: 7420 696e 7420 6e2c 2069 6e74 3332 5f74  t int n, int32_t
+0000cbe0: 202a 2078 2c20 636f 6e73 7420 696e 7433   * x, const int3
+0000cbf0: 325f 7420 7629 207b 2066 6f72 2028 696e  2_t v) { for (in
+0000cc00: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
+0000cc10: 2b2b 6929 2078 5b69 5d20 3d20 763b 207d  ++i) x[i] = v; }
+0000cc20: 0a0a 696e 6c69 6e65 2073 7461 7469 6320  ..inline static 
+0000cc30: 766f 6964 2067 676d 6c5f 7665 635f 7365  void ggml_vec_se
+0000cc40: 745f 6631 3628 636f 6e73 7420 696e 7420  t_f16(const int 
+0000cc50: 6e2c 2067 676d 6c5f 6670 3136 5f74 202a  n, ggml_fp16_t *
+0000cc60: 2078 2c20 636f 6e73 7420 696e 7433 325f   x, const int32_
+0000cc70: 7420 7629 207b 2066 6f72 2028 696e 7420  t v) { for (int 
+0000cc80: 6920 3d20 303b 2069 203c 206e 3b20 2b2b  i = 0; i < n; ++
+0000cc90: 6929 2078 5b69 5d20 3d20 763b 207d 0a0a  i) x[i] = v; }..
+0000cca0: 696e 6c69 6e65 2073 7461 7469 6320 766f  inline static vo
+0000ccb0: 6964 2067 676d 6c5f 7665 635f 6164 645f  id ggml_vec_add_
+0000ccc0: 6633 3220 2863 6f6e 7374 2069 6e74 206e  f32 (const int n
+0000ccd0: 2c20 666c 6f61 7420 2a20 7a2c 2063 6f6e  , float * z, con
+0000cce0: 7374 2066 6c6f 6174 202a 2078 2c20 636f  st float * x, co
+0000ccf0: 6e73 7420 666c 6f61 7420 2a20 7929 207b  nst float * y) {
+0000cd00: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0000cd10: 2069 203c 206e 3b20 2b2b 6929 207a 5b69   i < n; ++i) z[i
+0000cd20: 5d20 203d 2078 5b69 5d20 2b20 795b 695d  ]  = x[i] + y[i]
+0000cd30: 3b20 7d0a 696e 6c69 6e65 2073 7461 7469  ; }.inline stati
+0000cd40: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
+0000cd50: 6163 635f 6633 3220 2863 6f6e 7374 2069  acc_f32 (const i
+0000cd60: 6e74 206e 2c20 666c 6f61 7420 2a20 792c  nt n, float * y,
+0000cd70: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+0000cd80: 2920 2020 2020 2020 2020 2020 2020 2020  )               
+0000cd90: 2020 207b 2066 6f72 2028 696e 7420 6920     { for (int i 
+0000cda0: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
+0000cdb0: 2079 5b69 5d20 2b3d 2078 5b69 5d3b 2020   y[i] += x[i];  
+0000cdc0: 2020 2020 2020 7d0a 696e 6c69 6e65 2073        }.inline s
+0000cdd0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0000cde0: 7665 635f 6163 6331 5f66 3332 2863 6f6e  vec_acc1_f32(con
+0000cdf0: 7374 2069 6e74 206e 2c20 666c 6f61 7420  st int n, float 
+0000ce00: 2a20 792c 2063 6f6e 7374 2066 6c6f 6174  * y, const float
+0000ce10: 2020 2076 2920 2020 2020 2020 2020 2020     v)           
+0000ce20: 2020 2020 2020 207b 2066 6f72 2028 696e         { for (in
+0000ce30: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
+0000ce40: 2b2b 6929 2079 5b69 5d20 2b3d 2076 3b20  ++i) y[i] += v; 
+0000ce50: 2020 2020 2020 2020 2020 7d0a 696e 6c69            }.inli
+0000ce60: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
+0000ce70: 676d 6c5f 7665 635f 7375 625f 6633 3220  gml_vec_sub_f32 
+0000ce80: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
+0000ce90: 6f61 7420 2a20 7a2c 2063 6f6e 7374 2066  oat * z, const f
+0000cea0: 6c6f 6174 202a 2078 2c20 636f 6e73 7420  loat * x, const 
+0000ceb0: 666c 6f61 7420 2a20 7929 207b 2066 6f72  float * y) { for
+0000cec0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0000ced0: 206e 3b20 2b2b 6929 207a 5b69 5d20 203d   n; ++i) z[i]  =
+0000cee0: 2078 5b69 5d20 2d20 795b 695d 3b20 7d0a   x[i] - y[i]; }.
+0000cef0: 696e 6c69 6e65 2073 7461 7469 6320 766f  inline static vo
+0000cf00: 6964 2067 676d 6c5f 7665 635f 7365 745f  id ggml_vec_set_
+0000cf10: 6633 3220 2863 6f6e 7374 2069 6e74 206e  f32 (const int n
+0000cf20: 2c20 666c 6f61 7420 2a20 782c 2063 6f6e  , float * x, con
+0000cf30: 7374 2066 6c6f 6174 2020 2076 2920 2020  st float   v)   
+0000cf40: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0000cf50: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0000cf60: 2069 203c 206e 3b20 2b2b 6929 2078 5b69   i < n; ++i) x[i
+0000cf70: 5d20 203d 2076 3b20 2020 2020 2020 2020  ]  = v;         
+0000cf80: 2020 7d0a 696e 6c69 6e65 2073 7461 7469    }.inline stati
+0000cf90: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
+0000cfa0: 6370 795f 6633 3220 2863 6f6e 7374 2069  cpy_f32 (const i
+0000cfb0: 6e74 206e 2c20 666c 6f61 7420 2a20 792c  nt n, float * y,
+0000cfc0: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+0000cfd0: 2920 2020 2020 2020 2020 2020 2020 2020  )               
+0000cfe0: 2020 207b 2066 6f72 2028 696e 7420 6920     { for (int i 
+0000cff0: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
+0000d000: 2079 5b69 5d20 203d 2078 5b69 5d3b 2020   y[i]  = x[i];  
+0000d010: 2020 2020 2020 7d0a 696e 6c69 6e65 2073        }.inline s
+0000d020: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0000d030: 7665 635f 6e65 675f 6633 3220 2863 6f6e  vec_neg_f32 (con
+0000d040: 7374 2069 6e74 206e 2c20 666c 6f61 7420  st int n, float 
+0000d050: 2a20 792c 2063 6f6e 7374 2066 6c6f 6174  * y, const float
+0000d060: 202a 2078 2920 2020 2020 2020 2020 2020   * x)           
+0000d070: 2020 2020 2020 207b 2066 6f72 2028 696e         { for (in
+0000d080: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
+0000d090: 2b2b 6929 2079 5b69 5d20 203d 202d 785b  ++i) y[i]  = -x[
+0000d0a0: 695d 3b20 2020 2020 2020 7d0a 696e 6c69  i];       }.inli
+0000d0b0: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
+0000d0c0: 676d 6c5f 7665 635f 6d75 6c5f 6633 3220  gml_vec_mul_f32 
+0000d0d0: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
+0000d0e0: 6f61 7420 2a20 7a2c 2063 6f6e 7374 2066  oat * z, const f
+0000d0f0: 6c6f 6174 202a 2078 2c20 636f 6e73 7420  loat * x, const 
+0000d100: 666c 6f61 7420 2a20 7929 207b 2066 6f72  float * y) { for
+0000d110: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0000d120: 206e 3b20 2b2b 6929 207a 5b69 5d20 203d   n; ++i) z[i]  =
+0000d130: 2078 5b69 5d2a 795b 695d 3b20 2020 7d0a   x[i]*y[i];   }.
+0000d140: 696e 6c69 6e65 2073 7461 7469 6320 766f  inline static vo
+0000d150: 6964 2067 676d 6c5f 7665 635f 6469 765f  id ggml_vec_div_
+0000d160: 6633 3220 2863 6f6e 7374 2069 6e74 206e  f32 (const int n
+0000d170: 2c20 666c 6f61 7420 2a20 7a2c 2063 6f6e  , float * z, con
+0000d180: 7374 2066 6c6f 6174 202a 2078 2c20 636f  st float * x, co
+0000d190: 6e73 7420 666c 6f61 7420 2a20 7929 207b  nst float * y) {
+0000d1a0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0000d1b0: 2069 203c 206e 3b20 2b2b 6929 207a 5b69   i < n; ++i) z[i
+0000d1c0: 5d20 203d 2078 5b69 5d2f 795b 695d 3b20  ]  = x[i]/y[i]; 
+0000d1d0: 2020 7d0a 0a69 6e6c 696e 6520 7374 6174    }..inline stat
+0000d1e0: 6963 2076 6f69 6420 6767 6d6c 5f76 6563  ic void ggml_vec
+0000d1f0: 5f64 6f74 5f66 3332 2863 6f6e 7374 2069  _dot_f32(const i
+0000d200: 6e74 206e 2c20 666c 6f61 7420 2a20 7265  nt n, float * re
+0000d210: 7374 7269 6374 2073 2c20 636f 6e73 7420  strict s, const 
+0000d220: 666c 6f61 7420 2a20 7265 7374 7269 6374  float * restrict
+0000d230: 2078 2c20 636f 6e73 7420 666c 6f61 7420   x, const float 
+0000d240: 2a20 7265 7374 7269 6374 2079 2920 7b0a  * restrict y) {.
+0000d250: 2369 6664 6566 2047 474d 4c5f 5349 4d44  #ifdef GGML_SIMD
+0000d260: 0a20 2020 2066 6c6f 6174 2073 756d 6620  .    float sumf 
+0000d270: 3d20 302e 3066 3b0a 2020 2020 636f 6e73  = 0.0f;.    cons
+0000d280: 7420 696e 7420 6e70 203d 2028 6e20 2620  t int np = (n & 
+0000d290: 7e28 4747 4d4c 5f46 3332 5f53 5445 5020  ~(GGML_F32_STEP 
+0000d2a0: 2d20 3129 293b 0a0a 2020 2020 4747 4d4c  - 1));..    GGML
+0000d2b0: 5f46 3332 5f56 4543 2073 756d 5b47 474d  _F32_VEC sum[GGM
+0000d2c0: 4c5f 4633 325f 4152 525d 203d 207b 2047  L_F32_ARR] = { G
+0000d2d0: 474d 4c5f 4633 325f 5645 435f 5a45 524f  GML_F32_VEC_ZERO
+0000d2e0: 207d 3b0a 0a20 2020 2047 474d 4c5f 4633   };..    GGML_F3
+0000d2f0: 325f 5645 4320 6178 5b47 474d 4c5f 4633  2_VEC ax[GGML_F3
+0000d300: 325f 4152 525d 3b0a 2020 2020 4747 4d4c  2_ARR];.    GGML
+0000d310: 5f46 3332 5f56 4543 2061 795b 4747 4d4c  _F32_VEC ay[GGML
+0000d320: 5f46 3332 5f41 5252 5d3b 0a0a 2020 2020  _F32_ARR];..    
+0000d330: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0000d340: 6920 3c20 6e70 3b20 6920 2b3d 2047 474d  i < np; i += GGM
+0000d350: 4c5f 4633 325f 5354 4550 2920 7b0a 2020  L_F32_STEP) {.  
+0000d360: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+0000d370: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f46   = 0; j < GGML_F
+0000d380: 3332 5f41 5252 3b20 6a2b 2b29 207b 0a20  32_ARR; j++) {. 
+0000d390: 2020 2020 2020 2020 2020 2061 785b 6a5d             ax[j]
+0000d3a0: 203d 2047 474d 4c5f 4633 325f 5645 435f   = GGML_F32_VEC_
+0000d3b0: 4c4f 4144 2878 202b 2069 202b 206a 2a47  LOAD(x + i + j*G
+0000d3c0: 474d 4c5f 4633 325f 4550 5229 3b0a 2020  GML_F32_EPR);.  
+0000d3d0: 2020 2020 2020 2020 2020 6179 5b6a 5d20            ay[j] 
+0000d3e0: 3d20 4747 4d4c 5f46 3332 5f56 4543 5f4c  = GGML_F32_VEC_L
+0000d3f0: 4f41 4428 7920 2b20 6920 2b20 6a2a 4747  OAD(y + i + j*GG
+0000d400: 4d4c 5f46 3332 5f45 5052 293b 0a0a 2020  ML_F32_EPR);..  
+0000d410: 2020 2020 2020 2020 2020 7375 6d5b 6a5d            sum[j]
+0000d420: 203d 2047 474d 4c5f 4633 325f 5645 435f   = GGML_F32_VEC_
+0000d430: 464d 4128 7375 6d5b 6a5d 2c20 6178 5b6a  FMA(sum[j], ax[j
+0000d440: 5d2c 2061 795b 6a5d 293b 0a20 2020 2020  ], ay[j]);.     
+0000d450: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+0000d460: 2f2f 2072 6564 7563 6520 7375 6d30 2e2e  // reduce sum0..
+0000d470: 7375 6d33 2074 6f20 7375 6d30 0a20 2020  sum3 to sum0.   
+0000d480: 2047 474d 4c5f 4633 325f 5645 435f 5245   GGML_F32_VEC_RE
+0000d490: 4455 4345 2873 756d 662c 2073 756d 293b  DUCE(sumf, sum);
+0000d4a0: 0a0a 2020 2020 2f2f 206c 6566 746f 7665  ..    // leftove
+0000d4b0: 7273 0a20 2020 2066 6f72 2028 696e 7420  rs.    for (int 
+0000d4c0: 6920 3d20 6e70 3b20 6920 3c20 6e3b 202b  i = np; i < n; +
+0000d4d0: 2b69 2920 7b0a 2020 2020 2020 2020 7375  +i) {.        su
+0000d4e0: 6d66 202b 3d20 785b 695d 2a79 5b69 5d3b  mf += x[i]*y[i];
+0000d4f0: 0a20 2020 207d 0a23 656c 7365 0a20 2020  .    }.#else.   
+0000d500: 202f 2f20 7363 616c 6172 0a20 2020 2067   // scalar.    g
+0000d510: 676d 6c5f 666c 6f61 7420 7375 6d66 203d  gml_float sumf =
+0000d520: 2030 2e30 3b0a 2020 2020 666f 7220 2869   0.0;.    for (i
+0000d530: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
+0000d540: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+0000d550: 7375 6d66 202b 3d20 2867 676d 6c5f 666c  sumf += (ggml_fl
+0000d560: 6f61 7429 2878 5b69 5d2a 795b 695d 293b  oat)(x[i]*y[i]);
+0000d570: 0a20 2020 207d 0a23 656e 6469 660a 0a20  .    }.#endif.. 
+0000d580: 2020 202a 7320 3d20 7375 6d66 3b0a 7d0a     *s = sumf;.}.
+0000d590: 0a23 6966 205f 5f41 5658 3531 3246 5f5f  .#if __AVX512F__
+0000d5a0: 2026 2620 514b 203d 3d20 3332 0a73 7461   && QK == 32.sta
+0000d5b0: 7469 6320 696e 6c69 6e65 205f 5f6d 3531  tic inline __m51
+0000d5c0: 3220 646f 745f 7134 5f30 5f6f 6e65 626c  2 dot_q4_0_onebl
+0000d5d0: 6f63 6b5f 6176 7835 3132 280a 2020 2020  ock_avx512(.    
+0000d5e0: 5f5f 6d35 3132 2061 6363 2c0a 2020 2020  __m512 acc,.    
+0000d5f0: 636f 6e73 7420 626c 6f63 6b5f 7134 5f30  const block_q4_0
+0000d600: 202a 2072 6573 7472 6963 7420 782c 0a20   * restrict x,. 
+0000d610: 2020 2063 6f6e 7374 2062 6c6f 636b 5f71     const block_q
+0000d620: 345f 3020 2a20 7265 7374 7269 6374 2079  4_0 * restrict y
+0000d630: 2c0a 2020 2020 696e 7420 690a 2920 7b0a  ,.    int i.) {.
+0000d640: 2020 2020 2f2f 2043 6f6d 7075 7465 2063      // Compute c
+0000d650: 6f6d 6269 6e65 6420 7363 616c 6520 666f  ombined scale fo
+0000d660: 7220 7468 6520 626c 6f63 6b0a 2020 2020  r the block.    
+0000d670: 5f5f 6d35 3132 2064 203d 205f 6d6d 3531  __m512 d = _mm51
+0000d680: 325f 7365 7431 5f70 7328 2078 5b69 5d2e  2_set1_ps( x[i].
+0000d690: 6420 2a20 795b 695d 2e64 2029 3b0a 0a20  d * y[i].d );.. 
+0000d6a0: 2020 205f 5f6d 3235 3669 2062 7820 3d20     __m256i bx = 
+0000d6b0: 6279 7465 7346 726f 6d4e 6962 626c 6573  bytesFromNibbles
+0000d6c0: 2820 785b 695d 2e71 7320 293b 0a20 2020  ( x[i].qs );.   
+0000d6d0: 205f 5f6d 3235 3669 2062 7920 3d20 6279   __m256i by = by
+0000d6e0: 7465 7346 726f 6d4e 6962 626c 6573 2820  tesFromNibbles( 
+0000d6f0: 795b 695d 2e71 7320 293b 0a0a 2020 2020  y[i].qs );..    
+0000d700: 2f2f 204e 6f77 2077 6520 6861 7665 2061  // Now we have a
+0000d710: 2076 6563 746f 7220 7769 7468 2062 7974   vector with byt
+0000d720: 6573 2069 6e20 5b20 3020 2e2e 2031 3520  es in [ 0 .. 15 
+0000d730: 5d20 696e 7465 7276 616c 2e20 4f66 6673  ] interval. Offs
+0000d740: 6574 2074 6865 6d20 696e 746f 205b 202d  et them into [ -
+0000d750: 3820 2e2e 202b 3720 5d20 696e 7465 7276  8 .. +7 ] interv
+0000d760: 616c 2e0a 2020 2020 636f 6e73 7420 5f5f  al..    const __
+0000d770: 6d32 3536 6920 6f66 6620 3d20 5f6d 6d32  m256i off = _mm2
+0000d780: 3536 5f73 6574 315f 6570 6938 2820 3820  56_set1_epi8( 8 
+0000d790: 293b 0a20 2020 2062 7820 3d20 5f6d 6d32  );.    bx = _mm2
+0000d7a0: 3536 5f73 7562 5f65 7069 3828 2062 782c  56_sub_epi8( bx,
+0000d7b0: 206f 6666 2029 3b0a 2020 2020 6279 203d   off );.    by =
+0000d7c0: 205f 6d6d 3235 365f 7375 625f 6570 6938   _mm256_sub_epi8
+0000d7d0: 2820 6279 2c20 6f66 6620 293b 0a0a 2020  ( by, off );..  
+0000d7e0: 2020 2f2f 2053 6967 6e2d 6578 7465 6e64    // Sign-extend
+0000d7f0: 2031 3620 7369 676e 6564 2062 7974 6573   16 signed bytes
+0000d800: 2069 6e74 6f20 696e 7431 365f 740a 2020   into int16_t.  
+0000d810: 2020 5f5f 6d35 3132 6920 7833 3220 3d20    __m512i x32 = 
+0000d820: 5f6d 6d35 3132 5f63 7674 6570 6938 5f65  _mm512_cvtepi8_e
+0000d830: 7069 3136 2820 6278 2029 3b0a 2020 2020  pi16( bx );.    
+0000d840: 5f5f 6d35 3132 6920 7933 3220 3d20 5f6d  __m512i y32 = _m
+0000d850: 6d35 3132 5f63 7674 6570 6938 5f65 7069  m512_cvtepi8_epi
+0000d860: 3136 2820 6279 2029 3b0a 2020 2020 2f2f  16( by );.    //
+0000d870: 2043 6f6d 7075 7465 2070 726f 6475 6374   Compute product
+0000d880: 7320 6f66 2069 6e74 3136 5f74 2069 6e74  s of int16_t int
+0000d890: 6567 6572 732c 2061 6464 2070 6169 7277  egers, add pairw
+0000d8a0: 6973 650a 2020 2020 5f5f 6d35 3132 6920  ise.    __m512i 
+0000d8b0: 6936 3420 3d20 5f6d 6d35 3132 5f6d 6164  i64 = _mm512_mad
+0000d8c0: 645f 6570 6931 3628 2078 3332 2c20 7933  d_epi16( x32, y3
+0000d8d0: 3220 293b 0a0a 2020 2020 2f2f 2043 6f6e  2 );..    // Con
+0000d8e0: 7665 7274 2069 6e74 3332 5f74 2074 6f20  vert int32_t to 
+0000d8f0: 666c 6f61 740a 2020 2020 5f5f 6d35 3132  float.    __m512
+0000d900: 2070 203d 205f 6d6d 3531 325f 6376 7465   p = _mm512_cvte
+0000d910: 7069 3332 5f70 7328 2069 3634 2029 3b0a  pi32_ps( i64 );.
+0000d920: 2020 2020 2f2f 2041 7070 6c79 2074 6865      // Apply the
+0000d930: 2073 6361 6c65 2c20 616e 6420 6163 6375   scale, and accu
+0000d940: 6d75 6c61 7465 0a20 2020 2072 6574 7572  mulate.    retur
+0000d950: 6e20 5f6d 6d35 3132 5f66 6d61 6464 5f70  n _mm512_fmadd_p
+0000d960: 7328 2064 2c20 702c 2061 6363 2029 3b0a  s( d, p, acc );.
+0000d970: 7d0a 2365 6e64 6966 0a0a 696e 6c69 6e65  }.#endif..inline
+0000d980: 2073 7461 7469 6320 766f 6964 2067 676d   static void ggm
+0000d990: 6c5f 7665 635f 646f 745f 6631 3628 636f  l_vec_dot_f16(co
+0000d9a0: 6e73 7420 696e 7420 6e2c 2066 6c6f 6174  nst int n, float
+0000d9b0: 202a 2072 6573 7472 6963 7420 732c 2067   * restrict s, g
+0000d9c0: 676d 6c5f 6670 3136 5f74 202a 2072 6573  gml_fp16_t * res
+0000d9d0: 7472 6963 7420 782c 2067 676d 6c5f 6670  trict x, ggml_fp
+0000d9e0: 3136 5f74 202a 2072 6573 7472 6963 7420  16_t * restrict 
+0000d9f0: 7929 207b 0a20 2020 2067 676d 6c5f 666c  y) {.    ggml_fl
+0000da00: 6f61 7420 7375 6d66 203d 2030 2e30 3b0a  oat sumf = 0.0;.
+0000da10: 0a23 6966 2064 6566 696e 6564 2847 474d  .#if defined(GGM
+0000da20: 4c5f 5349 4d44 290a 2020 2020 636f 6e73  L_SIMD).    cons
+0000da30: 7420 696e 7420 6e70 203d 2028 6e20 2620  t int np = (n & 
+0000da40: 7e28 4747 4d4c 5f46 3136 5f53 5445 5020  ~(GGML_F16_STEP 
+0000da50: 2d20 3129 293b 0a0a 2020 2020 4747 4d4c  - 1));..    GGML
+0000da60: 5f46 3136 5f56 4543 2073 756d 5b47 474d  _F16_VEC sum[GGM
+0000da70: 4c5f 4631 365f 4152 525d 203d 207b 2047  L_F16_ARR] = { G
+0000da80: 474d 4c5f 4631 365f 5645 435f 5a45 524f  GML_F16_VEC_ZERO
+0000da90: 207d 3b0a 0a20 2020 2047 474d 4c5f 4631   };..    GGML_F1
+0000daa0: 365f 5645 4320 6178 5b47 474d 4c5f 4631  6_VEC ax[GGML_F1
+0000dab0: 365f 4152 525d 3b0a 2020 2020 4747 4d4c  6_ARR];.    GGML
+0000dac0: 5f46 3136 5f56 4543 2061 795b 4747 4d4c  _F16_VEC ay[GGML
+0000dad0: 5f46 3136 5f41 5252 5d3b 0a0a 2020 2020  _F16_ARR];..    
+0000dae0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0000daf0: 6920 3c20 6e70 3b20 6920 2b3d 2047 474d  i < np; i += GGM
+0000db00: 4c5f 4631 365f 5354 4550 2920 7b0a 2020  L_F16_STEP) {.  
+0000db10: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+0000db20: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f46   = 0; j < GGML_F
+0000db30: 3136 5f41 5252 3b20 6a2b 2b29 207b 0a20  16_ARR; j++) {. 
+0000db40: 2020 2020 2020 2020 2020 2061 785b 6a5d             ax[j]
+0000db50: 203d 2047 474d 4c5f 4631 365f 5645 435f   = GGML_F16_VEC_
+0000db60: 4c4f 4144 2878 202b 2069 202b 206a 2a47  LOAD(x + i + j*G
+0000db70: 474d 4c5f 4631 365f 4550 522c 206a 293b  GML_F16_EPR, j);
+0000db80: 0a20 2020 2020 2020 2020 2020 2061 795b  .            ay[
+0000db90: 6a5d 203d 2047 474d 4c5f 4631 365f 5645  j] = GGML_F16_VE
+0000dba0: 435f 4c4f 4144 2879 202b 2069 202b 206a  C_LOAD(y + i + j
+0000dbb0: 2a47 474d 4c5f 4631 365f 4550 522c 206a  *GGML_F16_EPR, j
+0000dbc0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0000dbd0: 7375 6d5b 6a5d 203d 2047 474d 4c5f 4631  sum[j] = GGML_F1
+0000dbe0: 365f 5645 435f 464d 4128 7375 6d5b 6a5d  6_VEC_FMA(sum[j]
+0000dbf0: 2c20 6178 5b6a 5d2c 2061 795b 6a5d 293b  , ax[j], ay[j]);
+0000dc00: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+0000dc10: 0a0a 2020 2020 2f2f 2072 6564 7563 6520  ..    // reduce 
+0000dc20: 7375 6d30 2e2e 7375 6d33 2074 6f20 7375  sum0..sum3 to su
+0000dc30: 6d30 0a20 2020 2047 474d 4c5f 4631 365f  m0.    GGML_F16_
+0000dc40: 5645 435f 5245 4455 4345 2873 756d 662c  VEC_REDUCE(sumf,
+0000dc50: 2073 756d 293b 0a0a 2020 2020 2f2f 206c   sum);..    // l
+0000dc60: 6566 746f 7665 7273 0a20 2020 2066 6f72  eftovers.    for
+0000dc70: 2028 696e 7420 6920 3d20 6e70 3b20 6920   (int i = np; i 
+0000dc80: 3c20 6e3b 202b 2b69 2920 7b0a 2020 2020  < n; ++i) {.    
+0000dc90: 2020 2020 7375 6d66 202b 3d20 2867 676d      sumf += (ggm
+0000dca0: 6c5f 666c 6f61 7429 2847 474d 4c5f 4650  l_float)(GGML_FP
+0000dcb0: 3136 5f54 4f5f 4650 3332 2878 5b69 5d29  16_TO_FP32(x[i])
+0000dcc0: 2a47 474d 4c5f 4650 3136 5f54 4f5f 4650  *GGML_FP16_TO_FP
+0000dcd0: 3332 2879 5b69 5d29 293b 0a20 2020 207d  32(y[i]));.    }
+0000dce0: 0a23 656c 7365 0a20 2020 2066 6f72 2028  .#else.    for (
+0000dcf0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+0000dd00: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+0000dd10: 2073 756d 6620 2b3d 2028 6767 6d6c 5f66   sumf += (ggml_f
+0000dd20: 6c6f 6174 2928 4747 4d4c 5f46 5031 365f  loat)(GGML_FP16_
+0000dd30: 544f 5f46 5033 3228 785b 695d 292a 4747  TO_FP32(x[i])*GG
+0000dd40: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+0000dd50: 795b 695d 2929 3b0a 2020 2020 7d0a 2365  y[i]));.    }.#e
+0000dd60: 6e64 6966 0a0a 2020 2020 2a73 203d 2073  ndif..    *s = s
+0000dd70: 756d 663b 0a7d 0a0a 7374 6174 6963 2076  umf;.}..static v
+0000dd80: 6f69 6420 6767 6d6c 5f76 6563 5f64 6f74  oid ggml_vec_dot
+0000dd90: 5f71 345f 3028 636f 6e73 7420 696e 7420  _q4_0(const int 
+0000dda0: 6e2c 2066 6c6f 6174 202a 2072 6573 7472  n, float * restr
+0000ddb0: 6963 7420 732c 2063 6f6e 7374 2076 6f69  ict s, const voi
+0000ddc0: 6420 2a20 7265 7374 7269 6374 2076 782c  d * restrict vx,
+0000ddd0: 2063 6f6e 7374 2076 6f69 6420 2a20 7265   const void * re
+0000dde0: 7374 7269 6374 2076 7929 207b 0a20 2020  strict vy) {.   
+0000ddf0: 2063 6f6e 7374 2069 6e74 206e 6220 3d20   const int nb = 
+0000de00: 6e20 2f20 514b 3b0a 0a20 2020 2061 7373  n / QK;..    ass
+0000de10: 6572 7428 6e20 2520 514b 203d 3d20 3029  ert(n % QK == 0)
+0000de20: 3b0a 2020 2020 6173 7365 7274 286e 6220  ;.    assert(nb 
+0000de30: 2520 3220 3d3d 2030 293b 0a0a 2020 2020  % 2 == 0);..    
+0000de40: 636f 6e73 7420 626c 6f63 6b5f 7134 5f30  const block_q4_0
+0000de50: 202a 2072 6573 7472 6963 7420 7820 3d20   * restrict x = 
+0000de60: 7678 3b0a 2020 2020 636f 6e73 7420 626c  vx;.    const bl
+0000de70: 6f63 6b5f 7134 5f30 202a 2072 6573 7472  ock_q4_0 * restr
+0000de80: 6963 7420 7920 3d20 7679 3b0a 0a20 2020  ict y = vy;..   
+0000de90: 2067 676d 6c5f 666c 6f61 7420 7375 6d66   ggml_float sumf
+0000dea0: 203d 2030 2e30 3b0a 0a23 6966 2064 6566   = 0.0;..#if def
+0000deb0: 696e 6564 285f 5f41 524d 5f4e 454f 4e29  ined(__ARM_NEON)
+0000dec0: 0a20 2020 2066 6c6f 6174 2073 756d 3020  .    float sum0 
+0000ded0: 3d20 302e 3066 3b0a 2020 2020 666c 6f61  = 0.0f;.    floa
+0000dee0: 7420 7375 6d31 203d 2030 2e30 663b 0a0a  t sum1 = 0.0f;..
+0000def0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0000df00: 2030 3b20 6920 3c20 6e62 3b20 6920 2b3d   0; i < nb; i +=
+0000df10: 2032 2920 7b0a 2020 2020 2020 2020 636f   2) {.        co
+0000df20: 6e73 7420 626c 6f63 6b5f 7134 5f30 202a  nst block_q4_0 *
+0000df30: 2072 6573 7472 6963 7420 7830 203d 2026   restrict x0 = &
+0000df40: 785b 6920 2b20 305d 3b0a 2020 2020 2020  x[i + 0];.      
+0000df50: 2020 636f 6e73 7420 626c 6f63 6b5f 7134    const block_q4
+0000df60: 5f30 202a 2072 6573 7472 6963 7420 7930  _0 * restrict y0
+0000df70: 203d 2026 795b 6920 2b20 305d 3b0a 2020   = &y[i + 0];.  
+0000df80: 2020 2020 2020 636f 6e73 7420 626c 6f63        const bloc
+0000df90: 6b5f 7134 5f30 202a 2072 6573 7472 6963  k_q4_0 * restric
+0000dfa0: 7420 7831 203d 2026 785b 6920 2b20 315d  t x1 = &x[i + 1]
+0000dfb0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+0000dfc0: 626c 6f63 6b5f 7134 5f30 202a 2072 6573  block_q4_0 * res
+0000dfd0: 7472 6963 7420 7931 203d 2026 795b 6920  trict y1 = &y[i 
+0000dfe0: 2b20 315d 3b0a 0a20 2020 2020 2020 2063  + 1];..        c
+0000dff0: 6f6e 7374 2075 696e 7438 7831 365f 7420  onst uint8x16_t 
+0000e000: 6d34 6220 3d20 7664 7570 715f 6e5f 7538  m4b = vdupq_n_u8
+0000e010: 2830 7866 293b 0a20 2020 2020 2020 2063  (0xf);.        c
+0000e020: 6f6e 7374 2069 6e74 3878 3136 5f74 2020  onst int8x16_t  
+0000e030: 7338 6220 3d20 7664 7570 715f 6e5f 7338  s8b = vdupq_n_s8
+0000e040: 2830 7838 293b 0a0a 2020 2020 2020 2020  (0x8);..        
+0000e050: 636f 6e73 7420 7569 6e74 3878 3136 5f74  const uint8x16_t
+0000e060: 2076 305f 3020 3d20 766c 6431 715f 7538   v0_0 = vld1q_u8
+0000e070: 2878 302d 3e71 7329 3b0a 2020 2020 2020  (x0->qs);.      
+0000e080: 2020 636f 6e73 7420 7569 6e74 3878 3136    const uint8x16
+0000e090: 5f74 2076 315f 3020 3d20 766c 6431 715f  _t v1_0 = vld1q_
+0000e0a0: 7538 2879 302d 3e71 7329 3b0a 2020 2020  u8(y0->qs);.    
+0000e0b0: 2020 2020 636f 6e73 7420 7569 6e74 3878      const uint8x
+0000e0c0: 3136 5f74 2076 305f 3120 3d20 766c 6431  16_t v0_1 = vld1
+0000e0d0: 715f 7538 2878 312d 3e71 7329 3b0a 2020  q_u8(x1->qs);.  
+0000e0e0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+0000e0f0: 3878 3136 5f74 2076 315f 3120 3d20 766c  8x16_t v1_1 = vl
+0000e100: 6431 715f 7538 2879 312d 3e71 7329 3b0a  d1q_u8(y1->qs);.
+0000e110: 0a20 2020 2020 2020 202f 2f20 342d 6269  .        // 4-bi
+0000e120: 7420 2d3e 2038 2d62 6974 0a20 2020 2020  t -> 8-bit.     
+0000e130: 2020 2063 6f6e 7374 2069 6e74 3878 3136     const int8x16
+0000e140: 5f74 2076 305f 306c 203d 2076 7265 696e  _t v0_0l = vrein
+0000e150: 7465 7270 7265 7471 5f73 385f 7538 2876  terpretq_s8_u8(v
+0000e160: 616e 6471 5f75 3828 7630 5f30 2c20 6d34  andq_u8(v0_0, m4
+0000e170: 6229 293b 0a20 2020 2020 2020 2063 6f6e  b));.        con
+0000e180: 7374 2069 6e74 3878 3136 5f74 2076 315f  st int8x16_t v1_
+0000e190: 306c 203d 2076 7265 696e 7465 7270 7265  0l = vreinterpre
+0000e1a0: 7471 5f73 385f 7538 2876 616e 6471 5f75  tq_s8_u8(vandq_u
+0000e1b0: 3828 7631 5f30 2c20 6d34 6229 293b 0a0a  8(v1_0, m4b));..
+0000e1c0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0000e1d0: 7438 7831 365f 7420 7630 5f30 6820 3d20  t8x16_t v0_0h = 
+0000e1e0: 7672 6569 6e74 6572 7072 6574 715f 7338  vreinterpretq_s8
+0000e1f0: 5f75 3828 7673 6872 715f 6e5f 7538 2876  _u8(vshrq_n_u8(v
+0000e200: 305f 302c 2034 2929 3b0a 2020 2020 2020  0_0, 4));.      
+0000e210: 2020 636f 6e73 7420 696e 7438 7831 365f    const int8x16_
+0000e220: 7420 7631 5f30 6820 3d20 7672 6569 6e74  t v1_0h = vreint
+0000e230: 6572 7072 6574 715f 7338 5f75 3828 7673  erpretq_s8_u8(vs
+0000e240: 6872 715f 6e5f 7538 2876 315f 302c 2034  hrq_n_u8(v1_0, 4
+0000e250: 2929 3b0a 0a20 2020 2020 2020 2063 6f6e  ));..        con
+0000e260: 7374 2069 6e74 3878 3136 5f74 2076 305f  st int8x16_t v0_
+0000e270: 316c 203d 2076 7265 696e 7465 7270 7265  1l = vreinterpre
+0000e280: 7471 5f73 385f 7538 2876 616e 6471 5f75  tq_s8_u8(vandq_u
+0000e290: 3828 7630 5f31 2c20 6d34 6229 293b 0a20  8(v0_1, m4b));. 
+0000e2a0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0000e2b0: 3878 3136 5f74 2076 315f 316c 203d 2076  8x16_t v1_1l = v
+0000e2c0: 7265 696e 7465 7270 7265 7471 5f73 385f  reinterpretq_s8_
+0000e2d0: 7538 2876 616e 6471 5f75 3828 7631 5f31  u8(vandq_u8(v1_1
+0000e2e0: 2c20 6d34 6229 293b 0a0a 2020 2020 2020  , m4b));..      
+0000e2f0: 2020 636f 6e73 7420 696e 7438 7831 365f    const int8x16_
+0000e300: 7420 7630 5f31 6820 3d20 7672 6569 6e74  t v0_1h = vreint
+0000e310: 6572 7072 6574 715f 7338 5f75 3828 7673  erpretq_s8_u8(vs
+0000e320: 6872 715f 6e5f 7538 2876 305f 312c 2034  hrq_n_u8(v0_1, 4
+0000e330: 2929 3b0a 2020 2020 2020 2020 636f 6e73  ));.        cons
+0000e340: 7420 696e 7438 7831 365f 7420 7631 5f31  t int8x16_t v1_1
+0000e350: 6820 3d20 7672 6569 6e74 6572 7072 6574  h = vreinterpret
+0000e360: 715f 7338 5f75 3828 7673 6872 715f 6e5f  q_s8_u8(vshrq_n_
+0000e370: 7538 2876 315f 312c 2034 2929 3b0a 0a20  u8(v1_1, 4));.. 
+0000e380: 2020 2020 2020 202f 2f20 7375 6220 380a         // sub 8.
+0000e390: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0000e3a0: 7438 7831 365f 7420 7630 5f30 6c73 203d  t8x16_t v0_0ls =
+0000e3b0: 2076 7375 6271 5f73 3828 7630 5f30 6c2c   vsubq_s8(v0_0l,
+0000e3c0: 2073 3862 293b 0a20 2020 2020 2020 2063   s8b);.        c
+0000e3d0: 6f6e 7374 2069 6e74 3878 3136 5f74 2076  onst int8x16_t v
+0000e3e0: 315f 306c 7320 3d20 7673 7562 715f 7338  1_0ls = vsubq_s8
+0000e3f0: 2876 315f 306c 2c20 7338 6229 3b0a 0a20  (v1_0l, s8b);.. 
+0000e400: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0000e410: 3878 3136 5f74 2076 305f 3068 7320 3d20  8x16_t v0_0hs = 
+0000e420: 7673 7562 715f 7338 2876 305f 3068 2c20  vsubq_s8(v0_0h, 
+0000e430: 7338 6229 3b0a 2020 2020 2020 2020 636f  s8b);.        co
+0000e440: 6e73 7420 696e 7438 7831 365f 7420 7631  nst int8x16_t v1
+0000e450: 5f30 6873 203d 2076 7375 6271 5f73 3828  _0hs = vsubq_s8(
+0000e460: 7631 5f30 682c 2073 3862 293b 0a0a 2020  v1_0h, s8b);..  
+0000e470: 2020 2020 2020 636f 6e73 7420 696e 7438        const int8
+0000e480: 7831 365f 7420 7630 5f31 6c73 203d 2076  x16_t v0_1ls = v
+0000e490: 7375 6271 5f73 3828 7630 5f31 6c2c 2073  subq_s8(v0_1l, s
+0000e4a0: 3862 293b 0a20 2020 2020 2020 2063 6f6e  8b);.        con
+0000e4b0: 7374 2069 6e74 3878 3136 5f74 2076 315f  st int8x16_t v1_
+0000e4c0: 316c 7320 3d20 7673 7562 715f 7338 2876  1ls = vsubq_s8(v
+0000e4d0: 315f 316c 2c20 7338 6229 3b0a 0a20 2020  1_1l, s8b);..   
+0000e4e0: 2020 2020 2063 6f6e 7374 2069 6e74 3878       const int8x
+0000e4f0: 3136 5f74 2076 305f 3168 7320 3d20 7673  16_t v0_1hs = vs
+0000e500: 7562 715f 7338 2876 305f 3168 2c20 7338  ubq_s8(v0_1h, s8
+0000e510: 6229 3b0a 2020 2020 2020 2020 636f 6e73  b);.        cons
+0000e520: 7420 696e 7438 7831 365f 7420 7631 5f31  t int8x16_t v1_1
+0000e530: 6873 203d 2076 7375 6271 5f73 3828 7631  hs = vsubq_s8(v1
+0000e540: 5f31 682c 2073 3862 293b 0a0a 2369 6620  _1h, s8b);..#if 
+0000e550: 6465 6669 6e65 6428 5f5f 4152 4d5f 4645  defined(__ARM_FE
+0000e560: 4154 5552 455f 444f 5450 524f 4429 0a20  ATURE_DOTPROD). 
+0000e570: 2020 2020 2020 202f 2f20 646f 7420 7072         // dot pr
+0000e580: 6f64 7563 7420 696e 746f 2069 6e74 3136  oduct into int16
+0000e590: 7838 5f74 0a20 2020 2020 2020 2069 6e74  x8_t.        int
+0000e5a0: 3332 7834 5f74 2070 5f30 203d 2076 646f  32x4_t p_0 = vdo
+0000e5b0: 7471 5f73 3332 2876 6475 7071 5f6e 5f73  tq_s32(vdupq_n_s
+0000e5c0: 3332 2830 292c 2076 305f 306c 732c 2076  32(0), v0_0ls, v
+0000e5d0: 315f 306c 7329 3b0a 2020 2020 2020 2020  1_0ls);.        
+0000e5e0: 696e 7433 3278 345f 7420 705f 3120 3d20  int32x4_t p_1 = 
+0000e5f0: 7664 6f74 715f 7333 3228 7664 7570 715f  vdotq_s32(vdupq_
+0000e600: 6e5f 7333 3228 3029 2c20 7630 5f31 6c73  n_s32(0), v0_1ls
+0000e610: 2c20 7631 5f31 6c73 293b 0a0a 2020 2020  , v1_1ls);..    
+0000e620: 2020 2020 705f 3020 3d20 7664 6f74 715f      p_0 = vdotq_
+0000e630: 7333 3228 705f 302c 2076 305f 3068 732c  s32(p_0, v0_0hs,
+0000e640: 2076 315f 3068 7329 3b0a 2020 2020 2020   v1_0hs);.      
+0000e650: 2020 705f 3120 3d20 7664 6f74 715f 7333    p_1 = vdotq_s3
+0000e660: 3228 705f 312c 2076 305f 3168 732c 2076  2(p_1, v0_1hs, v
+0000e670: 315f 3168 7329 3b0a 0a20 2020 2020 2020  1_1hs);..       
+0000e680: 202f 2f20 7363 616c 6172 0a23 6966 2064   // scalar.#if d
+0000e690: 6566 696e 6564 285f 5f41 524d 5f46 4541  efined(__ARM_FEA
+0000e6a0: 5455 5245 5f51 5244 4d58 290a 2020 2020  TURE_QRDMX).    
+0000e6b0: 2020 2020 7375 6d30 202b 3d20 7830 2d3e      sum0 += x0->
+0000e6c0: 6420 2a20 7930 2d3e 6420 2a20 7661 6464  d * y0->d * vadd
+0000e6d0: 7671 5f73 3332 2870 5f30 293b 0a20 2020  vq_s32(p_0);.   
+0000e6e0: 2020 2020 2073 756d 3120 2b3d 2078 312d       sum1 += x1-
+0000e6f0: 3e64 202a 2079 312d 3e64 202a 2076 6164  >d * y1->d * vad
+0000e700: 6476 715f 7333 3228 705f 3129 3b0a 2365  dvq_s32(p_1);.#e
+0000e710: 6c73 650a 2020 2020 2020 2020 7375 6d30  lse.        sum0
+0000e720: 202b 3d20 7830 2d3e 6420 2a20 7930 2d3e   += x0->d * y0->
+0000e730: 6420 2a20 2876 6765 7471 5f6c 616e 655f  d * (vgetq_lane_
+0000e740: 7333 3228 705f 302c 2030 2920 2b20 7667  s32(p_0, 0) + vg
+0000e750: 6574 715f 6c61 6e65 5f73 3332 2870 5f30  etq_lane_s32(p_0
+0000e760: 2c20 3129 202b 2076 6765 7471 5f6c 616e  , 1) + vgetq_lan
+0000e770: 655f 7333 3228 705f 302c 2032 2920 2b20  e_s32(p_0, 2) + 
+0000e780: 7667 6574 715f 6c61 6e65 5f73 3332 2870  vgetq_lane_s32(p
+0000e790: 5f30 2c20 3329 293b 0a20 2020 2020 2020  _0, 3));.       
+0000e7a0: 2073 756d 3120 2b3d 2078 312d 3e64 202a   sum1 += x1->d *
+0000e7b0: 2079 312d 3e64 202a 2028 7667 6574 715f   y1->d * (vgetq_
+0000e7c0: 6c61 6e65 5f73 3332 2870 5f31 2c20 3029  lane_s32(p_1, 0)
+0000e7d0: 202b 2076 6765 7471 5f6c 616e 655f 7333   + vgetq_lane_s3
+0000e7e0: 3228 705f 312c 2031 2920 2b20 7667 6574  2(p_1, 1) + vget
+0000e7f0: 715f 6c61 6e65 5f73 3332 2870 5f31 2c20  q_lane_s32(p_1, 
+0000e800: 3229 202b 2076 6765 7471 5f6c 616e 655f  2) + vgetq_lane_
+0000e810: 7333 3228 705f 312c 2033 2929 3b0a 2365  s32(p_1, 3));.#e
+0000e820: 6e64 6966 0a23 656c 7365 0a09 2020 2020  ndif.#else..    
+0000e830: 636f 6e73 7420 696e 7431 3678 385f 7420  const int16x8_t 
+0000e840: 706c 306c 203d 2076 6d75 6c6c 5f73 3828  pl0l = vmull_s8(
+0000e850: 7667 6574 5f6c 6f77 5f73 3820 2876 305f  vget_low_s8 (v0_
+0000e860: 306c 7329 2c20 7667 6574 5f6c 6f77 5f73  0ls), vget_low_s
+0000e870: 3820 2876 315f 306c 7329 293b 0a20 2020  8 (v1_0ls));.   
+0000e880: 2020 2020 2063 6f6e 7374 2069 6e74 3136       const int16
+0000e890: 7838 5f74 2070 6c30 6820 3d20 766d 756c  x8_t pl0h = vmul
+0000e8a0: 6c5f 7338 2876 6765 745f 6869 6768 5f73  l_s8(vget_high_s
+0000e8b0: 3828 7630 5f30 6c73 292c 2076 6765 745f  8(v0_0ls), vget_
+0000e8c0: 6869 6768 5f73 3828 7631 5f30 6c73 2929  high_s8(v1_0ls))
+0000e8d0: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
+0000e8e0: 2069 6e74 3136 7838 5f74 2070 6830 6c20   int16x8_t ph0l 
+0000e8f0: 3d20 766d 756c 6c5f 7338 2876 6765 745f  = vmull_s8(vget_
+0000e900: 6c6f 775f 7338 2028 7630 5f30 6873 292c  low_s8 (v0_0hs),
+0000e910: 2076 6765 745f 6c6f 775f 7338 2028 7631   vget_low_s8 (v1
+0000e920: 5f30 6873 2929 3b0a 2020 2020 2020 2020  _0hs));.        
+0000e930: 636f 6e73 7420 696e 7431 3678 385f 7420  const int16x8_t 
+0000e940: 7068 3068 203d 2076 6d75 6c6c 5f73 3828  ph0h = vmull_s8(
+0000e950: 7667 6574 5f68 6967 685f 7338 2876 305f  vget_high_s8(v0_
+0000e960: 3068 7329 2c20 7667 6574 5f68 6967 685f  0hs), vget_high_
+0000e970: 7338 2876 315f 3068 7329 293b 0a0a 2020  s8(v1_0hs));..  
+0000e980: 2020 2020 2020 636f 6e73 7420 696e 7431        const int1
+0000e990: 3678 385f 7420 706c 316c 203d 2076 6d75  6x8_t pl1l = vmu
+0000e9a0: 6c6c 5f73 3828 7667 6574 5f6c 6f77 5f73  ll_s8(vget_low_s
+0000e9b0: 3820 2876 305f 316c 7329 2c20 7667 6574  8 (v0_1ls), vget
+0000e9c0: 5f6c 6f77 5f73 3820 2876 315f 316c 7329  _low_s8 (v1_1ls)
+0000e9d0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0000e9e0: 2069 6e74 3136 7838 5f74 2070 6c31 6820   int16x8_t pl1h 
+0000e9f0: 3d20 766d 756c 6c5f 7338 2876 6765 745f  = vmull_s8(vget_
+0000ea00: 6869 6768 5f73 3828 7630 5f31 6c73 292c  high_s8(v0_1ls),
+0000ea10: 2076 6765 745f 6869 6768 5f73 3828 7631   vget_high_s8(v1
+0000ea20: 5f31 6c73 2929 3b0a 0a20 2020 2020 2020  _1ls));..       
+0000ea30: 2063 6f6e 7374 2069 6e74 3136 7838 5f74   const int16x8_t
+0000ea40: 2070 6831 6c20 3d20 766d 756c 6c5f 7338   ph1l = vmull_s8
+0000ea50: 2876 6765 745f 6c6f 775f 7338 2028 7630  (vget_low_s8 (v0
+0000ea60: 5f31 6873 292c 2076 6765 745f 6c6f 775f  _1hs), vget_low_
+0000ea70: 7338 2028 7631 5f31 6873 2929 3b0a 2020  s8 (v1_1hs));.  
+0000ea80: 2020 2020 2020 636f 6e73 7420 696e 7431        const int1
+0000ea90: 3678 385f 7420 7068 3168 203d 2076 6d75  6x8_t ph1h = vmu
+0000eaa0: 6c6c 5f73 3828 7667 6574 5f68 6967 685f  ll_s8(vget_high_
+0000eab0: 7338 2876 305f 3168 7329 2c20 7667 6574  s8(v0_1hs), vget
+0000eac0: 5f68 6967 685f 7338 2876 315f 3168 7329  _high_s8(v1_1hs)
+0000ead0: 293b 0a0a 2020 2020 2020 2020 636f 6e73  );..        cons
+0000eae0: 7420 696e 7431 3678 385f 7420 706c 5f30  t int16x8_t pl_0
+0000eaf0: 203d 2076 6164 6471 5f73 3136 2870 6c30   = vaddq_s16(pl0
+0000eb00: 6c2c 2070 6c30 6829 3b0a 2020 2020 2020  l, pl0h);.      
+0000eb10: 2020 636f 6e73 7420 696e 7431 3678 385f    const int16x8_
+0000eb20: 7420 7068 5f30 203d 2076 6164 6471 5f73  t ph_0 = vaddq_s
+0000eb30: 3136 2870 6830 6c2c 2070 6830 6829 3b0a  16(ph0l, ph0h);.
+0000eb40: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+0000eb50: 6e74 3136 7838 5f74 2070 6c5f 3120 3d20  nt16x8_t pl_1 = 
+0000eb60: 7661 6464 715f 7331 3628 706c 316c 2c20  vaddq_s16(pl1l, 
+0000eb70: 706c 3168 293b 0a20 2020 2020 2020 2063  pl1h);.        c
+0000eb80: 6f6e 7374 2069 6e74 3136 7838 5f74 2070  onst int16x8_t p
+0000eb90: 685f 3120 3d20 7661 6464 715f 7331 3628  h_1 = vaddq_s16(
+0000eba0: 7068 316c 2c20 7068 3168 293b 0a0a 2020  ph1l, ph1h);..  
+0000ebb0: 2020 2020 2020 636f 6e73 7420 696e 7431        const int1
+0000ebc0: 3678 385f 7420 705f 3020 3d20 7661 6464  6x8_t p_0 = vadd
+0000ebd0: 715f 7331 3628 706c 5f30 2c20 7068 5f30  q_s16(pl_0, ph_0
+0000ebe0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0000ebf0: 2069 6e74 3136 7838 5f74 2070 5f31 203d   int16x8_t p_1 =
+0000ec00: 2076 6164 6471 5f73 3136 2870 6c5f 312c   vaddq_s16(pl_1,
+0000ec10: 2070 685f 3129 3b0a 0a20 2020 2020 2020   ph_1);..       
+0000ec20: 202f 2f20 7363 616c 6172 0a23 6966 2064   // scalar.#if d
+0000ec30: 6566 696e 6564 285f 5f41 524d 5f46 4541  efined(__ARM_FEA
+0000ec40: 5455 5245 5f51 5244 4d58 290a 2020 2020  TURE_QRDMX).    
+0000ec50: 2020 2020 7375 6d30 202b 3d20 7830 2d3e      sum0 += x0->
+0000ec60: 6420 2a20 7930 2d3e 6420 2a20 7661 6464  d * y0->d * vadd
+0000ec70: 7671 5f73 3136 2870 5f30 293b 0a20 2020  vq_s16(p_0);.   
+0000ec80: 2020 2020 2073 756d 3120 2b3d 2078 312d       sum1 += x1-
+0000ec90: 3e64 202a 2079 312d 3e64 202a 2076 6164  >d * y1->d * vad
+0000eca0: 6476 715f 7331 3628 705f 3129 3b0a 2365  dvq_s16(p_1);.#e
+0000ecb0: 6c73 650a 2020 2020 2020 2020 7375 6d30  lse.        sum0
+0000ecc0: 202b 3d20 7830 2d3e 6420 2a20 7930 2d3e   += x0->d * y0->
+0000ecd0: 6420 2a20 2876 6765 7471 5f6c 616e 655f  d * (vgetq_lane_
+0000ece0: 7331 3628 705f 302c 2030 2920 2b20 7667  s16(p_0, 0) + vg
+0000ecf0: 6574 715f 6c61 6e65 5f73 3136 2870 5f30  etq_lane_s16(p_0
+0000ed00: 2c20 3129 202b 2076 6765 7471 5f6c 616e  , 1) + vgetq_lan
+0000ed10: 655f 7331 3628 705f 302c 2032 2920 2b20  e_s16(p_0, 2) + 
+0000ed20: 7667 6574 715f 6c61 6e65 5f73 3136 2870  vgetq_lane_s16(p
+0000ed30: 5f30 2c20 3329 202b 2076 6765 7471 5f6c  _0, 3) + vgetq_l
+0000ed40: 616e 655f 7331 3628 705f 302c 2034 2920  ane_s16(p_0, 4) 
+0000ed50: 2b20 7667 6574 715f 6c61 6e65 5f73 3136  + vgetq_lane_s16
+0000ed60: 2870 5f30 2c20 3529 202b 2076 6765 7471  (p_0, 5) + vgetq
+0000ed70: 5f6c 616e 655f 7331 3628 705f 302c 2036  _lane_s16(p_0, 6
+0000ed80: 2920 2b20 7667 6574 715f 6c61 6e65 5f73  ) + vgetq_lane_s
+0000ed90: 3136 2870 5f30 2c20 3729 293b 0a20 2020  16(p_0, 7));.   
+0000eda0: 2020 2020 2073 756d 3120 2b3d 2078 312d       sum1 += x1-
+0000edb0: 3e64 202a 2079 312d 3e64 202a 2028 7667  >d * y1->d * (vg
+0000edc0: 6574 715f 6c61 6e65 5f73 3136 2870 5f31  etq_lane_s16(p_1
+0000edd0: 2c20 3029 202b 2076 6765 7471 5f6c 616e  , 0) + vgetq_lan
+0000ede0: 655f 7331 3628 705f 312c 2031 2920 2b20  e_s16(p_1, 1) + 
+0000edf0: 7667 6574 715f 6c61 6e65 5f73 3136 2870  vgetq_lane_s16(p
+0000ee00: 5f31 2c20 3229 202b 2076 6765 7471 5f6c  _1, 2) + vgetq_l
+0000ee10: 616e 655f 7331 3628 705f 312c 2033 2920  ane_s16(p_1, 3) 
+0000ee20: 2b20 7667 6574 715f 6c61 6e65 5f73 3136  + vgetq_lane_s16
+0000ee30: 2870 5f31 2c20 3429 202b 2076 6765 7471  (p_1, 4) + vgetq
+0000ee40: 5f6c 616e 655f 7331 3628 705f 312c 2035  _lane_s16(p_1, 5
+0000ee50: 2920 2b20 7667 6574 715f 6c61 6e65 5f73  ) + vgetq_lane_s
+0000ee60: 3136 2870 5f31 2c20 3629 202b 2076 6765  16(p_1, 6) + vge
+0000ee70: 7471 5f6c 616e 655f 7331 3628 705f 312c  tq_lane_s16(p_1,
+0000ee80: 2037 2929 3b0a 2365 6e64 6966 0a23 656e   7));.#endif.#en
+0000ee90: 6469 660a 2020 2020 7d0a 0a20 2020 2073  dif.    }..    s
+0000eea0: 756d 6620 3d20 2867 676d 6c5f 666c 6f61  umf = (ggml_floa
+0000eeb0: 7429 2873 756d 3020 2b20 7375 6d31 293b  t)(sum0 + sum1);
+0000eec0: 0a23 656c 6966 2064 6566 696e 6564 285f  .#elif defined(_
+0000eed0: 5f41 5658 3531 3246 5f5f 290a 2020 2020  _AVX512F__).    
+0000eee0: 2f2f 2049 6e69 7469 616c 697a 6520 6163  // Initialize ac
+0000eef0: 6375 6d75 6c61 746f 7220 7769 7468 207a  cumulator with z
+0000ef00: 6572 6f73 0a20 2020 205f 5f6d 3531 3220  eros.    __m512 
+0000ef10: 6163 6330 203d 205f 6d6d 3531 325f 7365  acc0 = _mm512_se
+0000ef20: 747a 6572 6f5f 7073 2829 3b0a 2020 2020  tzero_ps();.    
+0000ef30: 5f5f 6d35 3132 2061 6363 3120 3d20 5f6d  __m512 acc1 = _m
+0000ef40: 6d35 3132 5f73 6574 7a65 726f 5f70 7328  m512_setzero_ps(
+0000ef50: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
+0000ef60: 7420 7375 7065 7262 6c6f 636b 5f73 697a  t superblock_siz
+0000ef70: 6520 3d20 383b 0a20 2020 2063 6f6e 7374  e = 8;.    const
+0000ef80: 2069 6e74 2073 7570 6572 626c 6f63 6b5f   int superblock_
+0000ef90: 636f 756e 7420 3d20 6e62 202f 2073 7570  count = nb / sup
+0000efa0: 6572 626c 6f63 6b5f 7369 7a65 3b0a 2020  erblock_size;.  
+0000efb0: 2020 636f 6e73 7420 696e 7420 7265 6d61    const int rema
+0000efc0: 696e 6465 7220 3d20 6e62 2025 2073 7570  inder = nb % sup
+0000efd0: 6572 626c 6f63 6b5f 7369 7a65 3b0a 0a20  erblock_size;.. 
+0000efe0: 2020 2066 6f72 2028 696e 7420 7375 7065     for (int supe
+0000eff0: 7262 6c6f 636b 5f69 7820 3d20 303b 2073  rblock_ix = 0; s
+0000f000: 7570 6572 626c 6f63 6b5f 6978 203c 2073  uperblock_ix < s
+0000f010: 7570 6572 626c 6f63 6b5f 636f 756e 743b  uperblock_count;
+0000f020: 2073 7570 6572 626c 6f63 6b5f 6978 202b   superblock_ix +
+0000f030: 3d20 3129 207b 0a20 2020 2020 2020 2069  = 1) {.        i
+0000f040: 6e74 2069 203d 2073 7570 6572 626c 6f63  nt i = superbloc
+0000f050: 6b5f 6978 202a 2073 7570 6572 626c 6f63  k_ix * superbloc
+0000f060: 6b5f 7369 7a65 3b0a 0a20 2020 2020 2020  k_size;..       
+0000f070: 2061 6363 3020 3d20 646f 745f 7134 5f30   acc0 = dot_q4_0
+0000f080: 5f6f 6e65 626c 6f63 6b5f 6176 7835 3132  _oneblock_avx512
+0000f090: 2820 6163 6330 2c20 782c 2079 2c20 692b  ( acc0, x, y, i+
+0000f0a0: 3020 293b 0a20 2020 2020 2020 2061 6363  0 );.        acc
+0000f0b0: 3120 3d20 646f 745f 7134 5f30 5f6f 6e65  1 = dot_q4_0_one
+0000f0c0: 626c 6f63 6b5f 6176 7835 3132 2820 6163  block_avx512( ac
+0000f0d0: 6331 2c20 782c 2079 2c20 692b 3120 293b  c1, x, y, i+1 );
+0000f0e0: 0a20 2020 2020 2020 2061 6363 3020 3d20  .        acc0 = 
+0000f0f0: 646f 745f 7134 5f30 5f6f 6e65 626c 6f63  dot_q4_0_onebloc
+0000f100: 6b5f 6176 7835 3132 2820 6163 6330 2c20  k_avx512( acc0, 
+0000f110: 782c 2079 2c20 692b 3220 293b 0a20 2020  x, y, i+2 );.   
+0000f120: 2020 2020 2061 6363 3120 3d20 646f 745f       acc1 = dot_
+0000f130: 7134 5f30 5f6f 6e65 626c 6f63 6b5f 6176  q4_0_oneblock_av
+0000f140: 7835 3132 2820 6163 6331 2c20 782c 2079  x512( acc1, x, y
+0000f150: 2c20 692b 3320 293b 0a20 2020 2020 2020  , i+3 );.       
+0000f160: 2061 6363 3020 3d20 646f 745f 7134 5f30   acc0 = dot_q4_0
+0000f170: 5f6f 6e65 626c 6f63 6b5f 6176 7835 3132  _oneblock_avx512
+0000f180: 2820 6163 6330 2c20 782c 2079 2c20 692b  ( acc0, x, y, i+
+0000f190: 3420 293b 0a20 2020 2020 2020 2061 6363  4 );.        acc
+0000f1a0: 3120 3d20 646f 745f 7134 5f30 5f6f 6e65  1 = dot_q4_0_one
+0000f1b0: 626c 6f63 6b5f 6176 7835 3132 2820 6163  block_avx512( ac
+0000f1c0: 6331 2c20 782c 2079 2c20 692b 3520 293b  c1, x, y, i+5 );
+0000f1d0: 0a20 2020 2020 2020 2061 6363 3020 3d20  .        acc0 = 
+0000f1e0: 646f 745f 7134 5f30 5f6f 6e65 626c 6f63  dot_q4_0_onebloc
+0000f1f0: 6b5f 6176 7835 3132 2820 6163 6330 2c20  k_avx512( acc0, 
+0000f200: 782c 2079 2c20 692b 3620 293b 0a20 2020  x, y, i+6 );.   
+0000f210: 2020 2020 2061 6363 3120 3d20 646f 745f       acc1 = dot_
+0000f220: 7134 5f30 5f6f 6e65 626c 6f63 6b5f 6176  q4_0_oneblock_av
+0000f230: 7835 3132 2820 6163 6331 2c20 782c 2079  x512( acc1, x, y
+0000f240: 2c20 692b 3720 293b 0a20 2020 207d 0a0a  , i+7 );.    }..
+0000f250: 2020 2020 2f2f 2052 656d 6169 6e64 6572      // Remainder
+0000f260: 730a 2020 2020 666f 7220 2869 6e74 2069  s.    for (int i
+0000f270: 203d 2073 7570 6572 626c 6f63 6b5f 636f   = superblock_co
+0000f280: 756e 7420 2a20 7375 7065 7262 6c6f 636b  unt * superblock
+0000f290: 5f73 697a 653b 2069 203c 206e 623b 202b  _size; i < nb; +
+0000f2a0: 2b69 2920 7b0a 2020 2020 2020 2020 6163  +i) {.        ac
+0000f2b0: 6330 203d 2064 6f74 5f71 345f 305f 6f6e  c0 = dot_q4_0_on
+0000f2c0: 6562 6c6f 636b 5f61 7678 3531 3228 2061  eblock_avx512( a
+0000f2d0: 6363 302c 2078 2c20 792c 2069 2029 3b0a  cc0, x, y, i );.
+0000f2e0: 2020 2020 7d0a 0a20 2020 202f 2f20 486f      }..    // Ho
+0000f2f0: 7269 7a6f 6e74 616c 2073 756d 206f 6620  rizontal sum of 
+0000f300: 616c 6c20 6c61 6e65 7320 6f66 2074 6865  all lanes of the
+0000f310: 2061 6363 756d 756c 6174 6f72 0a20 2020   accumulator.   
+0000f320: 2073 756d 6620 3d20 5f6d 6d35 3132 5f72   sumf = _mm512_r
+0000f330: 6564 7563 655f 6164 645f 7073 2820 6163  educe_add_ps( ac
+0000f340: 6330 2029 202b 205f 6d6d 3531 325f 7265  c0 ) + _mm512_re
+0000f350: 6475 6365 5f61 6464 5f70 7328 2061 6363  duce_add_ps( acc
+0000f360: 3120 293b 0a23 656c 6966 2064 6566 696e  1 );.#elif defin
+0000f370: 6564 285f 5f41 5658 325f 5f29 0a20 2020  ed(__AVX2__).   
+0000f380: 202f 2f20 496e 6974 6961 6c69 7a65 2061   // Initialize a
+0000f390: 6363 756d 756c 6174 6f72 2077 6974 6820  ccumulator with 
+0000f3a0: 7a65 726f 730a 2020 2020 5f5f 6d32 3536  zeros.    __m256
+0000f3b0: 2061 6363 203d 205f 6d6d 3235 365f 7365   acc = _mm256_se
+0000f3c0: 747a 6572 6f5f 7073 2829 3b0a 0a20 2020  tzero_ps();..   
+0000f3d0: 202f 2f20 4d61 696e 206c 6f6f 700a 2020   // Main loop.  
+0000f3e0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0000f3f0: 3b20 6920 3c20 6e62 3b20 2b2b 6929 207b  ; i < nb; ++i) {
+0000f400: 0a20 2020 2020 2020 202f 2f20 436f 6d70  .        // Comp
+0000f410: 7574 6520 636f 6d62 696e 6564 2073 6361  ute combined sca
+0000f420: 6c65 2066 6f72 2074 6865 2062 6c6f 636b  le for the block
+0000f430: 0a20 2020 2020 2020 2063 6f6e 7374 205f  .        const _
+0000f440: 5f6d 3235 3620 6420 3d20 5f6d 6d32 3536  _m256 d = _mm256
+0000f450: 5f6d 756c 5f70 7328 205f 6d6d 3235 365f  _mul_ps( _mm256_
+0000f460: 6272 6f61 6463 6173 745f 7373 2820 2678  broadcast_ss( &x
+0000f470: 5b69 5d2e 6420 292c 205f 6d6d 3235 365f  [i].d ), _mm256_
+0000f480: 6272 6f61 6463 6173 745f 7373 2820 2679  broadcast_ss( &y
+0000f490: 5b69 5d2e 6420 2920 293b 0a0a 2020 2020  [i].d ) );..    
+0000f4a0: 2020 2020 2f2f 204c 6f61 6420 3136 2062      // Load 16 b
+0000f4b0: 7974 6573 2c20 616e 6420 756e 7061 636b  ytes, and unpack
+0000f4c0: 2034 2062 6974 2066 6965 6c64 7320 696e   4 bit fields in
+0000f4d0: 746f 2062 7974 6573 2c20 6d61 6b69 6e67  to bytes, making
+0000f4e0: 2033 3220 6279 7465 730a 2020 2020 2020   32 bytes.      
+0000f4f0: 2020 5f5f 6d32 3536 6920 6278 203d 2062    __m256i bx = b
+0000f500: 7974 6573 4672 6f6d 4e69 6262 6c65 7328  ytesFromNibbles(
+0000f510: 2078 5b69 5d2e 7173 2029 3b0a 2020 2020   x[i].qs );.    
+0000f520: 2020 2020 5f5f 6d32 3536 6920 6279 203d      __m256i by =
+0000f530: 2062 7974 6573 4672 6f6d 4e69 6262 6c65   bytesFromNibble
+0000f540: 7328 2079 5b69 5d2e 7173 2029 3b0a 0a20  s( y[i].qs );.. 
+0000f550: 2020 2020 2020 202f 2f20 4e6f 7720 7765         // Now we
+0000f560: 2068 6176 6520 6120 7665 6374 6f72 2077   have a vector w
+0000f570: 6974 6820 6279 7465 7320 696e 205b 2030  ith bytes in [ 0
+0000f580: 202e 2e20 3135 205d 2069 6e74 6572 7661   .. 15 ] interva
+0000f590: 6c2e 204f 6666 7365 7420 7468 656d 2069  l. Offset them i
+0000f5a0: 6e74 6f20 5b20 2d38 202e 2e20 2b37 205d  nto [ -8 .. +7 ]
+0000f5b0: 2069 6e74 6572 7661 6c2e 0a20 2020 2020   interval..     
+0000f5c0: 2020 2063 6f6e 7374 205f 5f6d 3235 3669     const __m256i
+0000f5d0: 206f 6666 203d 205f 6d6d 3235 365f 7365   off = _mm256_se
+0000f5e0: 7431 5f65 7069 3828 2038 2029 3b0a 2020  t1_epi8( 8 );.  
+0000f5f0: 2020 2020 2020 6278 203d 205f 6d6d 3235        bx = _mm25
+0000f600: 365f 7375 625f 6570 6938 2820 6278 2c20  6_sub_epi8( bx, 
+0000f610: 6f66 6620 293b 0a20 2020 2020 2020 2062  off );.        b
+0000f620: 7920 3d20 5f6d 6d32 3536 5f73 7562 5f65  y = _mm256_sub_e
+0000f630: 7069 3828 2062 792c 206f 6666 2029 3b0a  pi8( by, off );.
+0000f640: 0a20 2020 2020 2020 202f 2f20 5369 676e  .        // Sign
+0000f650: 2d65 7874 656e 6420 6669 7273 7420 3136  -extend first 16
+0000f660: 2073 6967 6e65 6420 6279 7465 7320 696e   signed bytes in
+0000f670: 746f 2069 6e74 3136 5f74 0a20 2020 2020  to int16_t.     
+0000f680: 2020 205f 5f6d 3235 3669 2078 3136 203d     __m256i x16 =
+0000f690: 205f 6d6d 3235 365f 6376 7465 7069 385f   _mm256_cvtepi8_
+0000f6a0: 6570 6931 3628 205f 6d6d 3235 365f 6361  epi16( _mm256_ca
+0000f6b0: 7374 7369 3235 365f 7369 3132 3828 2062  stsi256_si128( b
+0000f6c0: 7820 2920 293b 0a20 2020 2020 2020 205f  x ) );.        _
+0000f6d0: 5f6d 3235 3669 2079 3136 203d 205f 6d6d  _m256i y16 = _mm
+0000f6e0: 3235 365f 6376 7465 7069 385f 6570 6931  256_cvtepi8_epi1
+0000f6f0: 3628 205f 6d6d 3235 365f 6361 7374 7369  6( _mm256_castsi
+0000f700: 3235 365f 7369 3132 3828 2062 7920 2920  256_si128( by ) 
+0000f710: 293b 0a20 2020 2020 2020 202f 2f20 436f  );.        // Co
+0000f720: 6d70 7574 6520 7072 6f64 7563 7473 206f  mpute products o
+0000f730: 6620 696e 7431 365f 7420 696e 7465 6765  f int16_t intege
+0000f740: 7273 2c20 6164 6420 7061 6972 7769 7365  rs, add pairwise
+0000f750: 0a20 2020 2020 2020 205f 5f6d 3235 3669  .        __m256i
+0000f760: 2069 3332 203d 205f 6d6d 3235 365f 6d61   i32 = _mm256_ma
+0000f770: 6464 5f65 7069 3136 2820 7831 362c 2079  dd_epi16( x16, y
+0000f780: 3136 2029 3b0a 0a20 2020 2020 2020 202f  16 );..        /
+0000f790: 2f20 5369 676e 2d65 7874 656e 6420 6c61  / Sign-extend la
+0000f7a0: 7374 2031 3620 7369 676e 6564 2062 7974  st 16 signed byt
+0000f7b0: 6573 2069 6e74 6f20 696e 7431 365f 7420  es into int16_t 
+0000f7c0: 7665 6374 6f72 730a 2020 2020 2020 2020  vectors.        
+0000f7d0: 7831 3620 3d20 5f6d 6d32 3536 5f63 7674  x16 = _mm256_cvt
+0000f7e0: 6570 6938 5f65 7069 3136 2820 5f6d 6d32  epi8_epi16( _mm2
+0000f7f0: 3536 5f65 7874 7261 6374 6931 3238 5f73  56_extracti128_s
+0000f800: 6932 3536 2820 6278 2c20 3120 2920 293b  i256( bx, 1 ) );
+0000f810: 0a20 2020 2020 2020 2079 3136 203d 205f  .        y16 = _
+0000f820: 6d6d 3235 365f 6376 7465 7069 385f 6570  mm256_cvtepi8_ep
+0000f830: 6931 3628 205f 6d6d 3235 365f 6578 7472  i16( _mm256_extr
+0000f840: 6163 7469 3132 385f 7369 3235 3628 2062  acti128_si256( b
+0000f850: 792c 2031 2029 2029 3b0a 2020 2020 2020  y, 1 ) );.      
+0000f860: 2020 2f2f 2041 6363 756d 756c 6174 6520    // Accumulate 
+0000f870: 7072 6f64 7563 7473 206f 6620 696e 7431  products of int1
+0000f880: 365f 7420 696e 7465 6765 7273 0a20 2020  6_t integers.   
+0000f890: 2020 2020 2069 3332 203d 205f 6d6d 3235       i32 = _mm25
+0000f8a0: 365f 6164 645f 6570 6933 3228 2069 3332  6_add_epi32( i32
+0000f8b0: 2c20 5f6d 6d32 3536 5f6d 6164 645f 6570  , _mm256_madd_ep
+0000f8c0: 6931 3628 2078 3136 2c20 7931 3620 2920  i16( x16, y16 ) 
+0000f8d0: 293b 0a0a 2020 2020 2020 2020 2f2f 2043  );..        // C
+0000f8e0: 6f6e 7665 7274 2069 6e74 3332 5f74 2074  onvert int32_t t
+0000f8f0: 6f20 666c 6f61 740a 2020 2020 2020 2020  o float.        
+0000f900: 5f5f 6d32 3536 2070 203d 205f 6d6d 3235  __m256 p = _mm25
+0000f910: 365f 6376 7465 7069 3332 5f70 7328 2069  6_cvtepi32_ps( i
+0000f920: 3332 2029 3b0a 2020 2020 2020 2020 2f2f  32 );.        //
+0000f930: 2041 7070 6c79 2074 6865 2073 6361 6c65   Apply the scale
+0000f940: 2c20 616e 6420 6163 6375 6d75 6c61 7465  , and accumulate
+0000f950: 0a20 2020 2020 2020 2061 6363 203d 205f  .        acc = _
+0000f960: 6d6d 3235 365f 666d 6164 645f 7073 2820  mm256_fmadd_ps( 
+0000f970: 642c 2070 2c20 6163 6320 293b 0a20 2020  d, p, acc );.   
+0000f980: 207d 0a0a 2020 2020 2f2f 2052 6574 7572   }..    // Retur
+0000f990: 6e20 686f 7269 7a6f 6e74 616c 2073 756d  n horizontal sum
+0000f9a0: 206f 6620 7468 6520 6163 6320 7665 6374   of the acc vect
+0000f9b0: 6f72 0a20 2020 205f 5f6d 3132 3820 7265  or.    __m128 re
+0000f9c0: 7320 3d20 5f6d 6d32 3536 5f65 7874 7261  s = _mm256_extra
+0000f9d0: 6374 6631 3238 5f70 7328 2061 6363 2c20  ctf128_ps( acc, 
+0000f9e0: 3120 293b 0a20 2020 2072 6573 203d 205f  1 );.    res = _
+0000f9f0: 6d6d 5f61 6464 5f70 7328 2072 6573 2c20  mm_add_ps( res, 
+0000fa00: 5f6d 6d32 3536 5f63 6173 7470 7332 3536  _mm256_castps256
+0000fa10: 5f70 7331 3238 2820 6163 6320 2920 293b  _ps128( acc ) );
+0000fa20: 0a20 2020 2072 6573 203d 205f 6d6d 5f61  .    res = _mm_a
+0000fa30: 6464 5f70 7328 2072 6573 2c20 5f6d 6d5f  dd_ps( res, _mm_
+0000fa40: 6d6f 7665 686c 5f70 7328 2072 6573 2c20  movehl_ps( res, 
+0000fa50: 7265 7320 2920 293b 0a20 2020 2072 6573  res ) );.    res
+0000fa60: 203d 205f 6d6d 5f61 6464 5f73 7328 2072   = _mm_add_ss( r
+0000fa70: 6573 2c20 5f6d 6d5f 6d6f 7665 6864 7570  es, _mm_movehdup
+0000fa80: 5f70 7328 2072 6573 2029 2029 3b0a 0a20  _ps( res ) );.. 
+0000fa90: 2020 2073 756d 6620 3d20 5f6d 6d5f 6376     sumf = _mm_cv
+0000faa0: 7473 735f 6633 3228 2072 6573 2029 3b0a  tss_f32( res );.
+0000fab0: 2365 6c69 6620 6465 6669 6e65 6428 5f5f  #elif defined(__
+0000fac0: 7761 736d 5f73 696d 6431 3238 5f5f 290a  wasm_simd128__).
+0000fad0: 2020 2020 2f2f 2077 6173 6d20 7369 6d64      // wasm simd
+0000fae0: 0a20 2020 2066 6c6f 6174 2073 756d 3020  .    float sum0 
+0000faf0: 3d20 302e 3066 3b0a 2020 2020 666c 6f61  = 0.0f;.    floa
+0000fb00: 7420 7375 6d31 203d 2030 2e30 663b 0a0a  t sum1 = 0.0f;..
+0000fb10: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0000fb20: 2030 3b20 6920 3c20 6e62 3b20 6920 2b3d   0; i < nb; i +=
+0000fb30: 2032 2920 7b0a 2020 2020 2020 2020 636f   2) {.        co
+0000fb40: 6e73 7420 626c 6f63 6b5f 7134 5f30 202a  nst block_q4_0 *
+0000fb50: 2072 6573 7472 6963 7420 7830 203d 2026   restrict x0 = &
+0000fb60: 7078 5b69 202b 2030 5d3b 0a20 2020 2020  px[i + 0];.     
+0000fb70: 2020 2063 6f6e 7374 2062 6c6f 636b 5f71     const block_q
+0000fb80: 345f 3020 2a20 7265 7374 7269 6374 2079  4_0 * restrict y
+0000fb90: 3020 3d20 2670 795b 6920 2b20 305d 3b0a  0 = &py[i + 0];.
+0000fba0: 2020 2020 2020 2020 636f 6e73 7420 626c          const bl
+0000fbb0: 6f63 6b5f 7134 5f30 202a 2072 6573 7472  ock_q4_0 * restr
+0000fbc0: 6963 7420 7831 203d 2026 7078 5b69 202b  ict x1 = &px[i +
+0000fbd0: 2031 5d3b 0a20 2020 2020 2020 2063 6f6e   1];.        con
+0000fbe0: 7374 2062 6c6f 636b 5f71 345f 3020 2a20  st block_q4_0 * 
+0000fbf0: 7265 7374 7269 6374 2079 3120 3d20 2670  restrict y1 = &p
+0000fc00: 795b 6920 2b20 315d 3b0a 0a20 2020 2020  y[i + 1];..     
+0000fc10: 2020 2063 6f6e 7374 2076 3132 385f 7420     const v128_t 
+0000fc20: 6d34 6220 3d20 7761 736d 5f75 3878 3136  m4b = wasm_u8x16
+0000fc30: 5f73 706c 6174 2830 7866 293b 0a20 2020  _splat(0xf);.   
+0000fc40: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
+0000fc50: 7420 7338 6220 3d20 7761 736d 5f69 3878  t s8b = wasm_i8x
+0000fc60: 3136 5f73 706c 6174 2830 7838 293b 0a0a  16_splat(0x8);..
+0000fc70: 2020 2020 2020 2020 636f 6e73 7420 7631          const v1
+0000fc80: 3238 5f74 2076 305f 3020 3d20 7761 736d  28_t v0_0 = wasm
+0000fc90: 5f76 3132 385f 6c6f 6164 2878 302e 7173  _v128_load(x0.qs
+0000fca0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0000fcb0: 2076 3132 385f 7420 7630 5f31 203d 2077   v128_t v0_1 = w
+0000fcc0: 6173 6d5f 7631 3238 5f6c 6f61 6428 7930  asm_v128_load(y0
+0000fcd0: 2e71 7329 3b0a 2020 2020 2020 2020 636f  .qs);.        co
+0000fce0: 6e73 7420 7631 3238 5f74 2076 315f 3020  nst v128_t v1_0 
+0000fcf0: 3d20 7761 736d 5f76 3132 385f 6c6f 6164  = wasm_v128_load
+0000fd00: 2878 312e 7173 293b 0a20 2020 2020 2020  (x1.qs);.       
+0000fd10: 2063 6f6e 7374 2076 3132 385f 7420 7631   const v128_t v1
+0000fd20: 5f31 203d 2077 6173 6d5f 7631 3238 5f6c  _1 = wasm_v128_l
+0000fd30: 6f61 6428 7931 2e71 7329 3b0a 0a20 2020  oad(y1.qs);..   
+0000fd40: 2020 2020 202f 2f20 342d 6269 7420 2d3e       // 4-bit ->
+0000fd50: 2038 2d62 6974 0a20 2020 2020 2020 2063   8-bit.        c
+0000fd60: 6f6e 7374 2076 3132 385f 7420 7630 5f30  onst v128_t v0_0
+0000fd70: 6c20 3d20 7761 736d 5f76 3132 385f 616e  l = wasm_v128_an
+0000fd80: 6428 7630 5f30 2c20 6d34 6229 3b0a 2020  d(v0_0, m4b);.  
+0000fd90: 2020 2020 2020 636f 6e73 7420 7631 3238        const v128
+0000fda0: 5f74 2076 315f 306c 203d 2077 6173 6d5f  _t v1_0l = wasm_
+0000fdb0: 7631 3238 5f61 6e64 2876 315f 302c 206d  v128_and(v1_0, m
+0000fdc0: 3462 293b 0a0a 2020 2020 2020 2020 636f  4b);..        co
+0000fdd0: 6e73 7420 7631 3238 5f74 2076 305f 3068  nst v128_t v0_0h
+0000fde0: 203d 2077 6173 6d5f 7538 7831 365f 7368   = wasm_u8x16_sh
+0000fdf0: 7228 7630 5f30 2c20 3429 3b0a 2020 2020  r(v0_0, 4);.    
+0000fe00: 2020 2020 636f 6e73 7420 7631 3238 5f74      const v128_t
+0000fe10: 2076 315f 3068 203d 2077 6173 6d5f 7538   v1_0h = wasm_u8
+0000fe20: 7831 365f 7368 7228 7631 5f30 2c20 3429  x16_shr(v1_0, 4)
+0000fe30: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
+0000fe40: 2076 3132 385f 7420 7630 5f31 6c20 3d20   v128_t v0_1l = 
+0000fe50: 7761 736d 5f76 3132 385f 616e 6428 7630  wasm_v128_and(v0
+0000fe60: 5f31 2c20 6d34 6229 3b0a 2020 2020 2020  _1, m4b);.      
+0000fe70: 2020 636f 6e73 7420 7631 3238 5f74 2076    const v128_t v
+0000fe80: 315f 316c 203d 2077 6173 6d5f 7631 3238  1_1l = wasm_v128
+0000fe90: 5f61 6e64 2876 315f 312c 206d 3462 293b  _and(v1_1, m4b);
+0000fea0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+0000feb0: 7631 3238 5f74 2076 305f 3168 203d 2077  v128_t v0_1h = w
+0000fec0: 6173 6d5f 7538 7831 365f 7368 7228 7630  asm_u8x16_shr(v0
+0000fed0: 5f31 2c20 3429 3b0a 2020 2020 2020 2020  _1, 4);.        
+0000fee0: 636f 6e73 7420 7631 3238 5f74 2076 315f  const v128_t v1_
+0000fef0: 3168 203d 2077 6173 6d5f 7538 7831 365f  1h = wasm_u8x16_
+0000ff00: 7368 7228 7631 5f31 2c20 3429 3b0a 0a20  shr(v1_1, 4);.. 
+0000ff10: 2020 2020 2020 202f 2f20 7375 6220 380a         // sub 8.
+0000ff20: 2020 2020 2020 2020 636f 6e73 7420 7631          const v1
+0000ff30: 3238 5f74 2076 305f 306c 7320 3d20 7761  28_t v0_0ls = wa
+0000ff40: 736d 5f69 3878 3136 5f73 7562 2876 305f  sm_i8x16_sub(v0_
+0000ff50: 306c 2c20 7338 6229 3b0a 2020 2020 2020  0l, s8b);.      
+0000ff60: 2020 636f 6e73 7420 7631 3238 5f74 2076    const v128_t v
+0000ff70: 315f 306c 7320 3d20 7761 736d 5f69 3878  1_0ls = wasm_i8x
+0000ff80: 3136 5f73 7562 2876 315f 306c 2c20 7338  16_sub(v1_0l, s8
+0000ff90: 6229 3b0a 0a20 2020 2020 2020 2063 6f6e  b);..        con
+0000ffa0: 7374 2076 3132 385f 7420 7630 5f30 6873  st v128_t v0_0hs
+0000ffb0: 203d 2077 6173 6d5f 6938 7831 365f 7375   = wasm_i8x16_su
+0000ffc0: 6228 7630 5f30 682c 2073 3862 293b 0a20  b(v0_0h, s8b);. 
+0000ffd0: 2020 2020 2020 2063 6f6e 7374 2076 3132         const v12
+0000ffe0: 385f 7420 7631 5f30 6873 203d 2077 6173  8_t v1_0hs = was
+0000fff0: 6d5f 6938 7831 365f 7375 6228 7631 5f30  m_i8x16_sub(v1_0
+00010000: 682c 2073 3862 293b 0a0a 2020 2020 2020  h, s8b);..      
+00010010: 2020 636f 6e73 7420 7631 3238 5f74 2076    const v128_t v
+00010020: 305f 316c 7320 3d20 7761 736d 5f69 3878  0_1ls = wasm_i8x
+00010030: 3136 5f73 7562 2876 305f 316c 2c20 7338  16_sub(v0_1l, s8
+00010040: 6229 3b0a 2020 2020 2020 2020 636f 6e73  b);.        cons
+00010050: 7420 7631 3238 5f74 2076 315f 316c 7320  t v128_t v1_1ls 
+00010060: 3d20 7761 736d 5f69 3878 3136 5f73 7562  = wasm_i8x16_sub
+00010070: 2876 315f 316c 2c20 7338 6229 3b0a 0a20  (v1_1l, s8b);.. 
+00010080: 2020 2020 2020 2063 6f6e 7374 2076 3132         const v12
+00010090: 385f 7420 7630 5f31 6873 203d 2077 6173  8_t v0_1hs = was
+000100a0: 6d5f 6938 7831 365f 7375 6228 7630 5f31  m_i8x16_sub(v0_1
+000100b0: 682c 2073 3862 293b 0a20 2020 2020 2020  h, s8b);.       
+000100c0: 2063 6f6e 7374 2076 3132 385f 7420 7631   const v128_t v1
+000100d0: 5f31 6873 203d 2077 6173 6d5f 6938 7831  _1hs = wasm_i8x1
+000100e0: 365f 7375 6228 7631 5f31 682c 2073 3862  6_sub(v1_1h, s8b
+000100f0: 293b 0a0a 2020 2020 2020 2020 2f2f 2064  );..        // d
+00010100: 6f74 2070 726f 6475 6374 2069 6e74 6f20  ot product into 
+00010110: 696e 7431 3678 385f 740a 2020 2020 2020  int16x8_t.      
+00010120: 2020 636f 6e73 7420 7631 3238 5f74 2070    const v128_t p
+00010130: 6c30 6c20 3d20 7761 736d 5f69 3136 7838  l0l = wasm_i16x8
+00010140: 5f6d 756c 2877 6173 6d5f 6931 3678 385f  _mul(wasm_i16x8_
+00010150: 6578 7465 6e64 5f6c 6f77 5f69 3878 3136  extend_low_i8x16
+00010160: 2876 305f 306c 7329 2c20 7761 736d 5f69  (v0_0ls), wasm_i
+00010170: 3136 7838 5f65 7874 656e 645f 6c6f 775f  16x8_extend_low_
+00010180: 6938 7831 3628 7631 5f30 6c73 2929 3b0a  i8x16(v1_0ls));.
+00010190: 2020 2020 2020 2020 636f 6e73 7420 7631          const v1
+000101a0: 3238 5f74 2070 6c30 6820 3d20 7761 736d  28_t pl0h = wasm
+000101b0: 5f69 3136 7838 5f6d 756c 2877 6173 6d5f  _i16x8_mul(wasm_
+000101c0: 6931 3678 385f 6578 7465 6e64 5f68 6967  i16x8_extend_hig
+000101d0: 685f 6938 7831 3628 7630 5f30 6c73 292c  h_i8x16(v0_0ls),
+000101e0: 2077 6173 6d5f 6931 3678 385f 6578 7465   wasm_i16x8_exte
+000101f0: 6e64 5f68 6967 685f 6938 7831 3628 7631  nd_high_i8x16(v1
+00010200: 5f30 6c73 2929 3b0a 0a20 2020 2020 2020  _0ls));..       
+00010210: 2063 6f6e 7374 2076 3132 385f 7420 7068   const v128_t ph
+00010220: 306c 203d 2077 6173 6d5f 6931 3678 385f  0l = wasm_i16x8_
+00010230: 6d75 6c28 7761 736d 5f69 3136 7838 5f65  mul(wasm_i16x8_e
+00010240: 7874 656e 645f 6c6f 775f 6938 7831 3628  xtend_low_i8x16(
+00010250: 7630 5f30 6873 292c 2077 6173 6d5f 6931  v0_0hs), wasm_i1
+00010260: 3678 385f 6578 7465 6e64 5f6c 6f77 5f69  6x8_extend_low_i
+00010270: 3878 3136 2876 315f 3068 7329 293b 0a20  8x16(v1_0hs));. 
+00010280: 2020 2020 2020 2063 6f6e 7374 2076 3132         const v12
+00010290: 385f 7420 7068 3068 203d 2077 6173 6d5f  8_t ph0h = wasm_
+000102a0: 6931 3678 385f 6d75 6c28 7761 736d 5f69  i16x8_mul(wasm_i
+000102b0: 3136 7838 5f65 7874 656e 645f 6869 6768  16x8_extend_high
+000102c0: 5f69 3878 3136 2876 305f 3068 7329 2c20  _i8x16(v0_0hs), 
+000102d0: 7761 736d 5f69 3136 7838 5f65 7874 656e  wasm_i16x8_exten
+000102e0: 645f 6869 6768 5f69 3878 3136 2876 315f  d_high_i8x16(v1_
+000102f0: 3068 7329 293b 0a0a 2020 2020 2020 2020  0hs));..        
+00010300: 636f 6e73 7420 7631 3238 5f74 2070 6c31  const v128_t pl1
+00010310: 6c20 3d20 7761 736d 5f69 3136 7838 5f6d  l = wasm_i16x8_m
+00010320: 756c 2877 6173 6d5f 6931 3678 385f 6578  ul(wasm_i16x8_ex
+00010330: 7465 6e64 5f6c 6f77 5f69 3878 3136 2876  tend_low_i8x16(v
+00010340: 305f 316c 7329 2c20 7761 736d 5f69 3136  0_1ls), wasm_i16
+00010350: 7838 5f65 7874 656e 645f 6c6f 775f 6938  x8_extend_low_i8
+00010360: 7831 3628 7631 5f31 6c73 2929 3b0a 2020  x16(v1_1ls));.  
+00010370: 2020 2020 2020 636f 6e73 7420 7631 3238        const v128
+00010380: 5f74 2070 6c31 6820 3d20 7761 736d 5f69  _t pl1h = wasm_i
+00010390: 3136 7838 5f6d 756c 2877 6173 6d5f 6931  16x8_mul(wasm_i1
+000103a0: 3678 385f 6578 7465 6e64 5f68 6967 685f  6x8_extend_high_
+000103b0: 6938 7831 3628 7630 5f31 6c73 292c 2077  i8x16(v0_1ls), w
+000103c0: 6173 6d5f 6931 3678 385f 6578 7465 6e64  asm_i16x8_extend
+000103d0: 5f68 6967 685f 6938 7831 3628 7631 5f31  _high_i8x16(v1_1
+000103e0: 6c73 2929 3b0a 0a20 2020 2020 2020 2063  ls));..        c
+000103f0: 6f6e 7374 2076 3132 385f 7420 7068 316c  onst v128_t ph1l
+00010400: 203d 2077 6173 6d5f 6931 3678 385f 6d75   = wasm_i16x8_mu
+00010410: 6c28 7761 736d 5f69 3136 7838 5f65 7874  l(wasm_i16x8_ext
+00010420: 656e 645f 6c6f 775f 6938 7831 3628 7630  end_low_i8x16(v0
+00010430: 5f31 6873 292c 2077 6173 6d5f 6931 3678  _1hs), wasm_i16x
+00010440: 385f 6578 7465 6e64 5f6c 6f77 5f69 3878  8_extend_low_i8x
+00010450: 3136 2876 315f 3168 7329 293b 0a20 2020  16(v1_1hs));.   
+00010460: 2020 2020 2063 6f6e 7374 2076 3132 385f       const v128_
+00010470: 7420 7068 3168 203d 2077 6173 6d5f 6931  t ph1h = wasm_i1
+00010480: 3678 385f 6d75 6c28 7761 736d 5f69 3136  6x8_mul(wasm_i16
+00010490: 7838 5f65 7874 656e 645f 6869 6768 5f69  x8_extend_high_i
+000104a0: 3878 3136 2876 305f 3168 7329 2c20 7761  8x16(v0_1hs), wa
+000104b0: 736d 5f69 3136 7838 5f65 7874 656e 645f  sm_i16x8_extend_
+000104c0: 6869 6768 5f69 3878 3136 2876 315f 3168  high_i8x16(v1_1h
+000104d0: 7329 293b 0a0a 2020 2020 2020 2020 636f  s));..        co
+000104e0: 6e73 7420 7631 3238 5f74 2070 6c5f 3020  nst v128_t pl_0 
+000104f0: 3d20 7761 736d 5f69 3136 7838 5f61 6464  = wasm_i16x8_add
+00010500: 2870 6c30 6c2c 2070 6c30 6829 3b0a 2020  (pl0l, pl0h);.  
+00010510: 2020 2020 2020 636f 6e73 7420 7631 3238        const v128
+00010520: 5f74 2070 685f 3020 3d20 7761 736d 5f69  _t ph_0 = wasm_i
+00010530: 3136 7838 5f61 6464 2870 6830 6c2c 2070  16x8_add(ph0l, p
+00010540: 6830 6829 3b0a 0a20 2020 2020 2020 2063  h0h);..        c
+00010550: 6f6e 7374 2076 3132 385f 7420 706c 5f31  onst v128_t pl_1
+00010560: 203d 2077 6173 6d5f 6931 3678 385f 6164   = wasm_i16x8_ad
+00010570: 6428 706c 316c 2c20 706c 3168 293b 0a20  d(pl1l, pl1h);. 
+00010580: 2020 2020 2020 2063 6f6e 7374 2076 3132         const v12
+00010590: 385f 7420 7068 5f31 203d 2077 6173 6d5f  8_t ph_1 = wasm_
+000105a0: 6931 3678 385f 6164 6428 7068 316c 2c20  i16x8_add(ph1l, 
+000105b0: 7068 3168 293b 0a0a 2020 2020 2020 2020  ph1h);..        
+000105c0: 636f 6e73 7420 7631 3238 5f74 2070 5f30  const v128_t p_0
+000105d0: 203d 2077 6173 6d5f 6931 3678 385f 6164   = wasm_i16x8_ad
+000105e0: 6428 706c 5f30 2c20 7068 5f30 293b 0a20  d(pl_0, ph_0);. 
+000105f0: 2020 2020 2020 2063 6f6e 7374 2076 3132         const v12
+00010600: 385f 7420 705f 3120 3d20 7761 736d 5f69  8_t p_1 = wasm_i
+00010610: 3136 7838 5f61 6464 2870 6c5f 312c 2070  16x8_add(pl_1, p
+00010620: 685f 3129 3b0a 0a20 2020 2020 2020 2073  h_1);..        s
+00010630: 756d 3020 2b3d 2078 302d 3e64 202a 2079  um0 += x0->d * y
+00010640: 302d 3e64 202a 2028 0a20 2020 2020 2020  0->d * (.       
+00010650: 2020 2020 2020 2020 2077 6173 6d5f 6931           wasm_i1
+00010660: 3678 385f 6578 7472 6163 745f 6c61 6e65  6x8_extract_lane
+00010670: 2870 5f30 2c20 3029 202b 2077 6173 6d5f  (p_0, 0) + wasm_
+00010680: 6931 3678 385f 6578 7472 6163 745f 6c61  i16x8_extract_la
+00010690: 6e65 2870 5f30 2c20 3129 202b 0a20 2020  ne(p_0, 1) +.   
+000106a0: 2020 2020 2020 2020 2020 2020 2077 6173               was
+000106b0: 6d5f 6931 3678 385f 6578 7472 6163 745f  m_i16x8_extract_
+000106c0: 6c61 6e65 2870 5f30 2c20 3229 202b 2077  lane(p_0, 2) + w
+000106d0: 6173 6d5f 6931 3678 385f 6578 7472 6163  asm_i16x8_extrac
+000106e0: 745f 6c61 6e65 2870 5f30 2c20 3329 202b  t_lane(p_0, 3) +
+000106f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010700: 2077 6173 6d5f 6931 3678 385f 6578 7472   wasm_i16x8_extr
+00010710: 6163 745f 6c61 6e65 2870 5f30 2c20 3429  act_lane(p_0, 4)
+00010720: 202b 2077 6173 6d5f 6931 3678 385f 6578   + wasm_i16x8_ex
+00010730: 7472 6163 745f 6c61 6e65 2870 5f30 2c20  tract_lane(p_0, 
+00010740: 3529 202b 0a20 2020 2020 2020 2020 2020  5) +.           
+00010750: 2020 2020 2077 6173 6d5f 6931 3678 385f       wasm_i16x8_
+00010760: 6578 7472 6163 745f 6c61 6e65 2870 5f30  extract_lane(p_0
+00010770: 2c20 3629 202b 2077 6173 6d5f 6931 3678  , 6) + wasm_i16x
+00010780: 385f 6578 7472 6163 745f 6c61 6e65 2870  8_extract_lane(p
+00010790: 5f30 2c20 3729 293b 0a20 2020 2020 2020  _0, 7));.       
+000107a0: 2073 756d 3120 2b3d 2078 312d 3e64 202a   sum1 += x1->d *
+000107b0: 2079 312d 3e64 202a 2028 0a20 2020 2020   y1->d * (.     
+000107c0: 2020 2020 2020 2020 2020 2077 6173 6d5f             wasm_
+000107d0: 6931 3678 385f 6578 7472 6163 745f 6c61  i16x8_extract_la
+000107e0: 6e65 2870 5f31 2c20 3029 202b 2077 6173  ne(p_1, 0) + was
+000107f0: 6d5f 6931 3678 385f 6578 7472 6163 745f  m_i16x8_extract_
+00010800: 6c61 6e65 2870 5f31 2c20 3129 202b 0a20  lane(p_1, 1) +. 
+00010810: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00010820: 6173 6d5f 6931 3678 385f 6578 7472 6163  asm_i16x8_extrac
+00010830: 745f 6c61 6e65 2870 5f31 2c20 3229 202b  t_lane(p_1, 2) +
+00010840: 2077 6173 6d5f 6931 3678 385f 6578 7472   wasm_i16x8_extr
+00010850: 6163 745f 6c61 6e65 2870 5f31 2c20 3329  act_lane(p_1, 3)
+00010860: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+00010870: 2020 2077 6173 6d5f 6931 3678 385f 6578     wasm_i16x8_ex
+00010880: 7472 6163 745f 6c61 6e65 2870 5f31 2c20  tract_lane(p_1, 
+00010890: 3429 202b 2077 6173 6d5f 6931 3678 385f  4) + wasm_i16x8_
+000108a0: 6578 7472 6163 745f 6c61 6e65 2870 5f31  extract_lane(p_1
+000108b0: 2c20 3529 202b 0a20 2020 2020 2020 2020  , 5) +.         
+000108c0: 2020 2020 2020 2077 6173 6d5f 6931 3678         wasm_i16x
+000108d0: 385f 6578 7472 6163 745f 6c61 6e65 2870  8_extract_lane(p
+000108e0: 5f31 2c20 3629 202b 2077 6173 6d5f 6931  _1, 6) + wasm_i1
+000108f0: 3678 385f 6578 7472 6163 745f 6c61 6e65  6x8_extract_lane
+00010900: 2870 5f31 2c20 3729 293b 0a20 2020 207d  (p_1, 7));.    }
+00010910: 0a0a 2020 2020 7375 6d66 203d 2073 756d  ..    sumf = sum
+00010920: 3020 2b20 7375 6d31 3b0a 2365 6c73 650a  0 + sum1;.#else.
+00010930: 2020 2020 2f2f 2073 6361 6c61 720a 2020      // scalar.  
+00010940: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00010950: 3b20 6920 3c20 6e62 3b20 692b 2b29 207b  ; i < nb; i++) {
+00010960: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
+00010970: 6c6f 6174 2064 3020 3d20 785b 695d 2e64  loat d0 = x[i].d
+00010980: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+00010990: 666c 6f61 7420 6431 203d 2079 5b69 5d2e  float d1 = y[i].
+000109a0: 643b 0a0a 2020 2020 2020 2020 636f 6e73  d;..        cons
+000109b0: 7420 7569 6e74 385f 7420 2a20 7265 7374  t uint8_t * rest
+000109c0: 7269 6374 2070 3020 3d20 785b 695d 2e71  rict p0 = x[i].q
+000109d0: 733b 0a20 2020 2020 2020 2063 6f6e 7374  s;.        const
+000109e0: 2075 696e 7438 5f74 202a 2072 6573 7472   uint8_t * restr
+000109f0: 6963 7420 7031 203d 2079 5b69 5d2e 7173  ict p1 = y[i].qs
+00010a00: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
+00010a10: 696e 7420 6a20 3d20 303b 206a 203c 2051  int j = 0; j < Q
+00010a20: 4b2f 323b 206a 2b2b 2920 7b0a 2020 2020  K/2; j++) {.    
+00010a30: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+00010a40: 6e74 385f 7420 7630 203d 2070 305b 6a5d  nt8_t v0 = p0[j]
+00010a50: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00010a60: 6e73 7420 7569 6e74 385f 7420 7631 203d  nst uint8_t v1 =
+00010a70: 2070 315b 6a5d 3b0a 0a20 2020 2020 2020   p1[j];..       
+00010a80: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00010a90: 2066 3020 3d20 6430 2a28 2869 6e74 385f   f0 = d0*((int8_
+00010aa0: 7429 2028 7630 2026 2030 7866 2920 2d20  t) (v0 & 0xf) - 
+00010ab0: 3829 3b0a 2020 2020 2020 2020 2020 2020  8);.            
+00010ac0: 636f 6e73 7420 666c 6f61 7420 6631 203d  const float f1 =
+00010ad0: 2064 302a 2828 696e 7438 5f74 2920 2876   d0*((int8_t) (v
+00010ae0: 3020 3e3e 2034 2920 202d 2038 293b 0a0a  0 >> 4)  - 8);..
+00010af0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00010b00: 7420 666c 6f61 7420 6632 203d 2064 312a  t float f2 = d1*
+00010b10: 2828 696e 7438 5f74 2920 2876 3120 2620  ((int8_t) (v1 & 
+00010b20: 3078 6629 202d 2038 293b 0a20 2020 2020  0xf) - 8);.     
+00010b30: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+00010b40: 6174 2066 3320 3d20 6431 2a28 2869 6e74  at f3 = d1*((int
+00010b50: 385f 7429 2028 7631 203e 3e20 3429 2020  8_t) (v1 >> 4)  
+00010b60: 2d20 3829 3b0a 0a20 2020 2020 2020 2020  - 8);..         
+00010b70: 2020 2073 756d 6620 2b3d 2066 302a 6632     sumf += f0*f2
+00010b80: 202b 2066 312a 6633 3b0a 2020 2020 2020   + f1*f3;.      
+00010b90: 2020 7d0a 2020 2020 7d0a 2365 6e64 6966    }.    }.#endif
+00010ba0: 0a0a 2020 2020 2a73 203d 2073 756d 663b  ..    *s = sumf;
+00010bb0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00010bc0: 6767 6d6c 5f76 6563 5f64 6f74 5f71 345f  ggml_vec_dot_q4_
+00010bd0: 3128 636f 6e73 7420 696e 7420 6e2c 2066  1(const int n, f
+00010be0: 6c6f 6174 202a 2072 6573 7472 6963 7420  loat * restrict 
+00010bf0: 732c 2063 6f6e 7374 2076 6f69 6420 2a20  s, const void * 
+00010c00: 7265 7374 7269 6374 2076 782c 2063 6f6e  restrict vx, con
+00010c10: 7374 2076 6f69 6420 2a20 7265 7374 7269  st void * restri
+00010c20: 6374 2076 7929 207b 0a20 2020 2063 6f6e  ct vy) {.    con
+00010c30: 7374 2069 6e74 206e 6220 3d20 6e20 2f20  st int nb = n / 
+00010c40: 514b 3b0a 0a20 2020 2063 6f6e 7374 2062  QK;..    const b
+00010c50: 6c6f 636b 5f71 345f 3120 2a20 7265 7374  lock_q4_1 * rest
+00010c60: 7269 6374 2078 203d 2076 783b 0a20 2020  rict x = vx;.   
+00010c70: 2063 6f6e 7374 2062 6c6f 636b 5f71 345f   const block_q4_
+00010c80: 3120 2a20 7265 7374 7269 6374 2079 203d  1 * restrict y =
+00010c90: 2076 793b 0a0a 2020 2020 666c 6f61 7420   vy;..    float 
+00010ca0: 7375 6d66 203d 2030 2e30 3b0a 0a23 6966  sumf = 0.0;..#if
+00010cb0: 2064 6566 696e 6564 285f 5f41 5658 325f   defined(__AVX2_
+00010cc0: 5f29 0a20 2020 202f 2f20 496e 6974 6961  _).    // Initia
+00010cd0: 6c69 7a65 2061 6363 756d 756c 6174 6f72  lize accumulator
+00010ce0: 2077 6974 6820 7a65 726f 730a 2020 2020   with zeros.    
+00010cf0: 5f5f 6d32 3536 2061 6363 203d 205f 6d6d  __m256 acc = _mm
+00010d00: 3235 365f 7365 747a 6572 6f5f 7073 2829  256_setzero_ps()
+00010d10: 3b0a 2020 2020 2f2f 2041 6363 756d 756c  ;.    // Accumul
+00010d20: 6174 6f72 2066 6f72 2063 6f6e 7374 616e  ator for constan
+00010d30: 7420 6f66 6673 6574 730a 2020 2020 666c  t offsets.    fl
+00010d40: 6f61 7420 6163 635f 6f66 6673 6574 203d  oat acc_offset =
+00010d50: 2030 2e30 663b 0a0a 2020 2020 2f2f 204d   0.0f;..    // M
+00010d60: 6169 6e20 6c6f 6f70 0a20 2020 2066 6f72  ain loop.    for
+00010d70: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00010d80: 206e 623b 202b 2b69 2920 7b0a 2020 2020   nb; ++i) {.    
+00010d90: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00010da0: 2a20 6430 203d 2026 785b 695d 2e64 3b0a  * d0 = &x[i].d;.
+00010db0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00010dc0: 6f61 7420 2a20 6431 203d 2026 795b 695d  oat * d1 = &y[i]
+00010dd0: 2e64 3b0a 0a20 2020 2020 2020 2063 6f6e  .d;..        con
+00010de0: 7374 2066 6c6f 6174 202a 206d 3020 3d20  st float * m0 = 
+00010df0: 2678 5b69 5d2e 6d3b 0a20 2020 2020 2020  &x[i].m;.       
+00010e00: 2063 6f6e 7374 2066 6c6f 6174 202a 206d   const float * m
+00010e10: 3120 3d20 2679 5b69 5d2e 6d3b 0a0a 2020  1 = &y[i].m;..  
+00010e20: 2020 2020 2020 636f 6e73 7420 5f5f 6d32        const __m2
+00010e30: 3536 2064 3076 203d 205f 6d6d 3235 365f  56 d0v = _mm256_
+00010e40: 6272 6f61 6463 6173 745f 7373 2820 6430  broadcast_ss( d0
+00010e50: 2029 3b0a 2020 2020 2020 2020 636f 6e73   );.        cons
+00010e60: 7420 5f5f 6d32 3536 2064 3176 203d 205f  t __m256 d1v = _
+00010e70: 6d6d 3235 365f 6272 6f61 6463 6173 745f  mm256_broadcast_
+00010e80: 7373 2820 6431 2029 3b0a 2020 2020 2020  ss( d1 );.      
+00010e90: 2020 636f 6e73 7420 5f5f 6d32 3536 206d    const __m256 m
+00010ea0: 3076 203d 205f 6d6d 3235 365f 6272 6f61  0v = _mm256_broa
+00010eb0: 6463 6173 745f 7373 2820 6d30 2029 3b0a  dcast_ss( m0 );.
+00010ec0: 2020 2020 2020 2020 636f 6e73 7420 5f5f          const __
+00010ed0: 6d32 3536 206d 3176 203d 205f 6d6d 3235  m256 m1v = _mm25
+00010ee0: 365f 6272 6f61 6463 6173 745f 7373 2820  6_broadcast_ss( 
+00010ef0: 6d31 2029 3b0a 0a20 2020 2020 2020 202f  m1 );..        /
+00010f00: 2f20 436f 6d70 7574 6520 636f 6d62 696e  / Compute combin
+00010f10: 6564 2073 6361 6c65 2066 6f72 2074 6865  ed scale for the
+00010f20: 2062 6c6f 636b 0a20 2020 2020 2020 2063   block.        c
+00010f30: 6f6e 7374 205f 5f6d 3235 3620 7363 616c  onst __m256 scal
+00010f40: 655f 3031 203d 205f 6d6d 3235 365f 6d75  e_01 = _mm256_mu
+00010f50: 6c5f 7073 2820 6430 762c 2064 3176 2029  l_ps( d0v, d1v )
+00010f60: 3b0a 0a20 2020 2020 2020 202f 2f20 436f  ;..        // Co
+00010f70: 6d70 7574 6520 6372 6f73 7320 7363 616c  mpute cross scal
+00010f80: 6573 2066 6f72 2074 6865 2062 6c6f 636b  es for the block
+00010f90: 0a20 2020 2020 2020 2063 6f6e 7374 205f  .        const _
+00010fa0: 5f6d 3235 3620 7363 616c 655f 3020 3d20  _m256 scale_0 = 
+00010fb0: 5f6d 6d32 3536 5f6d 756c 5f70 7328 2064  _mm256_mul_ps( d
+00010fc0: 3076 2c20 6d31 7620 293b 0a20 2020 2020  0v, m1v );.     
+00010fd0: 2020 2063 6f6e 7374 205f 5f6d 3235 3620     const __m256 
+00010fe0: 7363 616c 655f 3120 3d20 5f6d 6d32 3536  scale_1 = _mm256
+00010ff0: 5f6d 756c 5f70 7328 206d 3076 2c20 6431  _mul_ps( m0v, d1
+00011000: 7620 293b 0a20 2020 2020 2020 2063 6f6e  v );.        con
+00011010: 7374 205f 5f6d 3235 3620 6372 6f73 735f  st __m256 cross_
+00011020: 7363 616c 6573 203d 205f 6d6d 3235 365f  scales = _mm256_
+00011030: 626c 656e 645f 7073 2820 7363 616c 655f  blend_ps( scale_
+00011040: 302c 2073 6361 6c65 5f31 2c20 3062 3130  0, scale_1, 0b10
+00011050: 3130 3130 3130 2029 3b0a 0a20 2020 2020  101010 );..     
+00011060: 2020 202f 2f20 4c6f 6164 2031 3620 6279     // Load 16 by
+00011070: 7465 732c 2061 6e64 2075 6e70 6163 6b20  tes, and unpack 
+00011080: 3420 6269 7420 6669 656c 6473 2069 6e74  4 bit fields int
+00011090: 6f20 6279 7465 732c 206d 616b 696e 6720  o bytes, making 
+000110a0: 3332 2062 7974 6573 0a20 2020 2020 2020  32 bytes.       
+000110b0: 205f 5f6d 3235 3669 2062 7820 3d20 6279   __m256i bx = by
+000110c0: 7465 7346 726f 6d4e 6962 626c 6573 2820  tesFromNibbles( 
+000110d0: 785b 695d 2e71 7320 293b 0a20 2020 2020  x[i].qs );.     
+000110e0: 2020 205f 5f6d 3235 3669 2062 7920 3d20     __m256i by = 
+000110f0: 6279 7465 7346 726f 6d4e 6962 626c 6573  bytesFromNibbles
+00011100: 2820 795b 695d 2e71 7320 293b 0a0a 2020  ( y[i].qs );..  
+00011110: 2020 2020 2020 2f2f 204e 6f77 2077 6520        // Now we 
+00011120: 6861 7665 2061 2076 6563 746f 7220 7769  have a vector wi
+00011130: 7468 2062 7974 6573 2069 6e20 5b20 3020  th bytes in [ 0 
+00011140: 2e2e 2031 3520 5d20 696e 7465 7276 616c  .. 15 ] interval
+00011150: 2e0a 0a20 2020 2020 2020 202f 2f20 5369  ...        // Si
+00011160: 676e 2d65 7874 656e 6420 6669 7273 7420  gn-extend first 
+00011170: 3136 2073 6967 6e65 6420 6279 7465 7320  16 signed bytes 
+00011180: 696e 746f 2069 6e74 3136 5f74 0a20 2020  into int16_t.   
+00011190: 2020 2020 205f 5f6d 3235 3669 2078 3136       __m256i x16
+000111a0: 203d 205f 6d6d 3235 365f 6376 7465 7069   = _mm256_cvtepi
+000111b0: 385f 6570 6931 3628 205f 6d6d 3235 365f  8_epi16( _mm256_
+000111c0: 6361 7374 7369 3235 365f 7369 3132 3828  castsi256_si128(
+000111d0: 2062 7820 2920 293b 0a20 2020 2020 2020   bx ) );.       
+000111e0: 205f 5f6d 3235 3669 2079 3136 203d 205f   __m256i y16 = _
+000111f0: 6d6d 3235 365f 6376 7465 7069 385f 6570  mm256_cvtepi8_ep
+00011200: 6931 3628 205f 6d6d 3235 365f 6361 7374  i16( _mm256_cast
+00011210: 7369 3235 365f 7369 3132 3828 2062 7920  si256_si128( by 
+00011220: 2920 293b 0a20 2020 2020 2020 202f 2f20  ) );.        // 
+00011230: 436f 6d70 7574 6520 7072 6f64 7563 7473  Compute products
+00011240: 206f 6620 696e 7431 365f 7420 696e 7465   of int16_t inte
+00011250: 6765 7273 2c20 6164 6420 7061 6972 7769  gers, add pairwi
+00011260: 7365 0a20 2020 2020 2020 205f 5f6d 3235  se.        __m25
+00011270: 3669 2069 3332 203d 205f 6d6d 3235 365f  6i i32 = _mm256_
+00011280: 6d61 6464 5f65 7069 3136 2820 7831 362c  madd_epi16( x16,
+00011290: 2079 3136 2029 3b0a 0a20 2020 2020 2020   y16 );..       
+000112a0: 202f 2f20 5369 676e 2d65 7874 656e 6420   // Sign-extend 
+000112b0: 6c61 7374 2031 3620 7369 676e 6564 2062  last 16 signed b
+000112c0: 7974 6573 2069 6e74 6f20 696e 7431 365f  ytes into int16_
+000112d0: 7420 7665 6374 6f72 730a 2020 2020 2020  t vectors.      
+000112e0: 2020 5f5f 6d32 3536 6920 7831 365f 6820    __m256i x16_h 
+000112f0: 3d20 5f6d 6d32 3536 5f63 7674 6570 6938  = _mm256_cvtepi8
+00011300: 5f65 7069 3136 2820 5f6d 6d32 3536 5f65  _epi16( _mm256_e
+00011310: 7874 7261 6374 6931 3238 5f73 6932 3536  xtracti128_si256
+00011320: 2820 6278 2c20 3120 2920 293b 0a20 2020  ( bx, 1 ) );.   
+00011330: 2020 2020 205f 5f6d 3235 3669 2079 3136       __m256i y16
+00011340: 5f68 203d 205f 6d6d 3235 365f 6376 7465  _h = _mm256_cvte
+00011350: 7069 385f 6570 6931 3628 205f 6d6d 3235  pi8_epi16( _mm25
+00011360: 365f 6578 7472 6163 7469 3132 385f 7369  6_extracti128_si
+00011370: 3235 3628 2062 792c 2031 2029 2029 3b0a  256( by, 1 ) );.
+00011380: 2020 2020 2020 2020 2f2f 2041 6363 756d          // Accum
+00011390: 756c 6174 6520 7072 6f64 7563 7473 206f  ulate products o
+000113a0: 6620 696e 7431 365f 7420 696e 7465 6765  f int16_t intege
+000113b0: 7273 0a20 2020 2020 2020 2069 3332 203d  rs.        i32 =
+000113c0: 205f 6d6d 3235 365f 6164 645f 6570 6933   _mm256_add_epi3
+000113d0: 3228 2069 3332 2c20 5f6d 6d32 3536 5f6d  2( i32, _mm256_m
+000113e0: 6164 645f 6570 6931 3628 2078 3136 5f68  add_epi16( x16_h
+000113f0: 2c20 7931 365f 6820 2920 293b 0a0a 2020  , y16_h ) );..  
+00011400: 2020 2020 2020 2f2f 2063 6f6d 7075 7465        // compute
+00011410: 2073 756d 7320 6f66 2075 6e73 6967 6e65   sums of unsigne
+00011420: 6420 6279 7465 7320 696e 2062 782c 2062  d bytes in bx, b
+00011430: 7920 696e 2062 6c6f 636b 7320 6f66 2038  y in blocks of 8
+00011440: 2e0a 2020 2020 2020 2020 2f2f 2054 6869  ..        // Thi
+00011450: 7320 7265 7375 6c74 7320 696e 2061 206c  s results in a l
+00011460: 6179 6f75 7420 6c69 6b65 2058 3130 3020  ayout like X100 
+00011470: 3030 3030 2058 3230 3020 3030 3030 2058  0000 X200 0000 X
+00011480: 3330 3020 3030 3030 2058 3430 3020 3030  300 0000 X400 00
+00011490: 3030 2c0a 2020 2020 2020 2020 2f2f 2077  00,.        // w
+000114a0: 6869 6368 2077 6520 7468 656e 2069 6e74  hich we then int
+000114b0: 6572 6c65 6176 6520 6173 2058 3130 3020  erleave as X100 
+000114c0: 5931 3030 2058 3230 3020 5932 3030 2058  Y100 X200 Y200 X
+000114d0: 3330 3020 5933 3030 2058 3430 3020 5934  300 Y300 X400 Y4
+000114e0: 3030 2e0a 2020 2020 2020 2020 2f2f 2073  00..        // s
+000114f0: 6f20 6966 2077 6520 7468 656e 2063 6173  o if we then cas
+00011500: 7420 746f 2038 2073 696e 676c 6573 2c20  t to 8 singles, 
+00011510: 7765 2067 6574 2038 2066 6c6f 6174 7320  we get 8 floats 
+00011520: 6c69 6b65 205b 2078 305f 372c 2079 305f  like [ x0_7, y0_
+00011530: 372c 2078 385f 3135 2c20 7938 5f31 352c  7, x8_15, y8_15,
+00011540: 2078 3136 5f32 332c 2079 3136 5f32 332c   x16_23, y16_23,
+00011550: 2078 3234 5f33 312c 2079 3234 5f33 3120   x24_31, y24_31 
+00011560: 5d0a 2020 2020 2020 2020 5f5f 6d32 3536  ].        __m256
+00011570: 6920 7873 756d 6920 3d20 5f6d 6d32 3536  i xsumi = _mm256
+00011580: 5f73 6164 5f65 7075 3828 2062 782c 205f  _sad_epu8( bx, _
+00011590: 6d6d 3235 365f 7365 747a 6572 6f5f 7369  mm256_setzero_si
+000115a0: 3235 3628 2920 293b 0a20 2020 2020 2020  256() );.       
+000115b0: 205f 5f6d 3235 3669 2079 7375 6d69 203d   __m256i ysumi =
+000115c0: 205f 6d6d 3235 365f 7361 645f 6570 7538   _mm256_sad_epu8
+000115d0: 2820 6279 2c20 5f6d 6d32 3536 5f73 6574  ( by, _mm256_set
+000115e0: 7a65 726f 5f73 6932 3536 2829 2029 3b0a  zero_si256() );.
+000115f0: 2020 2020 2020 2020 5f5f 6d32 3536 6920          __m256i 
+00011600: 7375 6d73 6920 3d20 5f6d 6d32 3536 5f6f  sumsi = _mm256_o
+00011610: 725f 7369 3235 3628 2078 7375 6d69 2c20  r_si256( xsumi, 
+00011620: 5f6d 6d32 3536 5f73 6c6c 695f 7369 3235  _mm256_slli_si25
+00011630: 3628 2079 7375 6d69 2c20 3420 2920 293b  6( ysumi, 4 ) );
+00011640: 0a20 2020 2020 2020 205f 5f6d 3235 3620  .        __m256 
+00011650: 2073 756d 7320 203d 205f 6d6d 3235 365f   sums  = _mm256_
+00011660: 6376 7465 7069 3332 5f70 7328 2073 756d  cvtepi32_ps( sum
+00011670: 7369 2029 3b0a 0a20 2020 2020 2020 202f  si );..        /
+00011680: 2f20 436f 6e76 6572 7420 696e 7433 325f  / Convert int32_
+00011690: 7420 746f 2066 6c6f 6174 0a20 2020 2020  t to float.     
+000116a0: 2020 205f 5f6d 3235 3620 7020 3d20 5f6d     __m256 p = _m
+000116b0: 6d32 3536 5f63 7674 6570 6933 325f 7073  m256_cvtepi32_ps
+000116c0: 2820 6933 3220 293b 0a20 2020 2020 2020  ( i32 );.       
+000116d0: 202f 2f20 4170 706c 7920 7468 6520 7363   // Apply the sc
+000116e0: 616c 652c 2061 6e64 2061 6363 756d 756c  ale, and accumul
+000116f0: 6174 650a 2020 2020 2020 2020 2f2f 2061  ate.        // a
+00011700: 6363 202b 3d20 6430 2a64 312a 782a 7920  cc += d0*d1*x*y 
+00011710: 2b20 6430 2a6d 312a 7820 2b20 6431 2a6d  + d0*m1*x + d1*m
+00011720: 302a 790a 2020 2020 2020 2020 6163 6320  0*y.        acc 
+00011730: 3d20 5f6d 6d32 3536 5f66 6d61 6464 5f70  = _mm256_fmadd_p
+00011740: 7328 2073 6361 6c65 5f30 312c 2070 2c20  s( scale_01, p, 
+00011750: 6163 6320 293b 0a20 2020 2020 2020 2061  acc );.        a
+00011760: 6363 203d 205f 6d6d 3235 365f 666d 6164  cc = _mm256_fmad
+00011770: 645f 7073 2820 6372 6f73 735f 7363 616c  d_ps( cross_scal
+00011780: 6573 2c20 7375 6d73 2c20 6163 6320 293b  es, sums, acc );
+00011790: 0a20 2020 2020 2020 202f 2f20 6163 635f  .        // acc_
+000117a0: 6f66 6673 6574 202b 3d20 6d30 2a6d 3120  offset += m0*m1 
+000117b0: 2866 6f72 2065 6163 6820 656e 7472 7920  (for each entry 
+000117c0: 696e 2074 6865 2062 6c6f 636b 290a 2020  in the block).  
+000117d0: 2020 2020 2020 6163 635f 6f66 6673 6574        acc_offset
+000117e0: 202b 3d20 282a 6d30 292a 282a 6d31 293b   += (*m0)*(*m1);
+000117f0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2052  .    }..    // R
+00011800: 6574 7572 6e20 686f 7269 7a6f 6e74 616c  eturn horizontal
+00011810: 2073 756d 206f 6620 7468 6520 6163 6320   sum of the acc 
+00011820: 7665 6374 6f72 0a20 2020 205f 5f6d 3132  vector.    __m12
+00011830: 3820 7265 7320 3d20 5f6d 6d32 3536 5f65  8 res = _mm256_e
+00011840: 7874 7261 6374 6631 3238 5f70 7328 2061  xtractf128_ps( a
+00011850: 6363 2c20 3120 293b 0a20 2020 2072 6573  cc, 1 );.    res
+00011860: 203d 205f 6d6d 5f61 6464 5f70 7328 2072   = _mm_add_ps( r
+00011870: 6573 2c20 5f6d 6d32 3536 5f63 6173 7470  es, _mm256_castp
+00011880: 7332 3536 5f70 7331 3238 2820 6163 6320  s256_ps128( acc 
+00011890: 2920 293b 0a20 2020 2072 6573 203d 205f  ) );.    res = _
+000118a0: 6d6d 5f61 6464 5f70 7328 2072 6573 2c20  mm_add_ps( res, 
+000118b0: 5f6d 6d5f 6d6f 7665 686c 5f70 7328 2072  _mm_movehl_ps( r
+000118c0: 6573 2c20 7265 7320 2920 293b 0a20 2020  es, res ) );.   
+000118d0: 2072 6573 203d 205f 6d6d 5f61 6464 5f73   res = _mm_add_s
+000118e0: 7328 2072 6573 2c20 5f6d 6d5f 6d6f 7665  s( res, _mm_move
+000118f0: 6864 7570 5f70 7328 2072 6573 2029 2029  hdup_ps( res ) )
+00011900: 3b0a 0a20 2020 2073 756d 6620 3d20 5f6d  ;..    sumf = _m
+00011910: 6d5f 6376 7473 735f 6633 3228 2072 6573  m_cvtss_f32( res
+00011920: 2029 202b 2061 6363 5f6f 6666 7365 7420   ) + acc_offset 
+00011930: 2a20 514b 3b0a 2365 6c73 650a 2020 2020  * QK;.#else.    
+00011940: 2f2f 2073 6361 6c61 720a 2020 2020 666f  // scalar.    fo
 00011950: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00011960: 3c20 6e3b 202b 2b69 2920 7b0a 2020 2020  < n; ++i) {.    
-00011970: 2020 2020 795b 695d 203d 2067 676d 6c5f      y[i] = ggml_
-00011980: 7369 6c75 5f66 3332 2878 5b69 5d29 3b0a  silu_f32(x[i]);.
-00011990: 2020 2020 7d0a 7d0a 2365 6e64 6966 0a0a      }.}.#endif..
-000119a0: 696e 6c69 6e65 2073 7461 7469 6320 766f  inline static vo
-000119b0: 6964 2067 676d 6c5f 7665 635f 7375 6d5f  id ggml_vec_sum_
-000119c0: 6633 3228 636f 6e73 7420 696e 7420 6e2c  f32(const int n,
-000119d0: 2066 6c6f 6174 202a 2073 2c20 636f 6e73   float * s, cons
-000119e0: 7420 666c 6f61 7420 2a20 7829 207b 0a23  t float * x) {.#
-000119f0: 6966 6e64 6566 2047 474d 4c5f 5553 455f  ifndef GGML_USE_
-00011a00: 4143 4345 4c45 5241 5445 0a20 2020 2067  ACCELERATE.    g
-00011a10: 676d 6c5f 666c 6f61 7420 7375 6d20 3d20  gml_float sum = 
-00011a20: 302e 303b 0a20 2020 2066 6f72 2028 696e  0.0;.    for (in
-00011a30: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
-00011a40: 2b2b 6929 207b 0a20 2020 2020 2020 2073  ++i) {.        s
-00011a50: 756d 202b 3d20 785b 695d 3b0a 2020 2020  um += x[i];.    
-00011a60: 7d0a 2020 2020 2a73 203d 2073 756d 3b0a  }.    *s = sum;.
-00011a70: 2365 6c73 650a 2020 2020 7644 5350 5f73  #else.    vDSP_s
-00011a80: 7665 2878 2c20 312c 2073 2c20 6e29 3b0a  ve(x, 1, s, n);.
-00011a90: 2365 6e64 6966 0a7d 0a0a 696e 6c69 6e65  #endif.}..inline
-00011aa0: 2073 7461 7469 6320 766f 6964 2067 676d   static void ggm
-00011ab0: 6c5f 7665 635f 6d61 785f 6633 3228 636f  l_vec_max_f32(co
-00011ac0: 6e73 7420 696e 7420 6e2c 2066 6c6f 6174  nst int n, float
-00011ad0: 202a 2073 2c20 636f 6e73 7420 666c 6f61   * s, const floa
-00011ae0: 7420 2a20 7829 207b 0a23 6966 6e64 6566  t * x) {.#ifndef
-00011af0: 2047 474d 4c5f 5553 455f 4143 4345 4c45   GGML_USE_ACCELE
-00011b00: 5241 5445 0a20 2020 2067 676d 6c5f 666c  RATE.    ggml_fl
-00011b10: 6f61 7420 6d61 7820 3d20 2d49 4e46 494e  oat max = -INFIN
-00011b20: 4954 593b 0a20 2020 2066 6f72 2028 696e  ITY;.    for (in
-00011b30: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
-00011b40: 2b2b 6929 207b 0a20 2020 2020 2020 206d  ++i) {.        m
-00011b50: 6178 203d 204d 4158 286d 6178 2c20 785b  ax = MAX(max, x[
-00011b60: 695d 293b 0a20 2020 207d 0a20 2020 202a  i]);.    }.    *
-00011b70: 7320 3d20 6d61 783b 0a23 656c 7365 0a20  s = max;.#else. 
-00011b80: 2020 2076 4453 505f 6d61 7876 2878 2c20     vDSP_maxv(x, 
-00011b90: 312c 2073 2c20 6e29 3b0a 2365 6e64 6966  1, s, n);.#endif
-00011ba0: 0a7d 0a0a 696e 6c69 6e65 2073 7461 7469  .}..inline stati
-00011bb0: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
-00011bc0: 6e6f 726d 5f69 6e76 5f66 3332 2863 6f6e  norm_inv_f32(con
-00011bd0: 7374 2069 6e74 206e 2c20 666c 6f61 7420  st int n, float 
-00011be0: 2a20 732c 2063 6f6e 7374 2066 6c6f 6174  * s, const float
-00011bf0: 202a 2078 2920 7b20 6767 6d6c 5f76 6563   * x) { ggml_vec
-00011c00: 5f6e 6f72 6d5f 6633 3228 6e2c 2073 2c20  _norm_f32(n, s, 
-00011c10: 7829 3b20 2a73 203d 2031 2e2f 282a 7329  x); *s = 1./(*s)
-00011c20: 3b20 7d0a 0a2f 2f0a 2f2f 206c 6f67 6769  ; }..//.// loggi
-00011c30: 6e67 0a2f 2f0a 0a23 6966 2028 4747 4d4c  ng.//..#if (GGML
-00011c40: 5f44 4542 5547 203e 3d20 3129 0a23 6465  _DEBUG >= 1).#de
-00011c50: 6669 6e65 2047 474d 4c5f 5052 494e 545f  fine GGML_PRINT_
-00011c60: 4445 4255 4728 2e2e 2e29 2070 7269 6e74  DEBUG(...) print
-00011c70: 6628 5f5f 5641 5f41 5247 535f 5f29 0a23  f(__VA_ARGS__).#
-00011c80: 656c 7365 0a23 6465 6669 6e65 2047 474d  else.#define GGM
-00011c90: 4c5f 5052 494e 545f 4445 4255 4728 2e2e  L_PRINT_DEBUG(..
-00011ca0: 2e29 0a23 656e 6469 660a 0a23 6966 2028  .).#endif..#if (
-00011cb0: 4747 4d4c 5f44 4542 5547 203e 3d20 3529  GGML_DEBUG >= 5)
-00011cc0: 0a23 6465 6669 6e65 2047 474d 4c5f 5052  .#define GGML_PR
-00011cd0: 494e 545f 4445 4255 475f 3528 2e2e 2e29  INT_DEBUG_5(...)
-00011ce0: 2070 7269 6e74 6628 5f5f 5641 5f41 5247   printf(__VA_ARG
-00011cf0: 535f 5f29 0a23 656c 7365 0a23 6465 6669  S__).#else.#defi
-00011d00: 6e65 2047 474d 4c5f 5052 494e 545f 4445  ne GGML_PRINT_DE
-00011d10: 4255 475f 3528 2e2e 2e29 0a23 656e 6469  BUG_5(...).#endi
-00011d20: 660a 0a23 6966 2028 4747 4d4c 5f44 4542  f..#if (GGML_DEB
-00011d30: 5547 203e 3d20 3130 290a 2364 6566 696e  UG >= 10).#defin
-00011d40: 6520 4747 4d4c 5f50 5249 4e54 5f44 4542  e GGML_PRINT_DEB
-00011d50: 5547 5f31 3028 2e2e 2e29 2070 7269 6e74  UG_10(...) print
-00011d60: 6628 5f5f 5641 5f41 5247 535f 5f29 0a23  f(__VA_ARGS__).#
-00011d70: 656c 7365 0a23 6465 6669 6e65 2047 474d  else.#define GGM
-00011d80: 4c5f 5052 494e 545f 4445 4255 475f 3130  L_PRINT_DEBUG_10
-00011d90: 282e 2e2e 290a 2365 6e64 6966 0a0a 2364  (...).#endif..#d
-00011da0: 6566 696e 6520 4747 4d4c 5f50 5249 4e54  efine GGML_PRINT
-00011db0: 282e 2e2e 2920 7072 696e 7466 285f 5f56  (...) printf(__V
-00011dc0: 415f 4152 4753 5f5f 290a 0a2f 2f0a 2f2f  A_ARGS__)..//.//
-00011dd0: 2064 6174 6120 7479 7065 730a 2f2f 0a0a   data types.//..
-00011de0: 7374 6174 6963 2063 6f6e 7374 2069 6e74  static const int
-00011df0: 2047 474d 4c5f 424c 434b 5f53 495a 455b   GGML_BLCK_SIZE[
-00011e00: 4747 4d4c 5f54 5950 455f 434f 554e 545d  GGML_TYPE_COUNT]
-00011e10: 203d 207b 0a20 2020 2051 4b2c 0a20 2020   = {.    QK,.   
-00011e20: 2051 4b2c 0a20 2020 2031 2c0a 2020 2020   QK,.    1,.    
-00011e30: 312c 0a20 2020 2031 2c0a 2020 2020 312c  1,.    1,.    1,
-00011e40: 0a20 2020 2031 2c0a 7d3b 0a0a 7374 6174  .    1,.};..stat
-00011e50: 6963 5f61 7373 6572 7428 4747 4d4c 5f54  ic_assert(GGML_T
-00011e60: 5950 455f 434f 554e 5420 3d3d 2037 2c20  YPE_COUNT == 7, 
-00011e70: 2247 474d 4c5f 5459 5045 5f43 4f55 4e54  "GGML_TYPE_COUNT
-00011e80: 2021 3d20 3522 293b 0a0a 7374 6174 6963   != 5");..static
-00011e90: 2063 6f6e 7374 2073 697a 655f 7420 4747   const size_t GG
-00011ea0: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
-00011eb0: 4c5f 5459 5045 5f43 4f55 4e54 5d20 3d20  L_TYPE_COUNT] = 
-00011ec0: 7b0a 2020 2020 7369 7a65 6f66 2866 6c6f  {.    sizeof(flo
-00011ed0: 6174 2020 2920 2020 2b20 514b 2f32 2c0a  at  )   + QK/2,.
-00011ee0: 2020 2020 7369 7a65 6f66 2866 6c6f 6174      sizeof(float
-00011ef0: 2020 292a 3220 2b20 514b 2f32 2c0a 2020    )*2 + QK/2,.  
-00011f00: 2020 7369 7a65 6f66 2869 6e74 385f 7420    sizeof(int8_t 
-00011f10: 292c 0a20 2020 2073 697a 656f 6628 696e  ),.    sizeof(in
-00011f20: 7431 365f 7429 2c0a 2020 2020 7369 7a65  t16_t),.    size
-00011f30: 6f66 2869 6e74 3332 5f74 292c 0a20 2020  of(int32_t),.   
-00011f40: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-00011f50: 365f 7429 2c0a 2020 2020 7369 7a65 6f66  6_t),.    sizeof
-00011f60: 2866 6c6f 6174 2020 292c 0a7d 3b0a 0a2f  (float  ),.};../
-00011f70: 2f20 646f 6e27 7420 666f 7267 6574 2074  / don't forget t
-00011f80: 6f20 7570 6461 7465 2074 6865 2061 7272  o update the arr
-00011f90: 6179 2061 626f 7665 2077 6865 6e20 6164  ay above when ad
-00011fa0: 6469 6e67 206e 6577 2074 7970 6573 0a73  ding new types.s
-00011fb0: 7461 7469 635f 6173 7365 7274 2847 474d  tatic_assert(GGM
-00011fc0: 4c5f 5459 5045 5f43 4f55 4e54 203d 3d20  L_TYPE_COUNT == 
-00011fd0: 372c 2022 4747 4d4c 5f54 5950 455f 434f  7, "GGML_TYPE_CO
-00011fe0: 554e 5420 213d 2035 2229 3b0a 0a73 7461  UNT != 5");..sta
-00011ff0: 7469 6320 636f 6e73 7420 6368 6172 202a  tic const char *
-00012000: 2047 474d 4c5f 4f50 5f4c 4142 454c 5b47   GGML_OP_LABEL[G
-00012010: 474d 4c5f 4f50 5f43 4f55 4e54 5d20 3d20  GML_OP_COUNT] = 
-00012020: 7b0a 2020 2020 224e 4f4e 4522 2c0a 0a20  {.    "NONE",.. 
-00012030: 2020 2022 4455 5022 2c0a 2020 2020 2241     "DUP",.    "A
-00012040: 4444 222c 0a20 2020 2022 5355 4222 2c0a  DD",.    "SUB",.
-00012050: 2020 2020 224d 554c 222c 0a20 2020 2022      "MUL",.    "
-00012060: 4449 5622 2c0a 2020 2020 2253 5152 222c  DIV",.    "SQR",
-00012070: 0a20 2020 2022 5351 5254 222c 0a20 2020  .    "SQRT",.   
-00012080: 2022 5355 4d22 2c0a 2020 2020 224d 4541   "SUM",.    "MEA
-00012090: 4e22 2c0a 2020 2020 2252 4550 4541 5422  N",.    "REPEAT"
-000120a0: 2c0a 2020 2020 2241 4253 222c 0a20 2020  ,.    "ABS",.   
-000120b0: 2022 5347 4e22 2c0a 2020 2020 224e 4547   "SGN",.    "NEG
-000120c0: 222c 0a20 2020 2022 5354 4550 222c 0a20  ",.    "STEP",. 
-000120d0: 2020 2022 5245 4c55 222c 0a20 2020 2022     "RELU",.    "
-000120e0: 4745 4c55 222c 0a20 2020 2022 5349 4c55  GELU",.    "SILU
-000120f0: 222c 0a20 2020 2022 4e4f 524d 222c 0a20  ",.    "NORM",. 
-00012100: 2020 2022 524d 535f 4e4f 524d 222c 0a0a     "RMS_NORM",..
-00012110: 2020 2020 224d 554c 5f4d 4154 222c 0a0a      "MUL_MAT",..
-00012120: 2020 2020 2253 4341 4c45 222c 0a20 2020      "SCALE",.   
-00012130: 2022 4350 5922 2c0a 2020 2020 2252 4553   "CPY",.    "RES
-00012140: 4841 5045 222c 0a20 2020 2022 5649 4557  HAPE",.    "VIEW
-00012150: 222c 0a20 2020 2022 5045 524d 5554 4522  ",.    "PERMUTE"
-00012160: 2c0a 2020 2020 2254 5241 4e53 504f 5345  ,.    "TRANSPOSE
-00012170: 222c 0a20 2020 2022 4745 545f 524f 5753  ",.    "GET_ROWS
-00012180: 222c 0a20 2020 2022 4449 4147 5f4d 4153  ",.    "DIAG_MAS
-00012190: 4b5f 494e 4622 2c0a 2020 2020 2253 4f46  K_INF",.    "SOF
-000121a0: 545f 4d41 5822 2c0a 2020 2020 2252 4f50  T_MAX",.    "ROP
-000121b0: 4522 2c0a 2020 2020 2243 4f4e 565f 3144  E",.    "CONV_1D
-000121c0: 5f31 5322 2c0a 2020 2020 2243 4f4e 565f  _1S",.    "CONV_
-000121d0: 3144 5f32 5322 2c0a 0a20 2020 2022 464c  1D_2S",..    "FL
-000121e0: 4153 485f 4154 544e 222c 0a20 2020 2022  ASH_ATTN",.    "
-000121f0: 464c 4153 485f 4646 222c 0a7d 3b0a 0a73  FLASH_FF",.};..s
-00012200: 7461 7469 635f 6173 7365 7274 2847 474d  tatic_assert(GGM
-00012210: 4c5f 4f50 5f43 4f55 4e54 203d 3d20 3335  L_OP_COUNT == 35
-00012220: 2c20 2247 474d 4c5f 4f50 5f43 4f55 4e54  , "GGML_OP_COUNT
-00012230: 2021 3d20 3335 2229 3b0a 0a73 7461 7469   != 35");..stati
-00012240: 6320 636f 6e73 7420 6368 6172 202a 2047  c const char * G
-00012250: 474d 4c5f 4f50 5f53 594d 424f 4c5b 4747  GML_OP_SYMBOL[GG
-00012260: 4d4c 5f4f 505f 434f 554e 545d 203d 207b  ML_OP_COUNT] = {
-00012270: 0a20 2020 2022 6e6f 6e65 222c 0a0a 2020  .    "none",..  
-00012280: 2020 2278 222c 0a20 2020 2022 782b 7922    "x",.    "x+y"
-00012290: 2c0a 2020 2020 2278 2d79 222c 0a20 2020  ,.    "x-y",.   
-000122a0: 2022 782a 7922 2c0a 2020 2020 2278 2f79   "x*y",.    "x/y
-000122b0: 222c 0a20 2020 2022 785e 3222 2c0a 2020  ",.    "x^2",.  
-000122c0: 2020 22e2 889a 7822 2c0a 2020 2020 22ce    "...x",.    ".
-000122d0: a378 222c 0a20 2020 2022 cea3 782f 6e22  .x",.    "..x/n"
-000122e0: 2c0a 2020 2020 2272 6570 6561 7428 7829  ,.    "repeat(x)
-000122f0: 222c 0a20 2020 2022 6162 7328 7829 222c  ",.    "abs(x)",
-00012300: 0a20 2020 2022 7367 6e28 7829 222c 0a20  .    "sgn(x)",. 
-00012310: 2020 2022 2d78 222c 0a20 2020 2022 7374     "-x",.    "st
-00012320: 6570 2878 2922 2c0a 2020 2020 2272 656c  ep(x)",.    "rel
-00012330: 7528 7829 222c 0a20 2020 2022 6765 6c75  u(x)",.    "gelu
-00012340: 2878 2922 2c0a 2020 2020 2273 696c 7528  (x)",.    "silu(
-00012350: 7829 222c 0a20 2020 2022 6e6f 726d 2878  x)",.    "norm(x
-00012360: 2922 2c0a 2020 2020 2272 6d73 5f6e 6f72  )",.    "rms_nor
-00012370: 6d28 7829 222c 0a0a 2020 2020 2258 2a59  m(x)",..    "X*Y
-00012380: 222c 0a0a 2020 2020 2278 2a76 222c 0a20  ",..    "x*v",. 
-00012390: 2020 2022 782d 5c5c 3e79 222c 0a20 2020     "x-\\>y",.   
-000123a0: 2022 7265 7368 6170 6528 7829 222c 0a20   "reshape(x)",. 
-000123b0: 2020 2022 7669 6577 2878 2922 2c0a 2020     "view(x)",.  
-000123c0: 2020 2270 6572 6d75 7465 2878 2922 2c0a    "permute(x)",.
-000123d0: 2020 2020 2274 7261 6e73 706f 7365 2878      "transpose(x
-000123e0: 2922 2c0a 2020 2020 2267 6574 5f72 6f77  )",.    "get_row
-000123f0: 7328 7829 222c 0a20 2020 2022 6469 6167  s(x)",.    "diag
-00012400: 5f6d 6173 6b5f 696e 6628 7829 222c 0a20  _mask_inf(x)",. 
-00012410: 2020 2022 736f 6674 5f6d 6178 2878 2922     "soft_max(x)"
-00012420: 2c0a 2020 2020 2272 6f70 6528 7829 222c  ,.    "rope(x)",
-00012430: 0a20 2020 2022 636f 6e76 5f31 645f 3173  .    "conv_1d_1s
-00012440: 2878 2922 2c0a 2020 2020 2263 6f6e 765f  (x)",.    "conv_
-00012450: 3164 5f32 7328 7829 222c 0a0a 2020 2020  1d_2s(x)",..    
-00012460: 2266 6c61 7368 5f61 7474 6e28 7829 222c  "flash_attn(x)",
-00012470: 0a20 2020 2022 666c 6173 685f 6666 2878  .    "flash_ff(x
-00012480: 2922 2c0a 7d3b 0a0a 7374 6174 6963 5f61  )",.};..static_a
-00012490: 7373 6572 7428 4747 4d4c 5f4f 505f 434f  ssert(GGML_OP_CO
-000124a0: 554e 5420 3d3d 2033 352c 2022 4747 4d4c  UNT == 35, "GGML
-000124b0: 5f4f 505f 434f 554e 5420 213d 2033 3522  _OP_COUNT != 35"
-000124c0: 293b 0a0a 2f2f 0a2f 2f20 6767 6d6c 206f  );..//.// ggml o
-000124d0: 626a 6563 740a 2f2f 0a0a 7374 7275 6374  bject.//..struct
-000124e0: 2067 676d 6c5f 6f62 6a65 6374 207b 0a20   ggml_object {. 
-000124f0: 2020 2073 697a 655f 7420 6f66 6673 3b0a     size_t offs;.
-00012500: 2020 2020 7369 7a65 5f74 2073 697a 653b      size_t size;
-00012510: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
-00012520: 6c5f 6f62 6a65 6374 202a 206e 6578 743b  l_object * next;
-00012530: 0a0a 2020 2020 6368 6172 2070 6164 6469  ..    char paddi
-00012540: 6e67 5b38 5d3b 0a7d 3b0a 0a73 7461 7469  ng[8];.};..stati
-00012550: 6320 636f 6e73 7420 7369 7a65 5f74 2047  c const size_t G
-00012560: 474d 4c5f 4f42 4a45 4354 5f53 495a 4520  GML_OBJECT_SIZE 
-00012570: 3d20 7369 7a65 6f66 2873 7472 7563 7420  = sizeof(struct 
-00012580: 6767 6d6c 5f6f 626a 6563 7429 3b0a 0a73  ggml_object);..s
-00012590: 7461 7469 635f 6173 7365 7274 2873 697a  tatic_assert(siz
-000125a0: 656f 6628 7374 7275 6374 2067 676d 6c5f  eof(struct ggml_
-000125b0: 6f62 6a65 6374 2925 4747 4d4c 5f4d 454d  object)%GGML_MEM
-000125c0: 5f41 4c49 474e 203d 3d20 302c 2022 6767  _ALIGN == 0, "gg
-000125d0: 6d6c 5f6f 626a 6563 7420 7369 7a65 206d  ml_object size m
-000125e0: 7573 7420 6265 2061 206d 756c 7469 706c  ust be a multipl
-000125f0: 6520 6f66 2047 474d 4c5f 4d45 4d5f 414c  e of GGML_MEM_AL
-00012600: 4947 4e22 293b 0a73 7461 7469 635f 6173  IGN");.static_as
-00012610: 7365 7274 2873 697a 656f 6628 7374 7275  sert(sizeof(stru
-00012620: 6374 2067 676d 6c5f 7465 6e73 6f72 2925  ct ggml_tensor)%
-00012630: 4747 4d4c 5f4d 454d 5f41 4c49 474e 203d  GGML_MEM_ALIGN =
-00012640: 3d20 302c 2022 6767 6d6c 5f74 656e 736f  = 0, "ggml_tenso
-00012650: 7220 7369 7a65 206d 7573 7420 6265 2061  r size must be a
-00012660: 206d 756c 7469 706c 6520 6f66 2047 474d   multiple of GGM
-00012670: 4c5f 4d45 4d5f 414c 4947 4e22 293b 0a0a  L_MEM_ALIGN");..
-00012680: 2f2f 0a2f 2f20 6767 6d6c 2063 6f6e 7465  //.// ggml conte
-00012690: 7874 0a2f 2f0a 0a73 7472 7563 7420 6767  xt.//..struct gg
-000126a0: 6d6c 5f63 6f6e 7465 7874 207b 0a20 2020  ml_context {.   
-000126b0: 2073 697a 655f 7420 6d65 6d5f 7369 7a65   size_t mem_size
-000126c0: 3b0a 2020 2020 766f 6964 202a 206d 656d  ;.    void * mem
-000126d0: 5f62 7566 6665 723b 0a20 2020 2062 6f6f  _buffer;.    boo
-000126e0: 6c20 2020 6d65 6d5f 6275 6666 6572 5f6f  l   mem_buffer_o
-000126f0: 776e 6564 3b0a 0a20 2020 2069 6e74 206e  wned;..    int n
-00012700: 5f6f 626a 6563 7473 3b0a 0a20 2020 2073  _objects;..    s
-00012710: 7472 7563 7420 6767 6d6c 5f6f 626a 6563  truct ggml_objec
-00012720: 7420 2a20 6f62 6a65 6374 735f 6265 6769  t * objects_begi
-00012730: 6e3b 0a20 2020 2073 7472 7563 7420 6767  n;.    struct gg
-00012740: 6d6c 5f6f 626a 6563 7420 2a20 6f62 6a65  ml_object * obje
-00012750: 6374 735f 656e 643b 0a0a 2020 2020 7374  cts_end;..    st
-00012760: 7275 6374 2067 676d 6c5f 7363 7261 7463  ruct ggml_scratc
-00012770: 6820 7363 7261 7463 683b 0a20 2020 2073  h scratch;.    s
-00012780: 7472 7563 7420 6767 6d6c 5f73 6372 6174  truct ggml_scrat
-00012790: 6368 2073 6372 6174 6368 5f73 6176 653b  ch scratch_save;
-000127a0: 0a7d 3b0a 0a73 7472 7563 7420 6767 6d6c  .};..struct ggml
-000127b0: 5f63 6f6e 7465 7874 5f63 6f6e 7461 696e  _context_contain
-000127c0: 6572 207b 0a20 2020 2062 6f6f 6c20 7573  er {.    bool us
-000127d0: 6564 3b0a 0a20 2020 2073 7472 7563 7420  ed;..    struct 
-000127e0: 6767 6d6c 5f63 6f6e 7465 7874 2063 6f6e  ggml_context con
-000127f0: 7465 7874 3b0a 7d3b 0a0a 2f2f 0a2f 2f20  text;.};..//.// 
-00012800: 636f 6d70 7574 6520 7479 7065 730a 2f2f  compute types.//
-00012810: 0a0a 656e 756d 2067 676d 6c5f 7461 736b  ..enum ggml_task
-00012820: 5f74 7970 6520 7b0a 2020 2020 4747 4d4c  _type {.    GGML
-00012830: 5f54 4153 4b5f 494e 4954 203d 2030 2c0a  _TASK_INIT = 0,.
-00012840: 2020 2020 4747 4d4c 5f54 4153 4b5f 434f      GGML_TASK_CO
-00012850: 4d50 5554 452c 0a20 2020 2047 474d 4c5f  MPUTE,.    GGML_
-00012860: 5441 534b 5f46 494e 414c 495a 452c 0a7d  TASK_FINALIZE,.}
-00012870: 3b0a 0a73 7472 7563 7420 6767 6d6c 5f63  ;..struct ggml_c
-00012880: 6f6d 7075 7465 5f70 6172 616d 7320 7b0a  ompute_params {.
-00012890: 2020 2020 656e 756d 2067 676d 6c5f 7461      enum ggml_ta
-000128a0: 736b 5f74 7970 6520 7479 7065 3b0a 0a20  sk_type type;.. 
-000128b0: 2020 2069 6e74 2069 7468 2c20 6e74 683b     int ith, nth;
-000128c0: 0a0a 2020 2020 2f2f 2077 6f72 6b20 6275  ..    // work bu
-000128d0: 6666 6572 2066 6f72 2061 6c6c 2074 6872  ffer for all thr
-000128e0: 6561 6473 0a20 2020 2073 697a 655f 7420  eads.    size_t 
-000128f0: 7773 697a 653b 0a20 2020 2076 6f69 6420  wsize;.    void 
-00012900: 2a20 7764 6174 613b 0a7d 3b0a 0a2f 2f0a  * wdata;.};..//.
-00012910: 2f2f 2067 676d 6c20 7374 6174 650a 2f2f  // ggml state.//
-00012920: 0a0a 7374 7275 6374 2067 676d 6c5f 7374  ..struct ggml_st
-00012930: 6174 6520 7b0a 2020 2020 7374 7275 6374  ate {.    struct
-00012940: 2067 676d 6c5f 636f 6e74 6578 745f 636f   ggml_context_co
-00012950: 6e74 6169 6e65 7220 636f 6e74 6578 7473  ntainer contexts
-00012960: 5b47 474d 4c5f 4d41 585f 434f 4e54 4558  [GGML_MAX_CONTEX
-00012970: 5453 5d3b 0a7d 3b0a 0a2f 2f20 676c 6f62  TS];.};..// glob
-00012980: 616c 2073 7461 7465 0a73 7461 7469 6320  al state.static 
-00012990: 7374 7275 6374 2067 676d 6c5f 7374 6174  struct ggml_stat
-000129a0: 6520 675f 7374 6174 653b 0a73 7461 7469  e g_state;.stati
-000129b0: 6320 6174 6f6d 6963 5f69 6e74 2067 5f73  c atomic_int g_s
-000129c0: 7461 7465 5f62 6172 7269 6572 203d 2030  tate_barrier = 0
-000129d0: 3b0a 0a2f 2f20 6261 7272 6965 7220 7669  ;..// barrier vi
-000129e0: 6120 7370 696e 206c 6f63 6b0a 696e 6c69  a spin lock.inli
-000129f0: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
-00012a00: 676d 6c5f 6372 6974 6963 616c 5f73 6563  gml_critical_sec
-00012a10: 7469 6f6e 5f73 7461 7274 2876 6f69 6429  tion_start(void)
-00012a20: 207b 0a20 2020 2069 6e74 2070 726f 6365   {.    int proce
-00012a30: 7373 696e 6720 3d20 6174 6f6d 6963 5f66  ssing = atomic_f
-00012a40: 6574 6368 5f61 6464 2826 675f 7374 6174  etch_add(&g_stat
-00012a50: 655f 6261 7272 6965 722c 2031 293b 0a0a  e_barrier, 1);..
-00012a60: 2020 2020 7768 696c 6520 2870 726f 6365      while (proce
-00012a70: 7373 696e 6720 3e20 3029 207b 0a20 2020  ssing > 0) {.   
-00012a80: 2020 2020 202f 2f20 7761 6974 2066 6f72       // wait for
-00012a90: 206f 7468 6572 2074 6872 6561 6473 2074   other threads t
-00012aa0: 6f20 6669 6e69 7368 0a20 2020 2020 2020  o finish.       
-00012ab0: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
-00012ac0: 6228 2667 5f73 7461 7465 5f62 6172 7269  b(&g_state_barri
-00012ad0: 6572 2c20 3129 3b0a 2020 2020 2020 2020  er, 1);.        
-00012ae0: 7363 6865 645f 7969 656c 6428 293b 202f  sched_yield(); /
-00012af0: 2f20 544f 444f 3a20 7265 636f 6e73 6964  / TODO: reconsid
-00012b00: 6572 2074 6869 730a 2020 2020 2020 2020  er this.        
-00012b10: 7072 6f63 6573 7369 6e67 203d 2061 746f  processing = ato
-00012b20: 6d69 635f 6665 7463 685f 6164 6428 2667  mic_fetch_add(&g
-00012b30: 5f73 7461 7465 5f62 6172 7269 6572 2c20  _state_barrier, 
-00012b40: 3129 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  1);.    }.}..// 
-00012b50: 544f 444f 3a20 6d61 6b65 2074 6869 7320  TODO: make this 
-00012b60: 736f 6d65 686f 7720 6175 746f 6d61 7469  somehow automati
-00012b70: 6361 6c6c 7920 6578 6563 7574 6564 0a2f  cally executed./
-00012b80: 2f20 2020 2020 2020 736f 6d65 2073 6f72  /       some sor
-00012b90: 7420 6f66 2022 7365 6e74 7279 2220 6d65  t of "sentry" me
-00012ba0: 6368 616e 6973 6d0a 696e 6c69 6e65 2073  chanism.inline s
-00012bb0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00012bc0: 6372 6974 6963 616c 5f73 6563 7469 6f6e  critical_section
-00012bd0: 5f65 6e64 2876 6f69 6429 207b 0a20 2020  _end(void) {.   
-00012be0: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
-00012bf0: 6228 2667 5f73 7461 7465 5f62 6172 7269  b(&g_state_barri
-00012c00: 6572 2c20 3129 3b0a 7d0a 0a2f 2f2f 2f2f  er, 1);.}../////
-00012c10: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00012c20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00012c30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00012c40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00012c50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a76 6f69  ///////////..voi
-00012c60: 6420 6767 6d6c 5f70 7269 6e74 5f6f 626a  d ggml_print_obj
-00012c70: 6563 7428 636f 6e73 7420 7374 7275 6374  ect(const struct
-00012c80: 2067 676d 6c5f 6f62 6a65 6374 202a 206f   ggml_object * o
-00012c90: 626a 2920 7b0a 2020 2020 4747 4d4c 5f50  bj) {.    GGML_P
-00012ca0: 5249 4e54 2822 202d 2067 676d 6c5f 6f62  RINT(" - ggml_ob
-00012cb0: 6a65 6374 3a20 6f66 6673 6574 203d 2025  ject: offset = %
-00012cc0: 7a75 2c20 7369 7a65 203d 2025 7a75 2c20  zu, size = %zu, 
-00012cd0: 6e65 7874 203d 2025 705c 6e22 2c0a 2020  next = %p\n",.  
-00012ce0: 2020 2020 2020 2020 2020 6f62 6a2d 3e6f            obj->o
-00012cf0: 6666 732c 206f 626a 2d3e 7369 7a65 2c20  ffs, obj->size, 
-00012d00: 2863 6f6e 7374 2076 6f69 6420 2a29 206f  (const void *) o
-00012d10: 626a 2d3e 6e65 7874 293b 0a7d 0a0a 766f  bj->next);.}..vo
-00012d20: 6964 2067 676d 6c5f 7072 696e 745f 6f62  id ggml_print_ob
-00012d30: 6a65 6374 7328 636f 6e73 7420 7374 7275  jects(const stru
-00012d40: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00012d50: 2a20 6374 7829 207b 0a20 2020 2073 7472  * ctx) {.    str
-00012d60: 7563 7420 6767 6d6c 5f6f 626a 6563 7420  uct ggml_object 
-00012d70: 2a20 6f62 6a20 3d20 6374 782d 3e6f 626a  * obj = ctx->obj
-00012d80: 6563 7473 5f62 6567 696e 3b0a 0a20 2020  ects_begin;..   
-00012d90: 2047 474d 4c5f 5052 494e 5428 2225 733a   GGML_PRINT("%s:
-00012da0: 206f 626a 6563 7473 2069 6e20 636f 6e74   objects in cont
-00012db0: 6578 7420 2570 3a5c 6e22 2c20 5f5f 6675  ext %p:\n", __fu
-00012dc0: 6e63 5f5f 2c20 2863 6f6e 7374 2076 6f69  nc__, (const voi
-00012dd0: 6420 2a29 2063 7478 293b 0a0a 2020 2020  d *) ctx);..    
-00012de0: 7768 696c 6520 286f 626a 2021 3d20 4e55  while (obj != NU
-00012df0: 4c4c 2920 7b0a 2020 2020 2020 2020 6767  LL) {.        gg
-00012e00: 6d6c 5f70 7269 6e74 5f6f 626a 6563 7428  ml_print_object(
-00012e10: 6f62 6a29 3b0a 2020 2020 2020 2020 6f62  obj);.        ob
-00012e20: 6a20 3d20 6f62 6a2d 3e6e 6578 743b 0a20  j = obj->next;. 
-00012e30: 2020 207d 0a0a 2020 2020 4747 4d4c 5f50     }..    GGML_P
-00012e40: 5249 4e54 2822 2573 3a20 2d2d 2d20 656e  RINT("%s: --- en
-00012e50: 6420 2d2d 2d5c 6e22 2c20 5f5f 6675 6e63  d ---\n", __func
-00012e60: 5f5f 293b 0a7d 0a0a 696e 7420 6767 6d6c  __);.}..int ggml
-00012e70: 5f6e 656c 656d 656e 7473 2863 6f6e 7374  _nelements(const
-00012e80: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00012e90: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
-00012ea0: 2020 2020 7374 6174 6963 5f61 7373 6572      static_asser
-00012eb0: 7428 4747 4d4c 5f4d 4158 5f44 494d 5320  t(GGML_MAX_DIMS 
-00012ec0: 3d3d 2034 2c20 2247 474d 4c5f 4d41 585f  == 4, "GGML_MAX_
-00012ed0: 4449 4d53 2069 7320 6e6f 7420 3420 2d20  DIMS is not 4 - 
-00012ee0: 7570 6461 7465 2074 6869 7320 6675 6e63  update this func
-00012ef0: 7469 6f6e 2229 3b0a 0a20 2020 2072 6574  tion");..    ret
-00012f00: 7572 6e20 7465 6e73 6f72 2d3e 6e65 5b30  urn tensor->ne[0
-00012f10: 5d2a 7465 6e73 6f72 2d3e 6e65 5b31 5d2a  ]*tensor->ne[1]*
-00012f20: 7465 6e73 6f72 2d3e 6e65 5b32 5d2a 7465  tensor->ne[2]*te
-00012f30: 6e73 6f72 2d3e 6e65 5b33 5d3b 0a7d 0a0a  nsor->ne[3];.}..
-00012f40: 696e 7420 6767 6d6c 5f6e 726f 7773 2863  int ggml_nrows(c
-00012f50: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00012f60: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-00012f70: 2920 7b0a 2020 2020 7374 6174 6963 5f61  ) {.    static_a
-00012f80: 7373 6572 7428 4747 4d4c 5f4d 4158 5f44  ssert(GGML_MAX_D
-00012f90: 494d 5320 3d3d 2034 2c20 2247 474d 4c5f  IMS == 4, "GGML_
-00012fa0: 4d41 585f 4449 4d53 2069 7320 6e6f 7420  MAX_DIMS is not 
-00012fb0: 3420 2d20 7570 6461 7465 2074 6869 7320  4 - update this 
-00012fc0: 6675 6e63 7469 6f6e 2229 3b0a 0a20 2020  function");..   
-00012fd0: 2072 6574 7572 6e20 7465 6e73 6f72 2d3e   return tensor->
-00012fe0: 6e65 5b31 5d2a 7465 6e73 6f72 2d3e 6e65  ne[1]*tensor->ne
-00012ff0: 5b32 5d2a 7465 6e73 6f72 2d3e 6e65 5b33  [2]*tensor->ne[3
-00013000: 5d3b 0a7d 0a0a 7369 7a65 5f74 2067 676d  ];.}..size_t ggm
-00013010: 6c5f 6e62 7974 6573 2863 6f6e 7374 2073  l_nbytes(const s
-00013020: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00013030: 7220 2a20 7465 6e73 6f72 2920 7b0a 2020  r * tensor) {.  
-00013040: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
-00013050: 4747 4d4c 5f4d 4158 5f44 494d 5320 3d3d  GGML_MAX_DIMS ==
-00013060: 2034 2c20 2247 474d 4c5f 4d41 585f 4449   4, "GGML_MAX_DI
-00013070: 4d53 2069 7320 6e6f 7420 3420 2d20 7570  MS is not 4 - up
-00013080: 6461 7465 2074 6869 7320 6675 6e63 7469  date this functi
-00013090: 6f6e 2229 3b0a 0a20 2020 2072 6574 7572  on");..    retur
-000130a0: 6e20 2867 676d 6c5f 6e65 6c65 6d65 6e74  n (ggml_nelement
-000130b0: 7328 7465 6e73 6f72 292a 4747 4d4c 5f54  s(tensor)*GGML_T
-000130c0: 5950 455f 5349 5a45 5b74 656e 736f 722d  YPE_SIZE[tensor-
-000130d0: 3e74 7970 655d 292f 4747 4d4c 5f42 4c43  >type])/GGML_BLC
-000130e0: 4b5f 5349 5a45 5b74 656e 736f 722d 3e74  K_SIZE[tensor->t
-000130f0: 7970 655d 3b0a 7d0a 0a69 6e74 2067 676d  ype];.}..int ggm
-00013100: 6c5f 626c 636b 5f73 697a 6528 656e 756d  l_blck_size(enum
-00013110: 2067 676d 6c5f 7479 7065 2074 7970 6529   ggml_type type)
-00013120: 207b 0a20 2020 2072 6574 7572 6e20 4747   {.    return GG
-00013130: 4d4c 5f42 4c43 4b5f 5349 5a45 5b74 7970  ML_BLCK_SIZE[typ
-00013140: 655d 3b0a 7d0a 0a73 697a 655f 7420 6767  e];.}..size_t gg
-00013150: 6d6c 5f74 7970 655f 7369 7a65 2865 6e75  ml_type_size(enu
-00013160: 6d20 6767 6d6c 5f74 7970 6520 7479 7065  m ggml_type type
-00013170: 2920 7b0a 2020 2020 7265 7475 726e 2047  ) {.    return G
-00013180: 474d 4c5f 5459 5045 5f53 495a 455b 7479  GML_TYPE_SIZE[ty
-00013190: 7065 5d3b 0a7d 0a0a 666c 6f61 7420 6767  pe];.}..float gg
-000131a0: 6d6c 5f74 7970 655f 7369 7a65 6628 656e  ml_type_sizef(en
-000131b0: 756d 2067 676d 6c5f 7479 7065 2074 7970  um ggml_type typ
-000131c0: 6529 207b 0a20 2020 2072 6574 7572 6e20  e) {.    return 
-000131d0: 2828 666c 6f61 7429 2847 474d 4c5f 5459  ((float)(GGML_TY
-000131e0: 5045 5f53 495a 455b 7479 7065 5d29 292f  PE_SIZE[type]))/
-000131f0: 4747 4d4c 5f42 4c43 4b5f 5349 5a45 5b74  GGML_BLCK_SIZE[t
-00013200: 7970 655d 3b0a 7d0a 0a73 697a 655f 7420  ype];.}..size_t 
-00013210: 6767 6d6c 5f65 6c65 6d65 6e74 5f73 697a  ggml_element_siz
-00013220: 6528 636f 6e73 7420 7374 7275 6374 2067  e(const struct g
-00013230: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
-00013240: 736f 7229 207b 0a20 2020 2072 6574 7572  sor) {.    retur
-00013250: 6e20 4747 4d4c 5f54 5950 455f 5349 5a45  n GGML_TYPE_SIZE
-00013260: 5b74 656e 736f 722d 3e74 7970 655d 3b0a  [tensor->type];.
-00013270: 7d0a 0a73 7461 7469 6320 696e 6c69 6e65  }..static inline
-00013280: 2062 6f6f 6c20 6767 6d6c 5f69 735f 7363   bool ggml_is_sc
-00013290: 616c 6172 2863 6f6e 7374 2073 7472 7563  alar(const struc
-000132a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000132b0: 7465 6e73 6f72 2920 7b0a 2020 2020 7374  tensor) {.    st
-000132c0: 6174 6963 5f61 7373 6572 7428 4747 4d4c  atic_assert(GGML
-000132d0: 5f4d 4158 5f44 494d 5320 3d3d 2034 2c20  _MAX_DIMS == 4, 
-000132e0: 2247 474d 4c5f 4d41 585f 4449 4d53 2069  "GGML_MAX_DIMS i
-000132f0: 7320 6e6f 7420 3420 2d20 7570 6461 7465  s not 4 - update
-00013300: 2074 6869 7320 6675 6e63 7469 6f6e 2229   this function")
-00013310: 3b0a 0a20 2020 2072 6574 7572 6e20 7465  ;..    return te
-00013320: 6e73 6f72 2d3e 6e65 5b30 5d20 3d3d 2031  nsor->ne[0] == 1
-00013330: 2026 2620 7465 6e73 6f72 2d3e 6e65 5b31   && tensor->ne[1
-00013340: 5d20 3d3d 2031 2026 2620 7465 6e73 6f72  ] == 1 && tensor
-00013350: 2d3e 6e65 5b32 5d20 3d3d 2031 2026 2620  ->ne[2] == 1 && 
-00013360: 7465 6e73 6f72 2d3e 6e65 5b33 5d20 3d3d  tensor->ne[3] ==
-00013370: 2031 3b0a 7d0a 0a73 7461 7469 6320 696e   1;.}..static in
-00013380: 6c69 6e65 2062 6f6f 6c20 6767 6d6c 5f69  line bool ggml_i
-00013390: 735f 7665 6374 6f72 2863 6f6e 7374 2073  s_vector(const s
-000133a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000133b0: 7220 2a20 7465 6e73 6f72 2920 7b0a 2020  r * tensor) {.  
-000133c0: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
-000133d0: 4747 4d4c 5f4d 4158 5f44 494d 5320 3d3d  GGML_MAX_DIMS ==
-000133e0: 2034 2c20 2247 474d 4c5f 4d41 585f 4449   4, "GGML_MAX_DI
-000133f0: 4d53 2069 7320 6e6f 7420 3420 2d20 7570  MS is not 4 - up
-00013400: 6461 7465 2074 6869 7320 6675 6e63 7469  date this functi
-00013410: 6f6e 2229 3b0a 0a20 2020 2072 6574 7572  on");..    retur
-00013420: 6e20 7465 6e73 6f72 2d3e 6e65 5b31 5d20  n tensor->ne[1] 
-00013430: 3d3d 2031 2026 2620 7465 6e73 6f72 2d3e  == 1 && tensor->
-00013440: 6e65 5b32 5d20 3d3d 2031 2026 2620 7465  ne[2] == 1 && te
-00013450: 6e73 6f72 2d3e 6e65 5b33 5d20 3d3d 2031  nsor->ne[3] == 1
-00013460: 3b0a 7d0a 0a73 7461 7469 6320 696e 6c69  ;.}..static inli
-00013470: 6e65 2062 6f6f 6c20 6767 6d6c 5f69 735f  ne bool ggml_is_
-00013480: 6d61 7472 6978 2863 6f6e 7374 2073 7472  matrix(const str
-00013490: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000134a0: 2a20 7465 6e73 6f72 2920 7b0a 2020 2020  * tensor) {.    
-000134b0: 7374 6174 6963 5f61 7373 6572 7428 4747  static_assert(GG
-000134c0: 4d4c 5f4d 4158 5f44 494d 5320 3d3d 2034  ML_MAX_DIMS == 4
-000134d0: 2c20 2247 474d 4c5f 4d41 585f 4449 4d53  , "GGML_MAX_DIMS
-000134e0: 2069 7320 6e6f 7420 3420 2d20 7570 6461   is not 4 - upda
-000134f0: 7465 2074 6869 7320 6675 6e63 7469 6f6e  te this function
-00013500: 2229 3b0a 0a20 2020 2072 6574 7572 6e20  ");..    return 
-00013510: 7465 6e73 6f72 2d3e 6e65 5b32 5d20 3d3d  tensor->ne[2] ==
-00013520: 2031 2026 2620 7465 6e73 6f72 2d3e 6e65   1 && tensor->ne
-00013530: 5b33 5d20 3d3d 2031 3b0a 7d0a 0a73 7461  [3] == 1;.}..sta
-00013540: 7469 6320 696e 6c69 6e65 2062 6f6f 6c20  tic inline bool 
-00013550: 6767 6d6c 5f63 616e 5f6d 756c 5f6d 6174  ggml_can_mul_mat
-00013560: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
-00013570: 6d6c 5f74 656e 736f 7220 2a20 7430 2c20  ml_tensor * t0, 
-00013580: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00013590: 6c5f 7465 6e73 6f72 202a 2074 3129 207b  l_tensor * t1) {
-000135a0: 0a20 2020 2073 7461 7469 635f 6173 7365  .    static_asse
-000135b0: 7274 2847 474d 4c5f 4d41 585f 4449 4d53  rt(GGML_MAX_DIMS
-000135c0: 203d 3d20 342c 2022 4747 4d4c 5f4d 4158   == 4, "GGML_MAX
-000135d0: 5f44 494d 5320 6973 206e 6f74 2034 202d  _DIMS is not 4 -
-000135e0: 2075 7064 6174 6520 7468 6973 2066 756e   update this fun
-000135f0: 6374 696f 6e22 293b 0a0a 2020 2020 7265  ction");..    re
-00013600: 7475 726e 0a20 2020 2020 2020 2028 7430  turn.        (t0
-00013610: 2d3e 6e65 5b30 5d20 203d 3d20 7431 2d3e  ->ne[0]  == t1->
-00013620: 6e65 5b30 5d29 2020 2626 0a20 2020 2020  ne[0])  &&.     
-00013630: 2020 2028 7430 2d3e 6e65 5b32 5d20 203d     (t0->ne[2]  =
-00013640: 3d20 7431 2d3e 6e65 5b32 5d29 2020 2626  = t1->ne[2])  &&
-00013650: 0a20 2020 2020 2020 2028 7430 2d3e 6e65  .        (t0->ne
-00013660: 5b33 5d20 203d 3d20 7431 2d3e 6e65 5b33  [3]  == t1->ne[3
-00013670: 5d29 3b0a 7d0a 0a73 7461 7469 6320 696e  ]);.}..static in
-00013680: 6c69 6e65 2062 6f6f 6c20 6767 6d6c 5f69  line bool ggml_i
-00013690: 735f 636f 6e74 6967 756f 7573 2863 6f6e  s_contiguous(con
-000136a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000136b0: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
-000136c0: 7b0a 2020 2020 7374 6174 6963 5f61 7373  {.    static_ass
-000136d0: 6572 7428 4747 4d4c 5f4d 4158 5f44 494d  ert(GGML_MAX_DIM
-000136e0: 5320 3d3d 2034 2c20 2247 474d 4c5f 4d41  S == 4, "GGML_MA
-000136f0: 585f 4449 4d53 2069 7320 6e6f 7420 3420  X_DIMS is not 4 
-00013700: 2d20 7570 6461 7465 2074 6869 7320 6675  - update this fu
-00013710: 6e63 7469 6f6e 2229 3b0a 0a20 2020 2072  nction");..    r
-00013720: 6574 7572 6e0a 2020 2020 2020 2020 7465  eturn.        te
-00013730: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2047  nsor->nb[0] == G
-00013740: 474d 4c5f 5459 5045 5f53 495a 455b 7465  GML_TYPE_SIZE[te
-00013750: 6e73 6f72 2d3e 7479 7065 5d20 2626 0a20  nsor->type] &&. 
-00013760: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
-00013770: 625b 315d 203d 3d20 2874 656e 736f 722d  b[1] == (tensor-
-00013780: 3e6e 625b 305d 2a74 656e 736f 722d 3e6e  >nb[0]*tensor->n
-00013790: 655b 305d 292f 4747 4d4c 5f42 4c43 4b5f  e[0])/GGML_BLCK_
-000137a0: 5349 5a45 5b74 656e 736f 722d 3e74 7970  SIZE[tensor->typ
-000137b0: 655d 2026 260a 2020 2020 2020 2020 7465  e] &&.        te
-000137c0: 6e73 6f72 2d3e 6e62 5b32 5d20 3d3d 2074  nsor->nb[2] == t
-000137d0: 656e 736f 722d 3e6e 625b 315d 2a74 656e  ensor->nb[1]*ten
-000137e0: 736f 722d 3e6e 655b 315d 2026 260a 2020  sor->ne[1] &&.  
-000137f0: 2020 2020 2020 7465 6e73 6f72 2d3e 6e62        tensor->nb
-00013800: 5b33 5d20 3d3d 2074 656e 736f 722d 3e6e  [3] == tensor->n
-00013810: 625b 325d 2a74 656e 736f 722d 3e6e 655b  b[2]*tensor->ne[
-00013820: 325d 3b0a 7d0a 0a73 7461 7469 6320 696e  2];.}..static in
-00013830: 6c69 6e65 2062 6f6f 6c20 6767 6d6c 5f69  line bool ggml_i
-00013840: 735f 7061 6464 6564 5f31 6428 636f 6e73  s_padded_1d(cons
-00013850: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00013860: 6e73 6f72 202a 2074 656e 736f 7229 207b  nsor * tensor) {
-00013870: 0a20 2020 2073 7461 7469 635f 6173 7365  .    static_asse
-00013880: 7274 2847 474d 4c5f 4d41 585f 4449 4d53  rt(GGML_MAX_DIMS
-00013890: 203d 3d20 342c 2022 4747 4d4c 5f4d 4158   == 4, "GGML_MAX
-000138a0: 5f44 494d 5320 6973 206e 6f74 2034 202d  _DIMS is not 4 -
-000138b0: 2075 7064 6174 6520 7468 6973 2066 756e   update this fun
-000138c0: 6374 696f 6e22 293b 0a0a 2020 2020 7265  ction");..    re
-000138d0: 7475 726e 0a20 2020 2020 2020 2074 656e  turn.        ten
-000138e0: 736f 722d 3e6e 625b 305d 203d 3d20 4747  sor->nb[0] == GG
-000138f0: 4d4c 5f54 5950 455f 5349 5a45 5b74 656e  ML_TYPE_SIZE[ten
-00013900: 736f 722d 3e74 7970 655d 2026 260a 2020  sor->type] &&.  
-00013910: 2020 2020 2020 7465 6e73 6f72 2d3e 6e62        tensor->nb
-00013920: 5b32 5d20 3d3d 2074 656e 736f 722d 3e6e  [2] == tensor->n
-00013930: 625b 315d 2a74 656e 736f 722d 3e6e 655b  b[1]*tensor->ne[
-00013940: 315d 2026 260a 2020 2020 2020 2020 7465  1] &&.        te
-00013950: 6e73 6f72 2d3e 6e62 5b33 5d20 3d3d 2074  nsor->nb[3] == t
-00013960: 656e 736f 722d 3e6e 625b 325d 2a74 656e  ensor->nb[2]*ten
-00013970: 736f 722d 3e6e 655b 325d 3b0a 7d0a 0a73  sor->ne[2];.}..s
-00013980: 7461 7469 6320 696e 6c69 6e65 2062 6f6f  tatic inline boo
-00013990: 6c20 6767 6d6c 5f61 7265 5f73 616d 655f  l ggml_are_same_
-000139a0: 7368 6170 6528 636f 6e73 7420 7374 7275  shape(const stru
-000139b0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000139c0: 2074 302c 2063 6f6e 7374 2073 7472 7563   t0, const struc
-000139d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000139e0: 7431 2920 7b0a 2020 2020 7374 6174 6963  t1) {.    static
-000139f0: 5f61 7373 6572 7428 4747 4d4c 5f4d 4158  _assert(GGML_MAX
-00013a00: 5f44 494d 5320 3d3d 2034 2c20 2247 474d  _DIMS == 4, "GGM
-00013a10: 4c5f 4d41 585f 4449 4d53 2069 7320 6e6f  L_MAX_DIMS is no
-00013a20: 7420 3420 2d20 7570 6461 7465 2074 6869  t 4 - update thi
-00013a30: 7320 6675 6e63 7469 6f6e 2229 3b0a 0a20  s function");.. 
-00013a40: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00013a50: 2020 2874 302d 3e6e 655b 305d 203d 3d20    (t0->ne[0] == 
-00013a60: 7431 2d3e 6e65 5b30 5d20 2920 2626 0a20  t1->ne[0] ) &&. 
-00013a70: 2020 2020 2020 2028 7430 2d3e 6e65 5b31         (t0->ne[1
-00013a80: 5d20 3d3d 2074 312d 3e6e 655b 315d 2029  ] == t1->ne[1] )
-00013a90: 2026 260a 2020 2020 2020 2020 2874 302d   &&.        (t0-
-00013aa0: 3e6e 655b 325d 203d 3d20 7431 2d3e 6e65  >ne[2] == t1->ne
-00013ab0: 5b32 5d20 2920 2626 0a20 2020 2020 2020  [2] ) &&.       
-00013ac0: 2028 7430 2d3e 6e65 5b33 5d20 3d3d 2074   (t0->ne[3] == t
-00013ad0: 312d 3e6e 655b 335d 2029 3b0a 7d0a 0a2f  1->ne[3] );.}../
-00013ae0: 2f20 6368 6563 6b20 6966 2074 3120 6361  / check if t1 ca
-00013af0: 6e20 6265 2072 6570 7265 7365 6e74 6564  n be represented
-00013b00: 2061 7320 6120 7265 7065 6174 6974 696f   as a repeatitio
-00013b10: 6e20 6f66 2074 300a 7374 6174 6963 2069  n of t0.static i
-00013b20: 6e6c 696e 6520 626f 6f6c 2067 676d 6c5f  nline bool ggml_
-00013b30: 6361 6e5f 7265 7065 6174 2863 6f6e 7374  can_repeat(const
-00013b40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00013b50: 736f 7220 2a20 7430 2c20 636f 6e73 7420  sor * t0, const 
-00013b60: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00013b70: 6f72 202a 2074 3129 207b 0a20 2020 2073  or * t1) {.    s
-00013b80: 7461 7469 635f 6173 7365 7274 2847 474d  tatic_assert(GGM
-00013b90: 4c5f 4d41 585f 4449 4d53 203d 3d20 342c  L_MAX_DIMS == 4,
-00013ba0: 2022 4747 4d4c 5f4d 4158 5f44 494d 5320   "GGML_MAX_DIMS 
-00013bb0: 6973 206e 6f74 2034 202d 2075 7064 6174  is not 4 - updat
-00013bc0: 6520 7468 6973 2066 756e 6374 696f 6e22  e this function"
-00013bd0: 293b 0a0a 2020 2020 7265 7475 726e 0a20  );..    return. 
-00013be0: 2020 2020 2020 2028 7431 2d3e 6e65 5b30         (t1->ne[0
-00013bf0: 5d25 7430 2d3e 6e65 5b30 5d20 3d3d 2030  ]%t0->ne[0] == 0
-00013c00: 2920 2626 0a20 2020 2020 2020 2028 7431  ) &&.        (t1
-00013c10: 2d3e 6e65 5b31 5d25 7430 2d3e 6e65 5b31  ->ne[1]%t0->ne[1
-00013c20: 5d20 3d3d 2030 2920 2626 0a20 2020 2020  ] == 0) &&.     
-00013c30: 2020 2028 7431 2d3e 6e65 5b32 5d25 7430     (t1->ne[2]%t0
-00013c40: 2d3e 6e65 5b32 5d20 3d3d 2030 2920 2626  ->ne[2] == 0) &&
-00013c50: 0a20 2020 2020 2020 2028 7431 2d3e 6e65  .        (t1->ne
-00013c60: 5b33 5d25 7430 2d3e 6e65 5b33 5d20 3d3d  [3]%t0->ne[3] ==
-00013c70: 2030 293b 0a7d 0a0a 7374 6174 6963 2069   0);.}..static i
-00013c80: 6e6c 696e 6520 696e 7420 6767 6d6c 5f75  nline int ggml_u
-00013c90: 7033 3228 696e 7420 6e29 207b 0a20 2020  p32(int n) {.   
-00013ca0: 2072 6574 7572 6e20 286e 202b 2033 3129   return (n + 31)
-00013cb0: 2026 207e 3331 3b0a 7d0a 0a73 7461 7469   & ~31;.}..stati
-00013cc0: 6320 696e 6c69 6e65 2069 6e74 2067 676d  c inline int ggm
-00013cd0: 6c5f 7570 3634 2869 6e74 206e 2920 7b0a  l_up64(int n) {.
-00013ce0: 2020 2020 7265 7475 726e 2028 6e20 2b20      return (n + 
-00013cf0: 3633 2920 2620 7e36 333b 0a7d 0a0a 7374  63) & ~63;.}..st
-00013d00: 6174 6963 2069 6e6c 696e 6520 696e 7420  atic inline int 
-00013d10: 6767 6d6c 5f75 7028 696e 7420 6e2c 2069  ggml_up(int n, i
-00013d20: 6e74 206d 2920 7b0a 2020 2020 2f2f 2061  nt m) {.    // a
-00013d30: 7373 6572 7420 6d20 6973 2061 2070 6f77  ssert m is a pow
-00013d40: 6572 206f 6620 320a 2020 2020 4747 4d4c  er of 2.    GGML
-00013d50: 5f41 5353 4552 5428 286d 2026 2028 6d20  _ASSERT((m & (m 
-00013d60: 2d20 3129 2920 3d3d 2030 293b 0a20 2020  - 1)) == 0);.   
-00013d70: 2072 6574 7572 6e20 286e 202b 206d 202d   return (n + m -
-00013d80: 2031 2920 2620 7e28 6d20 2d20 3129 3b0a   1) & ~(m - 1);.
-00013d90: 7d0a 0a2f 2f20 6173 7365 7274 2074 6861  }..// assert tha
-00013da0: 7420 706f 696e 7465 7220 6973 2061 6c69  t pointer is ali
-00013db0: 676e 6564 2074 6f20 4747 4d4c 5f4d 454d  gned to GGML_MEM
-00013dc0: 5f41 4c49 474e 0a23 6465 6669 6e65 2067  _ALIGN.#define g
-00013dd0: 676d 6c5f 6173 7365 7274 5f61 6c69 676e  gml_assert_align
-00013de0: 6564 2870 7472 2920 5c0a 2020 2020 6173  ed(ptr) \.    as
-00013df0: 7365 7274 2828 2875 696e 7470 7472 5f74  sert(((uintptr_t
-00013e00: 2920 2870 7472 2929 2547 474d 4c5f 4d45  ) (ptr))%GGML_ME
-00013e10: 4d5f 414c 4947 4e20 3d3d 2030 290a 0a2f  M_ALIGN == 0)../
-00013e20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00013e30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00013e40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00013e50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00013e60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
-00013e70: 0a73 7472 7563 7420 6767 6d6c 5f63 6f6e  .struct ggml_con
-00013e80: 7465 7874 202a 2067 676d 6c5f 696e 6974  text * ggml_init
-00013e90: 2873 7472 7563 7420 6767 6d6c 5f69 6e69  (struct ggml_ini
-00013ea0: 745f 7061 7261 6d73 2070 6172 616d 7329  t_params params)
-00013eb0: 207b 0a20 2020 202f 2f20 6d61 6b65 2074   {.    // make t
-00013ec0: 6869 7320 6675 6e63 7469 6f6e 2074 6872  his function thr
-00013ed0: 6561 6420 7361 6665 0a20 2020 2067 676d  ead safe.    ggm
-00013ee0: 6c5f 6372 6974 6963 616c 5f73 6563 7469  l_critical_secti
-00013ef0: 6f6e 5f73 7461 7274 2829 3b0a 0a20 2020  on_start();..   
-00013f00: 2073 7461 7469 6320 626f 6f6c 2069 735f   static bool is_
-00013f10: 6669 7273 745f 6361 6c6c 203d 2074 7275  first_call = tru
-00013f20: 653b 0a0a 2020 2020 6966 2028 6973 5f66  e;..    if (is_f
-00013f30: 6972 7374 5f63 616c 6c29 207b 0a20 2020  irst_call) {.   
-00013f40: 2020 2020 202f 2f20 696e 6974 6961 6c69       // initiali
-00013f50: 7a65 2047 454c 552c 2053 494c 5520 616e  ze GELU, SILU an
-00013f60: 6420 4558 5020 4633 3220 7461 626c 6573  d EXP F32 tables
-00013f70: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-00013f80: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-00013f90: 7436 345f 7420 745f 7374 6172 7420 3d20  t64_t t_start = 
-00013fa0: 6767 6d6c 5f74 696d 655f 7573 2829 3b20  ggml_time_us(); 
-00013fb0: 554e 5553 4544 2874 5f73 7461 7274 293b  UNUSED(t_start);
-00013fc0: 0a0a 2020 2020 2020 2020 2020 2020 6767  ..            gg
-00013fd0: 6d6c 5f66 7031 365f 7420 6969 3b0a 2020  ml_fp16_t ii;.  
-00013fe0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00013ff0: 6e74 2069 203d 2030 3b20 6920 3c20 2831  nt i = 0; i < (1
-00014000: 203c 3c20 3136 293b 202b 2b69 2920 7b0a   << 16); ++i) {.
-00014010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014020: 7569 6e74 3136 5f74 2075 6920 3d20 693b  uint16_t ui = i;
-00014030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014040: 206d 656d 6370 7928 2669 692c 2026 7569   memcpy(&ii, &ui
-00014050: 2c20 7369 7a65 6f66 2869 6929 293b 0a20  , sizeof(ii));. 
-00014060: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00014070: 6f6e 7374 2066 6c6f 6174 2066 203d 2074  onst float f = t
-00014080: 6162 6c65 5f66 3332 5f66 3136 5b69 5d20  able_f32_f16[i] 
-00014090: 3d20 4747 4d4c 5f43 4f4d 5055 5445 5f46  = GGML_COMPUTE_F
-000140a0: 5031 365f 544f 5f46 5033 3228 6969 293b  P16_TO_FP32(ii);
-000140b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000140c0: 2074 6162 6c65 5f67 656c 755f 6631 365b   table_gelu_f16[
-000140d0: 695d 203d 2047 474d 4c5f 4650 3332 5f54  i] = GGML_FP32_T
-000140e0: 4f5f 4650 3136 2867 676d 6c5f 6765 6c75  O_FP16(ggml_gelu
-000140f0: 5f66 3332 2866 2929 3b0a 2020 2020 2020  _f32(f));.      
-00014100: 2020 2020 2020 2020 2020 7461 626c 655f            table_
-00014110: 7369 6c75 5f66 3136 5b69 5d20 3d20 4747  silu_f16[i] = GG
-00014120: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-00014130: 6767 6d6c 5f73 696c 755f 6633 3228 6629  ggml_silu_f32(f)
-00014140: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00014150: 2020 2074 6162 6c65 5f65 7870 5f66 3136     table_exp_f16
-00014160: 5b69 5d20 203d 2047 474d 4c5f 4650 3332  [i]  = GGML_FP32
-00014170: 5f54 4f5f 4650 3136 2865 7870 2866 2929  _TO_FP16(exp(f))
-00014180: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00014190: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-000141a0: 7374 2075 696e 7436 345f 7420 745f 656e  st uint64_t t_en
-000141b0: 6420 3d20 6767 6d6c 5f74 696d 655f 7573  d = ggml_time_us
-000141c0: 2829 3b20 554e 5553 4544 2874 5f65 6e64  (); UNUSED(t_end
-000141d0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-000141e0: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-000141f0: 2822 2573 3a20 4745 4c55 2c20 5349 4c55  ("%s: GELU, SILU
-00014200: 2061 6e64 2045 5850 2074 6162 6c65 7320   and EXP tables 
-00014210: 696e 6974 6961 6c69 7a65 6420 696e 2025  initialized in %
-00014220: 6620 6d73 5c6e 222c 205f 5f66 756e 635f  f ms\n", __func_
-00014230: 5f2c 2028 745f 656e 6420 2d20 745f 7374  _, (t_end - t_st
-00014240: 6172 7429 2f31 3030 302e 3066 293b 0a20  art)/1000.0f);. 
-00014250: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00014260: 2020 2f2f 2069 6e69 7469 616c 697a 6520    // initialize 
-00014270: 675f 7374 6174 650a 2020 2020 2020 2020  g_state.        
-00014280: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
-00014290: 6e73 7420 7569 6e74 3634 5f74 2074 5f73  nst uint64_t t_s
-000142a0: 7461 7274 203d 2067 676d 6c5f 7469 6d65  tart = ggml_time
-000142b0: 5f75 7328 293b 2055 4e55 5345 4428 745f  _us(); UNUSED(t_
-000142c0: 7374 6172 7429 3b0a 0a20 2020 2020 2020  start);..       
-000142d0: 2020 2020 2067 5f73 7461 7465 203d 2028       g_state = (
-000142e0: 7374 7275 6374 2067 676d 6c5f 7374 6174  struct ggml_stat
-000142f0: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
-00014300: 2020 2020 202f 2a2e 636f 6e74 6578 7473       /*.contexts
-00014310: 203d 2a2f 207b 207b 2030 207d 207d 2c0a   =*/ { { 0 } },.
-00014320: 2020 2020 2020 2020 2020 2020 7d3b 0a0a              };..
-00014330: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00014340: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00014350: 4747 4d4c 5f4d 4158 5f43 4f4e 5445 5854  GGML_MAX_CONTEXT
-00014360: 533b 202b 2b69 2920 7b0a 2020 2020 2020  S; ++i) {.      
-00014370: 2020 2020 2020 2020 2020 675f 7374 6174            g_stat
-00014380: 652e 636f 6e74 6578 7473 5b69 5d2e 7573  e.contexts[i].us
-00014390: 6564 203d 2066 616c 7365 3b0a 2020 2020  ed = false;.    
-000143a0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000143b0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-000143c0: 7436 345f 7420 745f 656e 6420 3d20 6767  t64_t t_end = gg
-000143d0: 6d6c 5f74 696d 655f 7573 2829 3b20 554e  ml_time_us(); UN
-000143e0: 5553 4544 2874 5f65 6e64 293b 0a0a 2020  USED(t_end);..  
-000143f0: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
-00014400: 5249 4e54 5f44 4542 5547 2822 2573 3a20  RINT_DEBUG("%s: 
-00014410: 675f 7374 6174 6520 696e 6974 6961 6c69  g_state initiali
-00014420: 7a65 6420 696e 2025 6620 6d73 5c6e 222c  zed in %f ms\n",
-00014430: 205f 5f66 756e 635f 5f2c 2028 745f 656e   __func__, (t_en
-00014440: 6420 2d20 745f 7374 6172 7429 2f31 3030  d - t_start)/100
-00014450: 302e 3066 293b 0a20 2020 2020 2020 207d  0.0f);.        }
-00014460: 0a0a 2020 2020 2020 2020 6973 5f66 6972  ..        is_fir
-00014470: 7374 5f63 616c 6c20 3d20 6661 6c73 653b  st_call = false;
-00014480: 0a20 2020 207d 0a0a 2020 2020 2f2f 2066  .    }..    // f
-00014490: 696e 6420 6e6f 6e2d 7573 6564 2063 6f6e  ind non-used con
-000144a0: 7465 7874 2069 6e20 675f 7374 6174 650a  text in g_state.
-000144b0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000144c0: 636f 6e74 6578 7420 2a20 6374 7820 3d20  context * ctx = 
-000144d0: 4e55 4c4c 3b0a 0a20 2020 2066 6f72 2028  NULL;..    for (
-000144e0: 696e 7420 6920 3d20 303b 2069 203c 2047  int i = 0; i < G
-000144f0: 474d 4c5f 4d41 585f 434f 4e54 4558 5453  GML_MAX_CONTEXTS
-00014500: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00014510: 2069 6620 2821 675f 7374 6174 652e 636f   if (!g_state.co
-00014520: 6e74 6578 7473 5b69 5d2e 7573 6564 2920  ntexts[i].used) 
-00014530: 7b0a 2020 2020 2020 2020 2020 2020 675f  {.            g_
-00014540: 7374 6174 652e 636f 6e74 6578 7473 5b69  state.contexts[i
-00014550: 5d2e 7573 6564 203d 2074 7275 653b 0a20  ].used = true;. 
-00014560: 2020 2020 2020 2020 2020 2063 7478 203d             ctx =
-00014570: 2026 675f 7374 6174 652e 636f 6e74 6578   &g_state.contex
-00014580: 7473 5b69 5d2e 636f 6e74 6578 743b 0a0a  ts[i].context;..
-00014590: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-000145a0: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
-000145b0: 3a20 666f 756e 6420 756e 7573 6564 2063  : found unused c
-000145c0: 6f6e 7465 7874 2025 645c 6e22 2c20 5f5f  ontext %d\n", __
-000145d0: 6675 6e63 5f5f 2c20 6929 3b0a 2020 2020  func__, i);.    
-000145e0: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-000145f0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-00014600: 2020 2020 6966 2028 6374 7820 3d3d 204e      if (ctx == N
-00014610: 554c 4c29 207b 0a20 2020 2020 2020 2047  ULL) {.        G
-00014620: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-00014630: 2225 733a 206e 6f20 756e 7573 6564 2063  "%s: no unused c
-00014640: 6f6e 7465 7874 2066 6f75 6e64 5c6e 222c  ontext found\n",
-00014650: 205f 5f66 756e 635f 5f29 3b0a 0a20 2020   __func__);..   
-00014660: 2020 2020 2067 676d 6c5f 6372 6974 6963       ggml_critic
-00014670: 616c 5f73 6563 7469 6f6e 5f65 6e64 2829  al_section_end()
-00014680: 3b0a 0a20 2020 2020 2020 2072 6574 7572  ;..        retur
-00014690: 6e20 4e55 4c4c 3b0a 2020 2020 7d0a 0a20  n NULL;.    }.. 
-000146a0: 2020 202a 6374 7820 3d20 2873 7472 7563     *ctx = (struc
-000146b0: 7420 6767 6d6c 5f63 6f6e 7465 7874 2920  t ggml_context) 
-000146c0: 7b0a 2020 2020 2020 2020 2f2a 2e6d 656d  {.        /*.mem
-000146d0: 5f73 697a 6520 2020 2020 2020 2020 3d2a  _size         =*
-000146e0: 2f20 7061 7261 6d73 2e6d 656d 5f73 697a  / params.mem_siz
-000146f0: 652c 0a20 2020 2020 2020 202f 2a2e 6d65  e,.        /*.me
-00014700: 6d5f 6275 6666 6572 2020 2020 2020 203d  m_buffer       =
-00014710: 2a2f 2070 6172 616d 732e 6d65 6d5f 6275  */ params.mem_bu
-00014720: 6666 6572 203f 2070 6172 616d 732e 6d65  ffer ? params.me
-00014730: 6d5f 6275 6666 6572 203a 206d 616c 6c6f  m_buffer : mallo
-00014740: 6328 7061 7261 6d73 2e6d 656d 5f73 697a  c(params.mem_siz
-00014750: 6529 2c0a 2020 2020 2020 2020 2f2a 2e6d  e),.        /*.m
-00014760: 656d 5f62 7566 6665 725f 6f77 6e65 6420  em_buffer_owned 
-00014770: 3d2a 2f20 7061 7261 6d73 2e6d 656d 5f62  =*/ params.mem_b
-00014780: 7566 6665 7220 3f20 6661 6c73 6520 3a20  uffer ? false : 
-00014790: 7472 7565 2c0a 2020 2020 2020 2020 2f2a  true,.        /*
-000147a0: 2e6e 5f6f 626a 6563 7473 2020 2020 2020  .n_objects      
-000147b0: 2020 3d2a 2f20 302c 0a20 2020 2020 2020    =*/ 0,.       
-000147c0: 202f 2a2e 6f62 6a65 6374 735f 6265 6769   /*.objects_begi
-000147d0: 6e20 2020 203d 2a2f 204e 554c 4c2c 0a20  n    =*/ NULL,. 
-000147e0: 2020 2020 2020 202f 2a2e 6f62 6a65 6374         /*.object
-000147f0: 735f 656e 6420 2020 2020 203d 2a2f 204e  s_end      =*/ N
-00014800: 554c 4c2c 0a20 2020 2020 2020 202f 2a2e  ULL,.        /*.
-00014810: 7363 7261 7463 6820 2020 2020 2020 2020  scratch         
-00014820: 203d 2a2f 207b 2030 2c20 302c 204e 554c   =*/ { 0, 0, NUL
-00014830: 4c2c 207d 2c0a 2020 2020 2020 2020 2f2a  L, },.        /*
-00014840: 2e73 6372 6174 6368 5f73 6176 6520 2020  .scratch_save   
-00014850: 2020 3d2a 2f20 7b20 302c 2030 2c20 4e55    =*/ { 0, 0, NU
-00014860: 4c4c 2c20 7d2c 0a20 2020 207d 3b0a 0a20  LL, },.    };.. 
-00014870: 2020 2067 676d 6c5f 6173 7365 7274 5f61     ggml_assert_a
-00014880: 6c69 676e 6564 2863 7478 2d3e 6d65 6d5f  ligned(ctx->mem_
-00014890: 6275 6666 6572 293b 0a0a 2020 2020 4747  buffer);..    GG
-000148a0: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
-000148b0: 2573 3a20 636f 6e74 6578 7420 696e 6974  %s: context init
-000148c0: 6961 6c69 7a65 645c 6e22 2c20 5f5f 6675  ialized\n", __fu
-000148d0: 6e63 5f5f 293b 0a0a 2020 2020 6767 6d6c  nc__);..    ggml
-000148e0: 5f63 7269 7469 6361 6c5f 7365 6374 696f  _critical_sectio
-000148f0: 6e5f 656e 6428 293b 0a0a 2020 2020 7265  n_end();..    re
-00014900: 7475 726e 2063 7478 3b0a 7d0a 0a76 6f69  turn ctx;.}..voi
-00014910: 6420 6767 6d6c 5f66 7265 6528 7374 7275  d ggml_free(stru
-00014920: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00014930: 2a20 6374 7829 207b 0a20 2020 202f 2f20  * ctx) {.    // 
-00014940: 6d61 6b65 2074 6869 7320 6675 6e63 7469  make this functi
-00014950: 6f6e 2074 6872 6561 6420 7361 6665 0a20  on thread safe. 
-00014960: 2020 2067 676d 6c5f 6372 6974 6963 616c     ggml_critical
-00014970: 5f73 6563 7469 6f6e 5f73 7461 7274 2829  _section_start()
-00014980: 3b0a 0a20 2020 2062 6f6f 6c20 666f 756e  ;..    bool foun
-00014990: 6420 3d20 6661 6c73 653b 0a0a 2020 2020  d = false;..    
-000149a0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000149b0: 6920 3c20 4747 4d4c 5f4d 4158 5f43 4f4e  i < GGML_MAX_CON
-000149c0: 5445 5854 533b 2069 2b2b 2920 7b0a 2020  TEXTS; i++) {.  
-000149d0: 2020 2020 2020 6966 2028 2667 5f73 7461        if (&g_sta
-000149e0: 7465 2e63 6f6e 7465 7874 735b 695d 2e63  te.contexts[i].c
-000149f0: 6f6e 7465 7874 203d 3d20 6374 7829 207b  ontext == ctx) {
-00014a00: 0a20 2020 2020 2020 2020 2020 2067 5f73  .            g_s
-00014a10: 7461 7465 2e63 6f6e 7465 7874 735b 695d  tate.contexts[i]
-00014a20: 2e75 7365 6420 3d20 6661 6c73 653b 0a0a  .used = false;..
-00014a30: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00014a40: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
-00014a50: 3a20 636f 6e74 6578 7420 2564 2077 6974  : context %d wit
-00014a60: 6820 2564 206f 626a 6563 7473 2068 6173  h %d objects has
-00014a70: 2062 6565 6e20 6672 6565 642e 206d 656d   been freed. mem
-00014a80: 6f72 7920 7573 6564 203d 2025 7a75 5c6e  ory used = %zu\n
-00014a90: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00014aa0: 2020 2020 2020 205f 5f66 756e 635f 5f2c         __func__,
-00014ab0: 2069 2c20 6374 782d 3e6e 5f6f 626a 6563   i, ctx->n_objec
-00014ac0: 7473 2c20 6374 782d 3e6f 626a 6563 7473  ts, ctx->objects
-00014ad0: 5f65 6e64 2d3e 6f66 6673 202b 2063 7478  _end->offs + ctx
-00014ae0: 2d3e 6f62 6a65 6374 735f 656e 642d 3e73  ->objects_end->s
-00014af0: 697a 6529 3b0a 0a20 2020 2020 2020 2020  ize);..         
-00014b00: 2020 2069 6620 2863 7478 2d3e 6d65 6d5f     if (ctx->mem_
-00014b10: 6275 6666 6572 5f6f 776e 6564 2920 7b0a  buffer_owned) {.
-00014b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b30: 6672 6565 2863 7478 2d3e 6d65 6d5f 6275  free(ctx->mem_bu
-00014b40: 6666 6572 293b 0a20 2020 2020 2020 2020  ffer);.         
-00014b50: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00014b60: 2020 666f 756e 6420 3d20 7472 7565 3b0a    found = true;.
-00014b70: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00014b80: 6b3b 0a20 2020 2020 2020 207d 0a20 2020  k;.        }.   
-00014b90: 207d 0a0a 2020 2020 6966 2028 2166 6f75   }..    if (!fou
-00014ba0: 6e64 2920 7b0a 2020 2020 2020 2020 4747  nd) {.        GG
-00014bb0: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
-00014bc0: 2573 3a20 636f 6e74 6578 7420 6e6f 7420  %s: context not 
-00014bd0: 666f 756e 645c 6e22 2c20 5f5f 6675 6e63  found\n", __func
-00014be0: 5f5f 293b 0a20 2020 207d 0a0a 2020 2020  __);.    }..    
-00014bf0: 6767 6d6c 5f63 7269 7469 6361 6c5f 7365  ggml_critical_se
-00014c00: 6374 696f 6e5f 656e 6428 293b 0a7d 0a0a  ction_end();.}..
-00014c10: 7369 7a65 5f74 2067 676d 6c5f 7573 6564  size_t ggml_used
-00014c20: 5f6d 656d 2863 6f6e 7374 2073 7472 7563  _mem(const struc
-00014c30: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00014c40: 2063 7478 2920 7b0a 2020 2020 7265 7475   ctx) {.    retu
-00014c50: 726e 2063 7478 2d3e 6f62 6a65 6374 735f  rn ctx->objects_
-00014c60: 656e 642d 3e6f 6666 7320 2b20 6374 782d  end->offs + ctx-
-00014c70: 3e6f 626a 6563 7473 5f65 6e64 2d3e 7369  >objects_end->si
-00014c80: 7a65 3b0a 7d0a 0a73 697a 655f 7420 6767  ze;.}..size_t gg
-00014c90: 6d6c 5f73 6574 5f73 6372 6174 6368 2873  ml_set_scratch(s
-00014ca0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00014cb0: 7874 202a 2063 7478 2c20 7374 7275 6374  xt * ctx, struct
-00014cc0: 2067 676d 6c5f 7363 7261 7463 6820 7363   ggml_scratch sc
-00014cd0: 7261 7463 6829 207b 0a20 2020 2063 6f6e  ratch) {.    con
-00014ce0: 7374 2073 697a 655f 7420 7265 7375 6c74  st size_t result
-00014cf0: 203d 2063 7478 2d3e 7363 7261 7463 682e   = ctx->scratch.
-00014d00: 6461 7461 203f 2063 7478 2d3e 7363 7261  data ? ctx->scra
-00014d10: 7463 682e 6f66 6673 203a 2030 3b0a 0a20  tch.offs : 0;.. 
-00014d20: 2020 2063 7478 2d3e 7363 7261 7463 6820     ctx->scratch 
-00014d30: 3d20 7363 7261 7463 683b 0a0a 2020 2020  = scratch;..    
-00014d40: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-00014d50: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
-00014d60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00014d70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00014d80: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00014d90: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00014da0: 2f2f 0a0a 7374 7275 6374 2067 676d 6c5f  //..struct ggml_
-00014db0: 7465 6e73 6f72 202a 2067 676d 6c5f 6e65  tensor * ggml_ne
-00014dc0: 775f 7465 6e73 6f72 5f69 6d70 6c28 0a20  w_tensor_impl(. 
-00014dd0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00014de0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00014df0: 2c0a 2020 2020 2020 2020 656e 756d 2020  ,.        enum  
-00014e00: 2067 676d 6c5f 7479 7065 2074 7970 652c   ggml_type type,
-00014e10: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
-00014e20: 6e5f 6469 6d73 2c0a 2020 2020 2020 2020  n_dims,.        
-00014e30: 636f 6e73 7420 696e 742a 206e 652c 0a20  const int* ne,. 
-00014e40: 2020 2020 2020 2076 6f69 642a 2020 6461         void*  da
-00014e50: 7461 2920 7b0a 2020 2020 2f2f 2061 6c77  ta) {.    // alw
-00014e60: 6179 7320 696e 7365 7274 206f 626a 6563  ays insert objec
-00014e70: 7473 2061 7420 7468 6520 656e 6420 6f66  ts at the end of
-00014e80: 2074 6865 2063 6f6e 7465 7874 2773 206d   the context's m
-00014e90: 656d 6f72 7920 706f 6f6c 0a20 2020 2073  emory pool.    s
-00014ea0: 7472 7563 7420 6767 6d6c 5f6f 626a 6563  truct ggml_objec
-00014eb0: 7420 2a20 6f62 6a5f 6375 7220 3d20 6374  t * obj_cur = ct
-00014ec0: 782d 3e6f 626a 6563 7473 5f65 6e64 3b0a  x->objects_end;.
-00014ed0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00014ee0: 7420 6375 725f 6f66 6673 203d 206f 626a  t cur_offs = obj
-00014ef0: 5f63 7572 203d 3d20 4e55 4c4c 203f 2030  _cur == NULL ? 0
-00014f00: 203a 206f 626a 5f63 7572 2d3e 6f66 6673   : obj_cur->offs
-00014f10: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00014f20: 5f74 2063 7572 5f73 697a 6520 3d20 6f62  _t cur_size = ob
-00014f30: 6a5f 6375 7220 3d3d 204e 554c 4c20 3f20  j_cur == NULL ? 
-00014f40: 3020 3a20 6f62 6a5f 6375 722d 3e73 697a  0 : obj_cur->siz
-00014f50: 653b 0a20 2020 2063 6f6e 7374 2073 697a  e;.    const siz
-00014f60: 655f 7420 6375 725f 656e 6420 203d 2063  e_t cur_end  = c
-00014f70: 7572 5f6f 6666 7320 2b20 6375 725f 7369  ur_offs + cur_si
-00014f80: 7a65 3b0a 0a20 2020 2073 697a 655f 7420  ze;..    size_t 
-00014f90: 7369 7a65 5f6e 6565 6465 6420 3d20 303b  size_needed = 0;
-00014fa0: 0a0a 2020 2020 6966 2028 6461 7461 203d  ..    if (data =
-00014fb0: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-00014fc0: 2020 7369 7a65 5f6e 6565 6465 6420 2b3d    size_needed +=
-00014fd0: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
-00014fe0: 7479 7065 5d2a 286e 655b 305d 2f47 474d  type]*(ne[0]/GGM
-00014ff0: 4c5f 424c 434b 5f53 495a 455b 7479 7065  L_BLCK_SIZE[type
-00015000: 5d29 3b0a 2020 2020 2020 2020 666f 7220  ]);.        for 
-00015010: 2869 6e74 2069 203d 2031 3b20 6920 3c20  (int i = 1; i < 
-00015020: 6e5f 6469 6d73 3b20 692b 2b29 207b 0a20  n_dims; i++) {. 
-00015030: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-00015040: 6e65 6564 6564 202a 3d20 6e65 5b69 5d3b  needed *= ne[i];
-00015050: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00015060: 2020 202f 2f20 616c 6967 6e20 746f 2047     // align to G
-00015070: 474d 4c5f 4d45 4d5f 414c 4947 4e0a 2020  GML_MEM_ALIGN.  
-00015080: 2020 2020 2020 7369 7a65 5f6e 6565 6465        size_neede
-00015090: 6420 3d20 2828 7369 7a65 5f6e 6565 6465  d = ((size_neede
-000150a0: 6420 2b20 4747 4d4c 5f4d 454d 5f41 4c49  d + GGML_MEM_ALI
-000150b0: 474e 202d 2031 292f 4747 4d4c 5f4d 454d  GN - 1)/GGML_MEM
-000150c0: 5f41 4c49 474e 292a 4747 4d4c 5f4d 454d  _ALIGN)*GGML_MEM
-000150d0: 5f41 4c49 474e 3b0a 2020 2020 7d0a 0a20  _ALIGN;.    }.. 
-000150e0: 2020 2063 6861 7220 2a20 636f 6e73 7420     char * const 
-000150f0: 6d65 6d5f 6275 6666 6572 203d 2063 7478  mem_buffer = ctx
-00015100: 2d3e 6d65 6d5f 6275 6666 6572 3b0a 2020  ->mem_buffer;.  
-00015110: 2020 7374 7275 6374 2067 676d 6c5f 6f62    struct ggml_ob
-00015120: 6a65 6374 202a 2063 6f6e 7374 206f 626a  ject * const obj
-00015130: 5f6e 6577 203d 2028 7374 7275 6374 2067  _new = (struct g
-00015140: 676d 6c5f 6f62 6a65 6374 202a 2928 6d65  gml_object *)(me
-00015150: 6d5f 6275 6666 6572 202b 2063 7572 5f65  m_buffer + cur_e
-00015160: 6e64 293b 0a0a 2020 2020 6966 2028 6374  nd);..    if (ct
-00015170: 782d 3e73 6372 6174 6368 2e64 6174 6120  x->scratch.data 
-00015180: 3d3d 204e 554c 4c20 7c7c 2064 6174 6120  == NULL || data 
-00015190: 213d 204e 554c 4c29 207b 0a20 2020 2020  != NULL) {.     
-000151a0: 2020 2073 697a 655f 6e65 6564 6564 202b     size_needed +
-000151b0: 3d20 7369 7a65 6f66 2873 7472 7563 7420  = sizeof(struct 
-000151c0: 6767 6d6c 5f74 656e 736f 7229 3b0a 0a20  ggml_tensor);.. 
-000151d0: 2020 2020 2020 2069 6620 2863 7572 5f65         if (cur_e
-000151e0: 6e64 202b 2073 697a 655f 6e65 6564 6564  nd + size_needed
-000151f0: 202b 2047 474d 4c5f 4f42 4a45 4354 5f53   + GGML_OBJECT_S
-00015200: 495a 4520 3e20 6374 782d 3e6d 656d 5f73  IZE > ctx->mem_s
-00015210: 697a 6529 207b 0a20 2020 2020 2020 2020  ize) {.         
-00015220: 2020 2047 474d 4c5f 5052 494e 5428 2225     GGML_PRINT("%
-00015230: 733a 206e 6f74 2065 6e6f 7567 6820 7370  s: not enough sp
-00015240: 6163 6520 696e 2074 6865 2063 6f6e 7465  ace in the conte
-00015250: 7874 2773 206d 656d 6f72 7920 706f 6f6c  xt's memory pool
-00015260: 2028 6e65 6564 6564 2025 7a75 2c20 6176   (needed %zu, av
-00015270: 6169 6c61 626c 6520 257a 7529 5c6e 222c  ailable %zu)\n",
-00015280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015290: 2020 2020 205f 5f66 756e 635f 5f2c 2063       __func__, c
-000152a0: 7572 5f65 6e64 202b 2073 697a 655f 6e65  ur_end + size_ne
-000152b0: 6564 6564 202b 2047 474d 4c5f 4f42 4a45  eded + GGML_OBJE
-000152c0: 4354 5f53 495a 452c 2063 7478 2d3e 6d65  CT_SIZE, ctx->me
-000152d0: 6d5f 7369 7a65 293b 0a20 2020 2020 2020  m_size);.       
-000152e0: 2020 2020 2061 7373 6572 7428 6661 6c73       assert(fals
-000152f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00015300: 7265 7475 726e 204e 554c 4c3b 0a20 2020  return NULL;.   
-00015310: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00015320: 2a6f 626a 5f6e 6577 203d 2028 7374 7275  *obj_new = (stru
-00015330: 6374 2067 676d 6c5f 6f62 6a65 6374 2920  ct ggml_object) 
-00015340: 7b0a 2020 2020 2020 2020 2020 2020 2e6f  {.            .o
-00015350: 6666 7320 3d20 6375 725f 656e 6420 2b20  ffs = cur_end + 
-00015360: 4747 4d4c 5f4f 424a 4543 545f 5349 5a45  GGML_OBJECT_SIZE
-00015370: 2c0a 2020 2020 2020 2020 2020 2020 2e73  ,.            .s
-00015380: 697a 6520 3d20 7369 7a65 5f6e 6565 6465  ize = size_neede
-00015390: 642c 0a20 2020 2020 2020 2020 2020 202e  d,.            .
-000153a0: 6e65 7874 203d 204e 554c 4c2c 0a20 2020  next = NULL,.   
-000153b0: 2020 2020 207d 3b0a 2020 2020 7d20 656c       };.    } el
-000153c0: 7365 207b 0a20 2020 2020 2020 2069 6620  se {.        if 
-000153d0: 2863 7478 2d3e 7363 7261 7463 682e 6f66  (ctx->scratch.of
-000153e0: 6673 202b 2073 697a 655f 6e65 6564 6564  fs + size_needed
-000153f0: 203e 2063 7478 2d3e 7363 7261 7463 682e   > ctx->scratch.
-00015400: 7369 7a65 2920 7b0a 2020 2020 2020 2020  size) {.        
-00015410: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
-00015420: 2573 3a20 6e6f 7420 656e 6f75 6768 2073  %s: not enough s
-00015430: 7061 6365 2069 6e20 7468 6520 7363 7261  pace in the scra
-00015440: 7463 6820 6d65 6d6f 7279 5c6e 222c 205f  tch memory\n", _
-00015450: 5f66 756e 635f 5f29 3b0a 2020 2020 2020  _func__);.      
-00015460: 2020 2020 2020 6173 7365 7274 2866 616c        assert(fal
-00015470: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00015480: 2072 6574 7572 6e20 4e55 4c4c 3b0a 2020   return NULL;.  
-00015490: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000154a0: 2069 6620 2863 7572 5f65 6e64 202b 2073   if (cur_end + s
-000154b0: 697a 656f 6628 7374 7275 6374 2067 676d  izeof(struct ggm
-000154c0: 6c5f 7465 6e73 6f72 2920 2b20 4747 4d4c  l_tensor) + GGML
-000154d0: 5f4f 424a 4543 545f 5349 5a45 203e 2063  _OBJECT_SIZE > c
-000154e0: 7478 2d3e 6d65 6d5f 7369 7a65 2920 7b0a  tx->mem_size) {.
-000154f0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00015500: 5f50 5249 4e54 2822 2573 3a20 6e6f 7420  _PRINT("%s: not 
-00015510: 656e 6f75 6768 2073 7061 6365 2069 6e20  enough space in 
-00015520: 7468 6520 636f 6e74 6578 7427 7320 6d65  the context's me
-00015530: 6d6f 7279 2070 6f6f 6c20 286e 6565 6465  mory pool (neede
-00015540: 6420 257a 752c 2061 7661 696c 6162 6c65  d %zu, available
-00015550: 2025 7a75 295c 6e22 2c0a 2020 2020 2020   %zu)\n",.      
-00015560: 2020 2020 2020 2020 2020 2020 2020 5f5f                __
-00015570: 6675 6e63 5f5f 2c20 6375 725f 656e 6420  func__, cur_end 
-00015580: 2b20 7369 7a65 6f66 2873 7472 7563 7420  + sizeof(struct 
-00015590: 6767 6d6c 5f74 656e 736f 7229 202b 2047  ggml_tensor) + G
-000155a0: 474d 4c5f 4f42 4a45 4354 5f53 495a 452c  GML_OBJECT_SIZE,
-000155b0: 2063 7478 2d3e 6d65 6d5f 7369 7a65 293b   ctx->mem_size);
-000155c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000155d0: 6572 7428 6661 6c73 6529 3b0a 2020 2020  ert(false);.    
-000155e0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-000155f0: 554c 4c3b 0a20 2020 2020 2020 207d 0a0a  ULL;.        }..
-00015600: 2020 2020 2020 2020 6461 7461 203d 2028          data = (
-00015610: 6368 6172 202a 2063 6f6e 7374 2920 6374  char * const) ct
-00015620: 782d 3e73 6372 6174 6368 2e64 6174 6120  x->scratch.data 
-00015630: 2b20 6374 782d 3e73 6372 6174 6368 2e6f  + ctx->scratch.o
-00015640: 6666 733b 0a0a 2020 2020 2020 2020 2a6f  ffs;..        *o
-00015650: 626a 5f6e 6577 203d 2028 7374 7275 6374  bj_new = (struct
-00015660: 2067 676d 6c5f 6f62 6a65 6374 2920 7b0a   ggml_object) {.
-00015670: 2020 2020 2020 2020 2020 2020 2e6f 6666              .off
-00015680: 7320 3d20 6375 725f 656e 6420 2b20 4747  s = cur_end + GG
-00015690: 4d4c 5f4f 424a 4543 545f 5349 5a45 2c0a  ML_OBJECT_SIZE,.
-000156a0: 2020 2020 2020 2020 2020 2020 2e73 697a              .siz
-000156b0: 6520 3d20 7369 7a65 6f66 2873 7472 7563  e = sizeof(struc
-000156c0: 7420 6767 6d6c 5f74 656e 736f 7229 2c0a  t ggml_tensor),.
-000156d0: 2020 2020 2020 2020 2020 2020 2e6e 6578              .nex
-000156e0: 7420 3d20 4e55 4c4c 2c0a 2020 2020 2020  t = NULL,.      
-000156f0: 2020 7d3b 0a0a 2020 2020 2020 2020 2f2f    };..        //
-00015700: 7072 696e 7466 2822 7363 7261 7463 6820  printf("scratch 
-00015710: 6f66 6673 203d 2025 7a75 2c20 7369 7a65  offs = %zu, size
-00015720: 5f6e 6565 6465 6420 3d20 257a 755c 6e22  _needed = %zu\n"
-00015730: 2c20 6374 782d 3e73 6372 6174 6368 2e6f  , ctx->scratch.o
-00015740: 6666 732c 2073 697a 655f 6e65 6564 6564  ffs, size_needed
-00015750: 293b 0a0a 2020 2020 2020 2020 6374 782d  );..        ctx-
-00015760: 3e73 6372 6174 6368 2e6f 6666 7320 2b3d  >scratch.offs +=
-00015770: 2073 697a 655f 6e65 6564 6564 3b0a 2020   size_needed;.  
-00015780: 2020 7d0a 0a20 2020 2069 6620 286f 626a    }..    if (obj
-00015790: 5f63 7572 2021 3d20 4e55 4c4c 2920 7b0a  _cur != NULL) {.
-000157a0: 2020 2020 2020 2020 6f62 6a5f 6375 722d          obj_cur-
-000157b0: 3e6e 6578 7420 3d20 6f62 6a5f 6e65 773b  >next = obj_new;
-000157c0: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
-000157d0: 2020 2020 2020 2f2f 2074 6869 7320 6973        // this is
-000157e0: 2074 6865 2066 6972 7374 206f 626a 6563   the first objec
-000157f0: 7420 696e 2074 6869 7320 636f 6e74 6578  t in this contex
-00015800: 740a 2020 2020 2020 2020 6374 782d 3e6f  t.        ctx->o
-00015810: 626a 6563 7473 5f62 6567 696e 203d 206f  bjects_begin = o
-00015820: 626a 5f6e 6577 3b0a 2020 2020 7d0a 0a20  bj_new;.    }.. 
-00015830: 2020 2063 7478 2d3e 6f62 6a65 6374 735f     ctx->objects_
-00015840: 656e 6420 3d20 6f62 6a5f 6e65 773b 0a0a  end = obj_new;..
-00015850: 2020 2020 2f2f 7072 696e 7466 2822 2573      //printf("%s
-00015860: 3a20 696e 7365 7274 6564 206e 6577 206f  : inserted new o
-00015870: 626a 6563 7420 6174 2025 7a75 2c20 7369  bject at %zu, si
-00015880: 7a65 203d 2025 7a75 5c6e 222c 205f 5f66  ze = %zu\n", __f
-00015890: 756e 635f 5f2c 2063 7572 5f65 6e64 2c20  unc__, cur_end, 
-000158a0: 6f62 6a5f 6e65 772d 3e73 697a 6529 3b0a  obj_new->size);.
-000158b0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-000158c0: 5f74 656e 736f 7220 2a20 636f 6e73 7420  _tensor * const 
-000158d0: 7265 7375 6c74 203d 2028 7374 7275 6374  result = (struct
-000158e0: 2067 676d 6c5f 7465 6e73 6f72 202a 2928   ggml_tensor *)(
-000158f0: 6d65 6d5f 6275 6666 6572 202b 206f 626a  mem_buffer + obj
-00015900: 5f6e 6577 2d3e 6f66 6673 293b 0a0a 2020  _new->offs);..  
-00015910: 2020 6767 6d6c 5f61 7373 6572 745f 616c    ggml_assert_al
-00015920: 6967 6e65 6428 7265 7375 6c74 293b 0a0a  igned(result);..
-00015930: 2020 2020 2a72 6573 756c 7420 3d20 2873      *result = (s
-00015940: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00015950: 7229 207b 0a20 2020 2020 2020 202f 2a2e  r) {.        /*.
-00015960: 7479 7065 2020 2020 2020 2020 203d 2a2f  type         =*/
-00015970: 2074 7970 652c 0a20 2020 2020 2020 202f   type,.        /
-00015980: 2a2e 6e5f 6469 6d73 2020 2020 2020 203d  *.n_dims       =
-00015990: 2a2f 206e 5f64 696d 732c 0a20 2020 2020  */ n_dims,.     
-000159a0: 2020 202f 2a2e 6e65 2020 2020 2020 2020     /*.ne        
-000159b0: 2020 203d 2a2f 207b 2031 2c20 312c 2031     =*/ { 1, 1, 1
-000159c0: 2c20 3120 7d2c 0a20 2020 2020 2020 202f  , 1 },.        /
-000159d0: 2a2e 6e62 2020 2020 2020 2020 2020 203d  *.nb           =
-000159e0: 2a2f 207b 2030 2c20 302c 2030 2c20 3020  */ { 0, 0, 0, 0 
-000159f0: 7d2c 0a20 2020 2020 2020 202f 2a2e 6f70  },.        /*.op
-00015a00: 2020 2020 2020 2020 2020 203d 2a2f 2047             =*/ G
-00015a10: 474d 4c5f 4f50 5f4e 4f4e 452c 0a20 2020  GML_OP_NONE,.   
-00015a20: 2020 2020 202f 2a2e 6973 5f70 6172 616d       /*.is_param
-00015a30: 2020 2020 203d 2a2f 2066 616c 7365 2c0a       =*/ false,.
-00015a40: 2020 2020 2020 2020 2f2a 2e67 7261 6420          /*.grad 
-00015a50: 2020 2020 2020 2020 3d2a 2f20 4e55 4c4c          =*/ NULL
-00015a60: 2c0a 2020 2020 2020 2020 2f2a 2e73 7263  ,.        /*.src
-00015a70: 3020 2020 2020 2020 2020 3d2a 2f20 4e55  0         =*/ NU
-00015a80: 4c4c 2c0a 2020 2020 2020 2020 2f2a 2e73  LL,.        /*.s
-00015a90: 7263 3120 2020 2020 2020 2020 3d2a 2f20  rc1         =*/ 
-00015aa0: 4e55 4c4c 2c0a 2020 2020 2020 2020 2f2a  NULL,.        /*
-00015ab0: 2e6f 7074 2020 2020 2020 2020 2020 3d2a  .opt          =*
-00015ac0: 2f20 7b20 4e55 4c4c 207d 2c0a 2020 2020  / { NULL },.    
-00015ad0: 2020 2020 2f2a 2e6e 5f74 6173 6b73 2020      /*.n_tasks  
-00015ae0: 2020 2020 3d2a 2f20 302c 0a20 2020 2020      =*/ 0,.     
-00015af0: 2020 202f 2a2e 7065 7266 5f72 756e 7320     /*.perf_runs 
-00015b00: 2020 203d 2a2f 2030 2c0a 2020 2020 2020     =*/ 0,.      
-00015b10: 2020 2f2a 2e70 6572 665f 6379 636c 6573    /*.perf_cycles
-00015b20: 2020 3d2a 2f20 302c 0a20 2020 2020 2020    =*/ 0,.       
-00015b30: 202f 2a2e 7065 7266 5f74 696d 655f 7573   /*.perf_time_us
-00015b40: 203d 2a2f 2030 2c0a 2020 2020 2020 2020   =*/ 0,.        
-00015b50: 2f2a 2e64 6174 6120 2020 2020 2020 2020  /*.data         
-00015b60: 3d2a 2f20 6461 7461 203d 3d20 4e55 4c4c  =*/ data == NULL
-00015b70: 203f 2028 766f 6964 202a 2928 7265 7375   ? (void *)(resu
-00015b80: 6c74 202b 2031 2920 3a20 6461 7461 2c0a  lt + 1) : data,.
-00015b90: 2020 2020 2020 2020 2f2a 2e70 6164 2020          /*.pad  
-00015ba0: 2020 2020 2020 2020 3d2a 2f20 7b20 3020          =*/ { 0 
-00015bb0: 7d2c 0a20 2020 207d 3b0a 0a20 2020 2067  },.    };..    g
-00015bc0: 676d 6c5f 6173 7365 7274 5f61 6c69 676e  gml_assert_align
-00015bd0: 6564 2872 6573 756c 742d 3e64 6174 6129  ed(result->data)
-00015be0: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-00015bf0: 6920 3d20 303b 2069 203c 206e 5f64 696d  i = 0; i < n_dim
-00015c00: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-00015c10: 2020 7265 7375 6c74 2d3e 6e65 5b69 5d20    result->ne[i] 
-00015c20: 3d20 6e65 5b69 5d3b 0a20 2020 207d 0a0a  = ne[i];.    }..
-00015c30: 2020 2020 7265 7375 6c74 2d3e 6e62 5b30      result->nb[0
-00015c40: 5d20 3d20 4747 4d4c 5f54 5950 455f 5349  ] = GGML_TYPE_SI
-00015c50: 5a45 5b74 7970 655d 3b0a 2020 2020 7265  ZE[type];.    re
-00015c60: 7375 6c74 2d3e 6e62 5b31 5d20 3d20 7265  sult->nb[1] = re
-00015c70: 7375 6c74 2d3e 6e62 5b30 5d2a 2872 6573  sult->nb[0]*(res
-00015c80: 756c 742d 3e6e 655b 305d 2f47 474d 4c5f  ult->ne[0]/GGML_
-00015c90: 424c 434b 5f53 495a 455b 7479 7065 5d29  BLCK_SIZE[type])
-00015ca0: 3b0a 2020 2020 666f 7220 2869 6e74 2069  ;.    for (int i
-00015cb0: 203d 2032 3b20 6920 3c20 4747 4d4c 5f4d   = 2; i < GGML_M
-00015cc0: 4158 5f44 494d 533b 2069 2b2b 2920 7b0a  AX_DIMS; i++) {.
-00015cd0: 2020 2020 2020 2020 7265 7375 6c74 2d3e          result->
-00015ce0: 6e62 5b69 5d20 3d20 7265 7375 6c74 2d3e  nb[i] = result->
-00015cf0: 6e62 5b69 202d 2031 5d2a 7265 7375 6c74  nb[i - 1]*result
-00015d00: 2d3e 6e65 5b69 202d 2031 5d3b 0a20 2020  ->ne[i - 1];.   
-00015d10: 207d 0a0a 2020 2020 6374 782d 3e6e 5f6f   }..    ctx->n_o
-00015d20: 626a 6563 7473 2b2b 3b0a 0a20 2020 2072  bjects++;..    r
-00015d30: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00015d40: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-00015d50: 736f 7220 2a20 6767 6d6c 5f6e 6577 5f74  sor * ggml_new_t
-00015d60: 656e 736f 7228 0a20 2020 2020 2020 2073  ensor(.        s
-00015d70: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00015d80: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00015d90: 2020 656e 756d 2020 2067 676d 6c5f 7479    enum   ggml_ty
-00015da0: 7065 2074 7970 652c 0a20 2020 2020 2020  pe type,.       
-00015db0: 2069 6e74 2020 2020 6e5f 6469 6d73 2c0a   int    n_dims,.
-00015dc0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00015dd0: 7420 2a20 6e65 2920 7b0a 2020 2020 7265  t * ne) {.    re
-00015de0: 7475 726e 2067 676d 6c5f 6e65 775f 7465  turn ggml_new_te
-00015df0: 6e73 6f72 5f69 6d70 6c28 6374 782c 2074  nsor_impl(ctx, t
-00015e00: 7970 652c 206e 5f64 696d 732c 206e 652c  ype, n_dims, ne,
-00015e10: 204e 554c 4c29 3b0a 7d0a 0a73 7472 7563   NULL);.}..struc
-00015e20: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00015e30: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-00015e40: 3164 280a 2020 2020 2020 2020 7374 7275  1d(.        stru
-00015e50: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00015e60: 2a20 6374 782c 0a20 2020 2020 2020 2065  * ctx,.        e
-00015e70: 6e75 6d20 2020 6767 6d6c 5f74 7970 6520  num   ggml_type 
-00015e80: 7479 7065 2c0a 2020 2020 2020 2020 696e  type,.        in
-00015e90: 7420 2020 206e 6530 2920 7b0a 2020 2020  t    ne0) {.    
-00015ea0: 7265 7475 726e 2067 676d 6c5f 6e65 775f  return ggml_new_
-00015eb0: 7465 6e73 6f72 2863 7478 2c20 7479 7065  tensor(ctx, type
-00015ec0: 2c20 312c 2026 6e65 3029 3b0a 7d0a 0a73  , 1, &ne0);.}..s
-00015ed0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00015ee0: 7220 2a20 6767 6d6c 5f6e 6577 5f74 656e  r * ggml_new_ten
-00015ef0: 736f 725f 3264 280a 2020 2020 2020 2020  sor_2d(.        
-00015f00: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00015f10: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-00015f20: 2020 2065 6e75 6d20 2020 6767 6d6c 5f74     enum   ggml_t
-00015f30: 7970 6520 7479 7065 2c0a 2020 2020 2020  ype type,.      
-00015f40: 2020 696e 7420 2020 206e 6530 2c0a 2020    int    ne0,.  
-00015f50: 2020 2020 2020 696e 7420 2020 206e 6531        int    ne1
-00015f60: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
-00015f70: 7420 6e65 5b32 5d20 3d20 7b20 6e65 302c  t ne[2] = { ne0,
-00015f80: 206e 6531 207d 3b0a 2020 2020 7265 7475   ne1 };.    retu
-00015f90: 726e 2067 676d 6c5f 6e65 775f 7465 6e73  rn ggml_new_tens
-00015fa0: 6f72 2863 7478 2c20 7479 7065 2c20 322c  or(ctx, type, 2,
-00015fb0: 206e 6529 3b0a 7d0a 0a73 7472 7563 7420   ne);.}..struct 
-00015fc0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-00015fd0: 6d6c 5f6e 6577 5f74 656e 736f 725f 3364  ml_new_tensor_3d
-00015fe0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-00015ff0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00016000: 6374 782c 0a20 2020 2020 2020 2065 6e75  ctx,.        enu
-00016010: 6d20 2020 6767 6d6c 5f74 7970 6520 7479  m   ggml_type ty
-00016020: 7065 2c0a 2020 2020 2020 2020 696e 7420  pe,.        int 
-00016030: 2020 206e 6530 2c0a 2020 2020 2020 2020     ne0,.        
-00016040: 696e 7420 2020 206e 6531 2c0a 2020 2020  int    ne1,.    
-00016050: 2020 2020 696e 7420 2020 206e 6532 2920      int    ne2) 
-00016060: 7b0a 2020 2020 636f 6e73 7420 696e 7420  {.    const int 
-00016070: 6e65 5b33 5d20 3d20 7b20 6e65 302c 206e  ne[3] = { ne0, n
-00016080: 6531 2c20 6e65 3220 7d3b 0a20 2020 2072  e1, ne2 };.    r
-00016090: 6574 7572 6e20 6767 6d6c 5f6e 6577 5f74  eturn ggml_new_t
-000160a0: 656e 736f 7228 6374 782c 2074 7970 652c  ensor(ctx, type,
-000160b0: 2033 2c20 6e65 293b 0a7d 0a0a 7374 7275   3, ne);.}..stru
-000160c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000160d0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-000160e0: 5f34 6428 0a20 2020 2020 2020 2073 7472  _4d(.        str
-000160f0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-00016100: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-00016110: 656e 756d 2020 2067 676d 6c5f 7479 7065  enum   ggml_type
-00016120: 2074 7970 652c 0a20 2020 2020 2020 2069   type,.        i
-00016130: 6e74 2020 2020 6e65 302c 0a20 2020 2020  nt    ne0,.     
-00016140: 2020 2069 6e74 2020 2020 6e65 312c 0a20     int    ne1,. 
-00016150: 2020 2020 2020 2069 6e74 2020 2020 6e65         int    ne
-00016160: 322c 0a20 2020 2020 2020 2069 6e74 2020  2,.        int  
-00016170: 2020 6e65 3329 207b 0a20 2020 2063 6f6e    ne3) {.    con
-00016180: 7374 2069 6e74 206e 655b 345d 203d 207b  st int ne[4] = {
-00016190: 206e 6530 2c20 6e65 312c 206e 6532 2c20   ne0, ne1, ne2, 
-000161a0: 6e65 3320 7d3b 0a20 2020 2072 6574 7572  ne3 };.    retur
-000161b0: 6e20 6767 6d6c 5f6e 6577 5f74 656e 736f  n ggml_new_tenso
-000161c0: 7228 6374 782c 2074 7970 652c 2034 2c20  r(ctx, type, 4, 
-000161d0: 6e65 293b 0a7d 0a0a 7374 7275 6374 2067  ne);.}..struct g
-000161e0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-000161f0: 6c5f 6e65 775f 6933 3228 7374 7275 6374  l_new_i32(struct
-00016200: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00016210: 6374 782c 2069 6e74 3332 5f74 2076 616c  ctx, int32_t val
-00016220: 7565 2920 7b0a 2020 2020 6374 782d 3e73  ue) {.    ctx->s
-00016230: 6372 6174 6368 5f73 6176 6520 3d20 6374  cratch_save = ct
-00016240: 782d 3e73 6372 6174 6368 3b0a 2020 2020  x->scratch;.    
-00016250: 6374 782d 3e73 6372 6174 6368 2e64 6174  ctx->scratch.dat
-00016260: 6120 3d20 4e55 4c4c 3b0a 0a20 2020 2073  a = NULL;..    s
-00016270: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00016280: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-00016290: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
-000162a0: 6374 782c 2047 474d 4c5f 5459 5045 5f49  ctx, GGML_TYPE_I
-000162b0: 3332 2c20 3129 3b0a 0a20 2020 2063 7478  32, 1);..    ctx
-000162c0: 2d3e 7363 7261 7463 6820 3d20 6374 782d  ->scratch = ctx-
-000162d0: 3e73 6372 6174 6368 5f73 6176 653b 0a0a  >scratch_save;..
-000162e0: 2020 2020 6767 6d6c 5f73 6574 5f69 3332      ggml_set_i32
-000162f0: 2872 6573 756c 742c 2076 616c 7565 293b  (result, value);
-00016300: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
-00016310: 756c 743b 0a7d 0a0a 7374 7275 6374 2067  ult;.}..struct g
-00016320: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00016330: 6c5f 6e65 775f 6633 3228 7374 7275 6374  l_new_f32(struct
-00016340: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00016350: 6374 782c 2066 6c6f 6174 2076 616c 7565  ctx, float value
-00016360: 2920 7b0a 2020 2020 6374 782d 3e73 6372  ) {.    ctx->scr
-00016370: 6174 6368 5f73 6176 6520 3d20 6374 782d  atch_save = ctx-
-00016380: 3e73 6372 6174 6368 3b0a 2020 2020 6374  >scratch;.    ct
-00016390: 782d 3e73 6372 6174 6368 2e64 6174 6120  x->scratch.data 
-000163a0: 3d20 4e55 4c4c 3b0a 0a20 2020 2073 7472  = NULL;..    str
-000163b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000163c0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
-000163d0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-000163e0: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-000163f0: 2c20 3129 3b0a 0a20 2020 2063 7478 2d3e  , 1);..    ctx->
-00016400: 7363 7261 7463 6820 3d20 6374 782d 3e73  scratch = ctx->s
-00016410: 6372 6174 6368 5f73 6176 653b 0a0a 2020  cratch_save;..  
-00016420: 2020 6767 6d6c 5f73 6574 5f66 3332 2872    ggml_set_f32(r
-00016430: 6573 756c 742c 2076 616c 7565 293b 0a0a  esult, value);..
-00016440: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00016450: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-00016460: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00016470: 6475 705f 7465 6e73 6f72 2873 7472 7563  dup_tensor(struc
-00016480: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00016490: 2063 7478 2c20 636f 6e73 7420 7374 7275   ctx, const stru
-000164a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000164b0: 2073 7263 2920 7b0a 2020 2020 7265 7475   src) {.    retu
-000164c0: 726e 2067 676d 6c5f 6e65 775f 7465 6e73  rn ggml_new_tens
-000164d0: 6f72 5f69 6d70 6c28 6374 782c 2073 7263  or_impl(ctx, src
-000164e0: 2d3e 7479 7065 2c20 7372 632d 3e6e 5f64  ->type, src->n_d
-000164f0: 696d 732c 2073 7263 2d3e 6e65 2c20 4e55  ims, src->ne, NU
-00016500: 4c4c 293b 0a7d 0a0a 7374 7275 6374 2067  LL);.}..struct g
-00016510: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00016520: 6c5f 7365 745f 7a65 726f 2873 7472 7563  l_set_zero(struc
-00016530: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00016540: 7465 6e73 6f72 2920 7b0a 2020 2020 6d65  tensor) {.    me
-00016550: 6d73 6574 2874 656e 736f 722d 3e64 6174  mset(tensor->dat
-00016560: 612c 2030 2c20 6767 6d6c 5f6e 6279 7465  a, 0, ggml_nbyte
-00016570: 7328 7465 6e73 6f72 2929 3b0a 2020 2020  s(tensor));.    
-00016580: 7265 7475 726e 2074 656e 736f 723b 0a7d  return tensor;.}
-00016590: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-000165a0: 6e73 6f72 202a 2067 676d 6c5f 7365 745f  nsor * ggml_set_
-000165b0: 6933 3220 2873 7472 7563 7420 6767 6d6c  i32 (struct ggml
-000165c0: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-000165d0: 2c20 696e 7433 325f 7420 7661 6c75 6529  , int32_t value)
-000165e0: 207b 0a20 2020 2063 6f6e 7374 2069 6e74   {.    const int
-000165f0: 206e 2020 2020 203d 2067 676d 6c5f 6e72   n     = ggml_nr
-00016600: 6f77 7328 7465 6e73 6f72 293b 0a20 2020  ows(tensor);.   
-00016610: 2063 6f6e 7374 2069 6e74 206e 6320 2020   const int nc   
-00016620: 203d 2074 656e 736f 722d 3e6e 655b 305d   = tensor->ne[0]
-00016630: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00016640: 5f74 206e 3120 3d20 7465 6e73 6f72 2d3e  _t n1 = tensor->
-00016650: 6e62 5b31 5d3b 0a0a 2020 2020 6368 6172  nb[1];..    char
-00016660: 202a 2063 6f6e 7374 2064 6174 6120 3d20   * const data = 
-00016670: 7465 6e73 6f72 2d3e 6461 7461 3b0a 0a20  tensor->data;.. 
-00016680: 2020 2073 7769 7463 6820 2874 656e 736f     switch (tenso
-00016690: 722d 3e74 7970 6529 207b 0a20 2020 2020  r->type) {.     
-000166a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000166b0: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
-000166c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000166d0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-000166e0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-000166f0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00016700: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00016710: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
-00016720: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00016730: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00016740: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-00016750: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00016760: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00016770: 4747 4d4c 5f54 5950 455f 4938 3a0a 2020  GGML_TYPE_I8:.  
-00016780: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00016790: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000167a0: 7274 2874 656e 736f 722d 3e6e 625b 305d  rt(tensor->nb[0]
-000167b0: 203d 3d20 7369 7a65 6f66 2869 6e74 385f   == sizeof(int8_
-000167c0: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
-000167d0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-000167e0: 3d20 303b 2069 203c 206e 3b20 692b 2b29  = 0; i < n; i++)
-000167f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00016800: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00016810: 7365 745f 6938 286e 632c 2028 696e 7438  set_i8(nc, (int8
-00016820: 5f74 202a 2928 6461 7461 202b 2069 2a6e  _t *)(data + i*n
-00016830: 3129 2c20 7661 6c75 6529 3b0a 2020 2020  1), value);.    
-00016840: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00016850: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00016860: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00016870: 4747 4d4c 5f54 5950 455f 4931 363a 0a20  GGML_TYPE_I16:. 
-00016880: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00016890: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000168a0: 6572 7428 7465 6e73 6f72 2d3e 6e62 5b30  ert(tensor->nb[0
-000168b0: 5d20 3d3d 2073 697a 656f 6628 696e 7431  ] == sizeof(int1
-000168c0: 365f 7429 293b 0a20 2020 2020 2020 2020  6_t));.         
-000168d0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000168e0: 6920 3d20 303b 2069 203c 206e 3b20 692b  i = 0; i < n; i+
-000168f0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00016900: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00016910: 635f 7365 745f 6931 3628 6e63 2c20 2869  c_set_i16(nc, (i
-00016920: 6e74 3136 5f74 202a 2928 6461 7461 202b  nt16_t *)(data +
-00016930: 2069 2a6e 3129 2c20 7661 6c75 6529 3b0a   i*n1), value);.
-00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016950: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00016960: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00016970: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
-00016980: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00016990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000169a0: 2061 7373 6572 7428 7465 6e73 6f72 2d3e   assert(tensor->
-000169b0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-000169c0: 696e 7433 325f 7429 293b 0a20 2020 2020  int32_t));.     
-000169d0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-000169e0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-000169f0: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00016a00: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00016a10: 6c5f 7665 635f 7365 745f 6933 3228 6e63  l_vec_set_i32(nc
-00016a20: 2c20 2869 6e74 3332 5f74 202a 2928 6461  , (int32_t *)(da
-00016a30: 7461 202b 2069 2a6e 3129 2c20 7661 6c75  ta + i*n1), valu
-00016a40: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00016a50: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00016a60: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00016a70: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00016a80: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
-00016a90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00016aa0: 2020 2020 2061 7373 6572 7428 7465 6e73       assert(tens
-00016ab0: 6f72 2d3e 6e62 5b30 5d20 3d3d 2073 697a  or->nb[0] == siz
-00016ac0: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-00016ad0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00016ae0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00016af0: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
-00016b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016b10: 2020 2020 2067 676d 6c5f 7665 635f 7365       ggml_vec_se
-00016b20: 745f 6631 3628 6e63 2c20 2867 676d 6c5f  t_f16(nc, (ggml_
-00016b30: 6670 3136 5f74 202a 2928 6461 7461 202b  fp16_t *)(data +
-00016b40: 2069 2a6e 3129 2c20 7661 6c75 6529 3b0a   i*n1), value);.
-00016b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b60: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00016b70: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00016b80: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00016b90: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00016ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016bb0: 2061 7373 6572 7428 7465 6e73 6f72 2d3e   assert(tensor->
-00016bc0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00016bd0: 666c 6f61 7429 293b 0a20 2020 2020 2020  float));.       
-00016be0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00016bf0: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
-00016c00: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
-00016c10: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00016c20: 7665 635f 7365 745f 6633 3228 6e63 2c20  vec_set_f32(nc, 
-00016c30: 2866 6c6f 6174 202a 2928 6461 7461 202b  (float *)(data +
-00016c40: 2069 2a6e 3129 2c20 7661 6c75 6529 3b0a   i*n1), value);.
-00016c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c60: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00016c70: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00016c80: 6173 6520 4747 4d4c 5f54 5950 455f 434f  ase GGML_TYPE_CO
-00016c90: 554e 543a 0a20 2020 2020 2020 2020 2020  UNT:.           
-00016ca0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00016cb0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00016cc0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-00016cd0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00016ce0: 7d0a 0a20 2020 2072 6574 7572 6e20 7465  }..    return te
-00016cf0: 6e73 6f72 3b0a 7d0a 0a73 7472 7563 7420  nsor;.}..struct 
-00016d00: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-00016d10: 6d6c 5f73 6574 5f66 3332 2873 7472 7563  ml_set_f32(struc
-00016d20: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00016d30: 7465 6e73 6f72 2c20 666c 6f61 7420 7661  tensor, float va
-00016d40: 6c75 6529 207b 0a20 2020 2063 6f6e 7374  lue) {.    const
-00016d50: 2069 6e74 206e 2020 2020 203d 2067 676d   int n     = ggm
-00016d60: 6c5f 6e72 6f77 7328 7465 6e73 6f72 293b  l_nrows(tensor);
-00016d70: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00016d80: 6320 2020 203d 2074 656e 736f 722d 3e6e  c    = tensor->n
-00016d90: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00016da0: 7369 7a65 5f74 206e 3120 3d20 7465 6e73  size_t n1 = tens
-00016db0: 6f72 2d3e 6e62 5b31 5d3b 0a0a 2020 2020  or->nb[1];..    
-00016dc0: 6368 6172 202a 2063 6f6e 7374 2064 6174  char * const dat
-00016dd0: 6120 3d20 7465 6e73 6f72 2d3e 6461 7461  a = tensor->data
-00016de0: 3b0a 0a20 2020 2073 7769 7463 6820 2874  ;..    switch (t
-00016df0: 656e 736f 722d 3e74 7970 6529 207b 0a20  ensor->type) {. 
-00016e00: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00016e10: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
-00016e20: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00016e30: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00016e40: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-00016e50: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00016e60: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00016e70: 4747 4d4c 5f54 5950 455f 5134 5f31 3a0a  GGML_TYPE_Q4_1:.
-00016e80: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00016e90: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00016ea0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00016eb0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00016ec0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00016ed0: 6173 6520 4747 4d4c 5f54 5950 455f 4938  ase GGML_TYPE_I8
-00016ee0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00016ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f00: 6173 7365 7274 2874 656e 736f 722d 3e6e  assert(tensor->n
-00016f10: 625b 305d 203d 3d20 7369 7a65 6f66 2869  b[0] == sizeof(i
-00016f20: 6e74 385f 7429 293b 0a20 2020 2020 2020  nt8_t));.       
-00016f30: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00016f40: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
-00016f50: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
-00016f60: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00016f70: 7665 635f 7365 745f 6938 286e 632c 2028  vec_set_i8(nc, (
-00016f80: 696e 7438 5f74 202a 2928 6461 7461 202b  int8_t *)(data +
-00016f90: 2069 2a6e 3129 2c20 7661 6c75 6529 3b0a   i*n1), value);.
-00016fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fb0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00016fc0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00016fd0: 6173 6520 4747 4d4c 5f54 5950 455f 4931  ase GGML_TYPE_I1
-00016fe0: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
-00016ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017000: 2061 7373 6572 7428 7465 6e73 6f72 2d3e   assert(tensor->
-00017010: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00017020: 696e 7431 365f 7429 293b 0a20 2020 2020  int16_t));.     
-00017030: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00017040: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00017050: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00017060: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00017070: 6c5f 7665 635f 7365 745f 6931 3628 6e63  l_vec_set_i16(nc
-00017080: 2c20 2869 6e74 3136 5f74 202a 2928 6461  , (int16_t *)(da
-00017090: 7461 202b 2069 2a6e 3129 2c20 7661 6c75  ta + i*n1), valu
-000170a0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-000170b0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000170c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000170d0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000170e0: 455f 4933 323a 0a20 2020 2020 2020 2020  E_I32:.         
-000170f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00017100: 2020 2020 2061 7373 6572 7428 7465 6e73       assert(tens
-00017110: 6f72 2d3e 6e62 5b30 5d20 3d3d 2073 697a  or->nb[0] == siz
-00017120: 656f 6628 696e 7433 325f 7429 293b 0a20  eof(int32_t));. 
-00017130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017140: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00017150: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
-00017160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017170: 2067 676d 6c5f 7665 635f 7365 745f 6933   ggml_vec_set_i3
-00017180: 3228 6e63 2c20 2869 6e74 3332 5f74 202a  2(nc, (int32_t *
-00017190: 2928 6461 7461 202b 2069 2a6e 3129 2c20  )(data + i*n1), 
-000171a0: 7661 6c75 6529 3b0a 2020 2020 2020 2020  value);.        
-000171b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000171c0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000171d0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000171e0: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
-000171f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00017200: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00017210: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-00017220: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-00017230: 365f 7429 293b 0a20 2020 2020 2020 2020  6_t));.         
-00017240: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00017250: 6920 3d20 303b 2069 203c 206e 3b20 692b  i = 0; i < n; i+
-00017260: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00017270: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00017280: 635f 7365 745f 6631 3628 6e63 2c20 2867  c_set_f16(nc, (g
-00017290: 676d 6c5f 6670 3136 5f74 202a 2928 6461  gml_fp16_t *)(da
-000172a0: 7461 202b 2069 2a6e 3129 2c20 7661 6c75  ta + i*n1), valu
-000172b0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-000172c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000172d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000172e0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000172f0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00017300: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00017310: 2020 2020 2061 7373 6572 7428 7465 6e73       assert(tens
-00017320: 6f72 2d3e 6e62 5b30 5d20 3d3d 2073 697a  or->nb[0] == siz
-00017330: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00017340: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00017350: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00017360: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
-00017370: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00017380: 676d 6c5f 7665 635f 7365 745f 6633 3228  gml_vec_set_f32(
-00017390: 6e63 2c20 2866 6c6f 6174 202a 2928 6461  nc, (float *)(da
-000173a0: 7461 202b 2069 2a6e 3129 2c20 7661 6c75  ta + i*n1), valu
-000173b0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-000173c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000173d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000173e0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000173f0: 455f 434f 554e 543a 0a20 2020 2020 2020  E_COUNT:.       
-00017400: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00017410: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00017420: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-00017430: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00017440: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-00017450: 6e20 7465 6e73 6f72 3b0a 7d0a 0a69 6e74  n tensor;.}..int
-00017460: 3332 5f74 2067 676d 6c5f 6765 745f 6933  32_t ggml_get_i3
-00017470: 325f 3164 2863 6f6e 7374 2073 7472 7563  2_1d(const struc
-00017480: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00017490: 7465 6e73 6f72 2c20 696e 7420 6929 207b  tensor, int i) {
-000174a0: 0a20 2020 2073 7769 7463 6820 2874 656e  .    switch (ten
-000174b0: 736f 722d 3e74 7970 6529 207b 0a20 2020  sor->type) {.   
-000174c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-000174d0: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
-000174e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000174f0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00017500: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-00017510: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00017520: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00017530: 4d4c 5f54 5950 455f 5134 5f31 3a0a 2020  ML_TYPE_Q4_1:.  
-00017540: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00017550: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00017560: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00017570: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00017580: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00017590: 6520 4747 4d4c 5f54 5950 455f 4938 3a0a  e GGML_TYPE_I8:.
-000175a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000175b0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000175c0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
-000175d0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-000175e0: 6628 696e 7438 5f74 2929 3b0a 2020 2020  f(int8_t));.    
-000175f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017600: 726e 2028 2869 6e74 385f 7420 2a29 2874  rn ((int8_t *)(t
-00017610: 656e 736f 722d 3e64 6174 6129 295b 695d  ensor->data))[i]
-00017620: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00017630: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00017640: 6173 6520 4747 4d4c 5f54 5950 455f 4931  ase GGML_TYPE_I1
-00017650: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
-00017660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017670: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
-00017680: 736f 722d 3e6e 625b 305d 203d 3d20 7369  sor->nb[0] == si
-00017690: 7a65 6f66 2869 6e74 3136 5f74 2929 3b0a  zeof(int16_t));.
-000176a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176b0: 7265 7475 726e 2028 2869 6e74 3136 5f74  return ((int16_t
-000176c0: 202a 2928 7465 6e73 6f72 2d3e 6461 7461   *)(tensor->data
-000176d0: 2929 5b69 5d3b 0a20 2020 2020 2020 2020  ))[i];.         
-000176e0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000176f0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00017700: 5045 5f49 3332 3a0a 2020 2020 2020 2020  PE_I32:.        
-00017710: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00017720: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00017730: 5428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  T(tensor->nb[0] 
-00017740: 3d3d 2073 697a 656f 6628 696e 7433 325f  == sizeof(int32_
-00017750: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
-00017760: 2020 2020 2072 6574 7572 6e20 2828 696e       return ((in
-00017770: 7433 325f 7420 2a29 2874 656e 736f 722d  t32_t *)(tensor-
-00017780: 3e64 6174 6129 295b 695d 3b0a 2020 2020  >data))[i];.    
-00017790: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000177a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000177b0: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
-000177c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000177d0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000177e0: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
-000177f0: 625b 305d 203d 3d20 7369 7a65 6f66 2867  b[0] == sizeof(g
-00017800: 676d 6c5f 6670 3136 5f74 2929 3b0a 2020  gml_fp16_t));.  
-00017810: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00017820: 7475 726e 2047 474d 4c5f 4650 3136 5f54  turn GGML_FP16_T
-00017830: 4f5f 4650 3332 2828 2867 676d 6c5f 6670  O_FP32(((ggml_fp
-00017840: 3136 5f74 202a 2928 7465 6e73 6f72 2d3e  16_t *)(tensor->
-00017850: 6461 7461 2929 5b69 5d29 3b0a 2020 2020  data))[i]);.    
-00017860: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00017870: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00017880: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-00017890: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000178a0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000178b0: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
-000178c0: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
-000178d0: 6c6f 6174 2929 3b0a 2020 2020 2020 2020  loat));.        
-000178e0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-000178f0: 2866 6c6f 6174 202a 2928 7465 6e73 6f72  (float *)(tensor
-00017900: 2d3e 6461 7461 2929 5b69 5d3b 0a20 2020  ->data))[i];.   
-00017910: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00017920: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00017930: 474d 4c5f 5459 5045 5f43 4f55 4e54 3a0a  GML_TYPE_COUNT:.
-00017940: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00017950: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00017960: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00017970: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00017980: 6272 6561 6b3b 0a20 2020 207d 0a0a 2020  break;.    }..  
-00017990: 2020 7265 7475 726e 2030 2e30 663b 0a7d    return 0.0f;.}
-000179a0: 0a0a 766f 6964 2067 676d 6c5f 7365 745f  ..void ggml_set_
-000179b0: 6933 325f 3164 2863 6f6e 7374 2073 7472  i32_1d(const str
-000179c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000179d0: 2a20 7465 6e73 6f72 2c20 696e 7420 692c  * tensor, int i,
-000179e0: 2069 6e74 3332 5f74 2076 616c 7565 2920   int32_t value) 
-000179f0: 7b0a 2020 2020 7377 6974 6368 2028 7465  {.    switch (te
-00017a00: 6e73 6f72 2d3e 7479 7065 2920 7b0a 2020  nsor->type) {.  
-00017a10: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00017a20: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
-00017a30: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00017a40: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00017a50: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00017a60: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00017a70: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00017a80: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
-00017a90: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00017aa0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00017ab0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00017ac0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00017ad0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00017ae0: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
-00017af0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00017b00: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00017b10: 474d 4c5f 4153 5345 5254 2874 656e 736f  GML_ASSERT(tenso
-00017b20: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
-00017b30: 6f66 2869 6e74 385f 7429 293b 0a20 2020  of(int8_t));.   
-00017b40: 2020 2020 2020 2020 2020 2020 2028 2869               ((i
-00017b50: 6e74 385f 7420 2a29 2874 656e 736f 722d  nt8_t *)(tensor-
-00017b60: 3e64 6174 6129 295b 695d 203d 2076 616c  >data))[i] = val
-00017b70: 7565 3b0a 2020 2020 2020 2020 2020 2020  ue;.            
-00017b80: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00017b90: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00017ba0: 4931 363a 0a20 2020 2020 2020 2020 2020  I16:.           
-00017bb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00017bc0: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-00017bd0: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
-00017be0: 7369 7a65 6f66 2869 6e74 3136 5f74 2929  sizeof(int16_t))
-00017bf0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00017c00: 2020 2828 696e 7431 365f 7420 2a29 2874    ((int16_t *)(t
-00017c10: 656e 736f 722d 3e64 6174 6129 295b 695d  ensor->data))[i]
-00017c20: 203d 2076 616c 7565 3b0a 2020 2020 2020   = value;.      
-00017c30: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00017c40: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00017c50: 5f54 5950 455f 4933 323a 0a20 2020 2020  _TYPE_I32:.     
-00017c60: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00017c70: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00017c80: 5345 5254 2874 656e 736f 722d 3e6e 625b  SERT(tensor->nb[
-00017c90: 305d 203d 3d20 7369 7a65 6f66 2869 6e74  0] == sizeof(int
-00017ca0: 3332 5f74 2929 3b0a 2020 2020 2020 2020  32_t));.        
-00017cb0: 2020 2020 2020 2020 2828 696e 7433 325f          ((int32_
-00017cc0: 7420 2a29 2874 656e 736f 722d 3e64 6174  t *)(tensor->dat
-00017cd0: 6129 295b 695d 203d 2076 616c 7565 3b0a  a))[i] = value;.
-00017ce0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00017cf0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00017d00: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
-00017d10: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00017d20: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00017d30: 474d 4c5f 4153 5345 5254 2874 656e 736f  GML_ASSERT(tenso
-00017d40: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
-00017d50: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
-00017d60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00017d70: 2020 2828 6767 6d6c 5f66 7031 365f 7420    ((ggml_fp16_t 
-00017d80: 2a29 2874 656e 736f 722d 3e64 6174 6129  *)(tensor->data)
-00017d90: 295b 695d 203d 2047 474d 4c5f 4650 3332  )[i] = GGML_FP32
-00017da0: 5f54 4f5f 4650 3136 2876 616c 7565 293b  _TO_FP16(value);
-00017db0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00017dc0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00017dd0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-00017de0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00017df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e00: 4747 4d4c 5f41 5353 4552 5428 7465 6e73  GGML_ASSERT(tens
-00017e10: 6f72 2d3e 6e62 5b30 5d20 3d3d 2073 697a  or->nb[0] == siz
-00017e20: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00017e30: 2020 2020 2020 2020 2020 2020 2028 2866               ((f
-00017e40: 6c6f 6174 202a 2928 7465 6e73 6f72 2d3e  loat *)(tensor->
-00017e50: 6461 7461 2929 5b69 5d20 3d20 7661 6c75  data))[i] = valu
-00017e60: 653b 0a20 2020 2020 2020 2020 2020 207d  e;.            }
-00017e70: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00017e80: 6361 7365 2047 474d 4c5f 5459 5045 5f43  case GGML_TYPE_C
-00017e90: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
-00017ea0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00017eb0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00017ec0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00017ed0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00017ee0: 207d 0a7d 0a0a 666c 6f61 7420 6767 6d6c   }.}..float ggml
-00017ef0: 5f67 6574 5f66 3332 5f31 6428 636f 6e73  _get_f32_1d(cons
-00017f00: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00017f10: 6e73 6f72 202a 2074 656e 736f 722c 2069  nsor * tensor, i
-00017f20: 6e74 2069 2920 7b0a 2020 2020 7377 6974  nt i) {.    swit
-00017f30: 6368 2028 7465 6e73 6f72 2d3e 7479 7065  ch (tensor->type
-00017f40: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-00017f50: 2047 474d 4c5f 5459 5045 5f51 345f 303a   GGML_TYPE_Q4_0:
-00017f60: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00017f70: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00017f80: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00017f90: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00017fa0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00017fb0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00017fc0: 345f 313a 0a20 2020 2020 2020 2020 2020  4_1:.           
-00017fd0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00017fe0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00017ff0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-00018000: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00018010: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00018020: 5045 5f49 383a 0a20 2020 2020 2020 2020  PE_I8:.         
-00018030: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00018040: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00018050: 2874 656e 736f 722d 3e6e 625b 305d 203d  (tensor->nb[0] =
-00018060: 3d20 7369 7a65 6f66 2869 6e74 385f 7429  = sizeof(int8_t)
-00018070: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00018080: 2020 2072 6574 7572 6e20 2828 696e 7438     return ((int8
-00018090: 5f74 202a 2928 7465 6e73 6f72 2d3e 6461  _t *)(tensor->da
-000180a0: 7461 2929 5b69 5d3b 0a20 2020 2020 2020  ta))[i];.       
-000180b0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000180c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000180d0: 5459 5045 5f49 3136 3a0a 2020 2020 2020  TYPE_I16:.      
-000180e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000180f0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00018100: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
-00018110: 5d20 3d3d 2073 697a 656f 6628 696e 7431  ] == sizeof(int1
-00018120: 365f 7429 293b 0a20 2020 2020 2020 2020  6_t));.         
-00018130: 2020 2020 2020 2072 6574 7572 6e20 2828         return ((
-00018140: 696e 7431 365f 7420 2a29 2874 656e 736f  int16_t *)(tenso
-00018150: 722d 3e64 6174 6129 295b 695d 3b0a 2020  r->data))[i];.  
-00018160: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00018170: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00018180: 4747 4d4c 5f54 5950 455f 4933 323a 0a20  GGML_TYPE_I32:. 
-00018190: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000181a0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-000181b0: 4c5f 4153 5345 5254 2874 656e 736f 722d  L_ASSERT(tensor-
-000181c0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-000181d0: 2869 6e74 3332 5f74 2929 3b0a 2020 2020  (int32_t));.    
-000181e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000181f0: 726e 2028 2869 6e74 3332 5f74 202a 2928  rn ((int32_t *)(
-00018200: 7465 6e73 6f72 2d3e 6461 7461 2929 5b69  tensor->data))[i
-00018210: 5d3b 0a20 2020 2020 2020 2020 2020 207d  ];.            }
-00018220: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00018230: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00018240: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
-00018250: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00018260: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
-00018270: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
-00018280: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-00018290: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
-000182a0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
-000182b0: 5f46 5031 365f 544f 5f46 5033 3228 2828  _FP16_TO_FP32(((
-000182c0: 6767 6d6c 5f66 7031 365f 7420 2a29 2874  ggml_fp16_t *)(t
-000182d0: 656e 736f 722d 3e64 6174 6129 295b 695d  ensor->data))[i]
-000182e0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000182f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00018300: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00018310: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-00018320: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00018330: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
-00018340: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
-00018350: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-00018360: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00018370: 6574 7572 6e20 2828 666c 6f61 7420 2a29  eturn ((float *)
-00018380: 2874 656e 736f 722d 3e64 6174 6129 295b  (tensor->data))[
-00018390: 695d 3b0a 2020 2020 2020 2020 2020 2020  i];.            
-000183a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000183b0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-000183c0: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
-000183d0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000183e0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-000183f0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00018400: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00018410: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-00018420: 302e 3066 3b0a 7d0a 0a76 6f69 6420 6767  0.0f;.}..void gg
-00018430: 6d6c 5f73 6574 5f66 3332 5f31 6428 636f  ml_set_f32_1d(co
-00018440: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00018450: 7465 6e73 6f72 202a 2074 656e 736f 722c  tensor * tensor,
-00018460: 2069 6e74 2069 2c20 666c 6f61 7420 7661   int i, float va
-00018470: 6c75 6529 207b 0a20 2020 2073 7769 7463  lue) {.    switc
-00018480: 6820 2874 656e 736f 722d 3e74 7970 6529  h (tensor->type)
-00018490: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-000184a0: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
-000184b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000184c0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000184d0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-000184e0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000184f0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00018500: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00018510: 5f31 3a0a 2020 2020 2020 2020 2020 2020  _1:.            
-00018520: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00018530: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00018540: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
-00018550: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00018560: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00018570: 455f 4938 3a0a 2020 2020 2020 2020 2020  E_I8:.          
-00018580: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00018590: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000185a0: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-000185b0: 2073 697a 656f 6628 696e 7438 5f74 2929   sizeof(int8_t))
-000185c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000185d0: 2020 2828 696e 7438 5f74 202a 2928 7465    ((int8_t *)(te
-000185e0: 6e73 6f72 2d3e 6461 7461 2929 5b69 5d20  nsor->data))[i] 
-000185f0: 3d20 7661 6c75 653b 0a20 2020 2020 2020  = value;.       
-00018600: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00018610: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00018620: 5459 5045 5f49 3136 3a0a 2020 2020 2020  TYPE_I16:.      
-00018630: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00018640: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00018650: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
-00018660: 5d20 3d3d 2073 697a 656f 6628 696e 7431  ] == sizeof(int1
-00018670: 365f 7429 293b 0a20 2020 2020 2020 2020  6_t));.         
-00018680: 2020 2020 2020 2028 2869 6e74 3136 5f74         ((int16_t
-00018690: 202a 2928 7465 6e73 6f72 2d3e 6461 7461   *)(tensor->data
-000186a0: 2929 5b69 5d20 3d20 7661 6c75 653b 0a20  ))[i] = value;. 
-000186b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000186c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-000186d0: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
-000186e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000186f0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00018700: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
-00018710: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-00018720: 6628 696e 7433 325f 7429 293b 0a20 2020  f(int32_t));.   
-00018730: 2020 2020 2020 2020 2020 2020 2028 2869               ((i
-00018740: 6e74 3332 5f74 202a 2928 7465 6e73 6f72  nt32_t *)(tensor
-00018750: 2d3e 6461 7461 2929 5b69 5d20 3d20 7661  ->data))[i] = va
-00018760: 6c75 653b 0a20 2020 2020 2020 2020 2020  lue;.           
-00018770: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00018780: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00018790: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
-000187a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000187b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000187c0: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-000187d0: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-000187e0: 365f 7429 293b 0a20 2020 2020 2020 2020  6_t));.         
-000187f0: 2020 2020 2020 2028 2867 676d 6c5f 6670         ((ggml_fp
-00018800: 3136 5f74 202a 2928 7465 6e73 6f72 2d3e  16_t *)(tensor->
-00018810: 6461 7461 2929 5b69 5d20 3d20 4747 4d4c  data))[i] = GGML
-00018820: 5f46 5033 325f 544f 5f46 5031 3628 7661  _FP32_TO_FP16(va
-00018830: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
-00018840: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00018850: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00018860: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00018870: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00018880: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00018890: 2874 656e 736f 722d 3e6e 625b 305d 203d  (tensor->nb[0] =
-000188a0: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-000188b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000188c0: 2020 2828 666c 6f61 7420 2a29 2874 656e    ((float *)(ten
-000188d0: 736f 722d 3e64 6174 6129 295b 695d 203d  sor->data))[i] =
-000188e0: 2076 616c 7565 3b0a 2020 2020 2020 2020   value;.        
-000188f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00018900: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00018910: 5950 455f 434f 554e 543a 0a20 2020 2020  YPE_COUNT:.     
-00018920: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00018930: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00018940: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00018950: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00018960: 3b0a 2020 2020 7d0a 7d0a 0a76 6f69 6420  ;.    }.}..void 
-00018970: 2a20 6767 6d6c 5f67 6574 5f64 6174 6128  * ggml_get_data(
-00018980: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00018990: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
-000189a0: 7229 207b 0a20 2020 2072 6574 7572 6e20  r) {.    return 
-000189b0: 7465 6e73 6f72 2d3e 6461 7461 3b0a 7d0a  tensor->data;.}.
-000189c0: 0a66 6c6f 6174 202a 2067 676d 6c5f 6765  .float * ggml_ge
-000189d0: 745f 6461 7461 5f66 3332 2863 6f6e 7374  t_data_f32(const
-000189e0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000189f0: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
-00018a00: 2020 2020 6173 7365 7274 2874 656e 736f      assert(tenso
-00018a10: 722d 3e74 7970 6520 3d3d 2047 474d 4c5f  r->type == GGML_
-00018a20: 5459 5045 5f46 3332 293b 0a20 2020 2072  TYPE_F32);.    r
-00018a30: 6574 7572 6e20 2866 6c6f 6174 202a 2928  eturn (float *)(
-00018a40: 7465 6e73 6f72 2d3e 6461 7461 293b 0a7d  tensor->data);.}
-00018a50: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00018a60: 6e73 6f72 202a 2067 676d 6c5f 7669 6577  nsor * ggml_view
-00018a70: 5f74 656e 736f 7228 0a20 2020 2020 2020  _tensor(.       
-00018a80: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00018a90: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00018aa0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00018ab0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00018ac0: 7263 2920 7b0a 2020 2020 7265 7475 726e  rc) {.    return
-00018ad0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-00018ae0: 5f69 6d70 6c28 6374 782c 2073 7263 2d3e  _impl(ctx, src->
-00018af0: 7479 7065 2c20 7372 632d 3e6e 5f64 696d  type, src->n_dim
-00018b00: 732c 2073 7263 2d3e 6e65 2c20 7372 632d  s, src->ne, src-
-00018b10: 3e64 6174 6129 3b0a 7d0a 0a2f 2f2f 2f2f  >data);.}../////
-00018b20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00018b30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00018b40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00018b50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00018b60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a2f 2f20  ///////////..// 
-00018b70: 6767 6d6c 5f64 7570 0a0a 7374 7275 6374  ggml_dup..struct
-00018b80: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00018b90: 676d 6c5f 6475 705f 696d 706c 280a 2020  gml_dup_impl(.  
-00018ba0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00018bb0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-00018bc0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00018bd0: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
-00018be0: 0a20 2020 2020 2020 2062 6f6f 6c20 696e  .        bool in
-00018bf0: 706c 6163 6529 207b 0a20 2020 2062 6f6f  place) {.    boo
-00018c00: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
-00018c10: 653b 0a0a 2020 2020 6966 2028 2169 6e70  e;..    if (!inp
-00018c20: 6c61 6365 2026 2620 2861 2d3e 6772 6164  lace && (a->grad
-00018c30: 2929 207b 0a20 2020 2020 2020 2069 735f  )) {.        is_
-00018c40: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
-00018c50: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
-00018c60: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
-00018c70: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
-00018c80: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
-00018c90: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
-00018ca0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-00018cb0: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
-00018cc0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-00018cd0: 4455 503b 0a20 2020 2072 6573 756c 742d  DUP;.    result-
-00018ce0: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-00018cf0: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-00018d00: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-00018d10: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-00018d20: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-00018d30: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-00018d40: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-00018d50: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
-00018d60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00018d70: 2a20 6767 6d6c 5f64 7570 280a 2020 2020  * ggml_dup(.    
-00018d80: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00018d90: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-00018da0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00018db0: 6d6c 5f74 656e 736f 7220 2a20 6129 207b  ml_tensor * a) {
-00018dc0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-00018dd0: 5f64 7570 5f69 6d70 6c28 6374 782c 2061  _dup_impl(ctx, a
-00018de0: 2c20 6661 6c73 6529 3b0a 7d0a 0a73 7472  , false);.}..str
-00018df0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00018e00: 2a20 6767 6d6c 5f64 7570 5f69 6e70 6c61  * ggml_dup_inpla
-00018e10: 6365 280a 2020 2020 2020 2020 7374 7275  ce(.        stru
-00018e20: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00018e30: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-00018e40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00018e50: 7220 2a20 6129 207b 0a20 2020 2072 6574  r * a) {.    ret
-00018e60: 7572 6e20 6767 6d6c 5f64 7570 5f69 6d70  urn ggml_dup_imp
-00018e70: 6c28 6374 782c 2061 2c20 7472 7565 293b  l(ctx, a, true);
-00018e80: 0a7d 0a0a 2f2f 2067 676d 6c5f 6164 640a  .}..// ggml_add.
-00018e90: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-00018ea0: 736f 7220 2a20 6767 6d6c 5f61 6464 5f69  sor * ggml_add_i
-00018eb0: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
-00018ec0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-00018ed0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-00018ee0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00018ef0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
-00018f00: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00018f10: 6f72 202a 2062 2c0a 2020 2020 2020 2020  or * b,.        
-00018f20: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
-00018f30: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00018f40: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
-00018f50: 6170 6528 612c 2062 2929 3b0a 0a20 2020  ape(a, b));..   
-00018f60: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-00018f70: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-00018f80: 2169 6e70 6c61 6365 2026 2620 2861 2d3e  !inplace && (a->
-00018f90: 6772 6164 207c 7c20 622d 3e67 7261 6429  grad || b->grad)
-00018fa0: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-00018fb0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-00018fc0: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
-00018fd0: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-00018fe0: 6c74 203d 2069 6e70 6c61 6365 203f 2067  lt = inplace ? g
-00018ff0: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
-00019000: 6374 782c 2061 2920 3a20 6767 6d6c 5f64  ctx, a) : ggml_d
-00019010: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
-00019020: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-00019030: 6f70 2020 203d 2047 474d 4c5f 4f50 5f41  op   = GGML_OP_A
-00019040: 4444 3b0a 2020 2020 7265 7375 6c74 2d3e  DD;.    result->
-00019050: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
-00019060: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00019070: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
-00019080: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
-00019090: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
-000190a0: 7265 7375 6c74 2d3e 7372 6331 203d 2062  result->src1 = b
-000190b0: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
-000190c0: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
-000190d0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-000190e0: 6d6c 5f61 6464 280a 2020 2020 2020 2020  ml_add(.        
-000190f0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00019100: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-00019110: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00019120: 656e 736f 7220 2a20 612c 0a20 2020 2020  ensor * a,.     
-00019130: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00019140: 656e 736f 7220 2a20 6229 207b 0a20 2020  ensor * b) {.   
-00019150: 2072 6574 7572 6e20 6767 6d6c 5f61 6464   return ggml_add
-00019160: 5f69 6d70 6c28 6374 782c 2061 2c20 622c  _impl(ctx, a, b,
-00019170: 2066 616c 7365 293b 0a7d 0a0a 7374 7275   false);.}..stru
-00019180: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00019190: 2067 676d 6c5f 6164 645f 696e 706c 6163   ggml_add_inplac
-000191a0: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
-000191b0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-000191c0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-000191d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000191e0: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-000191f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00019200: 202a 2062 2920 7b0a 2020 2020 7265 7475   * b) {.    retu
-00019210: 726e 2067 676d 6c5f 6164 645f 696d 706c  rn ggml_add_impl
-00019220: 2863 7478 2c20 612c 2062 2c20 7472 7565  (ctx, a, b, true
-00019230: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 7375  );.}..// ggml_su
-00019240: 620a 0a73 7472 7563 7420 6767 6d6c 5f74  b..struct ggml_t
-00019250: 656e 736f 7220 2a20 6767 6d6c 5f73 7562  ensor * ggml_sub
-00019260: 5f69 6d70 6c28 0a20 2020 2020 2020 2073  _impl(.        s
-00019270: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00019280: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00019290: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000192a0: 6e73 6f72 202a 2061 2c0a 2020 2020 2020  nsor * a,.      
-000192b0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000192c0: 6e73 6f72 202a 2062 2c0a 2020 2020 2020  nsor * b,.      
-000192d0: 2020 626f 6f6c 2069 6e70 6c61 6365 2920    bool inplace) 
-000192e0: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-000192f0: 5428 6767 6d6c 5f61 7265 5f73 616d 655f  T(ggml_are_same_
-00019300: 7368 6170 6528 612c 2062 2929 3b0a 0a20  shape(a, b));.. 
-00019310: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-00019320: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-00019330: 2028 2169 6e70 6c61 6365 2026 2620 2861   (!inplace && (a
-00019340: 2d3e 6772 6164 207c 7c20 622d 3e67 7261  ->grad || b->gra
-00019350: 6429 2920 7b0a 2020 2020 2020 2020 6973  d)) {.        is
-00019360: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-00019370: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-00019380: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-00019390: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-000193a0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-000193b0: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-000193c0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-000193d0: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-000193e0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-000193f0: 5f53 5542 3b0a 2020 2020 7265 7375 6c74  _SUB;.    result
-00019400: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-00019410: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-00019420: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-00019430: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-00019440: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-00019450: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-00019460: 2062 3b0a 0a20 2020 2072 6574 7572 6e20   b;..    return 
-00019470: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
-00019480: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00019490: 6767 6d6c 5f73 7562 280a 2020 2020 2020  ggml_sub(.      
-000194a0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-000194b0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-000194c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000194d0: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
-000194e0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000194f0: 5f74 656e 736f 7220 2a20 6229 207b 0a20  _tensor * b) {. 
-00019500: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
-00019510: 7562 5f69 6d70 6c28 6374 782c 2061 2c20  ub_impl(ctx, a, 
-00019520: 622c 2066 616c 7365 293b 0a7d 0a0a 7374  b, false);.}..st
-00019530: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00019540: 202a 2067 676d 6c5f 7375 625f 696e 706c   * ggml_sub_inpl
-00019550: 6163 6528 0a20 2020 2020 2020 2073 7472  ace(.        str
-00019560: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-00019570: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-00019580: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00019590: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
-000195a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000195b0: 6f72 202a 2062 2920 7b0a 2020 2020 7265  or * b) {.    re
-000195c0: 7475 726e 2067 676d 6c5f 7375 625f 696d  turn ggml_sub_im
-000195d0: 706c 2863 7478 2c20 612c 2062 2c20 7472  pl(ctx, a, b, tr
-000195e0: 7565 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  ue);.}..// ggml_
-000195f0: 6d75 6c0a 0a73 7472 7563 7420 6767 6d6c  mul..struct ggml
-00019600: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
-00019610: 756c 5f69 6d70 6c28 0a20 2020 2020 2020  ul_impl(.       
-00019620: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00019630: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00019640: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00019650: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
-00019660: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00019670: 7465 6e73 6f72 202a 2062 2c0a 2020 2020  tensor * b,.    
-00019680: 2020 2020 626f 6f6c 2069 6e70 6c61 6365      bool inplace
-00019690: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
-000196a0: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
-000196b0: 655f 7368 6170 6528 612c 2062 2929 3b0a  e_shape(a, b));.
-000196c0: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
-000196d0: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
-000196e0: 6966 2028 2169 6e70 6c61 6365 2026 2620  if (!inplace && 
-000196f0: 2861 2d3e 6772 6164 207c 7c20 622d 3e67  (a->grad || b->g
-00019700: 7261 6429 2920 7b0a 2020 2020 2020 2020  rad)) {.        
-00019710: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
-00019720: 2020 2020 7d0a 0a20 2020 2069 6620 2869      }..    if (i
-00019730: 6e70 6c61 6365 2920 7b0a 2020 2020 2020  nplace) {.      
-00019740: 2020 4747 4d4c 5f41 5353 4552 5428 6973    GGML_ASSERT(is
-00019750: 5f6e 6f64 6520 3d3d 2066 616c 7365 293b  _node == false);
-00019760: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-00019770: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00019780: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
-00019790: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-000197a0: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-000197b0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-000197c0: 7478 2c20 6129 3b0a 0a20 2020 2072 6573  tx, a);..    res
-000197d0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
-000197e0: 5f4f 505f 4d55 4c3b 0a20 2020 2072 6573  _OP_MUL;.    res
-000197f0: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
-00019800: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
-00019810: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
-00019820: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
-00019830: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
-00019840: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-00019850: 3120 3d20 623b 0a0a 2020 2020 7265 7475  1 = b;..    retu
-00019860: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
-00019870: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00019880: 202a 2067 676d 6c5f 6d75 6c28 0a20 2020   * ggml_mul(.   
-00019890: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000198a0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-000198b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000198c0: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
-000198d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000198e0: 6767 6d6c 5f74 656e 736f 7220 202a 2062  ggml_tensor  * b
-000198f0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-00019900: 676d 6c5f 6d75 6c5f 696d 706c 2863 7478  gml_mul_impl(ctx
-00019910: 2c20 612c 2062 2c20 6661 6c73 6529 3b0a  , a, b, false);.
-00019920: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
-00019930: 656e 736f 7220 2a20 6767 6d6c 5f6d 756c  ensor * ggml_mul
-00019940: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
-00019950: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-00019960: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-00019970: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00019980: 5f74 656e 736f 7220 202a 2061 2c0a 2020  _tensor  * a,.  
-00019990: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000199a0: 6c5f 7465 6e73 6f72 2020 2a20 6229 207b  l_tensor  * b) {
-000199b0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-000199c0: 5f6d 756c 5f69 6d70 6c28 6374 782c 2061  _mul_impl(ctx, a
-000199d0: 2c20 622c 2074 7275 6529 3b0a 7d0a 0a2f  , b, true);.}../
-000199e0: 2f20 6767 6d6c 5f64 6976 0a0a 7374 7275  / ggml_div..stru
-000199f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00019a00: 2067 676d 6c5f 6469 765f 696d 706c 280a   ggml_div_impl(.
-00019a10: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00019a20: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00019a30: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00019a40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00019a50: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-00019a60: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00019a70: 622c 0a20 2020 2020 2020 2062 6f6f 6c20  b,.        bool 
-00019a80: 696e 706c 6163 6529 207b 0a20 2020 2047  inplace) {.    G
-00019a90: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-00019aa0: 6172 655f 7361 6d65 5f73 6861 7065 2861  are_same_shape(a
-00019ab0: 2c20 6229 293b 0a0a 2020 2020 626f 6f6c  , b));..    bool
-00019ac0: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-00019ad0: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
-00019ae0: 6163 6520 2626 2028 612d 3e67 7261 6420  ace && (a->grad 
-00019af0: 7c7c 2062 2d3e 6772 6164 2929 207b 0a20  || b->grad)) {. 
-00019b00: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
-00019b10: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
-00019b20: 2020 6966 2028 696e 706c 6163 6529 207b    if (inplace) {
-00019b30: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
-00019b40: 5345 5254 2869 735f 6e6f 6465 203d 3d20  SERT(is_node == 
-00019b50: 6661 6c73 6529 3b0a 2020 2020 7d0a 0a20  false);.    }.. 
-00019b60: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00019b70: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
-00019b80: 2069 6e70 6c61 6365 203f 2067 676d 6c5f   inplace ? ggml_
-00019b90: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
-00019ba0: 2061 2920 3a20 6767 6d6c 5f64 7570 5f74   a) : ggml_dup_t
-00019bb0: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
-00019bc0: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-00019bd0: 203d 2047 474d 4c5f 4f50 5f44 4956 3b0a   = GGML_OP_DIV;.
-00019be0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-00019bf0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-00019c00: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-00019c10: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-00019c20: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-00019c30: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-00019c40: 6c74 2d3e 7372 6331 203d 2062 3b0a 0a20  lt->src1 = b;.. 
-00019c50: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00019c60: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-00019c70: 5f74 656e 736f 7220 2a20 6767 6d6c 5f64  _tensor * ggml_d
-00019c80: 6976 280a 2020 2020 2020 2020 7374 7275  iv(.        stru
-00019c90: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00019ca0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-00019cb0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00019cc0: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
-00019cd0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00019ce0: 6f72 2020 2a20 6229 207b 0a20 2020 2072  or  * b) {.    r
-00019cf0: 6574 7572 6e20 6767 6d6c 5f64 6976 5f69  eturn ggml_div_i
-00019d00: 6d70 6c28 6374 782c 2061 2c20 622c 2066  mpl(ctx, a, b, f
-00019d10: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
-00019d20: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00019d30: 676d 6c5f 6469 765f 696e 706c 6163 6528  gml_div_inplace(
-00019d40: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00019d50: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00019d60: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-00019d70: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-00019d80: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
-00019d90: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00019da0: 202a 2062 2920 7b0a 2020 2020 7265 7475   * b) {.    retu
-00019db0: 726e 2067 676d 6c5f 6469 765f 696d 706c  rn ggml_div_impl
-00019dc0: 2863 7478 2c20 612c 2062 2c20 7472 7565  (ctx, a, b, true
-00019dd0: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 7371  );.}..// ggml_sq
-00019de0: 720a 0a73 7472 7563 7420 6767 6d6c 5f74  r..struct ggml_t
-00019df0: 656e 736f 7220 2a20 6767 6d6c 5f73 7172  ensor * ggml_sqr
-00019e00: 5f69 6d70 6c28 0a20 2020 2020 2020 2073  _impl(.        s
-00019e10: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00019e20: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00019e30: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00019e40: 6e73 6f72 202a 2061 2c0a 2020 2020 2020  nsor * a,.      
-00019e50: 2020 626f 6f6c 2069 6e70 6c61 6365 2920    bool inplace) 
-00019e60: 7b0a 2020 2020 626f 6f6c 2069 735f 6e6f  {.    bool is_no
-00019e70: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
-00019e80: 2069 6620 2821 696e 706c 6163 6520 2626   if (!inplace &&
-00019e90: 2028 612d 3e67 7261 6429 2920 7b0a 2020   (a->grad)) {.  
-00019ea0: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
-00019eb0: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
-00019ec0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00019ed0: 736f 7220 2a20 7265 7375 6c74 203d 2069  sor * result = i
-00019ee0: 6e70 6c61 6365 203f 2067 676d 6c5f 7669  nplace ? ggml_vi
-00019ef0: 6577 5f74 656e 736f 7228 6374 782c 2061  ew_tensor(ctx, a
-00019f00: 2920 3a20 6767 6d6c 5f64 7570 5f74 656e  ) : ggml_dup_ten
-00019f10: 736f 7228 6374 782c 2061 293b 0a0a 2020  sor(ctx, a);..  
-00019f20: 2020 7265 7375 6c74 2d3e 6f70 2020 203d    result->op   =
-00019f30: 2047 474d 4c5f 4f50 5f53 5152 3b0a 2020   GGML_OP_SQR;.  
-00019f40: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-00019f50: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-00019f60: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-00019f70: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-00019f80: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-00019f90: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-00019fa0: 2d3e 7372 6331 203d 204e 554c 4c3b 0a0a  ->src1 = NULL;..
-00019fb0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00019fc0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-00019fd0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00019fe0: 7371 7228 0a20 2020 2020 2020 2073 7472  sqr(.        str
-00019ff0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0001a000: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0001a010: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001a020: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
-0001a030: 6574 7572 6e20 6767 6d6c 5f73 7172 5f69  eturn ggml_sqr_i
-0001a040: 6d70 6c28 6374 782c 2061 2c20 6661 6c73  mpl(ctx, a, fals
-0001a050: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
-0001a060: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-0001a070: 5f73 7172 5f69 6e70 6c61 6365 280a 2020  _sqr_inplace(.  
-0001a080: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001a090: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-0001a0a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001a0b0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
-0001a0c0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-0001a0d0: 676d 6c5f 7371 725f 696d 706c 2863 7478  gml_sqr_impl(ctx
-0001a0e0: 2c20 612c 2074 7275 6529 3b0a 7d0a 0a2f  , a, true);.}../
-0001a0f0: 2f20 6767 6d6c 5f73 7172 740a 0a73 7472  / ggml_sqrt..str
-0001a100: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001a110: 2a20 6767 6d6c 5f73 7172 745f 696d 706c  * ggml_sqrt_impl
-0001a120: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0001a130: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0001a140: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0001a150: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001a160: 2a20 612c 0a20 2020 2020 2020 2062 6f6f  * a,.        boo
-0001a170: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
-0001a180: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0001a190: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0001a1a0: 2169 6e70 6c61 6365 2026 2620 2861 2d3e  !inplace && (a->
-0001a1b0: 6772 6164 2929 207b 0a20 2020 2020 2020  grad)) {.       
-0001a1c0: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0001a1d0: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-0001a1e0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001a1f0: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
-0001a200: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-0001a210: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-0001a220: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0001a230: 7478 2c20 6129 3b0a 0a20 2020 2072 6573  tx, a);..    res
-0001a240: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
-0001a250: 5f4f 505f 5351 5254 3b0a 2020 2020 7265  _OP_SQRT;.    re
-0001a260: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-0001a270: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-0001a280: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-0001a290: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-0001a2a0: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-0001a2b0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0001a2c0: 6331 203d 204e 554c 4c3b 0a0a 2020 2020  c1 = NULL;..    
-0001a2d0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-0001a2e0: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001a2f0: 6e73 6f72 202a 2067 676d 6c5f 7371 7274  nsor * ggml_sqrt
-0001a300: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0001a310: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0001a320: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0001a330: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001a340: 202a 2061 2920 7b0a 2020 2020 7265 7475   * a) {.    retu
-0001a350: 726e 2067 676d 6c5f 7371 7274 5f69 6d70  rn ggml_sqrt_imp
-0001a360: 6c28 6374 782c 2061 2c20 6661 6c73 6529  l(ctx, a, false)
-0001a370: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-0001a380: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
-0001a390: 7172 745f 696e 706c 6163 6528 0a20 2020  qrt_inplace(.   
-0001a3a0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001a3b0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0001a3c0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0001a3d0: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0001a3e0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0001a3f0: 6d6c 5f73 7172 745f 696d 706c 2863 7478  ml_sqrt_impl(ctx
-0001a400: 2c20 612c 2074 7275 6529 3b0a 7d0a 0a2f  , a, true);.}../
-0001a410: 2f20 6767 6d6c 5f73 756d 0a0a 7374 7275  / ggml_sum..stru
-0001a420: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001a430: 2067 676d 6c5f 7375 6d28 0a20 2020 2020   ggml_sum(.     
-0001a440: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001a450: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001a460: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001a470: 6c5f 7465 6e73 6f72 202a 2061 2920 7b0a  l_tensor * a) {.
-0001a480: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
-0001a490: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
-0001a4a0: 6620 2861 2d3e 6772 6164 2920 7b0a 2020  f (a->grad) {.  
-0001a4b0: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
-0001a4c0: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
-0001a4d0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001a4e0: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
-0001a4f0: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
-0001a500: 6428 6374 782c 2061 2d3e 7479 7065 2c20  d(ctx, a->type, 
-0001a510: 3129 3b0a 0a20 2020 2072 6573 756c 742d  1);..    result-
-0001a520: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-0001a530: 5355 4d3b 0a20 2020 2072 6573 756c 742d  SUM;.    result-
-0001a540: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-0001a550: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-0001a560: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-0001a570: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0001a580: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-0001a590: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-0001a5a0: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-0001a5b0: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
-0001a5c0: 6767 6d6c 5f6d 6561 6e0a 0a73 7472 7563  ggml_mean..struc
-0001a5d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001a5e0: 6767 6d6c 5f6d 6561 6e28 0a20 2020 2020  ggml_mean(.     
-0001a5f0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001a600: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001a610: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001a620: 6c5f 7465 6e73 6f72 202a 2061 2920 7b0a  l_tensor * a) {.
-0001a630: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
-0001a640: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
-0001a650: 6620 2861 2d3e 6772 6164 2920 7b0a 2020  f (a->grad) {.  
-0001a660: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0001a670: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-0001a680: 4f3a 2069 6d70 6c65 6d65 6e74 0a20 2020  O: implement.   
-0001a690: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
-0001a6a0: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
-0001a6b0: 696e 7420 6e65 5b47 474d 4c5f 4d41 585f  int ne[GGML_MAX_
-0001a6c0: 4449 4d53 5d20 3d20 7b20 312c 2061 2d3e  DIMS] = { 1, a->
-0001a6d0: 6e65 5b31 5d2c 2061 2d3e 6e65 5b32 5d2c  ne[1], a->ne[2],
-0001a6e0: 2061 2d3e 6e65 5b33 5d20 7d3b 0a20 2020   a->ne[3] };.   
-0001a6f0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001a700: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
-0001a710: 676d 6c5f 6e65 775f 7465 6e73 6f72 2863  gml_new_tensor(c
-0001a720: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-0001a730: 322c 2061 2d3e 6e5f 6469 6d73 2c20 6e65  2, a->n_dims, ne
-0001a740: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0001a750: 6f70 2020 203d 2047 474d 4c5f 4f50 5f4d  op   = GGML_OP_M
-0001a760: 4541 4e3b 0a20 2020 2072 6573 756c 742d  EAN;.    result-
-0001a770: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-0001a780: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-0001a790: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-0001a7a0: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0001a7b0: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-0001a7c0: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-0001a7d0: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-0001a7e0: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
-0001a7f0: 6767 6d6c 5f72 6570 6561 740a 0a73 7472  ggml_repeat..str
-0001a800: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001a810: 2a20 6767 6d6c 5f72 6570 6561 7428 0a20  * ggml_repeat(. 
-0001a820: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001a830: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001a840: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001a850: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0001a860: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001a870: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-0001a880: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
-0001a890: 4552 5428 6767 6d6c 5f63 616e 5f72 6570  ERT(ggml_can_rep
-0001a8a0: 6561 7428 612c 2062 2929 3b0a 0a20 2020  eat(a, b));..   
-0001a8b0: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0001a8c0: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0001a8d0: 612d 3e67 7261 6429 207b 0a20 2020 2020  a->grad) {.     
-0001a8e0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-0001a8f0: 653b 0a20 2020 207d 0a0a 2020 2020 6966  e;.    }..    if
-0001a900: 2028 6767 6d6c 5f61 7265 5f73 616d 655f   (ggml_are_same_
-0001a910: 7368 6170 6528 612c 2062 2920 2626 2021  shape(a, b) && !
-0001a920: 6973 5f6e 6f64 6529 207b 0a20 2020 2020  is_node) {.     
-0001a930: 2020 2072 6574 7572 6e20 613b 0a20 2020     return a;.   
-0001a940: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
-0001a950: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
-0001a960: 756c 7420 3d20 6767 6d6c 5f6e 6577 5f74  ult = ggml_new_t
-0001a970: 656e 736f 7228 6374 782c 2061 2d3e 7479  ensor(ctx, a->ty
-0001a980: 7065 2c20 622d 3e6e 5f64 696d 732c 2062  pe, b->n_dims, b
-0001a990: 2d3e 6e65 293b 0a0a 2020 2020 7265 7375  ->ne);..    resu
-0001a9a0: 6c74 2d3e 6f70 2020 203d 2047 474d 4c5f  lt->op   = GGML_
-0001a9b0: 4f50 5f52 4550 4541 543b 0a20 2020 2072  OP_REPEAT;.    r
-0001a9c0: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-0001a9d0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-0001a9e0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-0001a9f0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-0001aa00: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-0001aa10: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-0001aa20: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
-0001aa30: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-0001aa40: 2f2f 2067 676d 6c5f 6162 730a 0a73 7472  // ggml_abs..str
-0001aa50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001aa60: 2a20 6767 6d6c 5f61 6273 5f69 6d70 6c28  * ggml_abs_impl(
-0001aa70: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001aa80: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0001aa90: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0001aaa0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001aab0: 2061 2c0a 2020 2020 2020 2020 626f 6f6c   a,.        bool
-0001aac0: 2069 6e70 6c61 6365 2920 7b0a 2020 2020   inplace) {.    
-0001aad0: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
-0001aae0: 616c 7365 3b0a 0a20 2020 2069 6620 2821  alse;..    if (!
-0001aaf0: 696e 706c 6163 6520 2626 2028 612d 3e67  inplace && (a->g
-0001ab00: 7261 6429 2920 7b0a 2020 2020 2020 2020  rad)) {.        
-0001ab10: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
-0001ab20: 2020 2020 7d0a 0a20 2020 2073 7472 7563      }..    struc
-0001ab30: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001ab40: 7265 7375 6c74 203d 2069 6e70 6c61 6365  result = inplace
-0001ab50: 203f 2067 676d 6c5f 7669 6577 5f74 656e   ? ggml_view_ten
-0001ab60: 736f 7228 6374 782c 2061 2920 3a20 6767  sor(ctx, a) : gg
-0001ab70: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
-0001ab80: 782c 2061 293b 0a0a 2020 2020 7265 7375  x, a);..    resu
-0001ab90: 6c74 2d3e 6f70 2020 203d 2047 474d 4c5f  lt->op   = GGML_
-0001aba0: 4f50 5f41 4253 3b0a 2020 2020 7265 7375  OP_ABS;.    resu
-0001abb0: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
-0001abc0: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
-0001abd0: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
-0001abe0: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
-0001abf0: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
-0001ac00: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
-0001ac10: 203d 204e 554c 4c3b 0a0a 2020 2020 7265   = NULL;..    re
-0001ac20: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-0001ac30: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001ac40: 6f72 202a 2067 676d 6c5f 6162 7328 0a20  or * ggml_abs(. 
-0001ac50: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001ac60: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001ac70: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001ac80: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001ac90: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
-0001aca0: 6767 6d6c 5f61 6273 5f69 6d70 6c28 6374  ggml_abs_impl(ct
-0001acb0: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
-0001acc0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0001acd0: 736f 7220 2a20 6767 6d6c 5f61 6273 5f69  sor * ggml_abs_i
-0001ace0: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0001acf0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0001ad00: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0001ad10: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0001ad20: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0001ad30: 2020 7265 7475 726e 2067 676d 6c5f 6162    return ggml_ab
-0001ad40: 735f 696d 706c 2863 7478 2c20 612c 2074  s_impl(ctx, a, t
-0001ad50: 7275 6529 3b0a 7d0a 0a0a 2f2f 2067 676d  rue);.}...// ggm
-0001ad60: 6c5f 7367 6e0a 0a73 7472 7563 7420 6767  l_sgn..struct gg
-0001ad70: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-0001ad80: 5f73 676e 5f69 6d70 6c28 0a20 2020 2020  _sgn_impl(.     
-0001ad90: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001ada0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001adb0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001adc0: 6c5f 7465 6e73 6f72 202a 2061 2c0a 2020  l_tensor * a,.  
-0001add0: 2020 2020 2020 626f 6f6c 2069 6e70 6c61        bool inpla
-0001ade0: 6365 2920 7b0a 2020 2020 626f 6f6c 2069  ce) {.    bool i
-0001adf0: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-0001ae00: 0a20 2020 2069 6620 2821 696e 706c 6163  .    if (!inplac
-0001ae10: 6520 2626 2028 612d 3e67 7261 6429 2920  e && (a->grad)) 
-0001ae20: 7b0a 2020 2020 2020 2020 6973 5f6e 6f64  {.        is_nod
-0001ae30: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
-0001ae40: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-0001ae50: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
-0001ae60: 203d 2069 6e70 6c61 6365 203f 2067 676d   = inplace ? ggm
-0001ae70: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
-0001ae80: 782c 2061 2920 3a20 6767 6d6c 5f64 7570  x, a) : ggml_dup
-0001ae90: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
-0001aea0: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-0001aeb0: 2020 203d 2047 474d 4c5f 4f50 5f53 474e     = GGML_OP_SGN
-0001aec0: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-0001aed0: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-0001aee0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0001aef0: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-0001af00: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-0001af10: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-0001af20: 7375 6c74 2d3e 7372 6331 203d 204e 554c  sult->src1 = NUL
-0001af30: 4c3b 0a0a 2020 2020 7265 7475 726e 2072  L;..    return r
-0001af40: 6573 756c 743b 0a7d 0a0a 7374 7275 6374  esult;.}..struct
-0001af50: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001af60: 676d 6c5f 7367 6e28 0a20 2020 2020 2020  gml_sgn(.       
-0001af70: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-0001af80: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-0001af90: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001afa0: 7465 6e73 6f72 2020 2a20 6129 207b 0a20  tensor  * a) {. 
-0001afb0: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
-0001afc0: 676e 5f69 6d70 6c28 6374 782c 2061 2c20  gn_impl(ctx, a, 
-0001afd0: 6661 6c73 6529 3b0a 7d0a 0a73 7472 7563  false);.}..struc
-0001afe0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001aff0: 6767 6d6c 5f73 676e 5f69 6e70 6c61 6365  ggml_sgn_inplace
-0001b000: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0001b010: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0001b020: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0001b030: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001b040: 202a 2061 2920 7b0a 2020 2020 7265 7475   * a) {.    retu
-0001b050: 726e 2067 676d 6c5f 7367 6e5f 696d 706c  rn ggml_sgn_impl
-0001b060: 2863 7478 2c20 612c 2074 7275 6529 3b0a  (ctx, a, true);.
-0001b070: 7d0a 0a2f 2f20 6767 6d6c 5f6e 6567 0a0a  }..// ggml_neg..
-0001b080: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001b090: 6f72 202a 2067 676d 6c5f 6e65 675f 696d  or * ggml_neg_im
-0001b0a0: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
-0001b0b0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0001b0c0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0001b0d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001b0e0: 7220 2a20 612c 0a20 2020 2020 2020 2062  r * a,.        b
-0001b0f0: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
-0001b100: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-0001b110: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-0001b120: 2028 2169 6e70 6c61 6365 2026 2620 2861   (!inplace && (a
-0001b130: 2d3e 6772 6164 2929 207b 0a20 2020 2020  ->grad)) {.     
-0001b140: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-0001b150: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-0001b160: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001b170: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
-0001b180: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
-0001b190: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
-0001b1a0: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-0001b1b0: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-0001b1c0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-0001b1d0: 4d4c 5f4f 505f 4e45 473b 0a20 2020 2072  ML_OP_NEG;.    r
-0001b1e0: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-0001b1f0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-0001b200: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-0001b210: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-0001b220: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-0001b230: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-0001b240: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
-0001b250: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-0001b260: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
-0001b270: 656e 736f 7220 2a20 6767 6d6c 5f6e 6567  ensor * ggml_neg
-0001b280: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0001b290: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0001b2a0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0001b2b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001b2c0: 202a 2061 2920 7b0a 2020 2020 7265 7475   * a) {.    retu
-0001b2d0: 726e 2067 676d 6c5f 6e65 675f 696d 706c  rn ggml_neg_impl
-0001b2e0: 2863 7478 2c20 612c 2066 616c 7365 293b  (ctx, a, false);
-0001b2f0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-0001b300: 7465 6e73 6f72 202a 2067 676d 6c5f 6e65  tensor * ggml_ne
-0001b310: 675f 696e 706c 6163 6528 0a20 2020 2020  g_inplace(.     
-0001b320: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001b330: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001b340: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001b350: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
-0001b360: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-0001b370: 5f6e 6567 5f69 6d70 6c28 6374 782c 2061  _neg_impl(ctx, a
-0001b380: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
-0001b390: 676d 6c5f 7374 6570 0a0a 7374 7275 6374  gml_step..struct
-0001b3a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001b3b0: 676d 6c5f 7374 6570 5f69 6d70 6c28 0a20  gml_step_impl(. 
-0001b3c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001b3d0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001b3e0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001b3f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0001b400: 2c0a 2020 2020 2020 2020 626f 6f6c 2069  ,.        bool i
-0001b410: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-0001b420: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0001b430: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-0001b440: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
-0001b450: 6429 2920 7b0a 2020 2020 2020 2020 6973  d)) {.        is
-0001b460: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0001b470: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0001b480: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001b490: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0001b4a0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0001b4b0: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0001b4c0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0001b4d0: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-0001b4e0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0001b4f0: 5f53 5445 503b 0a20 2020 2072 6573 756c  _STEP;.    resul
-0001b500: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0001b510: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0001b520: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0001b530: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0001b540: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0001b550: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0001b560: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
-0001b570: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
-0001b580: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001b590: 7220 2a20 6767 6d6c 5f73 7465 7028 0a20  r * ggml_step(. 
-0001b5a0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001b5b0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001b5c0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001b5d0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001b5e0: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
-0001b5f0: 6767 6d6c 5f73 7465 705f 696d 706c 2863  ggml_step_impl(c
-0001b600: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
-0001b610: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001b620: 6e73 6f72 202a 2067 676d 6c5f 7374 6570  nsor * ggml_step
-0001b630: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
-0001b640: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-0001b650: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-0001b660: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001b670: 5f74 656e 736f 7220 202a 2061 2920 7b0a  _tensor  * a) {.
-0001b680: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-0001b690: 7374 6570 5f69 6d70 6c28 6374 782c 2061  step_impl(ctx, a
-0001b6a0: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
-0001b6b0: 676d 6c5f 7265 6c75 0a0a 7374 7275 6374  gml_relu..struct
-0001b6c0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001b6d0: 676d 6c5f 7265 6c75 5f69 6d70 6c28 0a20  gml_relu_impl(. 
-0001b6e0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001b6f0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00011960: 3c20 6e62 3b20 692b 2b29 207b 0a20 2020  < nb; i++) {.   
+00011970: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00011980: 2064 3020 3d20 785b 695d 2e64 3b0a 2020   d0 = x[i].d;.  
+00011990: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+000119a0: 7420 6431 203d 2079 5b69 5d2e 643b 0a0a  t d1 = y[i].d;..
+000119b0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+000119c0: 6f61 7420 6d30 203d 2078 5b69 5d2e 6d3b  oat m0 = x[i].m;
+000119d0: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
+000119e0: 6c6f 6174 206d 3120 3d20 795b 695d 2e6d  loat m1 = y[i].m
+000119f0: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
+00011a00: 2075 696e 7438 5f74 202a 2072 6573 7472   uint8_t * restr
+00011a10: 6963 7420 7030 203d 2078 5b69 5d2e 7173  ict p0 = x[i].qs
+00011a20: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+00011a30: 7569 6e74 385f 7420 2a20 7265 7374 7269  uint8_t * restri
+00011a40: 6374 2070 3120 3d20 795b 695d 2e71 733b  ct p1 = y[i].qs;
+00011a50: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+00011a60: 6e74 206a 203d 2030 3b20 6a20 3c20 514b  nt j = 0; j < QK
+00011a70: 2f32 3b20 6a2b 2b29 207b 0a20 2020 2020  /2; j++) {.     
+00011a80: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+00011a90: 7438 5f74 2076 3020 3d20 7030 5b6a 5d3b  t8_t v0 = p0[j];
+00011aa0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00011ab0: 7374 2075 696e 7438 5f74 2076 3120 3d20  st uint8_t v1 = 
+00011ac0: 7031 5b6a 5d3b 0a0a 2020 2020 2020 2020  p1[j];..        
+00011ad0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00011ae0: 6630 203d 2064 302a 2876 3020 2620 3078  f0 = d0*(v0 & 0x
+00011af0: 6629 202b 206d 303b 0a20 2020 2020 2020  f) + m0;.       
+00011b00: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00011b10: 2066 3120 3d20 6430 2a28 7630 203e 3e20   f1 = d0*(v0 >> 
+00011b20: 3429 2020 2b20 6d30 3b0a 0a20 2020 2020  4)  + m0;..     
+00011b30: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+00011b40: 6174 2066 3220 3d20 6431 2a28 7631 2026  at f2 = d1*(v1 &
+00011b50: 2030 7866 2920 2b20 6d31 3b0a 2020 2020   0xf) + m1;.    
+00011b60: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00011b70: 6f61 7420 6633 203d 2064 312a 2876 3120  oat f3 = d1*(v1 
+00011b80: 3e3e 2034 2920 202b 206d 313b 0a0a 2020  >> 4)  + m1;..  
+00011b90: 2020 2020 2020 2020 2020 7375 6d66 202b            sumf +
+00011ba0: 3d20 6630 2a66 3220 2b20 6631 2a66 333b  = f0*f2 + f1*f3;
+00011bb0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00011bc0: 0a23 656e 6469 660a 0a20 2020 202a 7320  .#endif..    *s 
+00011bd0: 3d20 7375 6d66 3b0a 7d0a 0a2f 2f20 636f  = sumf;.}..// co
+00011be0: 6d70 7574 6520 4747 4d4c 5f56 4543 5f44  mpute GGML_VEC_D
+00011bf0: 4f54 5f55 4e52 4f4c 4c20 646f 7420 7072  OT_UNROLL dot pr
+00011c00: 6f64 7563 7473 2061 7420 6f6e 6365 0a2f  oducts at once./
+00011c10: 2f20 7873 202d 2078 2072 6f77 2073 7472  / xs - x row str
+00011c20: 6964 6520 696e 2062 7974 6573 0a69 6e6c  ide in bytes.inl
+00011c30: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
+00011c40: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3136  ggml_vec_dot_f16
+00011c50: 5f75 6e72 6f6c 6c28 636f 6e73 7420 696e  _unroll(const in
+00011c60: 7420 6e2c 2063 6f6e 7374 2069 6e74 2078  t n, const int x
+00011c70: 732c 2066 6c6f 6174 202a 2072 6573 7472  s, float * restr
+00011c80: 6963 7420 732c 2076 6f69 6420 2a20 7265  ict s, void * re
+00011c90: 7374 7269 6374 2078 762c 2067 676d 6c5f  strict xv, ggml_
+00011ca0: 6670 3136 5f74 202a 2072 6573 7472 6963  fp16_t * restric
+00011cb0: 7420 7929 207b 0a20 2020 2067 676d 6c5f  t y) {.    ggml_
+00011cc0: 666c 6f61 7420 7375 6d66 5b47 474d 4c5f  float sumf[GGML_
+00011cd0: 5645 435f 444f 545f 554e 524f 4c4c 5d20  VEC_DOT_UNROLL] 
+00011ce0: 3d20 7b20 302e 3020 7d3b 0a0a 2020 2020  = { 0.0 };..    
+00011cf0: 6767 6d6c 5f66 7031 365f 7420 2a20 7265  ggml_fp16_t * re
+00011d00: 7374 7269 6374 2078 5b47 474d 4c5f 5645  strict x[GGML_VE
+00011d10: 435f 444f 545f 554e 524f 4c4c 5d3b 0a0a  C_DOT_UNROLL];..
+00011d20: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00011d30: 2030 3b20 6920 3c20 4747 4d4c 5f56 4543   0; i < GGML_VEC
+00011d40: 5f44 4f54 5f55 4e52 4f4c 4c3b 202b 2b69  _DOT_UNROLL; ++i
+00011d50: 2920 7b0a 2020 2020 2020 2020 785b 695d  ) {.        x[i]
+00011d60: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
+00011d70: 2a29 2028 2863 6861 7220 2a29 2078 7620  *) ((char *) xv 
+00011d80: 2b20 692a 7873 293b 0a20 2020 207d 0a0a  + i*xs);.    }..
+00011d90: 2369 6620 6465 6669 6e65 6428 4747 4d4c  #if defined(GGML
+00011da0: 5f53 494d 4429 0a20 2020 2063 6f6e 7374  _SIMD).    const
+00011db0: 2069 6e74 206e 7020 3d20 286e 2026 207e   int np = (n & ~
+00011dc0: 2847 474d 4c5f 4631 365f 5354 4550 202d  (GGML_F16_STEP -
+00011dd0: 2031 2929 3b0a 0a20 2020 2047 474d 4c5f   1));..    GGML_
+00011de0: 4631 365f 5645 4320 7375 6d5b 4747 4d4c  F16_VEC sum[GGML
+00011df0: 5f56 4543 5f44 4f54 5f55 4e52 4f4c 4c5d  _VEC_DOT_UNROLL]
+00011e00: 5b47 474d 4c5f 4631 365f 4152 525d 203d  [GGML_F16_ARR] =
+00011e10: 207b 207b 2047 474d 4c5f 4631 365f 5645   { { GGML_F16_VE
+00011e20: 435f 5a45 524f 207d 207d 3b0a 0a20 2020  C_ZERO } };..   
+00011e30: 2047 474d 4c5f 4631 365f 5645 4320 6178   GGML_F16_VEC ax
+00011e40: 5b47 474d 4c5f 4631 365f 4152 525d 3b0a  [GGML_F16_ARR];.
+00011e50: 2020 2020 4747 4d4c 5f46 3136 5f56 4543      GGML_F16_VEC
+00011e60: 2061 795b 4747 4d4c 5f46 3136 5f41 5252   ay[GGML_F16_ARR
+00011e70: 5d3b 0a0a 2020 2020 666f 7220 2869 6e74  ];..    for (int
+00011e80: 2069 203d 2030 3b20 6920 3c20 6e70 3b20   i = 0; i < np; 
+00011e90: 6920 2b3d 2047 474d 4c5f 4631 365f 5354  i += GGML_F16_ST
+00011ea0: 4550 2920 7b0a 2020 2020 2020 2020 666f  EP) {.        fo
+00011eb0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+00011ec0: 3c20 4747 4d4c 5f46 3136 5f41 5252 3b20  < GGML_F16_ARR; 
+00011ed0: 6a2b 2b29 207b 0a20 2020 2020 2020 2020  j++) {.         
+00011ee0: 2020 2061 795b 6a5d 203d 2047 474d 4c5f     ay[j] = GGML_
+00011ef0: 4631 365f 5645 435f 4c4f 4144 2879 202b  F16_VEC_LOAD(y +
+00011f00: 2069 202b 206a 2a47 474d 4c5f 4631 365f   i + j*GGML_F16_
+00011f10: 4550 522c 206a 293b 0a0a 2020 2020 2020  EPR, j);..      
+00011f20: 2020 2020 2020 666f 7220 2869 6e74 206b        for (int k
+00011f30: 203d 2030 3b20 6b20 3c20 4747 4d4c 5f56   = 0; k < GGML_V
+00011f40: 4543 5f44 4f54 5f55 4e52 4f4c 4c3b 202b  EC_DOT_UNROLL; +
+00011f50: 2b6b 2920 7b0a 2020 2020 2020 2020 2020  +k) {.          
+00011f60: 2020 2020 2020 6178 5b6a 5d20 3d20 4747        ax[j] = GG
+00011f70: 4d4c 5f46 3136 5f56 4543 5f4c 4f41 4428  ML_F16_VEC_LOAD(
+00011f80: 785b 6b5d 202b 2069 202b 206a 2a47 474d  x[k] + i + j*GGM
+00011f90: 4c5f 4631 365f 4550 522c 206a 293b 0a0a  L_F16_EPR, j);..
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011fb0: 7375 6d5b 6b5d 5b6a 5d20 3d20 4747 4d4c  sum[k][j] = GGML
+00011fc0: 5f46 3136 5f56 4543 5f46 4d41 2873 756d  _F16_VEC_FMA(sum
+00011fd0: 5b6b 5d5b 6a5d 2c20 6178 5b6a 5d2c 2061  [k][j], ax[j], a
+00011fe0: 795b 6a5d 293b 0a20 2020 2020 2020 2020  y[j]);.         
+00011ff0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+00012000: 2020 207d 0a0a 2020 2020 2f2f 2072 6564     }..    // red
+00012010: 7563 6520 7375 6d30 2e2e 7375 6d33 2074  uce sum0..sum3 t
+00012020: 6f20 7375 6d30 0a20 2020 2066 6f72 2028  o sum0.    for (
+00012030: 696e 7420 6b20 3d20 303b 206b 203c 2047  int k = 0; k < G
+00012040: 474d 4c5f 5645 435f 444f 545f 554e 524f  GML_VEC_DOT_UNRO
+00012050: 4c4c 3b20 2b2b 6b29 207b 0a20 2020 2020  LL; ++k) {.     
+00012060: 2020 2047 474d 4c5f 4631 365f 5645 435f     GGML_F16_VEC_
+00012070: 5245 4455 4345 2873 756d 665b 6b5d 2c20  REDUCE(sumf[k], 
+00012080: 7375 6d5b 6b5d 293b 0a20 2020 207d 0a0a  sum[k]);.    }..
+00012090: 2020 2020 2f2f 206c 6566 746f 7665 7273      // leftovers
+000120a0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+000120b0: 3d20 6e70 3b20 6920 3c20 6e3b 202b 2b69  = np; i < n; ++i
+000120c0: 2920 7b0a 2020 2020 2020 2020 666f 7220  ) {.        for 
+000120d0: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
+000120e0: 4747 4d4c 5f56 4543 5f44 4f54 5f55 4e52  GGML_VEC_DOT_UNR
+000120f0: 4f4c 4c3b 202b 2b6a 2920 7b0a 2020 2020  OLL; ++j) {.    
+00012100: 2020 2020 2020 2020 7375 6d66 5b6a 5d20          sumf[j] 
+00012110: 2b3d 2028 6767 6d6c 5f66 6c6f 6174 2928  += (ggml_float)(
+00012120: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+00012130: 3228 785b 6a5d 5b69 5d29 2a47 474d 4c5f  2(x[j][i])*GGML_
+00012140: 4650 3136 5f54 4f5f 4650 3332 2879 5b69  FP16_TO_FP32(y[i
+00012150: 5d29 293b 0a20 2020 2020 2020 207d 0a20  ]));.        }. 
+00012160: 2020 207d 0a23 656c 7365 0a20 2020 2066     }.#else.    f
+00012170: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00012180: 203c 206e 3b20 2b2b 6929 207b 0a20 2020   < n; ++i) {.   
+00012190: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+000121a0: 3d20 303b 206a 203c 2047 474d 4c5f 5645  = 0; j < GGML_VE
+000121b0: 435f 444f 545f 554e 524f 4c4c 3b20 2b2b  C_DOT_UNROLL; ++
+000121c0: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+000121d0: 2073 756d 665b 6a5d 202b 3d20 2867 676d   sumf[j] += (ggm
+000121e0: 6c5f 666c 6f61 7429 2847 474d 4c5f 4650  l_float)(GGML_FP
+000121f0: 3136 5f54 4f5f 4650 3332 2878 5b6a 5d5b  16_TO_FP32(x[j][
+00012200: 695d 292a 4747 4d4c 5f46 5031 365f 544f  i])*GGML_FP16_TO
+00012210: 5f46 5033 3228 795b 695d 2929 3b0a 2020  _FP32(y[i]));.  
+00012220: 2020 2020 2020 7d0a 2020 2020 7d0a 2365        }.    }.#e
+00012230: 6e64 6966 0a0a 2020 2020 666f 7220 2869  ndif..    for (i
+00012240: 6e74 2069 203d 2030 3b20 6920 3c20 4747  nt i = 0; i < GG
+00012250: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+00012260: 4c3b 202b 2b69 2920 7b0a 2020 2020 2020  L; ++i) {.      
+00012270: 2020 735b 695d 203d 2073 756d 665b 695d    s[i] = sumf[i]
+00012280: 3b0a 2020 2020 7d0a 7d0a 0a69 6e6c 696e  ;.    }.}..inlin
+00012290: 6520 7374 6174 6963 2076 6f69 6420 6767  e static void gg
+000122a0: 6d6c 5f76 6563 5f6d 6164 5f66 3332 2863  ml_vec_mad_f32(c
+000122b0: 6f6e 7374 2069 6e74 206e 2c20 666c 6f61  onst int n, floa
+000122c0: 7420 2a20 7265 7374 7269 6374 2079 2c20  t * restrict y, 
+000122d0: 636f 6e73 7420 666c 6f61 7420 2a20 7265  const float * re
+000122e0: 7374 7269 6374 2078 2c20 636f 6e73 7420  strict x, const 
+000122f0: 666c 6f61 7420 7629 207b 0a23 6966 2064  float v) {.#if d
+00012300: 6566 696e 6564 2847 474d 4c5f 5349 4d44  efined(GGML_SIMD
+00012310: 290a 2020 2020 636f 6e73 7420 696e 7420  ).    const int 
+00012320: 6e70 203d 2028 6e20 2620 7e28 4747 4d4c  np = (n & ~(GGML
+00012330: 5f46 3332 5f53 5445 5020 2d20 3129 293b  _F32_STEP - 1));
+00012340: 0a0a 2020 2020 4747 4d4c 5f46 3332 5f56  ..    GGML_F32_V
+00012350: 4543 2076 7820 3d20 4747 4d4c 5f46 3332  EC vx = GGML_F32
+00012360: 5f56 4543 5f53 4554 3128 7629 3b0a 0a20  _VEC_SET1(v);.. 
+00012370: 2020 2047 474d 4c5f 4633 325f 5645 4320     GGML_F32_VEC 
+00012380: 6178 5b47 474d 4c5f 4633 325f 4152 525d  ax[GGML_F32_ARR]
+00012390: 3b0a 2020 2020 4747 4d4c 5f46 3332 5f56  ;.    GGML_F32_V
+000123a0: 4543 2061 795b 4747 4d4c 5f46 3332 5f41  EC ay[GGML_F32_A
+000123b0: 5252 5d3b 0a0a 2020 2020 666f 7220 2869  RR];..    for (i
+000123c0: 6e74 2069 203d 2030 3b20 6920 3c20 6e70  nt i = 0; i < np
+000123d0: 3b20 6920 2b3d 2047 474d 4c5f 4633 325f  ; i += GGML_F32_
+000123e0: 5354 4550 2920 7b0a 2020 2020 2020 2020  STEP) {.        
+000123f0: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
+00012400: 6a20 3c20 4747 4d4c 5f46 3332 5f41 5252  j < GGML_F32_ARR
+00012410: 3b20 6a2b 2b29 207b 0a20 2020 2020 2020  ; j++) {.       
+00012420: 2020 2020 2061 785b 6a5d 203d 2047 474d       ax[j] = GGM
+00012430: 4c5f 4633 325f 5645 435f 4c4f 4144 2878  L_F32_VEC_LOAD(x
+00012440: 202b 2069 202b 206a 2a47 474d 4c5f 4633   + i + j*GGML_F3
+00012450: 325f 4550 5229 3b0a 2020 2020 2020 2020  2_EPR);.        
+00012460: 2020 2020 6179 5b6a 5d20 3d20 4747 4d4c      ay[j] = GGML
+00012470: 5f46 3332 5f56 4543 5f4c 4f41 4428 7920  _F32_VEC_LOAD(y 
+00012480: 2b20 6920 2b20 6a2a 4747 4d4c 5f46 3332  + i + j*GGML_F32
+00012490: 5f45 5052 293b 0a20 2020 2020 2020 2020  _EPR);.         
+000124a0: 2020 2061 795b 6a5d 203d 2047 474d 4c5f     ay[j] = GGML_
+000124b0: 4633 325f 5645 435f 464d 4128 6179 5b6a  F32_VEC_FMA(ay[j
+000124c0: 5d2c 2061 785b 6a5d 2c20 7678 293b 0a0a  ], ax[j], vx);..
+000124d0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000124e0: 5f46 3332 5f56 4543 5f53 544f 5245 2879  _F32_VEC_STORE(y
+000124f0: 202b 2069 202b 206a 2a47 474d 4c5f 4633   + i + j*GGML_F3
+00012500: 325f 4550 522c 2061 795b 6a5d 293b 0a20  2_EPR, ay[j]);. 
+00012510: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+00012520: 2020 2020 2f2f 206c 6566 746f 7665 7273      // leftovers
+00012530: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00012540: 3d20 6e70 3b20 6920 3c20 6e3b 202b 2b69  = np; i < n; ++i
+00012550: 2920 7b0a 2020 2020 2020 2020 795b 695d  ) {.        y[i]
+00012560: 202b 3d20 785b 695d 2a76 3b0a 2020 2020   += x[i]*v;.    
+00012570: 7d0a 2365 6c73 650a 2020 2020 2f2f 2073  }.#else.    // s
+00012580: 6361 6c61 720a 2020 2020 666f 7220 2869  calar.    for (i
+00012590: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
+000125a0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+000125b0: 795b 695d 202b 3d20 785b 695d 2a76 3b0a  y[i] += x[i]*v;.
+000125c0: 2020 2020 7d0a 2365 6e64 6966 0a7d 0a0a      }.#endif.}..
+000125d0: 2f2f 696e 6c69 6e65 2073 7461 7469 6320  //inline static 
+000125e0: 766f 6964 2067 676d 6c5f 7665 635f 7363  void ggml_vec_sc
+000125f0: 616c 655f 6633 3228 636f 6e73 7420 696e  ale_f32(const in
+00012600: 7420 6e2c 2066 6c6f 6174 202a 2079 2c20  t n, float * y, 
+00012610: 636f 6e73 7420 666c 6f61 7420 2020 7629  const float   v)
+00012620: 207b 2066 6f72 2028 696e 7420 6920 3d20   { for (int i = 
+00012630: 303b 2069 203c 206e 3b20 2b2b 6929 2079  0; i < n; ++i) y
+00012640: 5b69 5d20 2a3d 2076 3b20 2020 2020 2020  [i] *= v;       
+00012650: 2020 207d 0a69 6e6c 696e 6520 7374 6174     }.inline stat
+00012660: 6963 2076 6f69 6420 6767 6d6c 5f76 6563  ic void ggml_vec
+00012670: 5f73 6361 6c65 5f66 3332 2863 6f6e 7374  _scale_f32(const
+00012680: 2069 6e74 206e 2c20 666c 6f61 7420 2a20   int n, float * 
+00012690: 792c 2063 6f6e 7374 2066 6c6f 6174 2020  y, const float  
+000126a0: 2076 2920 7b0a 2369 6620 6465 6669 6e65   v) {.#if define
+000126b0: 6428 4747 4d4c 5f53 494d 4429 0a20 2020  d(GGML_SIMD).   
+000126c0: 2063 6f6e 7374 2069 6e74 206e 7020 3d20   const int np = 
+000126d0: 286e 2026 207e 2847 474d 4c5f 4633 325f  (n & ~(GGML_F32_
+000126e0: 5354 4550 202d 2031 2929 3b0a 0a20 2020  STEP - 1));..   
+000126f0: 2047 474d 4c5f 4633 325f 5645 4320 7678   GGML_F32_VEC vx
+00012700: 203d 2047 474d 4c5f 4633 325f 5645 435f   = GGML_F32_VEC_
+00012710: 5345 5431 2876 293b 0a0a 2020 2020 4747  SET1(v);..    GG
+00012720: 4d4c 5f46 3332 5f56 4543 2061 795b 4747  ML_F32_VEC ay[GG
+00012730: 4d4c 5f46 3332 5f41 5252 5d3b 0a0a 2020  ML_F32_ARR];..  
+00012740: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00012750: 3b20 6920 3c20 6e70 3b20 6920 2b3d 2047  ; i < np; i += G
+00012760: 474d 4c5f 4633 325f 5354 4550 2920 7b0a  GML_F32_STEP) {.
+00012770: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00012780: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
+00012790: 5f46 3332 5f41 5252 3b20 6a2b 2b29 207b  _F32_ARR; j++) {
+000127a0: 0a20 2020 2020 2020 2020 2020 2061 795b  .            ay[
+000127b0: 6a5d 203d 2047 474d 4c5f 4633 325f 5645  j] = GGML_F32_VE
+000127c0: 435f 4c4f 4144 2879 202b 2069 202b 206a  C_LOAD(y + i + j
+000127d0: 2a47 474d 4c5f 4633 325f 4550 5229 3b0a  *GGML_F32_EPR);.
+000127e0: 2020 2020 2020 2020 2020 2020 6179 5b6a              ay[j
+000127f0: 5d20 3d20 4747 4d4c 5f46 3332 5f56 4543  ] = GGML_F32_VEC
+00012800: 5f4d 554c 2861 795b 6a5d 2c20 7678 293b  _MUL(ay[j], vx);
+00012810: 0a0a 2020 2020 2020 2020 2020 2020 4747  ..            GG
+00012820: 4d4c 5f46 3332 5f56 4543 5f53 544f 5245  ML_F32_VEC_STORE
+00012830: 2879 202b 2069 202b 206a 2a47 474d 4c5f  (y + i + j*GGML_
+00012840: 4633 325f 4550 522c 2061 795b 6a5d 293b  F32_EPR, ay[j]);
+00012850: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00012860: 0a0a 2020 2020 2f2f 206c 6566 746f 7665  ..    // leftove
+00012870: 7273 0a20 2020 2066 6f72 2028 696e 7420  rs.    for (int 
+00012880: 6920 3d20 6e70 3b20 6920 3c20 6e3b 202b  i = np; i < n; +
+00012890: 2b69 2920 7b0a 2020 2020 2020 2020 795b  +i) {.        y[
+000128a0: 695d 202a 3d20 763b 0a20 2020 207d 0a23  i] *= v;.    }.#
+000128b0: 656c 7365 0a20 2020 202f 2f20 7363 616c  else.    // scal
+000128c0: 6172 0a20 2020 2066 6f72 2028 696e 7420  ar.    for (int 
+000128d0: 6920 3d20 303b 2069 203c 206e 3b20 2b2b  i = 0; i < n; ++
+000128e0: 6929 207b 0a20 2020 2020 2020 2079 5b69  i) {.        y[i
+000128f0: 5d20 2a3d 2076 3b0a 2020 2020 7d0a 2365  ] *= v;.    }.#e
+00012900: 6e64 6966 0a7d 0a0a 696e 6c69 6e65 2073  ndif.}..inline s
+00012910: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00012920: 7665 635f 6e6f 726d 5f66 3332 2028 636f  vec_norm_f32 (co
+00012930: 6e73 7420 696e 7420 6e2c 2066 6c6f 6174  nst int n, float
+00012940: 202a 2073 2c20 636f 6e73 7420 666c 6f61   * s, const floa
+00012950: 7420 2a20 7829 207b 2067 676d 6c5f 7665  t * x) { ggml_ve
+00012960: 635f 646f 745f 6633 3228 6e2c 2073 2c20  c_dot_f32(n, s, 
+00012970: 782c 2078 293b 202a 7320 3d20 7371 7274  x, x); *s = sqrt
+00012980: 6628 2a73 293b 2020 207d 0a69 6e6c 696e  f(*s);   }.inlin
+00012990: 6520 7374 6174 6963 2076 6f69 6420 6767  e static void gg
+000129a0: 6d6c 5f76 6563 5f73 7172 5f66 3332 2020  ml_vec_sqr_f32  
+000129b0: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
+000129c0: 6f61 7420 2a20 792c 2063 6f6e 7374 2066  oat * y, const f
+000129d0: 6c6f 6174 202a 2078 2920 7b20 666f 7220  loat * x) { for 
+000129e0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000129f0: 6e3b 202b 2b69 2920 795b 695d 203d 2078  n; ++i) y[i] = x
+00012a00: 5b69 5d2a 785b 695d 3b20 2020 7d0a 696e  [i]*x[i];   }.in
+00012a10: 6c69 6e65 2073 7461 7469 6320 766f 6964  line static void
+00012a20: 2067 676d 6c5f 7665 635f 7371 7274 5f66   ggml_vec_sqrt_f
+00012a30: 3332 2028 636f 6e73 7420 696e 7420 6e2c  32 (const int n,
+00012a40: 2066 6c6f 6174 202a 2079 2c20 636f 6e73   float * y, cons
+00012a50: 7420 666c 6f61 7420 2a20 7829 207b 2066  t float * x) { f
+00012a60: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00012a70: 203c 206e 3b20 2b2b 6929 2079 5b69 5d20   < n; ++i) y[i] 
+00012a80: 3d20 7371 7274 6628 785b 695d 293b 207d  = sqrtf(x[i]); }
+00012a90: 0a69 6e6c 696e 6520 7374 6174 6963 2076  .inline static v
+00012aa0: 6f69 6420 6767 6d6c 5f76 6563 5f61 6273  oid ggml_vec_abs
+00012ab0: 5f66 3332 2020 2863 6f6e 7374 2069 6e74  _f32  (const int
+00012ac0: 206e 2c20 666c 6f61 7420 2a20 792c 2063   n, float * y, c
+00012ad0: 6f6e 7374 2066 6c6f 6174 202a 2078 2920  onst float * x) 
+00012ae0: 7b20 666f 7220 2869 6e74 2069 203d 2030  { for (int i = 0
+00012af0: 3b20 6920 3c20 6e3b 202b 2b69 2920 795b  ; i < n; ++i) y[
+00012b00: 695d 203d 2066 6162 7366 2878 5b69 5d29  i] = fabsf(x[i])
+00012b10: 3b20 7d0a 696e 6c69 6e65 2073 7461 7469  ; }.inline stati
+00012b20: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
+00012b30: 7367 6e5f 6633 3220 2028 636f 6e73 7420  sgn_f32  (const 
+00012b40: 696e 7420 6e2c 2066 6c6f 6174 202a 2079  int n, float * y
+00012b50: 2c20 636f 6e73 7420 666c 6f61 7420 2a20  , const float * 
+00012b60: 7829 207b 2066 6f72 2028 696e 7420 6920  x) { for (int i 
+00012b70: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
+00012b80: 2079 5b69 5d20 3d20 2878 5b69 5d20 3e20   y[i] = (x[i] > 
+00012b90: 302e 6629 203f 2031 2e66 203a 2028 2878  0.f) ? 1.f : ((x
+00012ba0: 5b69 5d20 3c20 302e 6629 203f 202d 312e  [i] < 0.f) ? -1.
+00012bb0: 6620 3a20 302e 6629 3b20 7d0a 696e 6c69  f : 0.f); }.inli
+00012bc0: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
+00012bd0: 676d 6c5f 7665 635f 7374 6570 5f66 3332  gml_vec_step_f32
+00012be0: 2028 636f 6e73 7420 696e 7420 6e2c 2066   (const int n, f
+00012bf0: 6c6f 6174 202a 2079 2c20 636f 6e73 7420  loat * y, const 
+00012c00: 666c 6f61 7420 2a20 7829 207b 2066 6f72  float * x) { for
+00012c10: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00012c20: 206e 3b20 2b2b 6929 2079 5b69 5d20 3d20   n; ++i) y[i] = 
+00012c30: 2878 5b69 5d20 3e20 302e 6629 203f 2031  (x[i] > 0.f) ? 1
+00012c40: 2e66 203a 2030 2e66 3b20 7d0a 696e 6c69  .f : 0.f; }.inli
+00012c50: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
+00012c60: 676d 6c5f 7665 635f 7265 6c75 5f66 3332  gml_vec_relu_f32
+00012c70: 2028 636f 6e73 7420 696e 7420 6e2c 2066   (const int n, f
+00012c80: 6c6f 6174 202a 2079 2c20 636f 6e73 7420  loat * y, const 
+00012c90: 666c 6f61 7420 2a20 7829 207b 2066 6f72  float * x) { for
+00012ca0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00012cb0: 206e 3b20 2b2b 6929 2079 5b69 5d20 3d20   n; ++i) y[i] = 
+00012cc0: 2878 5b69 5d20 3e20 302e 6629 203f 2078  (x[i] > 0.f) ? x
+00012cd0: 5b69 5d20 3a20 302e 663b 207d 0a0a 7374  [i] : 0.f; }..st
+00012ce0: 6174 6963 2063 6f6e 7374 2066 6c6f 6174  atic const float
+00012cf0: 2047 454c 555f 434f 4546 5f41 2020 2020   GELU_COEF_A    
+00012d00: 3d20 302e 3034 3437 3135 663b 0a73 7461  = 0.044715f;.sta
+00012d10: 7469 6320 636f 6e73 7420 666c 6f61 7420  tic const float 
+00012d20: 5351 5254 5f32 5f4f 5645 525f 5049 203d  SQRT_2_OVER_PI =
+00012d30: 2030 2e37 3937 3838 3435 3630 3830 3238   0.7978845608028
+00012d40: 3635 3335 3538 3739 3839 3231 3139 3836  6535587989211986
+00012d50: 3837 3666 3b0a 0a69 6e6c 696e 6520 7374  876f;..inline st
+00012d60: 6174 6963 2066 6c6f 6174 2067 676d 6c5f  atic float ggml_
+00012d70: 6765 6c75 5f66 3332 2866 6c6f 6174 2078  gelu_f32(float x
+00012d80: 2920 7b0a 2020 2020 7265 7475 726e 2030  ) {.    return 0
+00012d90: 2e35 662a 782a 2831 2e30 6620 2b20 7461  .5f*x*(1.0f + ta
+00012da0: 6e68 6628 5351 5254 5f32 5f4f 5645 525f  nhf(SQRT_2_OVER_
+00012db0: 5049 2a78 2a28 312e 3066 202b 2047 454c  PI*x*(1.0f + GEL
+00012dc0: 555f 434f 4546 5f41 2a78 2a78 2929 293b  U_COEF_A*x*x)));
+00012dd0: 0a7d 0a0a 696e 6c69 6e65 2073 7461 7469  .}..inline stati
+00012de0: 6320 766f 6964 2067 676d 6c5f 7665 635f  c void ggml_vec_
+00012df0: 6765 6c75 5f66 3136 2863 6f6e 7374 2069  gelu_f16(const i
+00012e00: 6e74 206e 2c20 6767 6d6c 5f66 7031 365f  nt n, ggml_fp16_
+00012e10: 7420 2a20 792c 2063 6f6e 7374 2067 676d  t * y, const ggm
+00012e20: 6c5f 6670 3136 5f74 202a 2078 2920 7b0a  l_fp16_t * x) {.
+00012e30: 2020 2020 636f 6e73 7420 7569 6e74 3136      const uint16
+00012e40: 5f74 202a 2069 3136 203d 2028 636f 6e73  _t * i16 = (cons
+00012e50: 7420 7569 6e74 3136 5f74 202a 2920 783b  t uint16_t *) x;
+00012e60: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00012e70: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
+00012e80: 207b 0a20 2020 2020 2020 2079 5b69 5d20   {.        y[i] 
+00012e90: 3d20 7461 626c 655f 6765 6c75 5f66 3136  = table_gelu_f16
+00012ea0: 5b69 3136 5b69 5d5d 3b0a 2020 2020 7d0a  [i16[i]];.    }.
+00012eb0: 7d0a 0a23 6966 6465 6620 4747 4d4c 5f47  }..#ifdef GGML_G
+00012ec0: 454c 555f 4650 3136 0a69 6e6c 696e 6520  ELU_FP16.inline 
+00012ed0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00012ee0: 5f76 6563 5f67 656c 755f 6633 3228 636f  _vec_gelu_f32(co
+00012ef0: 6e73 7420 696e 7420 6e2c 2066 6c6f 6174  nst int n, float
+00012f00: 202a 2079 2c20 636f 6e73 7420 666c 6f61   * y, const floa
+00012f10: 7420 2a20 7829 207b 0a20 2020 2075 696e  t * x) {.    uin
+00012f20: 7431 365f 7420 743b 0a20 2020 2066 6f72  t16_t t;.    for
+00012f30: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00012f40: 206e 3b20 2b2b 6929 207b 0a20 2020 2020   n; ++i) {.     
+00012f50: 2020 2067 676d 6c5f 6670 3136 5f74 2066     ggml_fp16_t f
+00012f60: 7031 3620 3d20 4747 4d4c 5f46 5033 325f  p16 = GGML_FP32_
+00012f70: 544f 5f46 5031 3628 785b 695d 293b 0a20  TO_FP16(x[i]);. 
+00012f80: 2020 2020 2020 206d 656d 6370 7928 2674         memcpy(&t
+00012f90: 2c20 2666 7031 362c 2073 697a 656f 6628  , &fp16, sizeof(
+00012fa0: 7569 6e74 3136 5f74 2929 3b0a 2020 2020  uint16_t));.    
+00012fb0: 2020 2020 795b 695d 203d 2047 474d 4c5f      y[i] = GGML_
+00012fc0: 4650 3136 5f54 4f5f 4650 3332 2874 6162  FP16_TO_FP32(tab
+00012fd0: 6c65 5f67 656c 755f 6631 365b 745d 293b  le_gelu_f16[t]);
+00012fe0: 0a20 2020 207d 0a7d 0a23 656c 7365 0a69  .    }.}.#else.i
+00012ff0: 6e6c 696e 6520 7374 6174 6963 2076 6f69  nline static voi
+00013000: 6420 6767 6d6c 5f76 6563 5f67 656c 755f  d ggml_vec_gelu_
+00013010: 6633 3228 636f 6e73 7420 696e 7420 6e2c  f32(const int n,
+00013020: 2066 6c6f 6174 202a 2079 2c20 636f 6e73   float * y, cons
+00013030: 7420 666c 6f61 7420 2a20 7829 207b 0a20  t float * x) {. 
+00013040: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00013050: 303b 2069 203c 206e 3b20 2b2b 6929 207b  0; i < n; ++i) {
+00013060: 0a20 2020 2020 2020 2079 5b69 5d20 3d20  .        y[i] = 
+00013070: 6767 6d6c 5f67 656c 755f 6633 3228 785b  ggml_gelu_f32(x[
+00013080: 695d 293b 0a20 2020 207d 0a7d 0a23 656e  i]);.    }.}.#en
+00013090: 6469 660a 0a2f 2f20 5369 676d 6f69 6420  dif..// Sigmoid 
+000130a0: 4c69 6e65 6172 2055 6e69 7420 2853 694c  Linear Unit (SiL
+000130b0: 5529 2066 756e 6374 696f 6e0a 696e 6c69  U) function.inli
+000130c0: 6e65 2073 7461 7469 6320 666c 6f61 7420  ne static float 
+000130d0: 6767 6d6c 5f73 696c 755f 6633 3228 666c  ggml_silu_f32(fl
+000130e0: 6f61 7420 7829 207b 0a20 2020 2072 6574  oat x) {.    ret
+000130f0: 7572 6e20 782f 2831 2e30 6620 2b20 6578  urn x/(1.0f + ex
+00013100: 7066 282d 7829 293b 0a7d 0a0a 696e 6c69  pf(-x));.}..inli
+00013110: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
+00013120: 676d 6c5f 7665 635f 7369 6c75 5f66 3136  gml_vec_silu_f16
+00013130: 2863 6f6e 7374 2069 6e74 206e 2c20 6767  (const int n, gg
+00013140: 6d6c 5f66 7031 365f 7420 2a20 792c 2063  ml_fp16_t * y, c
+00013150: 6f6e 7374 2067 676d 6c5f 6670 3136 5f74  onst ggml_fp16_t
+00013160: 202a 2078 2920 7b0a 2020 2020 636f 6e73   * x) {.    cons
+00013170: 7420 7569 6e74 3136 5f74 202a 2069 3136  t uint16_t * i16
+00013180: 203d 2028 636f 6e73 7420 7569 6e74 3136   = (const uint16
+00013190: 5f74 202a 2920 783b 0a20 2020 2066 6f72  _t *) x;.    for
+000131a0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+000131b0: 206e 3b20 2b2b 6929 207b 0a20 2020 2020   n; ++i) {.     
+000131c0: 2020 2079 5b69 5d20 3d20 7461 626c 655f     y[i] = table_
+000131d0: 7369 6c75 5f66 3136 5b69 3136 5b69 5d5d  silu_f16[i16[i]]
+000131e0: 3b0a 2020 2020 7d0a 7d0a 0a23 6966 6465  ;.    }.}..#ifde
+000131f0: 6620 4747 4d4c 5f53 494c 555f 4650 3136  f GGML_SILU_FP16
+00013200: 0a69 6e6c 696e 6520 7374 6174 6963 2076  .inline static v
+00013210: 6f69 6420 6767 6d6c 5f76 6563 5f73 696c  oid ggml_vec_sil
+00013220: 755f 6633 3228 636f 6e73 7420 696e 7420  u_f32(const int 
+00013230: 6e2c 2066 6c6f 6174 202a 2079 2c20 636f  n, float * y, co
+00013240: 6e73 7420 666c 6f61 7420 2a20 7829 207b  nst float * x) {
+00013250: 0a20 2020 2075 696e 7431 365f 7420 743b  .    uint16_t t;
+00013260: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00013270: 3d20 303b 2069 203c 206e 3b20 2b2b 6929  = 0; i < n; ++i)
+00013280: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
+00013290: 6670 3136 5f74 2066 7031 3620 3d20 4747  fp16_t fp16 = GG
+000132a0: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+000132b0: 785b 695d 293b 0a20 2020 2020 2020 206d  x[i]);.        m
+000132c0: 656d 6370 7928 2674 2c20 2666 7031 362c  emcpy(&t, &fp16,
+000132d0: 2073 697a 656f 6628 7569 6e74 3136 5f74   sizeof(uint16_t
+000132e0: 2929 3b0a 2020 2020 2020 2020 795b 695d  ));.        y[i]
+000132f0: 203d 2047 474d 4c5f 4650 3136 5f54 4f5f   = GGML_FP16_TO_
+00013300: 4650 3332 2874 6162 6c65 5f73 696c 755f  FP32(table_silu_
+00013310: 6631 365b 745d 293b 0a20 2020 207d 0a7d  f16[t]);.    }.}
+00013320: 0a23 656c 7365 0a69 6e6c 696e 6520 7374  .#else.inline st
+00013330: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
+00013340: 6563 5f73 696c 755f 6633 3228 636f 6e73  ec_silu_f32(cons
+00013350: 7420 696e 7420 6e2c 2066 6c6f 6174 202a  t int n, float *
+00013360: 2079 2c20 636f 6e73 7420 666c 6f61 7420   y, const float 
+00013370: 2a20 7829 207b 0a20 2020 2066 6f72 2028  * x) {.    for (
+00013380: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00013390: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+000133a0: 2079 5b69 5d20 3d20 6767 6d6c 5f73 696c   y[i] = ggml_sil
+000133b0: 755f 6633 3228 785b 695d 293b 0a20 2020  u_f32(x[i]);.   
+000133c0: 207d 0a7d 0a23 656e 6469 660a 0a69 6e6c   }.}.#endif..inl
+000133d0: 696e 6520 7374 6174 6963 2076 6f69 6420  ine static void 
+000133e0: 6767 6d6c 5f76 6563 5f73 756d 5f66 3332  ggml_vec_sum_f32
+000133f0: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
+00013400: 6f61 7420 2a20 732c 2063 6f6e 7374 2066  oat * s, const f
+00013410: 6c6f 6174 202a 2078 2920 7b0a 2369 666e  loat * x) {.#ifn
+00013420: 6465 6620 4747 4d4c 5f55 5345 5f41 4343  def GGML_USE_ACC
+00013430: 454c 4552 4154 450a 2020 2020 6767 6d6c  ELERATE.    ggml
+00013440: 5f66 6c6f 6174 2073 756d 203d 2030 2e30  _float sum = 0.0
+00013450: 3b0a 2020 2020 666f 7220 2869 6e74 2069  ;.    for (int i
+00013460: 203d 2030 3b20 6920 3c20 6e3b 202b 2b69   = 0; i < n; ++i
+00013470: 2920 7b0a 2020 2020 2020 2020 7375 6d20  ) {.        sum 
+00013480: 2b3d 2028 6767 6d6c 5f66 6c6f 6174 2978  += (ggml_float)x
+00013490: 5b69 5d3b 0a20 2020 207d 0a20 2020 202a  [i];.    }.    *
+000134a0: 7320 3d20 7375 6d3b 0a23 656c 7365 0a20  s = sum;.#else. 
+000134b0: 2020 2076 4453 505f 7376 6528 782c 2031     vDSP_sve(x, 1
+000134c0: 2c20 732c 206e 293b 0a23 656e 6469 660a  , s, n);.#endif.
+000134d0: 7d0a 0a69 6e6c 696e 6520 7374 6174 6963  }..inline static
+000134e0: 2076 6f69 6420 6767 6d6c 5f76 6563 5f6d   void ggml_vec_m
+000134f0: 6178 5f66 3332 2863 6f6e 7374 2069 6e74  ax_f32(const int
+00013500: 206e 2c20 666c 6f61 7420 2a20 732c 2063   n, float * s, c
+00013510: 6f6e 7374 2066 6c6f 6174 202a 2078 2920  onst float * x) 
+00013520: 7b0a 2369 666e 6465 6620 4747 4d4c 5f55  {.#ifndef GGML_U
+00013530: 5345 5f41 4343 454c 4552 4154 450a 2020  SE_ACCELERATE.  
+00013540: 2020 666c 6f61 7420 6d61 7820 3d20 2d49    float max = -I
+00013550: 4e46 494e 4954 593b 0a20 2020 2066 6f72  NFINITY;.    for
+00013560: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00013570: 206e 3b20 2b2b 6929 207b 0a20 2020 2020   n; ++i) {.     
+00013580: 2020 206d 6178 203d 204d 4158 286d 6178     max = MAX(max
+00013590: 2c20 785b 695d 293b 0a20 2020 207d 0a20  , x[i]);.    }. 
+000135a0: 2020 202a 7320 3d20 6d61 783b 0a23 656c     *s = max;.#el
+000135b0: 7365 0a20 2020 2076 4453 505f 6d61 7876  se.    vDSP_maxv
+000135c0: 2878 2c20 312c 2073 2c20 6e29 3b0a 2365  (x, 1, s, n);.#e
+000135d0: 6e64 6966 0a7d 0a0a 696e 6c69 6e65 2073  ndif.}..inline s
+000135e0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+000135f0: 7665 635f 6e6f 726d 5f69 6e76 5f66 3332  vec_norm_inv_f32
+00013600: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
+00013610: 6f61 7420 2a20 732c 2063 6f6e 7374 2066  oat * s, const f
+00013620: 6c6f 6174 202a 2078 2920 7b0a 2020 2020  loat * x) {.    
+00013630: 6767 6d6c 5f76 6563 5f6e 6f72 6d5f 6633  ggml_vec_norm_f3
+00013640: 3228 6e2c 2073 2c20 7829 3b0a 2020 2020  2(n, s, x);.    
+00013650: 2a73 203d 2031 2e66 2f28 2a73 293b 0a7d  *s = 1.f/(*s);.}
+00013660: 0a0a 2f2f 0a2f 2f20 6c6f 6767 696e 670a  ..//.// logging.
+00013670: 2f2f 0a0a 2369 6620 2847 474d 4c5f 4445  //..#if (GGML_DE
+00013680: 4255 4720 3e3d 2031 290a 2364 6566 696e  BUG >= 1).#defin
+00013690: 6520 4747 4d4c 5f50 5249 4e54 5f44 4542  e GGML_PRINT_DEB
+000136a0: 5547 282e 2e2e 2920 7072 696e 7466 285f  UG(...) printf(_
+000136b0: 5f56 415f 4152 4753 5f5f 290a 2365 6c73  _VA_ARGS__).#els
+000136c0: 650a 2364 6566 696e 6520 4747 4d4c 5f50  e.#define GGML_P
+000136d0: 5249 4e54 5f44 4542 5547 282e 2e2e 290a  RINT_DEBUG(...).
+000136e0: 2365 6e64 6966 0a0a 2369 6620 2847 474d  #endif..#if (GGM
+000136f0: 4c5f 4445 4255 4720 3e3d 2035 290a 2364  L_DEBUG >= 5).#d
+00013700: 6566 696e 6520 4747 4d4c 5f50 5249 4e54  efine GGML_PRINT
+00013710: 5f44 4542 5547 5f35 282e 2e2e 2920 7072  _DEBUG_5(...) pr
+00013720: 696e 7466 285f 5f56 415f 4152 4753 5f5f  intf(__VA_ARGS__
+00013730: 290a 2365 6c73 650a 2364 6566 696e 6520  ).#else.#define 
+00013740: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00013750: 5f35 282e 2e2e 290a 2365 6e64 6966 0a0a  _5(...).#endif..
+00013760: 2369 6620 2847 474d 4c5f 4445 4255 4720  #if (GGML_DEBUG 
+00013770: 3e3d 2031 3029 0a23 6465 6669 6e65 2047  >= 10).#define G
+00013780: 474d 4c5f 5052 494e 545f 4445 4255 475f  GML_PRINT_DEBUG_
+00013790: 3130 282e 2e2e 2920 7072 696e 7466 285f  10(...) printf(_
+000137a0: 5f56 415f 4152 4753 5f5f 290a 2365 6c73  _VA_ARGS__).#els
+000137b0: 650a 2364 6566 696e 6520 4747 4d4c 5f50  e.#define GGML_P
+000137c0: 5249 4e54 5f44 4542 5547 5f31 3028 2e2e  RINT_DEBUG_10(..
+000137d0: 2e29 0a23 656e 6469 660a 0a23 6465 6669  .).#endif..#defi
+000137e0: 6e65 2047 474d 4c5f 5052 494e 5428 2e2e  ne GGML_PRINT(..
+000137f0: 2e29 2070 7269 6e74 6628 5f5f 5641 5f41  .) printf(__VA_A
+00013800: 5247 535f 5f29 0a0a 2f2f 0a2f 2f20 6461  RGS__)..//.// da
+00013810: 7461 2074 7970 6573 0a2f 2f0a 0a73 7461  ta types.//..sta
+00013820: 7469 6320 636f 6e73 7420 696e 7420 4747  tic const int GG
+00013830: 4d4c 5f42 4c43 4b5f 5349 5a45 5b47 474d  ML_BLCK_SIZE[GGM
+00013840: 4c5f 5459 5045 5f43 4f55 4e54 5d20 3d20  L_TYPE_COUNT] = 
+00013850: 7b0a 2020 2020 514b 2c0a 2020 2020 514b  {.    QK,.    QK
+00013860: 2c0a 2020 2020 312c 0a20 2020 2031 2c0a  ,.    1,.    1,.
+00013870: 2020 2020 312c 0a20 2020 2031 2c0a 2020      1,.    1,.  
+00013880: 2020 312c 0a7d 3b0a 0a73 7461 7469 635f    1,.};..static_
+00013890: 6173 7365 7274 2847 474d 4c5f 5459 5045  assert(GGML_TYPE
+000138a0: 5f43 4f55 4e54 203d 3d20 372c 2022 4747  _COUNT == 7, "GG
+000138b0: 4d4c 5f54 5950 455f 434f 554e 5420 213d  ML_TYPE_COUNT !=
+000138c0: 2035 2229 3b0a 0a73 7461 7469 6320 636f   5");..static co
+000138d0: 6e73 7420 7369 7a65 5f74 2047 474d 4c5f  nst size_t GGML_
+000138e0: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
+000138f0: 5950 455f 434f 554e 545d 203d 207b 0a20  YPE_COUNT] = {. 
+00013900: 2020 2073 697a 656f 6628 626c 6f63 6b5f     sizeof(block_
+00013910: 7134 5f30 292c 0a20 2020 2073 697a 656f  q4_0),.    sizeo
+00013920: 6628 626c 6f63 6b5f 7134 5f31 292c 0a20  f(block_q4_1),. 
+00013930: 2020 2073 697a 656f 6628 696e 7438 5f74     sizeof(int8_t
+00013940: 2029 2c0a 2020 2020 7369 7a65 6f66 2869   ),.    sizeof(i
+00013950: 6e74 3136 5f74 292c 0a20 2020 2073 697a  nt16_t),.    siz
+00013960: 656f 6628 696e 7433 325f 7429 2c0a 2020  eof(int32_t),.  
+00013970: 2020 7369 7a65 6f66 2867 676d 6c5f 6670    sizeof(ggml_fp
+00013980: 3136 5f74 292c 0a20 2020 2073 697a 656f  16_t),.    sizeo
+00013990: 6628 666c 6f61 7420 2029 2c0a 7d3b 0a0a  f(float  ),.};..
+000139a0: 2f2f 2064 6f6e 2774 2066 6f72 6765 7420  // don't forget 
+000139b0: 746f 2075 7064 6174 6520 7468 6520 6172  to update the ar
+000139c0: 7261 7920 6162 6f76 6520 7768 656e 2061  ray above when a
+000139d0: 6464 696e 6720 6e65 7720 7479 7065 730a  dding new types.
+000139e0: 7374 6174 6963 5f61 7373 6572 7428 4747  static_assert(GG
+000139f0: 4d4c 5f54 5950 455f 434f 554e 5420 3d3d  ML_TYPE_COUNT ==
+00013a00: 2037 2c20 2247 474d 4c5f 5459 5045 5f43   7, "GGML_TYPE_C
+00013a10: 4f55 4e54 2021 3d20 3522 293b 0a0a 7374  OUNT != 5");..st
+00013a20: 6174 6963 2063 6f6e 7374 2063 6861 7220  atic const char 
+00013a30: 2a20 4747 4d4c 5f4f 505f 4c41 4245 4c5b  * GGML_OP_LABEL[
+00013a40: 4747 4d4c 5f4f 505f 434f 554e 545d 203d  GGML_OP_COUNT] =
+00013a50: 207b 0a20 2020 2022 4e4f 4e45 222c 0a0a   {.    "NONE",..
+00013a60: 2020 2020 2244 5550 222c 0a20 2020 2022      "DUP",.    "
+00013a70: 4144 4422 2c0a 2020 2020 2253 5542 222c  ADD",.    "SUB",
+00013a80: 0a20 2020 2022 4d55 4c22 2c0a 2020 2020  .    "MUL",.    
+00013a90: 2244 4956 222c 0a20 2020 2022 5351 5222  "DIV",.    "SQR"
+00013aa0: 2c0a 2020 2020 2253 5152 5422 2c0a 2020  ,.    "SQRT",.  
+00013ab0: 2020 2253 554d 222c 0a20 2020 2022 4d45    "SUM",.    "ME
+00013ac0: 414e 222c 0a20 2020 2022 5245 5045 4154  AN",.    "REPEAT
+00013ad0: 222c 0a20 2020 2022 4142 5322 2c0a 2020  ",.    "ABS",.  
+00013ae0: 2020 2253 474e 222c 0a20 2020 2022 4e45    "SGN",.    "NE
+00013af0: 4722 2c0a 2020 2020 2253 5445 5022 2c0a  G",.    "STEP",.
+00013b00: 2020 2020 2252 454c 5522 2c0a 2020 2020      "RELU",.    
+00013b10: 2247 454c 5522 2c0a 2020 2020 2253 494c  "GELU",.    "SIL
+00013b20: 5522 2c0a 2020 2020 224e 4f52 4d22 2c0a  U",.    "NORM",.
+00013b30: 2020 2020 2252 4d53 5f4e 4f52 4d22 2c0a      "RMS_NORM",.
+00013b40: 0a20 2020 2022 4d55 4c5f 4d41 5422 2c0a  .    "MUL_MAT",.
+00013b50: 0a20 2020 2022 5343 414c 4522 2c0a 2020  .    "SCALE",.  
+00013b60: 2020 2243 5059 222c 0a20 2020 2022 5245    "CPY",.    "RE
+00013b70: 5348 4150 4522 2c0a 2020 2020 2256 4945  SHAPE",.    "VIE
+00013b80: 5722 2c0a 2020 2020 2250 4552 4d55 5445  W",.    "PERMUTE
+00013b90: 222c 0a20 2020 2022 5452 414e 5350 4f53  ",.    "TRANSPOS
+00013ba0: 4522 2c0a 2020 2020 2247 4554 5f52 4f57  E",.    "GET_ROW
+00013bb0: 5322 2c0a 2020 2020 2244 4941 475f 4d41  S",.    "DIAG_MA
+00013bc0: 534b 5f49 4e46 222c 0a20 2020 2022 534f  SK_INF",.    "SO
+00013bd0: 4654 5f4d 4158 222c 0a20 2020 2022 524f  FT_MAX",.    "RO
+00013be0: 5045 222c 0a20 2020 2022 434f 4e56 5f31  PE",.    "CONV_1
+00013bf0: 445f 3153 222c 0a20 2020 2022 434f 4e56  D_1S",.    "CONV
+00013c00: 5f31 445f 3253 222c 0a0a 2020 2020 2246  _1D_2S",..    "F
+00013c10: 4c41 5348 5f41 5454 4e22 2c0a 2020 2020  LASH_ATTN",.    
+00013c20: 2246 4c41 5348 5f46 4622 2c0a 7d3b 0a0a  "FLASH_FF",.};..
+00013c30: 7374 6174 6963 5f61 7373 6572 7428 4747  static_assert(GG
+00013c40: 4d4c 5f4f 505f 434f 554e 5420 3d3d 2033  ML_OP_COUNT == 3
+00013c50: 352c 2022 4747 4d4c 5f4f 505f 434f 554e  5, "GGML_OP_COUN
+00013c60: 5420 213d 2033 3522 293b 0a0a 7374 6174  T != 35");..stat
+00013c70: 6963 2063 6f6e 7374 2063 6861 7220 2a20  ic const char * 
+00013c80: 4747 4d4c 5f4f 505f 5359 4d42 4f4c 5b47  GGML_OP_SYMBOL[G
+00013c90: 474d 4c5f 4f50 5f43 4f55 4e54 5d20 3d20  GML_OP_COUNT] = 
+00013ca0: 7b0a 2020 2020 226e 6f6e 6522 2c0a 0a20  {.    "none",.. 
+00013cb0: 2020 2022 7822 2c0a 2020 2020 2278 2b79     "x",.    "x+y
+00013cc0: 222c 0a20 2020 2022 782d 7922 2c0a 2020  ",.    "x-y",.  
+00013cd0: 2020 2278 2a79 222c 0a20 2020 2022 782f    "x*y",.    "x/
+00013ce0: 7922 2c0a 2020 2020 2278 5e32 222c 0a20  y",.    "x^2",. 
+00013cf0: 2020 2022 e288 9a78 222c 0a20 2020 2022     "...x",.    "
+00013d00: cea3 7822 2c0a 2020 2020 22ce a378 2f6e  ..x",.    "..x/n
+00013d10: 222c 0a20 2020 2022 7265 7065 6174 2878  ",.    "repeat(x
+00013d20: 2922 2c0a 2020 2020 2261 6273 2878 2922  )",.    "abs(x)"
+00013d30: 2c0a 2020 2020 2273 676e 2878 2922 2c0a  ,.    "sgn(x)",.
+00013d40: 2020 2020 222d 7822 2c0a 2020 2020 2273      "-x",.    "s
+00013d50: 7465 7028 7829 222c 0a20 2020 2022 7265  tep(x)",.    "re
+00013d60: 6c75 2878 2922 2c0a 2020 2020 2267 656c  lu(x)",.    "gel
+00013d70: 7528 7829 222c 0a20 2020 2022 7369 6c75  u(x)",.    "silu
+00013d80: 2878 2922 2c0a 2020 2020 226e 6f72 6d28  (x)",.    "norm(
+00013d90: 7829 222c 0a20 2020 2022 726d 735f 6e6f  x)",.    "rms_no
+00013da0: 726d 2878 2922 2c0a 0a20 2020 2022 582a  rm(x)",..    "X*
+00013db0: 5922 2c0a 0a20 2020 2022 782a 7622 2c0a  Y",..    "x*v",.
+00013dc0: 2020 2020 2278 2d5c 5c3e 7922 2c0a 2020      "x-\\>y",.  
+00013dd0: 2020 2272 6573 6861 7065 2878 2922 2c0a    "reshape(x)",.
+00013de0: 2020 2020 2276 6965 7728 7829 222c 0a20      "view(x)",. 
+00013df0: 2020 2022 7065 726d 7574 6528 7829 222c     "permute(x)",
+00013e00: 0a20 2020 2022 7472 616e 7370 6f73 6528  .    "transpose(
+00013e10: 7829 222c 0a20 2020 2022 6765 745f 726f  x)",.    "get_ro
+00013e20: 7773 2878 2922 2c0a 2020 2020 2264 6961  ws(x)",.    "dia
+00013e30: 675f 6d61 736b 5f69 6e66 2878 2922 2c0a  g_mask_inf(x)",.
+00013e40: 2020 2020 2273 6f66 745f 6d61 7828 7829      "soft_max(x)
+00013e50: 222c 0a20 2020 2022 726f 7065 2878 2922  ",.    "rope(x)"
+00013e60: 2c0a 2020 2020 2263 6f6e 765f 3164 5f31  ,.    "conv_1d_1
+00013e70: 7328 7829 222c 0a20 2020 2022 636f 6e76  s(x)",.    "conv
+00013e80: 5f31 645f 3273 2878 2922 2c0a 0a20 2020  _1d_2s(x)",..   
+00013e90: 2022 666c 6173 685f 6174 746e 2878 2922   "flash_attn(x)"
+00013ea0: 2c0a 2020 2020 2266 6c61 7368 5f66 6628  ,.    "flash_ff(
+00013eb0: 7829 222c 0a7d 3b0a 0a73 7461 7469 635f  x)",.};..static_
+00013ec0: 6173 7365 7274 2847 474d 4c5f 4f50 5f43  assert(GGML_OP_C
+00013ed0: 4f55 4e54 203d 3d20 3335 2c20 2247 474d  OUNT == 35, "GGM
+00013ee0: 4c5f 4f50 5f43 4f55 4e54 2021 3d20 3335  L_OP_COUNT != 35
+00013ef0: 2229 3b0a 0a2f 2f0a 2f2f 2067 676d 6c20  ");..//.// ggml 
+00013f00: 6f62 6a65 6374 0a2f 2f0a 0a73 7472 7563  object.//..struc
+00013f10: 7420 6767 6d6c 5f6f 626a 6563 7420 7b0a  t ggml_object {.
+00013f20: 2020 2020 7369 7a65 5f74 206f 6666 733b      size_t offs;
+00013f30: 0a20 2020 2073 697a 655f 7420 7369 7a65  .    size_t size
+00013f40: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+00013f50: 6d6c 5f6f 626a 6563 7420 2a20 6e65 7874  ml_object * next
+00013f60: 3b0a 0a20 2020 2063 6861 7220 7061 6464  ;..    char padd
+00013f70: 696e 675b 385d 3b0a 7d3b 0a0a 7374 6174  ing[8];.};..stat
+00013f80: 6963 2063 6f6e 7374 2073 697a 655f 7420  ic const size_t 
+00013f90: 4747 4d4c 5f4f 424a 4543 545f 5349 5a45  GGML_OBJECT_SIZE
+00013fa0: 203d 2073 697a 656f 6628 7374 7275 6374   = sizeof(struct
+00013fb0: 2067 676d 6c5f 6f62 6a65 6374 293b 0a0a   ggml_object);..
+00013fc0: 7374 6174 6963 5f61 7373 6572 7428 7369  static_assert(si
+00013fd0: 7a65 6f66 2873 7472 7563 7420 6767 6d6c  zeof(struct ggml
+00013fe0: 5f6f 626a 6563 7429 2547 474d 4c5f 4d45  _object)%GGML_ME
+00013ff0: 4d5f 414c 4947 4e20 3d3d 2030 2c20 2267  M_ALIGN == 0, "g
+00014000: 676d 6c5f 6f62 6a65 6374 2073 697a 6520  gml_object size 
+00014010: 6d75 7374 2062 6520 6120 6d75 6c74 6970  must be a multip
+00014020: 6c65 206f 6620 4747 4d4c 5f4d 454d 5f41  le of GGML_MEM_A
+00014030: 4c49 474e 2229 3b0a 7374 6174 6963 5f61  LIGN");.static_a
+00014040: 7373 6572 7428 7369 7a65 6f66 2873 7472  ssert(sizeof(str
+00014050: 7563 7420 6767 6d6c 5f74 656e 736f 7229  uct ggml_tensor)
+00014060: 2547 474d 4c5f 4d45 4d5f 414c 4947 4e20  %GGML_MEM_ALIGN 
+00014070: 3d3d 2030 2c20 2267 676d 6c5f 7465 6e73  == 0, "ggml_tens
+00014080: 6f72 2073 697a 6520 6d75 7374 2062 6520  or size must be 
+00014090: 6120 6d75 6c74 6970 6c65 206f 6620 4747  a multiple of GG
+000140a0: 4d4c 5f4d 454d 5f41 4c49 474e 2229 3b0a  ML_MEM_ALIGN");.
+000140b0: 0a2f 2f0a 2f2f 2067 676d 6c20 636f 6e74  .//.// ggml cont
+000140c0: 6578 740a 2f2f 0a0a 7374 7275 6374 2067  ext.//..struct g
+000140d0: 676d 6c5f 636f 6e74 6578 7420 7b0a 2020  gml_context {.  
+000140e0: 2020 7369 7a65 5f74 206d 656d 5f73 697a    size_t mem_siz
+000140f0: 653b 0a20 2020 2076 6f69 6420 2a20 6d65  e;.    void * me
+00014100: 6d5f 6275 6666 6572 3b0a 2020 2020 626f  m_buffer;.    bo
+00014110: 6f6c 2020 206d 656d 5f62 7566 6665 725f  ol   mem_buffer_
+00014120: 6f77 6e65 643b 0a20 2020 2062 6f6f 6c20  owned;.    bool 
+00014130: 2020 6d65 6d5f 6275 6666 6572 5f6d 6c6f    mem_buffer_mlo
+00014140: 636b 6564 3b0a 0a20 2020 2069 6e74 206e  cked;..    int n
+00014150: 5f6f 626a 6563 7473 3b0a 0a20 2020 2073  _objects;..    s
+00014160: 7472 7563 7420 6767 6d6c 5f6f 626a 6563  truct ggml_objec
+00014170: 7420 2a20 6f62 6a65 6374 735f 6265 6769  t * objects_begi
+00014180: 6e3b 0a20 2020 2073 7472 7563 7420 6767  n;.    struct gg
+00014190: 6d6c 5f6f 626a 6563 7420 2a20 6f62 6a65  ml_object * obje
+000141a0: 6374 735f 656e 643b 0a0a 2020 2020 7374  cts_end;..    st
+000141b0: 7275 6374 2067 676d 6c5f 7363 7261 7463  ruct ggml_scratc
+000141c0: 6820 7363 7261 7463 683b 0a20 2020 2073  h scratch;.    s
+000141d0: 7472 7563 7420 6767 6d6c 5f73 6372 6174  truct ggml_scrat
+000141e0: 6368 2073 6372 6174 6368 5f73 6176 653b  ch scratch_save;
+000141f0: 0a7d 3b0a 0a73 7472 7563 7420 6767 6d6c  .};..struct ggml
+00014200: 5f63 6f6e 7465 7874 5f63 6f6e 7461 696e  _context_contain
+00014210: 6572 207b 0a20 2020 2062 6f6f 6c20 7573  er {.    bool us
+00014220: 6564 3b0a 0a20 2020 2073 7472 7563 7420  ed;..    struct 
+00014230: 6767 6d6c 5f63 6f6e 7465 7874 2063 6f6e  ggml_context con
+00014240: 7465 7874 3b0a 7d3b 0a0a 2f2f 0a2f 2f20  text;.};..//.// 
+00014250: 636f 6d70 7574 6520 7479 7065 730a 2f2f  compute types.//
+00014260: 0a0a 656e 756d 2067 676d 6c5f 7461 736b  ..enum ggml_task
+00014270: 5f74 7970 6520 7b0a 2020 2020 4747 4d4c  _type {.    GGML
+00014280: 5f54 4153 4b5f 494e 4954 203d 2030 2c0a  _TASK_INIT = 0,.
+00014290: 2020 2020 4747 4d4c 5f54 4153 4b5f 434f      GGML_TASK_CO
+000142a0: 4d50 5554 452c 0a20 2020 2047 474d 4c5f  MPUTE,.    GGML_
+000142b0: 5441 534b 5f46 494e 414c 495a 452c 0a7d  TASK_FINALIZE,.}
+000142c0: 3b0a 0a73 7472 7563 7420 6767 6d6c 5f63  ;..struct ggml_c
+000142d0: 6f6d 7075 7465 5f70 6172 616d 7320 7b0a  ompute_params {.
+000142e0: 2020 2020 656e 756d 2067 676d 6c5f 7461      enum ggml_ta
+000142f0: 736b 5f74 7970 6520 7479 7065 3b0a 0a20  sk_type type;.. 
+00014300: 2020 2069 6e74 2069 7468 2c20 6e74 683b     int ith, nth;
+00014310: 0a0a 2020 2020 2f2f 2077 6f72 6b20 6275  ..    // work bu
+00014320: 6666 6572 2066 6f72 2061 6c6c 2074 6872  ffer for all thr
+00014330: 6561 6473 0a20 2020 2073 697a 655f 7420  eads.    size_t 
+00014340: 7773 697a 653b 0a20 2020 2076 6f69 6420  wsize;.    void 
+00014350: 2a20 7764 6174 613b 0a7d 3b0a 0a2f 2f0a  * wdata;.};..//.
+00014360: 2f2f 2067 676d 6c20 7374 6174 650a 2f2f  // ggml state.//
+00014370: 0a0a 7374 7275 6374 2067 676d 6c5f 7374  ..struct ggml_st
+00014380: 6174 6520 7b0a 2020 2020 7374 7275 6374  ate {.    struct
+00014390: 2067 676d 6c5f 636f 6e74 6578 745f 636f   ggml_context_co
+000143a0: 6e74 6169 6e65 7220 636f 6e74 6578 7473  ntainer contexts
+000143b0: 5b47 474d 4c5f 4d41 585f 434f 4e54 4558  [GGML_MAX_CONTEX
+000143c0: 5453 5d3b 0a7d 3b0a 0a2f 2f20 676c 6f62  TS];.};..// glob
+000143d0: 616c 2073 7461 7465 0a73 7461 7469 6320  al state.static 
+000143e0: 7374 7275 6374 2067 676d 6c5f 7374 6174  struct ggml_stat
+000143f0: 6520 675f 7374 6174 653b 0a73 7461 7469  e g_state;.stati
+00014400: 6320 6174 6f6d 6963 5f69 6e74 2067 5f73  c atomic_int g_s
+00014410: 7461 7465 5f62 6172 7269 6572 203d 2030  tate_barrier = 0
+00014420: 3b0a 0a2f 2f20 6261 7272 6965 7220 7669  ;..// barrier vi
+00014430: 6120 7370 696e 206c 6f63 6b0a 696e 6c69  a spin lock.inli
+00014440: 6e65 2073 7461 7469 6320 766f 6964 2067  ne static void g
+00014450: 676d 6c5f 6372 6974 6963 616c 5f73 6563  gml_critical_sec
+00014460: 7469 6f6e 5f73 7461 7274 2876 6f69 6429  tion_start(void)
+00014470: 207b 0a20 2020 2069 6e74 2070 726f 6365   {.    int proce
+00014480: 7373 696e 6720 3d20 6174 6f6d 6963 5f66  ssing = atomic_f
+00014490: 6574 6368 5f61 6464 2826 675f 7374 6174  etch_add(&g_stat
+000144a0: 655f 6261 7272 6965 722c 2031 293b 0a0a  e_barrier, 1);..
+000144b0: 2020 2020 7768 696c 6520 2870 726f 6365      while (proce
+000144c0: 7373 696e 6720 3e20 3029 207b 0a20 2020  ssing > 0) {.   
+000144d0: 2020 2020 202f 2f20 7761 6974 2066 6f72       // wait for
+000144e0: 206f 7468 6572 2074 6872 6561 6473 2074   other threads t
+000144f0: 6f20 6669 6e69 7368 0a20 2020 2020 2020  o finish.       
+00014500: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
+00014510: 6228 2667 5f73 7461 7465 5f62 6172 7269  b(&g_state_barri
+00014520: 6572 2c20 3129 3b0a 2020 2020 2020 2020  er, 1);.        
+00014530: 7363 6865 645f 7969 656c 6428 293b 202f  sched_yield(); /
+00014540: 2f20 544f 444f 3a20 7265 636f 6e73 6964  / TODO: reconsid
+00014550: 6572 2074 6869 730a 2020 2020 2020 2020  er this.        
+00014560: 7072 6f63 6573 7369 6e67 203d 2061 746f  processing = ato
+00014570: 6d69 635f 6665 7463 685f 6164 6428 2667  mic_fetch_add(&g
+00014580: 5f73 7461 7465 5f62 6172 7269 6572 2c20  _state_barrier, 
+00014590: 3129 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  1);.    }.}..// 
+000145a0: 544f 444f 3a20 6d61 6b65 2074 6869 7320  TODO: make this 
+000145b0: 736f 6d65 686f 7720 6175 746f 6d61 7469  somehow automati
+000145c0: 6361 6c6c 7920 6578 6563 7574 6564 0a2f  cally executed./
+000145d0: 2f20 2020 2020 2020 736f 6d65 2073 6f72  /       some sor
+000145e0: 7420 6f66 2022 7365 6e74 7279 2220 6d65  t of "sentry" me
+000145f0: 6368 616e 6973 6d0a 696e 6c69 6e65 2073  chanism.inline s
+00014600: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00014610: 6372 6974 6963 616c 5f73 6563 7469 6f6e  critical_section
+00014620: 5f65 6e64 2876 6f69 6429 207b 0a20 2020  _end(void) {.   
+00014630: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
+00014640: 6228 2667 5f73 7461 7465 5f62 6172 7269  b(&g_state_barri
+00014650: 6572 2c20 3129 3b0a 7d0a 0a2f 2f2f 2f2f  er, 1);.}../////
+00014660: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00014670: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00014680: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00014690: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000146a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a76 6f69  ///////////..voi
+000146b0: 6420 6767 6d6c 5f70 7269 6e74 5f6f 626a  d ggml_print_obj
+000146c0: 6563 7428 636f 6e73 7420 7374 7275 6374  ect(const struct
+000146d0: 2067 676d 6c5f 6f62 6a65 6374 202a 206f   ggml_object * o
+000146e0: 626a 2920 7b0a 2020 2020 4747 4d4c 5f50  bj) {.    GGML_P
+000146f0: 5249 4e54 2822 202d 2067 676d 6c5f 6f62  RINT(" - ggml_ob
+00014700: 6a65 6374 3a20 6f66 6673 6574 203d 2025  ject: offset = %
+00014710: 7a75 2c20 7369 7a65 203d 2025 7a75 2c20  zu, size = %zu, 
+00014720: 6e65 7874 203d 2025 705c 6e22 2c0a 2020  next = %p\n",.  
+00014730: 2020 2020 2020 2020 2020 6f62 6a2d 3e6f            obj->o
+00014740: 6666 732c 206f 626a 2d3e 7369 7a65 2c20  ffs, obj->size, 
+00014750: 2863 6f6e 7374 2076 6f69 6420 2a29 206f  (const void *) o
+00014760: 626a 2d3e 6e65 7874 293b 0a7d 0a0a 766f  bj->next);.}..vo
+00014770: 6964 2067 676d 6c5f 7072 696e 745f 6f62  id ggml_print_ob
+00014780: 6a65 6374 7328 636f 6e73 7420 7374 7275  jects(const stru
+00014790: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+000147a0: 2a20 6374 7829 207b 0a20 2020 2073 7472  * ctx) {.    str
+000147b0: 7563 7420 6767 6d6c 5f6f 626a 6563 7420  uct ggml_object 
+000147c0: 2a20 6f62 6a20 3d20 6374 782d 3e6f 626a  * obj = ctx->obj
+000147d0: 6563 7473 5f62 6567 696e 3b0a 0a20 2020  ects_begin;..   
+000147e0: 2047 474d 4c5f 5052 494e 5428 2225 733a   GGML_PRINT("%s:
+000147f0: 206f 626a 6563 7473 2069 6e20 636f 6e74   objects in cont
+00014800: 6578 7420 2570 3a5c 6e22 2c20 5f5f 6675  ext %p:\n", __fu
+00014810: 6e63 5f5f 2c20 2863 6f6e 7374 2076 6f69  nc__, (const voi
+00014820: 6420 2a29 2063 7478 293b 0a0a 2020 2020  d *) ctx);..    
+00014830: 7768 696c 6520 286f 626a 2021 3d20 4e55  while (obj != NU
+00014840: 4c4c 2920 7b0a 2020 2020 2020 2020 6767  LL) {.        gg
+00014850: 6d6c 5f70 7269 6e74 5f6f 626a 6563 7428  ml_print_object(
+00014860: 6f62 6a29 3b0a 2020 2020 2020 2020 6f62  obj);.        ob
+00014870: 6a20 3d20 6f62 6a2d 3e6e 6578 743b 0a20  j = obj->next;. 
+00014880: 2020 207d 0a0a 2020 2020 4747 4d4c 5f50     }..    GGML_P
+00014890: 5249 4e54 2822 2573 3a20 2d2d 2d20 656e  RINT("%s: --- en
+000148a0: 6420 2d2d 2d5c 6e22 2c20 5f5f 6675 6e63  d ---\n", __func
+000148b0: 5f5f 293b 0a7d 0a0a 696e 7420 6767 6d6c  __);.}..int ggml
+000148c0: 5f6e 656c 656d 656e 7473 2863 6f6e 7374  _nelements(const
+000148d0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000148e0: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
+000148f0: 2020 2020 7374 6174 6963 5f61 7373 6572      static_asser
+00014900: 7428 4747 4d4c 5f4d 4158 5f44 494d 5320  t(GGML_MAX_DIMS 
+00014910: 3d3d 2034 2c20 2247 474d 4c5f 4d41 585f  == 4, "GGML_MAX_
+00014920: 4449 4d53 2069 7320 6e6f 7420 3420 2d20  DIMS is not 4 - 
+00014930: 7570 6461 7465 2074 6869 7320 6675 6e63  update this func
+00014940: 7469 6f6e 2229 3b0a 0a20 2020 2072 6574  tion");..    ret
+00014950: 7572 6e20 7465 6e73 6f72 2d3e 6e65 5b30  urn tensor->ne[0
+00014960: 5d2a 7465 6e73 6f72 2d3e 6e65 5b31 5d2a  ]*tensor->ne[1]*
+00014970: 7465 6e73 6f72 2d3e 6e65 5b32 5d2a 7465  tensor->ne[2]*te
+00014980: 6e73 6f72 2d3e 6e65 5b33 5d3b 0a7d 0a0a  nsor->ne[3];.}..
+00014990: 696e 7420 6767 6d6c 5f6e 726f 7773 2863  int ggml_nrows(c
+000149a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000149b0: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
+000149c0: 2920 7b0a 2020 2020 7374 6174 6963 5f61  ) {.    static_a
+000149d0: 7373 6572 7428 4747 4d4c 5f4d 4158 5f44  ssert(GGML_MAX_D
+000149e0: 494d 5320 3d3d 2034 2c20 2247 474d 4c5f  IMS == 4, "GGML_
+000149f0: 4d41 585f 4449 4d53 2069 7320 6e6f 7420  MAX_DIMS is not 
+00014a00: 3420 2d20 7570 6461 7465 2074 6869 7320  4 - update this 
+00014a10: 6675 6e63 7469 6f6e 2229 3b0a 0a20 2020  function");..   
+00014a20: 2072 6574 7572 6e20 7465 6e73 6f72 2d3e   return tensor->
+00014a30: 6e65 5b31 5d2a 7465 6e73 6f72 2d3e 6e65  ne[1]*tensor->ne
+00014a40: 5b32 5d2a 7465 6e73 6f72 2d3e 6e65 5b33  [2]*tensor->ne[3
+00014a50: 5d3b 0a7d 0a0a 7369 7a65 5f74 2067 676d  ];.}..size_t ggm
+00014a60: 6c5f 6e62 7974 6573 2863 6f6e 7374 2073  l_nbytes(const s
+00014a70: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00014a80: 7220 2a20 7465 6e73 6f72 2920 7b0a 2020  r * tensor) {.  
+00014a90: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
+00014aa0: 4747 4d4c 5f4d 4158 5f44 494d 5320 3d3d  GGML_MAX_DIMS ==
+00014ab0: 2034 2c20 2247 474d 4c5f 4d41 585f 4449   4, "GGML_MAX_DI
+00014ac0: 4d53 2069 7320 6e6f 7420 3420 2d20 7570  MS is not 4 - up
+00014ad0: 6461 7465 2074 6869 7320 6675 6e63 7469  date this functi
+00014ae0: 6f6e 2229 3b0a 0a20 2020 2072 6574 7572  on");..    retur
+00014af0: 6e20 2867 676d 6c5f 6e65 6c65 6d65 6e74  n (ggml_nelement
+00014b00: 7328 7465 6e73 6f72 292a 4747 4d4c 5f54  s(tensor)*GGML_T
+00014b10: 5950 455f 5349 5a45 5b74 656e 736f 722d  YPE_SIZE[tensor-
+00014b20: 3e74 7970 655d 292f 4747 4d4c 5f42 4c43  >type])/GGML_BLC
+00014b30: 4b5f 5349 5a45 5b74 656e 736f 722d 3e74  K_SIZE[tensor->t
+00014b40: 7970 655d 3b0a 7d0a 0a69 6e74 2067 676d  ype];.}..int ggm
+00014b50: 6c5f 626c 636b 5f73 697a 6528 656e 756d  l_blck_size(enum
+00014b60: 2067 676d 6c5f 7479 7065 2074 7970 6529   ggml_type type)
+00014b70: 207b 0a20 2020 2072 6574 7572 6e20 4747   {.    return GG
+00014b80: 4d4c 5f42 4c43 4b5f 5349 5a45 5b74 7970  ML_BLCK_SIZE[typ
+00014b90: 655d 3b0a 7d0a 0a73 697a 655f 7420 6767  e];.}..size_t gg
+00014ba0: 6d6c 5f74 7970 655f 7369 7a65 2865 6e75  ml_type_size(enu
+00014bb0: 6d20 6767 6d6c 5f74 7970 6520 7479 7065  m ggml_type type
+00014bc0: 2920 7b0a 2020 2020 7265 7475 726e 2047  ) {.    return G
+00014bd0: 474d 4c5f 5459 5045 5f53 495a 455b 7479  GML_TYPE_SIZE[ty
+00014be0: 7065 5d3b 0a7d 0a0a 666c 6f61 7420 6767  pe];.}..float gg
+00014bf0: 6d6c 5f74 7970 655f 7369 7a65 6628 656e  ml_type_sizef(en
+00014c00: 756d 2067 676d 6c5f 7479 7065 2074 7970  um ggml_type typ
+00014c10: 6529 207b 0a20 2020 2072 6574 7572 6e20  e) {.    return 
+00014c20: 2828 666c 6f61 7429 2847 474d 4c5f 5459  ((float)(GGML_TY
+00014c30: 5045 5f53 495a 455b 7479 7065 5d29 292f  PE_SIZE[type]))/
+00014c40: 4747 4d4c 5f42 4c43 4b5f 5349 5a45 5b74  GGML_BLCK_SIZE[t
+00014c50: 7970 655d 3b0a 7d0a 0a73 697a 655f 7420  ype];.}..size_t 
+00014c60: 6767 6d6c 5f65 6c65 6d65 6e74 5f73 697a  ggml_element_siz
+00014c70: 6528 636f 6e73 7420 7374 7275 6374 2067  e(const struct g
+00014c80: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+00014c90: 736f 7229 207b 0a20 2020 2072 6574 7572  sor) {.    retur
+00014ca0: 6e20 4747 4d4c 5f54 5950 455f 5349 5a45  n GGML_TYPE_SIZE
+00014cb0: 5b74 656e 736f 722d 3e74 7970 655d 3b0a  [tensor->type];.
+00014cc0: 7d0a 0a73 7461 7469 6320 696e 6c69 6e65  }..static inline
+00014cd0: 2062 6f6f 6c20 6767 6d6c 5f69 735f 7363   bool ggml_is_sc
+00014ce0: 616c 6172 2863 6f6e 7374 2073 7472 7563  alar(const struc
+00014cf0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00014d00: 7465 6e73 6f72 2920 7b0a 2020 2020 7374  tensor) {.    st
+00014d10: 6174 6963 5f61 7373 6572 7428 4747 4d4c  atic_assert(GGML
+00014d20: 5f4d 4158 5f44 494d 5320 3d3d 2034 2c20  _MAX_DIMS == 4, 
+00014d30: 2247 474d 4c5f 4d41 585f 4449 4d53 2069  "GGML_MAX_DIMS i
+00014d40: 7320 6e6f 7420 3420 2d20 7570 6461 7465  s not 4 - update
+00014d50: 2074 6869 7320 6675 6e63 7469 6f6e 2229   this function")
+00014d60: 3b0a 0a20 2020 2072 6574 7572 6e20 7465  ;..    return te
+00014d70: 6e73 6f72 2d3e 6e65 5b30 5d20 3d3d 2031  nsor->ne[0] == 1
+00014d80: 2026 2620 7465 6e73 6f72 2d3e 6e65 5b31   && tensor->ne[1
+00014d90: 5d20 3d3d 2031 2026 2620 7465 6e73 6f72  ] == 1 && tensor
+00014da0: 2d3e 6e65 5b32 5d20 3d3d 2031 2026 2620  ->ne[2] == 1 && 
+00014db0: 7465 6e73 6f72 2d3e 6e65 5b33 5d20 3d3d  tensor->ne[3] ==
+00014dc0: 2031 3b0a 7d0a 0a73 7461 7469 6320 696e   1;.}..static in
+00014dd0: 6c69 6e65 2062 6f6f 6c20 6767 6d6c 5f69  line bool ggml_i
+00014de0: 735f 7665 6374 6f72 2863 6f6e 7374 2073  s_vector(const s
+00014df0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00014e00: 7220 2a20 7465 6e73 6f72 2920 7b0a 2020  r * tensor) {.  
+00014e10: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
+00014e20: 4747 4d4c 5f4d 4158 5f44 494d 5320 3d3d  GGML_MAX_DIMS ==
+00014e30: 2034 2c20 2247 474d 4c5f 4d41 585f 4449   4, "GGML_MAX_DI
+00014e40: 4d53 2069 7320 6e6f 7420 3420 2d20 7570  MS is not 4 - up
+00014e50: 6461 7465 2074 6869 7320 6675 6e63 7469  date this functi
+00014e60: 6f6e 2229 3b0a 0a20 2020 2072 6574 7572  on");..    retur
+00014e70: 6e20 7465 6e73 6f72 2d3e 6e65 5b31 5d20  n tensor->ne[1] 
+00014e80: 3d3d 2031 2026 2620 7465 6e73 6f72 2d3e  == 1 && tensor->
+00014e90: 6e65 5b32 5d20 3d3d 2031 2026 2620 7465  ne[2] == 1 && te
+00014ea0: 6e73 6f72 2d3e 6e65 5b33 5d20 3d3d 2031  nsor->ne[3] == 1
+00014eb0: 3b0a 7d0a 0a73 7461 7469 6320 696e 6c69  ;.}..static inli
+00014ec0: 6e65 2062 6f6f 6c20 6767 6d6c 5f69 735f  ne bool ggml_is_
+00014ed0: 6d61 7472 6978 2863 6f6e 7374 2073 7472  matrix(const str
+00014ee0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00014ef0: 2a20 7465 6e73 6f72 2920 7b0a 2020 2020  * tensor) {.    
+00014f00: 7374 6174 6963 5f61 7373 6572 7428 4747  static_assert(GG
+00014f10: 4d4c 5f4d 4158 5f44 494d 5320 3d3d 2034  ML_MAX_DIMS == 4
+00014f20: 2c20 2247 474d 4c5f 4d41 585f 4449 4d53  , "GGML_MAX_DIMS
+00014f30: 2069 7320 6e6f 7420 3420 2d20 7570 6461   is not 4 - upda
+00014f40: 7465 2074 6869 7320 6675 6e63 7469 6f6e  te this function
+00014f50: 2229 3b0a 0a20 2020 2072 6574 7572 6e20  ");..    return 
+00014f60: 7465 6e73 6f72 2d3e 6e65 5b32 5d20 3d3d  tensor->ne[2] ==
+00014f70: 2031 2026 2620 7465 6e73 6f72 2d3e 6e65   1 && tensor->ne
+00014f80: 5b33 5d20 3d3d 2031 3b0a 7d0a 0a73 7461  [3] == 1;.}..sta
+00014f90: 7469 6320 696e 6c69 6e65 2062 6f6f 6c20  tic inline bool 
+00014fa0: 6767 6d6c 5f63 616e 5f6d 756c 5f6d 6174  ggml_can_mul_mat
+00014fb0: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+00014fc0: 6d6c 5f74 656e 736f 7220 2a20 7430 2c20  ml_tensor * t0, 
+00014fd0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00014fe0: 6c5f 7465 6e73 6f72 202a 2074 3129 207b  l_tensor * t1) {
+00014ff0: 0a20 2020 2073 7461 7469 635f 6173 7365  .    static_asse
+00015000: 7274 2847 474d 4c5f 4d41 585f 4449 4d53  rt(GGML_MAX_DIMS
+00015010: 203d 3d20 342c 2022 4747 4d4c 5f4d 4158   == 4, "GGML_MAX
+00015020: 5f44 494d 5320 6973 206e 6f74 2034 202d  _DIMS is not 4 -
+00015030: 2075 7064 6174 6520 7468 6973 2066 756e   update this fun
+00015040: 6374 696f 6e22 293b 0a0a 2020 2020 7265  ction");..    re
+00015050: 7475 726e 0a20 2020 2020 2020 2028 7430  turn.        (t0
+00015060: 2d3e 6e65 5b30 5d20 3d3d 2074 312d 3e6e  ->ne[0] == t1->n
+00015070: 655b 305d 2920 2026 260a 2020 2020 2020  e[0])  &&.      
+00015080: 2020 2874 302d 3e6e 655b 325d 203d 3d20    (t0->ne[2] == 
+00015090: 7431 2d3e 6e65 5b32 5d29 2020 2626 0a20  t1->ne[2])  &&. 
+000150a0: 2020 2020 2020 2028 7430 2d3e 6e65 5b33         (t0->ne[3
+000150b0: 5d20 3d3d 2074 312d 3e6e 655b 335d 293b  ] == t1->ne[3]);
+000150c0: 0a7d 0a0a 7374 6174 6963 2069 6e6c 696e  .}..static inlin
+000150d0: 6520 626f 6f6c 2067 676d 6c5f 6973 5f74  e bool ggml_is_t
+000150e0: 7261 6e73 706f 7365 6428 636f 6e73 7420  ransposed(const 
+000150f0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00015100: 6f72 202a 2074 656e 736f 7229 207b 0a20  or * tensor) {. 
+00015110: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+00015120: 2d3e 6e62 5b30 5d20 3e20 7465 6e73 6f72  ->nb[0] > tensor
+00015130: 2d3e 6e62 5b31 5d3b 0a7d 0a0a 7374 6174  ->nb[1];.}..stat
+00015140: 6963 2069 6e6c 696e 6520 626f 6f6c 2067  ic inline bool g
+00015150: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+00015160: 7328 636f 6e73 7420 7374 7275 6374 2067  s(const struct g
+00015170: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+00015180: 736f 7229 207b 0a20 2020 2073 7461 7469  sor) {.    stati
+00015190: 635f 6173 7365 7274 2847 474d 4c5f 4d41  c_assert(GGML_MA
+000151a0: 585f 4449 4d53 203d 3d20 342c 2022 4747  X_DIMS == 4, "GG
+000151b0: 4d4c 5f4d 4158 5f44 494d 5320 6973 206e  ML_MAX_DIMS is n
+000151c0: 6f74 2034 202d 2075 7064 6174 6520 7468  ot 4 - update th
+000151d0: 6973 2066 756e 6374 696f 6e22 293b 0a0a  is function");..
+000151e0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+000151f0: 2020 2074 656e 736f 722d 3e6e 625b 305d     tensor->nb[0]
+00015200: 203d 3d20 4747 4d4c 5f54 5950 455f 5349   == GGML_TYPE_SI
+00015210: 5a45 5b74 656e 736f 722d 3e74 7970 655d  ZE[tensor->type]
+00015220: 2026 260a 2020 2020 2020 2020 7465 6e73   &&.        tens
+00015230: 6f72 2d3e 6e62 5b31 5d20 3d3d 2028 7465  or->nb[1] == (te
+00015240: 6e73 6f72 2d3e 6e62 5b30 5d2a 7465 6e73  nsor->nb[0]*tens
+00015250: 6f72 2d3e 6e65 5b30 5d29 2f47 474d 4c5f  or->ne[0])/GGML_
+00015260: 424c 434b 5f53 495a 455b 7465 6e73 6f72  BLCK_SIZE[tensor
+00015270: 2d3e 7479 7065 5d20 2626 0a20 2020 2020  ->type] &&.     
+00015280: 2020 2074 656e 736f 722d 3e6e 625b 325d     tensor->nb[2]
+00015290: 203d 3d20 7465 6e73 6f72 2d3e 6e62 5b31   == tensor->nb[1
+000152a0: 5d2a 7465 6e73 6f72 2d3e 6e65 5b31 5d20  ]*tensor->ne[1] 
+000152b0: 2626 0a20 2020 2020 2020 2074 656e 736f  &&.        tenso
+000152c0: 722d 3e6e 625b 335d 203d 3d20 7465 6e73  r->nb[3] == tens
+000152d0: 6f72 2d3e 6e62 5b32 5d2a 7465 6e73 6f72  or->nb[2]*tensor
+000152e0: 2d3e 6e65 5b32 5d3b 0a7d 0a0a 7374 6174  ->ne[2];.}..stat
+000152f0: 6963 2069 6e6c 696e 6520 626f 6f6c 2067  ic inline bool g
+00015300: 676d 6c5f 6973 5f70 6164 6465 645f 3164  gml_is_padded_1d
+00015310: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+00015320: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+00015330: 6f72 2920 7b0a 2020 2020 7374 6174 6963  or) {.    static
+00015340: 5f61 7373 6572 7428 4747 4d4c 5f4d 4158  _assert(GGML_MAX
+00015350: 5f44 494d 5320 3d3d 2034 2c20 2247 474d  _DIMS == 4, "GGM
+00015360: 4c5f 4d41 585f 4449 4d53 2069 7320 6e6f  L_MAX_DIMS is no
+00015370: 7420 3420 2d20 7570 6461 7465 2074 6869  t 4 - update thi
+00015380: 7320 6675 6e63 7469 6f6e 2229 3b0a 0a20  s function");.. 
+00015390: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+000153a0: 2020 7465 6e73 6f72 2d3e 6e62 5b30 5d20    tensor->nb[0] 
+000153b0: 3d3d 2047 474d 4c5f 5459 5045 5f53 495a  == GGML_TYPE_SIZ
+000153c0: 455b 7465 6e73 6f72 2d3e 7479 7065 5d20  E[tensor->type] 
+000153d0: 2626 0a20 2020 2020 2020 2074 656e 736f  &&.        tenso
+000153e0: 722d 3e6e 625b 325d 203d 3d20 7465 6e73  r->nb[2] == tens
+000153f0: 6f72 2d3e 6e62 5b31 5d2a 7465 6e73 6f72  or->nb[1]*tensor
+00015400: 2d3e 6e65 5b31 5d20 2626 0a20 2020 2020  ->ne[1] &&.     
+00015410: 2020 2074 656e 736f 722d 3e6e 625b 335d     tensor->nb[3]
+00015420: 203d 3d20 7465 6e73 6f72 2d3e 6e62 5b32   == tensor->nb[2
+00015430: 5d2a 7465 6e73 6f72 2d3e 6e65 5b32 5d3b  ]*tensor->ne[2];
+00015440: 0a7d 0a0a 7374 6174 6963 2069 6e6c 696e  .}..static inlin
+00015450: 6520 626f 6f6c 2067 676d 6c5f 6172 655f  e bool ggml_are_
+00015460: 7361 6d65 5f73 6861 7065 2863 6f6e 7374  same_shape(const
+00015470: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00015480: 736f 7220 2a20 7430 2c20 636f 6e73 7420  sor * t0, const 
+00015490: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000154a0: 6f72 202a 2074 3129 207b 0a20 2020 2073  or * t1) {.    s
+000154b0: 7461 7469 635f 6173 7365 7274 2847 474d  tatic_assert(GGM
+000154c0: 4c5f 4d41 585f 4449 4d53 203d 3d20 342c  L_MAX_DIMS == 4,
+000154d0: 2022 4747 4d4c 5f4d 4158 5f44 494d 5320   "GGML_MAX_DIMS 
+000154e0: 6973 206e 6f74 2034 202d 2075 7064 6174  is not 4 - updat
+000154f0: 6520 7468 6973 2066 756e 6374 696f 6e22  e this function"
+00015500: 293b 0a0a 2020 2020 7265 7475 726e 0a20  );..    return. 
+00015510: 2020 2020 2020 2028 7430 2d3e 6e65 5b30         (t0->ne[0
+00015520: 5d20 3d3d 2074 312d 3e6e 655b 305d 2029  ] == t1->ne[0] )
+00015530: 2026 260a 2020 2020 2020 2020 2874 302d   &&.        (t0-
+00015540: 3e6e 655b 315d 203d 3d20 7431 2d3e 6e65  >ne[1] == t1->ne
+00015550: 5b31 5d20 2920 2626 0a20 2020 2020 2020  [1] ) &&.       
+00015560: 2028 7430 2d3e 6e65 5b32 5d20 3d3d 2074   (t0->ne[2] == t
+00015570: 312d 3e6e 655b 325d 2029 2026 260a 2020  1->ne[2] ) &&.  
+00015580: 2020 2020 2020 2874 302d 3e6e 655b 335d        (t0->ne[3]
+00015590: 203d 3d20 7431 2d3e 6e65 5b33 5d20 293b   == t1->ne[3] );
+000155a0: 0a7d 0a0a 2f2f 2063 6865 636b 2069 6620  .}..// check if 
+000155b0: 7431 2063 616e 2062 6520 7265 7072 6573  t1 can be repres
+000155c0: 656e 7465 6420 6173 2061 2072 6570 6561  ented as a repea
+000155d0: 7469 7469 6f6e 206f 6620 7430 0a73 7461  tition of t0.sta
+000155e0: 7469 6320 696e 6c69 6e65 2062 6f6f 6c20  tic inline bool 
+000155f0: 6767 6d6c 5f63 616e 5f72 6570 6561 7428  ggml_can_repeat(
+00015600: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00015610: 6c5f 7465 6e73 6f72 202a 2074 302c 2063  l_tensor * t0, c
+00015620: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00015630: 5f74 656e 736f 7220 2a20 7431 2920 7b0a  _tensor * t1) {.
+00015640: 2020 2020 7374 6174 6963 5f61 7373 6572      static_asser
+00015650: 7428 4747 4d4c 5f4d 4158 5f44 494d 5320  t(GGML_MAX_DIMS 
+00015660: 3d3d 2034 2c20 2247 474d 4c5f 4d41 585f  == 4, "GGML_MAX_
+00015670: 4449 4d53 2069 7320 6e6f 7420 3420 2d20  DIMS is not 4 - 
+00015680: 7570 6461 7465 2074 6869 7320 6675 6e63  update this func
+00015690: 7469 6f6e 2229 3b0a 0a20 2020 2072 6574  tion");..    ret
+000156a0: 7572 6e0a 2020 2020 2020 2020 2874 312d  urn.        (t1-
+000156b0: 3e6e 655b 305d 2574 302d 3e6e 655b 305d  >ne[0]%t0->ne[0]
+000156c0: 203d 3d20 3029 2026 260a 2020 2020 2020   == 0) &&.      
+000156d0: 2020 2874 312d 3e6e 655b 315d 2574 302d    (t1->ne[1]%t0-
+000156e0: 3e6e 655b 315d 203d 3d20 3029 2026 260a  >ne[1] == 0) &&.
+000156f0: 2020 2020 2020 2020 2874 312d 3e6e 655b          (t1->ne[
+00015700: 325d 2574 302d 3e6e 655b 325d 203d 3d20  2]%t0->ne[2] == 
+00015710: 3029 2026 260a 2020 2020 2020 2020 2874  0) &&.        (t
+00015720: 312d 3e6e 655b 335d 2574 302d 3e6e 655b  1->ne[3]%t0->ne[
+00015730: 335d 203d 3d20 3029 3b0a 7d0a 0a73 7461  3] == 0);.}..sta
+00015740: 7469 6320 696e 6c69 6e65 2069 6e74 2067  tic inline int g
+00015750: 676d 6c5f 7570 3332 2869 6e74 206e 2920  gml_up32(int n) 
+00015760: 7b0a 2020 2020 7265 7475 726e 2028 6e20  {.    return (n 
+00015770: 2b20 3331 2920 2620 7e33 313b 0a7d 0a0a  + 31) & ~31;.}..
+00015780: 7374 6174 6963 2069 6e6c 696e 6520 696e  static inline in
+00015790: 7420 6767 6d6c 5f75 7036 3428 696e 7420  t ggml_up64(int 
+000157a0: 6e29 207b 0a20 2020 2072 6574 7572 6e20  n) {.    return 
+000157b0: 286e 202b 2036 3329 2026 207e 3633 3b0a  (n + 63) & ~63;.
+000157c0: 7d0a 0a73 7461 7469 6320 696e 6c69 6e65  }..static inline
+000157d0: 2069 6e74 2067 676d 6c5f 7570 2869 6e74   int ggml_up(int
+000157e0: 206e 2c20 696e 7420 6d29 207b 0a20 2020   n, int m) {.   
+000157f0: 202f 2f20 6173 7365 7274 206d 2069 7320   // assert m is 
+00015800: 6120 706f 7765 7220 6f66 2032 0a20 2020  a power of 2.   
+00015810: 2047 474d 4c5f 4153 5345 5254 2828 6d20   GGML_ASSERT((m 
+00015820: 2620 286d 202d 2031 2929 203d 3d20 3029  & (m - 1)) == 0)
+00015830: 3b0a 2020 2020 7265 7475 726e 2028 6e20  ;.    return (n 
+00015840: 2b20 6d20 2d20 3129 2026 207e 286d 202d  + m - 1) & ~(m -
+00015850: 2031 293b 0a7d 0a0a 2f2f 2061 7373 6572   1);.}..// asser
+00015860: 7420 7468 6174 2070 6f69 6e74 6572 2069  t that pointer i
+00015870: 7320 616c 6967 6e65 6420 746f 2047 474d  s aligned to GGM
+00015880: 4c5f 4d45 4d5f 414c 4947 4e0a 2364 6566  L_MEM_ALIGN.#def
+00015890: 696e 6520 6767 6d6c 5f61 7373 6572 745f  ine ggml_assert_
+000158a0: 616c 6967 6e65 6428 7074 7229 205c 0a20  aligned(ptr) \. 
+000158b0: 2020 2047 474d 4c5f 4153 5345 5254 2828     GGML_ASSERT((
+000158c0: 2875 696e 7470 7472 5f74 2920 2870 7472  (uintptr_t) (ptr
+000158d0: 2929 2547 474d 4c5f 4d45 4d5f 414c 4947  ))%GGML_MEM_ALIG
+000158e0: 4e20 3d3d 2030 290a 0a2f 2f2f 2f2f 2f2f  N == 0)..///////
+000158f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00015900: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00015910: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00015920: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00015930: 2f2f 2f2f 2f2f 2f2f 2f0a 0a73 7472 7563  /////////..struc
+00015940: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00015950: 2067 676d 6c5f 696e 6974 2873 7472 7563   ggml_init(struc
+00015960: 7420 6767 6d6c 5f69 6e69 745f 7061 7261  t ggml_init_para
+00015970: 6d73 2070 6172 616d 7329 207b 0a20 2020  ms params) {.   
+00015980: 202f 2f20 6d61 6b65 2074 6869 7320 6675   // make this fu
+00015990: 6e63 7469 6f6e 2074 6872 6561 6420 7361  nction thread sa
+000159a0: 6665 0a20 2020 2067 676d 6c5f 6372 6974  fe.    ggml_crit
+000159b0: 6963 616c 5f73 6563 7469 6f6e 5f73 7461  ical_section_sta
+000159c0: 7274 2829 3b0a 0a20 2020 2073 7461 7469  rt();..    stati
+000159d0: 6320 626f 6f6c 2069 735f 6669 7273 745f  c bool is_first_
+000159e0: 6361 6c6c 203d 2074 7275 653b 0a0a 2020  call = true;..  
+000159f0: 2020 6966 2028 6973 5f66 6972 7374 5f63    if (is_first_c
+00015a00: 616c 6c29 207b 0a20 2020 2020 2020 202f  all) {.        /
+00015a10: 2f20 696e 6974 6961 6c69 7a65 2047 454c  / initialize GEL
+00015a20: 552c 2053 494c 5520 616e 6420 4558 5020  U, SILU and EXP 
+00015a30: 4633 3220 7461 626c 6573 0a20 2020 2020  F32 tables.     
+00015a40: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00015a50: 2063 6f6e 7374 2075 696e 7436 345f 7420   const uint64_t 
+00015a60: 745f 7374 6172 7420 3d20 6767 6d6c 5f74  t_start = ggml_t
+00015a70: 696d 655f 7573 2829 3b20 554e 5553 4544  ime_us(); UNUSED
+00015a80: 2874 5f73 7461 7274 293b 0a0a 2020 2020  (t_start);..    
+00015a90: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
+00015aa0: 365f 7420 6969 3b0a 2020 2020 2020 2020  6_t ii;.        
+00015ab0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00015ac0: 2030 3b20 6920 3c20 2831 203c 3c20 3136   0; i < (1 << 16
+00015ad0: 293b 202b 2b69 2920 7b0a 2020 2020 2020  ); ++i) {.      
+00015ae0: 2020 2020 2020 2020 2020 7569 6e74 3136            uint16
+00015af0: 5f74 2075 6920 3d20 693b 0a20 2020 2020  _t ui = i;.     
+00015b00: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
+00015b10: 7928 2669 692c 2026 7569 2c20 7369 7a65  y(&ii, &ui, size
+00015b20: 6f66 2869 6929 293b 0a20 2020 2020 2020  of(ii));.       
+00015b30: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00015b40: 6c6f 6174 2066 203d 2074 6162 6c65 5f66  loat f = table_f
+00015b50: 3332 5f66 3136 5b69 5d20 3d20 4747 4d4c  32_f16[i] = GGML
+00015b60: 5f43 4f4d 5055 5445 5f46 5031 365f 544f  _COMPUTE_FP16_TO
+00015b70: 5f46 5033 3228 6969 293b 0a20 2020 2020  _FP32(ii);.     
+00015b80: 2020 2020 2020 2020 2020 2074 6162 6c65             table
+00015b90: 5f67 656c 755f 6631 365b 695d 203d 2047  _gelu_f16[i] = G
+00015ba0: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+00015bb0: 2867 676d 6c5f 6765 6c75 5f66 3332 2866  (ggml_gelu_f32(f
+00015bc0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+00015bd0: 2020 2020 7461 626c 655f 7369 6c75 5f66      table_silu_f
+00015be0: 3136 5b69 5d20 3d20 4747 4d4c 5f46 5033  16[i] = GGML_FP3
+00015bf0: 325f 544f 5f46 5031 3628 6767 6d6c 5f73  2_TO_FP16(ggml_s
+00015c00: 696c 755f 6633 3228 6629 293b 0a20 2020  ilu_f32(f));.   
+00015c10: 2020 2020 2020 2020 2020 2020 2074 6162               tab
+00015c20: 6c65 5f65 7870 5f66 3136 5b69 5d20 203d  le_exp_f16[i]  =
+00015c30: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
+00015c40: 3136 2865 7870 6628 6629 293b 0a20 2020  16(expf(f));.   
+00015c50: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00015c60: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+00015c70: 6e74 3634 5f74 2074 5f65 6e64 203d 2067  nt64_t t_end = g
+00015c80: 676d 6c5f 7469 6d65 5f75 7328 293b 2055  gml_time_us(); U
+00015c90: 4e55 5345 4428 745f 656e 6429 3b0a 0a20  NUSED(t_end);.. 
+00015ca0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00015cb0: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
+00015cc0: 2047 454c 552c 2053 494c 5520 616e 6420   GELU, SILU and 
+00015cd0: 4558 5020 7461 626c 6573 2069 6e69 7469  EXP tables initi
+00015ce0: 616c 697a 6564 2069 6e20 2566 206d 735c  alized in %f ms\
+00015cf0: 6e22 2c20 5f5f 6675 6e63 5f5f 2c20 2874  n", __func__, (t
+00015d00: 5f65 6e64 202d 2074 5f73 7461 7274 292f  _end - t_start)/
+00015d10: 3130 3030 2e30 6629 3b0a 2020 2020 2020  1000.0f);.      
+00015d20: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00015d30: 696e 6974 6961 6c69 7a65 2067 5f73 7461  initialize g_sta
+00015d40: 7465 0a20 2020 2020 2020 207b 0a20 2020  te.        {.   
+00015d50: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+00015d60: 696e 7436 345f 7420 745f 7374 6172 7420  int64_t t_start 
+00015d70: 3d20 6767 6d6c 5f74 696d 655f 7573 2829  = ggml_time_us()
+00015d80: 3b20 554e 5553 4544 2874 5f73 7461 7274  ; UNUSED(t_start
+00015d90: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00015da0: 675f 7374 6174 6520 3d20 2873 7472 7563  g_state = (struc
+00015db0: 7420 6767 6d6c 5f73 7461 7465 2920 7b0a  t ggml_state) {.
+00015dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015dd0: 2f2a 2e63 6f6e 7465 7874 7320 3d2a 2f20  /*.contexts =*/ 
+00015de0: 7b20 7b20 3020 7d20 7d2c 0a20 2020 2020  { { 0 } },.     
+00015df0: 2020 2020 2020 207d 3b0a 0a20 2020 2020         };..     
+00015e00: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00015e10: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
+00015e20: 4d41 585f 434f 4e54 4558 5453 3b20 2b2b  MAX_CONTEXTS; ++
+00015e30: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
+00015e40: 2020 2020 2067 5f73 7461 7465 2e63 6f6e       g_state.con
+00015e50: 7465 7874 735b 695d 2e75 7365 6420 3d20  texts[i].used = 
+00015e60: 6661 6c73 653b 0a20 2020 2020 2020 2020  false;.         
+00015e70: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00015e80: 2020 636f 6e73 7420 7569 6e74 3634 5f74    const uint64_t
+00015e90: 2074 5f65 6e64 203d 2067 676d 6c5f 7469   t_end = ggml_ti
+00015ea0: 6d65 5f75 7328 293b 2055 4e55 5345 4428  me_us(); UNUSED(
+00015eb0: 745f 656e 6429 3b0a 0a20 2020 2020 2020  t_end);..       
+00015ec0: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
+00015ed0: 4445 4255 4728 2225 733a 2067 5f73 7461  DEBUG("%s: g_sta
+00015ee0: 7465 2069 6e69 7469 616c 697a 6564 2069  te initialized i
+00015ef0: 6e20 2566 206d 735c 6e22 2c20 5f5f 6675  n %f ms\n", __fu
+00015f00: 6e63 5f5f 2c20 2874 5f65 6e64 202d 2074  nc__, (t_end - t
+00015f10: 5f73 7461 7274 292f 3130 3030 2e30 6629  _start)/1000.0f)
+00015f20: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+00015f30: 2020 2020 2069 735f 6669 7273 745f 6361       is_first_ca
+00015f40: 6c6c 203d 2066 616c 7365 3b0a 2020 2020  ll = false;.    
+00015f50: 7d0a 0a20 2020 202f 2f20 6669 6e64 206e  }..    // find n
+00015f60: 6f6e 2d75 7365 6420 636f 6e74 6578 7420  on-used context 
+00015f70: 696e 2067 5f73 7461 7465 0a20 2020 2073  in g_state.    s
+00015f80: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+00015f90: 7874 202a 2063 7478 203d 204e 554c 4c3b  xt * ctx = NULL;
+00015fa0: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00015fb0: 203d 2030 3b20 6920 3c20 4747 4d4c 5f4d   = 0; i < GGML_M
+00015fc0: 4158 5f43 4f4e 5445 5854 533b 2069 2b2b  AX_CONTEXTS; i++
+00015fd0: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+00015fe0: 2167 5f73 7461 7465 2e63 6f6e 7465 7874  !g_state.context
+00015ff0: 735b 695d 2e75 7365 6429 207b 0a20 2020  s[i].used) {.   
+00016000: 2020 2020 2020 2020 2067 5f73 7461 7465           g_state
+00016010: 2e63 6f6e 7465 7874 735b 695d 2e75 7365  .contexts[i].use
+00016020: 6420 3d20 7472 7565 3b0a 2020 2020 2020  d = true;.      
+00016030: 2020 2020 2020 6374 7820 3d20 2667 5f73        ctx = &g_s
+00016040: 7461 7465 2e63 6f6e 7465 7874 735b 695d  tate.contexts[i]
+00016050: 2e63 6f6e 7465 7874 3b0a 0a20 2020 2020  .context;..     
+00016060: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
+00016070: 545f 4445 4255 4728 2225 733a 2066 6f75  T_DEBUG("%s: fou
+00016080: 6e64 2075 6e75 7365 6420 636f 6e74 6578  nd unused contex
+00016090: 7420 2564 5c6e 222c 205f 5f66 756e 635f  t %d\n", __func_
+000160a0: 5f2c 2069 293b 0a20 2020 2020 2020 2020  _, i);.         
+000160b0: 2020 2062 7265 616b 3b0a 2020 2020 2020     break;.      
+000160c0: 2020 7d0a 2020 2020 7d0a 0a20 2020 2069    }.    }..    i
+000160d0: 6620 2863 7478 203d 3d20 4e55 4c4c 2920  f (ctx == NULL) 
+000160e0: 7b0a 2020 2020 2020 2020 4747 4d4c 5f50  {.        GGML_P
+000160f0: 5249 4e54 5f44 4542 5547 2822 2573 3a20  RINT_DEBUG("%s: 
+00016100: 6e6f 2075 6e75 7365 6420 636f 6e74 6578  no unused contex
+00016110: 7420 666f 756e 645c 6e22 2c20 5f5f 6675  t found\n", __fu
+00016120: 6e63 5f5f 293b 0a0a 2020 2020 2020 2020  nc__);..        
+00016130: 6767 6d6c 5f63 7269 7469 6361 6c5f 7365  ggml_critical_se
+00016140: 6374 696f 6e5f 656e 6428 293b 0a0a 2020  ction_end();..  
+00016150: 2020 2020 2020 7265 7475 726e 204e 554c        return NUL
+00016160: 4c3b 0a20 2020 207d 0a0a 2020 2020 2a63  L;.    }..    *c
+00016170: 7478 203d 2028 7374 7275 6374 2067 676d  tx = (struct ggm
+00016180: 6c5f 636f 6e74 6578 7429 207b 0a20 2020  l_context) {.   
+00016190: 2020 2020 202f 2a2e 6d65 6d5f 7369 7a65       /*.mem_size
+000161a0: 2020 2020 2020 2020 2020 203d 2a2f 2070             =*/ p
+000161b0: 6172 616d 732e 6d65 6d5f 7369 7a65 2c0a  arams.mem_size,.
+000161c0: 2020 2020 2020 2020 2f2a 2e6d 656d 5f62          /*.mem_b
+000161d0: 7566 6665 7220 2020 2020 2020 2020 3d2a  uffer         =*
+000161e0: 2f20 7061 7261 6d73 2e6d 656d 5f62 7566  / params.mem_buf
+000161f0: 6665 7220 3f20 7061 7261 6d73 2e6d 656d  fer ? params.mem
+00016200: 5f62 7566 6665 7220 3a20 6d61 6c6c 6f63  _buffer : malloc
+00016210: 2870 6172 616d 732e 6d65 6d5f 7369 7a65  (params.mem_size
+00016220: 292c 0a20 2020 2020 2020 202f 2a2e 6d65  ),.        /*.me
+00016230: 6d5f 6275 6666 6572 5f6f 776e 6564 2020  m_buffer_owned  
+00016240: 203d 2a2f 2070 6172 616d 732e 6d65 6d5f   =*/ params.mem_
+00016250: 6275 6666 6572 203f 2066 616c 7365 203a  buffer ? false :
+00016260: 2074 7275 652c 0a20 2020 2020 2020 202f   true,.        /
+00016270: 2a2e 6d65 6d5f 6275 6666 6572 5f6d 6c6f  *.mem_buffer_mlo
+00016280: 636b 6564 203d 2a2f 2066 616c 7365 2c0a  cked =*/ false,.
+00016290: 2020 2020 2020 2020 2f2a 2e6e 5f6f 626a          /*.n_obj
+000162a0: 6563 7473 2020 2020 2020 2020 2020 3d2a  ects          =*
+000162b0: 2f20 302c 0a20 2020 2020 2020 202f 2a2e  / 0,.        /*.
+000162c0: 6f62 6a65 6374 735f 6265 6769 6e20 2020  objects_begin   
+000162d0: 2020 203d 2a2f 204e 554c 4c2c 0a20 2020     =*/ NULL,.   
+000162e0: 2020 2020 202f 2a2e 6f62 6a65 6374 735f       /*.objects_
+000162f0: 656e 6420 2020 2020 2020 203d 2a2f 204e  end        =*/ N
+00016300: 554c 4c2c 0a20 2020 2020 2020 202f 2a2e  ULL,.        /*.
+00016310: 7363 7261 7463 6820 2020 2020 2020 2020  scratch         
+00016320: 2020 203d 2a2f 207b 2030 2c20 302c 204e     =*/ { 0, 0, N
+00016330: 554c 4c2c 207d 2c0a 2020 2020 2020 2020  ULL, },.        
+00016340: 2f2a 2e73 6372 6174 6368 5f73 6176 6520  /*.scratch_save 
+00016350: 2020 2020 2020 3d2a 2f20 7b20 302c 2030        =*/ { 0, 0
+00016360: 2c20 4e55 4c4c 2c20 7d2c 0a20 2020 207d  , NULL, },.    }
+00016370: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00016380: 5254 2863 7478 2d3e 6d65 6d5f 6275 6666  RT(ctx->mem_buff
+00016390: 6572 2021 3d20 4e55 4c4c 293b 202f 2f20  er != NULL); // 
+000163a0: 6368 6563 6b20 666f 7220 616c 6c6f 6361  check for alloca
+000163b0: 7469 6f6e 2066 6169 6c75 7265 0a0a 2020  tion failure..  
+000163c0: 2020 6767 6d6c 5f61 7373 6572 745f 616c    ggml_assert_al
+000163d0: 6967 6e65 6428 6374 782d 3e6d 656d 5f62  igned(ctx->mem_b
+000163e0: 7566 6665 7229 3b0a 0a20 2020 2047 474d  uffer);..    GGM
+000163f0: 4c5f 5052 494e 545f 4445 4255 4728 2225  L_PRINT_DEBUG("%
+00016400: 733a 2063 6f6e 7465 7874 2069 6e69 7469  s: context initi
+00016410: 616c 697a 6564 5c6e 222c 205f 5f66 756e  alized\n", __fun
+00016420: 635f 5f29 3b0a 0a20 2020 2067 676d 6c5f  c__);..    ggml_
+00016430: 6372 6974 6963 616c 5f73 6563 7469 6f6e  critical_section
+00016440: 5f65 6e64 2829 3b0a 0a20 2020 2072 6574  _end();..    ret
+00016450: 7572 6e20 6374 783b 0a7d 0a0a 766f 6964  urn ctx;.}..void
+00016460: 2067 676d 6c5f 6672 6565 2873 7472 7563   ggml_free(struc
+00016470: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00016480: 2063 7478 2920 7b0a 2020 2020 2f2f 206d   ctx) {.    // m
+00016490: 616b 6520 7468 6973 2066 756e 6374 696f  ake this functio
+000164a0: 6e20 7468 7265 6164 2073 6166 650a 2020  n thread safe.  
+000164b0: 2020 6767 6d6c 5f63 7269 7469 6361 6c5f    ggml_critical_
+000164c0: 7365 6374 696f 6e5f 7374 6172 7428 293b  section_start();
+000164d0: 0a0a 2020 2020 626f 6f6c 2066 6f75 6e64  ..    bool found
+000164e0: 203d 2066 616c 7365 3b0a 0a20 2020 2066   = false;..    f
+000164f0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00016500: 203c 2047 474d 4c5f 4d41 585f 434f 4e54   < GGML_MAX_CONT
+00016510: 4558 5453 3b20 692b 2b29 207b 0a20 2020  EXTS; i++) {.   
+00016520: 2020 2020 2069 6620 2826 675f 7374 6174       if (&g_stat
+00016530: 652e 636f 6e74 6578 7473 5b69 5d2e 636f  e.contexts[i].co
+00016540: 6e74 6578 7420 3d3d 2063 7478 2920 7b0a  ntext == ctx) {.
+00016550: 2020 2020 2020 2020 2020 2020 675f 7374              g_st
+00016560: 6174 652e 636f 6e74 6578 7473 5b69 5d2e  ate.contexts[i].
+00016570: 7573 6564 203d 2066 616c 7365 3b0a 0a20  used = false;.. 
+00016580: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00016590: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
+000165a0: 2063 6f6e 7465 7874 2025 6420 7769 7468   context %d with
+000165b0: 2025 6420 6f62 6a65 6374 7320 6861 7320   %d objects has 
+000165c0: 6265 656e 2066 7265 6564 2e20 6d65 6d6f  been freed. memo
+000165d0: 7279 2075 7365 6420 3d20 257a 755c 6e22  ry used = %zu\n"
+000165e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000165f0: 2020 2020 2020 5f5f 6675 6e63 5f5f 2c20        __func__, 
+00016600: 692c 2063 7478 2d3e 6e5f 6f62 6a65 6374  i, ctx->n_object
+00016610: 732c 2063 7478 2d3e 6f62 6a65 6374 735f  s, ctx->objects_
+00016620: 656e 642d 3e6f 6666 7320 2b20 6374 782d  end->offs + ctx-
+00016630: 3e6f 626a 6563 7473 5f65 6e64 2d3e 7369  >objects_end->si
+00016640: 7a65 293b 0a0a 2369 6620 4747 4d4c 5f4d  ze);..#if GGML_M
+00016650: 4c4f 434b 5f53 5550 504f 5254 0a20 2020  LOCK_SUPPORT.   
+00016660: 2020 2020 2020 2020 2069 6620 2863 7478           if (ctx
+00016670: 2d3e 6d65 6d5f 6275 6666 6572 5f6d 6c6f  ->mem_buffer_mlo
+00016680: 636b 6564 2920 7b0a 2020 2020 2020 2020  cked) {.        
+00016690: 2020 2020 2020 2020 6966 2028 6d75 6e6c          if (munl
+000166a0: 6f63 6b28 6374 782d 3e6d 656d 5f62 7566  ock(ctx->mem_buf
+000166b0: 6665 722c 2063 7478 2d3e 6d65 6d5f 7369  fer, ctx->mem_si
+000166c0: 7a65 2929 207b 0a20 2020 2020 2020 2020  ze)) {.         
+000166d0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+000166e0: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
+000166f0: 6661 696c 6564 2074 6f20 6d75 6e6c 6f63  failed to munloc
+00016700: 6b20 6275 6666 6572 3a20 2573 5c6e 222c  k buffer: %s\n",
+00016710: 205f 5f66 756e 635f 5f2c 2073 7472 6572   __func__, strer
+00016720: 726f 7228 6572 726e 6f29 293b 0a20 2020  ror(errno));.   
+00016730: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00016740: 2020 2020 2020 2020 2020 207d 0a23 656e             }.#en
+00016750: 6469 660a 0a20 2020 2020 2020 2020 2020  dif..           
+00016760: 2069 6620 2863 7478 2d3e 6d65 6d5f 6275   if (ctx->mem_bu
+00016770: 6666 6572 5f6f 776e 6564 2920 7b0a 2020  ffer_owned) {.  
+00016780: 2020 2020 2020 2020 2020 2020 2020 6672                fr
+00016790: 6565 2863 7478 2d3e 6d65 6d5f 6275 6666  ee(ctx->mem_buff
+000167a0: 6572 293b 0a20 2020 2020 2020 2020 2020  er);.           
+000167b0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+000167c0: 666f 756e 6420 3d20 7472 7565 3b0a 2020  found = true;.  
+000167d0: 2020 2020 2020 2020 2020 6272 6561 6b3b            break;
+000167e0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+000167f0: 0a0a 2020 2020 6966 2028 2166 6f75 6e64  ..    if (!found
+00016800: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
+00016810: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
+00016820: 3a20 636f 6e74 6578 7420 6e6f 7420 666f  : context not fo
+00016830: 756e 645c 6e22 2c20 5f5f 6675 6e63 5f5f  und\n", __func__
+00016840: 293b 0a20 2020 207d 0a0a 2020 2020 6767  );.    }..    gg
+00016850: 6d6c 5f63 7269 7469 6361 6c5f 7365 6374  ml_critical_sect
+00016860: 696f 6e5f 656e 6428 293b 0a7d 0a0a 7369  ion_end();.}..si
+00016870: 7a65 5f74 2067 676d 6c5f 7573 6564 5f6d  ze_t ggml_used_m
+00016880: 656d 2863 6f6e 7374 2073 7472 7563 7420  em(const struct 
+00016890: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+000168a0: 7478 2920 7b0a 2020 2020 7265 7475 726e  tx) {.    return
+000168b0: 2063 7478 2d3e 6f62 6a65 6374 735f 656e   ctx->objects_en
+000168c0: 642d 3e6f 6666 7320 2b20 6374 782d 3e6f  d->offs + ctx->o
+000168d0: 626a 6563 7473 5f65 6e64 2d3e 7369 7a65  bjects_end->size
+000168e0: 3b0a 7d0a 0a73 697a 655f 7420 6767 6d6c  ;.}..size_t ggml
+000168f0: 5f73 6574 5f73 6372 6174 6368 2873 7472  _set_scratch(str
+00016900: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00016910: 202a 2063 7478 2c20 7374 7275 6374 2067   * ctx, struct g
+00016920: 676d 6c5f 7363 7261 7463 6820 7363 7261  gml_scratch scra
+00016930: 7463 6829 207b 0a20 2020 2063 6f6e 7374  tch) {.    const
+00016940: 2073 697a 655f 7420 7265 7375 6c74 203d   size_t result =
+00016950: 2063 7478 2d3e 7363 7261 7463 682e 6461   ctx->scratch.da
+00016960: 7461 203f 2063 7478 2d3e 7363 7261 7463  ta ? ctx->scratc
+00016970: 682e 6f66 6673 203a 2030 3b0a 0a20 2020  h.offs : 0;..   
+00016980: 2063 7478 2d3e 7363 7261 7463 6820 3d20   ctx->scratch = 
+00016990: 7363 7261 7463 683b 0a0a 2020 2020 7265  scratch;..    re
+000169a0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+000169b0: 626f 6f6c 2067 676d 6c5f 6d6c 6f63 6b5f  bool ggml_mlock_
+000169c0: 7375 7070 6f72 7465 6428 766f 6964 2920  supported(void) 
+000169d0: 7b0a 2020 2020 7265 7475 726e 2047 474d  {.    return GGM
+000169e0: 4c5f 4d4c 4f43 4b5f 5355 5050 4f52 543b  L_MLOCK_SUPPORT;
+000169f0: 0a7d 0a0a 2369 6620 4747 4d4c 5f4d 4c4f  .}..#if GGML_MLO
+00016a00: 434b 5f53 5550 504f 5254 0a23 6966 6465  CK_SUPPORT.#ifde
+00016a10: 6620 5f5f 4150 504c 455f 5f0a 2020 2020  f __APPLE__.    
+00016a20: 2364 6566 696e 6520 4d4c 4f43 4b5f 5355  #define MLOCK_SU
+00016a30: 4747 4553 5449 4f4e 2022 5472 7920 696e  GGESTION "Try in
+00016a40: 6372 6561 7369 6e67 2074 6865 2073 7973  creasing the sys
+00016a50: 6374 6c20 7661 6c75 6573 2027 766d 2e75  ctl values 'vm.u
+00016a60: 7365 725f 7769 7265 5f6c 696d 6974 2720  ser_wire_limit' 
+00016a70: 616e 6420 2776 6d2e 676c 6f62 616c 5f75  and 'vm.global_u
+00016a80: 7365 725f 7769 7265 5f6c 696d 6974 2720  ser_wire_limit' 
+00016a90: 616e 642f 6f72 5c6e 2220 5c0a 2020 2020  and/or\n" \.    
+00016aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ab0: 2020 2020 2020 2020 2022 6465 6372 6561           "decrea
+00016ac0: 7369 6e67 2027 766d 2e67 6c6f 6261 6c5f  sing 'vm.global_
+00016ad0: 6e6f 5f75 7365 725f 7769 7265 5f61 6d6f  no_user_wire_amo
+00016ae0: 756e 7427 2e20 2041 6c73 6f20 7472 7920  unt'.  Also try 
+00016af0: 696e 6372 6561 7369 6e67 2052 4c49 4d49  increasing RLIMI
+00016b00: 545f 4d4c 4f43 4b20 2875 6c69 6d69 7420  T_MLOCK (ulimit 
+00016b10: 2d6c 292e 220a 2365 6c73 650a 2020 2020  -l).".#else.    
+00016b20: 2364 6566 696e 6520 4d4c 4f43 4b5f 5355  #define MLOCK_SU
+00016b30: 4747 4553 5449 4f4e 2022 5472 7920 696e  GGESTION "Try in
+00016b40: 6372 6561 7369 6e67 2052 4c49 4d49 545f  creasing RLIMIT_
+00016b50: 4d4c 4f43 4b20 2875 6c69 6d69 7420 2d6c  MLOCK (ulimit -l
+00016b60: 292e 220a 2365 6e64 6966 0a62 6f6f 6c20  ).".#endif.bool 
+00016b70: 6767 6d6c 5f6d 6c6f 636b 2873 7472 7563  ggml_mlock(struc
+00016b80: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00016b90: 2063 7478 2c20 6368 6172 202a 2a20 6572   ctx, char ** er
+00016ba0: 725f 7029 207b 0a20 2020 2069 6620 2863  r_p) {.    if (c
+00016bb0: 7478 2d3e 6d65 6d5f 6275 6666 6572 5f6d  tx->mem_buffer_m
+00016bc0: 6c6f 636b 6564 2920 7b0a 2020 2020 2020  locked) {.      
+00016bd0: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
+00016be0: 2020 207d 0a20 2020 2069 6620 286d 6c6f     }.    if (mlo
+00016bf0: 636b 2863 7478 2d3e 6d65 6d5f 6275 6666  ck(ctx->mem_buff
+00016c00: 6572 2c20 6374 782d 3e6d 656d 5f73 697a  er, ctx->mem_siz
+00016c10: 6529 2920 7b0a 2020 2020 2020 2020 696e  e)) {.        in
+00016c20: 7420 7265 7420 3d20 6173 7072 696e 7466  t ret = asprintf
+00016c30: 2865 7272 5f70 2c20 2266 6169 6c65 6420  (err_p, "failed 
+00016c40: 746f 206d 6c6f 636b 2025 7a75 2d62 7974  to mlock %zu-byt
+00016c50: 6520 6275 6666 6572 3a20 2573 5c6e 2220  e buffer: %s\n" 
+00016c60: 4d4c 4f43 4b5f 5355 4747 4553 5449 4f4e  MLOCK_SUGGESTION
+00016c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016c80: 2020 2020 2020 2020 2020 2020 2063 7478               ctx
+00016c90: 2d3e 6d65 6d5f 7369 7a65 2c20 7374 7265  ->mem_size, stre
+00016ca0: 7272 6f72 2865 7272 6e6f 2929 3b0a 2020  rror(errno));.  
+00016cb0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00016cc0: 5428 7265 7420 3e3d 2030 293b 0a20 2020  T(ret >= 0);.   
+00016cd0: 2020 2020 2072 6574 7572 6e20 6661 6c73       return fals
+00016ce0: 653b 0a20 2020 207d 0a20 2020 2063 7478  e;.    }.    ctx
+00016cf0: 2d3e 6d65 6d5f 6275 6666 6572 5f6d 6c6f  ->mem_buffer_mlo
+00016d00: 636b 6564 203d 2074 7275 653b 0a20 2020  cked = true;.   
+00016d10: 2072 6574 7572 6e20 7472 7565 3b0a 7d0a   return true;.}.
+00016d20: 2365 6c73 6520 2f2f 2047 474d 4c5f 4d4c  #else // GGML_ML
+00016d30: 4f43 4b5f 5355 5050 4f52 540a 626f 6f6c  OCK_SUPPORT.bool
+00016d40: 2067 676d 6c5f 6d6c 6f63 6b28 7374 7275   ggml_mlock(stru
+00016d50: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00016d60: 2a20 6374 782c 2063 6861 7220 2a2a 2065  * ctx, char ** e
+00016d70: 7272 5f70 2920 7b0a 2020 2020 2a65 7272  rr_p) {.    *err
+00016d80: 5f70 203d 2073 7472 6475 7028 2263 616e  _p = strdup("can
+00016d90: 2774 206d 6c6f 636b 2062 6563 6175 7365  't mlock because
+00016da0: 2069 7427 7320 6e6f 7420 7375 7070 6f72   it's not suppor
+00016db0: 7465 6420 6f6e 2074 6869 7320 7379 7374  ted on this syst
+00016dc0: 656d 2229 3b0a 2020 2020 7265 7475 726e  em");.    return
+00016dd0: 2066 616c 7365 3b0a 7d0a 2365 6e64 6966   false;.}.#endif
+00016de0: 202f 2f20 4747 4d4c 5f4d 4c4f 434b 5f53   // GGML_MLOCK_S
+00016df0: 5550 504f 5254 0a0a 2f2f 2f2f 2f2f 2f2f  UPPORT..////////
+00016e00: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00016e10: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00016e20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00016e30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00016e40: 2f2f 2f2f 2f2f 2f2f 0a0a 7374 7275 6374  ////////..struct
+00016e50: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+00016e60: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f69  gml_new_tensor_i
+00016e70: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+00016e80: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00016e90: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+00016ea0: 656e 756d 2020 2067 676d 6c5f 7479 7065  enum   ggml_type
+00016eb0: 2074 7970 652c 0a20 2020 2020 2020 2069   type,.        i
+00016ec0: 6e74 2020 2020 6e5f 6469 6d73 2c0a 2020  nt    n_dims,.  
+00016ed0: 2020 2020 2020 636f 6e73 7420 696e 742a        const int*
+00016ee0: 206e 652c 0a20 2020 2020 2020 2076 6f69   ne,.        voi
+00016ef0: 642a 2020 6461 7461 2920 7b0a 2020 2020  d*  data) {.    
+00016f00: 2f2f 2061 6c77 6179 7320 696e 7365 7274  // always insert
+00016f10: 206f 626a 6563 7473 2061 7420 7468 6520   objects at the 
+00016f20: 656e 6420 6f66 2074 6865 2063 6f6e 7465  end of the conte
+00016f30: 7874 2773 206d 656d 6f72 7920 706f 6f6c  xt's memory pool
+00016f40: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00016f50: 5f6f 626a 6563 7420 2a20 6f62 6a5f 6375  _object * obj_cu
+00016f60: 7220 3d20 6374 782d 3e6f 626a 6563 7473  r = ctx->objects
+00016f70: 5f65 6e64 3b0a 0a20 2020 2063 6f6e 7374  _end;..    const
+00016f80: 2073 697a 655f 7420 6375 725f 6f66 6673   size_t cur_offs
+00016f90: 203d 206f 626a 5f63 7572 203d 3d20 4e55   = obj_cur == NU
+00016fa0: 4c4c 203f 2030 203a 206f 626a 5f63 7572  LL ? 0 : obj_cur
+00016fb0: 2d3e 6f66 6673 3b0a 2020 2020 636f 6e73  ->offs;.    cons
+00016fc0: 7420 7369 7a65 5f74 2063 7572 5f73 697a  t size_t cur_siz
+00016fd0: 6520 3d20 6f62 6a5f 6375 7220 3d3d 204e  e = obj_cur == N
+00016fe0: 554c 4c20 3f20 3020 3a20 6f62 6a5f 6375  ULL ? 0 : obj_cu
+00016ff0: 722d 3e73 697a 653b 0a20 2020 2063 6f6e  r->size;.    con
+00017000: 7374 2073 697a 655f 7420 6375 725f 656e  st size_t cur_en
+00017010: 6420 203d 2063 7572 5f6f 6666 7320 2b20  d  = cur_offs + 
+00017020: 6375 725f 7369 7a65 3b0a 0a20 2020 2073  cur_size;..    s
+00017030: 697a 655f 7420 7369 7a65 5f6e 6565 6465  ize_t size_neede
+00017040: 6420 3d20 303b 0a0a 2020 2020 6966 2028  d = 0;..    if (
+00017050: 6461 7461 203d 3d20 4e55 4c4c 2920 7b0a  data == NULL) {.
+00017060: 2020 2020 2020 2020 7369 7a65 5f6e 6565          size_nee
+00017070: 6465 6420 2b3d 2047 474d 4c5f 5459 5045  ded += GGML_TYPE
+00017080: 5f53 495a 455b 7479 7065 5d2a 286e 655b  _SIZE[type]*(ne[
+00017090: 305d 2f47 474d 4c5f 424c 434b 5f53 495a  0]/GGML_BLCK_SIZ
+000170a0: 455b 7479 7065 5d29 3b0a 2020 2020 2020  E[type]);.      
+000170b0: 2020 666f 7220 2869 6e74 2069 203d 2031    for (int i = 1
+000170c0: 3b20 6920 3c20 6e5f 6469 6d73 3b20 692b  ; i < n_dims; i+
+000170d0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000170e0: 2073 697a 655f 6e65 6564 6564 202a 3d20   size_needed *= 
+000170f0: 6e65 5b69 5d3b 0a20 2020 2020 2020 207d  ne[i];.        }
+00017100: 0a20 2020 2020 2020 202f 2f20 616c 6967  .        // alig
+00017110: 6e20 746f 2047 474d 4c5f 4d45 4d5f 414c  n to GGML_MEM_AL
+00017120: 4947 4e0a 2020 2020 2020 2020 7369 7a65  IGN.        size
+00017130: 5f6e 6565 6465 6420 3d20 2828 7369 7a65  _needed = ((size
+00017140: 5f6e 6565 6465 6420 2b20 4747 4d4c 5f4d  _needed + GGML_M
+00017150: 454d 5f41 4c49 474e 202d 2031 292f 4747  EM_ALIGN - 1)/GG
+00017160: 4d4c 5f4d 454d 5f41 4c49 474e 292a 4747  ML_MEM_ALIGN)*GG
+00017170: 4d4c 5f4d 454d 5f41 4c49 474e 3b0a 2020  ML_MEM_ALIGN;.  
+00017180: 2020 7d0a 0a20 2020 2063 6861 7220 2a20    }..    char * 
+00017190: 636f 6e73 7420 6d65 6d5f 6275 6666 6572  const mem_buffer
+000171a0: 203d 2063 7478 2d3e 6d65 6d5f 6275 6666   = ctx->mem_buff
+000171b0: 6572 3b0a 2020 2020 7374 7275 6374 2067  er;.    struct g
+000171c0: 676d 6c5f 6f62 6a65 6374 202a 2063 6f6e  gml_object * con
+000171d0: 7374 206f 626a 5f6e 6577 203d 2028 7374  st obj_new = (st
+000171e0: 7275 6374 2067 676d 6c5f 6f62 6a65 6374  ruct ggml_object
+000171f0: 202a 2928 6d65 6d5f 6275 6666 6572 202b   *)(mem_buffer +
+00017200: 2063 7572 5f65 6e64 293b 0a0a 2020 2020   cur_end);..    
+00017210: 6966 2028 6374 782d 3e73 6372 6174 6368  if (ctx->scratch
+00017220: 2e64 6174 6120 3d3d 204e 554c 4c20 7c7c  .data == NULL ||
+00017230: 2064 6174 6120 213d 204e 554c 4c29 207b   data != NULL) {
+00017240: 0a20 2020 2020 2020 2073 697a 655f 6e65  .        size_ne
+00017250: 6564 6564 202b 3d20 7369 7a65 6f66 2873  eded += sizeof(s
+00017260: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00017270: 7229 3b0a 0a20 2020 2020 2020 2069 6620  r);..        if 
+00017280: 2863 7572 5f65 6e64 202b 2073 697a 655f  (cur_end + size_
+00017290: 6e65 6564 6564 202b 2047 474d 4c5f 4f42  needed + GGML_OB
+000172a0: 4a45 4354 5f53 495a 4520 3e20 6374 782d  JECT_SIZE > ctx-
+000172b0: 3e6d 656d 5f73 697a 6529 207b 0a20 2020  >mem_size) {.   
+000172c0: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
+000172d0: 494e 5428 2225 733a 206e 6f74 2065 6e6f  INT("%s: not eno
+000172e0: 7567 6820 7370 6163 6520 696e 2074 6865  ugh space in the
+000172f0: 2063 6f6e 7465 7874 2773 206d 656d 6f72   context's memor
+00017300: 7920 706f 6f6c 2028 6e65 6564 6564 2025  y pool (needed %
+00017310: 7a75 2c20 6176 6169 6c61 626c 6520 257a  zu, available %z
+00017320: 7529 5c6e 222c 0a20 2020 2020 2020 2020  u)\n",.         
+00017330: 2020 2020 2020 2020 2020 205f 5f66 756e             __fun
+00017340: 635f 5f2c 2063 7572 5f65 6e64 202b 2073  c__, cur_end + s
+00017350: 697a 655f 6e65 6564 6564 202b 2047 474d  ize_needed + GGM
+00017360: 4c5f 4f42 4a45 4354 5f53 495a 452c 2063  L_OBJECT_SIZE, c
+00017370: 7478 2d3e 6d65 6d5f 7369 7a65 293b 0a20  tx->mem_size);. 
+00017380: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00017390: 7428 6661 6c73 6529 3b0a 2020 2020 2020  t(false);.      
+000173a0: 2020 2020 2020 7265 7475 726e 204e 554c        return NUL
+000173b0: 4c3b 0a20 2020 2020 2020 207d 0a0a 2020  L;.        }..  
+000173c0: 2020 2020 2020 2a6f 626a 5f6e 6577 203d        *obj_new =
+000173d0: 2028 7374 7275 6374 2067 676d 6c5f 6f62   (struct ggml_ob
+000173e0: 6a65 6374 2920 7b0a 2020 2020 2020 2020  ject) {.        
+000173f0: 2020 2020 2e6f 6666 7320 3d20 6375 725f      .offs = cur_
+00017400: 656e 6420 2b20 4747 4d4c 5f4f 424a 4543  end + GGML_OBJEC
+00017410: 545f 5349 5a45 2c0a 2020 2020 2020 2020  T_SIZE,.        
+00017420: 2020 2020 2e73 697a 6520 3d20 7369 7a65      .size = size
+00017430: 5f6e 6565 6465 642c 0a20 2020 2020 2020  _needed,.       
+00017440: 2020 2020 202e 6e65 7874 203d 204e 554c       .next = NUL
+00017450: 4c2c 0a20 2020 2020 2020 207d 3b0a 2020  L,.        };.  
+00017460: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00017470: 2020 2069 6620 2863 7478 2d3e 7363 7261     if (ctx->scra
+00017480: 7463 682e 6f66 6673 202b 2073 697a 655f  tch.offs + size_
+00017490: 6e65 6564 6564 203e 2063 7478 2d3e 7363  needed > ctx->sc
+000174a0: 7261 7463 682e 7369 7a65 2920 7b0a 2020  ratch.size) {.  
+000174b0: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
+000174c0: 5249 4e54 2822 2573 3a20 6e6f 7420 656e  RINT("%s: not en
+000174d0: 6f75 6768 2073 7061 6365 2069 6e20 7468  ough space in th
+000174e0: 6520 7363 7261 7463 6820 6d65 6d6f 7279  e scratch memory
+000174f0: 5c6e 222c 205f 5f66 756e 635f 5f29 3b0a  \n", __func__);.
+00017500: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00017510: 7274 2866 616c 7365 293b 0a20 2020 2020  rt(false);.     
+00017520: 2020 2020 2020 2072 6574 7572 6e20 4e55         return NU
+00017530: 4c4c 3b0a 2020 2020 2020 2020 7d0a 0a20  LL;.        }.. 
+00017540: 2020 2020 2020 2069 6620 2863 7572 5f65         if (cur_e
+00017550: 6e64 202b 2073 697a 656f 6628 7374 7275  nd + sizeof(stru
+00017560: 6374 2067 676d 6c5f 7465 6e73 6f72 2920  ct ggml_tensor) 
+00017570: 2b20 4747 4d4c 5f4f 424a 4543 545f 5349  + GGML_OBJECT_SI
+00017580: 5a45 203e 2063 7478 2d3e 6d65 6d5f 7369  ZE > ctx->mem_si
+00017590: 7a65 2920 7b0a 2020 2020 2020 2020 2020  ze) {.          
+000175a0: 2020 4747 4d4c 5f50 5249 4e54 2822 2573    GGML_PRINT("%s
+000175b0: 3a20 6e6f 7420 656e 6f75 6768 2073 7061  : not enough spa
+000175c0: 6365 2069 6e20 7468 6520 636f 6e74 6578  ce in the contex
+000175d0: 7427 7320 6d65 6d6f 7279 2070 6f6f 6c20  t's memory pool 
+000175e0: 286e 6565 6465 6420 257a 752c 2061 7661  (needed %zu, ava
+000175f0: 696c 6162 6c65 2025 7a75 295c 6e22 2c0a  ilable %zu)\n",.
+00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017610: 2020 2020 5f5f 6675 6e63 5f5f 2c20 6375      __func__, cu
+00017620: 725f 656e 6420 2b20 7369 7a65 6f66 2873  r_end + sizeof(s
+00017630: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00017640: 7229 202b 2047 474d 4c5f 4f42 4a45 4354  r) + GGML_OBJECT
+00017650: 5f53 495a 452c 2063 7478 2d3e 6d65 6d5f  _SIZE, ctx->mem_
+00017660: 7369 7a65 293b 0a20 2020 2020 2020 2020  size);.         
+00017670: 2020 2061 7373 6572 7428 6661 6c73 6529     assert(false)
+00017680: 3b0a 2020 2020 2020 2020 2020 2020 7265  ;.            re
+00017690: 7475 726e 204e 554c 4c3b 0a20 2020 2020  turn NULL;.     
+000176a0: 2020 207d 0a0a 2020 2020 2020 2020 6461     }..        da
+000176b0: 7461 203d 2028 6368 6172 202a 2063 6f6e  ta = (char * con
+000176c0: 7374 2920 6374 782d 3e73 6372 6174 6368  st) ctx->scratch
+000176d0: 2e64 6174 6120 2b20 6374 782d 3e73 6372  .data + ctx->scr
+000176e0: 6174 6368 2e6f 6666 733b 0a0a 2020 2020  atch.offs;..    
+000176f0: 2020 2020 2a6f 626a 5f6e 6577 203d 2028      *obj_new = (
+00017700: 7374 7275 6374 2067 676d 6c5f 6f62 6a65  struct ggml_obje
+00017710: 6374 2920 7b0a 2020 2020 2020 2020 2020  ct) {.          
+00017720: 2020 2e6f 6666 7320 3d20 6375 725f 656e    .offs = cur_en
+00017730: 6420 2b20 4747 4d4c 5f4f 424a 4543 545f  d + GGML_OBJECT_
+00017740: 5349 5a45 2c0a 2020 2020 2020 2020 2020  SIZE,.          
+00017750: 2020 2e73 697a 6520 3d20 7369 7a65 6f66    .size = sizeof
+00017760: 2873 7472 7563 7420 6767 6d6c 5f74 656e  (struct ggml_ten
+00017770: 736f 7229 2c0a 2020 2020 2020 2020 2020  sor),.          
+00017780: 2020 2e6e 6578 7420 3d20 4e55 4c4c 2c0a    .next = NULL,.
+00017790: 2020 2020 2020 2020 7d3b 0a0a 2020 2020          };..    
+000177a0: 2020 2020 2f2f 7072 696e 7466 2822 7363      //printf("sc
+000177b0: 7261 7463 6820 6f66 6673 203d 2025 7a75  ratch offs = %zu
+000177c0: 2c20 7369 7a65 5f6e 6565 6465 6420 3d20  , size_needed = 
+000177d0: 257a 755c 6e22 2c20 6374 782d 3e73 6372  %zu\n", ctx->scr
+000177e0: 6174 6368 2e6f 6666 732c 2073 697a 655f  atch.offs, size_
+000177f0: 6e65 6564 6564 293b 0a0a 2020 2020 2020  needed);..      
+00017800: 2020 6374 782d 3e73 6372 6174 6368 2e6f    ctx->scratch.o
+00017810: 6666 7320 2b3d 2073 697a 655f 6e65 6564  ffs += size_need
+00017820: 6564 3b0a 2020 2020 7d0a 0a20 2020 2069  ed;.    }..    i
+00017830: 6620 286f 626a 5f63 7572 2021 3d20 4e55  f (obj_cur != NU
+00017840: 4c4c 2920 7b0a 2020 2020 2020 2020 6f62  LL) {.        ob
+00017850: 6a5f 6375 722d 3e6e 6578 7420 3d20 6f62  j_cur->next = ob
+00017860: 6a5f 6e65 773b 0a20 2020 207d 2065 6c73  j_new;.    } els
+00017870: 6520 7b0a 2020 2020 2020 2020 2f2f 2074  e {.        // t
+00017880: 6869 7320 6973 2074 6865 2066 6972 7374  his is the first
+00017890: 206f 626a 6563 7420 696e 2074 6869 7320   object in this 
+000178a0: 636f 6e74 6578 740a 2020 2020 2020 2020  context.        
+000178b0: 6374 782d 3e6f 626a 6563 7473 5f62 6567  ctx->objects_beg
+000178c0: 696e 203d 206f 626a 5f6e 6577 3b0a 2020  in = obj_new;.  
+000178d0: 2020 7d0a 0a20 2020 2063 7478 2d3e 6f62    }..    ctx->ob
+000178e0: 6a65 6374 735f 656e 6420 3d20 6f62 6a5f  jects_end = obj_
+000178f0: 6e65 773b 0a0a 2020 2020 2f2f 7072 696e  new;..    //prin
+00017900: 7466 2822 2573 3a20 696e 7365 7274 6564  tf("%s: inserted
+00017910: 206e 6577 206f 626a 6563 7420 6174 2025   new object at %
+00017920: 7a75 2c20 7369 7a65 203d 2025 7a75 5c6e  zu, size = %zu\n
+00017930: 222c 205f 5f66 756e 635f 5f2c 2063 7572  ", __func__, cur
+00017940: 5f65 6e64 2c20 6f62 6a5f 6e65 772d 3e73  _end, obj_new->s
+00017950: 697a 6529 3b0a 0a20 2020 2073 7472 7563  ize);..    struc
+00017960: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00017970: 636f 6e73 7420 7265 7375 6c74 203d 2028  const result = (
+00017980: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00017990: 6f72 202a 2928 6d65 6d5f 6275 6666 6572  or *)(mem_buffer
+000179a0: 202b 206f 626a 5f6e 6577 2d3e 6f66 6673   + obj_new->offs
+000179b0: 293b 0a0a 2020 2020 6767 6d6c 5f61 7373  );..    ggml_ass
+000179c0: 6572 745f 616c 6967 6e65 6428 7265 7375  ert_aligned(resu
+000179d0: 6c74 293b 0a0a 2020 2020 2a72 6573 756c  lt);..    *resul
+000179e0: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
+000179f0: 5f74 656e 736f 7229 207b 0a20 2020 2020  _tensor) {.     
+00017a00: 2020 202f 2a2e 7479 7065 2020 2020 2020     /*.type      
+00017a10: 2020 203d 2a2f 2074 7970 652c 0a20 2020     =*/ type,.   
+00017a20: 2020 2020 202f 2a2e 6e5f 6469 6d73 2020       /*.n_dims  
+00017a30: 2020 2020 203d 2a2f 206e 5f64 696d 732c       =*/ n_dims,
+00017a40: 0a20 2020 2020 2020 202f 2a2e 6e65 2020  .        /*.ne  
+00017a50: 2020 2020 2020 2020 203d 2a2f 207b 2031           =*/ { 1
+00017a60: 2c20 312c 2031 2c20 3120 7d2c 0a20 2020  , 1, 1, 1 },.   
+00017a70: 2020 2020 202f 2a2e 6e62 2020 2020 2020       /*.nb      
+00017a80: 2020 2020 203d 2a2f 207b 2030 2c20 302c       =*/ { 0, 0,
+00017a90: 2030 2c20 3020 7d2c 0a20 2020 2020 2020   0, 0 },.       
+00017aa0: 202f 2a2e 6f70 2020 2020 2020 2020 2020   /*.op          
+00017ab0: 203d 2a2f 2047 474d 4c5f 4f50 5f4e 4f4e   =*/ GGML_OP_NON
+00017ac0: 452c 0a20 2020 2020 2020 202f 2a2e 6973  E,.        /*.is
+00017ad0: 5f70 6172 616d 2020 2020 203d 2a2f 2066  _param     =*/ f
+00017ae0: 616c 7365 2c0a 2020 2020 2020 2020 2f2a  alse,.        /*
+00017af0: 2e67 7261 6420 2020 2020 2020 2020 3d2a  .grad         =*
+00017b00: 2f20 4e55 4c4c 2c0a 2020 2020 2020 2020  / NULL,.        
+00017b10: 2f2a 2e73 7263 3020 2020 2020 2020 2020  /*.src0         
+00017b20: 3d2a 2f20 4e55 4c4c 2c0a 2020 2020 2020  =*/ NULL,.      
+00017b30: 2020 2f2a 2e73 7263 3120 2020 2020 2020    /*.src1       
+00017b40: 2020 3d2a 2f20 4e55 4c4c 2c0a 2020 2020    =*/ NULL,.    
+00017b50: 2020 2020 2f2a 2e6f 7074 2020 2020 2020      /*.opt      
+00017b60: 2020 2020 3d2a 2f20 7b20 4e55 4c4c 207d      =*/ { NULL }
+00017b70: 2c0a 2020 2020 2020 2020 2f2a 2e6e 5f74  ,.        /*.n_t
+00017b80: 6173 6b73 2020 2020 2020 3d2a 2f20 302c  asks      =*/ 0,
+00017b90: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
+00017ba0: 5f72 756e 7320 2020 203d 2a2f 2030 2c0a  _runs    =*/ 0,.
+00017bb0: 2020 2020 2020 2020 2f2a 2e70 6572 665f          /*.perf_
+00017bc0: 6379 636c 6573 2020 3d2a 2f20 302c 0a20  cycles  =*/ 0,. 
+00017bd0: 2020 2020 2020 202f 2a2e 7065 7266 5f74         /*.perf_t
+00017be0: 696d 655f 7573 203d 2a2f 2030 2c0a 2020  ime_us =*/ 0,.  
+00017bf0: 2020 2020 2020 2f2a 2e64 6174 6120 2020        /*.data   
+00017c00: 2020 2020 2020 3d2a 2f20 6461 7461 203d        =*/ data =
+00017c10: 3d20 4e55 4c4c 203f 2028 766f 6964 202a  = NULL ? (void *
+00017c20: 2928 7265 7375 6c74 202b 2031 2920 3a20  )(result + 1) : 
+00017c30: 6461 7461 2c0a 2020 2020 2020 2020 2f2a  data,.        /*
+00017c40: 2e70 6164 2020 2020 2020 2020 2020 3d2a  .pad          =*
+00017c50: 2f20 7b20 3020 7d2c 0a20 2020 207d 3b0a  / { 0 },.    };.
+00017c60: 0a20 2020 2067 676d 6c5f 6173 7365 7274  .    ggml_assert
+00017c70: 5f61 6c69 676e 6564 2872 6573 756c 742d  _aligned(result-
+00017c80: 3e64 6174 6129 3b0a 0a20 2020 2066 6f72  >data);..    for
+00017c90: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00017ca0: 206e 5f64 696d 733b 2069 2b2b 2920 7b0a   n_dims; i++) {.
+00017cb0: 2020 2020 2020 2020 7265 7375 6c74 2d3e          result->
+00017cc0: 6e65 5b69 5d20 3d20 6e65 5b69 5d3b 0a20  ne[i] = ne[i];. 
+00017cd0: 2020 207d 0a0a 2020 2020 7265 7375 6c74     }..    result
+00017ce0: 2d3e 6e62 5b30 5d20 3d20 4747 4d4c 5f54  ->nb[0] = GGML_T
+00017cf0: 5950 455f 5349 5a45 5b74 7970 655d 3b0a  YPE_SIZE[type];.
+00017d00: 2020 2020 7265 7375 6c74 2d3e 6e62 5b31      result->nb[1
+00017d10: 5d20 3d20 7265 7375 6c74 2d3e 6e62 5b30  ] = result->nb[0
+00017d20: 5d2a 2872 6573 756c 742d 3e6e 655b 305d  ]*(result->ne[0]
+00017d30: 2f47 474d 4c5f 424c 434b 5f53 495a 455b  /GGML_BLCK_SIZE[
+00017d40: 7479 7065 5d29 3b0a 2020 2020 666f 7220  type]);.    for 
+00017d50: 2869 6e74 2069 203d 2032 3b20 6920 3c20  (int i = 2; i < 
+00017d60: 4747 4d4c 5f4d 4158 5f44 494d 533b 2069  GGML_MAX_DIMS; i
+00017d70: 2b2b 2920 7b0a 2020 2020 2020 2020 7265  ++) {.        re
+00017d80: 7375 6c74 2d3e 6e62 5b69 5d20 3d20 7265  sult->nb[i] = re
+00017d90: 7375 6c74 2d3e 6e62 5b69 202d 2031 5d2a  sult->nb[i - 1]*
+00017da0: 7265 7375 6c74 2d3e 6e65 5b69 202d 2031  result->ne[i - 1
+00017db0: 5d3b 0a20 2020 207d 0a0a 2020 2020 6374  ];.    }..    ct
+00017dc0: 782d 3e6e 5f6f 626a 6563 7473 2b2b 3b0a  x->n_objects++;.
+00017dd0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+00017de0: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
+00017df0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+00017e00: 5f6e 6577 5f74 656e 736f 7228 0a20 2020  _new_tensor(.   
+00017e10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00017e20: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+00017e30: 2020 2020 2020 2020 656e 756d 2020 2067          enum   g
+00017e40: 676d 6c5f 7479 7065 2074 7970 652c 0a20  gml_type type,. 
+00017e50: 2020 2020 2020 2069 6e74 2020 2020 6e5f         int    n_
+00017e60: 6469 6d73 2c0a 2020 2020 2020 2020 636f  dims,.        co
+00017e70: 6e73 7420 696e 7420 2a20 6e65 2920 7b0a  nst int * ne) {.
+00017e80: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+00017e90: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
+00017ea0: 6374 782c 2074 7970 652c 206e 5f64 696d  ctx, type, n_dim
+00017eb0: 732c 206e 652c 204e 554c 4c29 3b0a 7d0a  s, ne, NULL);.}.
+00017ec0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00017ed0: 736f 7220 2a20 6767 6d6c 5f6e 6577 5f74  sor * ggml_new_t
+00017ee0: 656e 736f 725f 3164 280a 2020 2020 2020  ensor_1d(.      
+00017ef0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+00017f00: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+00017f10: 2020 2020 2065 6e75 6d20 2020 6767 6d6c       enum   ggml
+00017f20: 5f74 7970 6520 7479 7065 2c0a 2020 2020  _type type,.    
+00017f30: 2020 2020 696e 7420 2020 206e 6530 2920      int    ne0) 
+00017f40: 7b0a 2020 2020 7265 7475 726e 2067 676d  {.    return ggm
+00017f50: 6c5f 6e65 775f 7465 6e73 6f72 2863 7478  l_new_tensor(ctx
+00017f60: 2c20 7479 7065 2c20 312c 2026 6e65 3029  , type, 1, &ne0)
+00017f70: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+00017f80: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6e  _tensor * ggml_n
+00017f90: 6577 5f74 656e 736f 725f 3264 280a 2020  ew_tensor_2d(.  
+00017fa0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00017fb0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+00017fc0: 0a20 2020 2020 2020 2065 6e75 6d20 2020  .        enum   
+00017fd0: 6767 6d6c 5f74 7970 6520 7479 7065 2c0a  ggml_type type,.
+00017fe0: 2020 2020 2020 2020 696e 7420 2020 206e          int    n
+00017ff0: 6530 2c0a 2020 2020 2020 2020 696e 7420  e0,.        int 
+00018000: 2020 206e 6531 2920 7b0a 2020 2020 636f     ne1) {.    co
+00018010: 6e73 7420 696e 7420 6e65 5b32 5d20 3d20  nst int ne[2] = 
+00018020: 7b20 6e65 302c 206e 6531 207d 3b0a 2020  { ne0, ne1 };.  
+00018030: 2020 7265 7475 726e 2067 676d 6c5f 6e65    return ggml_ne
+00018040: 775f 7465 6e73 6f72 2863 7478 2c20 7479  w_tensor(ctx, ty
+00018050: 7065 2c20 322c 206e 6529 3b0a 7d0a 0a73  pe, 2, ne);.}..s
+00018060: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00018070: 7220 2a20 6767 6d6c 5f6e 6577 5f74 656e  r * ggml_new_ten
+00018080: 736f 725f 3364 280a 2020 2020 2020 2020  sor_3d(.        
+00018090: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+000180a0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+000180b0: 2020 2065 6e75 6d20 2020 6767 6d6c 5f74     enum   ggml_t
+000180c0: 7970 6520 7479 7065 2c0a 2020 2020 2020  ype type,.      
+000180d0: 2020 696e 7420 2020 206e 6530 2c0a 2020    int    ne0,.  
+000180e0: 2020 2020 2020 696e 7420 2020 206e 6531        int    ne1
+000180f0: 2c0a 2020 2020 2020 2020 696e 7420 2020  ,.        int   
+00018100: 206e 6532 2920 7b0a 2020 2020 636f 6e73   ne2) {.    cons
+00018110: 7420 696e 7420 6e65 5b33 5d20 3d20 7b20  t int ne[3] = { 
+00018120: 6e65 302c 206e 6531 2c20 6e65 3220 7d3b  ne0, ne1, ne2 };
+00018130: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
+00018140: 5f6e 6577 5f74 656e 736f 7228 6374 782c  _new_tensor(ctx,
+00018150: 2074 7970 652c 2033 2c20 6e65 293b 0a7d   type, 3, ne);.}
+00018160: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+00018170: 6e73 6f72 202a 2067 676d 6c5f 6e65 775f  nsor * ggml_new_
+00018180: 7465 6e73 6f72 5f34 6428 0a20 2020 2020  tensor_4d(.     
+00018190: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+000181a0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+000181b0: 2020 2020 2020 656e 756d 2020 2067 676d        enum   ggm
+000181c0: 6c5f 7479 7065 2074 7970 652c 0a20 2020  l_type type,.   
+000181d0: 2020 2020 2069 6e74 2020 2020 6e65 302c       int    ne0,
+000181e0: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
+000181f0: 6e65 312c 0a20 2020 2020 2020 2069 6e74  ne1,.        int
+00018200: 2020 2020 6e65 322c 0a20 2020 2020 2020      ne2,.       
+00018210: 2069 6e74 2020 2020 6e65 3329 207b 0a20   int    ne3) {. 
+00018220: 2020 2063 6f6e 7374 2069 6e74 206e 655b     const int ne[
+00018230: 345d 203d 207b 206e 6530 2c20 6e65 312c  4] = { ne0, ne1,
+00018240: 206e 6532 2c20 6e65 3320 7d3b 0a20 2020   ne2, ne3 };.   
+00018250: 2072 6574 7572 6e20 6767 6d6c 5f6e 6577   return ggml_new
+00018260: 5f74 656e 736f 7228 6374 782c 2074 7970  _tensor(ctx, typ
+00018270: 652c 2034 2c20 6e65 293b 0a7d 0a0a 7374  e, 4, ne);.}..st
+00018280: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00018290: 202a 2067 676d 6c5f 6e65 775f 6933 3228   * ggml_new_i32(
+000182a0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+000182b0: 6578 7420 2a20 6374 782c 2069 6e74 3332  ext * ctx, int32
+000182c0: 5f74 2076 616c 7565 2920 7b0a 2020 2020  _t value) {.    
+000182d0: 6374 782d 3e73 6372 6174 6368 5f73 6176  ctx->scratch_sav
+000182e0: 6520 3d20 6374 782d 3e73 6372 6174 6368  e = ctx->scratch
+000182f0: 3b0a 2020 2020 6374 782d 3e73 6372 6174  ;.    ctx->scrat
+00018300: 6368 2e64 6174 6120 3d20 4e55 4c4c 3b0a  ch.data = NULL;.
+00018310: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00018320: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+00018330: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00018340: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+00018350: 5459 5045 5f49 3332 2c20 3129 3b0a 0a20  TYPE_I32, 1);.. 
+00018360: 2020 2063 7478 2d3e 7363 7261 7463 6820     ctx->scratch 
+00018370: 3d20 6374 782d 3e73 6372 6174 6368 5f73  = ctx->scratch_s
+00018380: 6176 653b 0a0a 2020 2020 6767 6d6c 5f73  ave;..    ggml_s
+00018390: 6574 5f69 3332 2872 6573 756c 742c 2076  et_i32(result, v
+000183a0: 616c 7565 293b 0a0a 2020 2020 7265 7475  alue);..    retu
+000183b0: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+000183c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000183d0: 202a 2067 676d 6c5f 6e65 775f 6633 3228   * ggml_new_f32(
+000183e0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+000183f0: 6578 7420 2a20 6374 782c 2066 6c6f 6174  ext * ctx, float
+00018400: 2076 616c 7565 2920 7b0a 2020 2020 6374   value) {.    ct
+00018410: 782d 3e73 6372 6174 6368 5f73 6176 6520  x->scratch_save 
+00018420: 3d20 6374 782d 3e73 6372 6174 6368 3b0a  = ctx->scratch;.
+00018430: 2020 2020 6374 782d 3e73 6372 6174 6368      ctx->scratch
+00018440: 2e64 6174 6120 3d20 4e55 4c4c 3b0a 0a20  .data = NULL;.. 
+00018450: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00018460: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+00018470: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00018480: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
+00018490: 5045 5f46 3332 2c20 3129 3b0a 0a20 2020  PE_F32, 1);..   
+000184a0: 2063 7478 2d3e 7363 7261 7463 6820 3d20   ctx->scratch = 
+000184b0: 6374 782d 3e73 6372 6174 6368 5f73 6176  ctx->scratch_sav
+000184c0: 653b 0a0a 2020 2020 6767 6d6c 5f73 6574  e;..    ggml_set
+000184d0: 5f66 3332 2872 6573 756c 742c 2076 616c  _f32(result, val
+000184e0: 7565 293b 0a0a 2020 2020 7265 7475 726e  ue);..    return
+000184f0: 2072 6573 756c 743b 0a7d 0a0a 7374 7275   result;.}..stru
+00018500: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00018510: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
+00018520: 2873 7472 7563 7420 6767 6d6c 5f63 6f6e  (struct ggml_con
+00018530: 7465 7874 202a 2063 7478 2c20 636f 6e73  text * ctx, cons
+00018540: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00018550: 6e73 6f72 202a 2073 7263 2920 7b0a 2020  nsor * src) {.  
+00018560: 2020 7265 7475 726e 2067 676d 6c5f 6e65    return ggml_ne
+00018570: 775f 7465 6e73 6f72 5f69 6d70 6c28 6374  w_tensor_impl(ct
+00018580: 782c 2073 7263 2d3e 7479 7065 2c20 7372  x, src->type, sr
+00018590: 632d 3e6e 5f64 696d 732c 2073 7263 2d3e  c->n_dims, src->
+000185a0: 6e65 2c20 4e55 4c4c 293b 0a7d 0a0a 7374  ne, NULL);.}..st
+000185b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000185c0: 202a 2067 676d 6c5f 7365 745f 7a65 726f   * ggml_set_zero
+000185d0: 2873 7472 7563 7420 6767 6d6c 5f74 656e  (struct ggml_ten
+000185e0: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
+000185f0: 2020 2020 6d65 6d73 6574 2874 656e 736f      memset(tenso
+00018600: 722d 3e64 6174 612c 2030 2c20 6767 6d6c  r->data, 0, ggml
+00018610: 5f6e 6279 7465 7328 7465 6e73 6f72 2929  _nbytes(tensor))
+00018620: 3b0a 2020 2020 7265 7475 726e 2074 656e  ;.    return ten
+00018630: 736f 723b 0a7d 0a0a 7374 7275 6374 2067  sor;.}..struct g
+00018640: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+00018650: 6c5f 7365 745f 6933 3220 2873 7472 7563  l_set_i32 (struc
+00018660: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00018670: 7465 6e73 6f72 2c20 696e 7433 325f 7420  tensor, int32_t 
+00018680: 7661 6c75 6529 207b 0a20 2020 2063 6f6e  value) {.    con
+00018690: 7374 2069 6e74 206e 2020 2020 203d 2067  st int n     = g
+000186a0: 676d 6c5f 6e72 6f77 7328 7465 6e73 6f72  gml_nrows(tensor
+000186b0: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
+000186c0: 206e 6320 2020 203d 2074 656e 736f 722d   nc    = tensor-
+000186d0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+000186e0: 7420 7369 7a65 5f74 206e 3120 3d20 7465  t size_t n1 = te
+000186f0: 6e73 6f72 2d3e 6e62 5b31 5d3b 0a0a 2020  nsor->nb[1];..  
+00018700: 2020 6368 6172 202a 2063 6f6e 7374 2064    char * const d
+00018710: 6174 6120 3d20 7465 6e73 6f72 2d3e 6461  ata = tensor->da
+00018720: 7461 3b0a 0a20 2020 2073 7769 7463 6820  ta;..    switch 
+00018730: 2874 656e 736f 722d 3e74 7970 6529 207b  (tensor->type) {
+00018740: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00018750: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
+00018760: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00018770: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00018780: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00018790: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000187a0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000187b0: 6520 4747 4d4c 5f54 5950 455f 5134 5f31  e GGML_TYPE_Q4_1
+000187c0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000187d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187e0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000187f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00018800: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00018810: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00018820: 4938 3a0a 2020 2020 2020 2020 2020 2020  I8:.            
+00018830: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00018840: 2020 6173 7365 7274 2874 656e 736f 722d    assert(tensor-
+00018850: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
+00018860: 2869 6e74 385f 7429 293b 0a20 2020 2020  (int8_t));.     
+00018870: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00018880: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00018890: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+000188a0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000188b0: 6c5f 7665 635f 7365 745f 6938 286e 632c  l_vec_set_i8(nc,
+000188c0: 2028 696e 7438 5f74 202a 2928 6461 7461   (int8_t *)(data
+000188d0: 202b 2069 2a6e 3129 2c20 7661 6c75 6529   + i*n1), value)
+000188e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000188f0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00018900: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00018910: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00018920: 4931 363a 0a20 2020 2020 2020 2020 2020  I16:.           
+00018930: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00018940: 2020 2061 7373 6572 7428 7465 6e73 6f72     assert(tensor
+00018950: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00018960: 6628 696e 7431 365f 7429 293b 0a20 2020  f(int16_t));.   
+00018970: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00018980: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00018990: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
+000189a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000189b0: 676d 6c5f 7665 635f 7365 745f 6931 3628  gml_vec_set_i16(
+000189c0: 6e63 2c20 2869 6e74 3136 5f74 202a 2928  nc, (int16_t *)(
+000189d0: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+000189e0: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+000189f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00018a00: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00018a10: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00018a20: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
+00018a30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00018a40: 2020 2020 2020 2061 7373 6572 7428 7465         assert(te
+00018a50: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+00018a60: 697a 656f 6628 696e 7433 325f 7429 293b  izeof(int32_t));
+00018a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018a80: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00018a90: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
+00018aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ab0: 2020 2067 676d 6c5f 7665 635f 7365 745f     ggml_vec_set_
+00018ac0: 6933 3228 6e63 2c20 2869 6e74 3332 5f74  i32(nc, (int32_t
+00018ad0: 202a 2928 6461 7461 202b 2069 2a6e 3129   *)(data + i*n1)
+00018ae0: 2c20 7661 6c75 6529 3b0a 2020 2020 2020  , value);.      
+00018af0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00018b00: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00018b10: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00018b20: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
+00018b30: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00018b40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00018b50: 7428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  t(tensor->nb[0] 
+00018b60: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+00018b70: 7031 365f 7429 293b 0a20 2020 2020 2020  p16_t));.       
+00018b80: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00018b90: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
+00018ba0: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+00018bb0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00018bc0: 7665 635f 7365 745f 6631 3628 6e63 2c20  vec_set_f16(nc, 
+00018bd0: 2867 676d 6c5f 6670 3136 5f74 202a 2928  (ggml_fp16_t *)(
+00018be0: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+00018bf0: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+00018c00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00018c10: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00018c20: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00018c30: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00018c40: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00018c50: 2020 2020 2020 2061 7373 6572 7428 7465         assert(te
+00018c60: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+00018c70: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+00018c80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018c90: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00018ca0: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
+00018cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018cc0: 2067 676d 6c5f 7665 635f 7365 745f 6633   ggml_vec_set_f3
+00018cd0: 3228 6e63 2c20 2866 6c6f 6174 202a 2928  2(nc, (float *)(
+00018ce0: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+00018cf0: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+00018d00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00018d10: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00018d20: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00018d30: 5950 455f 434f 554e 543a 0a20 2020 2020  YPE_COUNT:.     
+00018d40: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00018d50: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00018d60: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+00018d70: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00018d80: 3b0a 2020 2020 7d0a 0a20 2020 2072 6574  ;.    }..    ret
+00018d90: 7572 6e20 7465 6e73 6f72 3b0a 7d0a 0a73  urn tensor;.}..s
+00018da0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00018db0: 7220 2a20 6767 6d6c 5f73 6574 5f66 3332  r * ggml_set_f32
+00018dc0: 2873 7472 7563 7420 6767 6d6c 5f74 656e  (struct ggml_ten
+00018dd0: 736f 7220 2a20 7465 6e73 6f72 2c20 666c  sor * tensor, fl
+00018de0: 6f61 7420 7661 6c75 6529 207b 0a20 2020  oat value) {.   
+00018df0: 2063 6f6e 7374 2069 6e74 206e 2020 2020   const int n    
+00018e00: 203d 2067 676d 6c5f 6e72 6f77 7328 7465   = ggml_nrows(te
+00018e10: 6e73 6f72 293b 0a20 2020 2063 6f6e 7374  nsor);.    const
+00018e20: 2069 6e74 206e 6320 2020 203d 2074 656e   int nc    = ten
+00018e30: 736f 722d 3e6e 655b 305d 3b0a 2020 2020  sor->ne[0];.    
+00018e40: 636f 6e73 7420 7369 7a65 5f74 206e 3120  const size_t n1 
+00018e50: 3d20 7465 6e73 6f72 2d3e 6e62 5b31 5d3b  = tensor->nb[1];
+00018e60: 0a0a 2020 2020 6368 6172 202a 2063 6f6e  ..    char * con
+00018e70: 7374 2064 6174 6120 3d20 7465 6e73 6f72  st data = tensor
+00018e80: 2d3e 6461 7461 3b0a 0a20 2020 2073 7769  ->data;..    swi
+00018e90: 7463 6820 2874 656e 736f 722d 3e74 7970  tch (tensor->typ
+00018ea0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00018eb0: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
+00018ec0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00018ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ee0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00018ef0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00018f00: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00018f10: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00018f20: 5134 5f31 3a0a 2020 2020 2020 2020 2020  Q4_1:.          
+00018f30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00018f40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00018f50: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00018f60: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00018f70: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00018f80: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
+00018f90: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00018fa0: 2020 2020 2020 6173 7365 7274 2874 656e        assert(ten
+00018fb0: 736f 722d 3e6e 625b 305d 203d 3d20 7369  sor->nb[0] == si
+00018fc0: 7a65 6f66 2869 6e74 385f 7429 293b 0a20  zeof(int8_t));. 
+00018fd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018fe0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00018ff0: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
+00019000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019010: 2067 676d 6c5f 7665 635f 7365 745f 6938   ggml_vec_set_i8
+00019020: 286e 632c 2028 696e 7438 5f74 202a 2928  (nc, (int8_t *)(
+00019030: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+00019040: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+00019050: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00019060: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00019070: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00019080: 5950 455f 4931 363a 0a20 2020 2020 2020  YPE_I16:.       
+00019090: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000190a0: 2020 2020 2020 2061 7373 6572 7428 7465         assert(te
+000190b0: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+000190c0: 697a 656f 6628 696e 7431 365f 7429 293b  izeof(int16_t));
+000190d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000190e0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+000190f0: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
+00019100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019110: 2020 2067 676d 6c5f 7665 635f 7365 745f     ggml_vec_set_
+00019120: 6931 3628 6e63 2c20 2869 6e74 3136 5f74  i16(nc, (int16_t
+00019130: 202a 2928 6461 7461 202b 2069 2a6e 3129   *)(data + i*n1)
+00019140: 2c20 7661 6c75 6529 3b0a 2020 2020 2020  , value);.      
+00019150: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00019160: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00019170: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00019180: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
+00019190: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000191a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000191b0: 7428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  t(tensor->nb[0] 
+000191c0: 3d3d 2073 697a 656f 6628 696e 7433 325f  == sizeof(int32_
+000191d0: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+000191e0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+000191f0: 3d20 303b 2069 203c 206e 3b20 692b 2b29  = 0; i < n; i++)
+00019200: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00019210: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00019220: 7365 745f 6933 3228 6e63 2c20 2869 6e74  set_i32(nc, (int
+00019230: 3332 5f74 202a 2928 6461 7461 202b 2069  32_t *)(data + i
+00019240: 2a6e 3129 2c20 7661 6c75 6529 3b0a 2020  *n1), value);.  
+00019250: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00019260: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00019270: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00019280: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
+00019290: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000192a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000192b0: 7373 6572 7428 7465 6e73 6f72 2d3e 6e62  ssert(tensor->nb
+000192c0: 5b30 5d20 3d3d 2073 697a 656f 6628 6767  [0] == sizeof(gg
+000192d0: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
+000192e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000192f0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00019300: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
+00019310: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00019320: 676d 6c5f 7665 635f 7365 745f 6631 3628  gml_vec_set_f16(
+00019330: 6e63 2c20 2867 676d 6c5f 6670 3136 5f74  nc, (ggml_fp16_t
+00019340: 202a 2928 6461 7461 202b 2069 2a6e 3129   *)(data + i*n1)
+00019350: 2c20 7661 6c75 6529 3b0a 2020 2020 2020  , value);.      
+00019360: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00019370: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00019380: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00019390: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+000193a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000193b0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000193c0: 7428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  t(tensor->nb[0] 
+000193d0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+000193e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+000193f0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00019400: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
+00019410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019420: 2020 2020 2067 676d 6c5f 7665 635f 7365       ggml_vec_se
+00019430: 745f 6633 3228 6e63 2c20 2866 6c6f 6174  t_f32(nc, (float
+00019440: 202a 2928 6461 7461 202b 2069 2a6e 3129   *)(data + i*n1)
+00019450: 2c20 7661 6c75 6529 3b0a 2020 2020 2020  , value);.      
+00019460: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00019470: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00019480: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00019490: 4d4c 5f54 5950 455f 434f 554e 543a 0a20  ML_TYPE_COUNT:. 
+000194a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000194b0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+000194c0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+000194d0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000194e0: 7265 616b 3b0a 2020 2020 7d0a 0a20 2020  reak;.    }..   
+000194f0: 2072 6574 7572 6e20 7465 6e73 6f72 3b0a   return tensor;.
+00019500: 7d0a 0a69 6e74 3332 5f74 2067 676d 6c5f  }..int32_t ggml_
+00019510: 6765 745f 6933 325f 3164 2863 6f6e 7374  get_i32_1d(const
+00019520: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00019530: 736f 7220 2a20 7465 6e73 6f72 2c20 696e  sor * tensor, in
+00019540: 7420 6929 207b 0a20 2020 2073 7769 7463  t i) {.    switc
+00019550: 6820 2874 656e 736f 722d 3e74 7970 6529  h (tensor->type)
+00019560: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00019570: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
+00019580: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00019590: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+000195a0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+000195b0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+000195c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+000195d0: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+000195e0: 5f31 3a0a 2020 2020 2020 2020 2020 2020  _1:.            
+000195f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00019600: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00019610: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+00019620: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00019630: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00019640: 455f 4938 3a0a 2020 2020 2020 2020 2020  E_I8:.          
+00019650: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00019660: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00019670: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
+00019680: 2073 697a 656f 6628 696e 7438 5f74 2929   sizeof(int8_t))
+00019690: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000196a0: 2020 7265 7475 726e 2028 2869 6e74 385f    return ((int8_
+000196b0: 7420 2a29 2874 656e 736f 722d 3e64 6174  t *)(tensor->dat
+000196c0: 6129 295b 695d 3b0a 2020 2020 2020 2020  a))[i];.        
+000196d0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000196e0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000196f0: 5950 455f 4931 363a 0a20 2020 2020 2020  YPE_I16:.       
+00019700: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00019710: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00019720: 5254 2874 656e 736f 722d 3e6e 625b 305d  RT(tensor->nb[0]
+00019730: 203d 3d20 7369 7a65 6f66 2869 6e74 3136   == sizeof(int16
+00019740: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
+00019750: 2020 2020 2020 7265 7475 726e 2028 2869        return ((i
+00019760: 6e74 3136 5f74 202a 2928 7465 6e73 6f72  nt16_t *)(tensor
+00019770: 2d3e 6461 7461 2929 5b69 5d3b 0a20 2020  ->data))[i];.   
+00019780: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00019790: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000197a0: 474d 4c5f 5459 5045 5f49 3332 3a0a 2020  GML_TYPE_I32:.  
+000197b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000197c0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000197d0: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
+000197e0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+000197f0: 696e 7433 325f 7429 293b 0a20 2020 2020  int32_t));.     
+00019800: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00019810: 6e20 2828 696e 7433 325f 7420 2a29 2874  n ((int32_t *)(t
+00019820: 656e 736f 722d 3e64 6174 6129 295b 695d  ensor->data))[i]
+00019830: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00019840: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00019850: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
+00019860: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
+00019870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019880: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
+00019890: 736f 722d 3e6e 625b 305d 203d 3d20 7369  sor->nb[0] == si
+000198a0: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+000198b0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+000198c0: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
+000198d0: 4650 3136 5f54 4f5f 4650 3332 2828 2867  FP16_TO_FP32(((g
+000198e0: 676d 6c5f 6670 3136 5f74 202a 2928 7465  gml_fp16_t *)(te
+000198f0: 6e73 6f72 2d3e 6461 7461 2929 5b69 5d29  nsor->data))[i])
+00019900: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00019910: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00019920: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+00019930: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+00019940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019950: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
+00019960: 736f 722d 3e6e 625b 305d 203d 3d20 7369  sor->nb[0] == si
+00019970: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
+00019980: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00019990: 7475 726e 2028 2866 6c6f 6174 202a 2928  turn ((float *)(
+000199a0: 7465 6e73 6f72 2d3e 6461 7461 2929 5b69  tensor->data))[i
+000199b0: 5d3b 0a20 2020 2020 2020 2020 2020 207d  ];.            }
+000199c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000199d0: 6361 7365 2047 474d 4c5f 5459 5045 5f43  case GGML_TYPE_C
+000199e0: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
+000199f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00019a00: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00019a10: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00019a20: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00019a30: 207d 0a0a 2020 2020 7265 7475 726e 2030   }..    return 0
+00019a40: 2e30 663b 0a7d 0a0a 766f 6964 2067 676d  .0f;.}..void ggm
+00019a50: 6c5f 7365 745f 6933 325f 3164 2863 6f6e  l_set_i32_1d(con
+00019a60: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00019a70: 656e 736f 7220 2a20 7465 6e73 6f72 2c20  ensor * tensor, 
+00019a80: 696e 7420 692c 2069 6e74 3332 5f74 2076  int i, int32_t v
+00019a90: 616c 7565 2920 7b0a 2020 2020 7377 6974  alue) {.    swit
+00019aa0: 6368 2028 7465 6e73 6f72 2d3e 7479 7065  ch (tensor->type
+00019ab0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+00019ac0: 2047 474d 4c5f 5459 5045 5f51 345f 303a   GGML_TYPE_Q4_0:
+00019ad0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00019ae0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00019af0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00019b00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00019b10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00019b20: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+00019b30: 345f 313a 0a20 2020 2020 2020 2020 2020  4_1:.           
+00019b40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00019b50: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00019b60: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+00019b70: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00019b80: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00019b90: 5045 5f49 383a 0a20 2020 2020 2020 2020  PE_I8:.         
+00019ba0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00019bb0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00019bc0: 2874 656e 736f 722d 3e6e 625b 305d 203d  (tensor->nb[0] =
+00019bd0: 3d20 7369 7a65 6f66 2869 6e74 385f 7429  = sizeof(int8_t)
+00019be0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00019bf0: 2020 2028 2869 6e74 385f 7420 2a29 2874     ((int8_t *)(t
+00019c00: 656e 736f 722d 3e64 6174 6129 295b 695d  ensor->data))[i]
+00019c10: 203d 2076 616c 7565 3b0a 2020 2020 2020   = value;.      
+00019c20: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00019c30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00019c40: 5f54 5950 455f 4931 363a 0a20 2020 2020  _TYPE_I16:.     
+00019c50: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00019c60: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00019c70: 5345 5254 2874 656e 736f 722d 3e6e 625b  SERT(tensor->nb[
+00019c80: 305d 203d 3d20 7369 7a65 6f66 2869 6e74  0] == sizeof(int
+00019c90: 3136 5f74 2929 3b0a 2020 2020 2020 2020  16_t));.        
+00019ca0: 2020 2020 2020 2020 2828 696e 7431 365f          ((int16_
+00019cb0: 7420 2a29 2874 656e 736f 722d 3e64 6174  t *)(tensor->dat
+00019cc0: 6129 295b 695d 203d 2076 616c 7565 3b0a  a))[i] = value;.
+00019cd0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00019ce0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00019cf0: 6520 4747 4d4c 5f54 5950 455f 4933 323a  e GGML_TYPE_I32:
+00019d00: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00019d10: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00019d20: 474d 4c5f 4153 5345 5254 2874 656e 736f  GML_ASSERT(tenso
+00019d30: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
+00019d40: 6f66 2869 6e74 3332 5f74 2929 3b0a 2020  of(int32_t));.  
+00019d50: 2020 2020 2020 2020 2020 2020 2020 2828                ((
+00019d60: 696e 7433 325f 7420 2a29 2874 656e 736f  int32_t *)(tenso
+00019d70: 722d 3e64 6174 6129 295b 695d 203d 2076  r->data))[i] = v
+00019d80: 616c 7565 3b0a 2020 2020 2020 2020 2020  alue;.          
+00019d90: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00019da0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00019db0: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
+00019dc0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00019dd0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00019de0: 2874 656e 736f 722d 3e6e 625b 305d 203d  (tensor->nb[0] =
+00019df0: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
+00019e00: 3136 5f74 2929 3b0a 2020 2020 2020 2020  16_t));.        
+00019e10: 2020 2020 2020 2020 2828 6767 6d6c 5f66          ((ggml_f
+00019e20: 7031 365f 7420 2a29 2874 656e 736f 722d  p16_t *)(tensor-
+00019e30: 3e64 6174 6129 295b 695d 203d 2047 474d  >data))[i] = GGM
+00019e40: 4c5f 4650 3332 5f54 4f5f 4650 3136 2876  L_FP32_TO_FP16(v
+00019e50: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
+00019e60: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00019e70: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00019e80: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+00019e90: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00019ea0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00019eb0: 5428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  T(tensor->nb[0] 
+00019ec0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00019ed0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00019ee0: 2020 2028 2866 6c6f 6174 202a 2928 7465     ((float *)(te
+00019ef0: 6e73 6f72 2d3e 6461 7461 2929 5b69 5d20  nsor->data))[i] 
+00019f00: 3d20 7661 6c75 653b 0a20 2020 2020 2020  = value;.       
+00019f10: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00019f20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00019f30: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
+00019f40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00019f50: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00019f60: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00019f70: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00019f80: 6b3b 0a20 2020 207d 0a7d 0a0a 666c 6f61  k;.    }.}..floa
+00019f90: 7420 6767 6d6c 5f67 6574 5f66 3332 5f31  t ggml_get_f32_1
+00019fa0: 6428 636f 6e73 7420 7374 7275 6374 2067  d(const struct g
+00019fb0: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+00019fc0: 736f 722c 2069 6e74 2069 2920 7b0a 2020  sor, int i) {.  
+00019fd0: 2020 7377 6974 6368 2028 7465 6e73 6f72    switch (tensor
+00019fe0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00019ff0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0001a000: 5f51 345f 303a 0a20 2020 2020 2020 2020  _Q4_0:.         
+0001a010: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0001a020: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0001a030: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+0001a040: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0001a050: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0001a060: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
+0001a070: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0001a080: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0001a090: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+0001a0a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0001a0b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0001a0c0: 474d 4c5f 5459 5045 5f49 383a 0a20 2020  GML_TYPE_I8:.   
+0001a0d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0001a0e0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0001a0f0: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
+0001a100: 625b 305d 203d 3d20 7369 7a65 6f66 2869  b[0] == sizeof(i
+0001a110: 6e74 385f 7429 293b 0a20 2020 2020 2020  nt8_t));.       
+0001a120: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001a130: 2828 696e 7438 5f74 202a 2928 7465 6e73  ((int8_t *)(tens
+0001a140: 6f72 2d3e 6461 7461 2929 5b69 5d3b 0a20  or->data))[i];. 
+0001a150: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0001a160: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0001a170: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
+0001a180: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0001a190: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0001a1a0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+0001a1b0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+0001a1c0: 6628 696e 7431 365f 7429 293b 0a20 2020  f(int16_t));.   
+0001a1d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001a1e0: 7572 6e20 2828 696e 7431 365f 7420 2a29  urn ((int16_t *)
+0001a1f0: 2874 656e 736f 722d 3e64 6174 6129 295b  (tensor->data))[
+0001a200: 695d 3b0a 2020 2020 2020 2020 2020 2020  i];.            
+0001a210: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0001a220: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0001a230: 4933 323a 0a20 2020 2020 2020 2020 2020  I32:.           
+0001a240: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0001a250: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
+0001a260: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
+0001a270: 7369 7a65 6f66 2869 6e74 3332 5f74 2929  sizeof(int32_t))
+0001a280: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0001a290: 2020 7265 7475 726e 2028 2869 6e74 3332    return ((int32
+0001a2a0: 5f74 202a 2928 7465 6e73 6f72 2d3e 6461  _t *)(tensor->da
+0001a2b0: 7461 2929 5b69 5d3b 0a20 2020 2020 2020  ta))[i];.       
+0001a2c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0001a2d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0001a2e0: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
+0001a2f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0001a300: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0001a310: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
+0001a320: 5d20 3d3d 2073 697a 656f 6628 6767 6d6c  ] == sizeof(ggml
+0001a330: 5f66 7031 365f 7429 293b 0a20 2020 2020  _fp16_t));.     
+0001a340: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001a350: 6e20 4747 4d4c 5f46 5031 365f 544f 5f46  n GGML_FP16_TO_F
+0001a360: 5033 3228 2828 6767 6d6c 5f66 7031 365f  P32(((ggml_fp16_
+0001a370: 7420 2a29 2874 656e 736f 722d 3e64 6174  t *)(tensor->dat
+0001a380: 6129 295b 695d 293b 0a20 2020 2020 2020  a))[i]);.       
+0001a390: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0001a3a0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0001a3b0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+0001a3c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0001a3d0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0001a3e0: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
+0001a3f0: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+0001a400: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+0001a410: 2020 2020 2072 6574 7572 6e20 2828 666c       return ((fl
+0001a420: 6f61 7420 2a29 2874 656e 736f 722d 3e64  oat *)(tensor->d
+0001a430: 6174 6129 295b 695d 3b0a 2020 2020 2020  ata))[i];.      
+0001a440: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0001a450: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0001a460: 5f54 5950 455f 434f 554e 543a 0a20 2020  _TYPE_COUNT:.   
+0001a470: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0001a480: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0001a490: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+0001a4a0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0001a4b0: 616b 3b0a 2020 2020 7d0a 0a20 2020 2072  ak;.    }..    r
+0001a4c0: 6574 7572 6e20 302e 3066 3b0a 7d0a 0a76  eturn 0.0f;.}..v
+0001a4d0: 6f69 6420 6767 6d6c 5f73 6574 5f66 3332  oid ggml_set_f32
+0001a4e0: 5f31 6428 636f 6e73 7420 7374 7275 6374  _1d(const struct
+0001a4f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
+0001a500: 656e 736f 722c 2069 6e74 2069 2c20 666c  ensor, int i, fl
+0001a510: 6f61 7420 7661 6c75 6529 207b 0a20 2020  oat value) {.   
+0001a520: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
+0001a530: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+0001a540: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0001a550: 5134 5f30 3a0a 2020 2020 2020 2020 2020  Q4_0:.          
+0001a560: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0001a570: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0001a580: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+0001a590: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0001a5a0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0001a5b0: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
+0001a5c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0001a5d0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0001a5e0: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+0001a5f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0001a600: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0001a610: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
+0001a620: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0001a630: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0001a640: 5353 4552 5428 7465 6e73 6f72 2d3e 6e62  SSERT(tensor->nb
+0001a650: 5b30 5d20 3d3d 2073 697a 656f 6628 696e  [0] == sizeof(in
+0001a660: 7438 5f74 2929 3b0a 2020 2020 2020 2020  t8_t));.        
+0001a670: 2020 2020 2020 2020 2828 696e 7438 5f74          ((int8_t
+0001a680: 202a 2928 7465 6e73 6f72 2d3e 6461 7461   *)(tensor->data
+0001a690: 2929 5b69 5d20 3d20 7661 6c75 653b 0a20  ))[i] = value;. 
+0001a6a0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0001a6b0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0001a6c0: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
+0001a6d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0001a6e0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0001a6f0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+0001a700: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+0001a710: 6628 696e 7431 365f 7429 293b 0a20 2020  f(int16_t));.   
+0001a720: 2020 2020 2020 2020 2020 2020 2028 2869               ((i
+0001a730: 6e74 3136 5f74 202a 2928 7465 6e73 6f72  nt16_t *)(tensor
+0001a740: 2d3e 6461 7461 2929 5b69 5d20 3d20 7661  ->data))[i] = va
+0001a750: 6c75 653b 0a20 2020 2020 2020 2020 2020  lue;.           
+0001a760: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0001a770: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0001a780: 5f49 3332 3a0a 2020 2020 2020 2020 2020  _I32:.          
+0001a790: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0001a7a0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0001a7b0: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
+0001a7c0: 2073 697a 656f 6628 696e 7433 325f 7429   sizeof(int32_t)
+0001a7d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0001a7e0: 2020 2028 2869 6e74 3332 5f74 202a 2928     ((int32_t *)(
+0001a7f0: 7465 6e73 6f72 2d3e 6461 7461 2929 5b69  tensor->data))[i
+0001a800: 5d20 3d20 7661 6c75 653b 0a20 2020 2020  ] = value;.     
+0001a810: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0001a820: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0001a830: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
+0001a840: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0001a850: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0001a860: 5353 4552 5428 7465 6e73 6f72 2d3e 6e62  SSERT(tensor->nb
+0001a870: 5b30 5d20 3d3d 2073 697a 656f 6628 6767  [0] == sizeof(gg
+0001a880: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
+0001a890: 2020 2020 2020 2020 2020 2020 2028 2867               ((g
+0001a8a0: 676d 6c5f 6670 3136 5f74 202a 2928 7465  gml_fp16_t *)(te
+0001a8b0: 6e73 6f72 2d3e 6461 7461 2929 5b69 5d20  nsor->data))[i] 
+0001a8c0: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+0001a8d0: 5031 3628 7661 6c75 6529 3b0a 2020 2020  P16(value);.    
+0001a8e0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0001a8f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0001a900: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+0001a910: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0001a920: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0001a930: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
+0001a940: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
+0001a950: 6c6f 6174 2929 3b0a 2020 2020 2020 2020  loat));.        
+0001a960: 2020 2020 2020 2020 2828 666c 6f61 7420          ((float 
+0001a970: 2a29 2874 656e 736f 722d 3e64 6174 6129  *)(tensor->data)
+0001a980: 295b 695d 203d 2076 616c 7565 3b0a 2020  )[i] = value;.  
+0001a990: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0001a9a0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0001a9b0: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
+0001a9c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0001a9d0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0001a9e0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0001a9f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0001aa00: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+0001aa10: 0a76 6f69 6420 2a20 6767 6d6c 5f67 6574  .void * ggml_get
+0001aa20: 5f64 6174 6128 636f 6e73 7420 7374 7275  _data(const stru
+0001aa30: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0001aa40: 2074 656e 736f 7229 207b 0a20 2020 2072   tensor) {.    r
+0001aa50: 6574 7572 6e20 7465 6e73 6f72 2d3e 6461  eturn tensor->da
+0001aa60: 7461 3b0a 7d0a 0a66 6c6f 6174 202a 2067  ta;.}..float * g
+0001aa70: 676d 6c5f 6765 745f 6461 7461 5f66 3332  gml_get_data_f32
+0001aa80: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+0001aa90: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+0001aaa0: 6f72 2920 7b0a 2020 2020 6173 7365 7274  or) {.    assert
+0001aab0: 2874 656e 736f 722d 3e74 7970 6520 3d3d  (tensor->type ==
+0001aac0: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
+0001aad0: 0a20 2020 2072 6574 7572 6e20 2866 6c6f  .    return (flo
+0001aae0: 6174 202a 2928 7465 6e73 6f72 2d3e 6461  at *)(tensor->da
+0001aaf0: 7461 293b 0a7d 0a0a 7374 7275 6374 2067  ta);.}..struct g
+0001ab00: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0001ab10: 6c5f 7669 6577 5f74 656e 736f 7228 0a20  l_view_tensor(. 
+0001ab20: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0001ab30: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0001ab40: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0001ab50: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001ab60: 6f72 202a 2073 7263 2920 7b0a 2020 2020  or * src) {.    
+0001ab70: 7265 7475 726e 2067 676d 6c5f 6e65 775f  return ggml_new_
+0001ab80: 7465 6e73 6f72 5f69 6d70 6c28 6374 782c  tensor_impl(ctx,
+0001ab90: 2073 7263 2d3e 7479 7065 2c20 7372 632d   src->type, src-
+0001aba0: 3e6e 5f64 696d 732c 2073 7263 2d3e 6e65  >n_dims, src->ne
+0001abb0: 2c20 7372 632d 3e64 6174 6129 3b0a 7d0a  , src->data);.}.
+0001abc0: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
+0001abd0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0001abe0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0001abf0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0001ac00: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0001ac10: 2f0a 0a2f 2f20 6767 6d6c 5f64 7570 0a0a  /..// ggml_dup..
+0001ac20: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001ac30: 6f72 202a 2067 676d 6c5f 6475 705f 696d  or * ggml_dup_im
+0001ac40: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
+0001ac50: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0001ac60: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0001ac70: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001ac80: 7220 2a20 612c 0a20 2020 2020 2020 2062  r * a,.        b
+0001ac90: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
+0001aca0: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
+0001acb0: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
+0001acc0: 2028 2169 6e70 6c61 6365 2026 2620 2861   (!inplace && (a
+0001acd0: 2d3e 6772 6164 2929 207b 0a20 2020 2020  ->grad)) {.     
+0001ace0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
+0001acf0: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
+0001ad00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001ad10: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
+0001ad20: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
+0001ad30: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
+0001ad40: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
+0001ad50: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
+0001ad60: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+0001ad70: 4d4c 5f4f 505f 4455 503b 0a20 2020 2072  ML_OP_DUP;.    r
+0001ad80: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+0001ad90: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+0001ada0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+0001adb0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+0001adc0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+0001add0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+0001ade0: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
+0001adf0: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+0001ae00: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+0001ae10: 656e 736f 7220 2a20 6767 6d6c 5f64 7570  ensor * ggml_dup
+0001ae20: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+0001ae30: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+0001ae40: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+0001ae50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001ae60: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+0001ae70: 6e20 6767 6d6c 5f64 7570 5f69 6d70 6c28  n ggml_dup_impl(
+0001ae80: 6374 782c 2061 2c20 6661 6c73 6529 3b0a  ctx, a, false);.
+0001ae90: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+0001aea0: 656e 736f 7220 2a20 6767 6d6c 5f64 7570  ensor * ggml_dup
+0001aeb0: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
+0001aec0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+0001aed0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+0001aee0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0001aef0: 5f74 656e 736f 7220 2a20 6129 207b 0a20  _tensor * a) {. 
+0001af00: 2020 2072 6574 7572 6e20 6767 6d6c 5f64     return ggml_d
+0001af10: 7570 5f69 6d70 6c28 6374 782c 2061 2c20  up_impl(ctx, a, 
+0001af20: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
+0001af30: 6c5f 6164 640a 0a73 7472 7563 7420 6767  l_add..struct gg
+0001af40: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0001af50: 5f61 6464 5f69 6d70 6c28 0a20 2020 2020  _add_impl(.     
+0001af60: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001af70: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001af80: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001af90: 6c5f 7465 6e73 6f72 202a 2061 2c0a 2020  l_tensor * a,.  
+0001afa0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001afb0: 6c5f 7465 6e73 6f72 202a 2062 2c0a 2020  l_tensor * b,.  
+0001afc0: 2020 2020 2020 626f 6f6c 2069 6e70 6c61        bool inpla
+0001afd0: 6365 2920 7b0a 2020 2020 4747 4d4c 5f41  ce) {.    GGML_A
+0001afe0: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
+0001aff0: 616d 655f 7368 6170 6528 612c 2062 2929  ame_shape(a, b))
+0001b000: 3b0a 0a20 2020 2062 6f6f 6c20 6973 5f6e  ;..    bool is_n
+0001b010: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
+0001b020: 2020 6966 2028 2169 6e70 6c61 6365 2026    if (!inplace &
+0001b030: 2620 2861 2d3e 6772 6164 207c 7c20 622d  & (a->grad || b-
+0001b040: 3e67 7261 6429 2920 7b0a 2020 2020 2020  >grad)) {.      
+0001b050: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0001b060: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+0001b070: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001b080: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+0001b090: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+0001b0a0: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+0001b0b0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+0001b0c0: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+0001b0d0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+0001b0e0: 4c5f 4f50 5f41 4444 3b0a 2020 2020 7265  L_OP_ADD;.    re
+0001b0f0: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+0001b100: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+0001b110: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+0001b120: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+0001b130: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+0001b140: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+0001b150: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
+0001b160: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
+0001b170: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001b180: 7220 2a20 6767 6d6c 5f61 6464 280a 2020  r * ggml_add(.  
+0001b190: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001b1a0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0001b1b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001b1c0: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0001b1d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001b1e0: 6767 6d6c 5f74 656e 736f 7220 2a20 6229  ggml_tensor * b)
+0001b1f0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
+0001b200: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+0001b210: 2061 2c20 622c 2066 616c 7365 293b 0a7d   a, b, false);.}
+0001b220: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0001b230: 6e73 6f72 202a 2067 676d 6c5f 6164 645f  nsor * ggml_add_
+0001b240: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+0001b250: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0001b260: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0001b270: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0001b280: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
+0001b290: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0001b2a0: 7465 6e73 6f72 202a 2062 2920 7b0a 2020  tensor * b) {.  
+0001b2b0: 2020 7265 7475 726e 2067 676d 6c5f 6164    return ggml_ad
+0001b2c0: 645f 696d 706c 2863 7478 2c20 612c 2062  d_impl(ctx, a, b
+0001b2d0: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
+0001b2e0: 676d 6c5f 7375 620a 0a73 7472 7563 7420  gml_sub..struct 
+0001b2f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0001b300: 6d6c 5f73 7562 5f69 6d70 6c28 0a20 2020  ml_sub_impl(.   
+0001b310: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0001b320: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+0001b330: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001b340: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
+0001b350: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001b360: 676d 6c5f 7465 6e73 6f72 202a 2062 2c0a  gml_tensor * b,.
+0001b370: 2020 2020 2020 2020 626f 6f6c 2069 6e70          bool inp
+0001b380: 6c61 6365 2920 7b0a 2020 2020 4747 4d4c  lace) {.    GGML
+0001b390: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
+0001b3a0: 5f73 616d 655f 7368 6170 6528 612c 2062  _same_shape(a, b
+0001b3b0: 2929 3b0a 0a20 2020 2062 6f6f 6c20 6973  ));..    bool is
+0001b3c0: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
+0001b3d0: 2020 2020 6966 2028 2169 6e70 6c61 6365      if (!inplace
+0001b3e0: 2026 2620 2861 2d3e 6772 6164 207c 7c20   && (a->grad || 
+0001b3f0: 622d 3e67 7261 6429 2920 7b0a 2020 2020  b->grad)) {.    
+0001b400: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0001b410: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+0001b420: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001b430: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+0001b440: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+0001b450: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+0001b460: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+0001b470: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+0001b480: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0001b490: 474d 4c5f 4f50 5f53 5542 3b0a 2020 2020  GML_OP_SUB;.    
+0001b4a0: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+0001b4b0: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+0001b4c0: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+0001b4d0: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+0001b4e0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+0001b4f0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+0001b500: 7372 6331 203d 2062 3b0a 0a20 2020 2072  src1 = b;..    r
+0001b510: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+0001b520: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0001b530: 736f 7220 2a20 6767 6d6c 5f73 7562 280a  sor * ggml_sub(.
+0001b540: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001b550: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001b560: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001b570: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001b580: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
+0001b590: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001b5a0: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
+0001b5b0: 6767 6d6c 5f73 7562 5f69 6d70 6c28 6374  ggml_sub_impl(ct
+0001b5c0: 782c 2061 2c20 622c 2066 616c 7365 293b  x, a, b, false);
+0001b5d0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+0001b5e0: 7465 6e73 6f72 202a 2067 676d 6c5f 7375  tensor * ggml_su
+0001b5f0: 625f 696e 706c 6163 6528 0a20 2020 2020  b_inplace(.     
+0001b600: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001b610: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001b620: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001b630: 6c5f 7465 6e73 6f72 202a 2061 2c0a 2020  l_tensor * a,.  
+0001b640: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001b650: 6c5f 7465 6e73 6f72 202a 2062 2920 7b0a  l_tensor * b) {.
+0001b660: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+0001b670: 7375 625f 696d 706c 2863 7478 2c20 612c  sub_impl(ctx, a,
+0001b680: 2062 2c20 7472 7565 293b 0a7d 0a0a 2f2f   b, true);.}..//
+0001b690: 2067 676d 6c5f 6d75 6c0a 0a73 7472 7563   ggml_mul..struc
+0001b6a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001b6b0: 6767 6d6c 5f6d 756c 5f69 6d70 6c28 0a20  ggml_mul_impl(. 
+0001b6c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0001b6d0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0001b6e0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0001b6f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
 0001b700: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001b710: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+0001b710: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
 0001b720: 2c0a 2020 2020 2020 2020 626f 6f6c 2069  ,.        bool i
-0001b730: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-0001b740: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0001b750: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-0001b760: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
-0001b770: 6429 2920 7b0a 2020 2020 2020 2020 6973  d)) {.        is
-0001b780: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0001b790: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0001b7a0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001b7b0: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0001b7c0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0001b7d0: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0001b7e0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0001b7f0: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-0001b800: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0001b810: 5f52 454c 553b 0a20 2020 2072 6573 756c  _RELU;.    resul
-0001b820: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0001b830: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0001b840: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0001b850: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0001b860: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0001b870: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0001b880: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
-0001b890: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
-0001b8a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001b8b0: 7220 2a20 6767 6d6c 5f72 656c 7528 0a20  r * ggml_relu(. 
-0001b8c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001b8d0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001b8e0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001b8f0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001b900: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
-0001b910: 6767 6d6c 5f72 656c 755f 696d 706c 2863  ggml_relu_impl(c
-0001b920: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
-0001b930: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001b940: 6e73 6f72 202a 2067 676d 6c5f 7265 6c75  nsor * ggml_relu
-0001b950: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
-0001b960: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-0001b970: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-0001b980: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001b990: 5f74 656e 736f 7220 202a 2061 2920 7b0a  _tensor  * a) {.
-0001b9a0: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-0001b9b0: 7265 6c75 5f69 6d70 6c28 6374 782c 2061  relu_impl(ctx, a
-0001b9c0: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
-0001b9d0: 676d 6c5f 6765 6c75 0a0a 7374 7275 6374  gml_gelu..struct
-0001b9e0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001b9f0: 676d 6c5f 6765 6c75 5f69 6d70 6c28 0a20  gml_gelu_impl(. 
-0001ba00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001ba10: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001ba20: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001ba30: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0001ba40: 2c0a 2020 2020 2020 2020 626f 6f6c 2069  ,.        bool i
-0001ba50: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-0001ba60: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0001ba70: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-0001ba80: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
-0001ba90: 6429 2920 7b0a 2020 2020 2020 2020 6973  d)) {.        is
-0001baa0: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0001bab0: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0001bac0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001bad0: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0001bae0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0001baf0: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0001bb00: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0001bb10: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-0001bb20: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0001bb30: 5f47 454c 553b 0a20 2020 2072 6573 756c  _GELU;.    resul
-0001bb40: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0001bb50: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0001bb60: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0001bb70: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0001bb80: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0001bb90: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0001bba0: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
-0001bbb0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
-0001bbc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001bbd0: 7220 2a20 6767 6d6c 5f67 656c 7528 0a20  r * ggml_gelu(. 
-0001bbe0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001bbf0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001bc00: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001bc10: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001bc20: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
-0001bc30: 6767 6d6c 5f67 656c 755f 696d 706c 2863  ggml_gelu_impl(c
-0001bc40: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
-0001bc50: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001bc60: 6e73 6f72 202a 2067 676d 6c5f 6765 6c75  nsor * ggml_gelu
-0001bc70: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
-0001bc80: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-0001bc90: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-0001bca0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001bcb0: 5f74 656e 736f 7220 202a 2061 2920 7b0a  _tensor  * a) {.
-0001bcc0: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-0001bcd0: 6765 6c75 5f69 6d70 6c28 6374 782c 2061  gelu_impl(ctx, a
-0001bce0: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
-0001bcf0: 676d 6c5f 7369 6c75 0a0a 7374 7275 6374  gml_silu..struct
-0001bd00: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001bd10: 676d 6c5f 7369 6c75 5f69 6d70 6c28 0a20  gml_silu_impl(. 
-0001bd20: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001bd30: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001bd40: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001bd50: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0001bd60: 2c0a 2020 2020 2020 2020 626f 6f6c 2069  ,.        bool i
-0001bd70: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-0001bd80: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0001bd90: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-0001bda0: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
-0001bdb0: 6429 2920 7b0a 2020 2020 2020 2020 6973  d)) {.        is
-0001bdc0: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0001bdd0: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0001bde0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001bdf0: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0001be00: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0001be10: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0001be20: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0001be30: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-0001be40: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0001be50: 5f53 494c 553b 0a20 2020 2072 6573 756c  _SILU;.    resul
-0001be60: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0001be70: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0001be80: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0001be90: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0001bea0: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0001beb0: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0001bec0: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
-0001bed0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
-0001bee0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001bef0: 7220 2a20 6767 6d6c 5f73 696c 7528 0a20  r * ggml_silu(. 
-0001bf00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001bf10: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001bf20: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001bf30: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001bf40: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
-0001bf50: 6767 6d6c 5f73 696c 755f 696d 706c 2863  ggml_silu_impl(c
-0001bf60: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
-0001bf70: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001bf80: 6e73 6f72 202a 2067 676d 6c5f 7369 6c75  nsor * ggml_silu
-0001bf90: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
-0001bfa0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-0001bfb0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-0001bfc0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001bfd0: 5f74 656e 736f 7220 202a 2061 2920 7b0a  _tensor  * a) {.
-0001bfe0: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-0001bff0: 7369 6c75 5f69 6d70 6c28 6374 782c 2061  silu_impl(ctx, a
-0001c000: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
-0001c010: 676d 6c5f 6e6f 726d 0a0a 7374 7275 6374  gml_norm..struct
-0001c020: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001c030: 676d 6c5f 6e6f 726d 5f69 6d70 6c28 0a20  gml_norm_impl(. 
-0001c040: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001c050: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001c060: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001c070: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001c080: 612c 0a20 2020 2020 2020 2062 6f6f 6c20  a,.        bool 
-0001c090: 696e 706c 6163 6529 207b 0a20 2020 2062  inplace) {.    b
-0001c0a0: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0001c0b0: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
-0001c0c0: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
-0001c0d0: 6164 2929 207b 0a20 2020 2020 2020 2047  ad)) {.        G
-0001c0e0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0001c0f0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
-0001c100: 656d 656e 7420 6261 636b 7761 7264 0a20  ement backward. 
-0001c110: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
-0001c120: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
-0001c130: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0001c140: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-0001c150: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
-0001c160: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
-0001c170: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
-0001c180: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
-0001c190: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
-0001c1a0: 3d20 4747 4d4c 5f4f 505f 4e4f 524d 3b0a  = GGML_OP_NORM;.
-0001c1b0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-0001c1c0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-0001c1d0: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-0001c1e0: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-0001c1f0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0001c200: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-0001c210: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
-0001c220: 202f 2f20 544f 444f 3a20 6d61 7962 6520   // TODO: maybe 
-0001c230: 7374 6f72 6520 6570 7369 6c6f 6e20 6865  store epsilon he
-0001c240: 7265 3f0a 0a20 2020 2072 6574 7572 6e20  re?..    return 
-0001c250: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
-0001c260: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001c270: 6767 6d6c 5f6e 6f72 6d28 0a20 2020 2020  ggml_norm(.     
-0001c280: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001c290: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001c2a0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001c2b0: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
-0001c2c0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-0001c2d0: 5f6e 6f72 6d5f 696d 706c 2863 7478 2c20  _norm_impl(ctx, 
-0001c2e0: 612c 2066 616c 7365 293b 0a7d 0a0a 7374  a, false);.}..st
-0001c2f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001c300: 202a 2067 676d 6c5f 6e6f 726d 5f69 6e70   * ggml_norm_inp
-0001c310: 6c61 6365 280a 2020 2020 2020 2020 7374  lace(.        st
-0001c320: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-0001c330: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-0001c340: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001c350: 736f 7220 202a 2061 2920 7b0a 2020 2020  sor  * a) {.    
-0001c360: 7265 7475 726e 2067 676d 6c5f 6e6f 726d  return ggml_norm
-0001c370: 5f69 6d70 6c28 6374 782c 2061 2c20 7472  _impl(ctx, a, tr
-0001c380: 7565 293b 0a7d 0a0a 7374 7275 6374 2067  ue);.}..struct g
+0001b730: 6e70 6c61 6365 2920 7b0a 2020 2020 4747  nplace) {.    GG
+0001b740: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f61  ML_ASSERT(ggml_a
+0001b750: 7265 5f73 616d 655f 7368 6170 6528 612c  re_same_shape(a,
+0001b760: 2062 2929 3b0a 0a20 2020 2062 6f6f 6c20   b));..    bool 
+0001b770: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
+0001b780: 0a0a 2020 2020 6966 2028 2169 6e70 6c61  ..    if (!inpla
+0001b790: 6365 2026 2620 2861 2d3e 6772 6164 207c  ce && (a->grad |
+0001b7a0: 7c20 622d 3e67 7261 6429 2920 7b0a 2020  | b->grad)) {.  
+0001b7b0: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
+0001b7c0: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
+0001b7d0: 2069 6620 2869 6e70 6c61 6365 2920 7b0a   if (inplace) {.
+0001b7e0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0001b7f0: 4552 5428 6973 5f6e 6f64 6520 3d3d 2066  ERT(is_node == f
+0001b800: 616c 7365 293b 0a20 2020 207d 0a0a 2020  alse);.    }..  
+0001b810: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0001b820: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+0001b830: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
+0001b840: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
+0001b850: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
+0001b860: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
+0001b870: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
+0001b880: 3d20 4747 4d4c 5f4f 505f 4d55 4c3b 0a20  = GGML_OP_MUL;. 
+0001b890: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+0001b8a0: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+0001b8b0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+0001b8c0: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+0001b8d0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0001b8e0: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+0001b8f0: 742d 3e73 7263 3120 3d20 623b 0a0a 2020  t->src1 = b;..  
+0001b900: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
+0001b910: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+0001b920: 7465 6e73 6f72 202a 2067 676d 6c5f 6d75  tensor * ggml_mu
+0001b930: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
+0001b940: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+0001b950: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+0001b960: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001b970: 2020 2a20 612c 0a20 2020 2020 2020 2073    * a,.        s
+0001b980: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001b990: 7220 202a 2062 2920 7b0a 2020 2020 7265  r  * b) {.    re
+0001b9a0: 7475 726e 2067 676d 6c5f 6d75 6c5f 696d  turn ggml_mul_im
+0001b9b0: 706c 2863 7478 2c20 612c 2062 2c20 6661  pl(ctx, a, b, fa
+0001b9c0: 6c73 6529 3b0a 7d0a 0a73 7472 7563 7420  lse);.}..struct 
+0001b9d0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0001b9e0: 6d6c 5f6d 756c 5f69 6e70 6c61 6365 280a  ml_mul_inplace(.
+0001b9f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001ba00: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001ba10: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001ba20: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0001ba30: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
+0001ba40: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0001ba50: 2a20 6229 207b 0a20 2020 2072 6574 7572  * b) {.    retur
+0001ba60: 6e20 6767 6d6c 5f6d 756c 5f69 6d70 6c28  n ggml_mul_impl(
+0001ba70: 6374 782c 2061 2c20 622c 2074 7275 6529  ctx, a, b, true)
+0001ba80: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f64 6976  ;.}..// ggml_div
+0001ba90: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0001baa0: 6e73 6f72 202a 2067 676d 6c5f 6469 765f  nsor * ggml_div_
+0001bab0: 696d 706c 280a 2020 2020 2020 2020 7374  impl(.        st
+0001bac0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0001bad0: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+0001bae0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0001baf0: 736f 7220 2a20 612c 0a20 2020 2020 2020  sor * a,.       
+0001bb00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0001bb10: 736f 7220 2a20 622c 0a20 2020 2020 2020  sor * b,.       
+0001bb20: 2062 6f6f 6c20 696e 706c 6163 6529 207b   bool inplace) {
+0001bb30: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0001bb40: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+0001bb50: 6861 7065 2861 2c20 6229 293b 0a0a 2020  hape(a, b));..  
+0001bb60: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+0001bb70: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+0001bb80: 2821 696e 706c 6163 6520 2626 2028 612d  (!inplace && (a-
+0001bb90: 3e67 7261 6420 7c7c 2062 2d3e 6772 6164  >grad || b->grad
+0001bba0: 2929 207b 0a20 2020 2020 2020 2069 735f  )) {.        is_
+0001bbb0: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0001bbc0: 207d 0a0a 2020 2020 6966 2028 696e 706c   }..    if (inpl
+0001bbd0: 6163 6529 207b 0a20 2020 2020 2020 2047  ace) {.        G
+0001bbe0: 474d 4c5f 4153 5345 5254 2869 735f 6e6f  GML_ASSERT(is_no
+0001bbf0: 6465 203d 3d20 6661 6c73 6529 3b0a 2020  de == false);.  
+0001bc00: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
+0001bc10: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+0001bc20: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
+0001bc30: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
+0001bc40: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
+0001bc50: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+0001bc60: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
+0001bc70: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+0001bc80: 5f44 4956 3b0a 2020 2020 7265 7375 6c74  _DIV;.    result
+0001bc90: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+0001bca0: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+0001bcb0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+0001bcc0: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+0001bcd0: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+0001bce0: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+0001bcf0: 2062 3b0a 0a20 2020 2072 6574 7572 6e20   b;..    return 
+0001bd00: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
+0001bd10: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001bd20: 6767 6d6c 5f64 6976 280a 2020 2020 2020  ggml_div(.      
+0001bd30: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+0001bd40: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+0001bd50: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0001bd60: 5f74 656e 736f 7220 202a 2061 2c0a 2020  _tensor  * a,.  
+0001bd70: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001bd80: 6c5f 7465 6e73 6f72 2020 2a20 6229 207b  l_tensor  * b) {
+0001bd90: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
+0001bda0: 5f64 6976 5f69 6d70 6c28 6374 782c 2061  _div_impl(ctx, a
+0001bdb0: 2c20 622c 2066 616c 7365 293b 0a7d 0a0a  , b, false);.}..
+0001bdc0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001bdd0: 6f72 202a 2067 676d 6c5f 6469 765f 696e  or * ggml_div_in
+0001bde0: 706c 6163 6528 0a20 2020 2020 2020 2073  place(.        s
+0001bdf0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0001be00: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0001be10: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0001be20: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
+0001be30: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001be40: 656e 736f 7220 202a 2062 2920 7b0a 2020  ensor  * b) {.  
+0001be50: 2020 7265 7475 726e 2067 676d 6c5f 6469    return ggml_di
+0001be60: 765f 696d 706c 2863 7478 2c20 612c 2062  v_impl(ctx, a, b
+0001be70: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
+0001be80: 676d 6c5f 7371 720a 0a73 7472 7563 7420  gml_sqr..struct 
+0001be90: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0001bea0: 6d6c 5f73 7172 5f69 6d70 6c28 0a20 2020  ml_sqr_impl(.   
+0001beb0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0001bec0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+0001bed0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001bee0: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
+0001bef0: 2020 2020 2020 2020 626f 6f6c 2069 6e70          bool inp
+0001bf00: 6c61 6365 2920 7b0a 2020 2020 626f 6f6c  lace) {.    bool
+0001bf10: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
+0001bf20: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
+0001bf30: 6163 6520 2626 2028 612d 3e67 7261 6429  ace && (a->grad)
+0001bf40: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
+0001bf50: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
+0001bf60: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
+0001bf70: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
+0001bf80: 6c74 203d 2069 6e70 6c61 6365 203f 2067  lt = inplace ? g
+0001bf90: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
+0001bfa0: 6374 782c 2061 2920 3a20 6767 6d6c 5f64  ctx, a) : ggml_d
+0001bfb0: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
+0001bfc0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
+0001bfd0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f53  op   = GGML_OP_S
+0001bfe0: 5152 3b0a 2020 2020 7265 7375 6c74 2d3e  QR;.    result->
+0001bff0: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
+0001c000: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
+0001c010: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
+0001c020: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
+0001c030: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
+0001c040: 7265 7375 6c74 2d3e 7372 6331 203d 204e  result->src1 = N
+0001c050: 554c 4c3b 0a0a 2020 2020 7265 7475 726e  ULL;..    return
+0001c060: 2072 6573 756c 743b 0a7d 0a0a 7374 7275   result;.}..stru
+0001c070: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0001c080: 2067 676d 6c5f 7371 7228 0a20 2020 2020   ggml_sqr(.     
+0001c090: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001c0a0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001c0b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001c0c0: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
+0001c0d0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
+0001c0e0: 5f73 7172 5f69 6d70 6c28 6374 782c 2061  _sqr_impl(ctx, a
+0001c0f0: 2c20 6661 6c73 6529 3b0a 7d0a 0a73 7472  , false);.}..str
+0001c100: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001c110: 2a20 6767 6d6c 5f73 7172 5f69 6e70 6c61  * ggml_sqr_inpla
+0001c120: 6365 280a 2020 2020 2020 2020 7374 7275  ce(.        stru
+0001c130: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0001c140: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0001c150: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001c160: 7220 202a 2061 2920 7b0a 2020 2020 7265  r  * a) {.    re
+0001c170: 7475 726e 2067 676d 6c5f 7371 725f 696d  turn ggml_sqr_im
+0001c180: 706c 2863 7478 2c20 612c 2074 7275 6529  pl(ctx, a, true)
+0001c190: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f73 7172  ;.}..// ggml_sqr
+0001c1a0: 740a 0a73 7472 7563 7420 6767 6d6c 5f74  t..struct ggml_t
+0001c1b0: 656e 736f 7220 2a20 6767 6d6c 5f73 7172  ensor * ggml_sqr
+0001c1c0: 745f 696d 706c 280a 2020 2020 2020 2020  t_impl(.        
+0001c1d0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0001c1e0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0001c1f0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001c200: 656e 736f 7220 2a20 612c 0a20 2020 2020  ensor * a,.     
+0001c210: 2020 2062 6f6f 6c20 696e 706c 6163 6529     bool inplace)
+0001c220: 207b 0a20 2020 2062 6f6f 6c20 6973 5f6e   {.    bool is_n
+0001c230: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
+0001c240: 2020 6966 2028 2169 6e70 6c61 6365 2026    if (!inplace &
+0001c250: 2620 2861 2d3e 6772 6164 2929 207b 0a20  & (a->grad)) {. 
+0001c260: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
+0001c270: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
+0001c280: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0001c290: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+0001c2a0: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
+0001c2b0: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
+0001c2c0: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
+0001c2d0: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
+0001c2e0: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
+0001c2f0: 3d20 4747 4d4c 5f4f 505f 5351 5254 3b0a  = GGML_OP_SQRT;.
+0001c300: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
+0001c310: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
+0001c320: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+0001c330: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
+0001c340: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+0001c350: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
+0001c360: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
+0001c370: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
+0001c380: 756c 743b 0a7d 0a0a 7374 7275 6374 2067  ult;.}..struct g
 0001c390: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0001c3a0: 6c5f 726d 735f 6e6f 726d 5f69 6d70 6c28  l_rms_norm_impl(
-0001c3b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001c3c0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0001c3d0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0001c3e0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-0001c3f0: 2a20 612c 0a20 2020 2020 2020 2062 6f6f  * a,.        boo
-0001c400: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
-0001c410: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0001c420: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0001c430: 2169 6e70 6c61 6365 2026 2620 2861 2d3e  !inplace && (a->
-0001c440: 6772 6164 2929 207b 0a20 2020 2020 2020  grad)) {.       
-0001c450: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0001c460: 7365 293b 202f 2f20 544f 444f 3a20 696d  se); // TODO: im
-0001c470: 706c 656d 656e 7420 6261 636b 7761 7264  plement backward
-0001c480: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
-0001c490: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
-0001c4a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001c4b0: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-0001c4c0: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
-0001c4d0: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
-0001c4e0: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
-0001c4f0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
-0001c500: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
-0001c510: 2020 3d20 4747 4d4c 5f4f 505f 524d 535f    = GGML_OP_RMS_
-0001c520: 4e4f 524d 3b0a 2020 2020 7265 7375 6c74  NORM;.    result
-0001c530: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-0001c540: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-0001c550: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-0001c560: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-0001c570: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-0001c580: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-0001c590: 204e 554c 4c3b 202f 2f20 544f 444f 3a20   NULL; // TODO: 
-0001c5a0: 6d61 7962 6520 7374 6f72 6520 6570 7369  maybe store epsi
-0001c5b0: 6c6f 6e20 6865 7265 3f0a 0a20 2020 2072  lon here?..    r
-0001c5c0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-0001c5d0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0001c5e0: 736f 7220 2a20 6767 6d6c 5f72 6d73 5f6e  sor * ggml_rms_n
-0001c5f0: 6f72 6d28 0a20 2020 2020 2020 2073 7472  orm(.        str
-0001c600: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0001c610: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0001c620: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001c630: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
-0001c640: 6574 7572 6e20 6767 6d6c 5f72 6d73 5f6e  eturn ggml_rms_n
-0001c650: 6f72 6d5f 696d 706c 2863 7478 2c20 612c  orm_impl(ctx, a,
-0001c660: 2066 616c 7365 293b 0a7d 0a0a 7374 7275   false);.}..stru
-0001c670: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001c680: 2067 676d 6c5f 726d 735f 6e6f 726d 5f69   ggml_rms_norm_i
-0001c690: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0001c6a0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0001c6b0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0001c6c0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0001c6d0: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0001c6e0: 2020 7265 7475 726e 2067 676d 6c5f 726d    return ggml_rm
-0001c6f0: 735f 6e6f 726d 5f69 6d70 6c28 6374 782c  s_norm_impl(ctx,
-0001c700: 2061 2c20 7472 7565 293b 0a7d 0a0a 2f2f   a, true);.}..//
-0001c710: 2067 676d 6c5f 6d75 6c5f 6d61 740a 0a73   ggml_mul_mat..s
-0001c720: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001c730: 7220 2a20 6767 6d6c 5f6d 756c 5f6d 6174  r * ggml_mul_mat
-0001c740: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0001c750: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0001c760: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0001c770: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001c780: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-0001c790: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001c7a0: 2020 2a20 6229 207b 0a20 2020 2047 474d    * b) {.    GGM
-0001c7b0: 4c5f 4153 5345 5254 2867 676d 6c5f 6361  L_ASSERT(ggml_ca
-0001c7c0: 6e5f 6d75 6c5f 6d61 7428 612c 2062 2929  n_mul_mat(a, b))
-0001c7d0: 3b0a 0a20 2020 2062 6f6f 6c20 6973 5f6e  ;..    bool is_n
-0001c7e0: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
-0001c7f0: 2020 6966 2028 612d 3e67 7261 6420 7c7c    if (a->grad ||
-0001c800: 2062 2d3e 6772 6164 2920 7b0a 2020 2020   b->grad) {.    
-0001c810: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-0001c820: 7565 3b0a 2020 2020 7d0a 0a20 2020 2063  ue;.    }..    c
-0001c830: 6f6e 7374 2069 6e74 206e 655b 345d 203d  onst int ne[4] =
-0001c840: 207b 2061 2d3e 6e65 5b31 5d2c 2062 2d3e   { a->ne[1], b->
-0001c850: 6e65 5b31 5d2c 2061 2d3e 6e65 5b32 5d2c  ne[1], a->ne[2],
-0001c860: 2062 2d3e 6e65 5b33 5d20 7d3b 0a20 2020   b->ne[3] };.   
-0001c870: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001c880: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
-0001c890: 676d 6c5f 6e65 775f 7465 6e73 6f72 2863  gml_new_tensor(c
-0001c8a0: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-0001c8b0: 322c 204d 494e 2861 2d3e 6e5f 6469 6d73  2, MIN(a->n_dims
-0001c8c0: 2c20 622d 3e6e 5f64 696d 7329 2c20 6e65  , b->n_dims), ne
-0001c8d0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0001c8e0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f4d  op   = GGML_OP_M
-0001c8f0: 554c 5f4d 4154 3b0a 2020 2020 7265 7375  UL_MAT;.    resu
-0001c900: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
-0001c910: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
-0001c920: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
-0001c930: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
-0001c940: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
-0001c950: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
-0001c960: 203d 2062 3b0a 0a20 2020 2072 6574 7572   = b;..    retur
-0001c970: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
-0001c980: 6767 6d6c 5f73 6361 6c65 0a0a 7374 7275  ggml_scale..stru
-0001c990: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001c9a0: 2067 676d 6c5f 7363 616c 655f 696d 706c   ggml_scale_impl
-0001c9b0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0001c9c0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0001c9d0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0001c9e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001c9f0: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-0001ca00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001ca10: 2020 2a20 622c 0a20 2020 2020 2020 2062    * b,.        b
-0001ca20: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
-0001ca30: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-0001ca40: 676d 6c5f 6973 5f73 6361 6c61 7228 6229  gml_is_scalar(b)
-0001ca50: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0001ca60: 5254 2867 676d 6c5f 6973 5f70 6164 6465  RT(ggml_is_padde
-0001ca70: 645f 3164 2861 2929 3b0a 0a20 2020 2062  d_1d(a));..    b
-0001ca80: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0001ca90: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
-0001caa0: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
-0001cab0: 6164 207c 7c20 622d 3e67 7261 6429 2920  ad || b->grad)) 
-0001cac0: 7b0a 2020 2020 2020 2020 4747 4d4c 5f41  {.        GGML_A
-0001cad0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
-0001cae0: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
-0001caf0: 2062 6163 6b77 6172 640a 2020 2020 2020   backward.      
-0001cb00: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
-0001cb10: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-0001cb20: 544f 444f 3a20 7768 656e 2069 6d70 6c65  TODO: when imple
-0001cb30: 6d65 6e74 2062 6163 6b77 6172 642c 2066  ment backward, f
-0001cb40: 6978 2074 6869 733a 0a20 2020 202f 2f73  ix this:.    //s
-0001cb50: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001cb60: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
-0001cb70: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
-0001cb80: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
-0001cb90: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
-0001cba0: 7228 6374 782c 2061 293b 0a20 2020 2073  r(ctx, a);.    s
-0001cbb0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001cbc0: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-0001cbd0: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
-0001cbe0: 782c 2061 293b 0a0a 2020 2020 7265 7375  x, a);..    resu
-0001cbf0: 6c74 2d3e 6f70 2020 203d 2047 474d 4c5f  lt->op   = GGML_
-0001cc00: 4f50 5f53 4341 4c45 3b0a 2020 2020 7265  OP_SCALE;.    re
-0001cc10: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-0001cc20: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-0001cc30: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-0001cc40: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-0001cc50: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-0001cc60: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0001cc70: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
-0001cc80: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
-0001cc90: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001cca0: 7220 2a20 6767 6d6c 5f73 6361 6c65 280a  r * ggml_scale(.
-0001ccb0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0001ccc0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0001ccd0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-0001cce0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001ccf0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-0001cd00: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001cd10: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
-0001cd20: 6767 6d6c 5f73 6361 6c65 5f69 6d70 6c28  ggml_scale_impl(
-0001cd30: 6374 782c 2061 2c20 622c 2066 616c 7365  ctx, a, b, false
-0001cd40: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
-0001cd50: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-0001cd60: 7363 616c 655f 696e 706c 6163 6528 0a20  scale_inplace(. 
-0001cd70: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001cd80: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001cd90: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001cda0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0001cdb0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001cdc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
+0001c3a0: 6c5f 7371 7274 280a 2020 2020 2020 2020  l_sqrt(.        
+0001c3b0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0001c3c0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0001c3d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001c3e0: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
+0001c3f0: 2020 7265 7475 726e 2067 676d 6c5f 7371    return ggml_sq
+0001c400: 7274 5f69 6d70 6c28 6374 782c 2061 2c20  rt_impl(ctx, a, 
+0001c410: 6661 6c73 6529 3b0a 7d0a 0a73 7472 7563  false);.}..struc
+0001c420: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001c430: 6767 6d6c 5f73 7172 745f 696e 706c 6163  ggml_sqrt_inplac
+0001c440: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
+0001c450: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+0001c460: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+0001c470: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001c480: 2020 2a20 6129 207b 0a20 2020 2072 6574    * a) {.    ret
+0001c490: 7572 6e20 6767 6d6c 5f73 7172 745f 696d  urn ggml_sqrt_im
+0001c4a0: 706c 2863 7478 2c20 612c 2074 7275 6529  pl(ctx, a, true)
+0001c4b0: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f73 756d  ;.}..// ggml_sum
+0001c4c0: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0001c4d0: 6e73 6f72 202a 2067 676d 6c5f 7375 6d28  nsor * ggml_sum(
+0001c4e0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001c4f0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0001c500: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0001c510: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0001c520: 2061 2920 7b0a 2020 2020 626f 6f6c 2069   a) {.    bool i
+0001c530: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+0001c540: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+0001c550: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
+0001c560: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
+0001c570: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
+0001c580: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
+0001c590: 6c74 203d 2067 676d 6c5f 6e65 775f 7465  lt = ggml_new_te
+0001c5a0: 6e73 6f72 5f31 6428 6374 782c 2061 2d3e  nsor_1d(ctx, a->
+0001c5b0: 7479 7065 2c20 3129 3b0a 0a20 2020 2072  type, 1);..    r
+0001c5c0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+0001c5d0: 4d4c 5f4f 505f 5355 4d3b 0a20 2020 2072  ML_OP_SUM;.    r
+0001c5e0: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+0001c5f0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+0001c600: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+0001c610: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+0001c620: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+0001c630: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+0001c640: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
+0001c650: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+0001c660: 7d0a 0a2f 2f20 6767 6d6c 5f6d 6561 6e0a  }..// ggml_mean.
+0001c670: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0001c680: 736f 7220 2a20 6767 6d6c 5f6d 6561 6e28  sor * ggml_mean(
+0001c690: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001c6a0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0001c6b0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0001c6c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0001c6d0: 2061 2920 7b0a 2020 2020 626f 6f6c 2069   a) {.    bool i
+0001c6e0: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+0001c6f0: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+0001c700: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
+0001c710: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+0001c720: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
+0001c730: 6e74 0a20 2020 2020 2020 2069 735f 6e6f  nt.        is_no
+0001c740: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
+0001c750: 0a0a 2020 2020 696e 7420 6e65 5b47 474d  ..    int ne[GGM
+0001c760: 4c5f 4d41 585f 4449 4d53 5d20 3d20 7b20  L_MAX_DIMS] = { 
+0001c770: 312c 2061 2d3e 6e65 5b31 5d2c 2061 2d3e  1, a->ne[1], a->
+0001c780: 6e65 5b32 5d2c 2061 2d3e 6e65 5b33 5d20  ne[2], a->ne[3] 
+0001c790: 7d3b 0a20 2020 2073 7472 7563 7420 6767  };.    struct gg
+0001c7a0: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
+0001c7b0: 6c74 203d 2067 676d 6c5f 6e65 775f 7465  lt = ggml_new_te
+0001c7c0: 6e73 6f72 2863 7478 2c20 4747 4d4c 5f54  nsor(ctx, GGML_T
+0001c7d0: 5950 455f 4633 322c 2061 2d3e 6e5f 6469  YPE_F32, a->n_di
+0001c7e0: 6d73 2c20 6e65 293b 0a0a 2020 2020 7265  ms, ne);..    re
+0001c7f0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+0001c800: 4c5f 4f50 5f4d 4541 4e3b 0a20 2020 2072  L_OP_MEAN;.    r
+0001c810: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+0001c820: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+0001c830: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+0001c840: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+0001c850: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+0001c860: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+0001c870: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
+0001c880: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+0001c890: 7d0a 0a2f 2f20 6767 6d6c 5f72 6570 6561  }..// ggml_repea
+0001c8a0: 740a 0a73 7472 7563 7420 6767 6d6c 5f74  t..struct ggml_t
+0001c8b0: 656e 736f 7220 2a20 6767 6d6c 5f72 6570  ensor * ggml_rep
+0001c8c0: 6561 7428 0a20 2020 2020 2020 2073 7472  eat(.        str
+0001c8d0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001c8e0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001c8f0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001c900: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+0001c910: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001c920: 6f72 202a 2062 2920 7b0a 2020 2020 4747  or * b) {.    GG
+0001c930: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f63  ML_ASSERT(ggml_c
+0001c940: 616e 5f72 6570 6561 7428 612c 2062 2929  an_repeat(a, b))
+0001c950: 3b0a 0a20 2020 2062 6f6f 6c20 6973 5f6e  ;..    bool is_n
+0001c960: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
+0001c970: 2020 6966 2028 612d 3e67 7261 6429 207b    if (a->grad) {
+0001c980: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
+0001c990: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
+0001c9a0: 2020 2020 6966 2028 6767 6d6c 5f61 7265      if (ggml_are
+0001c9b0: 5f73 616d 655f 7368 6170 6528 612c 2062  _same_shape(a, b
+0001c9c0: 2920 2626 2021 6973 5f6e 6f64 6529 207b  ) && !is_node) {
+0001c9d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001c9e0: 613b 0a20 2020 207d 0a0a 2020 2020 7374  a;.    }..    st
+0001c9f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001ca00: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
+0001ca10: 5f6e 6577 5f74 656e 736f 7228 6374 782c  _new_tensor(ctx,
+0001ca20: 2061 2d3e 7479 7065 2c20 622d 3e6e 5f64   a->type, b->n_d
+0001ca30: 696d 732c 2062 2d3e 6e65 293b 0a0a 2020  ims, b->ne);..  
+0001ca40: 2020 7265 7375 6c74 2d3e 6f70 2020 203d    result->op   =
+0001ca50: 2047 474d 4c5f 4f50 5f52 4550 4541 543b   GGML_OP_REPEAT;
+0001ca60: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+0001ca70: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+0001ca80: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0001ca90: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+0001caa0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+0001cab0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+0001cac0: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
+0001cad0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001cae0: 743b 0a7d 0a0a 2f2f 2067 676d 6c5f 6162  t;.}..// ggml_ab
+0001caf0: 730a 0a73 7472 7563 7420 6767 6d6c 5f74  s..struct ggml_t
+0001cb00: 656e 736f 7220 2a20 6767 6d6c 5f61 6273  ensor * ggml_abs
+0001cb10: 5f69 6d70 6c28 0a20 2020 2020 2020 2073  _impl(.        s
+0001cb20: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0001cb30: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0001cb40: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0001cb50: 6e73 6f72 202a 2061 2c0a 2020 2020 2020  nsor * a,.      
+0001cb60: 2020 626f 6f6c 2069 6e70 6c61 6365 2920    bool inplace) 
+0001cb70: 7b0a 2020 2020 626f 6f6c 2069 735f 6e6f  {.    bool is_no
+0001cb80: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+0001cb90: 2069 6620 2821 696e 706c 6163 6520 2626   if (!inplace &&
+0001cba0: 2028 612d 3e67 7261 6429 2920 7b0a 2020   (a->grad)) {.  
+0001cbb0: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
+0001cbc0: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
+0001cbd0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0001cbe0: 736f 7220 2a20 7265 7375 6c74 203d 2069  sor * result = i
+0001cbf0: 6e70 6c61 6365 203f 2067 676d 6c5f 7669  nplace ? ggml_vi
+0001cc00: 6577 5f74 656e 736f 7228 6374 782c 2061  ew_tensor(ctx, a
+0001cc10: 2920 3a20 6767 6d6c 5f64 7570 5f74 656e  ) : ggml_dup_ten
+0001cc20: 736f 7228 6374 782c 2061 293b 0a0a 2020  sor(ctx, a);..  
+0001cc30: 2020 7265 7375 6c74 2d3e 6f70 2020 203d    result->op   =
+0001cc40: 2047 474d 4c5f 4f50 5f41 4253 3b0a 2020   GGML_OP_ABS;.  
+0001cc50: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
+0001cc60: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
+0001cc70: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0001cc80: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
+0001cc90: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+0001cca0: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+0001ccb0: 2d3e 7372 6331 203d 204e 554c 4c3b 0a0a  ->src1 = NULL;..
+0001ccc0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001ccd0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+0001cce0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+0001ccf0: 6162 7328 0a20 2020 2020 2020 2073 7472  abs(.        str
+0001cd00: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001cd10: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001cd20: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001cd30: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
+0001cd40: 6574 7572 6e20 6767 6d6c 5f61 6273 5f69  eturn ggml_abs_i
+0001cd50: 6d70 6c28 6374 782c 2061 2c20 6661 6c73  mpl(ctx, a, fals
+0001cd60: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
+0001cd70: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0001cd80: 5f61 6273 5f69 6e70 6c61 6365 280a 2020  _abs_inplace(.  
+0001cd90: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001cda0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0001cdb0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001cdc0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
 0001cdd0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-0001cde0: 676d 6c5f 7363 616c 655f 696d 706c 2863  gml_scale_impl(c
-0001cdf0: 7478 2c20 612c 2062 2c20 7472 7565 293b  tx, a, b, true);
-0001ce00: 0a7d 0a0a 2f2f 2067 676d 6c5f 6370 790a  .}..// ggml_cpy.
-0001ce10: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0001ce20: 736f 7220 2a20 6767 6d6c 5f63 7079 5f69  sor * ggml_cpy_i
-0001ce30: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
-0001ce40: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0001ce50: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0001ce60: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001ce70: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
-0001ce80: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001ce90: 736f 7220 202a 2062 2c0a 2020 2020 2020  sor  * b,.      
-0001cea0: 2020 626f 6f6c 2069 6e70 6c61 6365 2920    bool inplace) 
-0001ceb0: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-0001cec0: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
-0001ced0: 2861 2920 3d3d 2067 676d 6c5f 6e65 6c65  (a) == ggml_nele
-0001cee0: 6d65 6e74 7328 6229 293b 0a0a 2020 2020  ments(b));..    
-0001cef0: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
-0001cf00: 616c 7365 3b0a 0a20 2020 2069 6620 2821  alse;..    if (!
-0001cf10: 696e 706c 6163 6520 2626 2028 612d 3e67  inplace && (a->g
-0001cf20: 7261 6420 7c7c 2062 2d3e 6772 6164 2929  rad || b->grad))
-0001cf30: 207b 0a20 2020 2020 2020 2047 474d 4c5f   {.        GGML_
-0001cf40: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-0001cf50: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
-0001cf60: 7420 6261 636b 7761 7264 0a20 2020 2020  t backward.     
-0001cf70: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-0001cf80: 653b 0a20 2020 207d 0a0a 2020 2020 2f2f  e;.    }..    //
-0001cf90: 206d 616b 6520 6120 7669 6577 206f 6620   make a view of 
-0001cfa0: 7468 6520 6465 7374 696e 6174 696f 6e0a  the destination.
-0001cfb0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001cfc0: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-0001cfd0: 3d20 6767 6d6c 5f76 6965 775f 7465 6e73  = ggml_view_tens
-0001cfe0: 6f72 2863 7478 2c20 6229 3b0a 0a20 2020  or(ctx, b);..   
-0001cff0: 2072 6573 756c 742d 3e6f 7020 2020 3d20   result->op   = 
-0001d000: 4747 4d4c 5f4f 505f 4350 593b 0a20 2020  GGML_OP_CPY;.   
-0001d010: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
-0001d020: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
-0001d030: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
-0001d040: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
-0001d050: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
-0001d060: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
-0001d070: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
-0001d080: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-0001d090: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001d0a0: 6e73 6f72 202a 2067 676d 6c5f 6370 7928  nsor * ggml_cpy(
-0001d0b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001d0c0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0001d0d0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0001d0e0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001d0f0: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
-0001d100: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001d110: 2062 2920 7b0a 2020 2020 7265 7475 726e   b) {.    return
-0001d120: 2067 676d 6c5f 6370 795f 696d 706c 2863   ggml_cpy_impl(c
-0001d130: 7478 2c20 612c 2062 2c20 6661 6c73 6529  tx, a, b, false)
-0001d140: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-0001d150: 5f74 656e 736f 7220 2a20 6767 6d6c 5f63  _tensor * ggml_c
-0001d160: 7079 5f69 6e70 6c61 6365 280a 2020 2020  py_inplace(.    
-0001d170: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001d180: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-0001d190: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001d1a0: 6d6c 5f74 656e 736f 7220 2a20 612c 0a20  ml_tensor * a,. 
-0001d1b0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001d1c0: 6d6c 5f74 656e 736f 7220 2a20 6229 207b  ml_tensor * b) {
-0001d1d0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-0001d1e0: 5f63 7079 5f69 6d70 6c28 6374 782c 2061  _cpy_impl(ctx, a
-0001d1f0: 2c20 622c 2074 7275 6529 3b0a 7d0a 0a2f  , b, true);.}../
-0001d200: 2f20 6767 6d6c 5f72 6573 6861 7065 0a0a  / ggml_reshape..
-0001d210: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001d220: 6f72 202a 2067 676d 6c5f 7265 7368 6170  or * ggml_reshap
-0001d230: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
-0001d240: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-0001d250: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-0001d260: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001d270: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-0001d280: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001d290: 202a 2062 2920 7b0a 2020 2020 4747 4d4c   * b) {.    GGML
-0001d2a0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-0001d2b0: 636f 6e74 6967 756f 7573 2861 2929 3b0a  contiguous(a));.
-0001d2c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0001d2d0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
-0001d2e0: 7573 2862 2929 3b0a 2020 2020 4747 4d4c  us(b));.    GGML
-0001d2f0: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
-0001d300: 656d 656e 7473 2861 2920 3d3d 2067 676d  ements(a) == ggm
-0001d310: 6c5f 6e65 6c65 6d65 6e74 7328 6229 293b  l_nelements(b));
-0001d320: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
-0001d330: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
-0001d340: 2069 6620 2861 2d3e 6772 6164 207c 7c20   if (a->grad || 
-0001d350: 622d 3e67 7261 6429 207b 0a20 2020 2020  b->grad) {.     
-0001d360: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0001d370: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-0001d380: 696d 706c 656d 656e 7420 6261 636b 7761  implement backwa
-0001d390: 7264 0a20 2020 2020 2020 2069 735f 6e6f  rd.        is_no
-0001d3a0: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
-0001d3b0: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
-0001d3c0: 6c5f 7465 6e73 6f72 202a 2072 6573 756c  l_tensor * resul
-0001d3d0: 7420 3d20 6767 6d6c 5f6e 6577 5f74 656e  t = ggml_new_ten
-0001d3e0: 736f 725f 696d 706c 2863 7478 2c20 612d  sor_impl(ctx, a-
-0001d3f0: 3e74 7970 652c 2062 2d3e 6e5f 6469 6d73  >type, b->n_dims
-0001d400: 2c20 622d 3e6e 652c 2061 2d3e 6461 7461  , b->ne, a->data
-0001d410: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0001d420: 6f70 2020 203d 2047 474d 4c5f 4f50 5f52  op   = GGML_OP_R
-0001d430: 4553 4841 5045 3b0a 2020 2020 7265 7375  ESHAPE;.    resu
-0001d440: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
-0001d450: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
-0001d460: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
-0001d470: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
-0001d480: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
-0001d490: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
-0001d4a0: 203d 204e 554c 4c3b 0a0a 2020 2020 7265   = NULL;..    re
-0001d4b0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-0001d4c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001d4d0: 6f72 202a 2067 676d 6c5f 7265 7368 6170  or * ggml_reshap
-0001d4e0: 655f 3264 280a 2020 2020 2020 2020 7374  e_2d(.        st
-0001d4f0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-0001d500: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-0001d510: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001d520: 736f 7220 202a 2061 2c0a 2020 2020 2020  sor  * a,.      
-0001d530: 2020 696e 7420 2020 2020 2020 2020 2020    int           
-0001d540: 2020 2020 2020 2020 6e65 302c 0a20 2020          ne0,.   
-0001d550: 2020 2020 2069 6e74 2020 2020 2020 2020       int        
-0001d560: 2020 2020 2020 2020 2020 206e 6531 2920             ne1) 
-0001d570: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-0001d580: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-0001d590: 756f 7573 2861 2929 3b0a 2020 2020 4747  uous(a));.    GG
-0001d5a0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f6e  ML_ASSERT(ggml_n
-0001d5b0: 656c 656d 656e 7473 2861 2920 3d3d 206e  elements(a) == n
-0001d5c0: 6530 2a6e 6531 293b 0a0a 2020 2020 626f  e0*ne1);..    bo
-0001d5d0: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0001d5e0: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
-0001d5f0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0001d600: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0001d610: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
-0001d620: 6c65 6d65 6e74 2062 6163 6b77 6172 640a  lement backward.
-0001d630: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
-0001d640: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
-0001d650: 2020 2063 6f6e 7374 2069 6e74 206e 655b     const int ne[
-0001d660: 325d 203d 207b 206e 6530 2c20 6e65 3120  2] = { ne0, ne1 
-0001d670: 7d3b 0a20 2020 2073 7472 7563 7420 6767  };.    struct gg
-0001d680: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0001d690: 6c74 203d 2067 676d 6c5f 6e65 775f 7465  lt = ggml_new_te
-0001d6a0: 6e73 6f72 5f69 6d70 6c28 6374 782c 2061  nsor_impl(ctx, a
-0001d6b0: 2d3e 7479 7065 2c20 322c 206e 652c 2061  ->type, 2, ne, a
-0001d6c0: 2d3e 6461 7461 293b 0a0a 2020 2020 7265  ->data);..    re
-0001d6d0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-0001d6e0: 4c5f 4f50 5f52 4553 4841 5045 3b0a 2020  L_OP_RESHAPE;.  
-0001d6f0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-0001d700: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-0001d710: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-0001d720: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-0001d730: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-0001d740: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-0001d750: 2d3e 7372 6331 203d 204e 554c 4c3b 0a0a  ->src1 = NULL;..
-0001d760: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0001d770: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-0001d780: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-0001d790: 7265 7368 6170 655f 3364 280a 2020 2020  reshape_3d(.    
-0001d7a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001d7b0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-0001d7c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001d7d0: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-0001d7e0: 2020 2020 2020 2020 696e 7420 2020 2020          int     
-0001d7f0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001d800: 302c 0a20 2020 2020 2020 2069 6e74 2020  0,.        int  
-0001d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d820: 206e 6531 2c0a 2020 2020 2020 2020 696e   ne1,.        in
-0001d830: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-0001d840: 2020 2020 6e65 3229 207b 0a20 2020 2047      ne2) {.    G
-0001d850: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-0001d860: 6973 5f63 6f6e 7469 6775 6f75 7328 6129  is_contiguous(a)
-0001d870: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0001d880: 5254 2867 676d 6c5f 6e65 6c65 6d65 6e74  RT(ggml_nelement
-0001d890: 7328 6129 203d 3d20 6e65 302a 6e65 312a  s(a) == ne0*ne1*
-0001d8a0: 6e65 3229 3b0a 0a20 2020 2062 6f6f 6c20  ne2);..    bool 
-0001d8b0: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
-0001d8c0: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
-0001d8d0: 6429 207b 0a20 2020 2020 2020 2047 474d  d) {.        GGM
-0001d8e0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-0001d8f0: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
-0001d900: 656e 7420 6261 636b 7761 7264 0a20 2020  ent backward.   
-0001d910: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
-0001d920: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
-0001d930: 636f 6e73 7420 696e 7420 6e65 5b33 5d20  const int ne[3] 
-0001d940: 3d20 7b20 6e65 302c 206e 6531 2c20 6e65  = { ne0, ne1, ne
-0001d950: 3220 7d3b 0a20 2020 2073 7472 7563 7420  2 };.    struct 
-0001d960: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001d970: 7375 6c74 203d 2067 676d 6c5f 6e65 775f  sult = ggml_new_
-0001d980: 7465 6e73 6f72 5f69 6d70 6c28 6374 782c  tensor_impl(ctx,
-0001d990: 2061 2d3e 7479 7065 2c20 332c 206e 652c   a->type, 3, ne,
-0001d9a0: 2061 2d3e 6461 7461 293b 0a0a 2020 2020   a->data);..    
-0001d9b0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
-0001d9c0: 474d 4c5f 4f50 5f52 4553 4841 5045 3b0a  GML_OP_RESHAPE;.
-0001d9d0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-0001d9e0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-0001d9f0: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-0001da00: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-0001da10: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0001da20: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-0001da30: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
-0001da40: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
-0001da50: 756c 743b 0a7d 0a0a 2f2f 2067 676d 6c5f  ult;.}..// ggml_
-0001da60: 7669 6577 5f31 640a 0a73 7472 7563 7420  view_1d..struct 
-0001da70: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-0001da80: 6d6c 5f76 6965 775f 3164 280a 2020 2020  ml_view_1d(.    
-0001da90: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001daa0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-0001dab0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001dac0: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-0001dad0: 2020 2020 2020 2020 696e 7420 2020 2020          int     
-0001dae0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001daf0: 302c 0a20 2020 2020 2020 2073 697a 655f  0,.        size_
-0001db00: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-0001db10: 206f 6666 7365 7429 207b 0a20 2020 2069   offset) {.    i
-0001db20: 6620 2861 2d3e 6772 6164 2920 7b0a 2020  f (a->grad) {.  
-0001db30: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0001db40: 5428 6661 6c73 6529 3b20 2f2f 2067 7261  T(false); // gra
-0001db50: 6469 656e 7420 7072 6f70 6167 6174 696f  dient propagatio
-0001db60: 6e20 6973 206e 6f74 2073 7570 706f 7274  n is not support
-0001db70: 6564 0a20 2020 207d 0a0a 2020 2020 7374  ed.    }..    st
-0001db80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001db90: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
-0001dba0: 5f6e 6577 5f74 656e 736f 725f 696d 706c  _new_tensor_impl
-0001dbb0: 2863 7478 2c20 612d 3e74 7970 652c 2031  (ctx, a->type, 1
-0001dbc0: 2c20 266e 6530 2c20 2863 6861 7220 2a29  , &ne0, (char *)
-0001dbd0: 2061 2d3e 6461 7461 202b 206f 6666 7365   a->data + offse
-0001dbe0: 7429 3b0a 0a20 2020 2072 6573 756c 742d  t);..    result-
-0001dbf0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-0001dc00: 5649 4557 3b0a 2020 2020 7265 7375 6c74  VIEW;.    result
-0001dc10: 2d3e 6772 6164 203d 204e 554c 4c3b 0a20  ->grad = NULL;. 
+0001cde0: 676d 6c5f 6162 735f 696d 706c 2863 7478  gml_abs_impl(ctx
+0001cdf0: 2c20 612c 2074 7275 6529 3b0a 7d0a 0a0a  , a, true);.}...
+0001ce00: 2f2f 2067 676d 6c5f 7367 6e0a 0a73 7472  // ggml_sgn..str
+0001ce10: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001ce20: 2a20 6767 6d6c 5f73 676e 5f69 6d70 6c28  * ggml_sgn_impl(
+0001ce30: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001ce40: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0001ce50: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0001ce60: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0001ce70: 2061 2c0a 2020 2020 2020 2020 626f 6f6c   a,.        bool
+0001ce80: 2069 6e70 6c61 6365 2920 7b0a 2020 2020   inplace) {.    
+0001ce90: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+0001cea0: 616c 7365 3b0a 0a20 2020 2069 6620 2821  alse;..    if (!
+0001ceb0: 696e 706c 6163 6520 2626 2028 612d 3e67  inplace && (a->g
+0001cec0: 7261 6429 2920 7b0a 2020 2020 2020 2020  rad)) {.        
+0001ced0: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
+0001cee0: 2020 2020 7d0a 0a20 2020 2073 7472 7563      }..    struc
+0001cef0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001cf00: 7265 7375 6c74 203d 2069 6e70 6c61 6365  result = inplace
+0001cf10: 203f 2067 676d 6c5f 7669 6577 5f74 656e   ? ggml_view_ten
+0001cf20: 736f 7228 6374 782c 2061 2920 3a20 6767  sor(ctx, a) : gg
+0001cf30: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0001cf40: 782c 2061 293b 0a0a 2020 2020 7265 7375  x, a);..    resu
+0001cf50: 6c74 2d3e 6f70 2020 203d 2047 474d 4c5f  lt->op   = GGML_
+0001cf60: 4f50 5f53 474e 3b0a 2020 2020 7265 7375  OP_SGN;.    resu
+0001cf70: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
+0001cf80: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
+0001cf90: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
+0001cfa0: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
+0001cfb0: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
+0001cfc0: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
+0001cfd0: 203d 204e 554c 4c3b 0a0a 2020 2020 7265   = NULL;..    re
+0001cfe0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+0001cff0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d000: 6f72 202a 2067 676d 6c5f 7367 6e28 0a20  or * ggml_sgn(. 
+0001d010: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0001d020: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0001d030: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0001d040: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
+0001d050: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
+0001d060: 6767 6d6c 5f73 676e 5f69 6d70 6c28 6374  ggml_sgn_impl(ct
+0001d070: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
+0001d080: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0001d090: 736f 7220 2a20 6767 6d6c 5f73 676e 5f69  sor * ggml_sgn_i
+0001d0a0: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
+0001d0b0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0001d0c0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0001d0d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001d0e0: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
+0001d0f0: 2020 7265 7475 726e 2067 676d 6c5f 7367    return ggml_sg
+0001d100: 6e5f 696d 706c 2863 7478 2c20 612c 2074  n_impl(ctx, a, t
+0001d110: 7275 6529 3b0a 7d0a 0a2f 2f20 6767 6d6c  rue);.}..// ggml
+0001d120: 5f6e 6567 0a0a 7374 7275 6374 2067 676d  _neg..struct ggm
+0001d130: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+0001d140: 6e65 675f 696d 706c 280a 2020 2020 2020  neg_impl(.      
+0001d150: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+0001d160: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+0001d170: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0001d180: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
+0001d190: 2020 2020 2062 6f6f 6c20 696e 706c 6163       bool inplac
+0001d1a0: 6529 207b 0a20 2020 2062 6f6f 6c20 6973  e) {.    bool is
+0001d1b0: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
+0001d1c0: 2020 2020 6966 2028 2169 6e70 6c61 6365      if (!inplace
+0001d1d0: 2026 2620 2861 2d3e 6772 6164 2929 207b   && (a->grad)) {
+0001d1e0: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
+0001d1f0: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
+0001d200: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0001d210: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
+0001d220: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
+0001d230: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
+0001d240: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
+0001d250: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+0001d260: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0001d270: 2020 3d20 4747 4d4c 5f4f 505f 4e45 473b    = GGML_OP_NEG;
+0001d280: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+0001d290: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+0001d2a0: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0001d2b0: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+0001d2c0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+0001d2d0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+0001d2e0: 756c 742d 3e73 7263 3120 3d20 4e55 4c4c  ult->src1 = NULL
+0001d2f0: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
+0001d300: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
+0001d310: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0001d320: 6d6c 5f6e 6567 280a 2020 2020 2020 2020  ml_neg(.        
+0001d330: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0001d340: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0001d350: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001d360: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
+0001d370: 2020 7265 7475 726e 2067 676d 6c5f 6e65    return ggml_ne
+0001d380: 675f 696d 706c 2863 7478 2c20 612c 2066  g_impl(ctx, a, f
+0001d390: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
+0001d3a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+0001d3b0: 676d 6c5f 6e65 675f 696e 706c 6163 6528  gml_neg_inplace(
+0001d3c0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001d3d0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0001d3e0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0001d3f0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0001d400: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+0001d410: 6e20 6767 6d6c 5f6e 6567 5f69 6d70 6c28  n ggml_neg_impl(
+0001d420: 6374 782c 2061 2c20 7472 7565 293b 0a7d  ctx, a, true);.}
+0001d430: 0a0a 2f2f 2067 676d 6c5f 7374 6570 0a0a  ..// ggml_step..
+0001d440: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d450: 6f72 202a 2067 676d 6c5f 7374 6570 5f69  or * ggml_step_i
+0001d460: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+0001d470: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001d480: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001d490: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d4a0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+0001d4b0: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
+0001d4c0: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+0001d4d0: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+0001d4e0: 6620 2821 696e 706c 6163 6520 2626 2028  f (!inplace && (
+0001d4f0: 612d 3e67 7261 6429 2920 7b0a 2020 2020  a->grad)) {.    
+0001d500: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0001d510: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+0001d520: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001d530: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+0001d540: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+0001d550: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+0001d560: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+0001d570: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+0001d580: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0001d590: 474d 4c5f 4f50 5f53 5445 503b 0a20 2020  GML_OP_STEP;.   
+0001d5a0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+0001d5b0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+0001d5c0: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+0001d5d0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+0001d5e0: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+0001d5f0: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+0001d600: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
+0001d610: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001d620: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0001d630: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+0001d640: 7465 7028 0a20 2020 2020 2020 2073 7472  tep(.        str
+0001d650: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001d660: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001d670: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d680: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
+0001d690: 6574 7572 6e20 6767 6d6c 5f73 7465 705f  eturn ggml_step_
+0001d6a0: 696d 706c 2863 7478 2c20 612c 2066 616c  impl(ctx, a, fal
+0001d6b0: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
+0001d6c0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0001d6d0: 6c5f 7374 6570 5f69 6e70 6c61 6365 280a  l_step_inplace(.
+0001d6e0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001d6f0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001d700: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001d710: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0001d720: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
+0001d730: 2067 676d 6c5f 7374 6570 5f69 6d70 6c28   ggml_step_impl(
+0001d740: 6374 782c 2061 2c20 7472 7565 293b 0a7d  ctx, a, true);.}
+0001d750: 0a0a 2f2f 2067 676d 6c5f 7265 6c75 0a0a  ..// ggml_relu..
+0001d760: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d770: 6f72 202a 2067 676d 6c5f 7265 6c75 5f69  or * ggml_relu_i
+0001d780: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+0001d790: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001d7a0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001d7b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d7c0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+0001d7d0: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
+0001d7e0: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+0001d7f0: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+0001d800: 6620 2821 696e 706c 6163 6520 2626 2028  f (!inplace && (
+0001d810: 612d 3e67 7261 6429 2920 7b0a 2020 2020  a->grad)) {.    
+0001d820: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0001d830: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+0001d840: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001d850: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+0001d860: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+0001d870: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+0001d880: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+0001d890: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+0001d8a0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0001d8b0: 474d 4c5f 4f50 5f52 454c 553b 0a20 2020  GML_OP_RELU;.   
+0001d8c0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+0001d8d0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+0001d8e0: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+0001d8f0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+0001d900: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+0001d910: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+0001d920: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
+0001d930: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001d940: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0001d950: 5f74 656e 736f 7220 2a20 6767 6d6c 5f72  _tensor * ggml_r
+0001d960: 656c 7528 0a20 2020 2020 2020 2073 7472  elu(.        str
+0001d970: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001d980: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001d990: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001d9a0: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
+0001d9b0: 6574 7572 6e20 6767 6d6c 5f72 656c 755f  eturn ggml_relu_
+0001d9c0: 696d 706c 2863 7478 2c20 612c 2066 616c  impl(ctx, a, fal
+0001d9d0: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
+0001d9e0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0001d9f0: 6c5f 7265 6c75 5f69 6e70 6c61 6365 280a  l_relu_inplace(.
+0001da00: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001da10: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001da20: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001da30: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0001da40: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
+0001da50: 2067 676d 6c5f 7265 6c75 5f69 6d70 6c28   ggml_relu_impl(
+0001da60: 6374 782c 2061 2c20 7472 7565 293b 0a7d  ctx, a, true);.}
+0001da70: 0a0a 2f2f 2067 676d 6c5f 6765 6c75 0a0a  ..// ggml_gelu..
+0001da80: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001da90: 6f72 202a 2067 676d 6c5f 6765 6c75 5f69  or * ggml_gelu_i
+0001daa0: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+0001dab0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001dac0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001dad0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001dae0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+0001daf0: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
+0001db00: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+0001db10: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+0001db20: 6620 2821 696e 706c 6163 6520 2626 2028  f (!inplace && (
+0001db30: 612d 3e67 7261 6429 2920 7b0a 2020 2020  a->grad)) {.    
+0001db40: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0001db50: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+0001db60: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001db70: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+0001db80: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+0001db90: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+0001dba0: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+0001dbb0: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+0001dbc0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0001dbd0: 474d 4c5f 4f50 5f47 454c 553b 0a20 2020  GML_OP_GELU;.   
+0001dbe0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+0001dbf0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+0001dc00: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+0001dc10: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
 0001dc20: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
 0001dc30: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
-0001dc40: 3e73 7263 3120 3d20 4e55 4c4c 3b20 2f2f  >src1 = NULL; //
-0001dc50: 2054 4f44 4f3a 206d 6179 6265 2073 746f   TODO: maybe sto
-0001dc60: 7265 2074 6865 206f 6666 7365 7420 6865  re the offset he
-0001dc70: 7265 3f0a 0a20 2020 2072 6574 7572 6e20  re?..    return 
-0001dc80: 7265 7375 6c74 3b0a 7d0a 0a2f 2f20 6767  result;.}..// gg
-0001dc90: 6d6c 5f76 6965 775f 3264 0a0a 7374 7275  ml_view_2d..stru
-0001dca0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001dcb0: 2067 676d 6c5f 7669 6577 5f32 6428 0a20   ggml_view_2d(. 
-0001dcc0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001dcd0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001dce0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001dcf0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001dd00: 612c 0a20 2020 2020 2020 2069 6e74 2020  a,.        int  
-0001dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd20: 206e 6530 2c0a 2020 2020 2020 2020 696e   ne0,.        in
-0001dd30: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-0001dd40: 2020 2020 6e65 312c 0a20 2020 2020 2020      ne1,.       
-0001dd50: 2073 697a 655f 7420 2020 2020 2020 2020   size_t         
-0001dd60: 2020 2020 2020 206e 6231 2c0a 2020 2020         nb1,.    
-0001dd70: 2020 2020 7369 7a65 5f74 2020 2020 2020      size_t      
-0001dd80: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
-0001dd90: 2920 7b0a 2020 2020 6966 2028 612d 3e67  ) {.    if (a->g
-0001dda0: 7261 6429 207b 0a20 2020 2020 2020 2047  rad) {.        G
-0001ddb0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0001ddc0: 293b 202f 2f20 6772 6164 6965 6e74 2070  ); // gradient p
-0001ddd0: 726f 7061 6761 7469 6f6e 2069 7320 6e6f  ropagation is no
-0001dde0: 7420 7375 7070 6f72 7465 640a 2020 2020  t supported.    
-0001ddf0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-0001de00: 206e 655b 4747 4d4c 5f4d 4158 5f44 494d   ne[GGML_MAX_DIM
-0001de10: 535d 203d 207b 206e 6530 2c20 6e65 312c  S] = { ne0, ne1,
-0001de20: 2031 2c20 3120 7d3b 0a0a 2020 2020 7374   1, 1 };..    st
-0001de30: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001de40: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
-0001de50: 5f6e 6577 5f74 656e 736f 725f 696d 706c  _new_tensor_impl
-0001de60: 2863 7478 2c20 612d 3e74 7970 652c 2032  (ctx, a->type, 2
-0001de70: 2c20 6e65 2c20 2863 6861 7220 2a29 2061  , ne, (char *) a
-0001de80: 2d3e 6461 7461 202b 206f 6666 7365 7429  ->data + offset)
-0001de90: 3b0a 0a20 2020 2072 6573 756c 742d 3e6e  ;..    result->n
-0001dea0: 625b 315d 203d 206e 6231 3b0a 2020 2020  b[1] = nb1;.    
-0001deb0: 7265 7375 6c74 2d3e 6e62 5b32 5d20 3d20  result->nb[2] = 
-0001dec0: 7265 7375 6c74 2d3e 6e62 5b31 5d2a 6e65  result->nb[1]*ne
-0001ded0: 313b 0a20 2020 2072 6573 756c 742d 3e6e  1;.    result->n
-0001dee0: 625b 335d 203d 2072 6573 756c 742d 3e6e  b[3] = result->n
-0001def0: 625b 325d 3b0a 0a20 2020 2072 6573 756c  b[2];..    resul
-0001df00: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
-0001df10: 505f 5649 4557 3b0a 2020 2020 7265 7375  P_VIEW;.    resu
-0001df20: 6c74 2d3e 6772 6164 203d 204e 554c 4c3b  lt->grad = NULL;
-0001df30: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0001df40: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
-0001df50: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b20  t->src1 = NULL; 
-0001df60: 2f2f 2054 4f44 4f3a 206d 6179 6265 2073  // TODO: maybe s
-0001df70: 746f 7265 2074 6865 206f 6666 7365 7420  tore the offset 
-0001df80: 6865 7265 3f0a 0a20 2020 2072 6574 7572  here?..    retur
-0001df90: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
-0001dfa0: 6767 6d6c 5f70 6572 6d75 7465 0a0a 7374  ggml_permute..st
-0001dfb0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001dfc0: 202a 2067 676d 6c5f 7065 726d 7574 6528   * ggml_permute(
-0001dfd0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001dfe0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0001dff0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0001e000: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-0001e010: 2a20 612c 0a20 2020 2020 2020 2069 6e74  * a,.        int
-0001e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e030: 2020 2061 7869 7330 2c0a 2020 2020 2020     axis0,.      
-0001e040: 2020 696e 7420 2020 2020 2020 2020 2020    int           
-0001e050: 2020 2020 2020 2020 6178 6973 312c 0a20          axis1,. 
-0001e060: 2020 2020 2020 2069 6e74 2020 2020 2020         int      
-0001e070: 2020 2020 2020 2020 2020 2020 2061 7869               axi
-0001e080: 7332 2c0a 2020 2020 2020 2020 696e 7420  s2,.        int 
-0001e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0a0: 2020 6178 6973 3329 207b 0a20 2020 2047    axis3) {.    G
-0001e0b0: 474d 4c5f 4153 5345 5254 2861 7869 7330  GML_ASSERT(axis0
-0001e0c0: 203e 3d20 3020 2626 2061 7869 7330 203c   >= 0 && axis0 <
-0001e0d0: 2047 474d 4c5f 4d41 585f 4449 4d53 293b   GGML_MAX_DIMS);
-0001e0e0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0001e0f0: 2861 7869 7331 203e 3d20 3020 2626 2061  (axis1 >= 0 && a
-0001e100: 7869 7331 203c 2047 474d 4c5f 4d41 585f  xis1 < GGML_MAX_
-0001e110: 4449 4d53 293b 0a20 2020 2047 474d 4c5f  DIMS);.    GGML_
-0001e120: 4153 5345 5254 2861 7869 7332 203e 3d20  ASSERT(axis2 >= 
-0001e130: 3020 2626 2061 7869 7332 203c 2047 474d  0 && axis2 < GGM
-0001e140: 4c5f 4d41 585f 4449 4d53 293b 0a20 2020  L_MAX_DIMS);.   
-0001e150: 2047 474d 4c5f 4153 5345 5254 2861 7869   GGML_ASSERT(axi
-0001e160: 7333 203e 3d20 3020 2626 2061 7869 7333  s3 >= 0 && axis3
-0001e170: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
-0001e180: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-0001e190: 4552 5428 6178 6973 3020 213d 2061 7869  ERT(axis0 != axi
-0001e1a0: 7331 293b 0a20 2020 2047 474d 4c5f 4153  s1);.    GGML_AS
-0001e1b0: 5345 5254 2861 7869 7330 2021 3d20 6178  SERT(axis0 != ax
-0001e1c0: 6973 3229 3b0a 2020 2020 4747 4d4c 5f41  is2);.    GGML_A
-0001e1d0: 5353 4552 5428 6178 6973 3020 213d 2061  SSERT(axis0 != a
-0001e1e0: 7869 7333 293b 0a20 2020 2047 474d 4c5f  xis3);.    GGML_
-0001e1f0: 4153 5345 5254 2861 7869 7331 2021 3d20  ASSERT(axis1 != 
-0001e200: 6178 6973 3229 3b0a 2020 2020 4747 4d4c  axis2);.    GGML
-0001e210: 5f41 5353 4552 5428 6178 6973 3120 213d  _ASSERT(axis1 !=
-0001e220: 2061 7869 7333 293b 0a20 2020 2047 474d   axis3);.    GGM
-0001e230: 4c5f 4153 5345 5254 2861 7869 7332 2021  L_ASSERT(axis2 !
-0001e240: 3d20 6178 6973 3329 3b0a 0a20 2020 2062  = axis3);..    b
-0001e250: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0001e260: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-0001e270: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0001e280: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0001e290: 7365 293b 202f 2f20 544f 444f 3a20 696d  se); // TODO: im
-0001e2a0: 706c 656d 656e 7420 6261 636b 7761 7264  plement backward
-0001e2b0: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
-0001e2c0: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
-0001e2d0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001e2e0: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-0001e2f0: 3d20 6767 6d6c 5f76 6965 775f 7465 6e73  = ggml_view_tens
-0001e300: 6f72 2863 7478 2c20 6129 3b0a 0a20 2020  or(ctx, a);..   
-0001e310: 2069 6e74 206e 655b 4747 4d4c 5f4d 4158   int ne[GGML_MAX
-0001e320: 5f44 494d 535d 3b0a 2020 2020 696e 7420  _DIMS];.    int 
-0001e330: 6e62 5b47 474d 4c5f 4d41 585f 4449 4d53  nb[GGML_MAX_DIMS
-0001e340: 5d3b 0a0a 2020 2020 6e65 5b61 7869 7330  ];..    ne[axis0
-0001e350: 5d20 3d20 612d 3e6e 655b 305d 3b0a 2020  ] = a->ne[0];.  
-0001e360: 2020 6e65 5b61 7869 7331 5d20 3d20 612d    ne[axis1] = a-
-0001e370: 3e6e 655b 315d 3b0a 2020 2020 6e65 5b61  >ne[1];.    ne[a
-0001e380: 7869 7332 5d20 3d20 612d 3e6e 655b 325d  xis2] = a->ne[2]
-0001e390: 3b0a 2020 2020 6e65 5b61 7869 7333 5d20  ;.    ne[axis3] 
-0001e3a0: 3d20 612d 3e6e 655b 335d 3b0a 0a20 2020  = a->ne[3];..   
-0001e3b0: 206e 625b 6178 6973 305d 203d 2061 2d3e   nb[axis0] = a->
-0001e3c0: 6e62 5b30 5d3b 0a20 2020 206e 625b 6178  nb[0];.    nb[ax
-0001e3d0: 6973 315d 203d 2061 2d3e 6e62 5b31 5d3b  is1] = a->nb[1];
-0001e3e0: 0a20 2020 206e 625b 6178 6973 325d 203d  .    nb[axis2] =
-0001e3f0: 2061 2d3e 6e62 5b32 5d3b 0a20 2020 206e   a->nb[2];.    n
-0001e400: 625b 6178 6973 335d 203d 2061 2d3e 6e62  b[axis3] = a->nb
-0001e410: 5b33 5d3b 0a0a 2020 2020 7265 7375 6c74  [3];..    result
-0001e420: 2d3e 6e65 5b30 5d20 3d20 6e65 5b30 5d3b  ->ne[0] = ne[0];
-0001e430: 0a20 2020 2072 6573 756c 742d 3e6e 655b  .    result->ne[
-0001e440: 315d 203d 206e 655b 315d 3b0a 2020 2020  1] = ne[1];.    
-0001e450: 7265 7375 6c74 2d3e 6e65 5b32 5d20 3d20  result->ne[2] = 
-0001e460: 6e65 5b32 5d3b 0a20 2020 2072 6573 756c  ne[2];.    resul
-0001e470: 742d 3e6e 655b 335d 203d 206e 655b 335d  t->ne[3] = ne[3]
-0001e480: 3b0a 0a20 2020 2072 6573 756c 742d 3e6e  ;..    result->n
-0001e490: 625b 305d 203d 206e 625b 305d 3b0a 2020  b[0] = nb[0];.  
-0001e4a0: 2020 7265 7375 6c74 2d3e 6e62 5b31 5d20    result->nb[1] 
-0001e4b0: 3d20 6e62 5b31 5d3b 0a20 2020 2072 6573  = nb[1];.    res
-0001e4c0: 756c 742d 3e6e 625b 325d 203d 206e 625b  ult->nb[2] = nb[
-0001e4d0: 325d 3b0a 2020 2020 7265 7375 6c74 2d3e  2];.    result->
-0001e4e0: 6e62 5b33 5d20 3d20 6e62 5b33 5d3b 0a0a  nb[3] = nb[3];..
-0001e4f0: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-0001e500: 203d 2047 474d 4c5f 4f50 5f50 4552 4d55   = GGML_OP_PERMU
-0001e510: 5445 3b0a 2020 2020 7265 7375 6c74 2d3e  TE;.    result->
-0001e520: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
-0001e530: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-0001e540: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
-0001e550: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
-0001e560: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
-0001e570: 7265 7375 6c74 2d3e 7372 6331 203d 204e  result->src1 = N
-0001e580: 554c 4c3b 202f 2f20 544f 444f 3a20 6d61  ULL; // TODO: ma
-0001e590: 7962 6520 7374 6f72 6520 7468 6520 7065  ybe store the pe
-0001e5a0: 726d 7574 6174 696f 6e20 6865 7265 3f0a  rmutation here?.
-0001e5b0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-0001e5c0: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f74  lt;.}..// ggml_t
-0001e5d0: 7261 6e73 706f 7365 0a0a 7374 7275 6374  ranspose..struct
-0001e5e0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0001e5f0: 676d 6c5f 7472 616e 7370 6f73 6528 0a20  gml_transpose(. 
-0001e600: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001e610: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0001e620: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0001e630: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0001e640: 6129 207b 0a20 2020 2062 6f6f 6c20 6973  a) {.    bool is
-0001e650: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
-0001e660: 2020 2020 6966 2028 612d 3e67 7261 6429      if (a->grad)
-0001e670: 207b 0a20 2020 2020 2020 2047 474d 4c5f   {.        GGML_
-0001e680: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-0001e690: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
-0001e6a0: 7420 6261 636b 7761 7264 0a20 2020 2020  t backward.     
-0001e6b0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-0001e6c0: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-0001e6d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001e6e0: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
-0001e6f0: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
-0001e700: 2c20 6129 3b0a 0a20 2020 2072 6573 756c  , a);..    resul
-0001e710: 742d 3e6e 655b 305d 203d 2061 2d3e 6e65  t->ne[0] = a->ne
-0001e720: 5b31 5d3b 0a20 2020 2072 6573 756c 742d  [1];.    result-
-0001e730: 3e6e 655b 315d 203d 2061 2d3e 6e65 5b30  >ne[1] = a->ne[0
-0001e740: 5d3b 0a0a 2020 2020 7265 7375 6c74 2d3e  ];..    result->
-0001e750: 6e62 5b30 5d20 3d20 612d 3e6e 625b 315d  nb[0] = a->nb[1]
-0001e760: 3b0a 2020 2020 7265 7375 6c74 2d3e 6e62  ;.    result->nb
-0001e770: 5b31 5d20 3d20 612d 3e6e 625b 305d 3b0a  [1] = a->nb[0];.
-0001e780: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
-0001e790: 2020 3d20 4747 4d4c 5f4f 505f 5452 414e    = GGML_OP_TRAN
-0001e7a0: 5350 4f53 453b 0a20 2020 2072 6573 756c  SPOSE;.    resul
-0001e7b0: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0001e7c0: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0001e7d0: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0001e7e0: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0001e7f0: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0001e800: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0001e810: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
-0001e820: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
-0001e830: 2f20 6767 6d6c 5f67 6574 5f72 6f77 730a  / ggml_get_rows.
-0001e840: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0001e850: 736f 7220 2a20 6767 6d6c 5f67 6574 5f72  sor * ggml_get_r
-0001e860: 6f77 7328 0a20 2020 2020 2020 2073 7472  ows(.        str
-0001e870: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0001e880: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0001e890: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001e8a0: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
-0001e8b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0001e8c0: 736f 7220 202a 2062 2920 7b0a 2020 2020  sor  * b) {.    
-0001e8d0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0001e8e0: 5f69 735f 6d61 7472 6978 2861 2920 2626  _is_matrix(a) &&
-0001e8f0: 2067 676d 6c5f 6973 5f76 6563 746f 7228   ggml_is_vector(
-0001e900: 6229 2026 2620 622d 3e74 7970 6520 3d3d  b) && b->type ==
-0001e910: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
-0001e920: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
-0001e930: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
-0001e940: 2069 6620 2861 2d3e 6772 6164 207c 7c20   if (a->grad || 
-0001e950: 622d 3e67 7261 6429 207b 0a20 2020 2020  b->grad) {.     
-0001e960: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0001e970: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-0001e980: 696d 706c 656d 656e 7420 6261 636b 7761  implement backwa
-0001e990: 7264 0a20 2020 2020 2020 2069 735f 6e6f  rd.        is_no
-0001e9a0: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
-0001e9b0: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2069  ..    // TODO: i
-0001e9c0: 6d70 6c65 6d65 6e74 206e 6f6e 2046 3332  mplement non F32
-0001e9d0: 2072 6574 7572 6e0a 2020 2020 2f2f 7374   return.    //st
-0001e9e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001e9f0: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
-0001ea00: 5f6e 6577 5f74 656e 736f 725f 3264 2863  _new_tensor_2d(c
-0001ea10: 7478 2c20 612d 3e74 7970 652c 2061 2d3e  tx, a->type, a->
-0001ea20: 6e65 5b30 5d2c 2062 2d3e 6e65 5b30 5d29  ne[0], b->ne[0])
-0001ea30: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
-0001ea40: 6c5f 7465 6e73 6f72 202a 2072 6573 756c  l_tensor * resul
-0001ea50: 7420 3d20 6767 6d6c 5f6e 6577 5f74 656e  t = ggml_new_ten
-0001ea60: 736f 725f 3264 2863 7478 2c20 4747 4d4c  sor_2d(ctx, GGML
-0001ea70: 5f54 5950 455f 4633 322c 2061 2d3e 6e65  _TYPE_F32, a->ne
-0001ea80: 5b30 5d2c 2062 2d3e 6e65 5b30 5d29 3b0a  [0], b->ne[0]);.
-0001ea90: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
-0001eaa0: 2020 3d20 4747 4d4c 5f4f 505f 4745 545f    = GGML_OP_GET_
-0001eab0: 524f 5753 3b0a 2020 2020 7265 7375 6c74  ROWS;.    result
-0001eac0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-0001ead0: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-0001eae0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-0001eaf0: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-0001eb00: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-0001eb10: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-0001eb20: 2062 3b0a 0a20 2020 2072 6574 7572 6e20   b;..    return 
-0001eb30: 7265 7375 6c74 3b0a 7d0a 0a2f 2f20 6767  result;.}..// gg
-0001eb40: 6d6c 5f64 6961 675f 6d61 736b 5f69 6e66  ml_diag_mask_inf
-0001eb50: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0001eb60: 6e73 6f72 202a 2067 676d 6c5f 6469 6167  nsor * ggml_diag
-0001eb70: 5f6d 6173 6b5f 696e 6628 0a20 2020 2020  _mask_inf(.     
-0001eb80: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001eb90: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001eba0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001ebb0: 6c5f 7465 6e73 6f72 2020 2a20 612c 0a20  l_tensor  * a,. 
-0001ebc0: 2020 2020 2020 2069 6e74 2020 2020 2020         int      
-0001ebd0: 2020 2020 2020 2020 2020 2020 206e 5f70               n_p
-0001ebe0: 6173 7429 207b 0a20 2020 2062 6f6f 6c20  ast) {.    bool 
-0001ebf0: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
-0001ec00: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
-0001ec10: 6429 207b 0a20 2020 2020 2020 2047 474d  d) {.        GGM
-0001ec20: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-0001ec30: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
-0001ec40: 656e 7420 6261 636b 7761 7264 0a20 2020  ent backward.   
-0001ec50: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
-0001ec60: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
-0001ec70: 2f2f 2054 4f44 4f3a 2077 6865 6e20 696d  // TODO: when im
-0001ec80: 706c 656d 656e 7420 6261 636b 7761 7264  plement backward
-0001ec90: 2c20 6669 7820 7468 6973 3a0a 2020 2020  , fix this:.    
-0001eca0: 2f2f 7374 7275 6374 2067 676d 6c5f 7465  //struct ggml_te
-0001ecb0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-0001ecc0: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
-0001ecd0: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
-0001ece0: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
-0001ecf0: 6e73 6f72 2863 7478 2c20 6129 3b0a 2020  nsor(ctx, a);.  
-0001ed00: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0001ed10: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-0001ed20: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
-0001ed30: 2863 7478 2c20 6129 3b0a 2020 2020 7374  (ctx, a);.    st
-0001ed40: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0001ed50: 202a 2062 203d 2067 676d 6c5f 6e65 775f   * b = ggml_new_
-0001ed60: 6933 3228 6374 782c 206e 5f70 6173 7429  i32(ctx, n_past)
-0001ed70: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
-0001ed80: 7020 2020 3d20 4747 4d4c 5f4f 505f 4449  p   = GGML_OP_DI
-0001ed90: 4147 5f4d 4153 4b5f 494e 463b 0a20 2020  AG_MASK_INF;.   
-0001eda0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
-0001edb0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
-0001edc0: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
-0001edd0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
-0001ede0: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
-0001edf0: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
-0001ee00: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
-0001ee10: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-0001ee20: 0a0a 2f2f 2067 676d 6c5f 736f 6674 5f6d  ..// ggml_soft_m
-0001ee30: 6178 0a0a 7374 7275 6374 2067 676d 6c5f  ax..struct ggml_
-0001ee40: 7465 6e73 6f72 202a 2067 676d 6c5f 736f  tensor * ggml_so
-0001ee50: 6674 5f6d 6178 280a 2020 2020 2020 2020  ft_max(.        
-0001ee60: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0001ee70: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0001ee80: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0001ee90: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0001eea0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
-0001eeb0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
-0001eec0: 2861 2d3e 6772 6164 2920 7b0a 2020 2020  (a->grad) {.    
-0001eed0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0001eee0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-0001eef0: 2069 6d70 6c65 6d65 6e74 2062 6163 6b77   implement backw
-0001ef00: 6172 640a 2020 2020 2020 2020 6973 5f6e  ard.        is_n
-0001ef10: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0001ef20: 7d0a 0a20 2020 202f 2f20 544f 444f 3a20  }..    // TODO: 
-0001ef30: 7768 656e 2069 6d70 6c65 6d65 6e74 2062  when implement b
-0001ef40: 6163 6b77 6172 642c 2066 6978 2074 6869  ackward, fix thi
-0001ef50: 733a 0a20 2020 202f 2f73 7472 7563 7420  s:.    //struct 
-0001ef60: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001ef70: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0001ef80: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0001ef90: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0001efa0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0001efb0: 2061 293b 0a20 2020 2073 7472 7563 7420   a);.    struct 
-0001efc0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001efd0: 7375 6c74 203d 2067 676d 6c5f 7669 6577  sult = ggml_view
-0001efe0: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
-0001eff0: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-0001f000: 2020 203d 2047 474d 4c5f 4f50 5f53 4f46     = GGML_OP_SOF
-0001f010: 545f 4d41 583b 0a20 2020 2072 6573 756c  T_MAX;.    resul
-0001f020: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0001f030: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0001f040: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0001f050: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0001f060: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0001f070: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0001f080: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
-0001f090: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
-0001f0a0: 2f20 6767 6d6c 5f72 6f70 650a 0a73 7472  / ggml_rope..str
-0001f0b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001f0c0: 2a20 6767 6d6c 5f72 6f70 6528 0a20 2020  * ggml_rope(.   
-0001f0d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001f0e0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0001f0f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0001f100: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
-0001f110: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
-0001f120: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001f130: 5f70 6173 742c 0a20 2020 2020 2020 2069  _past,.        i
-0001f140: 6e74 2020 2020 2020 2020 2020 2020 2020  nt              
-0001f150: 2020 2020 206e 5f64 696d 732c 0a20 2020       n_dims,.   
-0001f160: 2020 2020 2069 6e74 2020 2020 2020 2020       int        
-0001f170: 2020 2020 2020 2020 2020 206d 6f64 6529             mode)
-0001f180: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-0001f190: 5254 286e 5f70 6173 7420 3e3d 2030 293b  RT(n_past >= 0);
-0001f1a0: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
-0001f1b0: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
-0001f1c0: 6966 2028 612d 3e67 7261 6429 207b 0a20  if (a->grad) {. 
-0001f1d0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0001f1e0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-0001f1f0: 444f 3a20 696d 706c 656d 656e 7420 6261  DO: implement ba
-0001f200: 636b 7761 7264 0a20 2020 2020 2020 2069  ckward.        i
-0001f210: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
-0001f220: 2020 207d 0a0a 2020 2020 2f2f 2054 4f44     }..    // TOD
-0001f230: 4f3a 2077 6865 6e20 696d 706c 656d 656e  O: when implemen
-0001f240: 7420 6261 636b 7761 7264 2c20 6669 7820  t backward, fix 
-0001f250: 7468 6973 3a0a 2020 2020 2f2f 7374 7275  this:.    //stru
-0001f260: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001f270: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
-0001f280: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-0001f290: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-0001f2a0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0001f2b0: 7478 2c20 6129 3b0a 2020 2020 7374 7275  tx, a);.    stru
-0001f2c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001f2d0: 2072 6573 756c 7420 3d20 6767 6d6c 5f76   result = ggml_v
-0001f2e0: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
-0001f2f0: 6129 3b0a 0a20 2020 2073 7472 7563 7420  a);..    struct 
-0001f300: 6767 6d6c 5f74 656e 736f 7220 2a20 6220  ggml_tensor * b 
-0001f310: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0001f320: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0001f330: 5950 455f 4933 322c 2033 293b 0a20 2020  YPE_I32, 3);.   
-0001f340: 2028 2869 6e74 3332 5f74 202a 2920 622d   ((int32_t *) b-
-0001f350: 3e64 6174 6129 5b30 5d20 3d20 6e5f 7061  >data)[0] = n_pa
-0001f360: 7374 3b0a 2020 2020 2828 696e 7433 325f  st;.    ((int32_
-0001f370: 7420 2a29 2062 2d3e 6461 7461 295b 315d  t *) b->data)[1]
-0001f380: 203d 206e 5f64 696d 733b 0a20 2020 2028   = n_dims;.    (
-0001f390: 2869 6e74 3332 5f74 202a 2920 622d 3e64  (int32_t *) b->d
-0001f3a0: 6174 6129 5b32 5d20 3d20 6d6f 6465 3b0a  ata)[2] = mode;.
-0001f3b0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
-0001f3c0: 2020 3d20 4747 4d4c 5f4f 505f 524f 5045    = GGML_OP_ROPE
-0001f3d0: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-0001f3e0: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-0001f3f0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0001f400: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-0001f410: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-0001f420: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-0001f430: 7375 6c74 2d3e 7372 6331 203d 2062 3b0a  sult->src1 = b;.
-0001f440: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-0001f450: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63  lt;.}..// ggml_c
-0001f460: 6f6e 765f 3164 5f31 730a 0a73 7472 7563  onv_1d_1s..struc
-0001f470: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0001f480: 6767 6d6c 5f63 6f6e 765f 3164 5f31 7328  ggml_conv_1d_1s(
-0001f490: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001f4a0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0001f4b0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0001f4c0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-0001f4d0: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
-0001f4e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0001f4f0: 202a 2062 2920 7b0a 2020 2020 4747 4d4c   * b) {.    GGML
-0001f500: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-0001f510: 6d61 7472 6978 2862 2929 3b0a 2020 2020  matrix(b));.    
-0001f520: 4747 4d4c 5f41 5353 4552 5428 612d 3e6e  GGML_ASSERT(a->n
-0001f530: 655b 315d 203d 3d20 622d 3e6e 655b 315d  e[1] == b->ne[1]
-0001f540: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0001f550: 5254 2861 2d3e 6e65 5b33 5d20 3d3d 2031  RT(a->ne[3] == 1
-0001f560: 293b 0a20 2020 2062 6f6f 6c20 6973 5f6e  );.    bool is_n
-0001f570: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
-0001f580: 2020 6966 2028 612d 3e67 7261 6420 7c7c    if (a->grad ||
-0001f590: 2062 2d3e 6772 6164 2920 7b0a 2020 2020   b->grad) {.    
-0001f5a0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0001f5b0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-0001f5c0: 2069 6d70 6c65 6d65 6e74 2062 6163 6b77   implement backw
-0001f5d0: 6172 640a 2020 2020 2020 2020 6973 5f6e  ard.        is_n
-0001f5e0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0001f5f0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-0001f600: 206e 655b 345d 203d 207b 2062 2d3e 6e65   ne[4] = { b->ne
-0001f610: 5b30 5d2c 2061 2d3e 6e65 5b32 5d2c 2031  [0], a->ne[2], 1
-0001f620: 2c20 312c 207d 3b0a 2020 2020 7374 7275  , 1, };.    stru
-0001f630: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001f640: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-0001f650: 6577 5f74 656e 736f 7228 6374 782c 2047  ew_tensor(ctx, G
-0001f660: 474d 4c5f 5459 5045 5f46 3332 2c20 322c  GML_TYPE_F32, 2,
-0001f670: 206e 6529 3b0a 0a20 2020 2072 6573 756c   ne);..    resul
-0001f680: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
-0001f690: 505f 434f 4e56 5f31 445f 3153 3b0a 2020  P_CONV_1D_1S;.  
-0001f6a0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-0001f6b0: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-0001f6c0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-0001f6d0: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-0001f6e0: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-0001f6f0: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-0001f700: 2d3e 7372 6331 203d 2062 3b0a 0a20 2020  ->src1 = b;..   
-0001f710: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-0001f720: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6e 765f  }..// ggml_conv_
-0001f730: 3164 5f32 730a 0a73 7472 7563 7420 6767  1d_2s..struct gg
-0001f740: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-0001f750: 5f63 6f6e 765f 3164 5f32 7328 0a20 2020  _conv_1d_2s(.   
-0001f760: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0001f770: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0001f780: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0001f790: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
-0001f7a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0001f7b0: 6767 6d6c 5f74 656e 736f 7220 202a 2062  ggml_tensor  * b
-0001f7c0: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
-0001f7d0: 4552 5428 6767 6d6c 5f69 735f 6d61 7472  ERT(ggml_is_matr
-0001f7e0: 6978 2862 2929 3b0a 2020 2020 4747 4d4c  ix(b));.    GGML
-0001f7f0: 5f41 5353 4552 5428 612d 3e6e 655b 315d  _ASSERT(a->ne[1]
-0001f800: 203d 3d20 622d 3e6e 655b 315d 293b 0a20   == b->ne[1]);. 
-0001f810: 2020 2047 474d 4c5f 4153 5345 5254 2861     GGML_ASSERT(a
-0001f820: 2d3e 6e65 5b33 5d20 3d3d 2031 293b 0a20  ->ne[3] == 1);. 
-0001f830: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-0001f840: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-0001f850: 2028 612d 3e67 7261 6420 7c7c 2062 2d3e   (a->grad || b->
-0001f860: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0001f870: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0001f880: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
-0001f890: 6c65 6d65 6e74 2062 6163 6b77 6172 640a  lement backward.
-0001f8a0: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
-0001f8b0: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
-0001f8c0: 2020 2063 6f6e 7374 2069 6e74 206e 655b     const int ne[
-0001f8d0: 345d 203d 207b 2062 2d3e 6e65 5b30 5d2f  4] = { b->ne[0]/
-0001f8e0: 322c 2061 2d3e 6e65 5b32 5d2c 2031 2c20  2, a->ne[2], 1, 
-0001f8f0: 312c 207d 3b0a 2020 2020 7374 7275 6374  1, };.    struct
-0001f900: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
-0001f910: 6573 756c 7420 3d20 6767 6d6c 5f6e 6577  esult = ggml_new
-0001f920: 5f74 656e 736f 7228 6374 782c 2047 474d  _tensor(ctx, GGM
-0001f930: 4c5f 5459 5045 5f46 3332 2c20 322c 206e  L_TYPE_F32, 2, n
-0001f940: 6529 3b0a 0a20 2020 2072 6573 756c 742d  e);..    result-
-0001f950: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-0001f960: 434f 4e56 5f31 445f 3253 3b0a 2020 2020  CONV_1D_2S;.    
-0001f970: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
-0001f980: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
-0001f990: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
-0001f9a0: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
-0001f9b0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
-0001f9c0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
-0001f9d0: 7372 6331 203d 2062 3b0a 0a20 2020 2072  src1 = b;..    r
-0001f9e0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-0001f9f0: 0a2f 2f20 6767 6d6c 5f66 6c61 7368 5f61  .// ggml_flash_a
-0001fa00: 7474 6e0a 0a73 7472 7563 7420 6767 6d6c  ttn..struct ggml
-0001fa10: 5f74 656e 736f 7220 2a20 6767 6d6c 5f66  _tensor * ggml_f
-0001fa20: 6c61 7368 5f61 7474 6e28 0a20 2020 2020  lash_attn(.     
-0001fa30: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0001fa40: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0001fa50: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001fa60: 6c5f 7465 6e73 6f72 2020 2a20 712c 0a20  l_tensor  * q,. 
-0001fa70: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0001fa80: 6d6c 5f74 656e 736f 7220 202a 206b 2c0a  ml_tensor  * k,.
-0001fa90: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0001faa0: 676d 6c5f 7465 6e73 6f72 2020 2a20 762c  gml_tensor  * v,
-0001fab0: 0a20 2020 2020 2020 2062 6f6f 6c20 2020  .        bool   
-0001fac0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001fad0: 6173 6b65 6429 207b 0a20 2020 2047 474d  asked) {.    GGM
-0001fae0: 4c5f 4153 5345 5254 2867 676d 6c5f 6361  L_ASSERT(ggml_ca
-0001faf0: 6e5f 6d75 6c5f 6d61 7428 6b2c 2071 2929  n_mul_mat(k, q))
-0001fb00: 3b0a 2020 2020 2f2f 2054 4f44 4f3a 2063  ;.    // TODO: c
-0001fb10: 6865 636b 2069 6620 7654 2063 616e 2062  heck if vT can b
-0001fb20: 6520 6d75 6c74 6970 6c69 6564 2062 7920  e multiplied by 
-0001fb30: 286b 2a71 5429 0a0a 2020 2020 626f 6f6c  (k*qT)..    bool
-0001fb40: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-0001fb50: 3b0a 0a20 2020 2069 6620 2871 2d3e 6772  ;..    if (q->gr
-0001fb60: 6164 207c 7c20 6b2d 3e67 7261 6420 7c7c  ad || k->grad ||
-0001fb70: 2076 2d3e 6772 6164 2920 7b0a 2020 2020   v->grad) {.    
-0001fb80: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0001fb90: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-0001fba0: 2069 6d70 6c65 6d65 6e74 2062 6163 6b77   implement backw
-0001fbb0: 6172 640a 2020 2020 2020 2020 6973 5f6e  ard.        is_n
-0001fbc0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0001fbd0: 7d0a 0a20 2020 202f 2f73 7472 7563 7420  }..    //struct 
-0001fbe0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0001fbf0: 7375 6c74 203d 2067 676d 6c5f 6475 705f  sult = ggml_dup_
-0001fc00: 7465 6e73 6f72 2863 7478 2c20 7129 3b0a  tensor(ctx, q);.
-0001fc10: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001fc20: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-0001fc30: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0001fc40: 7228 6374 782c 2047 474d 4c5f 5459 5045  r(ctx, GGML_TYPE
-0001fc50: 5f46 3332 2c20 342c 2071 2d3e 6e65 293b  _F32, 4, q->ne);
-0001fc60: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-0001fc70: 2020 203d 2047 474d 4c5f 4f50 5f46 4c41     = GGML_OP_FLA
-0001fc80: 5348 5f41 5454 4e3b 0a20 2020 2072 6573  SH_ATTN;.    res
-0001fc90: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
-0001fca0: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
-0001fcb0: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
-0001fcc0: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
-0001fcd0: 6573 756c 742d 3e73 7263 3020 3d20 713b  esult->src0 = q;
-0001fce0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0001fcf0: 3120 3d20 6b3b 0a20 2020 2072 6573 756c  1 = k;.    resul
-0001fd00: 742d 3e6f 7074 5b30 5d20 3d20 763b 0a20  t->opt[0] = v;. 
-0001fd10: 2020 2072 6573 756c 742d 3e6f 7074 5b31     result->opt[1
-0001fd20: 5d20 3d20 6767 6d6c 5f6e 6577 5f69 3332  ] = ggml_new_i32
-0001fd30: 2863 7478 2c20 6d61 736b 6564 203f 2031  (ctx, masked ? 1
-0001fd40: 203a 2030 293b 0a0a 2020 2020 7265 7475   : 0);..    retu
-0001fd50: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
-0001fd60: 2067 676d 6c5f 666c 6173 685f 6666 0a0a   ggml_flash_ff..
-0001fd70: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001fd80: 6f72 202a 2067 676d 6c5f 666c 6173 685f  or * ggml_flash_
-0001fd90: 6666 280a 2020 2020 2020 2020 7374 7275  ff(.        stru
-0001fda0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0001fdb0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0001fdc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0001fdd0: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
-0001fde0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0001fdf0: 6f72 2020 2a20 6230 2c0a 2020 2020 2020  or  * b0,.      
-0001fe00: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0001fe10: 6e73 6f72 2020 2a20 6231 2c0a 2020 2020  nsor  * b1,.    
-0001fe20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0001fe30: 7465 6e73 6f72 2020 2a20 6330 2c0a 2020  tensor  * c0,.  
-0001fe40: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0001fe50: 6c5f 7465 6e73 6f72 2020 2a20 6331 2920  l_tensor  * c1) 
-0001fe60: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-0001fe70: 5428 6767 6d6c 5f63 616e 5f6d 756c 5f6d  T(ggml_can_mul_m
-0001fe80: 6174 2862 302c 2061 2929 3b0a 2020 2020  at(b0, a));.    
-0001fe90: 2f2f 2054 4f44 4f3a 206d 6f72 6520 6368  // TODO: more ch
-0001fea0: 6563 6b73 0a0a 2020 2020 626f 6f6c 2069  ecks..    bool i
-0001feb0: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-0001fec0: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
-0001fed0: 207c 7c20 6230 2d3e 6772 6164 207c 7c20   || b0->grad || 
-0001fee0: 6231 2d3e 6772 6164 207c 7c20 6330 2d3e  b1->grad || c0->
-0001fef0: 6772 6164 207c 7c20 6331 2d3e 6772 6164  grad || c1->grad
-0001ff00: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
-0001ff10: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-0001ff20: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
-0001ff30: 6e74 2062 6163 6b77 6172 640a 2020 2020  nt backward.    
-0001ff40: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-0001ff50: 7565 3b0a 2020 2020 7d0a 0a20 2020 202f  ue;.    }..    /
-0001ff60: 2f73 7472 7563 7420 6767 6d6c 5f74 656e  /struct ggml_ten
-0001ff70: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
-0001ff80: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0001ff90: 7478 2c20 6129 3b0a 2020 2020 7374 7275  tx, a);.    stru
-0001ffa0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0001ffb0: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-0001ffc0: 6577 5f74 656e 736f 7228 6374 782c 2047  ew_tensor(ctx, G
-0001ffd0: 474d 4c5f 5459 5045 5f46 3332 2c20 342c  GML_TYPE_F32, 4,
-0001ffe0: 2061 2d3e 6e65 293b 0a0a 2020 2020 7265   a->ne);..    re
-0001fff0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-00020000: 4c5f 4f50 5f46 4c41 5348 5f46 463b 0a20  L_OP_FLASH_FF;. 
-00020010: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
-00020020: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
-00020030: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-00020040: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
-00020050: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-00020060: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
-00020070: 742d 3e73 7263 3120 3d20 6230 3b0a 2020  t->src1 = b0;.  
-00020080: 2020 7265 7375 6c74 2d3e 6f70 745b 305d    result->opt[0]
-00020090: 203d 2062 313b 0a20 2020 2072 6573 756c   = b1;.    resul
-000200a0: 742d 3e6f 7074 5b31 5d20 3d20 6330 3b0a  t->opt[1] = c0;.
-000200b0: 2020 2020 7265 7375 6c74 2d3e 6f70 745b      result->opt[
-000200c0: 325d 203d 2063 313b 0a0a 2020 2020 7265  2] = c1;..    re
-000200d0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-000200e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000200f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00020100: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00020110: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00020120: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00020130: 0a0a 766f 6964 2067 676d 6c5f 7365 745f  ..void ggml_set_
-00020140: 7061 7261 6d28 0a20 2020 2020 2020 2073  param(.        s
-00020150: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00020160: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00020170: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00020180: 6e73 6f72 202a 2074 656e 736f 7229 207b  nsor * tensor) {
-00020190: 0a20 2020 2074 656e 736f 722d 3e69 735f  .    tensor->is_
-000201a0: 7061 7261 6d20 3d20 7472 7565 3b0a 0a20  param = true;.. 
-000201b0: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-000201c0: 656e 736f 722d 3e67 7261 6420 3d3d 204e  ensor->grad == N
-000201d0: 554c 4c29 3b0a 2020 2020 7465 6e73 6f72  ULL);.    tensor
-000201e0: 2d3e 6772 6164 203d 2067 676d 6c5f 6475  ->grad = ggml_du
-000201f0: 705f 7465 6e73 6f72 2863 7478 2c20 7465  p_tensor(ctx, te
-00020200: 6e73 6f72 293b 0a7d 0a0a 2f2f 2067 676d  nsor);.}..// ggm
-00020210: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00020220: 645f 6475 700a 0a73 7461 7469 6320 766f  d_dup..static vo
-00020230: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00020240: 666f 7277 6172 645f 6475 705f 6631 3628  forward_dup_f16(
-00020250: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00020260: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00020270: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00020280: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00020290: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000202a0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-000202b0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000202c0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000202d0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000202e0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
-000202f0: 3029 3b0a 2020 2020 4747 4d4c 5f41 5353  0);.    GGML_ASS
-00020300: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
-00020310: 6967 756f 7573 2864 7374 2929 3b0a 2020  iguous(dst));.  
-00020320: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00020330: 6d6c 5f6e 656c 656d 656e 7473 2864 7374  ml_nelements(dst
-00020340: 2920 3d3d 2067 676d 6c5f 6e65 6c65 6d65  ) == ggml_neleme
-00020350: 6e74 7328 7372 6330 2929 3b0a 0a20 2020  nts(src0));..   
-00020360: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00020370: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-00020380: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-00020390: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-000203a0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-000203b0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-000203c0: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
-000203d0: 7420 6e65 3030 203d 2073 7263 302d 3e6e  t ne00 = src0->n
-000203e0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-000203f0: 696e 7420 6e65 3031 203d 2073 7263 302d  int ne01 = src0-
-00020400: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-00020410: 7420 696e 7420 6e65 3032 203d 2073 7263  t int ne02 = src
-00020420: 302d 3e6e 655b 325d 3b0a 2020 2020 636f  0->ne[2];.    co
-00020430: 6e73 7420 696e 7420 6e65 3033 203d 2073  nst int ne03 = s
-00020440: 7263 302d 3e6e 655b 335d 3b0a 0a20 2020  rc0->ne[3];..   
-00020450: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00020460: 3030 203d 2073 7263 302d 3e6e 625b 305d  00 = src0->nb[0]
-00020470: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00020480: 5f74 206e 6230 3120 3d20 7372 6330 2d3e  _t nb01 = src0->
-00020490: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-000204a0: 2073 697a 655f 7420 6e62 3032 203d 2073   size_t nb02 = s
-000204b0: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
-000204c0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-000204d0: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
-000204e0: 0a0a 2020 2020 6966 2028 6767 6d6c 5f69  ..    if (ggml_i
-000204f0: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
-00020500: 3029 2026 2620 7372 6330 2d3e 7479 7065  0) && src0->type
-00020510: 203d 3d20 6473 742d 3e74 7970 6529 207b   == dst->type) {
-00020520: 0a20 2020 2020 2020 206d 656d 6370 7928  .        memcpy(
-00020530: 6473 742d 3e64 6174 612c 2073 7263 302d  dst->data, src0-
-00020540: 3e64 6174 612c 2067 676d 6c5f 6e65 6c65  >data, ggml_nele
-00020550: 6d65 6e74 7328 6473 7429 202a 2047 474d  ments(dst) * GGM
-00020560: 4c5f 5459 5045 5f53 495a 455b 7372 6330  L_TYPE_SIZE[src0
-00020570: 2d3e 7479 7065 5d29 3b0a 2020 2020 2020  ->type]);.      
-00020580: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00020590: 0a20 2020 2069 6620 2873 7263 302d 3e6e  .    if (src0->n
-000205a0: 625b 305d 203d 3d20 7369 7a65 6f66 2867  b[0] == sizeof(g
-000205b0: 676d 6c5f 6670 3136 5f74 2929 207b 0a20  gml_fp16_t)) {. 
-000205c0: 2020 2020 2020 2069 6620 2864 7374 2d3e         if (dst->
-000205d0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-000205e0: 455f 4631 3629 207b 0a20 2020 2020 2020  E_F16) {.       
-000205f0: 2020 2020 2069 6e74 2069 6420 3d20 303b       int id = 0;
-00020600: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00020610: 7374 2073 697a 655f 7420 7273 203d 206e  st size_t rs = n
-00020620: 6530 302a 6e62 3030 3b0a 0a20 2020 2020  e00*nb00;..     
-00020630: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00020640: 6930 3320 3d20 303b 2069 3033 203c 206e  i03 = 0; i03 < n
-00020650: 6530 333b 2069 3033 2b2b 2920 7b0a 2020  e03; i03++) {.  
-00020660: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00020670: 7220 2869 6e74 2069 3032 203d 2030 3b20  r (int i02 = 0; 
-00020680: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
-00020690: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000206a0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-000206b0: 7420 6930 3120 3d20 303b 2069 3031 203c  t i01 = 0; i01 <
-000206c0: 206e 6530 313b 2069 3031 2b2b 2920 7b0a   ne01; i01++) {.
-000206d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000206e0: 2020 2020 2020 2020 636f 6e73 7420 6368          const ch
-000206f0: 6172 202a 2073 7263 305f 7074 7220 3d20  ar * src0_ptr = 
-00020700: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-00020710: 6174 6120 2b20 6930 312a 6e62 3031 202b  ata + i01*nb01 +
-00020720: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
-00020730: 6e62 3033 3b0a 2020 2020 2020 2020 2020  nb03;.          
-00020740: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00020750: 6172 202a 2064 7374 5f70 7472 203d 2028  ar * dst_ptr = (
-00020760: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-00020770: 6120 2b20 6964 2a72 733b 0a0a 2020 2020  a + id*rs;..    
-00020780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020790: 2020 2020 6d65 6d63 7079 2864 7374 5f70      memcpy(dst_p
-000207a0: 7472 2c20 7372 6330 5f70 7472 2c20 7273  tr, src0_ptr, rs
-000207b0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-000207c0: 2020 2020 2020 2020 2020 2020 6964 2b2b              id++
-000207d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000207e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000207f0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00020800: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00020810: 7d20 656c 7365 2069 6620 2864 7374 2d3e  } else if (dst->
-00020820: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-00020830: 455f 4633 3229 207b 0a20 2020 2020 2020  E_F32) {.       
-00020840: 2020 2020 2069 6e74 2069 6420 3d20 303b       int id = 0;
-00020850: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
-00020860: 6174 202a 2064 7374 5f70 7472 203d 2028  at * dst_ptr = (
-00020870: 666c 6f61 7420 2a29 2064 7374 2d3e 6461  float *) dst->da
-00020880: 7461 3b0a 0a20 2020 2020 2020 2020 2020  ta;..           
-00020890: 2066 6f72 2028 696e 7420 6930 3320 3d20   for (int i03 = 
-000208a0: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
-000208b0: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
-000208c0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000208d0: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
-000208e0: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
-000208f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020900: 2020 2066 6f72 2028 696e 7420 6930 3120     for (int i01 
-00020910: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
-00020920: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
-00020930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020940: 2020 666f 7220 2869 6e74 2069 3030 203d    for (int i00 =
-00020950: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
-00020960: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
-00020970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020980: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
-00020990: 6670 3136 5f74 202a 2073 7263 305f 7074  fp16_t * src0_pt
-000209a0: 7220 3d20 2867 676d 6c5f 6670 3136 5f74  r = (ggml_fp16_t
-000209b0: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-000209c0: 6330 2d3e 6461 7461 202b 2069 3030 2a6e  c0->data + i00*n
-000209d0: 6230 3020 2b20 6930 312a 6e62 3031 202b  b00 + i01*nb01 +
-000209e0: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
-000209f0: 6e62 3033 293b 0a0a 2020 2020 2020 2020  nb03);..        
-00020a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a10: 2020 2020 6473 745f 7074 725b 6964 5d20      dst_ptr[id] 
-00020a20: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
-00020a30: 5033 3228 2a73 7263 305f 7074 7229 3b0a  P32(*src0_ptr);.
-00020a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a50: 2020 2020 2020 2020 2020 2020 6964 2b2b              id++
-00020a60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00020a70: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00020a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a90: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00020aa0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00020ab0: 7d0a 2020 2020 2020 2020 7d20 656c 7365  }.        } else
-00020ac0: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
-00020ad0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00020ae0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
-00020af0: 656d 656e 740a 2020 2020 2020 2020 7d0a  ement.        }.
-00020b00: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00020b10: 2020 2020 202f 2f70 7269 6e74 6628 2225       //printf("%
-00020b20: 733a 2074 6869 7320 6973 206e 6f74 206f  s: this is not o
-00020b30: 7074 696d 616c 202d 2066 6978 206d 655c  ptimal - fix me\
-00020b40: 6e22 2c20 5f5f 6675 6e63 5f5f 293b 0a0a  n", __func__);..
-00020b50: 2020 2020 2020 2020 6966 2028 6473 742d          if (dst-
-00020b60: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00020b70: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
-00020b80: 2020 2020 2020 696e 7420 6964 203d 2030        int id = 0
-00020b90: 3b0a 2020 2020 2020 2020 2020 2020 666c  ;.            fl
-00020ba0: 6f61 7420 2a20 6473 745f 7074 7220 3d20  oat * dst_ptr = 
-00020bb0: 2866 6c6f 6174 202a 2920 6473 742d 3e64  (float *) dst->d
-00020bc0: 6174 613b 0a0a 2020 2020 2020 2020 2020  ata;..          
-00020bd0: 2020 666f 7220 2869 6e74 2069 3033 203d    for (int i03 =
-00020be0: 2030 3b20 6930 3320 3c20 6e65 3033 3b20   0; i03 < ne03; 
-00020bf0: 6930 332b 2b29 207b 0a20 2020 2020 2020  i03++) {.       
-00020c00: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00020c10: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
-00020c20: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
-00020c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c40: 2020 2020 666f 7220 2869 6e74 2069 3031      for (int i01
-00020c50: 203d 2030 3b20 6930 3120 3c20 6e65 3031   = 0; i01 < ne01
-00020c60: 3b20 6930 312b 2b29 207b 0a20 2020 2020  ; i01++) {.     
-00020c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c80: 2020 2066 6f72 2028 696e 7420 6930 3020     for (int i00 
-00020c90: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
-00020ca0: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
-00020cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020cc0: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
-00020cd0: 5f66 7031 365f 7420 2a20 7372 6330 5f70  _fp16_t * src0_p
-00020ce0: 7472 203d 2028 6767 6d6c 5f66 7031 365f  tr = (ggml_fp16_
-00020cf0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-00020d00: 7263 302d 3e64 6174 6120 2b20 6930 302a  rc0->data + i00*
-00020d10: 6e62 3030 202b 2069 3031 2a6e 6230 3120  nb00 + i01*nb01 
-00020d20: 2b20 6930 322a 6e62 3032 202b 2069 3033  + i02*nb02 + i03
-00020d30: 2a6e 6230 3329 3b0a 0a20 2020 2020 2020  *nb03);..       
-00020d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d50: 2020 2020 2064 7374 5f70 7472 5b69 645d       dst_ptr[id]
-00020d60: 203d 2047 474d 4c5f 4650 3136 5f54 4f5f   = GGML_FP16_TO_
-00020d70: 4650 3332 282a 7372 6330 5f70 7472 293b  FP32(*src0_ptr);
-00020d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020d90: 2020 2020 2020 2020 2020 2020 2069 642b               id+
-00020da0: 2b3b 0a20 2020 2020 2020 2020 2020 2020  +;.             
-00020db0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00020dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020dd0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00020de0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00020df0: 207d 0a20 2020 2020 2020 207d 2065 6c73   }.        } els
-00020e00: 6520 6966 2028 6473 742d 3e74 7970 6520  e if (dst->type 
-00020e10: 3d3d 2047 474d 4c5f 5459 5045 5f46 3136  == GGML_TYPE_F16
-00020e20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00020e30: 696e 7420 6964 203d 2030 3b0a 2020 2020  int id = 0;.    
-00020e40: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-00020e50: 365f 7420 2a20 6473 745f 7074 7220 3d20  6_t * dst_ptr = 
-00020e60: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-00020e70: 6473 742d 3e64 6174 613b 0a0a 2020 2020  dst->data;..    
-00020e80: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00020e90: 2069 3033 203d 2030 3b20 6930 3320 3c20   i03 = 0; i03 < 
-00020ea0: 6e65 3033 3b20 6930 332b 2b29 207b 0a20  ne03; i03++) {. 
-00020eb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020ec0: 6f72 2028 696e 7420 6930 3220 3d20 303b  or (int i02 = 0;
-00020ed0: 2069 3032 203c 206e 6530 323b 2069 3032   i02 < ne02; i02
-00020ee0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00020ef0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00020f00: 6e74 2069 3031 203d 2030 3b20 6930 3120  nt i01 = 0; i01 
-00020f10: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
-00020f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020f30: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00020f40: 7420 6930 3020 3d20 303b 2069 3030 203c  t i00 = 0; i00 <
-00020f50: 206e 6530 303b 2069 3030 2b2b 2920 7b0a   ne00; i00++) {.
-00020f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f70: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00020f80: 7420 6767 6d6c 5f66 7031 365f 7420 2a20  t ggml_fp16_t * 
-00020f90: 7372 6330 5f70 7472 203d 2028 6767 6d6c  src0_ptr = (ggml
-00020fa0: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-00020fb0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00020fc0: 2b20 6930 302a 6e62 3030 202b 2069 3031  + i00*nb00 + i01
-00020fd0: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
-00020fe0: 202b 2069 3033 2a6e 6230 3329 3b0a 0a20   + i03*nb03);.. 
-00020ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021000: 2020 2020 2020 2020 2020 2064 7374 5f70             dst_p
-00021010: 7472 5b69 645d 203d 202a 7372 6330 5f70  tr[id] = *src0_p
-00021020: 7472 3b0a 2020 2020 2020 2020 2020 2020  tr;.            
-00021030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021040: 6964 2b2b 3b0a 2020 2020 2020 2020 2020  id++;.          
-00021050: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00021060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021070: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00021080: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00021090: 2020 2020 7d0a 2020 2020 2020 2020 7d20      }.        } 
-000210a0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-000210b0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-000210c0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-000210d0: 696d 706c 656d 656e 740a 2020 2020 2020  implement.      
-000210e0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-000210f0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00021100: 6d70 7574 655f 666f 7277 6172 645f 6475  mpute_forward_du
-00021110: 705f 6633 3228 0a20 2020 2020 2020 2063  p_f32(.        c
-00021120: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00021130: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00021140: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00021150: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00021160: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00021170: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
-00021180: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00021190: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
-000211a0: 4153 5345 5254 2870 6172 616d 732d 3e69  ASSERT(params->i
-000211b0: 7468 203d 3d20 3029 3b0a 2020 2020 4747  th == 0);.    GG
-000211c0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
-000211d0: 735f 636f 6e74 6967 756f 7573 2864 7374  s_contiguous(dst
-000211e0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-000211f0: 4552 5428 6767 6d6c 5f6e 656c 656d 656e  ERT(ggml_nelemen
-00021200: 7473 2864 7374 2920 3d3d 2067 676d 6c5f  ts(dst) == ggml_
-00021210: 6e65 6c65 6d65 6e74 7328 7372 6330 2929  nelements(src0))
-00021220: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-00021230: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00021240: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-00021250: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00021260: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-00021270: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-00021280: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-00021290: 6e73 7420 696e 7420 6e65 3030 203d 2073  nst int ne00 = s
-000212a0: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
-000212b0: 636f 6e73 7420 696e 7420 6e65 3031 203d  const int ne01 =
-000212c0: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
-000212d0: 2020 636f 6e73 7420 696e 7420 6e65 3032    const int ne02
-000212e0: 203d 2073 7263 302d 3e6e 655b 325d 3b0a   = src0->ne[2];.
-000212f0: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-00021300: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-00021310: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-00021320: 655f 7420 6e62 3030 203d 2073 7263 302d  e_t nb00 = src0-
-00021330: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-00021340: 7420 7369 7a65 5f74 206e 6230 3120 3d20  t size_t nb01 = 
-00021350: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
-00021360: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00021370: 3032 203d 2073 7263 302d 3e6e 625b 325d  02 = src0->nb[2]
-00021380: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00021390: 5f74 206e 6230 3320 3d20 7372 6330 2d3e  _t nb03 = src0->
-000213a0: 6e62 5b33 5d3b 0a0a 2020 2020 6966 2028  nb[3];..    if (
-000213b0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
-000213c0: 7573 2873 7263 3029 2026 2620 7372 6330  us(src0) && src0
-000213d0: 2d3e 7479 7065 203d 3d20 6473 742d 3e74  ->type == dst->t
-000213e0: 7970 6529 207b 0a20 2020 2020 2020 206d  ype) {.        m
-000213f0: 656d 6370 7928 6473 742d 3e64 6174 612c  emcpy(dst->data,
-00021400: 2073 7263 302d 3e64 6174 612c 2067 676d   src0->data, ggm
-00021410: 6c5f 6e65 6c65 6d65 6e74 7328 6473 7429  l_nelements(dst)
-00021420: 202a 2047 474d 4c5f 5459 5045 5f53 495a   * GGML_TYPE_SIZ
-00021430: 455b 7372 6330 2d3e 7479 7065 5d29 3b0a  E[src0->type]);.
-00021440: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00021450: 2020 2020 7d0a 0a20 2020 2069 6620 2873      }..    if (s
-00021460: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
-00021470: 7a65 6f66 2866 6c6f 6174 2929 207b 0a20  zeof(float)) {. 
-00021480: 2020 2020 2020 2069 6620 2864 7374 2d3e         if (dst->
-00021490: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-000214a0: 455f 4633 3229 207b 0a20 2020 2020 2020  E_F32) {.       
-000214b0: 2020 2020 2069 6e74 2069 6420 3d20 303b       int id = 0;
-000214c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-000214d0: 7374 2073 697a 655f 7420 7273 203d 206e  st size_t rs = n
-000214e0: 6530 302a 6e62 3030 3b0a 0a20 2020 2020  e00*nb00;..     
-000214f0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00021500: 6930 3320 3d20 303b 2069 3033 203c 206e  i03 = 0; i03 < n
-00021510: 6530 333b 2069 3033 2b2b 2920 7b0a 2020  e03; i03++) {.  
-00021520: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00021530: 7220 2869 6e74 2069 3032 203d 2030 3b20  r (int i02 = 0; 
-00021540: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
-00021550: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00021560: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00021570: 7420 6930 3120 3d20 303b 2069 3031 203c  t i01 = 0; i01 <
-00021580: 206e 6530 313b 2069 3031 2b2b 2920 7b0a   ne01; i01++) {.
-00021590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000215a0: 2020 2020 2020 2020 636f 6e73 7420 6368          const ch
-000215b0: 6172 202a 2073 7263 305f 7074 7220 3d20  ar * src0_ptr = 
-000215c0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-000215d0: 6174 6120 2b20 6930 312a 6e62 3031 202b  ata + i01*nb01 +
-000215e0: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
-000215f0: 6e62 3033 3b0a 2020 2020 2020 2020 2020  nb03;.          
-00021600: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00021610: 6172 202a 2064 7374 5f70 7472 203d 2028  ar * dst_ptr = (
-00021620: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-00021630: 6120 2b20 6964 2a72 733b 0a0a 2020 2020  a + id*rs;..    
-00021640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021650: 2020 2020 6d65 6d63 7079 2864 7374 5f70      memcpy(dst_p
-00021660: 7472 2c20 7372 6330 5f70 7472 2c20 7273  tr, src0_ptr, rs
-00021670: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00021680: 2020 2020 2020 2020 2020 2020 6964 2b2b              id++
-00021690: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000216a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000216b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000216c0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000216d0: 7d20 656c 7365 2069 6620 2864 7374 2d3e  } else if (dst->
-000216e0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-000216f0: 455f 4631 3629 207b 0a20 2020 2020 2020  E_F16) {.       
-00021700: 2020 2020 2069 6e74 2069 6420 3d20 303b       int id = 0;
-00021710: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00021720: 6c5f 6670 3136 5f74 202a 2064 7374 5f70  l_fp16_t * dst_p
-00021730: 7472 203d 2028 6767 6d6c 5f66 7031 365f  tr = (ggml_fp16_
-00021740: 7420 2a29 2064 7374 2d3e 6461 7461 3b0a  t *) dst->data;.
-00021750: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00021760: 2028 696e 7420 6930 3320 3d20 303b 2069   (int i03 = 0; i
-00021770: 3033 203c 206e 6530 333b 2069 3033 2b2b  03 < ne03; i03++
-00021780: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00021790: 2020 2020 666f 7220 2869 6e74 2069 3032      for (int i02
-000217a0: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-000217b0: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-000217c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000217d0: 6f72 2028 696e 7420 6930 3120 3d20 303b  or (int i01 = 0;
-000217e0: 2069 3031 203c 206e 6530 313b 2069 3031   i01 < ne01; i01
-000217f0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00021800: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00021810: 7220 2869 6e74 2069 3030 203d 2030 3b20  r (int i00 = 0; 
-00021820: 6930 3020 3c20 6e65 3030 3b20 6930 302b  i00 < ne00; i00+
-00021830: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00021840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021850: 2063 6f6e 7374 2066 6c6f 6174 202a 2073   const float * s
-00021860: 7263 305f 7074 7220 3d20 2866 6c6f 6174  rc0_ptr = (float
-00021870: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00021880: 6330 2d3e 6461 7461 202b 2069 3030 2a6e  c0->data + i00*n
-00021890: 6230 3020 2b20 6930 312a 6e62 3031 202b  b00 + i01*nb01 +
-000218a0: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
-000218b0: 6e62 3033 293b 0a0a 2020 2020 2020 2020  nb03);..        
-000218c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000218d0: 2020 2020 6473 745f 7074 725b 6964 5d20      dst_ptr[id] 
-000218e0: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
-000218f0: 5031 3628 2a73 7263 305f 7074 7229 3b0a  P16(*src0_ptr);.
-00021900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021910: 2020 2020 2020 2020 2020 2020 6964 2b2b              id++
-00021920: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00021930: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021950: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00021960: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00021970: 7d0a 2020 2020 2020 2020 7d20 656c 7365  }.        } else
-00021980: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
-00021990: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000219a0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
-000219b0: 656d 656e 740a 2020 2020 2020 2020 7d0a  ement.        }.
-000219c0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-000219d0: 2020 2020 202f 2f70 7269 6e74 6628 2225       //printf("%
-000219e0: 733a 2074 6869 7320 6973 206e 6f74 206f  s: this is not o
-000219f0: 7074 696d 616c 202d 2066 6978 206d 655c  ptimal - fix me\
-00021a00: 6e22 2c20 5f5f 6675 6e63 5f5f 293b 0a0a  n", __func__);..
-00021a10: 2020 2020 2020 2020 6966 2028 6473 742d          if (dst-
-00021a20: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00021a30: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
-00021a40: 2020 2020 2020 696e 7420 6964 203d 2030        int id = 0
-00021a50: 3b0a 2020 2020 2020 2020 2020 2020 666c  ;.            fl
-00021a60: 6f61 7420 2a20 6473 745f 7074 7220 3d20  oat * dst_ptr = 
-00021a70: 2866 6c6f 6174 202a 2920 6473 742d 3e64  (float *) dst->d
-00021a80: 6174 613b 0a0a 2020 2020 2020 2020 2020  ata;..          
-00021a90: 2020 666f 7220 2869 6e74 2069 3033 203d    for (int i03 =
-00021aa0: 2030 3b20 6930 3320 3c20 6e65 3033 3b20   0; i03 < ne03; 
-00021ab0: 6930 332b 2b29 207b 0a20 2020 2020 2020  i03++) {.       
-00021ac0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00021ad0: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
-00021ae0: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
-00021af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b00: 2020 2020 666f 7220 2869 6e74 2069 3031      for (int i01
-00021b10: 203d 2030 3b20 6930 3120 3c20 6e65 3031   = 0; i01 < ne01
-00021b20: 3b20 6930 312b 2b29 207b 0a20 2020 2020  ; i01++) {.     
-00021b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b40: 2020 2066 6f72 2028 696e 7420 6930 3020     for (int i00 
-00021b50: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
-00021b60: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
-00021b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b80: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-00021b90: 7420 2a20 7372 6330 5f70 7472 203d 2028  t * src0_ptr = (
-00021ba0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00021bb0: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00021bc0: 6930 302a 6e62 3030 202b 2069 3031 2a6e  i00*nb00 + i01*n
-00021bd0: 6230 3120 2b20 6930 322a 6e62 3032 202b  b01 + i02*nb02 +
-00021be0: 2069 3033 2a6e 6230 3329 3b0a 0a20 2020   i03*nb03);..   
-00021bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c00: 2020 2020 2020 2020 2064 7374 5f70 7472           dst_ptr
-00021c10: 5b69 645d 203d 202a 7372 6330 5f70 7472  [id] = *src0_ptr
-00021c20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00021c30: 2020 2020 2020 2020 2020 2020 2020 6964                id
-00021c40: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
-00021c50: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00021c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c70: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00021c80: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00021c90: 2020 7d0a 2020 2020 2020 2020 7d20 656c    }.        } el
-00021ca0: 7365 2069 6620 2864 7374 2d3e 7479 7065  se if (dst->type
-00021cb0: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-00021cc0: 3629 207b 0a20 2020 2020 2020 2020 2020  6) {.           
-00021cd0: 2069 6e74 2069 6420 3d20 303b 0a20 2020   int id = 0;.   
-00021ce0: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
-00021cf0: 3136 5f74 202a 2064 7374 5f70 7472 203d  16_t * dst_ptr =
-00021d00: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-00021d10: 2064 7374 2d3e 6461 7461 3b0a 0a20 2020   dst->data;..   
-00021d20: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00021d30: 7420 6930 3320 3d20 303b 2069 3033 203c  t i03 = 0; i03 <
-00021d40: 206e 6530 333b 2069 3033 2b2b 2920 7b0a   ne03; i03++) {.
-00021d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d60: 666f 7220 2869 6e74 2069 3032 203d 2030  for (int i02 = 0
-00021d70: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
-00021d80: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
-00021d90: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00021da0: 696e 7420 6930 3120 3d20 303b 2069 3031  int i01 = 0; i01
-00021db0: 203c 206e 6530 313b 2069 3031 2b2b 2920   < ne01; i01++) 
-00021dc0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00021dd0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00021de0: 6e74 2069 3030 203d 2030 3b20 6930 3020  nt i00 = 0; i00 
-00021df0: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
-00021e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021e10: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00021e20: 7374 2066 6c6f 6174 202a 2073 7263 305f  st float * src0_
-00021e30: 7074 7220 3d20 2866 6c6f 6174 202a 2920  ptr = (float *) 
-00021e40: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-00021e50: 6461 7461 202b 2069 3030 2a6e 6230 3020  data + i00*nb00 
-00021e60: 2b20 6930 312a 6e62 3031 202b 2069 3032  + i01*nb01 + i02
-00021e70: 2a6e 6230 3220 2b20 6930 332a 6e62 3033  *nb02 + i03*nb03
-00021e80: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00021e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ea0: 6473 745f 7074 725b 6964 5d20 3d20 4747  dst_ptr[id] = GG
-00021eb0: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-00021ec0: 2a73 7263 305f 7074 7229 3b0a 2020 2020  *src0_ptr);.    
-00021ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ee0: 2020 2020 2020 2020 6964 2b2b 3b0a 2020          id++;.  
-00021ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00021f10: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00021f20: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00021f30: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00021f40: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-00021f50: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00021f60: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-00021f70: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
-00021f80: 740a 2020 2020 2020 2020 7d0a 2020 2020  t.        }.    
-00021f90: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00021fa0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00021fb0: 7277 6172 645f 6475 7028 0a20 2020 2020  rward_dup(.     
-00021fc0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00021fd0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00021fe0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00021ff0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00022000: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00022010: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
-00022020: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00022030: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
-00022040: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
-00022050: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
-00022060: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
-00022070: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00022080: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00022090: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000220a0: 6172 645f 6475 705f 6631 3628 7061 7261  ard_dup_f16(para
-000220b0: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
-000220c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000220d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000220e0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-000220f0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00022100: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00022110: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00022120: 6172 645f 6475 705f 6633 3228 7061 7261  ard_dup_f32(para
-00022130: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
-00022140: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00022150: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00022160: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
-00022170: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00022180: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
-00022190: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000221a0: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
-000221b0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000221c0: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
-000221d0: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
-000221e0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-000221f0: 474d 4c5f 5459 5045 5f43 4f55 4e54 3a0a  GML_TYPE_COUNT:.
-00022200: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00022210: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00022220: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00022230: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00022240: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00022250: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00022260: 666f 7277 6172 645f 6164 640a 0a73 7461  forward_add..sta
-00022270: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00022280: 6d70 7574 655f 666f 7277 6172 645f 6164  mpute_forward_ad
-00022290: 645f 6633 3228 0a20 2020 2020 2020 2063  d_f32(.        c
-000222a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000222b0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-000222c0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-000222d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000222e0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-000222f0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00022300: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00022310: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00022320: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00022330: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00022340: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00022350: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
-00022360: 6170 6528 7372 6330 2c20 7372 6331 2920  ape(src0, src1) 
-00022370: 2626 2067 676d 6c5f 6172 655f 7361 6d65  && ggml_are_same
-00022380: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-00022390: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-000223a0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-000223b0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-000223c0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000223d0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-000223e0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-000223f0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00022400: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
-00022410: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
-00022420: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
-00022430: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
-00022440: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
-00022450: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
-00022460: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
-00022470: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
-00022480: 305d 3b0a 0a20 2020 2063 6f6e 7374 2073  0];..    const s
-00022490: 697a 655f 7420 6e62 3030 203d 2073 7263  ize_t nb00 = src
-000224a0: 302d 3e6e 625b 305d 3b0a 2020 2020 636f  0->nb[0];.    co
-000224b0: 6e73 7420 7369 7a65 5f74 206e 6230 3120  nst size_t nb01 
-000224c0: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a0a  = src0->nb[1];..
-000224d0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-000224e0: 206e 6231 3020 3d20 7372 6331 2d3e 6e62   nb10 = src1->nb
-000224f0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-00022500: 697a 655f 7420 6e62 3131 203d 2073 7263  ize_t nb11 = src
-00022510: 312d 3e6e 625b 315d 3b0a 0a20 2020 2063  1->nb[1];..    c
-00022520: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
-00022530: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-00022540: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00022550: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-00022560: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00022570: 5428 206e 6230 203d 3d20 7369 7a65 6f66  T( nb0 == sizeof
-00022580: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
-00022590: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-000225a0: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-000225b0: 3b0a 0a20 2020 2069 6620 286e 6231 3020  ;..    if (nb10 
-000225c0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-000225d0: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
-000225e0: 7420 696e 7420 6a30 203d 2028 6e2f 6e74  t int j0 = (n/nt
-000225f0: 6829 2a69 7468 3b0a 2020 2020 2020 2020  h)*ith;.        
-00022600: 636f 6e73 7420 696e 7420 6a31 203d 2069  const int j1 = i
-00022610: 7468 203d 3d20 6e74 6820 2d20 3120 3f20  th == nth - 1 ? 
-00022620: 6e20 3a20 286e 2f6e 7468 292a 2869 7468  n : (n/nth)*(ith
-00022630: 202b 2031 293b 0a0a 2020 2020 2020 2020   + 1);..        
-00022640: 666f 7220 2869 6e74 206a 203d 206a 303b  for (int j = j0;
-00022650: 206a 203c 206a 313b 206a 2b2b 2920 7b0a   j < j1; j++) {.
-00022660: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00022670: 5f76 6563 5f61 6464 5f66 3332 286e 632c  _vec_add_f32(nc,
-00022680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022690: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-000226a0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-000226b0: 7461 2020 2b20 6a2a 6e62 3129 2c0a 2020  ta  + j*nb1),.  
-000226c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226d0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-000226e0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-000226f0: 202b 206a 2a6e 6230 3129 2c0a 2020 2020   + j*nb01),.    
-00022700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022710: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00022720: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-00022730: 206a 2a6e 6231 3129 293b 0a20 2020 2020   j*nb11));.     
-00022740: 2020 207d 0a20 2020 207d 2065 6c73 6520     }.    } else 
-00022750: 7b0a 2020 2020 2020 2020 2f2f 2073 7263  {.        // src
-00022760: 3120 6973 206e 6f74 2063 6f6e 7469 6775  1 is not contigu
-00022770: 6f75 730a 2020 2020 2020 2020 666f 7220  ous.        for 
-00022780: 2869 6e74 206a 203d 2069 7468 3b20 6a20  (int j = ith; j 
-00022790: 3c20 6e3b 206a 202b 3d20 6e74 6829 207b  < n; j += nth) {
-000227a0: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
-000227b0: 6174 202a 2064 7374 5f70 7472 2020 3d20  at * dst_ptr  = 
-000227c0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-000227d0: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
-000227e0: 206a 2a6e 6231 293b 0a20 2020 2020 2020   j*nb1);.       
-000227f0: 2020 2020 2066 6c6f 6174 202a 2073 7263       float * src
-00022800: 305f 7074 7220 3d20 2866 6c6f 6174 202a  0_ptr = (float *
-00022810: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-00022820: 2d3e 6461 7461 202b 206a 2a6e 6230 3129  ->data + j*nb01)
-00022830: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
-00022840: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00022850: 3c20 6e63 3b20 692b 2b29 207b 0a20 2020  < nc; i++) {.   
-00022860: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-00022870: 6174 202a 2073 7263 315f 7074 7220 3d20  at * src1_ptr = 
-00022880: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00022890: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-000228a0: 206a 2a6e 6231 3120 2b20 692a 6e62 3130   j*nb11 + i*nb10
-000228b0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-000228c0: 2020 2020 6473 745f 7074 725b 695d 203d      dst_ptr[i] =
-000228d0: 2073 7263 305f 7074 725b 695d 202b 202a   src0_ptr[i] + *
-000228e0: 7372 6331 5f70 7472 3b0a 2020 2020 2020  src1_ptr;.      
-000228f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00022900: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
-00022910: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00022920: 7574 655f 666f 7277 6172 645f 6164 6428  ute_forward_add(
-00022930: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00022940: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00022950: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00022960: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00022970: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00022980: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00022990: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000229a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000229b0: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-000229c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000229d0: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-000229e0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-000229f0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-00022a00: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00022a10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00022a20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00022a30: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00022a40: 7264 5f61 6464 5f66 3332 2870 6172 616d  rd_add_f32(param
-00022a50: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00022a60: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00022a70: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00022a80: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00022a90: 5f51 345f 303a 0a20 2020 2020 2020 2063  _Q4_0:.        c
-00022aa0: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00022ab0: 5f31 3a0a 2020 2020 2020 2020 6361 7365  _1:.        case
-00022ac0: 2047 474d 4c5f 5459 5045 5f49 383a 0a20   GGML_TYPE_I8:. 
-00022ad0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00022ae0: 5f54 5950 455f 4931 363a 0a20 2020 2020  _TYPE_I16:.     
-00022af0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00022b00: 455f 4933 323a 0a20 2020 2020 2020 2063  E_I32:.        c
-00022b10: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
-00022b20: 363a 0a20 2020 2020 2020 2063 6173 6520  6:.        case 
-00022b30: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
-00022b40: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00022b50: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00022b60: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00022b70: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00022b80: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-00022b90: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-00022ba0: 5f66 6f72 7761 7264 5f73 7562 0a0a 7374  _forward_sub..st
-00022bb0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00022bc0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00022bd0: 7562 5f66 3332 280a 2020 2020 2020 2020  ub_f32(.        
-00022be0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00022bf0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00022c00: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00022c10: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00022c20: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00022c30: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-00022c40: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00022c50: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-00022c60: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00022c70: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00022c80: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
-00022c90: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a20  ms->ith == 0);. 
-00022ca0: 2020 2061 7373 6572 7428 6767 6d6c 5f61     assert(ggml_a
-00022cb0: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
-00022cc0: 6330 2c20 7372 6331 2920 2626 2067 676d  c0, src1) && ggm
-00022cd0: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
-00022ce0: 2873 7263 302c 2064 7374 2929 3b0a 0a20  (src0, dst));.. 
-00022cf0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-00022d00: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00022d10: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-00022d20: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00022d30: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-00022d40: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00022d50: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-00022d60: 696e 7420 6e20 203d 2067 676d 6c5f 6e72  int n  = ggml_nr
-00022d70: 6f77 7328 7372 6330 293b 0a20 2020 2063  ows(src0);.    c
-00022d80: 6f6e 7374 2069 6e74 206e 6320 3d20 7372  onst int nc = sr
-00022d90: 6330 2d3e 6e65 5b30 5d3b 0a0a 2020 2020  c0->ne[0];..    
-00022da0: 6173 7365 7274 2820 6473 742d 3e6e 625b  assert( dst->nb[
-00022db0: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
-00022dc0: 6174 2929 3b0a 2020 2020 6173 7365 7274  at));.    assert
-00022dd0: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
-00022de0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00022df0: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
-00022e00: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00022e10: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-00022e20: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00022e30: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
-00022e40: 2020 2020 2067 676d 6c5f 7665 635f 7375       ggml_vec_su
-00022e50: 625f 6633 3228 6e63 2c0a 2020 2020 2020  b_f32(nc,.      
-00022e60: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00022e70: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-00022e80: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
-00022e90: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
-00022ea0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-00022eb0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00022ec0: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
-00022ed0: 2873 7263 302d 3e6e 625b 315d 2929 2c0a  (src0->nb[1])),.
-00022ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ef0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00022f00: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-00022f10: 2069 2a28 7372 6331 2d3e 6e62 5b31 5d29   i*(src1->nb[1])
-00022f20: 2929 3b0a 2020 2020 7d0a 7d0a 0a73 7461  ));.    }.}..sta
-00022f30: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00022f40: 6d70 7574 655f 666f 7277 6172 645f 7375  mpute_forward_su
-00022f50: 6228 0a20 2020 2020 2020 2063 6f6e 7374  b(.        const
-00022f60: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00022f70: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00022f80: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-00022f90: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00022fa0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-00022fb0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00022fc0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00022fd0: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-00022fe0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00022ff0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00023000: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
-00023010: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-00023020: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-00023030: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0001dc40: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
+0001dc50: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001dc60: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0001dc70: 5f74 656e 736f 7220 2a20 6767 6d6c 5f67  _tensor * ggml_g
+0001dc80: 656c 7528 0a20 2020 2020 2020 2073 7472  elu(.        str
+0001dc90: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001dca0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001dcb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001dcc0: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
+0001dcd0: 6574 7572 6e20 6767 6d6c 5f67 656c 755f  eturn ggml_gelu_
+0001dce0: 696d 706c 2863 7478 2c20 612c 2066 616c  impl(ctx, a, fal
+0001dcf0: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
+0001dd00: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0001dd10: 6c5f 6765 6c75 5f69 6e70 6c61 6365 280a  l_gelu_inplace(.
+0001dd20: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001dd30: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001dd40: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001dd50: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0001dd60: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
+0001dd70: 2067 676d 6c5f 6765 6c75 5f69 6d70 6c28   ggml_gelu_impl(
+0001dd80: 6374 782c 2061 2c20 7472 7565 293b 0a7d  ctx, a, true);.}
+0001dd90: 0a0a 2f2f 2067 676d 6c5f 7369 6c75 0a0a  ..// ggml_silu..
+0001dda0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001ddb0: 6f72 202a 2067 676d 6c5f 7369 6c75 5f69  or * ggml_silu_i
+0001ddc0: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+0001ddd0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001dde0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001ddf0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001de00: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+0001de10: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
+0001de20: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+0001de30: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+0001de40: 6620 2821 696e 706c 6163 6520 2626 2028  f (!inplace && (
+0001de50: 612d 3e67 7261 6429 2920 7b0a 2020 2020  a->grad)) {.    
+0001de60: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0001de70: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+0001de80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001de90: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+0001dea0: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+0001deb0: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+0001dec0: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+0001ded0: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+0001dee0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0001def0: 474d 4c5f 4f50 5f53 494c 553b 0a20 2020  GML_OP_SILU;.   
+0001df00: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+0001df10: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+0001df20: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+0001df30: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+0001df40: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+0001df50: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+0001df60: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
+0001df70: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001df80: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0001df90: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+0001dfa0: 696c 7528 0a20 2020 2020 2020 2073 7472  ilu(.        str
+0001dfb0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001dfc0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001dfd0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001dfe0: 6f72 2020 2a20 6129 207b 0a20 2020 2072  or  * a) {.    r
+0001dff0: 6574 7572 6e20 6767 6d6c 5f73 696c 755f  eturn ggml_silu_
+0001e000: 696d 706c 2863 7478 2c20 612c 2066 616c  impl(ctx, a, fal
+0001e010: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
+0001e020: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0001e030: 6c5f 7369 6c75 5f69 6e70 6c61 6365 280a  l_silu_inplace(.
+0001e040: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001e050: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001e060: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001e070: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0001e080: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
+0001e090: 2067 676d 6c5f 7369 6c75 5f69 6d70 6c28   ggml_silu_impl(
+0001e0a0: 6374 782c 2061 2c20 7472 7565 293b 0a7d  ctx, a, true);.}
+0001e0b0: 0a0a 2f2f 2067 676d 6c5f 6e6f 726d 0a0a  ..// ggml_norm..
+0001e0c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001e0d0: 6f72 202a 2067 676d 6c5f 6e6f 726d 5f69  or * ggml_norm_i
+0001e0e0: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+0001e0f0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001e100: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001e110: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001e120: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
+0001e130: 2062 6f6f 6c20 696e 706c 6163 6529 207b   bool inplace) {
+0001e140: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
+0001e150: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
+0001e160: 6966 2028 2169 6e70 6c61 6365 2026 2620  if (!inplace && 
+0001e170: 2861 2d3e 6772 6164 2929 207b 0a20 2020  (a->grad)) {.   
+0001e180: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0001e190: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
+0001e1a0: 3a20 696d 706c 656d 656e 7420 6261 636b  : implement back
+0001e1b0: 7761 7264 0a20 2020 2020 2020 2069 735f  ward.        is_
+0001e1c0: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0001e1d0: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
+0001e1e0: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0001e1f0: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
+0001e200: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
+0001e210: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
+0001e220: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0001e230: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
+0001e240: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
+0001e250: 4e4f 524d 3b0a 2020 2020 7265 7375 6c74  NORM;.    result
+0001e260: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+0001e270: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+0001e280: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+0001e290: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+0001e2a0: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+0001e2b0: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+0001e2c0: 204e 554c 4c3b 202f 2f20 544f 444f 3a20   NULL; // TODO: 
+0001e2d0: 6d61 7962 6520 7374 6f72 6520 6570 7369  maybe store epsi
+0001e2e0: 6c6f 6e20 6865 7265 3f0a 0a20 2020 2072  lon here?..    r
+0001e2f0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+0001e300: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0001e310: 736f 7220 2a20 6767 6d6c 5f6e 6f72 6d28  sor * ggml_norm(
+0001e320: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001e330: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0001e340: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0001e350: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0001e360: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+0001e370: 6e20 6767 6d6c 5f6e 6f72 6d5f 696d 706c  n ggml_norm_impl
+0001e380: 2863 7478 2c20 612c 2066 616c 7365 293b  (ctx, a, false);
+0001e390: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+0001e3a0: 7465 6e73 6f72 202a 2067 676d 6c5f 6e6f  tensor * ggml_no
+0001e3b0: 726d 5f69 6e70 6c61 6365 280a 2020 2020  rm_inplace(.    
+0001e3c0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0001e3d0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+0001e3e0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0001e3f0: 6d6c 5f74 656e 736f 7220 202a 2061 2920  ml_tensor  * a) 
+0001e400: 7b0a 2020 2020 7265 7475 726e 2067 676d  {.    return ggm
+0001e410: 6c5f 6e6f 726d 5f69 6d70 6c28 6374 782c  l_norm_impl(ctx,
+0001e420: 2061 2c20 7472 7565 293b 0a7d 0a0a 7374   a, true);.}..st
+0001e430: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001e440: 202a 2067 676d 6c5f 726d 735f 6e6f 726d   * ggml_rms_norm
+0001e450: 5f69 6d70 6c28 0a20 2020 2020 2020 2073  _impl(.        s
+0001e460: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0001e470: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0001e480: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0001e490: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
+0001e4a0: 2020 2062 6f6f 6c20 696e 706c 6163 6529     bool inplace)
+0001e4b0: 207b 0a20 2020 2062 6f6f 6c20 6973 5f6e   {.    bool is_n
+0001e4c0: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
+0001e4d0: 2020 6966 2028 2169 6e70 6c61 6365 2026    if (!inplace &
+0001e4e0: 2620 2861 2d3e 6772 6164 2929 207b 0a20  & (a->grad)) {. 
+0001e4f0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0001e500: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+0001e510: 444f 3a20 696d 706c 656d 656e 7420 6261  DO: implement ba
+0001e520: 636b 7761 7264 0a20 2020 2020 2020 2069  ckward.        i
+0001e530: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
+0001e540: 2020 207d 0a0a 2020 2020 7374 7275 6374     }..    struct
+0001e550: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
+0001e560: 6573 756c 7420 3d20 696e 706c 6163 6520  esult = inplace 
+0001e570: 3f20 6767 6d6c 5f76 6965 775f 7465 6e73  ? ggml_view_tens
+0001e580: 6f72 2863 7478 2c20 6129 203a 2067 676d  or(ctx, a) : ggm
+0001e590: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+0001e5a0: 2c20 6129 3b0a 0a20 2020 2072 6573 756c  , a);..    resul
+0001e5b0: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
+0001e5c0: 505f 524d 535f 4e4f 524d 3b0a 2020 2020  P_RMS_NORM;.    
+0001e5d0: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+0001e5e0: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+0001e5f0: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+0001e600: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+0001e610: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+0001e620: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+0001e630: 7372 6331 203d 204e 554c 4c3b 202f 2f20  src1 = NULL; // 
+0001e640: 544f 444f 3a20 6d61 7962 6520 7374 6f72  TODO: maybe stor
+0001e650: 6520 6570 7369 6c6f 6e20 6865 7265 3f0a  e epsilon here?.
+0001e660: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0001e670: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
+0001e680: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0001e690: 5f72 6d73 5f6e 6f72 6d28 0a20 2020 2020  _rms_norm(.     
+0001e6a0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001e6b0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001e6c0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001e6d0: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
+0001e6e0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
+0001e6f0: 5f72 6d73 5f6e 6f72 6d5f 696d 706c 2863  _rms_norm_impl(c
+0001e700: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
+0001e710: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0001e720: 6e73 6f72 202a 2067 676d 6c5f 726d 735f  nsor * ggml_rms_
+0001e730: 6e6f 726d 5f69 6e70 6c61 6365 280a 2020  norm_inplace(.  
+0001e740: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001e750: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0001e760: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001e770: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0001e780: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0001e790: 676d 6c5f 726d 735f 6e6f 726d 5f69 6d70  gml_rms_norm_imp
+0001e7a0: 6c28 6374 782c 2061 2c20 7472 7565 293b  l(ctx, a, true);
+0001e7b0: 0a7d 0a0a 2f2f 2067 676d 6c5f 6d75 6c5f  .}..// ggml_mul_
+0001e7c0: 6d61 740a 0a73 7472 7563 7420 6767 6d6c  mat..struct ggml
+0001e7d0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
+0001e7e0: 756c 5f6d 6174 280a 2020 2020 2020 2020  ul_mat(.        
+0001e7f0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0001e800: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0001e810: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001e820: 656e 736f 7220 202a 2061 2c0a 2020 2020  ensor  * a,.    
+0001e830: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0001e840: 7465 6e73 6f72 2020 2a20 6229 207b 0a20  tensor  * b) {. 
+0001e850: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0001e860: 676d 6c5f 6361 6e5f 6d75 6c5f 6d61 7428  gml_can_mul_mat(
+0001e870: 612c 2062 2929 3b0a 2020 2020 4747 4d4c  a, b));.    GGML
+0001e880: 5f41 5353 4552 5428 2167 676d 6c5f 6973  _ASSERT(!ggml_is
+0001e890: 5f74 7261 6e73 706f 7365 6428 6129 293b  _transposed(a));
+0001e8a0: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
+0001e8b0: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+0001e8c0: 2069 6620 2861 2d3e 6772 6164 207c 7c20   if (a->grad || 
+0001e8d0: 622d 3e67 7261 6429 207b 0a20 2020 2020  b->grad) {.     
+0001e8e0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
+0001e8f0: 653b 0a20 2020 207d 0a0a 2020 2020 636f  e;.    }..    co
+0001e900: 6e73 7420 696e 7420 6e65 5b34 5d20 3d20  nst int ne[4] = 
+0001e910: 7b20 612d 3e6e 655b 315d 2c20 622d 3e6e  { a->ne[1], b->n
+0001e920: 655b 315d 2c20 612d 3e6e 655b 325d 2c20  e[1], a->ne[2], 
+0001e930: 622d 3e6e 655b 335d 207d 3b0a 2020 2020  b->ne[3] };.    
+0001e940: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001e950: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
+0001e960: 6d6c 5f6e 6577 5f74 656e 736f 7228 6374  ml_new_tensor(ct
+0001e970: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+0001e980: 2c20 4d49 4e28 612d 3e6e 5f64 696d 732c  , MIN(a->n_dims,
+0001e990: 2062 2d3e 6e5f 6469 6d73 292c 206e 6529   b->n_dims), ne)
+0001e9a0: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
+0001e9b0: 7020 2020 3d20 4747 4d4c 5f4f 505f 4d55  p   = GGML_OP_MU
+0001e9c0: 4c5f 4d41 543b 0a20 2020 2072 6573 756c  L_MAT;.    resul
+0001e9d0: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
+0001e9e0: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
+0001e9f0: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
+0001ea00: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
+0001ea10: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
+0001ea20: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
+0001ea30: 3d20 623b 0a0a 2020 2020 7265 7475 726e  = b;..    return
+0001ea40: 2072 6573 756c 743b 0a7d 0a0a 2f2f 2067   result;.}..// g
+0001ea50: 676d 6c5f 7363 616c 650a 0a73 7472 7563  gml_scale..struc
+0001ea60: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001ea70: 6767 6d6c 5f73 6361 6c65 5f69 6d70 6c28  ggml_scale_impl(
+0001ea80: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001ea90: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0001eaa0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0001eab0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0001eac0: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
+0001ead0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001eae0: 202a 2062 2c0a 2020 2020 2020 2020 626f   * b,.        bo
+0001eaf0: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+0001eb00: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0001eb10: 6d6c 5f69 735f 7363 616c 6172 2862 2929  ml_is_scalar(b))
+0001eb20: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0001eb30: 5428 6767 6d6c 5f69 735f 7061 6464 6564  T(ggml_is_padded
+0001eb40: 5f31 6428 6129 293b 0a0a 2020 2020 626f  _1d(a));..    bo
+0001eb50: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+0001eb60: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
+0001eb70: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
+0001eb80: 6420 7c7c 2062 2d3e 6772 6164 2929 207b  d || b->grad)) {
+0001eb90: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
+0001eba0: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+0001ebb0: 544f 444f 3a20 696d 706c 656d 656e 7420  TODO: implement 
+0001ebc0: 6261 636b 7761 7264 0a20 2020 2020 2020  backward.       
+0001ebd0: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
+0001ebe0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2054  .    }..    // T
+0001ebf0: 4f44 4f3a 2077 6865 6e20 696d 706c 656d  ODO: when implem
+0001ec00: 656e 7420 6261 636b 7761 7264 2c20 6669  ent backward, fi
+0001ec10: 7820 7468 6973 3a0a 2020 2020 2f2f 7374  x this:.    //st
+0001ec20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001ec30: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
+0001ec40: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
+0001ec50: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
+0001ec60: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
+0001ec70: 2863 7478 2c20 6129 3b0a 2020 2020 7374  (ctx, a);.    st
+0001ec80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001ec90: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
+0001eca0: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
+0001ecb0: 2c20 6129 3b0a 0a20 2020 2072 6573 756c  , a);..    resul
+0001ecc0: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
+0001ecd0: 505f 5343 414c 453b 0a20 2020 2072 6573  P_SCALE;.    res
+0001ece0: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
+0001ecf0: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
+0001ed00: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
+0001ed10: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
+0001ed20: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
+0001ed30: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0001ed40: 3120 3d20 623b 0a0a 2020 2020 7265 7475  1 = b;..    retu
+0001ed50: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+0001ed60: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0001ed70: 202a 2067 676d 6c5f 7363 616c 6528 0a20   * ggml_scale(. 
+0001ed80: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0001ed90: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0001eda0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0001edb0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+0001edc0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0001edd0: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
+0001ede0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0001edf0: 676d 6c5f 7363 616c 655f 696d 706c 2863  gml_scale_impl(c
+0001ee00: 7478 2c20 612c 2062 2c20 6661 6c73 6529  tx, a, b, false)
+0001ee10: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0001ee20: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+0001ee30: 6361 6c65 5f69 6e70 6c61 6365 280a 2020  cale_inplace(.  
+0001ee40: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001ee50: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0001ee60: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001ee70: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0001ee80: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001ee90: 6767 6d6c 5f74 656e 736f 7220 2a20 6229  ggml_tensor * b)
+0001eea0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
+0001eeb0: 6d6c 5f73 6361 6c65 5f69 6d70 6c28 6374  ml_scale_impl(ct
+0001eec0: 782c 2061 2c20 622c 2074 7275 6529 3b0a  x, a, b, true);.
+0001eed0: 7d0a 0a2f 2f20 6767 6d6c 5f63 7079 0a0a  }..// ggml_cpy..
+0001eee0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001eef0: 6f72 202a 2067 676d 6c5f 6370 795f 696d  or * ggml_cpy_im
+0001ef00: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
+0001ef10: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0001ef20: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0001ef30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001ef40: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
+0001ef50: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001ef60: 6f72 2020 2a20 622c 0a20 2020 2020 2020  or  * b,.       
+0001ef70: 2062 6f6f 6c20 696e 706c 6163 6529 207b   bool inplace) {
+0001ef80: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0001ef90: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
+0001efa0: 6129 203d 3d20 6767 6d6c 5f6e 656c 656d  a) == ggml_nelem
+0001efb0: 656e 7473 2862 2929 3b0a 0a20 2020 2062  ents(b));..    b
+0001efc0: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
+0001efd0: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
+0001efe0: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
+0001eff0: 6164 207c 7c20 622d 3e67 7261 6429 2920  ad || b->grad)) 
+0001f000: 7b0a 2020 2020 2020 2020 4747 4d4c 5f41  {.        GGML_A
+0001f010: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+0001f020: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
+0001f030: 2062 6163 6b77 6172 640a 2020 2020 2020   backward.      
+0001f040: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0001f050: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+0001f060: 6d61 6b65 2061 2076 6965 7720 6f66 2074  make a view of t
+0001f070: 6865 2064 6573 7469 6e61 7469 6f6e 0a20  he destination. 
+0001f080: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0001f090: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+0001f0a0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
+0001f0b0: 7228 6374 782c 2062 293b 0a0a 2020 2020  r(ctx, b);..    
+0001f0c0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0001f0d0: 474d 4c5f 4f50 5f43 5059 3b0a 2020 2020  GML_OP_CPY;.    
+0001f0e0: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+0001f0f0: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+0001f100: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+0001f110: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+0001f120: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+0001f130: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+0001f140: 7372 6331 203d 2062 3b0a 0a20 2020 2072  src1 = b;..    r
+0001f150: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+0001f160: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0001f170: 736f 7220 2a20 6767 6d6c 5f63 7079 280a  sor * ggml_cpy(.
+0001f180: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0001f190: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0001f1a0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0001f1b0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001f1c0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
+0001f1d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001f1e0: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
+0001f1f0: 6767 6d6c 5f63 7079 5f69 6d70 6c28 6374  ggml_cpy_impl(ct
+0001f200: 782c 2061 2c20 622c 2066 616c 7365 293b  x, a, b, false);
+0001f210: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+0001f220: 7465 6e73 6f72 202a 2067 676d 6c5f 6370  tensor * ggml_cp
+0001f230: 795f 696e 706c 6163 6528 0a20 2020 2020  y_inplace(.     
+0001f240: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001f250: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001f260: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001f270: 6c5f 7465 6e73 6f72 202a 2061 2c0a 2020  l_tensor * a,.  
+0001f280: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001f290: 6c5f 7465 6e73 6f72 202a 2062 2920 7b0a  l_tensor * b) {.
+0001f2a0: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+0001f2b0: 6370 795f 696d 706c 2863 7478 2c20 612c  cpy_impl(ctx, a,
+0001f2c0: 2062 2c20 7472 7565 293b 0a7d 0a0a 2f2f   b, true);.}..//
+0001f2d0: 2067 676d 6c5f 7265 7368 6170 650a 0a73   ggml_reshape..s
+0001f2e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001f2f0: 7220 2a20 6767 6d6c 5f72 6573 6861 7065  r * ggml_reshape
+0001f300: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+0001f310: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+0001f320: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+0001f330: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001f340: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
+0001f350: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001f360: 2a20 6229 207b 0a20 2020 2047 474d 4c5f  * b) {.    GGML_
+0001f370: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
+0001f380: 6f6e 7469 6775 6f75 7328 6129 293b 0a20  ontiguous(a));. 
+0001f390: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0001f3a0: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+0001f3b0: 7328 6229 293b 0a20 2020 2047 474d 4c5f  s(b));.    GGML_
+0001f3c0: 4153 5345 5254 2867 676d 6c5f 6e65 6c65  ASSERT(ggml_nele
+0001f3d0: 6d65 6e74 7328 6129 203d 3d20 6767 6d6c  ments(a) == ggml
+0001f3e0: 5f6e 656c 656d 656e 7473 2862 2929 3b0a  _nelements(b));.
+0001f3f0: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
+0001f400: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
+0001f410: 6966 2028 612d 3e67 7261 6420 7c7c 2062  if (a->grad || b
+0001f420: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0001f430: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0001f440: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 2069  lse); // TODO: i
+0001f450: 6d70 6c65 6d65 6e74 2062 6163 6b77 6172  mplement backwar
+0001f460: 640a 2020 2020 2020 2020 6973 5f6e 6f64  d.        is_nod
+0001f470: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
+0001f480: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0001f490: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+0001f4a0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+0001f4b0: 6f72 5f69 6d70 6c28 6374 782c 2061 2d3e  or_impl(ctx, a->
+0001f4c0: 7479 7065 2c20 622d 3e6e 5f64 696d 732c  type, b->n_dims,
+0001f4d0: 2062 2d3e 6e65 2c20 612d 3e64 6174 6129   b->ne, a->data)
+0001f4e0: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
+0001f4f0: 7020 2020 3d20 4747 4d4c 5f4f 505f 5245  p   = GGML_OP_RE
+0001f500: 5348 4150 453b 0a20 2020 2072 6573 756c  SHAPE;.    resul
+0001f510: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
+0001f520: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
+0001f530: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
+0001f540: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
+0001f550: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
+0001f560: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
+0001f570: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
+0001f580: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
+0001f590: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0001f5a0: 7220 2a20 6767 6d6c 5f72 6573 6861 7065  r * ggml_reshape
+0001f5b0: 5f32 6428 0a20 2020 2020 2020 2073 7472  _2d(.        str
+0001f5c0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0001f5d0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0001f5e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0001f5f0: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
+0001f600: 2069 6e74 2020 2020 2020 2020 2020 2020   int            
+0001f610: 2020 2020 2020 206e 6530 2c0a 2020 2020         ne0,.    
+0001f620: 2020 2020 696e 7420 2020 2020 2020 2020      int         
+0001f630: 2020 2020 2020 2020 2020 6e65 3129 207b            ne1) {
+0001f640: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0001f650: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
+0001f660: 6f75 7328 6129 293b 0a20 2020 2047 474d  ous(a));.    GGM
+0001f670: 4c5f 4153 5345 5254 2867 676d 6c5f 6e65  L_ASSERT(ggml_ne
+0001f680: 6c65 6d65 6e74 7328 6129 203d 3d20 6e65  lements(a) == ne
+0001f690: 302a 6e65 3129 3b0a 0a20 2020 2062 6f6f  0*ne1);..    boo
+0001f6a0: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+0001f6b0: 653b 0a0a 2020 2020 6966 2028 612d 3e67  e;..    if (a->g
+0001f6c0: 7261 6429 207b 0a20 2020 2020 2020 2047  rad) {.        G
+0001f6d0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0001f6e0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
+0001f6f0: 656d 656e 7420 6261 636b 7761 7264 0a20  ement backward. 
+0001f700: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
+0001f710: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
+0001f720: 2020 636f 6e73 7420 696e 7420 6e65 5b32    const int ne[2
+0001f730: 5d20 3d20 7b20 6e65 302c 206e 6531 207d  ] = { ne0, ne1 }
+0001f740: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
+0001f750: 6c5f 7465 6e73 6f72 202a 2072 6573 756c  l_tensor * resul
+0001f760: 7420 3d20 6767 6d6c 5f6e 6577 5f74 656e  t = ggml_new_ten
+0001f770: 736f 725f 696d 706c 2863 7478 2c20 612d  sor_impl(ctx, a-
+0001f780: 3e74 7970 652c 2032 2c20 6e65 2c20 612d  >type, 2, ne, a-
+0001f790: 3e64 6174 6129 3b0a 0a20 2020 2072 6573  >data);..    res
+0001f7a0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
+0001f7b0: 5f4f 505f 5245 5348 4150 453b 0a20 2020  _OP_RESHAPE;.   
+0001f7c0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+0001f7d0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+0001f7e0: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+0001f7f0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+0001f800: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+0001f810: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+0001f820: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
+0001f830: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001f840: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0001f850: 5f74 656e 736f 7220 2a20 6767 6d6c 5f72  _tensor * ggml_r
+0001f860: 6573 6861 7065 5f33 6428 0a20 2020 2020  eshape_3d(.     
+0001f870: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001f880: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001f890: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001f8a0: 6c5f 7465 6e73 6f72 2020 2a20 612c 0a20  l_tensor  * a,. 
+0001f8b0: 2020 2020 2020 2069 6e74 2020 2020 2020         int      
+0001f8c0: 2020 2020 2020 2020 2020 2020 206e 6530               ne0
+0001f8d0: 2c0a 2020 2020 2020 2020 696e 7420 2020  ,.        int   
+0001f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8f0: 6e65 312c 0a20 2020 2020 2020 2069 6e74  ne1,.        int
+0001f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f910: 2020 206e 6532 2920 7b0a 2020 2020 4747     ne2) {.    GG
+0001f920: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+0001f930: 735f 636f 6e74 6967 756f 7573 2861 2929  s_contiguous(a))
+0001f940: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0001f950: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
+0001f960: 2861 2920 3d3d 206e 6530 2a6e 6531 2a6e  (a) == ne0*ne1*n
+0001f970: 6532 293b 0a0a 2020 2020 626f 6f6c 2069  e2);..    bool i
+0001f980: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+0001f990: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+0001f9a0: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
+0001f9b0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+0001f9c0: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
+0001f9d0: 6e74 2062 6163 6b77 6172 640a 2020 2020  nt backward.    
+0001f9e0: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0001f9f0: 7565 3b0a 2020 2020 7d0a 0a20 2020 2063  ue;.    }..    c
+0001fa00: 6f6e 7374 2069 6e74 206e 655b 335d 203d  onst int ne[3] =
+0001fa10: 207b 206e 6530 2c20 6e65 312c 206e 6532   { ne0, ne1, ne2
+0001fa20: 207d 3b0a 2020 2020 7374 7275 6374 2067   };.    struct g
+0001fa30: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0001fa40: 756c 7420 3d20 6767 6d6c 5f6e 6577 5f74  ult = ggml_new_t
+0001fa50: 656e 736f 725f 696d 706c 2863 7478 2c20  ensor_impl(ctx, 
+0001fa60: 612d 3e74 7970 652c 2033 2c20 6e65 2c20  a->type, 3, ne, 
+0001fa70: 612d 3e64 6174 6129 3b0a 0a20 2020 2072  a->data);..    r
+0001fa80: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+0001fa90: 4d4c 5f4f 505f 5245 5348 4150 453b 0a20  ML_OP_RESHAPE;. 
+0001faa0: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+0001fab0: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+0001fac0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+0001fad0: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+0001fae0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0001faf0: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+0001fb00: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b0a  t->src1 = NULL;.
+0001fb10: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0001fb20: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f76  lt;.}..// ggml_v
+0001fb30: 6965 775f 3164 0a0a 7374 7275 6374 2067  iew_1d..struct g
+0001fb40: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0001fb50: 6c5f 7669 6577 5f31 6428 0a20 2020 2020  l_view_1d(.     
+0001fb60: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0001fb70: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0001fb80: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001fb90: 6c5f 7465 6e73 6f72 2020 2a20 612c 0a20  l_tensor  * a,. 
+0001fba0: 2020 2020 2020 2069 6e74 2020 2020 2020         int      
+0001fbb0: 2020 2020 2020 2020 2020 2020 206e 6530               ne0
+0001fbc0: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
+0001fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fbe0: 6f66 6673 6574 2920 7b0a 2020 2020 6966  offset) {.    if
+0001fbf0: 2028 612d 3e67 7261 6429 207b 0a20 2020   (a->grad) {.   
+0001fc00: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0001fc10: 2866 616c 7365 293b 202f 2f20 6772 6164  (false); // grad
+0001fc20: 6965 6e74 2070 726f 7061 6761 7469 6f6e  ient propagation
+0001fc30: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+0001fc40: 640a 2020 2020 7d0a 0a20 2020 2073 7472  d.    }..    str
+0001fc50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001fc60: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+0001fc70: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
+0001fc80: 6374 782c 2061 2d3e 7479 7065 2c20 312c  ctx, a->type, 1,
+0001fc90: 2026 6e65 302c 2028 6368 6172 202a 2920   &ne0, (char *) 
+0001fca0: 612d 3e64 6174 6120 2b20 6f66 6673 6574  a->data + offset
+0001fcb0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
+0001fcc0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f56  op   = GGML_OP_V
+0001fcd0: 4945 573b 0a20 2020 2072 6573 756c 742d  IEW;.    result-
+0001fce0: 3e67 7261 6420 3d20 4e55 4c4c 3b0a 2020  >grad = NULL;.  
+0001fcf0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+0001fd00: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+0001fd10: 7372 6331 203d 204e 554c 4c3b 202f 2f20  src1 = NULL; // 
+0001fd20: 544f 444f 3a20 6d61 7962 6520 7374 6f72  TODO: maybe stor
+0001fd30: 6520 7468 6520 6f66 6673 6574 2068 6572  e the offset her
+0001fd40: 653f 0a0a 2020 2020 7265 7475 726e 2072  e?..    return r
+0001fd50: 6573 756c 743b 0a7d 0a0a 2f2f 2067 676d  esult;.}..// ggm
+0001fd60: 6c5f 7669 6577 5f32 640a 0a73 7472 7563  l_view_2d..struc
+0001fd70: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0001fd80: 6767 6d6c 5f76 6965 775f 3264 280a 2020  ggml_view_2d(.  
+0001fd90: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0001fda0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0001fdb0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0001fdc0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0001fdd0: 2c0a 2020 2020 2020 2020 696e 7420 2020  ,.        int   
+0001fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fdf0: 6e65 302c 0a20 2020 2020 2020 2069 6e74  ne0,.        int
+0001fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe10: 2020 206e 6531 2c0a 2020 2020 2020 2020     ne1,.        
+0001fe20: 7369 7a65 5f74 2020 2020 2020 2020 2020  size_t          
+0001fe30: 2020 2020 2020 6e62 312c 0a20 2020 2020        nb1,.     
+0001fe40: 2020 2073 697a 655f 7420 2020 2020 2020     size_t       
+0001fe50: 2020 2020 2020 2020 206f 6666 7365 7429           offset)
+0001fe60: 207b 0a20 2020 2069 6620 2861 2d3e 6772   {.    if (a->gr
+0001fe70: 6164 2920 7b0a 2020 2020 2020 2020 4747  ad) {.        GG
+0001fe80: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+0001fe90: 3b20 2f2f 2067 7261 6469 656e 7420 7072  ; // gradient pr
+0001fea0: 6f70 6167 6174 696f 6e20 6973 206e 6f74  opagation is not
+0001feb0: 2073 7570 706f 7274 6564 0a20 2020 207d   supported.    }
+0001fec0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0001fed0: 6e65 5b47 474d 4c5f 4d41 585f 4449 4d53  ne[GGML_MAX_DIMS
+0001fee0: 5d20 3d20 7b20 6e65 302c 206e 6531 2c20  ] = { ne0, ne1, 
+0001fef0: 312c 2031 207d 3b0a 0a20 2020 2073 7472  1, 1 };..    str
+0001ff00: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0001ff10: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+0001ff20: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
+0001ff30: 6374 782c 2061 2d3e 7479 7065 2c20 322c  ctx, a->type, 2,
+0001ff40: 206e 652c 2028 6368 6172 202a 2920 612d   ne, (char *) a-
+0001ff50: 3e64 6174 6120 2b20 6f66 6673 6574 293b  >data + offset);
+0001ff60: 0a0a 2020 2020 7265 7375 6c74 2d3e 6e62  ..    result->nb
+0001ff70: 5b31 5d20 3d20 6e62 313b 0a20 2020 2072  [1] = nb1;.    r
+0001ff80: 6573 756c 742d 3e6e 625b 325d 203d 2072  esult->nb[2] = r
+0001ff90: 6573 756c 742d 3e6e 625b 315d 2a6e 6531  esult->nb[1]*ne1
+0001ffa0: 3b0a 2020 2020 7265 7375 6c74 2d3e 6e62  ;.    result->nb
+0001ffb0: 5b33 5d20 3d20 7265 7375 6c74 2d3e 6e62  [3] = result->nb
+0001ffc0: 5b32 5d3b 0a0a 2020 2020 7265 7375 6c74  [2];..    result
+0001ffd0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+0001ffe0: 5f56 4945 573b 0a20 2020 2072 6573 756c  _VIEW;.    resul
+0001fff0: 742d 3e67 7261 6420 3d20 4e55 4c4c 3b0a  t->grad = NULL;.
+00020000: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+00020010: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+00020020: 2d3e 7372 6331 203d 204e 554c 4c3b 202f  ->src1 = NULL; /
+00020030: 2f20 544f 444f 3a20 6d61 7962 6520 7374  / TODO: maybe st
+00020040: 6f72 6520 7468 6520 6f66 6673 6574 2068  ore the offset h
+00020050: 6572 653f 0a0a 2020 2020 7265 7475 726e  ere?..    return
+00020060: 2072 6573 756c 743b 0a7d 0a0a 2f2f 2067   result;.}..// g
+00020070: 676d 6c5f 7065 726d 7574 650a 0a73 7472  gml_permute..str
+00020080: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00020090: 2a20 6767 6d6c 5f70 6572 6d75 7465 280a  * ggml_permute(.
+000200a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000200b0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+000200c0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+000200d0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+000200e0: 2061 2c0a 2020 2020 2020 2020 696e 7420   a,.        int 
+000200f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020100: 2020 6178 6973 302c 0a20 2020 2020 2020    axis0,.       
+00020110: 2069 6e74 2020 2020 2020 2020 2020 2020   int            
+00020120: 2020 2020 2020 2061 7869 7331 2c0a 2020         axis1,.  
+00020130: 2020 2020 2020 696e 7420 2020 2020 2020        int       
+00020140: 2020 2020 2020 2020 2020 2020 6178 6973              axis
+00020150: 322c 0a20 2020 2020 2020 2069 6e74 2020  2,.        int  
+00020160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020170: 2061 7869 7333 2920 7b0a 2020 2020 4747   axis3) {.    GG
+00020180: 4d4c 5f41 5353 4552 5428 6178 6973 3020  ML_ASSERT(axis0 
+00020190: 3e3d 2030 2026 2620 6178 6973 3020 3c20  >= 0 && axis0 < 
+000201a0: 4747 4d4c 5f4d 4158 5f44 494d 5329 3b0a  GGML_MAX_DIMS);.
+000201b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000201c0: 6178 6973 3120 3e3d 2030 2026 2620 6178  axis1 >= 0 && ax
+000201d0: 6973 3120 3c20 4747 4d4c 5f4d 4158 5f44  is1 < GGML_MAX_D
+000201e0: 494d 5329 3b0a 2020 2020 4747 4d4c 5f41  IMS);.    GGML_A
+000201f0: 5353 4552 5428 6178 6973 3220 3e3d 2030  SSERT(axis2 >= 0
+00020200: 2026 2620 6178 6973 3220 3c20 4747 4d4c   && axis2 < GGML
+00020210: 5f4d 4158 5f44 494d 5329 3b0a 2020 2020  _MAX_DIMS);.    
+00020220: 4747 4d4c 5f41 5353 4552 5428 6178 6973  GGML_ASSERT(axis
+00020230: 3320 3e3d 2030 2026 2620 6178 6973 3320  3 >= 0 && axis3 
+00020240: 3c20 4747 4d4c 5f4d 4158 5f44 494d 5329  < GGML_MAX_DIMS)
+00020250: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00020260: 5254 2861 7869 7330 2021 3d20 6178 6973  RT(axis0 != axis
+00020270: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
+00020280: 4552 5428 6178 6973 3020 213d 2061 7869  ERT(axis0 != axi
+00020290: 7332 293b 0a20 2020 2047 474d 4c5f 4153  s2);.    GGML_AS
+000202a0: 5345 5254 2861 7869 7330 2021 3d20 6178  SERT(axis0 != ax
+000202b0: 6973 3329 3b0a 2020 2020 4747 4d4c 5f41  is3);.    GGML_A
+000202c0: 5353 4552 5428 6178 6973 3120 213d 2061  SSERT(axis1 != a
+000202d0: 7869 7332 293b 0a20 2020 2047 474d 4c5f  xis2);.    GGML_
+000202e0: 4153 5345 5254 2861 7869 7331 2021 3d20  ASSERT(axis1 != 
+000202f0: 6178 6973 3329 3b0a 2020 2020 4747 4d4c  axis3);.    GGML
+00020300: 5f41 5353 4552 5428 6178 6973 3220 213d  _ASSERT(axis2 !=
+00020310: 2061 7869 7333 293b 0a0a 2020 2020 626f   axis3);..    bo
+00020320: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+00020330: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
+00020340: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00020350: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00020360: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
+00020370: 6c65 6d65 6e74 2062 6163 6b77 6172 640a  lement backward.
+00020380: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
+00020390: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
+000203a0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000203b0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+000203c0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
+000203d0: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+000203e0: 696e 7420 6e65 5b47 474d 4c5f 4d41 585f  int ne[GGML_MAX_
+000203f0: 4449 4d53 5d3b 0a20 2020 2069 6e74 206e  DIMS];.    int n
+00020400: 625b 4747 4d4c 5f4d 4158 5f44 494d 535d  b[GGML_MAX_DIMS]
+00020410: 3b0a 0a20 2020 206e 655b 6178 6973 305d  ;..    ne[axis0]
+00020420: 203d 2061 2d3e 6e65 5b30 5d3b 0a20 2020   = a->ne[0];.   
+00020430: 206e 655b 6178 6973 315d 203d 2061 2d3e   ne[axis1] = a->
+00020440: 6e65 5b31 5d3b 0a20 2020 206e 655b 6178  ne[1];.    ne[ax
+00020450: 6973 325d 203d 2061 2d3e 6e65 5b32 5d3b  is2] = a->ne[2];
+00020460: 0a20 2020 206e 655b 6178 6973 335d 203d  .    ne[axis3] =
+00020470: 2061 2d3e 6e65 5b33 5d3b 0a0a 2020 2020   a->ne[3];..    
+00020480: 6e62 5b61 7869 7330 5d20 3d20 612d 3e6e  nb[axis0] = a->n
+00020490: 625b 305d 3b0a 2020 2020 6e62 5b61 7869  b[0];.    nb[axi
+000204a0: 7331 5d20 3d20 612d 3e6e 625b 315d 3b0a  s1] = a->nb[1];.
+000204b0: 2020 2020 6e62 5b61 7869 7332 5d20 3d20      nb[axis2] = 
+000204c0: 612d 3e6e 625b 325d 3b0a 2020 2020 6e62  a->nb[2];.    nb
+000204d0: 5b61 7869 7333 5d20 3d20 612d 3e6e 625b  [axis3] = a->nb[
+000204e0: 335d 3b0a 0a20 2020 2072 6573 756c 742d  3];..    result-
+000204f0: 3e6e 655b 305d 203d 206e 655b 305d 3b0a  >ne[0] = ne[0];.
+00020500: 2020 2020 7265 7375 6c74 2d3e 6e65 5b31      result->ne[1
+00020510: 5d20 3d20 6e65 5b31 5d3b 0a20 2020 2072  ] = ne[1];.    r
+00020520: 6573 756c 742d 3e6e 655b 325d 203d 206e  esult->ne[2] = n
+00020530: 655b 325d 3b0a 2020 2020 7265 7375 6c74  e[2];.    result
+00020540: 2d3e 6e65 5b33 5d20 3d20 6e65 5b33 5d3b  ->ne[3] = ne[3];
+00020550: 0a0a 2020 2020 7265 7375 6c74 2d3e 6e62  ..    result->nb
+00020560: 5b30 5d20 3d20 6e62 5b30 5d3b 0a20 2020  [0] = nb[0];.   
+00020570: 2072 6573 756c 742d 3e6e 625b 315d 203d   result->nb[1] =
+00020580: 206e 625b 315d 3b0a 2020 2020 7265 7375   nb[1];.    resu
+00020590: 6c74 2d3e 6e62 5b32 5d20 3d20 6e62 5b32  lt->nb[2] = nb[2
+000205a0: 5d3b 0a20 2020 2072 6573 756c 742d 3e6e  ];.    result->n
+000205b0: 625b 335d 203d 206e 625b 335d 3b0a 0a20  b[3] = nb[3];.. 
+000205c0: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
+000205d0: 3d20 4747 4d4c 5f4f 505f 5045 524d 5554  = GGML_OP_PERMUT
+000205e0: 453b 0a20 2020 2072 6573 756c 742d 3e67  E;.    result->g
+000205f0: 7261 6420 3d20 6973 5f6e 6f64 6520 3f20  rad = is_node ? 
+00020600: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00020610: 6374 782c 2072 6573 756c 7429 203a 204e  ctx, result) : N
+00020620: 554c 4c3b 0a20 2020 2072 6573 756c 742d  ULL;.    result-
+00020630: 3e73 7263 3020 3d20 613b 0a20 2020 2072  >src0 = a;.    r
+00020640: 6573 756c 742d 3e73 7263 3120 3d20 4e55  esult->src1 = NU
+00020650: 4c4c 3b20 2f2f 2054 4f44 4f3a 206d 6179  LL; // TODO: may
+00020660: 6265 2073 746f 7265 2074 6865 2070 6572  be store the per
+00020670: 6d75 7461 7469 6f6e 2068 6572 653f 0a0a  mutation here?..
+00020680: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00020690: 743b 0a7d 0a0a 2f2f 2067 676d 6c5f 7472  t;.}..// ggml_tr
+000206a0: 616e 7370 6f73 650a 0a73 7472 7563 7420  anspose..struct 
+000206b0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+000206c0: 6d6c 5f74 7261 6e73 706f 7365 280a 2020  ml_transpose(.  
+000206d0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000206e0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+000206f0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00020700: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+00020710: 2920 7b0a 2020 2020 626f 6f6c 2069 735f  ) {.    bool is_
+00020720: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
+00020730: 2020 2069 6620 2861 2d3e 6772 6164 2920     if (a->grad) 
+00020740: 7b0a 2020 2020 2020 2020 4747 4d4c 5f41  {.        GGML_A
+00020750: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00020760: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
+00020770: 2062 6163 6b77 6172 640a 2020 2020 2020   backward.      
+00020780: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+00020790: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+000207a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000207b0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+000207c0: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
+000207d0: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
+000207e0: 2d3e 6e65 5b30 5d20 3d20 612d 3e6e 655b  ->ne[0] = a->ne[
+000207f0: 315d 3b0a 2020 2020 7265 7375 6c74 2d3e  1];.    result->
+00020800: 6e65 5b31 5d20 3d20 612d 3e6e 655b 305d  ne[1] = a->ne[0]
+00020810: 3b0a 0a20 2020 2072 6573 756c 742d 3e6e  ;..    result->n
+00020820: 625b 305d 203d 2061 2d3e 6e62 5b31 5d3b  b[0] = a->nb[1];
+00020830: 0a20 2020 2072 6573 756c 742d 3e6e 625b  .    result->nb[
+00020840: 315d 203d 2061 2d3e 6e62 5b30 5d3b 0a0a  1] = a->nb[0];..
+00020850: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
+00020860: 203d 2047 474d 4c5f 4f50 5f54 5241 4e53   = GGML_OP_TRANS
+00020870: 504f 5345 3b0a 2020 2020 7265 7375 6c74  POSE;.    result
+00020880: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+00020890: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+000208a0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+000208b0: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+000208c0: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+000208d0: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+000208e0: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
+000208f0: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
+00020900: 2067 676d 6c5f 6765 745f 726f 7773 0a0a   ggml_get_rows..
+00020910: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00020920: 6f72 202a 2067 676d 6c5f 6765 745f 726f  or * ggml_get_ro
+00020930: 7773 280a 2020 2020 2020 2020 7374 7275  ws(.        stru
+00020940: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00020950: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+00020960: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00020970: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
+00020980: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00020990: 6f72 2020 2a20 6229 207b 0a20 2020 2047  or  * b) {.    G
+000209a0: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+000209b0: 6973 5f6d 6174 7269 7828 6129 2026 2620  is_matrix(a) && 
+000209c0: 6767 6d6c 5f69 735f 7665 6374 6f72 2862  ggml_is_vector(b
+000209d0: 2920 2626 2062 2d3e 7479 7065 203d 3d20  ) && b->type == 
+000209e0: 4747 4d4c 5f54 5950 455f 4933 3229 3b0a  GGML_TYPE_I32);.
+000209f0: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
+00020a00: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
+00020a10: 6966 2028 612d 3e67 7261 6420 7c7c 2062  if (a->grad || b
+00020a20: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00020a30: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00020a40: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 2069  lse); // TODO: i
+00020a50: 6d70 6c65 6d65 6e74 2062 6163 6b77 6172  mplement backwar
+00020a60: 640a 2020 2020 2020 2020 6973 5f6e 6f64  d.        is_nod
+00020a70: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
+00020a80: 0a20 2020 202f 2f20 544f 444f 3a20 696d  .    // TODO: im
+00020a90: 706c 656d 656e 7420 6e6f 6e20 4633 3220  plement non F32 
+00020aa0: 7265 7475 726e 0a20 2020 202f 2f73 7472  return.    //str
+00020ab0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00020ac0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+00020ad0: 6e65 775f 7465 6e73 6f72 5f32 6428 6374  new_tensor_2d(ct
+00020ae0: 782c 2061 2d3e 7479 7065 2c20 612d 3e6e  x, a->type, a->n
+00020af0: 655b 305d 2c20 622d 3e6e 655b 305d 293b  e[0], b->ne[0]);
+00020b00: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00020b10: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+00020b20: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00020b30: 6f72 5f32 6428 6374 782c 2047 474d 4c5f  or_2d(ctx, GGML_
+00020b40: 5459 5045 5f46 3332 2c20 612d 3e6e 655b  TYPE_F32, a->ne[
+00020b50: 305d 2c20 622d 3e6e 655b 305d 293b 0a0a  0], b->ne[0]);..
+00020b60: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
+00020b70: 203d 2047 474d 4c5f 4f50 5f47 4554 5f52   = GGML_OP_GET_R
+00020b80: 4f57 533b 0a20 2020 2072 6573 756c 742d  OWS;.    result-
+00020b90: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
+00020ba0: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
+00020bb0: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
+00020bc0: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
+00020bd0: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
+00020be0: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
+00020bf0: 623b 0a0a 2020 2020 7265 7475 726e 2072  b;..    return r
+00020c00: 6573 756c 743b 0a7d 0a0a 2f2f 2067 676d  esult;.}..// ggm
+00020c10: 6c5f 6469 6167 5f6d 6173 6b5f 696e 660a  l_diag_mask_inf.
+00020c20: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00020c30: 736f 7220 2a20 6767 6d6c 5f64 6961 675f  sor * ggml_diag_
+00020c40: 6d61 736b 5f69 6e66 280a 2020 2020 2020  mask_inf(.      
+00020c50: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+00020c60: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+00020c70: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00020c80: 5f74 656e 736f 7220 202a 2061 2c0a 2020  _tensor  * a,.  
+00020c90: 2020 2020 2020 696e 7420 2020 2020 2020        int       
+00020ca0: 2020 2020 2020 2020 2020 2020 6e5f 7061              n_pa
+00020cb0: 7374 2920 7b0a 2020 2020 626f 6f6c 2069  st) {.    bool i
+00020cc0: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+00020cd0: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+00020ce0: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
+00020cf0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+00020d00: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
+00020d10: 6e74 2062 6163 6b77 6172 640a 2020 2020  nt backward.    
+00020d20: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+00020d30: 7565 3b0a 2020 2020 7d0a 0a20 2020 202f  ue;.    }..    /
+00020d40: 2f20 544f 444f 3a20 7768 656e 2069 6d70  / TODO: when imp
+00020d50: 6c65 6d65 6e74 2062 6163 6b77 6172 642c  lement backward,
+00020d60: 2066 6978 2074 6869 733a 0a20 2020 202f   fix this:.    /
+00020d70: 2f73 7472 7563 7420 6767 6d6c 5f74 656e  /struct ggml_ten
+00020d80: 736f 7220 2a20 7265 7375 6c74 203d 2069  sor * result = i
+00020d90: 6e70 6c61 6365 203f 2067 676d 6c5f 7669  nplace ? ggml_vi
+00020da0: 6577 5f74 656e 736f 7228 6374 782c 2061  ew_tensor(ctx, a
+00020db0: 2920 3a20 6767 6d6c 5f64 7570 5f74 656e  ) : ggml_dup_ten
+00020dc0: 736f 7228 6374 782c 2061 293b 0a20 2020  sor(ctx, a);.   
+00020dd0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00020de0: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
+00020df0: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
+00020e00: 6374 782c 2061 293b 0a20 2020 2073 7472  ctx, a);.    str
+00020e10: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00020e20: 2a20 6220 3d20 6767 6d6c 5f6e 6577 5f69  * b = ggml_new_i
+00020e30: 3332 2863 7478 2c20 6e5f 7061 7374 293b  32(ctx, n_past);
+00020e40: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
+00020e50: 2020 203d 2047 474d 4c5f 4f50 5f44 4941     = GGML_OP_DIA
+00020e60: 475f 4d41 534b 5f49 4e46 3b0a 2020 2020  G_MASK_INF;.    
+00020e70: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+00020e80: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+00020e90: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+00020ea0: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+00020eb0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+00020ec0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+00020ed0: 7372 6331 203d 2062 3b0a 0a20 2020 2072  src1 = b;..    r
+00020ee0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+00020ef0: 0a2f 2f20 6767 6d6c 5f73 6f66 745f 6d61  .// ggml_soft_ma
+00020f00: 780a 0a73 7472 7563 7420 6767 6d6c 5f74  x..struct ggml_t
+00020f10: 656e 736f 7220 2a20 6767 6d6c 5f73 6f66  ensor * ggml_sof
+00020f20: 745f 6d61 7828 0a20 2020 2020 2020 2073  t_max(.        s
+00020f30: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+00020f40: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+00020f50: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00020f60: 6e73 6f72 2020 2a20 6129 207b 0a20 2020  nsor  * a) {.   
+00020f70: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
+00020f80: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
+00020f90: 612d 3e67 7261 6429 207b 0a20 2020 2020  a->grad) {.     
+00020fa0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00020fb0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00020fc0: 696d 706c 656d 656e 7420 6261 636b 7761  implement backwa
+00020fd0: 7264 0a20 2020 2020 2020 2069 735f 6e6f  rd.        is_no
+00020fe0: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
+00020ff0: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2077  ..    // TODO: w
+00021000: 6865 6e20 696d 706c 656d 656e 7420 6261  hen implement ba
+00021010: 636b 7761 7264 2c20 6669 7820 7468 6973  ckward, fix this
+00021020: 3a0a 2020 2020 2f2f 7374 7275 6374 2067  :.    //struct g
+00021030: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+00021040: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
+00021050: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
+00021060: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
+00021070: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+00021080: 6129 3b0a 2020 2020 7374 7275 6374 2067  a);.    struct g
+00021090: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+000210a0: 756c 7420 3d20 6767 6d6c 5f76 6965 775f  ult = ggml_view_
+000210b0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+000210c0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+000210d0: 2020 3d20 4747 4d4c 5f4f 505f 534f 4654    = GGML_OP_SOFT
+000210e0: 5f4d 4158 3b0a 2020 2020 7265 7375 6c74  _MAX;.    result
+000210f0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+00021100: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+00021110: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+00021120: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+00021130: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+00021140: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+00021150: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
+00021160: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
+00021170: 2067 676d 6c5f 726f 7065 0a0a 7374 7275   ggml_rope..stru
+00021180: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00021190: 2067 676d 6c5f 726f 7065 280a 2020 2020   ggml_rope(.    
+000211a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000211b0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+000211c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000211d0: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
+000211e0: 2020 2020 2020 2020 696e 7420 2020 2020          int     
+000211f0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+00021200: 7061 7374 2c0a 2020 2020 2020 2020 696e  past,.        in
+00021210: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+00021220: 2020 2020 6e5f 6469 6d73 2c0a 2020 2020      n_dims,.    
+00021230: 2020 2020 696e 7420 2020 2020 2020 2020      int         
+00021240: 2020 2020 2020 2020 2020 6d6f 6465 2920            mode) 
+00021250: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+00021260: 5428 6e5f 7061 7374 203e 3d20 3029 3b0a  T(n_past >= 0);.
+00021270: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+00021280: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+00021290: 6620 2861 2d3e 6772 6164 2920 7b0a 2020  f (a->grad) {.  
+000212a0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000212b0: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
+000212c0: 4f3a 2069 6d70 6c65 6d65 6e74 2062 6163  O: implement bac
+000212d0: 6b77 6172 640a 2020 2020 2020 2020 6973  kward.        is
+000212e0: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
+000212f0: 2020 7d0a 0a20 2020 202f 2f20 544f 444f    }..    // TODO
+00021300: 3a20 7768 656e 2069 6d70 6c65 6d65 6e74  : when implement
+00021310: 2062 6163 6b77 6172 642c 2066 6978 2074   backward, fix t
+00021320: 6869 733a 0a20 2020 202f 2f73 7472 7563  his:.    //struc
+00021330: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00021340: 7265 7375 6c74 203d 2069 6e70 6c61 6365  result = inplace
+00021350: 203f 2067 676d 6c5f 7669 6577 5f74 656e   ? ggml_view_ten
+00021360: 736f 7228 6374 782c 2061 2920 3a20 6767  sor(ctx, a) : gg
+00021370: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+00021380: 782c 2061 293b 0a20 2020 2073 7472 7563  x, a);.    struc
+00021390: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000213a0: 7265 7375 6c74 203d 2067 676d 6c5f 7669  result = ggml_vi
+000213b0: 6577 5f74 656e 736f 7228 6374 782c 2061  ew_tensor(ctx, a
+000213c0: 293b 0a0a 2020 2020 7374 7275 6374 2067  );..    struct g
+000213d0: 676d 6c5f 7465 6e73 6f72 202a 2062 203d  gml_tensor * b =
+000213e0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+000213f0: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
+00021400: 5045 5f49 3332 2c20 3329 3b0a 2020 2020  PE_I32, 3);.    
+00021410: 2828 696e 7433 325f 7420 2a29 2062 2d3e  ((int32_t *) b->
+00021420: 6461 7461 295b 305d 203d 206e 5f70 6173  data)[0] = n_pas
+00021430: 743b 0a20 2020 2028 2869 6e74 3332 5f74  t;.    ((int32_t
+00021440: 202a 2920 622d 3e64 6174 6129 5b31 5d20   *) b->data)[1] 
+00021450: 3d20 6e5f 6469 6d73 3b0a 2020 2020 2828  = n_dims;.    ((
+00021460: 696e 7433 325f 7420 2a29 2062 2d3e 6461  int32_t *) b->da
+00021470: 7461 295b 325d 203d 206d 6f64 653b 0a0a  ta)[2] = mode;..
+00021480: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
+00021490: 203d 2047 474d 4c5f 4f50 5f52 4f50 453b   = GGML_OP_ROPE;
+000214a0: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+000214b0: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+000214c0: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+000214d0: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+000214e0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+000214f0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+00021500: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
+00021510: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00021520: 743b 0a7d 0a0a 2f2f 2067 676d 6c5f 636f  t;.}..// ggml_co
+00021530: 6e76 5f31 645f 3173 0a0a 7374 7275 6374  nv_1d_1s..struct
+00021540: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+00021550: 676d 6c5f 636f 6e76 5f31 645f 3173 280a  gml_conv_1d_1s(.
+00021560: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00021570: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00021580: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00021590: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+000215a0: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
+000215b0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+000215c0: 2a20 6229 207b 0a20 2020 2047 474d 4c5f  * b) {.    GGML_
+000215d0: 4153 5345 5254 2867 676d 6c5f 6973 5f6d  ASSERT(ggml_is_m
+000215e0: 6174 7269 7828 6229 293b 0a20 2020 2047  atrix(b));.    G
+000215f0: 474d 4c5f 4153 5345 5254 2861 2d3e 6e65  GML_ASSERT(a->ne
+00021600: 5b31 5d20 3d3d 2062 2d3e 6e65 5b31 5d29  [1] == b->ne[1])
+00021610: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00021620: 5428 612d 3e6e 655b 335d 203d 3d20 3129  T(a->ne[3] == 1)
+00021630: 3b0a 2020 2020 626f 6f6c 2069 735f 6e6f  ;.    bool is_no
+00021640: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+00021650: 2069 6620 2861 2d3e 6772 6164 207c 7c20   if (a->grad || 
+00021660: 622d 3e67 7261 6429 207b 0a20 2020 2020  b->grad) {.     
+00021670: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00021680: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00021690: 696d 706c 656d 656e 7420 6261 636b 7761  implement backwa
+000216a0: 7264 0a20 2020 2020 2020 2069 735f 6e6f  rd.        is_no
+000216b0: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
+000216c0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+000216d0: 6e65 5b34 5d20 3d20 7b20 622d 3e6e 655b  ne[4] = { b->ne[
+000216e0: 305d 2c20 612d 3e6e 655b 325d 2c20 312c  0], a->ne[2], 1,
+000216f0: 2031 2c20 7d3b 0a20 2020 2073 7472 7563   1, };.    struc
+00021700: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00021710: 7265 7375 6c74 203d 2067 676d 6c5f 6e65  result = ggml_ne
+00021720: 775f 7465 6e73 6f72 2863 7478 2c20 4747  w_tensor(ctx, GG
+00021730: 4d4c 5f54 5950 455f 4633 322c 2032 2c20  ML_TYPE_F32, 2, 
+00021740: 6e65 293b 0a0a 2020 2020 7265 7375 6c74  ne);..    result
+00021750: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+00021760: 5f43 4f4e 565f 3144 5f31 533b 0a20 2020  _CONV_1D_1S;.   
+00021770: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+00021780: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+00021790: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+000217a0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+000217b0: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+000217c0: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+000217d0: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
+000217e0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+000217f0: 0a0a 2f2f 2067 676d 6c5f 636f 6e76 5f31  ..// ggml_conv_1
+00021800: 645f 3273 0a0a 7374 7275 6374 2067 676d  d_2s..struct ggm
+00021810: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00021820: 636f 6e76 5f31 645f 3273 280a 2020 2020  conv_1d_2s(.    
+00021830: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00021840: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+00021850: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00021860: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
+00021870: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00021880: 676d 6c5f 7465 6e73 6f72 2020 2a20 6229  gml_tensor  * b)
+00021890: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+000218a0: 5254 2867 676d 6c5f 6973 5f6d 6174 7269  RT(ggml_is_matri
+000218b0: 7828 6229 293b 0a20 2020 2047 474d 4c5f  x(b));.    GGML_
+000218c0: 4153 5345 5254 2861 2d3e 6e65 5b31 5d20  ASSERT(a->ne[1] 
+000218d0: 3d3d 2062 2d3e 6e65 5b31 5d29 3b0a 2020  == b->ne[1]);.  
+000218e0: 2020 4747 4d4c 5f41 5353 4552 5428 612d    GGML_ASSERT(a-
+000218f0: 3e6e 655b 335d 203d 3d20 3129 3b0a 2020  >ne[3] == 1);.  
+00021900: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+00021910: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+00021920: 2861 2d3e 6772 6164 207c 7c20 622d 3e67  (a->grad || b->g
+00021930: 7261 6429 207b 0a20 2020 2020 2020 2047  rad) {.        G
+00021940: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00021950: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
+00021960: 656d 656e 7420 6261 636b 7761 7264 0a20  ement backward. 
+00021970: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
+00021980: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
+00021990: 2020 636f 6e73 7420 696e 7420 6e65 5b34    const int ne[4
+000219a0: 5d20 3d20 7b20 622d 3e6e 655b 305d 2f32  ] = { b->ne[0]/2
+000219b0: 2c20 612d 3e6e 655b 325d 2c20 312c 2031  , a->ne[2], 1, 1
+000219c0: 2c20 7d3b 0a20 2020 2073 7472 7563 7420  , };.    struct 
+000219d0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+000219e0: 7375 6c74 203d 2067 676d 6c5f 6e65 775f  sult = ggml_new_
+000219f0: 7465 6e73 6f72 2863 7478 2c20 4747 4d4c  tensor(ctx, GGML
+00021a00: 5f54 5950 455f 4633 322c 2032 2c20 6e65  _TYPE_F32, 2, ne
+00021a10: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
+00021a20: 6f70 2020 203d 2047 474d 4c5f 4f50 5f43  op   = GGML_OP_C
+00021a30: 4f4e 565f 3144 5f32 533b 0a20 2020 2072  ONV_1D_2S;.    r
+00021a40: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+00021a50: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+00021a60: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+00021a70: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+00021a80: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+00021a90: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+00021aa0: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
+00021ab0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+00021ac0: 2f2f 2067 676d 6c5f 666c 6173 685f 6174  // ggml_flash_at
+00021ad0: 746e 0a0a 7374 7275 6374 2067 676d 6c5f  tn..struct ggml_
+00021ae0: 7465 6e73 6f72 202a 2067 676d 6c5f 666c  tensor * ggml_fl
+00021af0: 6173 685f 6174 746e 280a 2020 2020 2020  ash_attn(.      
+00021b00: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+00021b10: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+00021b20: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00021b30: 5f74 656e 736f 7220 202a 2071 2c0a 2020  _tensor  * q,.  
+00021b40: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00021b50: 6c5f 7465 6e73 6f72 2020 2a20 6b2c 0a20  l_tensor  * k,. 
+00021b60: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00021b70: 6d6c 5f74 656e 736f 7220 202a 2076 2c0a  ml_tensor  * v,.
+00021b80: 2020 2020 2020 2020 626f 6f6c 2020 2020          bool    
+00021b90: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00021ba0: 736b 6564 2920 7b0a 2020 2020 4747 4d4c  sked) {.    GGML
+00021bb0: 5f41 5353 4552 5428 6767 6d6c 5f63 616e  _ASSERT(ggml_can
+00021bc0: 5f6d 756c 5f6d 6174 286b 2c20 7129 293b  _mul_mat(k, q));
+00021bd0: 0a20 2020 202f 2f20 544f 444f 3a20 6368  .    // TODO: ch
+00021be0: 6563 6b20 6966 2076 5420 6361 6e20 6265  eck if vT can be
+00021bf0: 206d 756c 7469 706c 6965 6420 6279 2028   multiplied by (
+00021c00: 6b2a 7154 290a 0a20 2020 2062 6f6f 6c20  k*qT)..    bool 
+00021c10: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
+00021c20: 0a0a 2020 2020 6966 2028 712d 3e67 7261  ..    if (q->gra
+00021c30: 6420 7c7c 206b 2d3e 6772 6164 207c 7c20  d || k->grad || 
+00021c40: 762d 3e67 7261 6429 207b 0a20 2020 2020  v->grad) {.     
+00021c50: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00021c60: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00021c70: 696d 706c 656d 656e 7420 6261 636b 7761  implement backwa
+00021c80: 7264 0a20 2020 2020 2020 2069 735f 6e6f  rd.        is_no
+00021c90: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
+00021ca0: 0a0a 2020 2020 2f2f 7374 7275 6374 2067  ..    //struct g
+00021cb0: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+00021cc0: 756c 7420 3d20 6767 6d6c 5f64 7570 5f74  ult = ggml_dup_t
+00021cd0: 656e 736f 7228 6374 782c 2071 293b 0a20  ensor(ctx, q);. 
+00021ce0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00021cf0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+00021d00: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00021d10: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+00021d20: 4633 322c 2034 2c20 712d 3e6e 6529 3b0a  F32, 4, q->ne);.
+00021d30: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+00021d40: 2020 3d20 4747 4d4c 5f4f 505f 464c 4153    = GGML_OP_FLAS
+00021d50: 485f 4154 544e 3b0a 2020 2020 7265 7375  H_ATTN;.    resu
+00021d60: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
+00021d70: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
+00021d80: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
+00021d90: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
+00021da0: 7375 6c74 2d3e 7372 6330 203d 2071 3b0a  sult->src0 = q;.
+00021db0: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
+00021dc0: 203d 206b 3b0a 2020 2020 7265 7375 6c74   = k;.    result
+00021dd0: 2d3e 6f70 745b 305d 203d 2076 3b0a 2020  ->opt[0] = v;.  
+00021de0: 2020 7265 7375 6c74 2d3e 6f70 745b 315d    result->opt[1]
+00021df0: 203d 2067 676d 6c5f 6e65 775f 6933 3228   = ggml_new_i32(
+00021e00: 6374 782c 206d 6173 6b65 6420 3f20 3120  ctx, masked ? 1 
+00021e10: 3a20 3029 3b0a 0a20 2020 2072 6574 7572  : 0);..    retur
+00021e20: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
+00021e30: 6767 6d6c 5f66 6c61 7368 5f66 660a 0a73  ggml_flash_ff..s
+00021e40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00021e50: 7220 2a20 6767 6d6c 5f66 6c61 7368 5f66  r * ggml_flash_f
+00021e60: 6628 0a20 2020 2020 2020 2073 7472 7563  f(.        struc
+00021e70: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00021e80: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+00021e90: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00021ea0: 2020 2a20 612c 0a20 2020 2020 2020 2073    * a,.        s
+00021eb0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00021ec0: 7220 202a 2062 302c 0a20 2020 2020 2020  r  * b0,.       
+00021ed0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00021ee0: 736f 7220 202a 2062 312c 0a20 2020 2020  sor  * b1,.     
+00021ef0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00021f00: 656e 736f 7220 202a 2063 302c 0a20 2020  ensor  * c0,.   
+00021f10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00021f20: 5f74 656e 736f 7220 202a 2063 3129 207b  _tensor  * c1) {
+00021f30: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00021f40: 2867 676d 6c5f 6361 6e5f 6d75 6c5f 6d61  (ggml_can_mul_ma
+00021f50: 7428 6230 2c20 6129 293b 0a20 2020 202f  t(b0, a));.    /
+00021f60: 2f20 544f 444f 3a20 6d6f 7265 2063 6865  / TODO: more che
+00021f70: 636b 730a 0a20 2020 2062 6f6f 6c20 6973  cks..    bool is
+00021f80: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
+00021f90: 2020 2020 6966 2028 612d 3e67 7261 6420      if (a->grad 
+00021fa0: 7c7c 2062 302d 3e67 7261 6420 7c7c 2062  || b0->grad || b
+00021fb0: 312d 3e67 7261 6420 7c7c 2063 302d 3e67  1->grad || c0->g
+00021fc0: 7261 6420 7c7c 2063 312d 3e67 7261 6429  rad || c1->grad)
+00021fd0: 207b 0a20 2020 2020 2020 2047 474d 4c5f   {.        GGML_
+00021fe0: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+00021ff0: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
+00022000: 7420 6261 636b 7761 7264 0a20 2020 2020  t backward.     
+00022010: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
+00022020: 653b 0a20 2020 207d 0a0a 2020 2020 2f2f  e;.    }..    //
+00022030: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00022040: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
+00022050: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+00022060: 782c 2061 293b 0a20 2020 2073 7472 7563  x, a);.    struc
+00022070: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00022080: 7265 7375 6c74 203d 2067 676d 6c5f 6e65  result = ggml_ne
+00022090: 775f 7465 6e73 6f72 2863 7478 2c20 4747  w_tensor(ctx, GG
+000220a0: 4d4c 5f54 5950 455f 4633 322c 2034 2c20  ML_TYPE_F32, 4, 
+000220b0: 612d 3e6e 6529 3b0a 0a20 2020 2072 6573  a->ne);..    res
+000220c0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
+000220d0: 5f4f 505f 464c 4153 485f 4646 3b0a 2020  _OP_FLASH_FF;.  
+000220e0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
+000220f0: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
+00022100: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+00022110: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
+00022120: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+00022130: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+00022140: 2d3e 7372 6331 203d 2062 303b 0a20 2020  ->src1 = b0;.   
+00022150: 2072 6573 756c 742d 3e6f 7074 5b30 5d20   result->opt[0] 
+00022160: 3d20 6231 3b0a 2020 2020 7265 7375 6c74  = b1;.    result
+00022170: 2d3e 6f70 745b 315d 203d 2063 303b 0a20  ->opt[1] = c0;. 
+00022180: 2020 2072 6573 756c 742d 3e6f 7074 5b32     result->opt[2
+00022190: 5d20 3d20 6331 3b0a 0a20 2020 2072 6574  ] = c1;..    ret
+000221a0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+000221b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000221c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000221d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000221e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000221f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
+00022200: 0a76 6f69 6420 6767 6d6c 5f73 6574 5f70  .void ggml_set_p
+00022210: 6172 616d 280a 2020 2020 2020 2020 7374  aram(.        st
+00022220: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00022230: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+00022240: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00022250: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
+00022260: 2020 2020 7465 6e73 6f72 2d3e 6973 5f70      tensor->is_p
+00022270: 6172 616d 203d 2074 7275 653b 0a0a 2020  aram = true;..  
+00022280: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
+00022290: 6e73 6f72 2d3e 6772 6164 203d 3d20 4e55  nsor->grad == NU
+000222a0: 4c4c 293b 0a20 2020 2074 656e 736f 722d  LL);.    tensor-
+000222b0: 3e67 7261 6420 3d20 6767 6d6c 5f64 7570  >grad = ggml_dup
+000222c0: 5f74 656e 736f 7228 6374 782c 2074 656e  _tensor(ctx, ten
+000222d0: 736f 7229 3b0a 7d0a 0a2f 2f20 6767 6d6c  sor);.}..// ggml
+000222e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000222f0: 5f64 7570 0a0a 7374 6174 6963 2076 6f69  _dup..static voi
+00022300: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00022310: 6f72 7761 7264 5f64 7570 5f66 3136 280a  orward_dup_f16(.
+00022320: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00022330: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00022340: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00022350: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00022360: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00022370: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00022380: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00022390: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+000223a0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000223b0: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
+000223c0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000223d0: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+000223e0: 6775 6f75 7328 6473 7429 293b 0a20 2020  guous(dst));.   
+000223f0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00022400: 6c5f 6e65 6c65 6d65 6e74 7328 6473 7429  l_nelements(dst)
+00022410: 203d 3d20 6767 6d6c 5f6e 656c 656d 656e   == ggml_nelemen
+00022420: 7473 2873 7263 3029 293b 0a0a 2020 2020  ts(src0));..    
+00022430: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00022440: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+00022450: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+00022460: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00022470: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00022480: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00022490: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+000224a0: 206e 6530 3020 3d20 7372 6330 2d3e 6e65   ne00 = src0->ne
+000224b0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+000224c0: 6e74 206e 6530 3120 3d20 7372 6330 2d3e  nt ne01 = src0->
+000224d0: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+000224e0: 2069 6e74 206e 6530 3220 3d20 7372 6330   int ne02 = src0
+000224f0: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+00022500: 7374 2069 6e74 206e 6530 3320 3d20 7372  st int ne03 = sr
+00022510: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
+00022520: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00022530: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
+00022540: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00022550: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+00022560: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+00022570: 7369 7a65 5f74 206e 6230 3220 3d20 7372  size_t nb02 = sr
+00022580: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
+00022590: 6f6e 7374 2073 697a 655f 7420 6e62 3033  onst size_t nb03
+000225a0: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
+000225b0: 0a20 2020 2069 6620 2867 676d 6c5f 6973  .    if (ggml_is
+000225c0: 5f63 6f6e 7469 6775 6f75 7328 7372 6330  _contiguous(src0
+000225d0: 2920 2626 2073 7263 302d 3e74 7970 6520  ) && src0->type 
+000225e0: 3d3d 2064 7374 2d3e 7479 7065 2920 7b0a  == dst->type) {.
+000225f0: 2020 2020 2020 2020 6d65 6d63 7079 2864          memcpy(d
+00022600: 7374 2d3e 6461 7461 2c20 7372 6330 2d3e  st->data, src0->
+00022610: 6461 7461 2c20 6767 6d6c 5f6e 656c 656d  data, ggml_nelem
+00022620: 656e 7473 2864 7374 2920 2a20 4747 4d4c  ents(dst) * GGML
+00022630: 5f54 5950 455f 5349 5a45 5b73 7263 302d  _TYPE_SIZE[src0-
+00022640: 3e74 7970 655d 293b 0a20 2020 2020 2020  >type]);.       
+00022650: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00022660: 2020 2020 6966 2028 7372 6330 2d3e 6e62      if (src0->nb
+00022670: 5b30 5d20 3d3d 2073 697a 656f 6628 6767  [0] == sizeof(gg
+00022680: 6d6c 5f66 7031 365f 7429 2920 7b0a 2020  ml_fp16_t)) {.  
+00022690: 2020 2020 2020 6966 2028 6473 742d 3e74        if (dst->t
+000226a0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+000226b0: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
+000226c0: 2020 2020 7369 7a65 5f74 2069 6420 3d20      size_t id = 
+000226d0: 303b 0a20 2020 2020 2020 2020 2020 2063  0;.            c
+000226e0: 6f6e 7374 2073 697a 655f 7420 7273 203d  onst size_t rs =
+000226f0: 206e 6530 302a 6e62 3030 3b0a 0a20 2020   ne00*nb00;..   
+00022700: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00022710: 7420 6930 3320 3d20 303b 2069 3033 203c  t i03 = 0; i03 <
+00022720: 206e 6530 333b 2069 3033 2b2b 2920 7b0a   ne03; i03++) {.
+00022730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022740: 666f 7220 2869 6e74 2069 3032 203d 2030  for (int i02 = 0
+00022750: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
+00022760: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+00022770: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00022780: 696e 7420 6930 3120 3d20 303b 2069 3031  int i01 = 0; i01
+00022790: 203c 206e 6530 313b 2069 3031 2b2b 2920   < ne01; i01++) 
+000227a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000227b0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+000227c0: 6368 6172 202a 2073 7263 305f 7074 7220  char * src0_ptr 
+000227d0: 3d20 2863 6861 7220 2a29 2073 7263 302d  = (char *) src0-
+000227e0: 3e64 6174 6120 2b20 6930 312a 6e62 3031  >data + i01*nb01
+000227f0: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
+00022800: 332a 6e62 3033 3b0a 2020 2020 2020 2020  3*nb03;.        
+00022810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022820: 6368 6172 202a 2064 7374 5f70 7472 203d  char * dst_ptr =
+00022830: 2028 6368 6172 202a 2920 6473 742d 3e64   (char *) dst->d
+00022840: 6174 6120 2b20 6964 2a72 733b 0a0a 2020  ata + id*rs;..  
+00022850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022860: 2020 2020 2020 6d65 6d63 7079 2864 7374        memcpy(dst
+00022870: 5f70 7472 2c20 7372 6330 5f70 7472 2c20  _ptr, src0_ptr, 
+00022880: 7273 293b 0a0a 2020 2020 2020 2020 2020  rs);..          
+00022890: 2020 2020 2020 2020 2020 2020 2020 6964                id
+000228a0: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
+000228b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000228c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000228d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000228e0: 2020 7d20 656c 7365 2069 6620 2864 7374    } else if (dst
+000228f0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00022900: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
+00022910: 2020 2020 2020 2073 697a 655f 7420 6964         size_t id
+00022920: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+00022930: 2020 666c 6f61 7420 2a20 6473 745f 7074    float * dst_pt
+00022940: 7220 3d20 2866 6c6f 6174 202a 2920 6473  r = (float *) ds
+00022950: 742d 3e64 6174 613b 0a0a 2020 2020 2020  t->data;..      
+00022960: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00022970: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
+00022980: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
+00022990: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000229a0: 2028 696e 7420 6930 3220 3d20 303b 2069   (int i02 = 0; i
+000229b0: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+000229c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000229d0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000229e0: 2069 3031 203d 2030 3b20 6930 3120 3c20   i01 = 0; i01 < 
+000229f0: 6e65 3031 3b20 6930 312b 2b29 207b 0a20  ne01; i01++) {. 
+00022a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a10: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00022a20: 6930 3020 3d20 303b 2069 3030 203c 206e  i00 = 0; i00 < n
+00022a30: 6530 303b 2069 3030 2b2b 2920 7b0a 2020  e00; i00++) {.  
+00022a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a50: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00022a60: 6767 6d6c 5f66 7031 365f 7420 2a20 7372  ggml_fp16_t * sr
+00022a70: 6330 5f70 7472 203d 2028 6767 6d6c 5f66  c0_ptr = (ggml_f
+00022a80: 7031 365f 7420 2a29 2028 2863 6861 7220  p16_t *) ((char 
+00022a90: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00022aa0: 6930 302a 6e62 3030 202b 2069 3031 2a6e  i00*nb00 + i01*n
+00022ab0: 6230 3120 2b20 6930 322a 6e62 3032 202b  b01 + i02*nb02 +
+00022ac0: 2069 3033 2a6e 6230 3329 3b0a 0a20 2020   i03*nb03);..   
+00022ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ae0: 2020 2020 2020 2020 2064 7374 5f70 7472           dst_ptr
+00022af0: 5b69 645d 203d 2047 474d 4c5f 4650 3136  [id] = GGML_FP16
+00022b00: 5f54 4f5f 4650 3332 282a 7372 6330 5f70  _TO_FP32(*src0_p
+00022b10: 7472 293b 0a20 2020 2020 2020 2020 2020  tr);.           
+00022b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b30: 2069 642b 2b3b 0a20 2020 2020 2020 2020   id++;.         
+00022b40: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00022b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b60: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00022b70: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00022b80: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00022b90: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00022ba0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00022bb0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
+00022bc0: 2069 6d70 6c65 6d65 6e74 0a20 2020 2020   implement.     
+00022bd0: 2020 207d 0a20 2020 207d 2065 6c73 6520     }.    } else 
+00022be0: 7b0a 2020 2020 2020 2020 2f2f 7072 696e  {.        //prin
+00022bf0: 7466 2822 2573 3a20 7468 6973 2069 7320  tf("%s: this is 
+00022c00: 6e6f 7420 6f70 7469 6d61 6c20 2d20 6669  not optimal - fi
+00022c10: 7820 6d65 5c6e 222c 205f 5f66 756e 635f  x me\n", __func_
+00022c20: 5f29 3b0a 0a20 2020 2020 2020 2069 6620  _);..        if 
+00022c30: 2864 7374 2d3e 7479 7065 203d 3d20 4747  (dst->type == GG
+00022c40: 4d4c 5f54 5950 455f 4633 3229 207b 0a20  ML_TYPE_F32) {. 
+00022c50: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+00022c60: 7420 6964 203d 2030 3b0a 2020 2020 2020  t id = 0;.      
+00022c70: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+00022c80: 745f 7074 7220 3d20 2866 6c6f 6174 202a  t_ptr = (float *
+00022c90: 2920 6473 742d 3e64 6174 613b 0a0a 2020  ) dst->data;..  
+00022ca0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00022cb0: 6e74 2069 3033 203d 2030 3b20 6930 3320  nt i03 = 0; i03 
+00022cc0: 3c20 6e65 3033 3b20 6930 332b 2b29 207b  < ne03; i03++) {
+00022cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022ce0: 2066 6f72 2028 696e 7420 6930 3220 3d20   for (int i02 = 
+00022cf0: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
+00022d00: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
+00022d10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00022d20: 2869 6e74 2069 3031 203d 2030 3b20 6930  (int i01 = 0; i0
+00022d30: 3120 3c20 6e65 3031 3b20 6930 312b 2b29  1 < ne01; i01++)
+00022d40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00022d50: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00022d60: 696e 7420 6930 3020 3d20 303b 2069 3030  int i00 = 0; i00
+00022d70: 203c 206e 6530 303b 2069 3030 2b2b 2920   < ne00; i00++) 
+00022d80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00022d90: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00022da0: 6e73 7420 6767 6d6c 5f66 7031 365f 7420  nst ggml_fp16_t 
+00022db0: 2a20 7372 6330 5f70 7472 203d 2028 6767  * src0_ptr = (gg
+00022dc0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
+00022dd0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00022de0: 6120 2b20 6930 302a 6e62 3030 202b 2069  a + i00*nb00 + i
+00022df0: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
+00022e00: 3032 202b 2069 3033 2a6e 6230 3329 3b0a  02 + i03*nb03);.
+00022e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022e20: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+00022e30: 5f70 7472 5b69 645d 203d 2047 474d 4c5f  _ptr[id] = GGML_
+00022e40: 4650 3136 5f54 4f5f 4650 3332 282a 7372  FP16_TO_FP32(*sr
+00022e50: 6330 5f70 7472 293b 0a20 2020 2020 2020  c0_ptr);.       
+00022e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e70: 2020 2020 2069 642b 2b3b 0a20 2020 2020       id++;.     
+00022e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e90: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00022ea0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00022eb0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00022ec0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00022ed0: 2020 207d 2065 6c73 6520 6966 2028 6473     } else if (ds
+00022ee0: 742d 3e74 7970 6520 3d3d 2047 474d 4c5f  t->type == GGML_
+00022ef0: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
+00022f00: 2020 2020 2020 2020 7369 7a65 5f74 2069          size_t i
+00022f10: 6420 3d20 303b 0a20 2020 2020 2020 2020  d = 0;.         
+00022f20: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
+00022f30: 2064 7374 5f70 7472 203d 2028 6767 6d6c   dst_ptr = (ggml
+00022f40: 5f66 7031 365f 7420 2a29 2064 7374 2d3e  _fp16_t *) dst->
+00022f50: 6461 7461 3b0a 0a20 2020 2020 2020 2020  data;..         
+00022f60: 2020 2066 6f72 2028 696e 7420 6930 3320     for (int i03 
+00022f70: 3d20 303b 2069 3033 203c 206e 6530 333b  = 0; i03 < ne03;
+00022f80: 2069 3033 2b2b 2920 7b0a 2020 2020 2020   i03++) {.      
+00022f90: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00022fa0: 6e74 2069 3032 203d 2030 3b20 6930 3220  nt i02 = 0; i02 
+00022fb0: 3c20 6e65 3032 3b20 6930 322b 2b29 207b  < ne02; i02++) {
+00022fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022fd0: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00022fe0: 3120 3d20 303b 2069 3031 203c 206e 6530  1 = 0; i01 < ne0
+00022ff0: 313b 2069 3031 2b2b 2920 7b0a 2020 2020  1; i01++) {.    
+00023000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023010: 2020 2020 666f 7220 2869 6e74 2069 3030      for (int i00
+00023020: 203d 2030 3b20 6930 3020 3c20 6e65 3030   = 0; i00 < ne00
+00023030: 3b20 6930 302b 2b29 207b 0a20 2020 2020  ; i00++) {.     
 00023040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023050: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00023060: 7761 7264 5f73 7562 5f66 3332 2870 6172  ward_sub_f32(par
-00023070: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00023080: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00023090: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000230a0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-000230b0: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
-000230c0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-000230d0: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
-000230e0: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
-000230f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00023100: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
-00023110: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00023120: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
-00023130: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00023140: 4631 363a 0a20 2020 2020 2020 2063 6173  F16:.        cas
-00023150: 6520 4747 4d4c 5f54 5950 455f 434f 554e  e GGML_TYPE_COUN
-00023160: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-00023170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023180: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00023190: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-000231a0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-000231b0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-000231c0: 7465 5f66 6f72 7761 7264 5f6d 756c 0a0a  te_forward_mul..
-000231d0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000231e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000231f0: 5f6d 756c 5f66 3332 280a 2020 2020 2020  _mul_f32(.      
-00023200: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00023210: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00023220: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00023230: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00023240: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00023250: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00023260: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00023270: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00023280: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00023290: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000232a0: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
-000232b0: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
-000232c0: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
-000232d0: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
-000232e0: 7372 6330 2c20 7372 6331 2920 2626 2067  src0, src1) && g
-000232f0: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-00023300: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
-00023310: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00023320: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00023330: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00023340: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00023350: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00023360: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00023370: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-00023380: 7420 696e 7420 6e20 203d 2067 676d 6c5f  t int n  = ggml_
-00023390: 6e72 6f77 7328 7372 6330 293b 0a20 2020  nrows(src0);.   
-000233a0: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-000233b0: 7372 6330 2d3e 6e65 5b30 5d3b 0a0a 2020  src0->ne[0];..  
-000233c0: 2020 6173 7365 7274 2820 6473 742d 3e6e    assert( dst->n
-000233d0: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
-000233e0: 6c6f 6174 2929 3b0a 2020 2020 6173 7365  loat));.    asse
-000233f0: 7274 2873 7263 302d 3e6e 625b 305d 203d  rt(src0->nb[0] =
-00023400: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00023410: 3b0a 2020 2020 6173 7365 7274 2873 7263  ;.    assert(src
-00023420: 312d 3e6e 625b 305d 203d 3d20 7369 7a65  1->nb[0] == size
-00023430: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-00023440: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00023450: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
-00023460: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00023470: 6d75 6c5f 6633 3228 6e63 2c0a 2020 2020  mul_f32(nc,.    
-00023480: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-00023490: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-000234a0: 6473 742d 3e64 6174 6120 202b 2069 2a28  dst->data  + i*(
-000234b0: 2064 7374 2d3e 6e62 5b31 5d29 292c 0a20   dst->nb[1])),. 
-000234c0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000234d0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-000234e0: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-000234f0: 692a 2873 7263 302d 3e6e 625b 315d 2929  i*(src0->nb[1]))
-00023500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023510: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00023520: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
-00023530: 202b 2069 2a28 7372 6331 2d3e 6e62 5b31   + i*(src1->nb[1
-00023540: 5d29 2929 3b0a 2020 2020 7d0a 7d0a 0a73  ])));.    }.}..s
-00023550: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00023560: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00023570: 6d75 6c28 0a20 2020 2020 2020 2063 6f6e  mul(.        con
-00023580: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00023590: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000235a0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000235b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000235c0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-000235d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000235e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000235f0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00023600: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00023610: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00023620: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-00023630: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00023640: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00023650: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-00023660: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00023670: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00023680: 6f72 7761 7264 5f6d 756c 5f66 3332 2870  orward_mul_f32(p
-00023690: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
-000236a0: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
-000236b0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000236c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000236d0: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
-000236e0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000236f0: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
-00023700: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-00023710: 383a 0a20 2020 2020 2020 2063 6173 6520  8:.        case 
-00023720: 4747 4d4c 5f54 5950 455f 4931 363a 0a20  GGML_TYPE_I16:. 
-00023730: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00023740: 5f54 5950 455f 4933 323a 0a20 2020 2020  _TYPE_I32:.     
-00023750: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00023760: 455f 4631 363a 0a20 2020 2020 2020 2063  E_F16:.        c
-00023770: 6173 6520 4747 4d4c 5f54 5950 455f 434f  ase GGML_TYPE_CO
-00023780: 554e 543a 0a20 2020 2020 2020 2020 2020  UNT:.           
-00023790: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000237a0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-000237b0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-000237c0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000237d0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-000237e0: 7075 7465 5f66 6f72 7761 7264 5f64 6976  pute_forward_div
-000237f0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00023800: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00023810: 7264 5f64 6976 5f66 3332 280a 2020 2020  rd_div_f32(.    
-00023820: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00023830: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00023840: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00023850: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00023860: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00023870: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00023880: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00023890: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-000238a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000238b0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-000238c0: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-000238d0: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
-000238e0: 293b 0a20 2020 2061 7373 6572 7428 6767  );.    assert(gg
-000238f0: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00023900: 6528 7372 6330 2c20 7372 6331 2920 2626  e(src0, src1) &&
-00023910: 2067 676d 6c5f 6172 655f 7361 6d65 5f73   ggml_are_same_s
-00023920: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
-00023930: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-00023940: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00023950: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-00023960: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00023970: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-00023980: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-00023990: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-000239a0: 6e73 7420 696e 7420 6e20 203d 2067 676d  nst int n  = ggm
-000239b0: 6c5f 6e72 6f77 7328 7372 6330 293b 0a20  l_nrows(src0);. 
-000239c0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
-000239d0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a0a  = src0->ne[0];..
-000239e0: 2020 2020 6173 7365 7274 2820 6473 742d      assert( dst-
-000239f0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00023a00: 2866 6c6f 6174 2929 3b0a 2020 2020 6173  (float));.    as
-00023a10: 7365 7274 2873 7263 302d 3e6e 625b 305d  sert(src0->nb[0]
-00023a20: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00023a30: 2929 3b0a 2020 2020 6173 7365 7274 2873  ));.    assert(s
-00023a40: 7263 312d 3e6e 625b 305d 203d 3d20 7369  rc1->nb[0] == si
-00023a50: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-00023a60: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00023a70: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
-00023a80: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00023a90: 635f 6469 765f 6633 3228 6e63 2c0a 2020  c_div_f32(nc,.  
-00023aa0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-00023ab0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-00023ac0: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
-00023ad0: 2a28 2064 7374 2d3e 6e62 5b31 5d29 292c  *( dst->nb[1])),
-00023ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023af0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00023b00: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00023b10: 2b20 692a 2873 7263 302d 3e6e 625b 315d  + i*(src0->nb[1]
-00023b20: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00023b30: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00023b40: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
-00023b50: 7461 202b 2069 2a28 7372 6331 2d3e 6e62  ta + i*(src1->nb
-00023b60: 5b31 5d29 2929 3b0a 2020 2020 7d0a 7d0a  [1])));.    }.}.
-00023b70: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00023b80: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00023b90: 645f 6469 7628 0a20 2020 2020 2020 2063  d_div(.        c
-00023ba0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00023bb0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00023bc0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00023bd0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00023be0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00023bf0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00023c00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00023c10: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00023c20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00023c30: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00023c40: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-00023c50: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00023c60: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00023c70: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00023c80: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00023c90: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00023ca0: 5f66 6f72 7761 7264 5f64 6976 5f66 3332  _forward_div_f32
-00023cb0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-00023cc0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-00023cd0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00023ce0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00023cf0: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
-00023d00: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00023d10: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
-00023d20: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00023d30: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
-00023d40: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
-00023d50: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00023d60: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
-00023d70: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00023d80: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
-00023d90: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00023da0: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
-00023db0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00023dc0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00023dd0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00023de0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00023df0: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00023e00: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00023e10: 7172 0a0a 7374 6174 6963 2076 6f69 6420  qr..static void 
-00023e20: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00023e30: 7761 7264 5f73 7172 5f66 3332 280a 2020  ward_sqr_f32(.  
-00023e40: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00023e50: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00023e60: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00023e70: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00023e80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00023e90: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00023ea0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00023eb0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00023ec0: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
-00023ed0: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
-00023ee0: 6173 7365 7274 2867 676d 6c5f 6172 655f  assert(ggml_are_
-00023ef0: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-00023f00: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
-00023f10: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00023f20: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00023f30: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00023f40: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00023f50: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00023f60: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00023f70: 2020 2020 636f 6e73 7420 696e 7420 6e20      const int n 
-00023f80: 2020 2020 3d20 6767 6d6c 5f6e 726f 7773      = ggml_nrows
-00023f90: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
-00023fa0: 7420 696e 7420 6e63 2020 2020 3d20 7372  t int nc    = sr
-00023fb0: 6330 2d3e 6e65 5b30 5d3b 0a0a 2020 2020  c0->ne[0];..    
-00023fc0: 6173 7365 7274 2820 6473 742d 3e6e 625b  assert( dst->nb[
-00023fd0: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
-00023fe0: 6174 2929 3b0a 2020 2020 6173 7365 7274  at));.    assert
-00023ff0: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
-00024000: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00024010: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-00024020: 3d20 303b 2069 203c 206e 3b20 692b 2b29  = 0; i < n; i++)
-00024030: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
-00024040: 7665 635f 7371 725f 6633 3228 6e63 2c0a  vec_sqr_f32(nc,.
-00024050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024060: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00024070: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
-00024080: 2069 2a28 2064 7374 2d3e 6e62 5b31 5d29   i*( dst->nb[1])
-00024090: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000240a0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-000240b0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-000240c0: 6120 2b20 692a 2873 7263 302d 3e6e 625b  a + i*(src0->nb[
-000240d0: 315d 2929 293b 0a20 2020 207d 0a7d 0a0a  1])));.    }.}..
-000240e0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000240f0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00024100: 5f73 7172 280a 2020 2020 2020 2020 636f  _sqr(.        co
-00024110: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00024120: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00024130: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00024140: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00024150: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00024160: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00024170: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00024180: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
-00024190: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
-000241a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000241b0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-000241c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000241d0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-000241e0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-000241f0: 7172 5f66 3332 2870 6172 616d 732c 2073  qr_f32(params, s
-00024200: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
-00024210: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00024220: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00024230: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
-00024240: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00024250: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
-00024260: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00024270: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
-00024280: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
+00023050: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
+00023060: 6c5f 6670 3136 5f74 202a 2073 7263 305f  l_fp16_t * src0_
+00023070: 7074 7220 3d20 2867 676d 6c5f 6670 3136  ptr = (ggml_fp16
+00023080: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+00023090: 7372 6330 2d3e 6461 7461 202b 2069 3030  src0->data + i00
+000230a0: 2a6e 6230 3020 2b20 6930 312a 6e62 3031  *nb00 + i01*nb01
+000230b0: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
+000230c0: 332a 6e62 3033 293b 0a0a 2020 2020 2020  3*nb03);..      
+000230d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230e0: 2020 2020 2020 6473 745f 7074 725b 6964        dst_ptr[id
+000230f0: 5d20 3d20 2a73 7263 305f 7074 723b 0a20  ] = *src0_ptr;. 
+00023100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023110: 2020 2020 2020 2020 2020 2069 642b 2b3b             id++;
+00023120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023130: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00023140: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00023150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023160: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00023170: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
+00023180: 7b0a 2020 2020 2020 2020 2020 2020 4747  {.            GG
+00023190: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+000231a0: 3b20 2f2f 2054 4f44 4f3a 2069 6d70 6c65  ; // TODO: imple
+000231b0: 6d65 6e74 0a20 2020 2020 2020 207d 0a20  ment.        }. 
+000231c0: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+000231d0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+000231e0: 5f66 6f72 7761 7264 5f64 7570 5f66 3332  _forward_dup_f32
+000231f0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00023200: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00023210: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00023220: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00023230: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00023240: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00023250: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00023260: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00023270: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+00023280: 5428 7061 7261 6d73 2d3e 6974 6820 3d3d  T(params->ith ==
+00023290: 2030 293b 0a20 2020 2047 474d 4c5f 4153   0);.    GGML_AS
+000232a0: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+000232b0: 7469 6775 6f75 7328 6473 7429 293b 0a20  tiguous(dst));. 
+000232c0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+000232d0: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6473  gml_nelements(ds
+000232e0: 7429 203d 3d20 6767 6d6c 5f6e 656c 656d  t) == ggml_nelem
+000232f0: 656e 7473 2873 7263 3029 293b 0a0a 2020  ents(src0));..  
+00023300: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00023310: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00023320: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+00023330: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00023340: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+00023350: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+00023360: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+00023370: 6e74 206e 6530 3020 3d20 7372 6330 2d3e  nt ne00 = src0->
+00023380: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00023390: 2069 6e74 206e 6530 3120 3d20 7372 6330   int ne01 = src0
+000233a0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+000233b0: 7374 2069 6e74 206e 6530 3220 3d20 7372  st int ne02 = sr
+000233c0: 6330 2d3e 6e65 5b32 5d3b 0a20 2020 2063  c0->ne[2];.    c
+000233d0: 6f6e 7374 2069 6e74 206e 6530 3320 3d20  onst int ne03 = 
+000233e0: 7372 6330 2d3e 6e65 5b33 5d3b 0a0a 2020  src0->ne[3];..  
+000233f0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00023400: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
+00023410: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+00023420: 655f 7420 6e62 3031 203d 2073 7263 302d  e_t nb01 = src0-
+00023430: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00023440: 7420 7369 7a65 5f74 206e 6230 3220 3d20  t size_t nb02 = 
+00023450: 7372 6330 2d3e 6e62 5b32 5d3b 0a20 2020  src0->nb[2];.   
+00023460: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00023470: 3033 203d 2073 7263 302d 3e6e 625b 335d  03 = src0->nb[3]
+00023480: 3b0a 0a20 2020 2069 6620 2867 676d 6c5f  ;..    if (ggml_
+00023490: 6973 5f63 6f6e 7469 6775 6f75 7328 7372  is_contiguous(sr
+000234a0: 6330 2920 2626 2073 7263 302d 3e74 7970  c0) && src0->typ
+000234b0: 6520 3d3d 2064 7374 2d3e 7479 7065 2920  e == dst->type) 
+000234c0: 7b0a 2020 2020 2020 2020 6d65 6d63 7079  {.        memcpy
+000234d0: 2864 7374 2d3e 6461 7461 2c20 7372 6330  (dst->data, src0
+000234e0: 2d3e 6461 7461 2c20 6767 6d6c 5f6e 656c  ->data, ggml_nel
+000234f0: 656d 656e 7473 2864 7374 2920 2a20 4747  ements(dst) * GG
+00023500: 4d4c 5f54 5950 455f 5349 5a45 5b73 7263  ML_TYPE_SIZE[src
+00023510: 302d 3e74 7970 655d 293b 0a20 2020 2020  0->type]);.     
+00023520: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00023530: 0a0a 2020 2020 6966 2028 7372 6330 2d3e  ..    if (src0->
+00023540: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+00023550: 666c 6f61 7429 2920 7b0a 2020 2020 2020  float)) {.      
+00023560: 2020 6966 2028 6473 742d 3e74 7970 6520    if (dst->type 
+00023570: 3d3d 2047 474d 4c5f 5459 5045 5f46 3332  == GGML_TYPE_F32
+00023580: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00023590: 7369 7a65 5f74 2069 6420 3d20 303b 0a20  size_t id = 0;. 
+000235a0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000235b0: 2073 697a 655f 7420 7273 203d 206e 6530   size_t rs = ne0
+000235c0: 302a 6e62 3030 3b0a 0a20 2020 2020 2020  0*nb00;..       
+000235d0: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+000235e0: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
+000235f0: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
+00023600: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00023610: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
+00023620: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
+00023630: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00023640: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00023650: 6930 3120 3d20 303b 2069 3031 203c 206e  i01 = 0; i01 < n
+00023660: 6530 313b 2069 3031 2b2b 2920 7b0a 2020  e01; i01++) {.  
+00023670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023680: 2020 2020 2020 636f 6e73 7420 6368 6172        const char
+00023690: 202a 2073 7263 305f 7074 7220 3d20 2863   * src0_ptr = (c
+000236a0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+000236b0: 6120 2b20 6930 312a 6e62 3031 202b 2069  a + i01*nb01 + i
+000236c0: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
+000236d0: 3033 3b0a 2020 2020 2020 2020 2020 2020  03;.            
+000236e0: 2020 2020 2020 2020 2020 2020 6368 6172              char
+000236f0: 202a 2064 7374 5f70 7472 203d 2028 6368   * dst_ptr = (ch
+00023700: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00023710: 2b20 6964 2a72 733b 0a0a 2020 2020 2020  + id*rs;..      
+00023720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023730: 2020 6d65 6d63 7079 2864 7374 5f70 7472    memcpy(dst_ptr
+00023740: 2c20 7372 6330 5f70 7472 2c20 7273 293b  , src0_ptr, rs);
+00023750: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00023760: 2020 2020 2020 2020 2020 6964 2b2b 3b0a            id++;.
+00023770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023780: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00023790: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000237a0: 2020 2020 7d0a 2020 2020 2020 2020 7d20      }.        } 
+000237b0: 656c 7365 2069 6620 2864 7374 2d3e 7479  else if (dst->ty
+000237c0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+000237d0: 4631 3629 207b 0a20 2020 2020 2020 2020  F16) {.         
+000237e0: 2020 2073 697a 655f 7420 6964 203d 2030     size_t id = 0
+000237f0: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
+00023800: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
+00023810: 7074 7220 3d20 2867 676d 6c5f 6670 3136  ptr = (ggml_fp16
+00023820: 5f74 202a 2920 6473 742d 3e64 6174 613b  _t *) dst->data;
+00023830: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00023840: 7220 2869 6e74 2069 3033 203d 2030 3b20  r (int i03 = 0; 
+00023850: 6930 3320 3c20 6e65 3033 3b20 6930 332b  i03 < ne03; i03+
+00023860: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00023870: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00023880: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+00023890: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
+000238a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000238b0: 666f 7220 2869 6e74 2069 3031 203d 2030  for (int i01 = 0
+000238c0: 3b20 6930 3120 3c20 6e65 3031 3b20 6930  ; i01 < ne01; i0
+000238d0: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+000238e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000238f0: 6f72 2028 696e 7420 6930 3020 3d20 303b  or (int i00 = 0;
+00023900: 2069 3030 203c 206e 6530 303b 2069 3030   i00 < ne00; i00
+00023910: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00023920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023930: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
+00023940: 7372 6330 5f70 7472 203d 2028 666c 6f61  src0_ptr = (floa
+00023950: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+00023960: 7263 302d 3e64 6174 6120 2b20 6930 302a  rc0->data + i00*
+00023970: 6e62 3030 202b 2069 3031 2a6e 6230 3120  nb00 + i01*nb01 
+00023980: 2b20 6930 322a 6e62 3032 202b 2069 3033  + i02*nb02 + i03
+00023990: 2a6e 6230 3329 3b0a 0a20 2020 2020 2020  *nb03);..       
+000239a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000239b0: 2020 2020 2064 7374 5f70 7472 5b69 645d       dst_ptr[id]
+000239c0: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
+000239d0: 4650 3136 282a 7372 6330 5f70 7472 293b  FP16(*src0_ptr);
+000239e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000239f0: 2020 2020 2020 2020 2020 2020 2069 642b               id+
+00023a00: 2b3b 0a20 2020 2020 2020 2020 2020 2020  +;.             
+00023a10: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00023a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a30: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00023a40: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00023a50: 207d 0a20 2020 2020 2020 207d 2065 6c73   }.        } els
+00023a60: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+00023a70: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00023a80: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
+00023a90: 6c65 6d65 6e74 0a20 2020 2020 2020 207d  lement.        }
+00023aa0: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
+00023ab0: 2020 2020 2020 2f2f 7072 696e 7466 2822        //printf("
+00023ac0: 2573 3a20 7468 6973 2069 7320 6e6f 7420  %s: this is not 
+00023ad0: 6f70 7469 6d61 6c20 2d20 6669 7820 6d65  optimal - fix me
+00023ae0: 5c6e 222c 205f 5f66 756e 635f 5f29 3b0a  \n", __func__);.
+00023af0: 0a20 2020 2020 2020 2069 6620 2864 7374  .        if (dst
+00023b00: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00023b10: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
+00023b20: 2020 2020 2020 2073 697a 655f 7420 6964         size_t id
+00023b30: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+00023b40: 2020 666c 6f61 7420 2a20 6473 745f 7074    float * dst_pt
+00023b50: 7220 3d20 2866 6c6f 6174 202a 2920 6473  r = (float *) ds
+00023b60: 742d 3e64 6174 613b 0a0a 2020 2020 2020  t->data;..      
+00023b70: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00023b80: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
+00023b90: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
+00023ba0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00023bb0: 2028 696e 7420 6930 3220 3d20 303b 2069   (int i02 = 0; i
+00023bc0: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+00023bd0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00023be0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00023bf0: 2069 3031 203d 2030 3b20 6930 3120 3c20   i01 = 0; i01 < 
+00023c00: 6e65 3031 3b20 6930 312b 2b29 207b 0a20  ne01; i01++) {. 
+00023c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c20: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00023c30: 6930 3020 3d20 303b 2069 3030 203c 206e  i00 = 0; i00 < n
+00023c40: 6530 303b 2069 3030 2b2b 2920 7b0a 2020  e00; i00++) {.  
+00023c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c60: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00023c70: 666c 6f61 7420 2a20 7372 6330 5f70 7472  float * src0_ptr
+00023c80: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
+00023c90: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00023ca0: 6120 2b20 6930 302a 6e62 3030 202b 2069  a + i00*nb00 + i
+00023cb0: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
+00023cc0: 3032 202b 2069 3033 2a6e 6230 3329 3b0a  02 + i03*nb03);.
+00023cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ce0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+00023cf0: 5f70 7472 5b69 645d 203d 202a 7372 6330  _ptr[id] = *src0
+00023d00: 5f70 7472 3b0a 2020 2020 2020 2020 2020  _ptr;.          
+00023d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d20: 2020 6964 2b2b 3b0a 2020 2020 2020 2020    id++;.        
+00023d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d40: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00023d50: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00023d60: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00023d70: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00023d80: 7d20 656c 7365 2069 6620 2864 7374 2d3e  } else if (dst->
+00023d90: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00023da0: 455f 4631 3629 207b 0a20 2020 2020 2020  E_F16) {.       
+00023db0: 2020 2020 2073 697a 655f 7420 6964 203d       size_t id =
+00023dc0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00023dd0: 6767 6d6c 5f66 7031 365f 7420 2a20 6473  ggml_fp16_t * ds
+00023de0: 745f 7074 7220 3d20 2867 676d 6c5f 6670  t_ptr = (ggml_fp
+00023df0: 3136 5f74 202a 2920 6473 742d 3e64 6174  16_t *) dst->dat
+00023e00: 613b 0a0a 2020 2020 2020 2020 2020 2020  a;..            
+00023e10: 666f 7220 2869 6e74 2069 3033 203d 2030  for (int i03 = 0
+00023e20: 3b20 6930 3320 3c20 6e65 3033 3b20 6930  ; i03 < ne03; i0
+00023e30: 332b 2b29 207b 0a20 2020 2020 2020 2020  3++) {.         
+00023e40: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00023e50: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
+00023e60: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
+00023e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e80: 2020 666f 7220 2869 6e74 2069 3031 203d    for (int i01 =
+00023e90: 2030 3b20 6930 3120 3c20 6e65 3031 3b20   0; i01 < ne01; 
+00023ea0: 6930 312b 2b29 207b 0a20 2020 2020 2020  i01++) {.       
+00023eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ec0: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
+00023ed0: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
+00023ee0: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
+00023ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f00: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00023f10: 2a20 7372 6330 5f70 7472 203d 2028 666c  * src0_ptr = (fl
+00023f20: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+00023f30: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
+00023f40: 302a 6e62 3030 202b 2069 3031 2a6e 6230  0*nb00 + i01*nb0
+00023f50: 3120 2b20 6930 322a 6e62 3032 202b 2069  1 + i02*nb02 + i
+00023f60: 3033 2a6e 6230 3329 3b0a 0a20 2020 2020  03*nb03);..     
+00023f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f80: 2020 2020 2020 2064 7374 5f70 7472 5b69         dst_ptr[i
+00023f90: 645d 203d 2047 474d 4c5f 4650 3332 5f54  d] = GGML_FP32_T
+00023fa0: 4f5f 4650 3136 282a 7372 6330 5f70 7472  O_FP16(*src0_ptr
+00023fb0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00023fc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00023fd0: 642b 2b3b 0a20 2020 2020 2020 2020 2020  d++;.           
+00023fe0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00023ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024000: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00024010: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00024020: 2020 207d 0a20 2020 2020 2020 207d 2065     }.        } e
+00024030: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+00024040: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00024050: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 2069  lse); // TODO: i
+00024060: 6d70 6c65 6d65 6e74 0a20 2020 2020 2020  mplement.       
+00024070: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
+00024080: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00024090: 7075 7465 5f66 6f72 7761 7264 5f64 7570  pute_forward_dup
+000240a0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+000240b0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+000240c0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+000240d0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+000240e0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000240f0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00024100: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00024110: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00024120: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+00024130: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+00024140: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00024150: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
+00024160: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00024170: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00024180: 7465 5f66 6f72 7761 7264 5f64 7570 5f66  te_forward_dup_f
+00024190: 3136 2870 6172 616d 732c 2073 7263 302c  16(params, src0,
+000241a0: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+000241b0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000241c0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+000241d0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+000241e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000241f0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00024200: 7465 5f66 6f72 7761 7264 5f64 7570 5f66  te_forward_dup_f
+00024210: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
+00024220: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00024230: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00024240: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00024250: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
+00024260: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00024270: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
+00024280: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
 00024290: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000242a0: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
+000242a0: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
 000242b0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-000242c0: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+000242c0: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
 000242d0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
 000242e0: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
 000242f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
 00024300: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
 00024310: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
 00024320: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
 00024330: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00024340: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00024350: 7172 740a 0a73 7461 7469 6320 766f 6964  qrt..static void
-00024360: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00024370: 7277 6172 645f 7371 7274 5f66 3332 280a  rward_sqrt_f32(.
-00024380: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00024390: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000243a0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-000243b0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-000243c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000243d0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-000243e0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000243f0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00024400: 2020 2020 6173 7365 7274 2870 6172 616d      assert(param
-00024410: 732d 3e69 7468 203d 3d20 3029 3b0a 2020  s->ith == 0);.  
-00024420: 2020 6173 7365 7274 2867 676d 6c5f 6172    assert(ggml_ar
-00024430: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
-00024440: 302c 2064 7374 2929 3b0a 0a20 2020 2069  0, dst));..    i
-00024450: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00024460: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00024470: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-00024480: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00024490: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-000244a0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-000244b0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-000244c0: 6e20 203d 2067 676d 6c5f 6e72 6f77 7328  n  = ggml_nrows(
-000244d0: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
-000244e0: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
-000244f0: 6e65 5b30 5d3b 0a0a 2020 2020 6173 7365  ne[0];..    asse
-00024500: 7274 2820 6473 742d 3e6e 625b 305d 203d  rt( dst->nb[0] =
-00024510: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00024520: 3b0a 2020 2020 6173 7365 7274 2873 7263  ;.    assert(src
-00024530: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
-00024540: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-00024550: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00024560: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
-00024570: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00024580: 7371 7274 5f66 3332 286e 632c 0a20 2020  sqrt_f32(nc,.   
-00024590: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-000245a0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-000245b0: 2064 7374 2d3e 6461 7461 2020 2b20 692a   dst->data  + i*
-000245c0: 2820 6473 742d 3e6e 625b 315d 2929 2c0a  ( dst->nb[1])),.
-000245d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245e0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-000245f0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-00024600: 2069 2a28 7372 6330 2d3e 6e62 5b31 5d29   i*(src0->nb[1])
-00024610: 2929 3b0a 2020 2020 7d0a 7d0a 0a73 7461  ));.    }.}..sta
-00024620: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00024630: 6d70 7574 655f 666f 7277 6172 645f 7371  mpute_forward_sq
-00024640: 7274 280a 2020 2020 2020 2020 636f 6e73  rt(.        cons
-00024650: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00024660: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00024670: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00024680: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00024690: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-000246a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000246b0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-000246c0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-000246d0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-000246e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000246f0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00024700: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00024710: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00024720: 7075 7465 5f66 6f72 7761 7264 5f73 7172  pute_forward_sqr
-00024730: 745f 6633 3228 7061 7261 6d73 2c20 7372  t_f32(params, sr
-00024740: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
-00024750: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00024760: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00024770: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
-00024780: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00024790: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
-000247a0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-000247b0: 4938 3a0a 2020 2020 2020 2020 6361 7365  I8:.        case
-000247c0: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
-000247d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000247e0: 4c5f 5459 5045 5f49 3332 3a0a 2020 2020  L_TYPE_I32:.    
-000247f0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00024800: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
-00024810: 6361 7365 2047 474d 4c5f 5459 5045 5f43  case GGML_TYPE_C
-00024820: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
-00024830: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00024840: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00024850: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00024860: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00024870: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
-00024880: 6d70 7574 655f 666f 7277 6172 645f 7375  mpute_forward_su
-00024890: 6d0a 0a73 7461 7469 6320 766f 6964 2067  m..static void g
-000248a0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000248b0: 6172 645f 7375 6d5f 6633 3228 0a20 2020  ard_sum_f32(.   
-000248c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000248d0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-000248e0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-000248f0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00024900: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00024910: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00024920: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00024930: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00024940: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
-00024950: 6974 6820 3d3d 2030 293b 0a20 2020 2061  ith == 0);.    a
-00024960: 7373 6572 7428 6767 6d6c 5f69 735f 7363  ssert(ggml_is_sc
-00024970: 616c 6172 2864 7374 2929 3b0a 0a20 2020  alar(dst));..   
-00024980: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00024990: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-000249a0: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-000249b0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-000249c0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-000249d0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-000249e0: 207d 0a0a 2020 2020 6173 7365 7274 2867   }..    assert(g
-000249f0: 676d 6c5f 6973 5f73 6361 6c61 7228 6473  gml_is_scalar(ds
-00024a00: 7429 293b 0a20 2020 2061 7373 6572 7428  t));.    assert(
-00024a10: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
-00024a20: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-00024a30: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-00024a40: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
-00024a50: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00024a60: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
-00024a70: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00024a80: 7420 6e65 3032 203d 2073 7263 302d 3e6e  t ne02 = src0->n
-00024a90: 655b 325d 3b0a 2020 2020 636f 6e73 7420  e[2];.    const 
-00024aa0: 696e 7420 6e65 3033 203d 2073 7263 302d  int ne03 = src0-
-00024ab0: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
-00024ac0: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
-00024ad0: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
-00024ae0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00024af0: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
-00024b00: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-00024b10: 655f 7420 6e62 3033 203d 2073 7263 302d  e_t nb03 = src0-
-00024b20: 3e6e 625b 335d 3b0a 0a20 2020 2066 6f72  >nb[3];..    for
-00024b30: 2028 696e 7420 6930 3320 3d20 303b 2069   (int i03 = 0; i
-00024b40: 3033 203c 206e 6530 333b 2069 3033 2b2b  03 < ne03; i03++
-00024b50: 2920 7b0a 2020 2020 2020 2020 666f 7220  ) {.        for 
-00024b60: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
-00024b70: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
-00024b80: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-00024b90: 6f72 2028 696e 7420 6930 3120 3d20 303b  or (int i01 = 0;
-00024ba0: 2069 3031 203c 206e 6530 313b 2069 3031   i01 < ne01; i01
-00024bb0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00024bc0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-00024bd0: 756d 5f66 3332 286e 6530 302c 0a20 2020  um_f32(ne00,.   
-00024be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024bf0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-00024c00: 6473 742d 3e64 6174 6129 2c0a 2020 2020  dst->data),.    
-00024c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c20: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00024c30: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00024c40: 7461 202b 2069 3031 2a6e 6230 3120 2b20  ta + i01*nb01 + 
-00024c50: 6930 322a 6e62 3032 202b 2069 3033 2a6e  i02*nb02 + i03*n
-00024c60: 6230 3329 293b 0a20 2020 2020 2020 2020  b03));.         
-00024c70: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-00024c80: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-00024c90: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00024ca0: 5f66 6f72 7761 7264 5f73 756d 280a 2020  _forward_sum(.  
-00024cb0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00024cc0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00024cd0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00024ce0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00024cf0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00024d00: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00024d10: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00024d20: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00024d30: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-00024d40: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00024d50: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00024d60: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-00024d70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00024d80: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00024d90: 6f72 7761 7264 5f73 756d 5f66 3332 2870  orward_sum_f32(p
-00024da0: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
-00024db0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00024dc0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00024dd0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00024de0: 345f 303a 0a20 2020 2020 2020 2063 6173  4_0:.        cas
-00024df0: 6520 4747 4d4c 5f54 5950 455f 5134 5f31  e GGML_TYPE_Q4_1
-00024e00: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00024e10: 474d 4c5f 5459 5045 5f49 383a 0a20 2020  GML_TYPE_I8:.   
-00024e20: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00024e30: 5950 455f 4931 363a 0a20 2020 2020 2020  YPE_I16:.       
-00024e40: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00024e50: 4933 323a 0a20 2020 2020 2020 2063 6173  I32:.        cas
-00024e60: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
-00024e70: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00024e80: 4d4c 5f54 5950 455f 434f 554e 543a 0a20  ML_TYPE_COUNT:. 
-00024e90: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00024ea0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00024eb0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00024ec0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00024ed0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
-00024ee0: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00024ef0: 6f72 7761 7264 5f6d 6561 6e0a 0a73 7461  orward_mean..sta
-00024f00: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00024f10: 6d70 7574 655f 666f 7277 6172 645f 6d65  mpute_forward_me
-00024f20: 616e 5f66 3332 280a 2020 2020 2020 2020  an_f32(.        
-00024f30: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00024f40: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00024f50: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00024f60: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00024f70: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00024f80: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
-00024f90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00024fa0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
-00024fb0: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
-00024fc0: 3d20 3029 3b0a 0a20 2020 2069 6620 2870  = 0);..    if (p
-00024fd0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00024fe0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
-00024ff0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
-00025000: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-00025010: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-00025020: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00025030: 2020 6173 7365 7274 2873 7263 302d 3e6e    assert(src0->n
-00025040: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
-00025050: 6c6f 6174 2929 3b0a 0a20 2020 2063 6f6e  loat));..    con
-00025060: 7374 2069 6e74 206e 6530 3020 3d20 7372  st int ne00 = sr
-00025070: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-00025080: 6f6e 7374 2069 6e74 206e 6530 3120 3d20  onst int ne01 = 
-00025090: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
-000250a0: 2063 6f6e 7374 2069 6e74 206e 6530 3220   const int ne02 
-000250b0: 3d20 7372 6330 2d3e 6e65 5b32 5d3b 0a20  = src0->ne[2];. 
-000250c0: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
-000250d0: 3320 3d20 7372 6330 2d3e 6e65 5b33 5d3b  3 = src0->ne[3];
-000250e0: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
-000250f0: 5f74 206e 6230 3120 3d20 7372 6330 2d3e  _t nb01 = src0->
-00025100: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00025110: 2073 697a 655f 7420 6e62 3032 203d 2073   size_t nb02 = s
-00025120: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
-00025130: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-00025140: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
-00025150: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00025160: 6e65 3020 3d20 6473 742d 3e6e 655b 305d  ne0 = dst->ne[0]
-00025170: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00025180: 6e65 3120 3d20 6473 742d 3e6e 655b 315d  ne1 = dst->ne[1]
-00025190: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000251a0: 6e65 3220 3d20 6473 742d 3e6e 655b 325d  ne2 = dst->ne[2]
-000251b0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000251c0: 6e65 3320 3d20 6473 742d 3e6e 655b 335d  ne3 = dst->ne[3]
-000251d0: 3b0a 0a20 2020 2061 7373 6572 7428 6e65  ;..    assert(ne
-000251e0: 3020 3d3d 2031 293b 0a20 2020 2061 7373  0 == 1);.    ass
-000251f0: 6572 7428 6e65 3120 3d3d 206e 6530 3129  ert(ne1 == ne01)
-00025200: 3b0a 2020 2020 6173 7365 7274 286e 6532  ;.    assert(ne2
-00025210: 203d 3d20 6e65 3032 293b 0a20 2020 2061   == ne02);.    a
-00025220: 7373 6572 7428 6e65 3320 3d3d 206e 6530  ssert(ne3 == ne0
-00025230: 3329 3b0a 0a20 2020 2055 4e55 5345 4428  3);..    UNUSED(
-00025240: 6e65 3029 3b0a 2020 2020 554e 5553 4544  ne0);.    UNUSED
-00025250: 286e 6531 293b 0a20 2020 2055 4e55 5345  (ne1);.    UNUSE
-00025260: 4428 6e65 3229 3b0a 2020 2020 554e 5553  D(ne2);.    UNUS
-00025270: 4544 286e 6533 293b 0a0a 2020 2020 636f  ED(ne3);..    co
-00025280: 6e73 7420 7369 7a65 5f74 206e 6231 203d  nst size_t nb1 =
-00025290: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
-000252a0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-000252b0: 3220 3d20 6473 742d 3e6e 625b 325d 3b0a  2 = dst->nb[2];.
-000252c0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-000252d0: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
-000252e0: 5d3b 0a0a 2020 2020 666f 7220 2869 6e74  ];..    for (int
-000252f0: 2069 3033 203d 2030 3b20 6930 3320 3c20   i03 = 0; i03 < 
-00025300: 6e65 3033 3b20 6930 332b 2b29 207b 0a20  ne03; i03++) {. 
-00025310: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00025320: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
-00025330: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
-00025340: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00025350: 6e74 2069 3031 203d 2030 3b20 6930 3120  nt i01 = 0; i01 
-00025360: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
-00025370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025380: 2067 676d 6c5f 7665 635f 7375 6d5f 6633   ggml_vec_sum_f3
-00025390: 3228 6e65 3030 2c0a 2020 2020 2020 2020  2(ne00,.        
-000253a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253b0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-000253c0: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
-000253d0: 2069 3031 2a6e 6231 2020 2b20 6930 322a   i01*nb1  + i02*
-000253e0: 6e62 3220 202b 2069 3033 2a6e 6233 292c  nb2  + i03*nb3),
-000253f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025400: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00025410: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-00025420: 302d 3e64 6174 6120 2b20 6930 312a 6e62  0->data + i01*nb
-00025430: 3031 202b 2069 3032 2a6e 6230 3220 2b20  01 + i02*nb02 + 
-00025440: 6930 332a 6e62 3033 2929 3b0a 0a20 2020  i03*nb03));..   
-00025450: 2020 2020 2020 2020 2020 2020 202a 2866               *(f
-00025460: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-00025470: 2920 6473 742d 3e64 6174 6120 2b20 6930  ) dst->data + i0
-00025480: 312a 6e62 3120 2b20 6930 322a 6e62 3220  1*nb1 + i02*nb2 
-00025490: 2b20 6930 332a 6e62 3329 202f 3d20 2866  + i03*nb3) /= (f
-000254a0: 6c6f 6174 2920 6e65 3030 3b0a 2020 2020  loat) ne00;.    
-000254b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000254c0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-000254d0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-000254e0: 6d70 7574 655f 666f 7277 6172 645f 6d65  mpute_forward_me
-000254f0: 616e 280a 2020 2020 2020 2020 636f 6e73  an(.        cons
-00025500: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00025510: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00025520: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00025530: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00025540: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00025550: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00025560: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00025570: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00025580: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00025590: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000255a0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-000255b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000255c0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-000255d0: 7075 7465 5f66 6f72 7761 7264 5f6d 6561  pute_forward_mea
-000255e0: 6e5f 6633 3228 7061 7261 6d73 2c20 7372  n_f32(params, sr
-000255f0: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
-00025600: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00025610: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00025620: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
-00025630: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00025640: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
-00025650: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00025660: 4938 3a0a 2020 2020 2020 2020 6361 7365  I8:.        case
-00025670: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
-00025680: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00025690: 4c5f 5459 5045 5f49 3332 3a0a 2020 2020  L_TYPE_I32:.    
-000256a0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-000256b0: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
-000256c0: 6361 7365 2047 474d 4c5f 5459 5045 5f43  case GGML_TYPE_C
-000256d0: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
-000256e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000256f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00025700: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00025710: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00025720: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
-00025730: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
-00025740: 7065 6174 0a0a 7374 6174 6963 2076 6f69  peat..static voi
-00025750: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00025760: 6f72 7761 7264 5f72 6570 6561 745f 6633  orward_repeat_f3
-00025770: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
-00025780: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00025790: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-000257a0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-000257b0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000257c0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-000257d0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000257e0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000257f0: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
-00025800: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
-00025810: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
-00025820: 5f63 616e 5f72 6570 6561 7428 7372 6330  _can_repeat(src0
-00025830: 2c20 6473 7429 293b 0a0a 2020 2020 6966  , dst));..    if
-00025840: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-00025850: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-00025860: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
-00025870: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-00025880: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-00025890: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-000258a0: 0a20 2020 202f 2f20 544f 444f 3a20 696d  .    // TODO: im
-000258b0: 706c 656d 656e 7420 7375 7070 6f72 7420  plement support 
-000258c0: 666f 7220 7261 6e6b 203e 2032 2074 656e  for rank > 2 ten
-000258d0: 736f 7273 0a20 2020 2061 7373 6572 7428  sors.    assert(
-000258e0: 7372 6330 2d3e 6e65 5b32 5d20 3d3d 2031  src0->ne[2] == 1
-000258f0: 293b 0a20 2020 2061 7373 6572 7428 7372  );.    assert(sr
-00025900: 6330 2d3e 6e65 5b33 5d20 3d3d 2031 293b  c0->ne[3] == 1);
-00025910: 0a20 2020 2061 7373 6572 7428 2064 7374  .    assert( dst
-00025920: 2d3e 6e65 5b32 5d20 3d3d 2031 293b 0a20  ->ne[2] == 1);. 
-00025930: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
-00025940: 6e65 5b33 5d20 3d3d 2031 293b 0a0a 2020  ne[3] == 1);..  
-00025950: 2020 636f 6e73 7420 696e 7420 6e63 2020    const int nc  
-00025960: 3d20 6473 742d 3e6e 655b 305d 3b0a 2020  = dst->ne[0];.  
-00025970: 2020 636f 6e73 7420 696e 7420 6e72 2020    const int nr  
-00025980: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
-00025990: 2020 636f 6e73 7420 696e 7420 6e63 3020    const int nc0 
-000259a0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
-000259b0: 2020 2063 6f6e 7374 2069 6e74 206e 7230     const int nr0
-000259c0: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
-000259d0: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
-000259e0: 7220 3d20 6e63 2f6e 6330 3b20 2f2f 2067  r = nc/nc0; // g
-000259f0: 7561 7261 6e74 6565 6420 746f 2062 6520  uaranteed to be 
-00025a00: 616e 2069 6e74 6567 6572 2064 7565 2074  an integer due t
-00025a10: 6f20 7468 6520 6368 6563 6b20 696e 2067  o the check in g
-00025a20: 676d 6c5f 6361 6e5f 7265 7065 6174 0a20  gml_can_repeat. 
-00025a30: 2020 2063 6f6e 7374 2069 6e74 206e 7272     const int nrr
-00025a40: 203d 206e 722f 6e72 303b 202f 2f20 6775   = nr/nr0; // gu
-00025a50: 6172 616e 7465 6564 2074 6f20 6265 2061  aranteed to be a
-00025a60: 6e20 696e 7465 6765 7220 6475 6520 746f  n integer due to
-00025a70: 2074 6865 2063 6865 636b 2069 6e20 6767   the check in gg
-00025a80: 6d6c 5f63 616e 5f72 6570 6561 740a 0a20  ml_can_repeat.. 
-00025a90: 2020 202f 2f20 544f 444f 3a20 7375 7070     // TODO: supp
-00025aa0: 6f72 7420 666f 7220 7472 616e 7370 6f73  ort for transpos
-00025ab0: 6564 202f 2070 6572 6d75 7465 6420 7465  ed / permuted te
-00025ac0: 6e73 6f72 730a 2020 2020 6173 7365 7274  nsors.    assert
-00025ad0: 2820 6473 742d 3e6e 625b 305d 203d 3d20  ( dst->nb[0] == 
-00025ae0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00025af0: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
-00025b00: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00025b10: 2866 6c6f 6174 2929 3b0a 0a20 2020 202f  (float));..    /
-00025b20: 2f20 544f 444f 3a20 6d61 7962 6520 7468  / TODO: maybe th
-00025b30: 6973 2069 7320 6e6f 7420 6f70 7469 6d61  is is not optima
-00025b40: 6c3f 0a20 2020 2066 6f72 2028 696e 7420  l?.    for (int 
-00025b50: 6920 3d20 303b 2069 203c 206e 7272 3b20  i = 0; i < nrr; 
-00025b60: 692b 2b29 207b 0a20 2020 2020 2020 2066  i++) {.        f
-00025b70: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-00025b80: 203c 206e 6372 3b20 6a2b 2b29 207b 0a20   < ncr; j++) {. 
-00025b90: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00025ba0: 696e 7420 6b20 3d20 303b 206b 203c 206e  int k = 0; k < n
-00025bb0: 7230 3b20 6b2b 2b29 207b 0a20 2020 2020  r0; k++) {.     
-00025bc0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00025bd0: 7665 635f 6370 795f 6633 3228 6e63 302c  vec_cpy_f32(nc0,
-00025be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025bf0: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00025c00: 2a29 2028 2863 6861 7220 2a29 2020 6473  *) ((char *)  ds
-00025c10: 742d 3e64 6174 6120 2b20 2869 2a6e 7230  t->data + (i*nr0
-00025c20: 202b 206b 292a 2820 6473 742d 3e6e 625b   + k)*( dst->nb[
-00025c30: 315d 2920 2b20 6a2a 6e63 302a 2820 6473  1]) + j*nc0*( ds
-00025c40: 742d 3e6e 625b 305d 2929 2c0a 2020 2020  t->nb[0])),.    
-00025c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025c60: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00025c70: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00025c80: 7461 202b 2028 2020 2020 2020 2020 6b29  ta + (        k)
-00025c90: 2a28 7372 6330 2d3e 6e62 5b31 5d29 2929  *(src0->nb[1])))
-00025ca0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00025cb0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00025cc0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00025cd0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00025ce0: 6172 645f 7265 7065 6174 280a 2020 2020  ard_repeat(.    
-00025cf0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00025d00: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00025d10: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00025d20: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00025d30: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00025d40: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00025d50: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00025d60: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00025d70: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
-00025d80: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-00025d90: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-00025da0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00025db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025dc0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00025dd0: 7761 7264 5f72 6570 6561 745f 6633 3228  ward_repeat_f32(
-00025de0: 7061 7261 6d73 2c20 7372 6330 2c20 6473  params, src0, ds
-00025df0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00025e00: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00025e10: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00025e20: 5134 5f30 3a0a 2020 2020 2020 2020 6361  Q4_0:.        ca
-00025e30: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
-00025e40: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
-00025e50: 4747 4d4c 5f54 5950 455f 4938 3a0a 2020  GGML_TYPE_I8:.  
-00025e60: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00025e70: 5459 5045 5f49 3136 3a0a 2020 2020 2020  TYPE_I16:.      
-00025e80: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00025e90: 5f49 3332 3a0a 2020 2020 2020 2020 6361  _I32:.        ca
-00025ea0: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
-00025eb0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00025ec0: 474d 4c5f 5459 5045 5f43 4f55 4e54 3a0a  GML_TYPE_COUNT:.
-00025ed0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00025ee0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00025ef0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00025f00: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00025f10: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00025f20: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00025f30: 666f 7277 6172 645f 6162 730a 0a73 7461  forward_abs..sta
-00025f40: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00025f50: 6d70 7574 655f 666f 7277 6172 645f 6162  mpute_forward_ab
-00025f60: 735f 6633 3228 0a20 2020 2020 2020 2063  s_f32(.        c
-00025f70: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00025f80: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00025f90: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00025fa0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00025fb0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00025fc0: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
-00025fd0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00025fe0: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
-00025ff0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
-00026000: 2030 293b 0a20 2020 2061 7373 6572 7428   0);.    assert(
-00026010: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
-00026020: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
-00026030: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00026040: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00026050: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
-00026060: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00026070: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
-00026080: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-00026090: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
-000260a0: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
-000260b0: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
-000260c0: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
-000260d0: 2073 7263 302d 3e6e 655b 305d 3b0a 0a20   src0->ne[0];.. 
-000260e0: 2020 2061 7373 6572 7428 6473 742d 3e6e     assert(dst->n
-000260f0: 625b 305d 2020 3d3d 2073 697a 656f 6628  b[0]  == sizeof(
-00026100: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
-00026110: 6572 7428 7372 6330 2d3e 6e62 5b30 5d20  ert(src0->nb[0] 
-00026120: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00026130: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-00026140: 2069 203d 2030 3b20 6920 3c20 6e3b 2069   i = 0; i < n; i
-00026150: 2b2b 2920 7b0a 2020 2020 2020 2020 6767  ++) {.        gg
-00026160: 6d6c 5f76 6563 5f61 6273 5f66 3332 286e  ml_vec_abs_f32(n
-00026170: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00026180: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-00026190: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-000261a0: 2020 2b20 692a 2820 6473 742d 3e6e 625b    + i*( dst->nb[
-000261b0: 315d 2929 2c0a 2020 2020 2020 2020 2020  1])),.          
-000261c0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-000261d0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-000261e0: 6461 7461 202b 2069 2a28 7372 6330 2d3e  data + i*(src0->
-000261f0: 6e62 5b31 5d29 2929 3b0a 2020 2020 7d0a  nb[1])));.    }.
-00026200: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00026210: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00026220: 6172 645f 6162 7328 0a20 2020 2020 2020  ard_abs(.       
-00026230: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00026240: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00026250: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00026260: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00026270: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00026280: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
-00026290: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000262a0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-000262b0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-000262c0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-000262d0: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
-000262e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000262f0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00026300: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00026310: 645f 6162 735f 6633 3228 7061 7261 6d73  d_abs_f32(params
-00026320: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
-00026330: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00026340: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00026350: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
-00026360: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00026370: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
-00026380: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00026390: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
-000263a0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-000263b0: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
-000263c0: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
-000263d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000263e0: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
-000263f0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00026400: 5045 5f43 4f55 4e54 3a0a 2020 2020 2020  PE_COUNT:.      
-00026410: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00026420: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00026430: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-00026440: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00026450: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
-00026460: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00026470: 645f 7367 6e0a 0a73 7461 7469 6320 766f  d_sgn..static vo
-00026480: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00026490: 666f 7277 6172 645f 7367 6e5f 6633 3228  forward_sgn_f32(
-000264a0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000264b0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-000264c0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-000264d0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-000264e0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000264f0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00026500: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00026510: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00026520: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
-00026530: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a20  ms->ith == 0);. 
-00026540: 2020 2061 7373 6572 7428 6767 6d6c 5f61     assert(ggml_a
-00026550: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
-00026560: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
-00026570: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00026580: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-00026590: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-000265a0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-000265b0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-000265c0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-000265d0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-000265e0: 206e 2020 3d20 6767 6d6c 5f6e 726f 7773   n  = ggml_nrows
-000265f0: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
-00026600: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
-00026610: 3e6e 655b 305d 3b0a 0a20 2020 2061 7373  >ne[0];..    ass
-00026620: 6572 7428 6473 742d 3e6e 625b 305d 2020  ert(dst->nb[0]  
-00026630: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00026640: 293b 0a20 2020 2061 7373 6572 7428 7372  );.    assert(sr
-00026650: 6330 2d3e 6e62 5b30 5d20 3d3d 2073 697a  c0->nb[0] == siz
-00026660: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00026670: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00026680: 3b20 6920 3c20 6e3b 2069 2b2b 2920 7b0a  ; i < n; i++) {.
-00026690: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-000266a0: 5f73 676e 5f66 3332 286e 632c 0a20 2020  _sgn_f32(nc,.   
-000266b0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-000266c0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-000266d0: 2064 7374 2d3e 6461 7461 2020 2b20 692a   dst->data  + i*
-000266e0: 2820 6473 742d 3e6e 625b 315d 2929 2c0a  ( dst->nb[1])),.
-000266f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026700: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00026710: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-00026720: 2069 2a28 7372 6330 2d3e 6e62 5b31 5d29   i*(src0->nb[1])
-00026730: 2929 3b0a 2020 2020 7d0a 7d0a 0a73 7461  ));.    }.}..sta
-00026740: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00026750: 6d70 7574 655f 666f 7277 6172 645f 7367  mpute_forward_sg
-00026760: 6e28 0a20 2020 2020 2020 2063 6f6e 7374  n(.        const
-00026770: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00026780: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00026790: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-000267a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000267b0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-000267c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000267d0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000267e0: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-000267f0: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-00026800: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00026810: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-00026820: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00026830: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00026840: 7574 655f 666f 7277 6172 645f 7367 6e5f  ute_forward_sgn_
-00026850: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
-00026860: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-00026870: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00026880: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00026890: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
-000268a0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000268b0: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
-000268c0: 6173 6520 4747 4d4c 5f54 5950 455f 4938  ase GGML_TYPE_I8
-000268d0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-000268e0: 474d 4c5f 5459 5045 5f49 3136 3a0a 2020  GML_TYPE_I16:.  
-000268f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00026900: 5459 5045 5f49 3332 3a0a 2020 2020 2020  TYPE_I32:.      
-00026910: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00026920: 5f46 3136 3a0a 2020 2020 2020 2020 6361  _F16:.        ca
-00026930: 7365 2047 474d 4c5f 5459 5045 5f43 4f55  se GGML_TYPE_COU
-00026940: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
-00026950: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00026960: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00026970: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
-00026980: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
-00026990: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
-000269a0: 7574 655f 666f 7277 6172 645f 6e65 670a  ute_forward_neg.
-000269b0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000269c0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000269d0: 645f 6e65 675f 6633 3228 0a20 2020 2020  d_neg_f32(.     
-000269e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000269f0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00026a00: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00026a10: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00026a20: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00026a30: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
-00026a40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00026a50: 7220 2a20 6473 7429 207b 0a20 2020 2061  r * dst) {.    a
-00026a60: 7373 6572 7428 7061 7261 6d73 2d3e 6974  ssert(params->it
-00026a70: 6820 3d3d 2030 293b 0a20 2020 2061 7373  h == 0);.    ass
-00026a80: 6572 7428 6767 6d6c 5f61 7265 5f73 616d  ert(ggml_are_sam
-00026a90: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
-00026aa0: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
-00026ab0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00026ac0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-00026ad0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00026ae0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00026af0: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00026b00: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00026b10: 2063 6f6e 7374 2069 6e74 206e 2020 3d20   const int n  = 
-00026b20: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
-00026b30: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00026b40: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-00026b50: 3b0a 0a20 2020 2061 7373 6572 7428 6473  ;..    assert(ds
-00026b60: 742d 3e6e 625b 305d 2020 3d3d 2073 697a  t->nb[0]  == siz
-00026b70: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00026b80: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
-00026b90: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
-00026ba0: 6f61 7429 293b 0a0a 2020 2020 666f 7220  oat));..    for 
-00026bb0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00026bc0: 6e3b 2069 2b2b 2920 7b0a 2020 2020 2020  n; i++) {.      
-00026bd0: 2020 6767 6d6c 5f76 6563 5f6e 6567 5f66    ggml_vec_neg_f
-00026be0: 3332 286e 632c 0a20 2020 2020 2020 2020  32(nc,.         
-00026bf0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00026c00: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-00026c10: 6461 7461 2020 2b20 692a 2820 6473 742d  data  + i*( dst-
-00026c20: 3e6e 625b 315d 2929 2c0a 2020 2020 2020  >nb[1])),.      
-00026c30: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00026c40: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00026c50: 6330 2d3e 6461 7461 202b 2069 2a28 7372  c0->data + i*(sr
-00026c60: 6330 2d3e 6e62 5b31 5d29 2929 3b0a 2020  c0->nb[1])));.  
-00026c70: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-00026c80: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00026c90: 666f 7277 6172 645f 6e65 6728 0a20 2020  forward_neg(.   
-00026ca0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00026cb0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00026cc0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00026cd0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00026ce0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00026cf0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00026d00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00026d10: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00026d20: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-00026d30: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00026d40: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00026d50: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00026d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026d70: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00026d80: 7277 6172 645f 6e65 675f 6633 3228 7061  rward_neg_f32(pa
-00026d90: 7261 6d73 2c20 7372 6330 2c20 6473 7429  rams, src0, dst)
-00026da0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00026db0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00026dc0: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00026dd0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
-00026de0: 2047 474d 4c5f 5459 5045 5f51 345f 313a   GGML_TYPE_Q4_1:
-00026df0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00026e00: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
-00026e10: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00026e20: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
-00026e30: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-00026e40: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
-00026e50: 2047 474d 4c5f 5459 5045 5f46 3136 3a0a   GGML_TYPE_F16:.
-00026e60: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00026e70: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
-00026e80: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00026e90: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00026ea0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00026eb0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00026ec0: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-00026ed0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00026ee0: 7277 6172 645f 7374 6570 0a0a 7374 6174  rward_step..stat
-00026ef0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00026f00: 7075 7465 5f66 6f72 7761 7264 5f73 7465  pute_forward_ste
-00026f10: 705f 6633 3228 0a20 2020 2020 2020 2063  p_f32(.        c
-00026f20: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00026f30: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00026f40: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00026f50: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00026f60: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00026f70: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
-00026f80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00026f90: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
-00026fa0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
-00026fb0: 2030 293b 0a20 2020 2061 7373 6572 7428   0);.    assert(
-00026fc0: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
-00026fd0: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
-00026fe0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00026ff0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00027000: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
-00027010: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00027020: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
-00027030: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-00027040: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
-00027050: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
-00027060: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
-00027070: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
-00027080: 2073 7263 302d 3e6e 655b 305d 3b0a 0a20   src0->ne[0];.. 
-00027090: 2020 2061 7373 6572 7428 6473 742d 3e6e     assert(dst->n
-000270a0: 625b 305d 2020 3d3d 2073 697a 656f 6628  b[0]  == sizeof(
-000270b0: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
-000270c0: 6572 7428 7372 6330 2d3e 6e62 5b30 5d20  ert(src0->nb[0] 
-000270d0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-000270e0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-000270f0: 2069 203d 2030 3b20 6920 3c20 6e3b 2069   i = 0; i < n; i
-00027100: 2b2b 2920 7b0a 2020 2020 2020 2020 6767  ++) {.        gg
-00027110: 6d6c 5f76 6563 5f73 7465 705f 6633 3228  ml_vec_step_f32(
-00027120: 6e63 2c0a 2020 2020 2020 2020 2020 2020  nc,.            
-00027130: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00027140: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-00027150: 6120 202b 2069 2a28 2064 7374 2d3e 6e62  a  + i*( dst->nb
-00027160: 5b31 5d29 292c 0a20 2020 2020 2020 2020  [1])),.         
-00027170: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00027180: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00027190: 3e64 6174 6120 2b20 692a 2873 7263 302d  >data + i*(src0-
-000271a0: 3e6e 625b 315d 2929 293b 0a20 2020 207d  >nb[1])));.    }
-000271b0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-000271c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000271d0: 7761 7264 5f73 7465 7028 0a20 2020 2020  ward_step(.     
-000271e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000271f0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00027200: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00027210: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00027220: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00027230: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
-00027240: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00027250: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
-00027260: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
-00027270: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
-00027280: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-00027290: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000272a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000272b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000272c0: 6172 645f 7374 6570 5f66 3332 2870 6172  ard_step_f32(par
-000272d0: 616d 732c 2073 7263 302c 2064 7374 293b  ams, src0, dst);
-000272e0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000272f0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00027300: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
-00027310: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
-00027320: 4747 4d4c 5f54 5950 455f 5134 5f31 3a0a  GGML_TYPE_Q4_1:.
-00027330: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00027340: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
-00027350: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00027360: 455f 4931 363a 0a20 2020 2020 2020 2063  E_I16:.        c
-00027370: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
-00027380: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
-00027390: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-000273a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000273b0: 5f54 5950 455f 434f 554e 543a 0a20 2020  _TYPE_COUNT:.   
-000273c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000273d0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000273e0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-000273f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00027400: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-00027410: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00027420: 7761 7264 5f72 656c 750a 0a73 7461 7469  ward_relu..stati
-00027430: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00027440: 7574 655f 666f 7277 6172 645f 7265 6c75  ute_forward_relu
-00027450: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-00027460: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00027470: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00027480: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00027490: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000274a0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-000274b0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-000274c0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-000274d0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-000274e0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
-000274f0: 3029 3b0a 2020 2020 6173 7365 7274 2867  0);.    assert(g
-00027500: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-00027510: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
-00027520: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00027530: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00027540: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00027550: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00027560: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00027570: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00027580: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-00027590: 7420 696e 7420 6e20 203d 2067 676d 6c5f  t int n  = ggml_
-000275a0: 6e72 6f77 7328 7372 6330 293b 0a20 2020  nrows(src0);.   
-000275b0: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-000275c0: 7372 6330 2d3e 6e65 5b30 5d3b 0a0a 2020  src0->ne[0];..  
-000275d0: 2020 6173 7365 7274 2864 7374 2d3e 6e62    assert(dst->nb
-000275e0: 5b30 5d20 203d 3d20 7369 7a65 6f66 2866  [0]  == sizeof(f
-000275f0: 6c6f 6174 2929 3b0a 2020 2020 6173 7365  loat));.    asse
-00027600: 7274 2873 7263 302d 3e6e 625b 305d 203d  rt(src0->nb[0] =
-00027610: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00027620: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-00027630: 6920 3d20 303b 2069 203c 206e 3b20 692b  i = 0; i < n; i+
-00027640: 2b29 207b 0a20 2020 2020 2020 2067 676d  +) {.        ggm
-00027650: 6c5f 7665 635f 7265 6c75 5f66 3332 286e  l_vec_relu_f32(n
-00027660: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00027670: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-00027680: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-00027690: 2020 2b20 692a 2820 6473 742d 3e6e 625b    + i*( dst->nb[
-000276a0: 315d 2929 2c0a 2020 2020 2020 2020 2020  1])),.          
-000276b0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-000276c0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-000276d0: 6461 7461 202b 2069 2a28 7372 6330 2d3e  data + i*(src0->
-000276e0: 6e62 5b31 5d29 2929 3b0a 2020 2020 7d0a  nb[1])));.    }.
-000276f0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00027700: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00027710: 6172 645f 7265 6c75 280a 2020 2020 2020  ard_relu(.      
-00027720: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00027730: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00027740: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00027750: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00027760: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00027770: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-00027780: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00027790: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-000277a0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-000277b0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-000277c0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-000277d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000277e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000277f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00027800: 7264 5f72 656c 755f 6633 3228 7061 7261  rd_relu_f32(para
-00027810: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
-00027820: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00027830: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00027840: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
-00027850: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00027860: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
-00027870: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00027880: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
-00027890: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000278a0: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
-000278b0: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
-000278c0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-000278d0: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-000278e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000278f0: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
-00027900: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00027910: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00027920: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-00027930: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00027940: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
-00027950: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00027960: 6172 645f 6765 6c75 0a0a 7374 6174 6963  ard_gelu..static
-00027970: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00027980: 7465 5f66 6f72 7761 7264 5f67 656c 755f  te_forward_gelu_
-00027990: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-000279a0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000279b0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000279c0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000279d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000279e0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-000279f0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00027a00: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00027a10: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
-00027a20: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
-00027a30: 7469 6775 6f75 7328 7372 6330 2929 3b0a  tiguous(src0));.
-00027a40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00027a50: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
-00027a60: 7573 2864 7374 2929 3b0a 2020 2020 4747  us(dst));.    GG
-00027a70: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f61  ML_ASSERT(ggml_a
-00027a80: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
-00027a90: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
-00027aa0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00027ab0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-00027ac0: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-00027ad0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00027ae0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-00027af0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00027b00: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-00027b10: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
-00027b20: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00027b30: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
-00027b40: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
-00027b50: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
-00027b60: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00027b70: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
-00027b80: 6f77 7328 7372 6330 293b 0a0a 2020 2020  ows(src0);..    
-00027b90: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
-00027ba0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00027bb0: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-00027bc0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-00027bd0: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-00027be0: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-00027bf0: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-00027c00: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
-00027c10: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
-00027c20: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
-00027c30: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
-00027c40: 3d20 6972 303b 2069 3120 3c20 6972 313b  = ir0; i1 < ir1;
-00027c50: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
-00027c60: 2067 676d 6c5f 7665 635f 6765 6c75 5f66   ggml_vec_gelu_f
-00027c70: 3332 286e 632c 0a20 2020 2020 2020 2020  32(nc,.         
-00027c80: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00027c90: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-00027ca0: 6461 7461 2020 2b20 6931 2a28 2064 7374  data  + i1*( dst
-00027cb0: 2d3e 6e62 5b31 5d29 292c 0a20 2020 2020  ->nb[1])),.     
-00027cc0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-00027cd0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-00027ce0: 7263 302d 3e64 6174 6120 2b20 6931 2a28  rc0->data + i1*(
-00027cf0: 7372 6330 2d3e 6e62 5b31 5d29 2929 3b0a  src0->nb[1])));.
-00027d00: 0a23 6966 6e64 6566 204e 4445 4255 470a  .#ifndef NDEBUG.
-00027d10: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00027d20: 206b 203d 2030 3b20 6b20 3c20 6e63 3b20   k = 0; k < nc; 
-00027d30: 6b2b 2b29 207b 0a20 2020 2020 2020 2020  k++) {.         
-00027d40: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
-00027d50: 203d 2028 2866 6c6f 6174 202a 2920 2828   = ((float *) ((
-00027d60: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-00027d70: 6120 2b20 6931 2a28 2064 7374 2d3e 6e62  a + i1*( dst->nb
-00027d80: 5b31 5d29 2929 5b6b 5d3b 0a20 2020 2020  [1])))[k];.     
-00027d90: 2020 2020 2020 2055 4e55 5345 4428 7829         UNUSED(x)
-00027da0: 3b0a 2020 2020 2020 2020 2020 2020 6173  ;.            as
-00027db0: 7365 7274 2821 6973 6e61 6e28 7829 293b  sert(!isnan(x));
-00027dc0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00027dd0: 6572 7428 2169 7369 6e66 2878 2929 3b0a  ert(!isinf(x));.
-00027de0: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
-00027df0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00027e00: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00027e10: 7465 5f66 6f72 7761 7264 5f67 656c 7528  te_forward_gelu(
-00027e20: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00027e30: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00027e40: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00027e50: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00027e60: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00027e70: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00027e80: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00027e90: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00027ea0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00027eb0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00027ec0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00027ed0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00027ee0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00027ef0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00027f00: 655f 666f 7277 6172 645f 6765 6c75 5f66  e_forward_gelu_f
-00027f10: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00027f20: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00027f30: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00027f40: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00027f50: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
-00027f60: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00027f70: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
-00027f80: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
-00027f90: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00027fa0: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
-00027fb0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00027fc0: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
-00027fd0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00027fe0: 4631 363a 0a20 2020 2020 2020 2063 6173  F16:.        cas
-00027ff0: 6520 4747 4d4c 5f54 5950 455f 434f 554e  e GGML_TYPE_COUN
-00028000: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-00028010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028020: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00028030: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00028040: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00028050: 0a20 2020 202f 2f70 7269 6e74 6628 2258  .    //printf("X
-00028060: 5858 5858 5858 5820 6765 6c75 5c6e 2229  XXXXXXX gelu\n")
-00028070: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  ;.}..// ggml_com
-00028080: 7075 7465 5f66 6f72 7761 7264 5f73 696c  pute_forward_sil
-00028090: 750a 0a73 7461 7469 6320 766f 6964 2067  u..static void g
-000280a0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000280b0: 6172 645f 7369 6c75 5f66 3332 280a 2020  ard_silu_f32(.  
-000280c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000280d0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-000280e0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-000280f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00028100: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00028110: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00028120: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00028130: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00028140: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00028150: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-00028160: 2873 7263 3029 293b 0a20 2020 2047 474d  (src0));.    GGM
-00028170: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-00028180: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
-00028190: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000281a0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-000281b0: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-000281c0: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-000281d0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-000281e0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-000281f0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00028200: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00028210: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00028220: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00028230: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
-00028240: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
-00028250: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
-00028260: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
-00028270: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
-00028280: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
-00028290: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
-000282a0: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
-000282b0: 3029 3b0a 0a20 2020 202f 2f20 726f 7773  0);..    // rows
-000282c0: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
-000282d0: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
-000282e0: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
-000282f0: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
-00028300: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
-00028310: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-00028320: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
-00028330: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00028340: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
-00028350: 722c 206e 7229 3b0a 0a20 2020 2066 6f72  r, nr);..    for
-00028360: 2028 696e 7420 6931 203d 2069 7230 3b20   (int i1 = ir0; 
-00028370: 6931 203c 2069 7231 3b20 6931 2b2b 2920  i1 < ir1; i1++) 
-00028380: 7b0a 2020 2020 2020 2020 6767 6d6c 5f76  {.        ggml_v
-00028390: 6563 5f73 696c 755f 6633 3228 6e63 2c0a  ec_silu_f32(nc,.
-000283a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283b0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-000283c0: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
-000283d0: 2069 312a 2820 6473 742d 3e6e 625b 315d   i1*( dst->nb[1]
-000283e0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-000283f0: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00028400: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00028410: 7461 202b 2069 312a 2873 7263 302d 3e6e  ta + i1*(src0->n
-00028420: 625b 315d 2929 293b 0a0a 2369 666e 6465  b[1])));..#ifnde
-00028430: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
-00028440: 2066 6f72 2028 696e 7420 6b20 3d20 303b   for (int k = 0;
-00028450: 206b 203c 206e 633b 206b 2b2b 2920 7b0a   k < nc; k++) {.
-00028460: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00028470: 7420 666c 6f61 7420 7820 3d20 2828 666c  t float x = ((fl
-00028480: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00028490: 2064 7374 2d3e 6461 7461 202b 2069 312a   dst->data + i1*
-000284a0: 2820 6473 742d 3e6e 625b 315d 2929 295b  ( dst->nb[1])))[
-000284b0: 6b5d 3b0a 2020 2020 2020 2020 2020 2020  k];.            
-000284c0: 554e 5553 4544 2878 293b 0a20 2020 2020  UNUSED(x);.     
-000284d0: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
-000284e0: 736e 616e 2878 2929 3b0a 2020 2020 2020  snan(x));.      
-000284f0: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
-00028500: 696e 6628 7829 293b 0a20 2020 2020 2020  inf(x));.       
-00028510: 207d 0a23 656e 6469 660a 2020 2020 7d0a   }.#endif.    }.
-00028520: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00028530: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00028540: 6172 645f 7369 6c75 280a 2020 2020 2020  ard_silu(.      
-00028550: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00028560: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00028570: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00028580: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00028590: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000285a0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-000285b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000285c0: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-000285d0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-000285e0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-000285f0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00028600: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00028610: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00028620: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00028630: 7264 5f73 696c 755f 6633 3228 7061 7261  rd_silu_f32(para
-00028640: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
-00028650: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00028660: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00028670: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
-00028680: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00028690: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
-000286a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000286b0: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
-000286c0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000286d0: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
-000286e0: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
-000286f0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00028700: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00028710: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00028720: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
-00028730: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00028740: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00028750: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-00028760: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00028770: 6b3b 0a20 2020 207d 0a7d 0a0a 0a2f 2f20  k;.    }.}...// 
-00028780: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00028790: 7761 7264 5f6e 6f72 6d0a 0a73 7461 7469  ward_norm..stati
-000287a0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-000287b0: 7574 655f 666f 7277 6172 645f 6e6f 726d  ute_forward_norm
-000287c0: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-000287d0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000287e0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-000287f0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00028800: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00028810: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00028820: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00028830: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00028840: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-00028850: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-00028860: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-00028870: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
-00028880: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00028890: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-000288a0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-000288b0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-000288c0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-000288d0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-000288e0: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-000288f0: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
-00028900: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-00028910: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00028920: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00028930: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00028940: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-00028950: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00028960: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
-00028970: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00028980: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-00028990: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-000289a0: 696e 7420 6e65 3032 203d 2073 7263 302d  int ne02 = src0-
-000289b0: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-000289c0: 7420 696e 7420 6e65 3033 203d 2073 7263  t int ne03 = src
-000289d0: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
-000289e0: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
-000289f0: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-00028a00: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00028a10: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-00028a20: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-00028a30: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
-00028a40: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
-00028a50: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
-00028a60: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-00028a70: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00028a80: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
-00028a90: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00028aa0: 7420 6e62 3320 3d20 6473 742d 3e6e 625b  t nb3 = dst->nb[
-00028ab0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2067  3];..    const g
-00028ac0: 676d 6c5f 666c 6f61 7420 6570 7320 3d20  gml_float eps = 
-00028ad0: 3165 2d35 663b 202f 2f20 544f 444f 3a20  1e-5f; // TODO: 
-00028ae0: 6d61 6b65 2074 6869 7320 6120 7061 7261  make this a para
-00028af0: 6d65 7465 720a 0a20 2020 202f 2f20 544f  meter..    // TO
-00028b00: 444f 3a20 6f70 7469 6d69 7a65 0a20 2020  DO: optimize.   
-00028b10: 2066 6f72 2028 696e 7420 6930 3320 3d20   for (int i03 = 
-00028b20: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
-00028b30: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
-00028b40: 666f 7220 2869 6e74 2069 3032 203d 2030  for (int i02 = 0
-00028b50: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
-00028b60: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
-00028b70: 2020 2066 6f72 2028 696e 7420 6930 3120     for (int i01 
-00028b80: 3d20 6974 683b 2069 3031 203c 206e 6530  = ith; i01 < ne0
-00028b90: 313b 2069 3031 202b 3d20 6e74 6829 207b  1; i01 += nth) {
-00028ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028bb0: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
-00028bc0: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-00028bd0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00028be0: 6120 2b20 6930 312a 6e62 3031 202b 2069  a + i01*nb01 + i
-00028bf0: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
-00028c00: 3033 293b 0a0a 2020 2020 2020 2020 2020  03);..          
-00028c10: 2020 2020 2020 6767 6d6c 5f66 6c6f 6174        ggml_float
-00028c20: 206d 6561 6e20 3d20 302e 303b 0a20 2020   mean = 0.0;.   
-00028c30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00028c40: 2028 696e 7420 6930 3020 3d20 303b 2069   (int i00 = 0; i
-00028c50: 3030 203c 206e 6530 303b 2069 3030 2b2b  00 < ne00; i00++
-00028c60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00028c70: 2020 2020 2020 2020 6d65 616e 202b 3d20          mean += 
-00028c80: 785b 6930 305d 3b0a 2020 2020 2020 2020  x[i00];.        
-00028c90: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00028ca0: 2020 2020 2020 2020 2020 206d 6561 6e20             mean 
-00028cb0: 2f3d 206e 6530 303b 0a0a 2020 2020 2020  /= ne00;..      
-00028cc0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00028cd0: 2a20 7920 3d20 2866 6c6f 6174 202a 2920  * y = (float *) 
-00028ce0: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-00028cf0: 6174 6120 2b20 6930 312a 6e62 3120 2b20  ata + i01*nb1 + 
-00028d00: 6930 322a 6e62 3220 2b20 6930 332a 6e62  i02*nb2 + i03*nb
-00028d10: 3329 3b0a 0a20 2020 2020 2020 2020 2020  3);..           
-00028d20: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
-00028d30: 7375 6d32 203d 2030 2e30 3b0a 2020 2020  sum2 = 0.0;.    
-00028d40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00028d50: 2869 6e74 2069 3030 203d 2030 3b20 6930  (int i00 = 0; i0
-00028d60: 3020 3c20 6e65 3030 3b20 6930 302b 2b29  0 < ne00; i00++)
-00028d70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00028d80: 2020 2020 2020 2067 676d 6c5f 666c 6f61         ggml_floa
-00028d90: 7420 7620 3d20 785b 6930 305d 202d 206d  t v = x[i00] - m
-00028da0: 6561 6e3b 0a20 2020 2020 2020 2020 2020  ean;.           
-00028db0: 2020 2020 2020 2020 2079 5b69 3030 5d20           y[i00] 
-00028dc0: 3d20 763b 0a20 2020 2020 2020 2020 2020  = v;.           
-00028dd0: 2020 2020 2020 2020 2073 756d 3220 2b3d           sum2 +=
-00028de0: 2076 2a76 3b0a 2020 2020 2020 2020 2020   v*v;.          
-00028df0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00028e00: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00028e10: 6c6f 6174 2073 6361 6c65 203d 2031 2e30  loat scale = 1.0
-00028e20: 2f73 7172 7428 7375 6d32 2f6e 6530 3020  /sqrt(sum2/ne00 
-00028e30: 2b20 6570 7329 3b0a 0a20 2020 2020 2020  + eps);..       
-00028e40: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00028e50: 635f 7363 616c 655f 6633 3228 6e65 3030  c_scale_f32(ne00
-00028e60: 2c20 792c 2073 6361 6c65 293b 0a20 2020  , y, scale);.   
-00028e70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00028e80: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-00028e90: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00028ea0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6e  ompute_forward_n
-00028eb0: 6f72 6d28 0a20 2020 2020 2020 2063 6f6e  orm(.        con
-00028ec0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00028ed0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00028ee0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00028ef0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00028f00: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00028f10: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00028f20: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00028f30: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00028f40: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00028f50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00028f60: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-00028f70: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00028f80: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00028f90: 6d70 7574 655f 666f 7277 6172 645f 6e6f  mpute_forward_no
-00028fa0: 726d 5f66 3332 2870 6172 616d 732c 2073  rm_f32(params, s
-00028fb0: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
-00028fc0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00028fd0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00028fe0: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
-00028ff0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00029000: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
-00029010: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00029020: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
-00029030: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
-00029040: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00029050: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
-00029060: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00029070: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
-00029080: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00029090: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
-000290a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000290b0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-000290c0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-000290d0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000290e0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-000290f0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00029100: 666f 7277 6172 645f 726d 735f 6e6f 726d  forward_rms_norm
-00029110: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-00029120: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00029130: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00029140: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00029150: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00029160: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00029170: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00029180: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00029190: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-000291a0: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-000291b0: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-000291c0: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
-000291d0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-000291e0: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-000291f0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00029200: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00029210: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00029220: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00029230: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-00029240: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
-00029250: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-00029260: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00029270: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00029280: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00029290: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-000292a0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-000292b0: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
-000292c0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-000292d0: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-000292e0: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-000292f0: 696e 7420 6e65 3032 203d 2073 7263 302d  int ne02 = src0-
-00029300: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-00029310: 7420 696e 7420 6e65 3033 203d 2073 7263  t int ne03 = src
-00029320: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
-00029330: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
-00029340: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-00029350: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00029360: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-00029370: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-00029380: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
-00029390: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
-000293a0: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
-000293b0: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-000293c0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-000293d0: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
-000293e0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-000293f0: 7420 6e62 3320 3d20 6473 742d 3e6e 625b  t nb3 = dst->nb[
-00029400: 335d 3b0a 0a20 2020 2063 6f6e 7374 2067  3];..    const g
-00029410: 676d 6c5f 666c 6f61 7420 6570 7320 3d20  gml_float eps = 
-00029420: 3165 2d36 663b 202f 2f20 544f 444f 3a20  1e-6f; // TODO: 
-00029430: 6d61 6b65 2074 6869 7320 6120 7061 7261  make this a para
-00029440: 6d65 7465 720a 0a20 2020 202f 2f20 544f  meter..    // TO
-00029450: 444f 3a20 6f70 7469 6d69 7a65 0a20 2020  DO: optimize.   
-00029460: 2066 6f72 2028 696e 7420 6930 3320 3d20   for (int i03 = 
-00029470: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
-00029480: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
-00029490: 666f 7220 2869 6e74 2069 3032 203d 2030  for (int i02 = 0
-000294a0: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
-000294b0: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
-000294c0: 2020 2066 6f72 2028 696e 7420 6930 3120     for (int i01 
-000294d0: 3d20 6974 683b 2069 3031 203c 206e 6530  = ith; i01 < ne0
-000294e0: 313b 2069 3031 202b 3d20 6e74 6829 207b  1; i01 += nth) {
-000294f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029500: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
-00029510: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-00029520: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00029530: 6120 2b20 6930 312a 6e62 3031 202b 2069  a + i01*nb01 + i
-00029540: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
-00029550: 3033 293b 0a0a 2020 2020 2020 2020 2020  03);..          
-00029560: 2020 2020 2020 6767 6d6c 5f66 6c6f 6174        ggml_float
-00029570: 206d 6561 6e20 3d20 302e 303b 0a20 2020   mean = 0.0;.   
-00029580: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00029590: 2028 696e 7420 6930 3020 3d20 303b 2069   (int i00 = 0; i
-000295a0: 3030 203c 206e 6530 303b 2069 3030 2b2b  00 < ne00; i00++
-000295b0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000295c0: 2020 2020 2020 2020 6d65 616e 202b 3d20          mean += 
-000295d0: 785b 6930 305d 202a 2078 5b69 3030 5d3b  x[i00] * x[i00];
-000295e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000295f0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00029600: 2020 2020 6d65 616e 202f 3d20 6e65 3030      mean /= ne00
-00029610: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00029620: 2020 2066 6c6f 6174 202a 2079 203d 2028     float * y = (
-00029630: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00029640: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
-00029650: 3031 2a6e 6231 202b 2069 3032 2a6e 6232  01*nb1 + i02*nb2
-00029660: 202b 2069 3033 2a6e 6233 293b 0a0a 2020   + i03*nb3);..  
-00029670: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00029680: 6d63 7079 2879 2c20 782c 206e 6530 3020  mcpy(y, x, ne00 
-00029690: 2a20 7369 7a65 6f66 2866 6c6f 6174 2929  * sizeof(float))
-000296a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000296b0: 2020 2f2f 2066 6f72 2028 696e 7420 6930    // for (int i0
-000296c0: 3020 3d20 303b 2069 3030 203c 206e 6530  0 = 0; i00 < ne0
-000296d0: 303b 2069 3030 2b2b 2920 7b0a 2020 2020  0; i00++) {.    
-000296e0: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-000296f0: 2020 2079 5b69 3030 5d20 3d20 785b 6930     y[i00] = x[i0
-00029700: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-00029710: 2020 2020 2f2f 207d 0a0a 2020 2020 2020      // }..      
-00029720: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00029730: 666c 6f61 7420 7363 616c 6520 3d20 312e  float scale = 1.
-00029740: 302f 7371 7274 286d 6561 6e20 2b20 6570  0/sqrt(mean + ep
-00029750: 7329 3b0a 0a20 2020 2020 2020 2020 2020  s);..           
-00029760: 2020 2020 2067 676d 6c5f 7665 635f 7363       ggml_vec_sc
-00029770: 616c 655f 6633 3228 6e65 3030 2c20 792c  ale_f32(ne00, y,
-00029780: 2073 6361 6c65 293b 0a20 2020 2020 2020   scale);.       
-00029790: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-000297a0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-000297b0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000297c0: 7465 5f66 6f72 7761 7264 5f72 6d73 5f6e  te_forward_rms_n
-000297d0: 6f72 6d28 0a20 2020 2020 2020 2063 6f6e  orm(.        con
-000297e0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000297f0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00029800: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00029810: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00029820: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00029830: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00029840: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00029850: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00029860: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00029870: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00029880: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-00029890: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000298a0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000298b0: 6d70 7574 655f 666f 7277 6172 645f 726d  mpute_forward_rm
-000298c0: 735f 6e6f 726d 5f66 3332 2870 6172 616d  s_norm_f32(param
-000298d0: 732c 2073 7263 302c 2064 7374 293b 0a20  s, src0, dst);. 
-000298e0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000298f0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00029900: 2047 474d 4c5f 5459 5045 5f51 345f 303a   GGML_TYPE_Q4_0:
-00029910: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00029920: 4d4c 5f54 5950 455f 5134 5f31 3a0a 2020  ML_TYPE_Q4_1:.  
-00029930: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00029940: 5459 5045 5f49 383a 0a20 2020 2020 2020  TYPE_I8:.       
-00029950: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00029960: 4931 363a 0a20 2020 2020 2020 2063 6173  I16:.        cas
-00029970: 6520 4747 4d4c 5f54 5950 455f 4933 323a  e GGML_TYPE_I32:
-00029980: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00029990: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
-000299a0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-000299b0: 5950 455f 434f 554e 543a 0a20 2020 2020  YPE_COUNT:.     
-000299c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000299d0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-000299e0: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-000299f0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00029a00: 3b0a 2020 2020 7d0a 7d0a 0a0a 2f2f 2067  ;.    }.}...// g
-00029a10: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00029a20: 6172 645f 6d75 6c5f 6d61 740a 0a23 6966  ard_mul_mat..#if
-00029a30: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
-00029a40: 455f 4143 4345 4c45 5241 5445 2920 7c7c  E_ACCELERATE) ||
-00029a50: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
-00029a60: 455f 4f50 454e 424c 4153 290a 2f2f 2068  E_OPENBLAS).// h
-00029a70: 656c 7065 7220 6675 6e63 7469 6f6e 2074  elper function t
-00029a80: 6f20 6465 7465 726d 696e 6520 6966 2069  o determine if i
-00029a90: 7420 6973 2062 6574 7465 7220 746f 2075  t is better to u
-00029aa0: 7365 2042 4c41 5320 6f72 206e 6f74 0a2f  se BLAS or not./
-00029ab0: 2f20 666f 7220 6c61 7267 6520 6d61 7472  / for large matr
-00029ac0: 6963 6573 2c20 424c 4153 2069 7320 6661  ices, BLAS is fa
-00029ad0: 7374 6572 0a73 7461 7469 6320 626f 6f6c  ster.static bool
-00029ae0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00029af0: 7277 6172 645f 6d75 6c5f 6d61 745f 7573  rward_mul_mat_us
-00029b00: 655f 626c 6173 280a 2020 2020 2020 2020  e_blas(.        
-00029b10: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00029b20: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00029b30: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00029b40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00029b50: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00029b60: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00029b70: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00029b80: 2920 7b0a 2020 2020 554e 5553 4544 2873  ) {.    UNUSED(s
-00029b90: 7263 3029 3b0a 0a20 2020 2063 6f6e 7374  rc0);..    const
-00029ba0: 2069 6e74 206e 6531 3020 3d20 7372 6331   int ne10 = src1
-00029bb0: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 636f  ->ne[0];..    co
-00029bc0: 6e73 7420 696e 7420 6e65 3020 3d20 6473  nst int ne0 = ds
-00029bd0: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
-00029be0: 6e73 7420 696e 7420 6e65 3120 3d20 6473  nst int ne1 = ds
-00029bf0: 742d 3e6e 655b 315d 3b0a 0a20 2020 202f  t->ne[1];..    /
-00029c00: 2f20 544f 444f 3a20 6669 6e64 2074 6865  / TODO: find the
-00029c10: 206f 7074 696d 616c 2076 616c 7565 7320   optimal values 
-00029c20: 666f 7220 7468 6573 650a 2020 2020 6966  for these.    if
-00029c30: 2028 6767 6d6c 5f69 735f 636f 6e74 6967   (ggml_is_contig
-00029c40: 756f 7573 2873 7263 3029 2026 260a 2020  uous(src0) &&.  
-00029c50: 2020 2020 2020 6767 6d6c 5f69 735f 636f        ggml_is_co
-00029c60: 6e74 6967 756f 7573 2873 7263 3129 2026  ntiguous(src1) &
-00029c70: 2620 2828 6e65 3020 3e3d 2033 3220 2626  & ((ne0 >= 32 &&
-00029c80: 206e 6531 203e 3d20 3332 2026 2620 6e65   ne1 >= 32 && ne
-00029c90: 3130 203e 3d20 3332 2929 2920 7b0a 2020  10 >= 32))) {.  
-00029ca0: 2020 2020 2020 2f2f 7072 696e 7466 2822        //printf("
-00029cb0: 424c 4153 3a20 2564 2025 6420 2564 5c6e  BLAS: %d %d %d\n
-00029cc0: 222c 206e 6530 2c20 6e65 312c 206e 6531  ", ne0, ne1, ne1
-00029cd0: 3029 3b0a 2020 2020 2020 2020 7265 7475  0);.        retu
-00029ce0: 726e 2074 7275 653b 0a20 2020 207d 0a0a  rn true;.    }..
-00029cf0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
-00029d00: 3b0a 7d0a 2365 6e64 6966 0a0a 7374 6174  ;.}.#endif..stat
-00029d10: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00029d20: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
-00029d30: 5f6d 6174 5f66 3332 280a 2020 2020 2020  _mat_f32(.      
-00029d40: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00029d50: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00029d60: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00029d70: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00029d80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00029d90: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00029da0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00029db0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00029dc0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00029dd0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00029de0: 2a20 6473 7429 207b 0a20 2020 2069 6e74  * dst) {.    int
-00029df0: 3634 5f74 2074 3020 3d20 6767 6d6c 5f70  64_t t0 = ggml_p
-00029e00: 6572 665f 7469 6d65 5f75 7328 293b 0a20  erf_time_us();. 
-00029e10: 2020 2055 4e55 5345 4428 7430 293b 0a0a     UNUSED(t0);..
-00029e20: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-00029e30: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
-00029e40: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00029e50: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
-00029e60: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00029e70: 7420 6e65 3032 203d 2073 7263 302d 3e6e  t ne02 = src0->n
-00029e80: 655b 325d 3b0a 2020 2020 636f 6e73 7420  e[2];.    const 
-00029e90: 696e 7420 6e65 3033 203d 2073 7263 302d  int ne03 = src0-
-00029ea0: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
-00029eb0: 7374 2069 6e74 206e 6531 3020 3d20 7372  st int ne10 = sr
-00029ec0: 6331 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c1->ne[0];.    c
-00029ed0: 6f6e 7374 2069 6e74 206e 6531 3120 3d20  onst int ne11 = 
-00029ee0: 7372 6331 2d3e 6e65 5b31 5d3b 0a20 2020  src1->ne[1];.   
-00029ef0: 2063 6f6e 7374 2069 6e74 206e 6531 3220   const int ne12 
-00029f00: 3d20 7372 6331 2d3e 6e65 5b32 5d3b 0a20  = src1->ne[2];. 
-00029f10: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
-00029f20: 3320 3d20 7372 6331 2d3e 6e65 5b33 5d3b  3 = src1->ne[3];
-00029f30: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00029f40: 6e65 3020 203d 2064 7374 2d3e 6e65 5b30  ne0  = dst->ne[0
-00029f50: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00029f60: 206e 6531 2020 3d20 6473 742d 3e6e 655b   ne1  = dst->ne[
-00029f70: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00029f80: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
-00029f90: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
-00029fa0: 6e74 206e 6533 2020 3d20 6473 742d 3e6e  nt ne3  = dst->n
-00029fb0: 655b 335d 3b0a 2020 2020 636f 6e73 7420  e[3];.    const 
-00029fc0: 696e 7420 6e65 2020 203d 206e 6530 2a6e  int ne   = ne0*n
-00029fd0: 6531 2a6e 6532 2a6e 6533 3b0a 0a20 2020  e1*ne2*ne3;..   
-00029fe0: 2063 6f6e 7374 2069 6e74 206e 6230 3020   const int nb00 
-00029ff0: 3d20 7372 6330 2d3e 6e62 5b30 5d3b 0a20  = src0->nb[0];. 
-0002a000: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-0002a010: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
-0002a020: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0002a030: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
-0002a040: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0002a050: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
-0002a060: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0002a070: 696e 7420 6e62 3130 203d 2073 7263 312d  int nb10 = src1-
-0002a080: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0002a090: 7420 696e 7420 6e62 3131 203d 2073 7263  t int nb11 = src
-0002a0a0: 312d 3e6e 625b 315d 3b0a 2020 2020 636f  1->nb[1];.    co
-0002a0b0: 6e73 7420 696e 7420 6e62 3132 203d 2073  nst int nb12 = s
-0002a0c0: 7263 312d 3e6e 625b 325d 3b0a 2020 2020  rc1->nb[2];.    
-0002a0d0: 636f 6e73 7420 696e 7420 6e62 3133 203d  const int nb13 =
-0002a0e0: 2073 7263 312d 3e6e 625b 335d 3b0a 0a20   src1->nb[3];.. 
-0002a0f0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-0002a100: 2020 3d20 6473 742d 3e6e 625b 305d 3b0a    = dst->nb[0];.
-0002a110: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0002a120: 3120 203d 2064 7374 2d3e 6e62 5b31 5d3b  1  = dst->nb[1];
-0002a130: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0002a140: 6232 2020 3d20 6473 742d 3e6e 625b 325d  b2  = dst->nb[2]
-0002a150: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0002a160: 6e62 3320 203d 2064 7374 2d3e 6e62 5b33  nb3  = dst->nb[3
-0002a170: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-0002a180: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
-0002a190: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0002a1a0: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
-0002a1b0: 3e6e 7468 3b0a 0a20 2020 2061 7373 6572  >nth;..    asser
-0002a1c0: 7428 6e65 3032 203d 3d20 6e65 3132 293b  t(ne02 == ne12);
-0002a1d0: 0a20 2020 2061 7373 6572 7428 6e65 3033  .    assert(ne03
-0002a1e0: 203d 3d20 6e65 3133 293b 0a20 2020 2061   == ne13);.    a
-0002a1f0: 7373 6572 7428 6e65 3220 203d 3d20 6e65  ssert(ne2  == ne
-0002a200: 3132 293b 0a20 2020 2061 7373 6572 7428  12);.    assert(
-0002a210: 6e65 3320 203d 3d20 6e65 3133 293b 0a0a  ne3  == ne13);..
-0002a220: 2020 2020 2f2f 2054 4f44 4f3a 2077 6520      // TODO: we 
-0002a230: 646f 6e27 7420 7375 7070 6f72 7420 7065  don't support pe
-0002a240: 726d 7574 6564 2073 7263 300a 2020 2020  rmuted src0.    
-0002a250: 6173 7365 7274 286e 6230 3020 3d3d 2073  assert(nb00 == s
-0002a260: 697a 656f 6628 666c 6f61 7429 207c 7c20  izeof(float) || 
-0002a270: 6e62 3031 203d 3d20 7369 7a65 6f66 2866  nb01 == sizeof(f
-0002a280: 6c6f 6174 2929 3b0a 0a20 2020 202f 2f20  loat));..    // 
-0002a290: 6473 7420 6361 6e6e 6f74 2062 6520 7472  dst cannot be tr
-0002a2a0: 616e 7370 6f73 6564 206f 7220 7065 726d  ansposed or perm
-0002a2b0: 7574 6564 0a20 2020 2061 7373 6572 7428  uted.    assert(
-0002a2c0: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
-0002a2d0: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
-0002a2e0: 7428 6e62 3020 3c3d 206e 6231 293b 0a20  t(nb0 <= nb1);. 
-0002a2f0: 2020 2061 7373 6572 7428 6e62 3120 3c3d     assert(nb1 <=
-0002a300: 206e 6232 293b 0a20 2020 2061 7373 6572   nb2);.    asser
-0002a310: 7428 6e62 3220 3c3d 206e 6233 293b 0a0a  t(nb2 <= nb3);..
-0002a320: 2020 2020 6173 7365 7274 286e 6530 203d      assert(ne0 =
-0002a330: 3d20 6e65 3031 293b 0a20 2020 2061 7373  = ne01);.    ass
-0002a340: 6572 7428 6e65 3120 3d3d 206e 6531 3129  ert(ne1 == ne11)
-0002a350: 3b0a 2020 2020 6173 7365 7274 286e 6532  ;.    assert(ne2
-0002a360: 203d 3d20 6e65 3032 293b 0a20 2020 2061   == ne02);.    a
-0002a370: 7373 6572 7428 6e65 3320 3d3d 206e 6530  ssert(ne3 == ne0
-0002a380: 3329 3b0a 0a20 2020 202f 2f20 6e62 3031  3);..    // nb01
-0002a390: 203e 3d20 6e62 3030 202d 2073 7263 3020   >= nb00 - src0 
-0002a3a0: 6973 206e 6f74 2074 7261 6e73 706f 7365  is not transpose
-0002a3b0: 640a 2020 2020 2f2f 2020 2063 6f6d 7075  d.    //   compu
-0002a3c0: 7465 2062 7920 7372 6330 2072 6f77 730a  te by src0 rows.
-0002a3d0: 2020 2020 2f2f 0a20 2020 202f 2f20 6e62      //.    // nb
-0002a3e0: 3030 203c 2020 6e62 3031 202d 2073 7263  00 <  nb01 - src
-0002a3f0: 3020 6973 2074 7261 6e73 706f 7365 640a  0 is transposed.
-0002a400: 2020 2020 2f2f 2020 2063 6f6d 7075 7465      //   compute
-0002a410: 2062 7920 7372 6330 2063 6f6c 756d 6e73   by src0 columns
-0002a420: 0a0a 2369 6620 6465 6669 6e65 6428 4747  ..#if defined(GG
-0002a430: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
-0002a440: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
-0002a450: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
-0002a460: 0a20 2020 2069 6620 2867 676d 6c5f 636f  .    if (ggml_co
-0002a470: 6d70 7574 655f 666f 7277 6172 645f 6d75  mpute_forward_mu
-0002a480: 6c5f 6d61 745f 7573 655f 626c 6173 2873  l_mat_use_blas(s
-0002a490: 7263 302c 2073 7263 312c 2064 7374 2929  rc0, src1, dst))
-0002a4a0: 207b 0a20 2020 2020 2020 2047 474d 4c5f   {.        GGML_
-0002a4b0: 4153 5345 5254 286e 6231 3020 3d3d 2073  ASSERT(nb10 == s
-0002a4c0: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-0002a4d0: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
-0002a4e0: 6d73 2d3e 6974 6820 213d 2030 2920 7b0a  ms->ith != 0) {.
-0002a4f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002a500: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
-0002a510: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
-0002a520: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0002a530: 5441 534b 5f49 4e49 5429 207b 0a20 2020  TASK_INIT) {.   
-0002a540: 2020 2020 2020 2020 2072 6574 7572 6e3b           return;
-0002a550: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0002a560: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0002a570: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0002a580: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-0002a590: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a5a0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-0002a5b0: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
-0002a5c0: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
-0002a5d0: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
-0002a5e0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0002a5f0: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
-0002a600: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
-0002a610: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002a620: 6f6e 7374 2066 6c6f 6174 202a 2078 203d  onst float * x =
-0002a630: 2028 666c 6f61 7420 2a29 2028 7372 6330   (float *) (src0
-0002a640: 2d3e 6461 7461 293b 0a20 2020 2020 2020  ->data);.       
-0002a650: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0002a660: 6c6f 6174 202a 2079 203d 2028 666c 6f61  loat * y = (floa
-0002a670: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-0002a680: 7263 312d 3e64 6174 6120 2b20 6930 322a  rc1->data + i02*
-0002a690: 6e62 3132 202b 2069 3033 2a6e 6231 3329  nb12 + i03*nb13)
-0002a6a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0002a6b0: 2020 2066 6c6f 6174 202a 2064 203d 2028     float * d = (
-0002a6c0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-0002a6d0: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
-0002a6e0: 3032 2a6e 6232 202b 2069 3033 2a6e 6233  02*nb2 + i03*nb3
-0002a6f0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0002a700: 2020 2020 2f2f 207a 5420 3d20 7920 2a20      // zT = y * 
-0002a710: 7854 0a20 2020 2020 2020 2020 2020 2020  xT.             
-0002a720: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0002a730: 2020 2020 2020 2020 2063 626c 6173 5f73           cblas_s
-0002a740: 6765 6d6d 2843 626c 6173 526f 774d 616a  gemm(CblasRowMaj
-0002a750: 6f72 2c20 4362 6c61 734e 6f54 7261 6e73  or, CblasNoTrans
-0002a760: 2c20 4362 6c61 7354 7261 6e73 2c0a 2020  , CblasTrans,.  
-0002a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a780: 2020 2020 2020 2020 2020 6e65 3131 2c20            ne11, 
-0002a790: 6e65 3031 2c20 6e65 3130 2c0a 2020 2020  ne01, ne10,.    
-0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7b0: 2020 2020 2020 2020 312e 3066 2c20 2020          1.0f,   
-0002a7c0: 2079 2c20 6e65 3130 2c0a 2020 2020 2020   y, ne10,.      
-0002a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7e0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-0002a7f0: 2c20 6e65 3130 2c0a 2020 2020 2020 2020  , ne10,.        
-0002a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a810: 2020 2020 302e 3066 2c20 2020 2064 2c20      0.0f,    d, 
-0002a820: 6e65 3031 293b 0a20 2020 2020 2020 2020  ne01);.         
-0002a830: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0002a840: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0002a850: 0a0a 2020 2020 2020 2020 2f2f 7072 696e  ..        //prin
-0002a860: 7466 2822 4342 4c41 5320 4633 3220 3d20  tf("CBLAS F32 = 
-0002a870: 2566 206d 732c 2025 6420 7820 2564 2078  %f ms, %d x %d x
-0002a880: 2025 6420 7820 2564 5c6e 222c 2028 6767   %d x %d\n", (gg
-0002a890: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-0002a8a0: 2920 2d20 7430 292f 3130 3030 2e30 2c20  ) - t0)/1000.0, 
-0002a8b0: 6e65 302c 206e 6531 2c20 6e65 322c 206e  ne0, ne1, ne2, n
-0002a8c0: 6533 293b 0a0a 2020 2020 2020 2020 7265  e3);..        re
-0002a8d0: 7475 726e 3b0a 2020 2020 7d0a 2365 6e64  turn;.    }.#end
-0002a8e0: 6966 0a0a 2020 2020 6966 2028 7061 7261  if..    if (para
-0002a8f0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-0002a900: 5f54 4153 4b5f 494e 4954 2920 7b0a 2020  _TASK_INIT) {.  
-0002a910: 2020 2020 2020 6966 2028 6e62 3031 203e        if (nb01 >
-0002a920: 3d20 6e62 3030 2920 7b0a 2020 2020 2020  = nb00) {.      
-0002a930: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0002a940: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0002a950: 202f 2f20 544f 444f 3a20 6669 7820 7468   // TODO: fix th
-0002a960: 6973 206d 656d 7365 7420 2877 7369 7a65  is memset (wsize
-0002a970: 2069 7320 6f76 6572 6573 7469 6d61 7465   is overestimate
-0002a980: 6429 0a20 2020 2020 2020 206d 656d 7365  d).        memse
-0002a990: 7428 7061 7261 6d73 2d3e 7764 6174 612c  t(params->wdata,
-0002a9a0: 2030 2c20 7061 7261 6d73 2d3e 7773 697a   0, params->wsiz
-0002a9b0: 6529 3b0a 2020 2020 2020 2020 7265 7475  e);.        retu
-0002a9c0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
-0002a9d0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-0002a9e0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-0002a9f0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-0002aa00: 2069 6620 286e 6230 3120 3e3d 206e 6230   if (nb01 >= nb0
-0002aa10: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-0002aa20: 2072 6574 7572 6e3b 0a20 2020 2020 2020   return;.       
-0002aa30: 207d 0a0a 2020 2020 2020 2020 2f2f 2054   }..        // T
-0002aa40: 4f44 4f3a 2066 6978 2074 6869 7320 6d65  ODO: fix this me
-0002aa50: 6d73 6574 2028 7773 697a 6520 6973 206f  mset (wsize is o
-0002aa60: 7665 7265 7374 696d 6174 6564 290a 2020  verestimated).  
-0002aa70: 2020 2020 2020 2f2f 6173 7365 7274 2870        //assert(p
-0002aa80: 6172 616d 732d 3e77 7369 7a65 203d 3d20  arams->wsize == 
-0002aa90: 2867 676d 6c5f 6e62 7974 6573 2864 7374  (ggml_nbytes(dst
-0002aaa0: 2920 2b20 4341 4348 455f 4c49 4e45 5f53  ) + CACHE_LINE_S
-0002aab0: 495a 4529 2a6e 7468 293b 0a0a 2020 2020  IZE)*nth);..    
-0002aac0: 2020 2020 666c 6f61 7420 2a20 636f 6e73      float * cons
-0002aad0: 7420 7764 6174 6120 3d20 7061 7261 6d73  t wdata = params
-0002aae0: 2d3e 7764 6174 613b 0a0a 2020 2020 2020  ->wdata;..      
-0002aaf0: 2020 2f2f 2063 6f6c 7320 7065 7220 7468    // cols per th
-0002ab00: 7265 6164 0a20 2020 2020 2020 2063 6f6e  read.        con
-0002ab10: 7374 2069 6e74 2064 6320 3d20 286e 6520  st int dc = (ne 
-0002ab20: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
-0002ab30: 0a20 2020 2020 2020 202f 2f20 636f 6c20  .        // col 
-0002ab40: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
-0002ab50: 6872 6561 640a 2020 2020 2020 2020 636f  hread.        co
-0002ab60: 6e73 7420 696e 7420 6963 3020 3d20 6463  nst int ic0 = dc
-0002ab70: 2a69 7468 3b0a 2020 2020 2020 2020 636f  *ith;.        co
-0002ab80: 6e73 7420 696e 7420 6963 3120 3d20 4d49  nst int ic1 = MI
-0002ab90: 4e28 6963 3020 2b20 6463 2c20 6e65 293b  N(ic0 + dc, ne);
-0002aba0: 0a0a 2020 2020 2020 2020 6767 6d6c 5f76  ..        ggml_v
-0002abb0: 6563 5f63 7079 5f66 3332 2869 6331 202d  ec_cpy_f32(ic1 -
-0002abc0: 2069 6330 2c20 2866 6c6f 6174 202a 2920   ic0, (float *) 
-0002abd0: 6473 742d 3e64 6174 6120 2b20 6963 302c  dst->data + ic0,
-0002abe0: 2077 6461 7461 202b 2069 6330 293b 0a0a   wdata + ic0);..
-0002abf0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0002ac00: 206b 203d 2031 3b20 6b20 3c20 6e74 683b   k = 1; k < nth;
-0002ac10: 206b 2b2b 2920 7b0a 2020 2020 2020 2020   k++) {.        
-0002ac20: 2020 2020 6767 6d6c 5f76 6563 5f61 6363      ggml_vec_acc
-0002ac30: 5f66 3332 2869 6331 202d 2069 6330 2c20  _f32(ic1 - ic0, 
-0002ac40: 2866 6c6f 6174 202a 2920 6473 742d 3e64  (float *) dst->d
-0002ac50: 6174 6120 2b20 6963 302c 2077 6461 7461  ata + ic0, wdata
-0002ac60: 202b 2028 6e65 202b 2043 4143 4845 5f4c   + (ne + CACHE_L
-0002ac70: 494e 455f 5349 5a45 5f46 3332 292a 6b20  INE_SIZE_F32)*k 
-0002ac80: 2b20 6963 3029 3b0a 2020 2020 2020 2020  + ic0);.        
-0002ac90: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
-0002aca0: 6e3b 0a20 2020 207d 0a0a 2020 2020 6966  n;.    }..    if
-0002acb0: 2028 6e62 3031 203e 3d20 6e62 3030 2920   (nb01 >= nb00) 
-0002acc0: 7b0a 2020 2020 2020 2020 2f2f 2054 4f44  {.        // TOD
-0002acd0: 4f3a 2064 6f20 6e6f 7420 7375 7070 6f72  O: do not suppor
-0002ace0: 7420 7472 616e 7370 6f73 6564 2073 7263  t transposed src
-0002acf0: 310a 2020 2020 2020 2020 6173 7365 7274  1.        assert
-0002ad00: 286e 6231 3020 3d3d 2073 697a 656f 6628  (nb10 == sizeof(
-0002ad10: 666c 6f61 7429 293b 0a0a 2020 2020 2020  float));..      
-0002ad20: 2020 2f2f 2070 6172 616c 6c65 6c69 7a65    // parallelize
-0002ad30: 2062 7920 7372 6330 2072 6f77 7320 7573   by src0 rows us
-0002ad40: 696e 6720 6767 6d6c 5f76 6563 5f64 6f74  ing ggml_vec_dot
-0002ad50: 5f66 3332 0a0a 2020 2020 2020 2020 2f2f  _f32..        //
-0002ad60: 2074 6f74 616c 2072 6f77 7320 696e 2073   total rows in s
-0002ad70: 7263 300a 2020 2020 2020 2020 636f 6e73  rc0.        cons
-0002ad80: 7420 696e 7420 6e72 203d 206e 6530 312a  t int nr = ne01*
-0002ad90: 6e65 3032 2a6e 6530 333b 0a0a 2020 2020  ne02*ne03;..    
-0002ada0: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
-0002adb0: 7468 7265 6164 0a20 2020 2020 2020 2063  thread.        c
-0002adc0: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
-0002add0: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
-0002ade0: 3b0a 0a20 2020 2020 2020 202f 2f20 726f  ;..        // ro
-0002adf0: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
-0002ae00: 2074 6872 6561 640a 2020 2020 2020 2020   thread.        
-0002ae10: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-0002ae20: 6472 2a69 7468 3b0a 2020 2020 2020 2020  dr*ith;.        
-0002ae30: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
-0002ae40: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
-0002ae50: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
-0002ae60: 2869 6e74 2069 7220 3d20 6972 303b 2069  (int ir = ir0; i
-0002ae70: 7220 3c20 6972 313b 202b 2b69 7229 207b  r < ir1; ++ir) {
-0002ae80: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0002ae90: 7372 6330 2069 6e64 6963 6573 0a20 2020  src0 indices.   
-0002aea0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-0002aeb0: 6e74 2069 3033 203d 2069 722f 286e 6530  nt i03 = ir/(ne0
-0002aec0: 322a 6e65 3031 293b 0a20 2020 2020 2020  2*ne01);.       
-0002aed0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0002aee0: 3032 203d 2028 6972 202d 2069 3033 2a6e  02 = (ir - i03*n
-0002aef0: 6530 322a 6e65 3031 292f 6e65 3031 3b0a  e02*ne01)/ne01;.
-0002af00: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0002af10: 7420 696e 7420 6930 3120 3d20 2869 7220  t int i01 = (ir 
-0002af20: 2d20 6930 332a 6e65 3032 2a6e 6530 3120  - i03*ne02*ne01 
-0002af30: 2d20 6930 322a 6e65 3031 293b 0a0a 2020  - i02*ne01);..  
-0002af40: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0002af50: 6e74 2069 6320 3d20 303b 2069 6320 3c20  nt ic = 0; ic < 
-0002af60: 6e65 3131 3b20 2b2b 6963 2920 7b0a 2020  ne11; ++ic) {.  
-0002af70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0002af80: 2073 7263 3120 696e 6469 6365 730a 2020   src1 indices.  
-0002af90: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002afa0: 6e73 7420 696e 7420 6931 3320 3d20 6930  nst int i13 = i0
-0002afb0: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
-0002afc0: 2020 2063 6f6e 7374 2069 6e74 2069 3132     const int i12
-0002afd0: 203d 2069 3032 3b0a 2020 2020 2020 2020   = i02;.        
-0002afe0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0002aff0: 7420 6931 3120 3d20 6963 3b0a 0a20 2020  t i11 = ic;..   
-0002b000: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0002b010: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-0002b020: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0002b030: 7420 696e 7420 6930 203d 2069 3031 3b0a  t int i0 = i01;.
-0002b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b050: 636f 6e73 7420 696e 7420 6931 203d 2069  const int i1 = i
-0002b060: 3131 3b0a 2020 2020 2020 2020 2020 2020  11;.            
-0002b070: 2020 2020 636f 6e73 7420 696e 7420 6932      const int i2
-0002b080: 203d 2069 3032 3b0a 2020 2020 2020 2020   = i02;.        
-0002b090: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0002b0a0: 7420 6933 203d 2069 3033 3b0a 0a20 2020  t i3 = i03;..   
-0002b0b0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0002b0c0: 6c5f 7665 635f 646f 745f 6633 3228 6e65  l_vec_dot_f32(ne
-0002b0d0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-0002b0e0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-0002b0f0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-0002b100: 2064 7374 2d3e 6461 7461 202b 2028 6930   dst->data + (i0
-0002b110: 2a6e 6230 202b 2069 312a 6e62 3120 2b20  *nb0 + i1*nb1 + 
-0002b120: 6932 2a6e 6232 202b 2069 332a 6e62 3329  i2*nb2 + i3*nb3)
-0002b130: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0002b140: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-0002b150: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-0002b160: 7263 302d 3e64 6174 6120 2b20 2869 3031  rc0->data + (i01
-0002b170: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
-0002b180: 202b 2069 3033 2a6e 6230 3329 292c 0a20   + i03*nb03)),. 
-0002b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1a0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0002b1b0: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
-0002b1c0: 3e64 6174 6120 2b20 2869 3131 2a6e 6231  >data + (i11*nb1
-0002b1d0: 3120 2b20 6931 322a 6e62 3132 202b 2069  1 + i12*nb12 + i
-0002b1e0: 3133 2a6e 6231 3329 2929 3b0a 2020 2020  13*nb13)));.    
-0002b1f0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0002b200: 2020 7d0a 2020 2020 7d20 656c 7365 207b    }.    } else {
-0002b210: 0a20 2020 2020 2020 202f 2f20 7061 7261  .        // para
-0002b220: 6c6c 656c 697a 6520 6279 2073 7263 3120  llelize by src1 
-0002b230: 636f 6c75 6d6e 7320 7573 696e 6720 6767  columns using gg
-0002b240: 6d6c 5f76 6563 5f6d 6164 5f66 3332 0a20  ml_vec_mad_f32. 
-0002b250: 2020 2020 2020 202f 2f20 6561 6368 2074         // each t
-0002b260: 6872 6561 6420 6861 7320 6974 7320 6f77  hread has its ow
-0002b270: 6e20 776f 726b 2064 6174 610a 2020 2020  n work data.    
-0002b280: 2020 2020 2f2f 2064 7572 696e 6720 4649      // during FI
-0002b290: 4e41 4c49 5a45 2077 6520 6163 6375 6d75  NALIZE we accumu
-0002b2a0: 6c61 7465 2061 6c6c 2077 6f72 6b20 6461  late all work da
-0002b2b0: 7461 2069 6e74 6f20 6473 740a 0a20 2020  ta into dst..   
-0002b2c0: 2020 2020 202f 2f20 746f 7461 6c20 636f       // total co
-0002b2d0: 6c75 6d6e 7320 696e 2073 7263 310a 2020  lumns in src1.  
-0002b2e0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002b2f0: 6e63 203d 206e 6531 303b 0a0a 2020 2020  nc = ne10;..    
-0002b300: 2020 2020 2f2f 2063 6f6c 756d 6e73 2070      // columns p
-0002b310: 6572 2074 6872 6561 640a 2020 2020 2020  er thread.      
-0002b320: 2020 636f 6e73 7420 696e 7420 6463 203d    const int dc =
-0002b330: 2028 6e63 202b 206e 7468 202d 2031 292f   (nc + nth - 1)/
-0002b340: 6e74 683b 0a0a 2020 2020 2020 2020 2f2f  nth;..        //
-0002b350: 2063 6f6c 756d 6e20 7261 6e67 6520 666f   column range fo
-0002b360: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
-0002b370: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002b380: 6963 3020 3d20 6463 2a69 7468 3b0a 2020  ic0 = dc*ith;.  
-0002b390: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002b3a0: 6963 3120 3d20 4d49 4e28 6963 3020 2b20  ic1 = MIN(ic0 + 
-0002b3b0: 6463 2c20 6e63 293b 0a0a 2020 2020 2020  dc, nc);..      
-0002b3c0: 2020 2f2f 2077 6f72 6b20 6461 7461 2066    // work data f
-0002b3d0: 6f72 2074 6872 6561 640a 2020 2020 2020  or thread.      
-0002b3e0: 2020 636f 6e73 7420 696e 7420 776f 203d    const int wo =
-0002b3f0: 2028 6e65 202b 2043 4143 4845 5f4c 494e   (ne + CACHE_LIN
-0002b400: 455f 5349 5a45 5f46 3332 292a 6974 683b  E_SIZE_F32)*ith;
-0002b410: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-0002b420: 2063 6f6e 7374 2077 6461 7461 203d 2070   const wdata = p
-0002b430: 6172 616d 732d 3e77 6461 7461 3b0a 0a20  arams->wdata;.. 
-0002b440: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0002b450: 6931 3320 3d20 303b 2069 3133 203c 206e  i13 = 0; i13 < n
-0002b460: 6531 333b 202b 2b69 3133 2920 7b0a 2020  e13; ++i13) {.  
-0002b470: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0002b480: 6e74 2069 3132 203d 2030 3b20 6931 3220  nt i12 = 0; i12 
-0002b490: 3c20 6e65 3132 3b20 2b2b 6931 3229 207b  < ne12; ++i12) {
-0002b4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b4b0: 2066 6f72 2028 696e 7420 6931 3120 3d20   for (int i11 = 
-0002b4c0: 303b 2069 3131 203c 206e 6531 313b 202b  0; i11 < ne11; +
-0002b4d0: 2b69 3131 2920 7b0a 2020 2020 2020 2020  +i11) {.        
-0002b4e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002b4f0: 2869 6e74 2069 6320 3d20 6963 303b 2069  (int ic = ic0; i
-0002b500: 6320 3c20 6963 313b 202b 2b69 6329 207b  c < ic1; ++ic) {
-0002b510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b520: 2020 2020 2020 2020 202f 2f20 7372 6331           // src1
-0002b530: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-0002b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b550: 2063 6f6e 7374 2069 6e74 2069 3130 203d   const int i10 =
-0002b560: 2069 633b 0a0a 2020 2020 2020 2020 2020   ic;..          
-0002b570: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0002b580: 2073 7263 3020 696e 6469 6365 730a 2020   src0 indices.  
-0002b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5a0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002b5b0: 6930 3320 3d20 6931 333b 0a20 2020 2020  i03 = i13;.     
-0002b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5d0: 2020 2063 6f6e 7374 2069 6e74 2069 3032     const int i02
-0002b5e0: 203d 2069 3132 3b0a 2020 2020 2020 2020   = i12;.        
-0002b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b600: 636f 6e73 7420 696e 7420 6930 3020 3d20  const int i00 = 
-0002b610: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
-0002b620: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0002b630: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-0002b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b650: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
-0002b660: 203d 2069 3131 3b0a 2020 2020 2020 2020   = i11;.        
-0002b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b680: 636f 6e73 7420 696e 7420 6932 203d 2069  const int i2 = i
-0002b690: 3132 3b0a 2020 2020 2020 2020 2020 2020  12;.            
-0002b6a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0002b6b0: 7420 696e 7420 6933 203d 2069 3133 3b0a  t int i3 = i13;.
-0002b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b6d0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-0002b6e0: 7369 7a65 6f66 2866 6c6f 6174 292a 2877  sizeof(float)*(w
-0002b6f0: 6f20 2b20 6933 2a6e 6532 2a6e 6531 2a6e  o + i3*ne2*ne1*n
-0002b700: 6530 202b 2069 322a 6e65 312a 6e65 3020  e0 + i2*ne1*ne0 
-0002b710: 2b20 6931 2a6e 6530 202b 206e 6530 3129  + i1*ne0 + ne01)
-0002b720: 203c 3d20 7061 7261 6d73 2d3e 7773 697a   <= params->wsiz
-0002b730: 6529 3b0a 0a20 2020 2020 2020 2020 2020  e);..           
-0002b740: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0002b750: 6c5f 7665 635f 6d61 645f 6633 3228 6e65  l_vec_mad_f32(ne
-0002b760: 3031 2c0a 2020 2020 2020 2020 2020 2020  01,.            
-0002b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b780: 2020 2020 2866 6c6f 6174 202a 2920 2877      (float *) (w
-0002b790: 6461 7461 202b 2077 6f20 2b20 6933 2a6e  data + wo + i3*n
-0002b7a0: 6532 2a6e 6531 2a6e 6530 202b 2069 322a  e2*ne1*ne0 + i2*
-0002b7b0: 6e65 312a 6e65 3020 2b20 6931 2a6e 6530  ne1*ne0 + i1*ne0
-0002b7c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0002b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b7e0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0002b7f0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-0002b800: 6120 2b20 2869 3030 2a6e 6230 3020 2b20  a + (i00*nb00 + 
-0002b810: 6930 322a 6e62 3032 202b 2069 3033 2a6e  i02*nb02 + i03*n
-0002b820: 6230 3329 292c 0a20 2020 2020 2020 2020  b03)),.         
-0002b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b840: 2020 2020 2020 2a28 666c 6f61 7420 2a29        *(float *)
-0002b850: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
-0002b860: 3e64 6174 6120 2b20 2869 3130 2a6e 6231  >data + (i10*nb1
-0002b870: 3020 2b20 6931 312a 6e62 3131 202b 2069  0 + i11*nb11 + i
-0002b880: 3132 2a6e 6231 3220 2b20 6931 332a 6e62  12*nb12 + i13*nb
-0002b890: 3133 2929 293b 0a20 2020 2020 2020 2020  13)));.         
-0002b8a0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0002b8b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0002b8c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0002b8d0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0002b8e0: 2020 2f2f 696e 7436 345f 7420 7431 203d    //int64_t t1 =
-0002b8f0: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
-0002b900: 7573 2829 3b0a 2020 2020 2f2f 7374 6174  us();.    //stat
-0002b910: 6963 2069 6e74 3634 5f74 2061 6363 203d  ic int64_t acc =
-0002b920: 2030 3b0a 2020 2020 2f2f 6163 6320 2b3d   0;.    //acc +=
-0002b930: 2074 3120 2d20 7430 3b0a 2020 2020 2f2f   t1 - t0;.    //
-0002b940: 6966 2028 7431 202d 2074 3020 3e20 3130  if (t1 - t0 > 10
-0002b950: 2920 7b0a 2020 2020 2f2f 2020 2020 7072  ) {.    //    pr
-0002b960: 696e 7466 2822 5c6e 2229 3b0a 2020 2020  intf("\n");.    
-0002b970: 2f2f 2020 2020 7072 696e 7466 2822 6e65  //    printf("ne
-0002b980: 3030 203d 2025 3564 2c20 6e65 3031 203d  00 = %5d, ne01 =
-0002b990: 2025 3564 2c20 6e65 3032 203d 2025 3564   %5d, ne02 = %5d
-0002b9a0: 2c20 6e65 3033 203d 2025 3564 5c6e 222c  , ne03 = %5d\n",
-0002b9b0: 206e 6530 302c 206e 6530 312c 206e 6530   ne00, ne01, ne0
-0002b9c0: 322c 206e 6530 3329 3b0a 2020 2020 2f2f  2, ne03);.    //
-0002b9d0: 2020 2020 7072 696e 7466 2822 6e62 3030      printf("nb00
-0002b9e0: 203d 2025 3564 2c20 6e62 3031 203d 2025   = %5d, nb01 = %
-0002b9f0: 3564 2c20 6e62 3032 203d 2025 3564 2c20  5d, nb02 = %5d, 
-0002ba00: 6e62 3033 203d 2025 3564 5c6e 222c 206e  nb03 = %5d\n", n
-0002ba10: 6230 302c 206e 6230 312c 206e 6230 322c  b00, nb01, nb02,
-0002ba20: 206e 6230 3329 3b0a 2020 2020 2f2f 2020   nb03);.    //  
-0002ba30: 2020 7072 696e 7466 2822 6e65 3130 203d    printf("ne10 =
-0002ba40: 2025 3564 2c20 6e65 3131 203d 2025 3564   %5d, ne11 = %5d
-0002ba50: 2c20 6e65 3132 203d 2025 3564 2c20 6e65  , ne12 = %5d, ne
-0002ba60: 3133 203d 2025 3564 5c6e 222c 206e 6531  13 = %5d\n", ne1
-0002ba70: 302c 206e 6531 312c 206e 6531 322c 206e  0, ne11, ne12, n
-0002ba80: 6531 3329 3b0a 2020 2020 2f2f 2020 2020  e13);.    //    
-0002ba90: 7072 696e 7466 2822 6e62 3130 203d 2025  printf("nb10 = %
-0002baa0: 3564 2c20 6e62 3131 203d 2025 3564 2c20  5d, nb11 = %5d, 
-0002bab0: 6e62 3132 203d 2025 3564 2c20 6e62 3133  nb12 = %5d, nb13
-0002bac0: 203d 2025 3564 5c6e 222c 206e 6231 302c   = %5d\n", nb10,
-0002bad0: 206e 6231 312c 206e 6231 322c 206e 6231   nb11, nb12, nb1
-0002bae0: 3329 3b0a 0a20 2020 202f 2f20 2020 2070  3);..    //    p
-0002baf0: 7269 6e74 6628 2258 5858 5858 5858 5858  rintf("XXXXXXXXX
-0002bb00: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-0002bb10: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-0002bb20: 5858 5858 5858 5858 5858 5820 7461 736b  XXXXXXXXXXX task
-0002bb30: 2025 642f 2564 3a20 2564 2075 732c 2061   %d/%d: %d us, a
-0002bb40: 6363 203d 2025 645c 6e22 2c20 6974 682c  cc = %d\n", ith,
-0002bb50: 206e 7468 2c20 2869 6e74 2920 2874 3120   nth, (int) (t1 
-0002bb60: 2d20 7430 292c 2028 696e 7429 2061 6363  - t0), (int) acc
-0002bb70: 293b 0a20 2020 202f 2f7d 0a7d 0a0a 7374  );.    //}.}..st
-0002bb80: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0002bb90: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-0002bba0: 756c 5f6d 6174 5f66 3136 5f66 3332 280a  ul_mat_f16_f32(.
-0002bbb0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0002bbc0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0002bbd0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-0002bbe0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-0002bbf0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0002bc00: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-0002bc10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0002bc20: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-0002bc30: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
-0002bc40: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002bc50: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-0002bc60: 2020 2069 6e74 3634 5f74 2074 3020 3d20     int64_t t0 = 
-0002bc70: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
-0002bc80: 7328 293b 0a20 2020 2055 4e55 5345 4428  s();.    UNUSED(
-0002bc90: 7430 293b 0a0a 2020 2020 636f 6e73 7420  t0);..    const 
-0002bca0: 696e 7420 6e65 3030 203d 2073 7263 302d  int ne00 = src0-
-0002bcb0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-0002bcc0: 7420 696e 7420 6e65 3031 203d 2073 7263  t int ne01 = src
-0002bcd0: 302d 3e6e 655b 315d 3b0a 2020 2020 636f  0->ne[1];.    co
-0002bce0: 6e73 7420 696e 7420 6e65 3032 203d 2073  nst int ne02 = s
-0002bcf0: 7263 302d 3e6e 655b 325d 3b0a 2020 2020  rc0->ne[2];.    
-0002bd00: 636f 6e73 7420 696e 7420 6e65 3033 203d  const int ne03 =
-0002bd10: 2073 7263 302d 3e6e 655b 335d 3b0a 0a20   src0->ne[3];.. 
-0002bd20: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
-0002bd30: 3020 3d20 7372 6331 2d3e 6e65 5b30 5d3b  0 = src1->ne[0];
-0002bd40: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0002bd50: 6531 3120 3d20 7372 6331 2d3e 6e65 5b31  e11 = src1->ne[1
-0002bd60: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0002bd70: 206e 6531 3220 3d20 7372 6331 2d3e 6e65   ne12 = src1->ne
-0002bd80: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
-0002bd90: 6e74 206e 6531 3320 3d20 7372 6331 2d3e  nt ne13 = src1->
-0002bda0: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-0002bdb0: 7420 696e 7420 6e65 3020 203d 2064 7374  t int ne0  = dst
-0002bdc0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-0002bdd0: 7374 2069 6e74 206e 6531 2020 3d20 6473  st int ne1  = ds
-0002bde0: 742d 3e6e 655b 315d 3b0a 2020 2020 636f  t->ne[1];.    co
-0002bdf0: 6e73 7420 696e 7420 6e65 3220 203d 2064  nst int ne2  = d
-0002be00: 7374 2d3e 6e65 5b32 5d3b 0a20 2020 2063  st->ne[2];.    c
-0002be10: 6f6e 7374 2069 6e74 206e 6533 2020 3d20  onst int ne3  = 
-0002be20: 6473 742d 3e6e 655b 335d 3b0a 2020 2020  dst->ne[3];.    
-0002be30: 636f 6e73 7420 696e 7420 6e65 2020 203d  const int ne   =
-0002be40: 206e 6530 2a6e 6531 2a6e 6532 2a6e 6533   ne0*ne1*ne2*ne3
-0002be50: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0002be60: 206e 6230 3020 3d20 7372 6330 2d3e 6e62   nb00 = src0->nb
-0002be70: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0002be80: 6e74 206e 6230 3120 3d20 7372 6330 2d3e  nt nb01 = src0->
-0002be90: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-0002bea0: 2069 6e74 206e 6230 3220 3d20 7372 6330   int nb02 = src0
-0002beb0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-0002bec0: 7374 2069 6e74 206e 6230 3320 3d20 7372  st int nb03 = sr
-0002bed0: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
-0002bee0: 636f 6e73 7420 696e 7420 6e62 3130 203d  const int nb10 =
-0002bef0: 2073 7263 312d 3e6e 625b 305d 3b0a 2020   src1->nb[0];.  
-0002bf00: 2020 636f 6e73 7420 696e 7420 6e62 3131    const int nb11
-0002bf10: 203d 2073 7263 312d 3e6e 625b 315d 3b0a   = src1->nb[1];.
-0002bf20: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0002bf30: 3132 203d 2073 7263 312d 3e6e 625b 325d  12 = src1->nb[2]
-0002bf40: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0002bf50: 6e62 3133 203d 2073 7263 312d 3e6e 625b  nb13 = src1->nb[
-0002bf60: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-0002bf70: 6e74 206e 6230 2020 3d20 6473 742d 3e6e  nt nb0  = dst->n
-0002bf80: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-0002bf90: 696e 7420 6e62 3120 203d 2064 7374 2d3e  int nb1  = dst->
-0002bfa0: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-0002bfb0: 2069 6e74 206e 6232 2020 3d20 6473 742d   int nb2  = dst-
-0002bfc0: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-0002bfd0: 7420 696e 7420 6e62 3320 203d 2064 7374  t int nb3  = dst
-0002bfe0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-0002bff0: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
-0002c000: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
-0002c010: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
-0002c020: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
-0002c030: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-0002c040: 3220 3d3d 206e 6531 3229 3b0a 2020 2020  2 == ne12);.    
-0002c050: 4747 4d4c 5f41 5353 4552 5428 6e65 3033  GGML_ASSERT(ne03
-0002c060: 203d 3d20 6e65 3133 293b 0a20 2020 2047   == ne13);.    G
-0002c070: 474d 4c5f 4153 5345 5254 286e 6532 2020  GML_ASSERT(ne2  
-0002c080: 3d3d 206e 6531 3229 3b0a 2020 2020 4747  == ne12);.    GG
-0002c090: 4d4c 5f41 5353 4552 5428 6e65 3320 203d  ML_ASSERT(ne3  =
-0002c0a0: 3d20 6e65 3133 293b 0a0a 2020 2020 2f2f  = ne13);..    //
-0002c0b0: 2054 4f44 4f3a 2077 6520 646f 6e27 7420   TODO: we don't 
-0002c0c0: 7375 7070 6f72 7420 7065 726d 7574 6564  support permuted
-0002c0d0: 2073 7263 300a 2020 2020 4747 4d4c 5f41   src0.    GGML_A
-0002c0e0: 5353 4552 5428 6e62 3030 203d 3d20 7369  SSERT(nb00 == si
-0002c0f0: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
-0002c100: 2920 7c7c 206e 6230 3120 3d3d 2073 697a  ) || nb01 == siz
-0002c110: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-0002c120: 293b 0a0a 2020 2020 2f2f 2064 7374 2063  );..    // dst c
-0002c130: 616e 6e6f 7420 6265 2074 7261 6e73 706f  annot be transpo
-0002c140: 7365 6420 6f72 2070 6572 6d75 7465 640a  sed or permuted.
-0002c150: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0002c160: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
-0002c170: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-0002c180: 4153 5345 5254 286e 6230 203c 3d20 6e62  ASSERT(nb0 <= nb
-0002c190: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
-0002c1a0: 4552 5428 6e62 3120 3c3d 206e 6232 293b  ERT(nb1 <= nb2);
-0002c1b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0002c1c0: 286e 6232 203c 3d20 6e62 3329 3b0a 0a20  (nb2 <= nb3);.. 
-0002c1d0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0002c1e0: 6530 203d 3d20 6e65 3031 293b 0a20 2020  e0 == ne01);.   
-0002c1f0: 2047 474d 4c5f 4153 5345 5254 286e 6531   GGML_ASSERT(ne1
-0002c200: 203d 3d20 6e65 3131 293b 0a20 2020 2047   == ne11);.    G
-0002c210: 474d 4c5f 4153 5345 5254 286e 6532 203d  GML_ASSERT(ne2 =
-0002c220: 3d20 6e65 3032 293b 0a20 2020 2047 474d  = ne02);.    GGM
-0002c230: 4c5f 4153 5345 5254 286e 6533 203d 3d20  L_ASSERT(ne3 == 
-0002c240: 6e65 3033 293b 0a0a 2020 2020 2f2f 206e  ne03);..    // n
-0002c250: 6230 3120 3e3d 206e 6230 3020 2d20 7372  b01 >= nb00 - sr
-0002c260: 6330 2069 7320 6e6f 7420 7472 616e 7370  c0 is not transp
-0002c270: 6f73 6564 0a20 2020 202f 2f20 2020 636f  osed.    //   co
-0002c280: 6d70 7574 6520 6279 2073 7263 3020 726f  mpute by src0 ro
-0002c290: 7773 0a20 2020 202f 2f0a 2020 2020 2f2f  ws.    //.    //
-0002c2a0: 206e 6230 3020 3c20 206e 6230 3120 2d20   nb00 <  nb01 - 
-0002c2b0: 7372 6330 2069 7320 7472 616e 7370 6f73  src0 is transpos
-0002c2c0: 6564 0a20 2020 202f 2f20 2020 636f 6d70  ed.    //   comp
-0002c2d0: 7574 6520 6279 2073 7263 3020 636f 6c75  ute by src0 colu
-0002c2e0: 6d6e 730a 0a23 6966 2064 6566 696e 6564  mns..#if defined
-0002c2f0: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
-0002c300: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
-0002c310: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
-0002c320: 4153 290a 2020 2020 6966 2028 6767 6d6c  AS).    if (ggml
-0002c330: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0002c340: 5f6d 756c 5f6d 6174 5f75 7365 5f62 6c61  _mul_mat_use_bla
-0002c350: 7328 7372 6330 2c20 7372 6331 2c20 6473  s(src0, src1, ds
-0002c360: 7429 2920 7b0a 2020 2020 2020 2020 4747  t)) {.        GG
-0002c370: 4d4c 5f41 5353 4552 5428 6e62 3130 203d  ML_ASSERT(nb10 =
-0002c380: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0002c390: 3b0a 0a20 2020 2020 2020 2069 6620 2870  ;..        if (p
-0002c3a0: 6172 616d 732d 3e69 7468 2021 3d20 3029  arams->ith != 0)
-0002c3b0: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
-0002c3c0: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
-0002c3d0: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
-0002c3e0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0002c3f0: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
-0002c400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002c410: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
-0002c420: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
-0002c430: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0002c440: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-0002c450: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002c460: 7572 6e3b 0a20 2020 2020 2020 207d 0a0a  urn;.        }..
-0002c470: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-0002c480: 636f 6e73 7420 7764 6174 6120 3d20 7061  const wdata = pa
-0002c490: 7261 6d73 2d3e 7764 6174 613b 0a0a 2020  rams->wdata;..  
-0002c4a0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0002c4b0: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
-0002c4c0: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
-0002c4d0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0002c4e0: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
-0002c4f0: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
-0002c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c510: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0002c520: 2020 2020 2020 696e 7420 6964 203d 2030        int id = 0
-0002c530: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0002c540: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0002c550: 3031 203d 2030 3b20 6930 3120 3c20 6e65  01 = 0; i01 < ne
-0002c560: 3031 3b20 2b2b 6930 3129 207b 0a20 2020  01; ++i01) {.   
-0002c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c580: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
-0002c590: 3020 3d20 303b 2069 3030 203c 206e 6530  0 = 0; i00 < ne0
-0002c5a0: 303b 202b 2b69 3030 2920 7b0a 2020 2020  0; ++i00) {.    
-0002c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c5c0: 2020 2020 2020 2020 7764 6174 615b 6964          wdata[id
-0002c5d0: 2b2b 5d20 3d20 4747 4d4c 5f46 5031 365f  ++] = GGML_FP16_
-0002c5e0: 544f 5f46 5033 3228 2a28 6767 6d6c 5f66  TO_FP32(*(ggml_f
-0002c5f0: 7031 365f 7420 2a29 2028 2863 6861 7220  p16_t *) ((char 
-0002c600: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-0002c610: 6930 332a 6e62 3033 202b 2069 3032 2a6e  i03*nb03 + i02*n
-0002c620: 6230 3220 2b20 6930 312a 6e62 3031 202b  b02 + i01*nb01 +
-0002c630: 2069 3030 2a6e 6230 3029 293b 0a20 2020   i00*nb00));.   
-0002c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c650: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0002c660: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0002c670: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0002c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c690: 636f 6e73 7420 666c 6f61 7420 2a20 7820  const float * x 
-0002c6a0: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
-0002c6b0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0002c6c0: 6c6f 6174 202a 2079 203d 2028 666c 6f61  loat * y = (floa
-0002c6d0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-0002c6e0: 7263 312d 3e64 6174 6120 2b20 6930 322a  rc1->data + i02*
-0002c6f0: 6e62 3132 202b 2069 3033 2a6e 6231 3329  nb12 + i03*nb13)
-0002c700: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0002c710: 2020 202f 2f20 2020 2020 2066 6c6f 6174     //      float
-0002c720: 202a 207a 203d 2020 2020 2020 2020 2020   * z =          
-0002c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c740: 7764 6174 6120 2b20 6e65 3030 2a6e 6530  wdata + ne00*ne0
-0002c750: 313b 0a0a 2020 2020 2020 2020 2020 2020  1;..            
-0002c760: 2020 2020 2f2f 207a 203d 2078 202a 2079      // z = x * y
-0002c770: 540a 2020 2020 2020 2020 2020 2020 2020  T.              
-0002c780: 2020 2f2f 7b0a 2020 2020 2020 2020 2020    //{.          
-0002c790: 2020 2020 2020 2f2f 2020 2020 6362 6c61        //    cbla
-0002c7a0: 735f 7367 656d 6d28 4362 6c61 7352 6f77  s_sgemm(CblasRow
-0002c7b0: 4d61 6a6f 722c 2043 626c 6173 4e6f 5472  Major, CblasNoTr
-0002c7c0: 616e 732c 2043 626c 6173 5472 616e 732c  ans, CblasTrans,
-0002c7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c7e0: 202f 2f20 2020 2020 2020 2020 2020 206e   //            n
-0002c7f0: 6530 312c 206e 6531 312c 206e 6530 302c  e01, ne11, ne00,
-0002c800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c810: 202f 2f20 2020 2020 2020 2020 2020 2031   //            1
-0002c820: 2e30 662c 2078 2c20 6e65 3030 2c0a 2020  .0f, x, ne00,.  
-0002c830: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0002c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c850: 2020 792c 206e 6530 302c 0a20 2020 2020    y, ne00,.     
-0002c860: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
-0002c870: 2020 2020 2020 2020 2030 2e30 662c 207a           0.0f, z
-0002c880: 2c20 6e65 3131 293b 0a20 2020 2020 2020  , ne11);.       
-0002c890: 2020 2020 2020 2020 202f 2f7d 0a0a 2020           //}..  
-0002c8a0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-0002c8b0: 6f61 7420 2a20 6420 3d20 2866 6c6f 6174  oat * d = (float
-0002c8c0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-0002c8d0: 742d 3e64 6174 6120 2b20 6930 322a 6e62  t->data + i02*nb
-0002c8e0: 3220 2b20 6930 332a 6e62 3329 3b0a 0a20  2 + i03*nb3);.. 
-0002c8f0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0002c900: 2f20 7472 616e 7370 6f73 6520 7a0a 2020  / transpose z.  
-0002c910: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0002c920: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-0002c930: 6a20 3c20 6e65 3131 3b20 2b2b 6a29 207b  j < ne11; ++j) {
-0002c940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c950: 202f 2f20 2020 2066 6f72 2028 696e 7420   //    for (int 
-0002c960: 6920 3d20 303b 2069 203c 206e 6530 313b  i = 0; i < ne01;
-0002c970: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0002c980: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
-0002c990: 2020 645b 6a2a 6e65 3031 202b 2069 5d20    d[j*ne01 + i] 
-0002c9a0: 3d20 7a5b 692a 6e65 3131 202b 206a 5d3b  = z[i*ne11 + j];
-0002c9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c9c0: 202f 2f20 2020 207d 0a20 2020 2020 2020   //    }.       
-0002c9d0: 2020 2020 2020 2020 202f 2f7d 0a0a 2020           //}..  
-0002c9e0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0002c9f0: 2369 6620 310a 2020 2020 2020 2020 2020  #if 1.          
-0002ca00: 2020 2020 2020 2020 2020 2f2f 207a 5420            // zT 
-0002ca10: 3d20 7920 2a20 7854 0a20 2020 2020 2020  = y * xT.       
-0002ca20: 2020 2020 2020 2020 2020 2020 2063 626c               cbl
-0002ca30: 6173 5f73 6765 6d6d 2843 626c 6173 526f  as_sgemm(CblasRo
-0002ca40: 774d 616a 6f72 2c20 4362 6c61 734e 6f54  wMajor, CblasNoT
-0002ca50: 7261 6e73 2c20 4362 6c61 7354 7261 6e73  rans, CblasTrans
-0002ca60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ca70: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0002ca80: 3131 2c20 6e65 3031 2c20 6e65 3130 2c0a  11, ne01, ne10,.
-0002ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002caa0: 2020 2020 2020 2020 2020 2020 312e 3066              1.0f
-0002cab0: 2c20 2020 2079 2c20 6e65 3030 2c0a 2020  ,    y, ne00,.  
-0002cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cae0: 2020 2078 2c20 6e65 3030 2c0a 2020 2020     x, ne00,.    
-0002caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cb00: 2020 2020 2020 2020 302e 3066 2c20 2020          0.0f,   
-0002cb10: 2064 2c20 6e65 3031 293b 0a23 656c 7365   d, ne01);.#else
-0002cb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cb30: 2020 2020 202f 2f20 7a54 203d 2028 7854       // zT = (xT
-0002cb40: 202a 2079 2954 0a20 2020 2020 2020 2020   * y)T.         
-0002cb50: 2020 2020 2020 2020 2020 2063 626c 6173             cblas
-0002cb60: 5f73 6765 6d6d 2843 626c 6173 436f 6c4d  _sgemm(CblasColM
-0002cb70: 616a 6f72 2c20 4362 6c61 7354 7261 6e73  ajor, CblasTrans
-0002cb80: 2c20 4362 6c61 734e 6f54 7261 6e73 2c0a  , CblasNoTrans,.
-0002cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cba0: 2020 2020 2020 2020 2020 2020 6e65 3031              ne01
-0002cbb0: 2c20 6e65 3131 2c20 6e65 3130 2c0a 2020  , ne11, ne10,.  
-0002cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cbd0: 2020 2020 2020 2020 2020 312e 3066 2c20            1.0f, 
-0002cbe0: 2020 2078 2c20 6e65 3030 2c0a 2020 2020     x, ne00,.    
-0002cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc10: 2079 2c20 6e65 3030 2c0a 2020 2020 2020   y, ne00,.      
-0002cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc30: 2020 2020 2020 302e 3066 2c20 2020 2064        0.0f,    d
-0002cc40: 2c20 6e65 3031 293b 0a23 656e 6469 660a  , ne01);.#endif.
-0002cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc60: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0002cc70: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0002cc80: 2020 202f 2a70 7269 6e74 6628 2243 424c     /*printf("CBL
-0002cc90: 4153 2046 3136 203d 2025 6620 6d73 2c20  AS F16 = %f ms, 
-0002cca0: 2564 2078 2025 6420 7820 2564 2078 2025  %d x %d x %d x %
-0002ccb0: 645c 6e22 2c20 2867 676d 6c5f 7065 7266  d\n", (ggml_perf
-0002ccc0: 5f74 696d 655f 7573 2829 202d 2074 3029  _time_us() - t0)
-0002ccd0: 2f31 3030 302e 302c 206e 6530 2c20 6e65  /1000.0, ne0, ne
-0002cce0: 312c 206e 6532 2c20 6e65 3329 3b2a 2f0a  1, ne2, ne3);*/.
-0002ccf0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-0002cd00: 0a20 2020 207d 0a23 656e 6469 660a 0a20  .    }.#endif.. 
-0002cd10: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0002cd20: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0002cd30: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
-0002cd40: 2069 6620 286e 6230 3120 3e3d 206e 6230   if (nb01 >= nb0
-0002cd50: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-0002cd60: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-0002cd70: 6f6e 7374 2077 6461 7461 203d 2070 6172  onst wdata = par
-0002cd80: 616d 732d 3e77 6461 7461 3b0a 0a20 2020  ams->wdata;..   
-0002cd90: 2020 2020 2020 2020 2069 6e74 2069 6420           int id 
-0002cda0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-0002cdb0: 2066 6f72 2028 696e 7420 6931 3320 3d20   for (int i13 = 
-0002cdc0: 303b 2069 3133 203c 206e 6531 333b 202b  0; i13 < ne13; +
-0002cdd0: 2b69 3133 2920 7b0a 2020 2020 2020 2020  +i13) {.        
-0002cde0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0002cdf0: 2069 3132 203d 2030 3b20 6931 3220 3c20   i12 = 0; i12 < 
-0002ce00: 6e65 3132 3b20 2b2b 6931 3229 207b 0a20  ne12; ++i12) {. 
+00024340: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
+00024350: 6464 0a0a 7374 6174 6963 2076 6f69 6420  dd..static void 
+00024360: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00024370: 7761 7264 5f61 6464 5f66 3332 280a 2020  ward_add_f32(.  
+00024380: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00024390: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000243a0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000243b0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000243c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000243d0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+000243e0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000243f0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00024400: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+00024410: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00024420: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+00024430: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
+00024440: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+00024450: 2073 7263 3129 2026 2620 6767 6d6c 5f61   src1) && ggml_a
+00024460: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
+00024470: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
+00024480: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00024490: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+000244a0: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+000244b0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000244c0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+000244d0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000244e0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+000244f0: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+00024500: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00024510: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+00024520: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+00024530: 696e 7420 6e20 203d 2067 676d 6c5f 6e72  int n  = ggml_nr
+00024540: 6f77 7328 7372 6330 293b 0a20 2020 2063  ows(src0);.    c
+00024550: 6f6e 7374 2069 6e74 206e 6320 3d20 7372  onst int nc = sr
+00024560: 6330 2d3e 6e65 5b30 5d3b 0a0a 2020 2020  c0->ne[0];..    
+00024570: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00024580: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
+00024590: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+000245a0: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+000245b0: 625b 315d 3b0a 0a20 2020 2063 6f6e 7374  b[1];..    const
+000245c0: 2073 697a 655f 7420 6e62 3130 203d 2073   size_t nb10 = s
+000245d0: 7263 312d 3e6e 625b 305d 3b0a 2020 2020  rc1->nb[0];.    
+000245e0: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
+000245f0: 3120 3d20 7372 6331 2d3e 6e62 5b31 5d3b  1 = src1->nb[1];
+00024600: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+00024610: 5f74 206e 6230 203d 2064 7374 2d3e 6e62  _t nb0 = dst->nb
+00024620: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
+00024630: 697a 655f 7420 6e62 3120 3d20 6473 742d  ize_t nb1 = dst-
+00024640: 3e6e 625b 315d 3b0a 0a20 2020 2047 474d  >nb[1];..    GGM
+00024650: 4c5f 4153 5345 5254 2820 6e62 3020 3d3d  L_ASSERT( nb0 ==
+00024660: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00024670: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00024680: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
+00024690: 666c 6f61 7429 293b 0a0a 2020 2020 6966  float));..    if
+000246a0: 2028 6e62 3130 203d 3d20 7369 7a65 6f66   (nb10 == sizeof
+000246b0: 2866 6c6f 6174 2929 207b 0a20 2020 2020  (float)) {.     
+000246c0: 2020 2063 6f6e 7374 2069 6e74 206a 3020     const int j0 
+000246d0: 3d20 286e 2f6e 7468 292a 6974 683b 0a20  = (n/nth)*ith;. 
+000246e0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+000246f0: 206a 3120 3d20 6974 6820 3d3d 206e 7468   j1 = ith == nth
+00024700: 202d 2031 203f 206e 203a 2028 6e2f 6e74   - 1 ? n : (n/nt
+00024710: 6829 2a28 6974 6820 2b20 3129 3b0a 0a20  h)*(ith + 1);.. 
+00024720: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00024730: 6a20 3d20 6a30 3b20 6a20 3c20 6a31 3b20  j = j0; j < j1; 
+00024740: 6a2b 2b29 207b 0a20 2020 2020 2020 2020  j++) {.         
+00024750: 2020 2067 676d 6c5f 7665 635f 6164 645f     ggml_vec_add_
+00024760: 6633 3228 6e63 2c0a 2020 2020 2020 2020  f32(nc,.        
+00024770: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+00024780: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00024790: 6473 742d 3e64 6174 6120 202b 206a 2a6e  dst->data  + j*n
+000247a0: 6231 292c 0a20 2020 2020 2020 2020 2020  b1),.           
+000247b0: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+000247c0: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+000247d0: 302d 3e64 6174 6120 2b20 6a2a 6e62 3031  0->data + j*nb01
+000247e0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000247f0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+00024800: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
+00024810: 3e64 6174 6120 2b20 6a2a 6e62 3131 2929  >data + j*nb11))
+00024820: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00024830: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00024840: 202f 2f20 7372 6331 2069 7320 6e6f 7420   // src1 is not 
+00024850: 636f 6e74 6967 756f 7573 0a20 2020 2020  contiguous.     
+00024860: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+00024870: 6974 683b 206a 203c 206e 3b20 6a20 2b3d  ith; j < n; j +=
+00024880: 206e 7468 2920 7b0a 2020 2020 2020 2020   nth) {.        
+00024890: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
+000248a0: 7074 7220 203d 2028 666c 6f61 7420 2a29  ptr  = (float *)
+000248b0: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+000248c0: 6461 7461 2020 2b20 6a2a 6e62 3129 3b0a  data  + j*nb1);.
+000248d0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000248e0: 7420 2a20 7372 6330 5f70 7472 203d 2028  t * src0_ptr = (
+000248f0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+00024900: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00024910: 6a2a 6e62 3031 293b 0a20 2020 2020 2020  j*nb01);.       
+00024920: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00024930: 3d20 303b 2069 203c 206e 633b 2069 2b2b  = 0; i < nc; i++
+00024940: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00024950: 2020 2020 666c 6f61 7420 2a20 7372 6331      float * src1
+00024960: 5f70 7472 203d 2028 666c 6f61 7420 2a29  _ptr = (float *)
+00024970: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
+00024980: 3e64 6174 6120 2b20 6a2a 6e62 3131 202b  >data + j*nb11 +
+00024990: 2069 2a6e 6231 3029 3b0a 0a20 2020 2020   i*nb10);..     
+000249a0: 2020 2020 2020 2020 2020 2064 7374 5f70             dst_p
+000249b0: 7472 5b69 5d20 3d20 7372 6330 5f70 7472  tr[i] = src0_ptr
+000249c0: 5b69 5d20 2b20 2a73 7263 315f 7074 723b  [i] + *src1_ptr;
+000249d0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+000249e0: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+000249f0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00024a00: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00024a10: 7264 5f61 6464 280a 2020 2020 2020 2020  rd_add(.        
+00024a20: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00024a30: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00024a40: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00024a50: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00024a60: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00024a70: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+00024a80: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00024a90: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+00024aa0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00024ab0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00024ac0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+00024ad0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+00024ae0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00024af0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+00024b00: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00024b10: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00024b20: 655f 666f 7277 6172 645f 6164 645f 6633  e_forward_add_f3
+00024b30: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+00024b40: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+00024b50: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00024b60: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00024b70: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
+00024b80: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00024b90: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
+00024ba0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00024bb0: 455f 4938 3a0a 2020 2020 2020 2020 6361  E_I8:.        ca
+00024bc0: 7365 2047 474d 4c5f 5459 5045 5f49 3136  se GGML_TYPE_I16
+00024bd0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00024be0: 474d 4c5f 5459 5045 5f49 3332 3a0a 2020  GML_TYPE_I32:.  
+00024bf0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00024c00: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
+00024c10: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00024c20: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
+00024c30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00024c40: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00024c50: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+00024c60: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00024c70: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
+00024c80: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00024c90: 7375 620a 0a73 7461 7469 6320 766f 6964  sub..static void
+00024ca0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00024cb0: 7277 6172 645f 7375 625f 6633 3228 0a20  rward_sub_f32(. 
+00024cc0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00024cd0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00024ce0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00024cf0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00024d00: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00024d10: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00024d20: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00024d30: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00024d40: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+00024d50: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00024d60: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+00024d70: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
+00024d80: 3d20 3029 3b0a 2020 2020 6173 7365 7274  = 0);.    assert
+00024d90: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+00024da0: 6861 7065 2873 7263 302c 2073 7263 3129  hape(src0, src1)
+00024db0: 2026 2620 6767 6d6c 5f61 7265 5f73 616d   && ggml_are_sam
+00024dc0: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
+00024dd0: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
+00024de0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00024df0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00024e00: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00024e10: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00024e20: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00024e30: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00024e40: 2063 6f6e 7374 2069 6e74 206e 2020 3d20   const int n  = 
+00024e50: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+00024e60: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00024e70: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
+00024e80: 3b0a 0a20 2020 2061 7373 6572 7428 2064  ;..    assert( d
+00024e90: 7374 2d3e 6e62 5b30 5d20 3d3d 2073 697a  st->nb[0] == siz
+00024ea0: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
+00024eb0: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
+00024ec0: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+00024ed0: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
+00024ee0: 7428 7372 6331 2d3e 6e62 5b30 5d20 3d3d  t(src1->nb[0] ==
+00024ef0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00024f00: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00024f10: 203d 2030 3b20 6920 3c20 6e3b 2069 2b2b   = 0; i < n; i++
+00024f20: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+00024f30: 5f76 6563 5f73 7562 5f66 3332 286e 632c  _vec_sub_f32(nc,
+00024f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024f50: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00024f60: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
+00024f70: 2b20 692a 2820 6473 742d 3e6e 625b 315d  + i*( dst->nb[1]
+00024f80: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00024f90: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+00024fa0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+00024fb0: 7461 202b 2069 2a28 7372 6330 2d3e 6e62  ta + i*(src0->nb
+00024fc0: 5b31 5d29 292c 0a20 2020 2020 2020 2020  [1])),.         
+00024fd0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+00024fe0: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
+00024ff0: 3e64 6174 6120 2b20 692a 2873 7263 312d  >data + i*(src1-
+00025000: 3e6e 625b 315d 2929 293b 0a20 2020 207d  >nb[1])));.    }
+00025010: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00025020: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00025030: 7761 7264 5f73 7562 280a 2020 2020 2020  ward_sub(.      
+00025040: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00025050: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00025060: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00025070: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00025080: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00025090: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+000250a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000250b0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+000250c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000250d0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+000250e0: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+000250f0: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00025100: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00025110: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00025120: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00025130: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00025140: 7574 655f 666f 7277 6172 645f 7375 625f  ute_forward_sub_
+00025150: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+00025160: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
+00025170: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00025180: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00025190: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
+000251a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000251b0: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
+000251c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000251d0: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
+000251e0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+000251f0: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
+00025200: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
+00025210: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00025220: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
+00025230: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00025240: 5045 5f43 4f55 4e54 3a0a 2020 2020 2020  PE_COUNT:.      
+00025250: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00025260: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00025270: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+00025280: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00025290: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+000252a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000252b0: 645f 6d75 6c0a 0a73 7461 7469 6320 766f  d_mul..static vo
+000252c0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+000252d0: 666f 7277 6172 645f 6d75 6c5f 6633 3228  forward_mul_f32(
+000252e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000252f0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00025300: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00025310: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00025320: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00025330: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00025340: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00025350: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00025360: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
+00025370: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00025380: 202a 2064 7374 2920 7b0a 2020 2020 6173   * dst) {.    as
+00025390: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
+000253a0: 203d 3d20 3029 3b0a 2020 2020 6173 7365   == 0);.    asse
+000253b0: 7274 2867 676d 6c5f 6172 655f 7361 6d65  rt(ggml_are_same
+000253c0: 5f73 6861 7065 2873 7263 302c 2073 7263  _shape(src0, src
+000253d0: 3129 2026 2620 6767 6d6c 5f61 7265 5f73  1) && ggml_are_s
+000253e0: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
+000253f0: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
+00025400: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00025410: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+00025420: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+00025430: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00025440: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00025450: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00025460: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+00025470: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+00025480: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+00025490: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
+000254a0: 305d 3b0a 0a20 2020 2061 7373 6572 7428  0];..    assert(
+000254b0: 2064 7374 2d3e 6e62 5b30 5d20 3d3d 2073   dst->nb[0] == s
+000254c0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+000254d0: 2020 2061 7373 6572 7428 7372 6330 2d3e     assert(src0->
+000254e0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+000254f0: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
+00025500: 6572 7428 7372 6331 2d3e 6e62 5b30 5d20  ert(src1->nb[0] 
+00025510: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00025520: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+00025530: 2069 203d 2030 3b20 6920 3c20 6e3b 2069   i = 0; i < n; i
+00025540: 2b2b 2920 7b0a 2020 2020 2020 2020 6767  ++) {.        gg
+00025550: 6d6c 5f76 6563 5f6d 756c 5f66 3332 286e  ml_vec_mul_f32(n
+00025560: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+00025570: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00025580: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
+00025590: 2020 2b20 692a 2820 6473 742d 3e6e 625b    + i*( dst->nb[
+000255a0: 315d 2929 2c0a 2020 2020 2020 2020 2020  1])),.          
+000255b0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+000255c0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+000255d0: 6461 7461 202b 2069 2a28 7372 6330 2d3e  data + i*(src0->
+000255e0: 6e62 5b31 5d29 292c 0a20 2020 2020 2020  nb[1])),.       
+000255f0: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+00025600: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+00025610: 312d 3e64 6174 6120 2b20 692a 2873 7263  1->data + i*(src
+00025620: 312d 3e6e 625b 315d 2929 293b 0a20 2020  1->nb[1])));.   
+00025630: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+00025640: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00025650: 6f72 7761 7264 5f6d 756c 280a 2020 2020  orward_mul(.    
+00025660: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00025670: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00025680: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00025690: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000256a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000256b0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+000256c0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000256d0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+000256e0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000256f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00025700: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+00025710: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00025720: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00025730: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+00025740: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00025750: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00025760: 6d70 7574 655f 666f 7277 6172 645f 6d75  mpute_forward_mu
+00025770: 6c5f 6633 3228 7061 7261 6d73 2c20 7372  l_f32(params, sr
+00025780: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
+00025790: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000257a0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000257b0: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
+000257c0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+000257d0: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
+000257e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000257f0: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
+00025800: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00025810: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
+00025820: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
+00025830: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00025840: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
+00025850: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00025860: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
+00025870: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00025880: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00025890: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+000258a0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000258b0: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+000258c0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000258d0: 6172 645f 6469 760a 0a73 7461 7469 6320  ard_div..static 
+000258e0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+000258f0: 655f 666f 7277 6172 645f 6469 765f 6633  e_forward_div_f3
+00025900: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+00025910: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00025920: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00025930: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00025940: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00025950: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00025960: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00025970: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00025980: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+00025990: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000259a0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+000259b0: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
+000259c0: 7468 203d 3d20 3029 3b0a 2020 2020 6173  th == 0);.    as
+000259d0: 7365 7274 2867 676d 6c5f 6172 655f 7361  sert(ggml_are_sa
+000259e0: 6d65 5f73 6861 7065 2873 7263 302c 2073  me_shape(src0, s
+000259f0: 7263 3129 2026 2620 6767 6d6c 5f61 7265  rc1) && ggml_are
+00025a00: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+00025a10: 2c20 6473 7429 293b 0a0a 2020 2020 6966  , dst));..    if
+00025a20: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00025a30: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00025a40: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00025a50: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00025a60: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00025a70: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00025a80: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00025a90: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
+00025aa0: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
+00025ab0: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
+00025ac0: 655b 305d 3b0a 0a20 2020 2061 7373 6572  e[0];..    asser
+00025ad0: 7428 2064 7374 2d3e 6e62 5b30 5d20 3d3d  t( dst->nb[0] ==
+00025ae0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00025af0: 0a20 2020 2061 7373 6572 7428 7372 6330  .    assert(src0
+00025b00: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00025b10: 6628 666c 6f61 7429 293b 0a20 2020 2061  f(float));.    a
+00025b20: 7373 6572 7428 7372 6331 2d3e 6e62 5b30  ssert(src1->nb[0
+00025b30: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00025b40: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
+00025b50: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
+00025b60: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00025b70: 6767 6d6c 5f76 6563 5f64 6976 5f66 3332  ggml_vec_div_f32
+00025b80: 286e 632c 0a20 2020 2020 2020 2020 2020  (nc,.           
+00025b90: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00025ba0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
+00025bb0: 7461 2020 2b20 692a 2820 6473 742d 3e6e  ta  + i*( dst->n
+00025bc0: 625b 315d 2929 2c0a 2020 2020 2020 2020  b[1])),.        
+00025bd0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+00025be0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+00025bf0: 2d3e 6461 7461 202b 2069 2a28 7372 6330  ->data + i*(src0
+00025c00: 2d3e 6e62 5b31 5d29 292c 0a20 2020 2020  ->nb[1])),.     
+00025c10: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00025c20: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+00025c30: 7263 312d 3e64 6174 6120 2b20 692a 2873  rc1->data + i*(s
+00025c40: 7263 312d 3e6e 625b 315d 2929 293b 0a20  rc1->nb[1])));. 
+00025c50: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+00025c60: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00025c70: 5f66 6f72 7761 7264 5f64 6976 280a 2020  _forward_div(.  
+00025c80: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00025c90: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00025ca0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00025cb0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00025cc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00025cd0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00025ce0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00025cf0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00025d00: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+00025d10: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00025d20: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
+00025d30: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
+00025d40: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00025d50: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+00025d60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00025d70: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00025d80: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00025d90: 6469 765f 6633 3228 7061 7261 6d73 2c20  div_f32(params, 
+00025da0: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00025db0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00025dc0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00025dd0: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+00025de0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+00025df0: 2047 474d 4c5f 5459 5045 5f51 345f 313a   GGML_TYPE_Q4_1:
+00025e00: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00025e10: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
+00025e20: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00025e30: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
+00025e40: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+00025e50: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
+00025e60: 2047 474d 4c5f 5459 5045 5f46 3136 3a0a   GGML_TYPE_F16:.
+00025e70: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00025e80: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
+00025e90: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00025ea0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00025eb0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00025ec0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00025ed0: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
+00025ee0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00025ef0: 7277 6172 645f 7371 720a 0a73 7461 7469  rward_sqr..stati
+00025f00: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00025f10: 7574 655f 666f 7277 6172 645f 7371 725f  ute_forward_sqr_
+00025f20: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+00025f30: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00025f40: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00025f50: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00025f60: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00025f70: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00025f80: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00025f90: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00025fa0: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
+00025fb0: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
+00025fc0: 293b 0a20 2020 2061 7373 6572 7428 6767  );.    assert(gg
+00025fd0: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
+00025fe0: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
+00025ff0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00026000: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00026010: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00026020: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00026030: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00026040: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00026050: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00026060: 2069 6e74 206e 2020 2020 203d 2067 676d   int n     = ggm
+00026070: 6c5f 6e72 6f77 7328 7372 6330 293b 0a20  l_nrows(src0);. 
+00026080: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
+00026090: 2020 203d 2073 7263 302d 3e6e 655b 305d     = src0->ne[0]
+000260a0: 3b0a 0a20 2020 2061 7373 6572 7428 2064  ;..    assert( d
+000260b0: 7374 2d3e 6e62 5b30 5d20 3d3d 2073 697a  st->nb[0] == siz
+000260c0: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
+000260d0: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
+000260e0: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+000260f0: 6f61 7429 293b 0a0a 2020 2020 666f 7220  oat));..    for 
+00026100: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00026110: 6e3b 2069 2b2b 2920 7b0a 2020 2020 2020  n; i++) {.      
+00026120: 2020 6767 6d6c 5f76 6563 5f73 7172 5f66    ggml_vec_sqr_f
+00026130: 3332 286e 632c 0a20 2020 2020 2020 2020  32(nc,.         
+00026140: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+00026150: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+00026160: 6461 7461 2020 2b20 692a 2820 6473 742d  data  + i*( dst-
+00026170: 3e6e 625b 315d 2929 2c0a 2020 2020 2020  >nb[1])),.      
+00026180: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00026190: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
+000261a0: 6330 2d3e 6461 7461 202b 2069 2a28 7372  c0->data + i*(sr
+000261b0: 6330 2d3e 6e62 5b31 5d29 2929 3b0a 2020  c0->nb[1])));.  
+000261c0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+000261d0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+000261e0: 666f 7277 6172 645f 7371 7228 0a20 2020  forward_sqr(.   
+000261f0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00026200: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00026210: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00026220: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00026230: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00026240: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00026250: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00026260: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00026270: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
+00026280: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
+00026290: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+000262a0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+000262b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000262c0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000262d0: 7277 6172 645f 7371 725f 6633 3228 7061  rward_sqr_f32(pa
+000262e0: 7261 6d73 2c20 7372 6330 2c20 6473 7429  rams, src0, dst)
+000262f0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00026300: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00026310: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+00026320: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+00026330: 2047 474d 4c5f 5459 5045 5f51 345f 313a   GGML_TYPE_Q4_1:
+00026340: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00026350: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
+00026360: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00026370: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
+00026380: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+00026390: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
+000263a0: 2047 474d 4c5f 5459 5045 5f46 3136 3a0a   GGML_TYPE_F16:.
+000263b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000263c0: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
+000263d0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000263e0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000263f0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00026400: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00026410: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
+00026420: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00026430: 7277 6172 645f 7371 7274 0a0a 7374 6174  rward_sqrt..stat
+00026440: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00026450: 7075 7465 5f66 6f72 7761 7264 5f73 7172  pute_forward_sqr
+00026460: 745f 6633 3228 0a20 2020 2020 2020 2063  t_f32(.        c
+00026470: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00026480: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00026490: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+000264a0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000264b0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+000264c0: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+000264d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000264e0: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
+000264f0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
+00026500: 2030 293b 0a20 2020 2061 7373 6572 7428   0);.    assert(
+00026510: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
+00026520: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
+00026530: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00026540: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00026550: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+00026560: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00026570: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+00026580: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00026590: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+000265a0: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
+000265b0: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
+000265c0: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
+000265d0: 2073 7263 302d 3e6e 655b 305d 3b0a 0a20   src0->ne[0];.. 
+000265e0: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
+000265f0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+00026600: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
+00026610: 6572 7428 7372 6330 2d3e 6e62 5b30 5d20  ert(src0->nb[0] 
+00026620: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00026630: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+00026640: 2069 203d 2030 3b20 6920 3c20 6e3b 2069   i = 0; i < n; i
+00026650: 2b2b 2920 7b0a 2020 2020 2020 2020 6767  ++) {.        gg
+00026660: 6d6c 5f76 6563 5f73 7172 745f 6633 3228  ml_vec_sqrt_f32(
+00026670: 6e63 2c0a 2020 2020 2020 2020 2020 2020  nc,.            
+00026680: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+00026690: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+000266a0: 6120 202b 2069 2a28 2064 7374 2d3e 6e62  a  + i*( dst->nb
+000266b0: 5b31 5d29 292c 0a20 2020 2020 2020 2020  [1])),.         
+000266c0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+000266d0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
+000266e0: 3e64 6174 6120 2b20 692a 2873 7263 302d  >data + i*(src0-
+000266f0: 3e6e 625b 315d 2929 293b 0a20 2020 207d  >nb[1])));.    }
+00026700: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00026710: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00026720: 7761 7264 5f73 7172 7428 0a20 2020 2020  ward_sqrt(.     
+00026730: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00026740: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00026750: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00026760: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00026770: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00026780: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
+00026790: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000267a0: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+000267b0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+000267c0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+000267d0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+000267e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000267f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00026800: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00026810: 6172 645f 7371 7274 5f66 3332 2870 6172  ard_sqrt_f32(par
+00026820: 616d 732c 2073 7263 302c 2064 7374 293b  ams, src0, dst);
+00026830: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00026840: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00026850: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
+00026860: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+00026870: 4747 4d4c 5f54 5950 455f 5134 5f31 3a0a  GGML_TYPE_Q4_1:.
+00026880: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00026890: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
+000268a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000268b0: 455f 4931 363a 0a20 2020 2020 2020 2063  E_I16:.        c
+000268c0: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
+000268d0: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
+000268e0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+000268f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00026900: 5f54 5950 455f 434f 554e 543a 0a20 2020  _TYPE_COUNT:.   
+00026910: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00026920: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00026930: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00026940: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00026950: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
+00026960: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00026970: 7761 7264 5f73 756d 0a0a 7374 6174 6963  ward_sum..static
+00026980: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00026990: 7465 5f66 6f72 7761 7264 5f73 756d 5f66  te_forward_sum_f
+000269a0: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
+000269b0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+000269c0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+000269d0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+000269e0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000269f0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+00026a00: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00026a10: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00026a20: 2920 7b0a 2020 2020 6173 7365 7274 2870  ) {.    assert(p
+00026a30: 6172 616d 732d 3e69 7468 203d 3d20 3029  arams->ith == 0)
+00026a40: 3b0a 2020 2020 6173 7365 7274 2867 676d  ;.    assert(ggm
+00026a50: 6c5f 6973 5f73 6361 6c61 7228 6473 7429  l_is_scalar(dst)
+00026a60: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+00026a70: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00026a80: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+00026a90: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00026aa0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+00026ab0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+00026ac0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2061  rn;.    }..    a
+00026ad0: 7373 6572 7428 6767 6d6c 5f69 735f 7363  ssert(ggml_is_sc
+00026ae0: 616c 6172 2864 7374 2929 3b0a 2020 2020  alar(dst));.    
+00026af0: 6173 7365 7274 2873 7263 302d 3e6e 625b  assert(src0->nb[
+00026b00: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
+00026b10: 6174 2929 3b0a 0a20 2020 2063 6f6e 7374  at));..    const
+00026b20: 2069 6e74 206e 6530 3020 3d20 7372 6330   int ne00 = src0
+00026b30: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00026b40: 7374 2069 6e74 206e 6530 3120 3d20 7372  st int ne01 = sr
+00026b50: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c0->ne[1];.    c
+00026b60: 6f6e 7374 2069 6e74 206e 6530 3220 3d20  onst int ne02 = 
+00026b70: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
+00026b80: 2063 6f6e 7374 2069 6e74 206e 6530 3320   const int ne03 
+00026b90: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
+00026ba0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00026bb0: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
+00026bc0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
+00026bd0: 697a 655f 7420 6e62 3032 203d 2073 7263  ize_t nb02 = src
+00026be0: 302d 3e6e 625b 325d 3b0a 2020 2020 636f  0->nb[2];.    co
+00026bf0: 6e73 7420 7369 7a65 5f74 206e 6230 3320  nst size_t nb03 
+00026c00: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
+00026c10: 2020 2020 666f 7220 2869 6e74 2069 3033      for (int i03
+00026c20: 203d 2030 3b20 6930 3320 3c20 6e65 3033   = 0; i03 < ne03
+00026c30: 3b20 6930 332b 2b29 207b 0a20 2020 2020  ; i03++) {.     
+00026c40: 2020 2066 6f72 2028 696e 7420 6930 3220     for (int i02 
+00026c50: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
+00026c60: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
+00026c70: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00026c80: 3031 203d 2030 3b20 6930 3120 3c20 6e65  01 = 0; i01 < ne
+00026c90: 3031 3b20 6930 312b 2b29 207b 0a20 2020  01; i01++) {.   
+00026ca0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00026cb0: 6c5f 7665 635f 7375 6d5f 6633 3228 6e65  l_vec_sum_f32(ne
+00026cc0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00026cd0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+00026ce0: 6174 202a 2920 2864 7374 2d3e 6461 7461  at *) (dst->data
+00026cf0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00026d00: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00026d10: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+00026d20: 7263 302d 3e64 6174 6120 2b20 6930 312a  rc0->data + i01*
+00026d30: 6e62 3031 202b 2069 3032 2a6e 6230 3220  nb01 + i02*nb02 
+00026d40: 2b20 6930 332a 6e62 3033 2929 3b0a 2020  + i03*nb03));.  
+00026d50: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00026d60: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00026d70: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00026d80: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00026d90: 7375 6d28 0a20 2020 2020 2020 2063 6f6e  sum(.        con
+00026da0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00026db0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00026dc0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00026dd0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00026de0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00026df0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00026e00: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00026e10: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+00026e20: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00026e30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00026e40: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+00026e50: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00026e60: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00026e70: 6d70 7574 655f 666f 7277 6172 645f 7375  mpute_forward_su
+00026e80: 6d5f 6633 3228 7061 7261 6d73 2c20 7372  m_f32(params, sr
+00026e90: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
+00026ea0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00026eb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00026ec0: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
+00026ed0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00026ee0: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
+00026ef0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00026f00: 4938 3a0a 2020 2020 2020 2020 6361 7365  I8:.        case
+00026f10: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
+00026f20: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00026f30: 4c5f 5459 5045 5f49 3332 3a0a 2020 2020  L_TYPE_I32:.    
+00026f40: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00026f50: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
+00026f60: 6361 7365 2047 474d 4c5f 5459 5045 5f43  case GGML_TYPE_C
+00026f70: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
+00026f80: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00026f90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00026fa0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00026fb0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00026fc0: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
+00026fd0: 6d70 7574 655f 666f 7277 6172 645f 6d65  mpute_forward_me
+00026fe0: 616e 0a0a 7374 6174 6963 2076 6f69 6420  an..static void 
+00026ff0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00027000: 7761 7264 5f6d 6561 6e5f 6633 3228 0a20  ward_mean_f32(. 
+00027010: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00027020: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00027030: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00027040: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00027050: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00027060: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00027070: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00027080: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00027090: 2020 2061 7373 6572 7428 7061 7261 6d73     assert(params
+000270a0: 2d3e 6974 6820 3d3d 2030 293b 0a0a 2020  ->ith == 0);..  
+000270b0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+000270c0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000270d0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+000270e0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000270f0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+00027100: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+00027110: 2020 7d0a 0a20 2020 2061 7373 6572 7428    }..    assert(
+00027120: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
+00027130: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00027140: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+00027150: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
+00027160: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00027170: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
+00027180: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+00027190: 7420 6e65 3032 203d 2073 7263 302d 3e6e  t ne02 = src0->n
+000271a0: 655b 325d 3b0a 2020 2020 636f 6e73 7420  e[2];.    const 
+000271b0: 696e 7420 6e65 3033 203d 2073 7263 302d  int ne03 = src0-
+000271c0: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
+000271d0: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
+000271e0: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
+000271f0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00027200: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
+00027210: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+00027220: 655f 7420 6e62 3033 203d 2073 7263 302d  e_t nb03 = src0-
+00027230: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00027240: 7374 2069 6e74 206e 6530 203d 2064 7374  st int ne0 = dst
+00027250: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00027260: 7374 2069 6e74 206e 6531 203d 2064 7374  st int ne1 = dst
+00027270: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+00027280: 7374 2069 6e74 206e 6532 203d 2064 7374  st int ne2 = dst
+00027290: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+000272a0: 7374 2069 6e74 206e 6533 203d 2064 7374  st int ne3 = dst
+000272b0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 6173  ->ne[3];..    as
+000272c0: 7365 7274 286e 6530 203d 3d20 3129 3b0a  sert(ne0 == 1);.
+000272d0: 2020 2020 6173 7365 7274 286e 6531 203d      assert(ne1 =
+000272e0: 3d20 6e65 3031 293b 0a20 2020 2061 7373  = ne01);.    ass
+000272f0: 6572 7428 6e65 3220 3d3d 206e 6530 3229  ert(ne2 == ne02)
+00027300: 3b0a 2020 2020 6173 7365 7274 286e 6533  ;.    assert(ne3
+00027310: 203d 3d20 6e65 3033 293b 0a0a 2020 2020   == ne03);..    
+00027320: 554e 5553 4544 286e 6530 293b 0a20 2020  UNUSED(ne0);.   
+00027330: 2055 4e55 5345 4428 6e65 3129 3b0a 2020   UNUSED(ne1);.  
+00027340: 2020 554e 5553 4544 286e 6532 293b 0a20    UNUSED(ne2);. 
+00027350: 2020 2055 4e55 5345 4428 6e65 3329 3b0a     UNUSED(ne3);.
+00027360: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00027370: 7420 6e62 3120 3d20 6473 742d 3e6e 625b  t nb1 = dst->nb[
+00027380: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
+00027390: 7a65 5f74 206e 6232 203d 2064 7374 2d3e  ze_t nb2 = dst->
+000273a0: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+000273b0: 2073 697a 655f 7420 6e62 3320 3d20 6473   size_t nb3 = ds
+000273c0: 742d 3e6e 625b 335d 3b0a 0a20 2020 2066  t->nb[3];..    f
+000273d0: 6f72 2028 696e 7420 6930 3320 3d20 303b  or (int i03 = 0;
+000273e0: 2069 3033 203c 206e 6530 333b 2069 3033   i03 < ne03; i03
+000273f0: 2b2b 2920 7b0a 2020 2020 2020 2020 666f  ++) {.        fo
+00027400: 7220 2869 6e74 2069 3032 203d 2030 3b20  r (int i02 = 0; 
+00027410: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
+00027420: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00027430: 2066 6f72 2028 696e 7420 6930 3120 3d20   for (int i01 = 
+00027440: 303b 2069 3031 203c 206e 6530 313b 2069  0; i01 < ne01; i
+00027450: 3031 2b2b 2920 7b0a 2020 2020 2020 2020  01++) {.        
+00027460: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00027470: 5f73 756d 5f66 3332 286e 6530 302c 0a20  _sum_f32(ne00,. 
+00027480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027490: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+000274a0: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
+000274b0: 3e64 6174 6120 2b20 6930 312a 6e62 3120  >data + i01*nb1 
+000274c0: 202b 2069 3032 2a6e 6232 2020 2b20 6930   + i02*nb2  + i0
+000274d0: 332a 6e62 3329 2c0a 2020 2020 2020 2020  3*nb3),.        
+000274e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274f0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00027500: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00027510: 2069 3031 2a6e 6230 3120 2b20 6930 322a   i01*nb01 + i02*
+00027520: 6e62 3032 202b 2069 3033 2a6e 6230 3329  nb02 + i03*nb03)
+00027530: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00027540: 2020 2020 2a28 666c 6f61 7420 2a29 2028      *(float *) (
+00027550: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
+00027560: 7461 202b 2069 3031 2a6e 6231 202b 2069  ta + i01*nb1 + i
+00027570: 3032 2a6e 6232 202b 2069 3033 2a6e 6233  02*nb2 + i03*nb3
+00027580: 2920 2f3d 2028 666c 6f61 7429 206e 6530  ) /= (float) ne0
+00027590: 303b 0a20 2020 2020 2020 2020 2020 207d  0;.            }
+000275a0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+000275b0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+000275c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000275d0: 7761 7264 5f6d 6561 6e28 0a20 2020 2020  ward_mean(.     
+000275e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000275f0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00027600: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00027610: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00027620: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00027630: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
+00027640: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00027650: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+00027660: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+00027670: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00027680: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+00027690: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000276a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000276b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000276c0: 6172 645f 6d65 616e 5f66 3332 2870 6172  ard_mean_f32(par
+000276d0: 616d 732c 2073 7263 302c 2064 7374 293b  ams, src0, dst);
+000276e0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000276f0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00027700: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
+00027710: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+00027720: 4747 4d4c 5f54 5950 455f 5134 5f31 3a0a  GGML_TYPE_Q4_1:.
+00027730: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00027740: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
+00027750: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00027760: 455f 4931 363a 0a20 2020 2020 2020 2063  E_I16:.        c
+00027770: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
+00027780: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
+00027790: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+000277a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000277b0: 5f54 5950 455f 434f 554e 543a 0a20 2020  _TYPE_COUNT:.   
+000277c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000277d0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+000277e0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+000277f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00027800: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
+00027810: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00027820: 7761 7264 5f72 6570 6561 740a 0a73 7461  ward_repeat..sta
+00027830: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00027840: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
+00027850: 7065 6174 5f66 3332 280a 2020 2020 2020  peat_f32(.      
+00027860: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00027870: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00027880: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00027890: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000278a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000278b0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+000278c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000278d0: 202a 2064 7374 2920 7b0a 2020 2020 6173   * dst) {.    as
+000278e0: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
+000278f0: 203d 3d20 3029 3b0a 2020 2020 6173 7365   == 0);.    asse
+00027900: 7274 2867 676d 6c5f 6361 6e5f 7265 7065  rt(ggml_can_repe
+00027910: 6174 2873 7263 302c 2064 7374 2929 3b0a  at(src0, dst));.
+00027920: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00027930: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00027940: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00027950: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00027960: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00027970: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00027980: 0a20 2020 207d 0a0a 2020 2020 2f2f 2054  .    }..    // T
+00027990: 4f44 4f3a 2069 6d70 6c65 6d65 6e74 2073  ODO: implement s
+000279a0: 7570 706f 7274 2066 6f72 2072 616e 6b20  upport for rank 
+000279b0: 3e20 3220 7465 6e73 6f72 730a 2020 2020  > 2 tensors.    
+000279c0: 6173 7365 7274 2873 7263 302d 3e6e 655b  assert(src0->ne[
+000279d0: 325d 203d 3d20 3129 3b0a 2020 2020 6173  2] == 1);.    as
+000279e0: 7365 7274 2873 7263 302d 3e6e 655b 335d  sert(src0->ne[3]
+000279f0: 203d 3d20 3129 3b0a 2020 2020 6173 7365   == 1);.    asse
+00027a00: 7274 2820 6473 742d 3e6e 655b 325d 203d  rt( dst->ne[2] =
+00027a10: 3d20 3129 3b0a 2020 2020 6173 7365 7274  = 1);.    assert
+00027a20: 2820 6473 742d 3e6e 655b 335d 203d 3d20  ( dst->ne[3] == 
+00027a30: 3129 3b0a 0a20 2020 2063 6f6e 7374 2069  1);..    const i
+00027a40: 6e74 206e 6320 203d 2064 7374 2d3e 6e65  nt nc  = dst->ne
+00027a50: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00027a60: 6e74 206e 7220 203d 2064 7374 2d3e 6e65  nt nr  = dst->ne
+00027a70: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00027a80: 6e74 206e 6330 203d 2073 7263 302d 3e6e  nt nc0 = src0->n
+00027a90: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00027aa0: 696e 7420 6e72 3020 3d20 7372 6330 2d3e  int nr0 = src0->
+00027ab0: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00027ac0: 2069 6e74 206e 6372 203d 206e 632f 6e63   int ncr = nc/nc
+00027ad0: 303b 202f 2f20 6775 6172 616e 7465 6564  0; // guaranteed
+00027ae0: 2074 6f20 6265 2061 6e20 696e 7465 6765   to be an intege
+00027af0: 7220 6475 6520 746f 2074 6865 2063 6865  r due to the che
+00027b00: 636b 2069 6e20 6767 6d6c 5f63 616e 5f72  ck in ggml_can_r
+00027b10: 6570 6561 740a 2020 2020 636f 6e73 7420  epeat.    const 
+00027b20: 696e 7420 6e72 7220 3d20 6e72 2f6e 7230  int nrr = nr/nr0
+00027b30: 3b20 2f2f 2067 7561 7261 6e74 6565 6420  ; // guaranteed 
+00027b40: 746f 2062 6520 616e 2069 6e74 6567 6572  to be an integer
+00027b50: 2064 7565 2074 6f20 7468 6520 6368 6563   due to the chec
+00027b60: 6b20 696e 2067 676d 6c5f 6361 6e5f 7265  k in ggml_can_re
+00027b70: 7065 6174 0a0a 2020 2020 2f2f 2054 4f44  peat..    // TOD
+00027b80: 4f3a 2073 7570 706f 7274 2066 6f72 2074  O: support for t
+00027b90: 7261 6e73 706f 7365 6420 2f20 7065 726d  ransposed / perm
+00027ba0: 7574 6564 2074 656e 736f 7273 0a20 2020  uted tensors.   
+00027bb0: 2061 7373 6572 7428 2064 7374 2d3e 6e62   assert( dst->nb
+00027bc0: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+00027bd0: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
+00027be0: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
+00027bf0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00027c00: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 206d  ..    // TODO: m
+00027c10: 6179 6265 2074 6869 7320 6973 206e 6f74  aybe this is not
+00027c20: 206f 7074 696d 616c 3f0a 2020 2020 666f   optimal?.    fo
+00027c30: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00027c40: 3c20 6e72 723b 2069 2b2b 2920 7b0a 2020  < nrr; i++) {.  
+00027c50: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00027c60: 203d 2030 3b20 6a20 3c20 6e63 723b 206a   = 0; j < ncr; j
+00027c70: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00027c80: 2020 666f 7220 2869 6e74 206b 203d 2030    for (int k = 0
+00027c90: 3b20 6b20 3c20 6e72 303b 206b 2b2b 2920  ; k < nr0; k++) 
+00027ca0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00027cb0: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
+00027cc0: 3332 286e 6330 2c0a 2020 2020 2020 2020  32(nc0,.        
+00027cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ce0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00027cf0: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+00027d00: 2028 692a 6e72 3020 2b20 6b29 2a28 2064   (i*nr0 + k)*( d
+00027d10: 7374 2d3e 6e62 5b31 5d29 202b 206a 2a6e  st->nb[1]) + j*n
+00027d20: 6330 2a28 2064 7374 2d3e 6e62 5b30 5d29  c0*( dst->nb[0])
+00027d30: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00027d40: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00027d50: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+00027d60: 7263 302d 3e64 6174 6120 2b20 2820 2020  rc0->data + (   
+00027d70: 2020 2020 206b 292a 2873 7263 302d 3e6e       k)*(src0->n
+00027d80: 625b 315d 2929 293b 0a20 2020 2020 2020  b[1])));.       
+00027d90: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00027da0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00027db0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00027dc0: 7465 5f66 6f72 7761 7264 5f72 6570 6561  te_forward_repea
+00027dd0: 7428 0a20 2020 2020 2020 2063 6f6e 7374  t(.        const
+00027de0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00027df0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00027e00: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00027e10: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00027e20: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00027e30: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00027e40: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00027e50: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+00027e60: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00027e70: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00027e80: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00027e90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00027ea0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00027eb0: 7574 655f 666f 7277 6172 645f 7265 7065  ute_forward_repe
+00027ec0: 6174 5f66 3332 2870 6172 616d 732c 2073  at_f32(params, s
+00027ed0: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
+00027ee0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00027ef0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00027f00: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
+00027f10: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00027f20: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
+00027f30: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00027f40: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
+00027f50: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
+00027f60: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00027f70: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
+00027f80: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00027f90: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+00027fa0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00027fb0: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
+00027fc0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00027fd0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00027fe0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00027ff0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00028000: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+00028010: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
+00028020: 6273 0a0a 7374 6174 6963 2076 6f69 6420  bs..static void 
+00028030: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00028040: 7761 7264 5f61 6273 5f66 3332 280a 2020  ward_abs_f32(.  
+00028050: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00028060: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00028070: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00028080: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00028090: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000280a0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+000280b0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+000280c0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+000280d0: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
+000280e0: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
+000280f0: 6173 7365 7274 2867 676d 6c5f 6172 655f  assert(ggml_are_
+00028100: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+00028110: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
+00028120: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00028130: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00028140: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00028150: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00028160: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00028170: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00028180: 2020 2020 636f 6e73 7420 696e 7420 6e20      const int n 
+00028190: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
+000281a0: 6330 293b 0a20 2020 2063 6f6e 7374 2069  c0);.    const i
+000281b0: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
+000281c0: 5b30 5d3b 0a0a 2020 2020 6173 7365 7274  [0];..    assert
+000281d0: 2864 7374 2d3e 6e62 5b30 5d20 203d 3d20  (dst->nb[0]  == 
+000281e0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+000281f0: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
+00028200: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
+00028210: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
+00028220: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00028230: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
+00028240: 2020 2020 2067 676d 6c5f 7665 635f 6162       ggml_vec_ab
+00028250: 735f 6633 3228 6e63 2c0a 2020 2020 2020  s_f32(nc,.      
+00028260: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00028270: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+00028280: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
+00028290: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
+000282a0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+000282b0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+000282c0: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
+000282d0: 2873 7263 302d 3e6e 625b 315d 2929 293b  (src0->nb[1])));
+000282e0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+000282f0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00028300: 7465 5f66 6f72 7761 7264 5f61 6273 280a  te_forward_abs(.
+00028310: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00028320: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00028330: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00028340: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00028350: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00028360: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00028370: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00028380: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00028390: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+000283a0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+000283b0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+000283c0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+000283d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000283e0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+000283f0: 5f66 6f72 7761 7264 5f61 6273 5f66 3332  _forward_abs_f32
+00028400: 2870 6172 616d 732c 2073 7263 302c 2064  (params, src0, d
+00028410: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+00028420: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00028430: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00028440: 5f51 345f 303a 0a20 2020 2020 2020 2063  _Q4_0:.        c
+00028450: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+00028460: 5f31 3a0a 2020 2020 2020 2020 6361 7365  _1:.        case
+00028470: 2047 474d 4c5f 5459 5045 5f49 383a 0a20   GGML_TYPE_I8:. 
+00028480: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00028490: 5f54 5950 455f 4931 363a 0a20 2020 2020  _TYPE_I16:.     
+000284a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000284b0: 455f 4933 323a 0a20 2020 2020 2020 2063  E_I32:.        c
+000284c0: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
+000284d0: 363a 0a20 2020 2020 2020 2063 6173 6520  6:.        case 
+000284e0: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
+000284f0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00028500: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00028510: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00028520: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00028530: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+00028540: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+00028550: 5f66 6f72 7761 7264 5f73 676e 0a0a 7374  _forward_sgn..st
+00028560: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00028570: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00028580: 676e 5f66 3332 280a 2020 2020 2020 2020  gn_f32(.        
+00028590: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000285a0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+000285b0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+000285c0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000285d0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+000285e0: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
+000285f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00028600: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+00028610: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
+00028620: 3d20 3029 3b0a 2020 2020 6173 7365 7274  = 0);.    assert
+00028630: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+00028640: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
+00028650: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00028660: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00028670: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+00028680: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00028690: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+000286a0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+000286b0: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
+000286c0: 6e73 7420 696e 7420 6e20 203d 2067 676d  nst int n  = ggm
+000286d0: 6c5f 6e72 6f77 7328 7372 6330 293b 0a20  l_nrows(src0);. 
+000286e0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
+000286f0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a0a  = src0->ne[0];..
+00028700: 2020 2020 6173 7365 7274 2864 7374 2d3e      assert(dst->
+00028710: 6e62 5b30 5d20 203d 3d20 7369 7a65 6f66  nb[0]  == sizeof
+00028720: 2866 6c6f 6174 2929 3b0a 2020 2020 6173  (float));.    as
+00028730: 7365 7274 2873 7263 302d 3e6e 625b 305d  sert(src0->nb[0]
+00028740: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+00028750: 2929 3b0a 0a20 2020 2066 6f72 2028 696e  ));..    for (in
+00028760: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
+00028770: 692b 2b29 207b 0a20 2020 2020 2020 2067  i++) {.        g
+00028780: 676d 6c5f 7665 635f 7367 6e5f 6633 3228  gml_vec_sgn_f32(
+00028790: 6e63 2c0a 2020 2020 2020 2020 2020 2020  nc,.            
+000287a0: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+000287b0: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+000287c0: 6120 202b 2069 2a28 2064 7374 2d3e 6e62  a  + i*( dst->nb
+000287d0: 5b31 5d29 292c 0a20 2020 2020 2020 2020  [1])),.         
+000287e0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+000287f0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
+00028800: 3e64 6174 6120 2b20 692a 2873 7263 302d  >data + i*(src0-
+00028810: 3e6e 625b 315d 2929 293b 0a20 2020 207d  >nb[1])));.    }
+00028820: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00028830: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00028840: 7761 7264 5f73 676e 280a 2020 2020 2020  ward_sgn(.      
+00028850: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00028860: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00028870: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00028880: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00028890: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000288a0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+000288b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000288c0: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
+000288d0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
+000288e0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+000288f0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+00028900: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00028910: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00028920: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00028930: 7264 5f73 676e 5f66 3332 2870 6172 616d  rd_sgn_f32(param
+00028940: 732c 2073 7263 302c 2064 7374 293b 0a20  s, src0, dst);. 
+00028950: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00028960: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00028970: 2047 474d 4c5f 5459 5045 5f51 345f 303a   GGML_TYPE_Q4_0:
+00028980: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00028990: 4d4c 5f54 5950 455f 5134 5f31 3a0a 2020  ML_TYPE_Q4_1:.  
+000289a0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000289b0: 5459 5045 5f49 383a 0a20 2020 2020 2020  TYPE_I8:.       
+000289c0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+000289d0: 4931 363a 0a20 2020 2020 2020 2063 6173  I16:.        cas
+000289e0: 6520 4747 4d4c 5f54 5950 455f 4933 323a  e GGML_TYPE_I32:
+000289f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00028a00: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
+00028a10: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00028a20: 5950 455f 434f 554e 543a 0a20 2020 2020  YPE_COUNT:.     
+00028a30: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00028a40: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00028a50: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+00028a60: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00028a70: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
+00028a80: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00028a90: 7264 5f6e 6567 0a0a 7374 6174 6963 2076  rd_neg..static v
+00028aa0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00028ab0: 5f66 6f72 7761 7264 5f6e 6567 5f66 3332  _forward_neg_f32
+00028ac0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00028ad0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00028ae0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00028af0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00028b00: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00028b10: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00028b20: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00028b30: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00028b40: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
+00028b50: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
+00028b60: 2020 2020 6173 7365 7274 2867 676d 6c5f      assert(ggml_
+00028b70: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
+00028b80: 7263 302c 2064 7374 2929 3b0a 0a20 2020  rc0, dst));..   
+00028b90: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00028ba0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+00028bb0: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
+00028bc0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00028bd0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+00028be0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+00028bf0: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
+00028c00: 7420 6e20 203d 2067 676d 6c5f 6e72 6f77  t n  = ggml_nrow
+00028c10: 7328 7372 6330 293b 0a20 2020 2063 6f6e  s(src0);.    con
+00028c20: 7374 2069 6e74 206e 6320 3d20 7372 6330  st int nc = src0
+00028c30: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 6173  ->ne[0];..    as
+00028c40: 7365 7274 2864 7374 2d3e 6e62 5b30 5d20  sert(dst->nb[0] 
+00028c50: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+00028c60: 2929 3b0a 2020 2020 6173 7365 7274 2873  ));.    assert(s
+00028c70: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
+00028c80: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
+00028c90: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00028ca0: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
+00028cb0: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
+00028cc0: 635f 6e65 675f 6633 3228 6e63 2c0a 2020  c_neg_f32(nc,.  
+00028cd0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00028ce0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00028cf0: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
+00028d00: 2a28 2064 7374 2d3e 6e62 5b31 5d29 292c  *( dst->nb[1])),
+00028d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028d20: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00028d30: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+00028d40: 2b20 692a 2873 7263 302d 3e6e 625b 315d  + i*(src0->nb[1]
+00028d50: 2929 293b 0a20 2020 207d 0a7d 0a0a 7374  )));.    }.}..st
+00028d60: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00028d70: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6e  ompute_forward_n
+00028d80: 6567 280a 2020 2020 2020 2020 636f 6e73  eg(.        cons
+00028d90: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00028da0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+00028db0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00028dc0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00028dd0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+00028de0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00028df0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00028e00: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00028e10: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00028e20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00028e30: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00028e40: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00028e50: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00028e60: 7075 7465 5f66 6f72 7761 7264 5f6e 6567  pute_forward_neg
+00028e70: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
+00028e80: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
+00028e90: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00028ea0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00028eb0: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
+00028ec0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00028ed0: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
+00028ee0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+00028ef0: 383a 0a20 2020 2020 2020 2063 6173 6520  8:.        case 
+00028f00: 4747 4d4c 5f54 5950 455f 4931 363a 0a20  GGML_TYPE_I16:. 
+00028f10: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00028f20: 5f54 5950 455f 4933 323a 0a20 2020 2020  _TYPE_I32:.     
+00028f30: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00028f40: 455f 4631 363a 0a20 2020 2020 2020 2063  E_F16:.        c
+00028f50: 6173 6520 4747 4d4c 5f54 5950 455f 434f  ase GGML_TYPE_CO
+00028f60: 554e 543a 0a20 2020 2020 2020 2020 2020  UNT:.           
+00028f70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00028f80: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00028f90: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+00028fa0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00028fb0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+00028fc0: 7075 7465 5f66 6f72 7761 7264 5f73 7465  pute_forward_ste
+00028fd0: 700a 0a73 7461 7469 6320 766f 6964 2067  p..static void g
+00028fe0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00028ff0: 6172 645f 7374 6570 5f66 3332 280a 2020  ard_step_f32(.  
+00029000: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00029010: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00029020: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00029030: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00029040: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00029050: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00029060: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00029070: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00029080: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
+00029090: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
+000290a0: 6173 7365 7274 2867 676d 6c5f 6172 655f  assert(ggml_are_
+000290b0: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+000290c0: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
+000290d0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+000290e0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+000290f0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00029100: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00029110: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00029120: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00029130: 2020 2020 636f 6e73 7420 696e 7420 6e20      const int n 
+00029140: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
+00029150: 6330 293b 0a20 2020 2063 6f6e 7374 2069  c0);.    const i
+00029160: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
+00029170: 5b30 5d3b 0a0a 2020 2020 6173 7365 7274  [0];..    assert
+00029180: 2864 7374 2d3e 6e62 5b30 5d20 203d 3d20  (dst->nb[0]  == 
+00029190: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+000291a0: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
+000291b0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
+000291c0: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
+000291d0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+000291e0: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
+000291f0: 2020 2020 2067 676d 6c5f 7665 635f 7374       ggml_vec_st
+00029200: 6570 5f66 3332 286e 632c 0a20 2020 2020  ep_f32(nc,.     
+00029210: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00029220: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+00029230: 7374 2d3e 6461 7461 2020 2b20 692a 2820  st->data  + i*( 
+00029240: 6473 742d 3e6e 625b 315d 2929 2c0a 2020  dst->nb[1])),.  
+00029250: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00029260: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00029270: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+00029280: 2a28 7372 6330 2d3e 6e62 5b31 5d29 2929  *(src0->nb[1])))
+00029290: 3b0a 2020 2020 7d0a 7d0a 0a73 7461 7469  ;.    }.}..stati
+000292a0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+000292b0: 7574 655f 666f 7277 6172 645f 7374 6570  ute_forward_step
+000292c0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+000292d0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+000292e0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+000292f0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00029300: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00029310: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00029320: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00029330: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00029340: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+00029350: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+00029360: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00029370: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+00029380: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00029390: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+000293a0: 7465 5f66 6f72 7761 7264 5f73 7465 705f  te_forward_step_
+000293b0: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+000293c0: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+000293d0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000293e0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000293f0: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
+00029400: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00029410: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
+00029420: 6173 6520 4747 4d4c 5f54 5950 455f 4938  ase GGML_TYPE_I8
+00029430: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00029440: 474d 4c5f 5459 5045 5f49 3136 3a0a 2020  GML_TYPE_I16:.  
+00029450: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00029460: 5459 5045 5f49 3332 3a0a 2020 2020 2020  TYPE_I32:.      
+00029470: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00029480: 5f46 3136 3a0a 2020 2020 2020 2020 6361  _F16:.        ca
+00029490: 7365 2047 474d 4c5f 5459 5045 5f43 4f55  se GGML_TYPE_COU
+000294a0: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
+000294b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000294c0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+000294d0: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+000294e0: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+000294f0: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+00029500: 7574 655f 666f 7277 6172 645f 7265 6c75  ute_forward_relu
+00029510: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00029520: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00029530: 7264 5f72 656c 755f 6633 3228 0a20 2020  rd_relu_f32(.   
+00029540: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00029550: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00029560: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00029570: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00029580: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00029590: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+000295a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000295b0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+000295c0: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
+000295d0: 6974 6820 3d3d 2030 293b 0a20 2020 2061  ith == 0);.    a
+000295e0: 7373 6572 7428 6767 6d6c 5f61 7265 5f73  ssert(ggml_are_s
+000295f0: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
+00029600: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
+00029610: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00029620: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+00029630: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+00029640: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00029650: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00029660: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00029670: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+00029680: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+00029690: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+000296a0: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
+000296b0: 305d 3b0a 0a20 2020 2061 7373 6572 7428  0];..    assert(
+000296c0: 6473 742d 3e6e 625b 305d 2020 3d3d 2073  dst->nb[0]  == s
+000296d0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+000296e0: 2020 2061 7373 6572 7428 7372 6330 2d3e     assert(src0->
+000296f0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+00029700: 666c 6f61 7429 293b 0a0a 2020 2020 666f  float));..    fo
+00029710: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00029720: 3c20 6e3b 2069 2b2b 2920 7b0a 2020 2020  < n; i++) {.    
+00029730: 2020 2020 6767 6d6c 5f76 6563 5f72 656c      ggml_vec_rel
+00029740: 755f 6633 3228 6e63 2c0a 2020 2020 2020  u_f32(nc,.      
+00029750: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00029760: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+00029770: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
+00029780: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
+00029790: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+000297a0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+000297b0: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
+000297c0: 2873 7263 302d 3e6e 625b 315d 2929 293b  (src0->nb[1])));
+000297d0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+000297e0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+000297f0: 7465 5f66 6f72 7761 7264 5f72 656c 7528  te_forward_relu(
+00029800: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00029810: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00029820: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00029830: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00029840: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00029850: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00029860: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00029870: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00029880: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+00029890: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+000298a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000298b0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+000298c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000298d0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+000298e0: 655f 666f 7277 6172 645f 7265 6c75 5f66  e_forward_relu_f
+000298f0: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
+00029900: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00029910: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00029920: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00029930: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
+00029940: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00029950: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
+00029960: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
+00029970: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00029980: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
+00029990: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000299a0: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
+000299b0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+000299c0: 4631 363a 0a20 2020 2020 2020 2063 6173  F16:.        cas
+000299d0: 6520 4747 4d4c 5f54 5950 455f 434f 554e  e GGML_TYPE_COUN
+000299e0: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+000299f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029a00: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+00029a10: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+00029a20: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+00029a30: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00029a40: 7465 5f66 6f72 7761 7264 5f67 656c 750a  te_forward_gelu.
+00029a50: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00029a60: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00029a70: 645f 6765 6c75 5f66 3332 280a 2020 2020  d_gelu_f32(.    
+00029a80: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00029a90: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00029aa0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00029ab0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00029ac0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029ad0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00029ae0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00029af0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00029b00: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+00029b10: 5f69 735f 636f 6e74 6967 756f 7573 2873  _is_contiguous(s
+00029b20: 7263 3029 293b 0a20 2020 2047 474d 4c5f  rc0));.    GGML_
+00029b30: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
+00029b40: 6f6e 7469 6775 6f75 7328 6473 7429 293b  ontiguous(dst));
+00029b50: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00029b60: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+00029b70: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
+00029b80: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00029b90: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00029ba0: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+00029bb0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00029bc0: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+00029bd0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+00029be0: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
+00029bf0: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
+00029c00: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
+00029c10: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
+00029c20: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
+00029c30: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
+00029c40: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+00029c50: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
+00029c60: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+00029c70: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+00029c80: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+00029c90: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+00029ca0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+00029cb0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+00029cc0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+00029cd0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00029ce0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+00029cf0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+00029d00: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+00029d10: 206e 7229 3b0a 0a20 2020 2066 6f72 2028   nr);..    for (
+00029d20: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
+00029d30: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
+00029d40: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00029d50: 5f67 656c 755f 6633 3228 6e63 2c0a 2020  _gelu_f32(nc,.  
+00029d60: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00029d70: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00029d80: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
+00029d90: 312a 2820 6473 742d 3e6e 625b 315d 2929  1*( dst->nb[1]))
+00029da0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029db0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+00029dc0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00029dd0: 202b 2069 312a 2873 7263 302d 3e6e 625b   + i1*(src0->nb[
+00029de0: 315d 2929 293b 0a0a 2369 666e 6465 6620  1])));..#ifndef 
+00029df0: 4e44 4542 5547 0a20 2020 2020 2020 2066  NDEBUG.        f
+00029e00: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
+00029e10: 203c 206e 633b 206b 2b2b 2920 7b0a 2020   < nc; k++) {.  
+00029e20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00029e30: 666c 6f61 7420 7820 3d20 2828 666c 6f61  float x = ((floa
+00029e40: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+00029e50: 7374 2d3e 6461 7461 202b 2069 312a 2820  st->data + i1*( 
+00029e60: 6473 742d 3e6e 625b 315d 2929 295b 6b5d  dst->nb[1])))[k]
+00029e70: 3b0a 2020 2020 2020 2020 2020 2020 554e  ;.            UN
+00029e80: 5553 4544 2878 293b 0a20 2020 2020 2020  USED(x);.       
+00029e90: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
+00029ea0: 616e 2878 2929 3b0a 2020 2020 2020 2020  an(x));.        
+00029eb0: 2020 2020 6173 7365 7274 2821 6973 696e      assert(!isin
+00029ec0: 6628 7829 293b 0a20 2020 2020 2020 207d  f(x));.        }
+00029ed0: 0a23 656e 6469 660a 2020 2020 7d0a 7d0a  .#endif.    }.}.
+00029ee0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00029ef0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00029f00: 645f 6765 6c75 280a 2020 2020 2020 2020  d_gelu(.        
+00029f10: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00029f20: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00029f30: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00029f40: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00029f50: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00029f60: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
+00029f70: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00029f80: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
+00029f90: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
+00029fa0: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
+00029fb0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
+00029fc0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00029fd0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00029fe0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00029ff0: 5f67 656c 755f 6633 3228 7061 7261 6d73  _gelu_f32(params
+0002a000: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+0002a010: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0002a020: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0002a030: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
+0002a040: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0002a050: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
+0002a060: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0002a070: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
+0002a080: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+0002a090: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
+0002a0a0: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
+0002a0b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0002a0c0: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
+0002a0d0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0002a0e0: 5045 5f43 4f55 4e54 3a0a 2020 2020 2020  PE_COUNT:.      
+0002a0f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0002a100: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0002a110: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+0002a120: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0002a130: 0a20 2020 207d 0a0a 2020 2020 2f2f 7072  .    }..    //pr
+0002a140: 696e 7466 2822 5858 5858 5858 5858 2067  intf("XXXXXXXX g
+0002a150: 656c 755c 6e22 293b 0a7d 0a0a 2f2f 2067  elu\n");.}..// g
+0002a160: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0002a170: 6172 645f 7369 6c75 0a0a 7374 6174 6963  ard_silu..static
+0002a180: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0002a190: 7465 5f66 6f72 7761 7264 5f73 696c 755f  te_forward_silu_
+0002a1a0: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+0002a1b0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0002a1c0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0002a1d0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0002a1e0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0002a1f0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0002a200: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002a210: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0002a220: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
+0002a230: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+0002a240: 7469 6775 6f75 7328 7372 6330 2929 3b0a  tiguous(src0));.
+0002a250: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0002a260: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
+0002a270: 7573 2864 7374 2929 3b0a 2020 2020 4747  us(dst));.    GG
+0002a280: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f61  ML_ASSERT(ggml_a
+0002a290: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
+0002a2a0: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
+0002a2b0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+0002a2c0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+0002a2d0: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+0002a2e0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0002a2f0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+0002a300: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+0002a310: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+0002a320: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+0002a330: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+0002a340: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+0002a350: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+0002a360: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
+0002a370: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+0002a380: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
+0002a390: 6f77 7328 7372 6330 293b 0a0a 2020 2020  ows(src0);..    
+0002a3a0: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+0002a3b0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+0002a3c0: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
+0002a3d0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
+0002a3e0: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
+0002a3f0: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
+0002a400: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
+0002a410: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
+0002a420: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+0002a430: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+0002a440: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
+0002a450: 3d20 6972 303b 2069 3120 3c20 6972 313b  = ir0; i1 < ir1;
+0002a460: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
+0002a470: 2067 676d 6c5f 7665 635f 7369 6c75 5f66   ggml_vec_silu_f
+0002a480: 3332 286e 632c 0a20 2020 2020 2020 2020  32(nc,.         
+0002a490: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0002a4a0: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+0002a4b0: 6461 7461 2020 2b20 6931 2a28 2064 7374  data  + i1*( dst
+0002a4c0: 2d3e 6e62 5b31 5d29 292c 0a20 2020 2020  ->nb[1])),.     
+0002a4d0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+0002a4e0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+0002a4f0: 7263 302d 3e64 6174 6120 2b20 6931 2a28  rc0->data + i1*(
+0002a500: 7372 6330 2d3e 6e62 5b31 5d29 2929 3b0a  src0->nb[1])));.
+0002a510: 0a23 6966 6e64 6566 204e 4445 4255 470a  .#ifndef NDEBUG.
+0002a520: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0002a530: 206b 203d 2030 3b20 6b20 3c20 6e63 3b20   k = 0; k < nc; 
+0002a540: 6b2b 2b29 207b 0a20 2020 2020 2020 2020  k++) {.         
+0002a550: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
+0002a560: 203d 2028 2866 6c6f 6174 202a 2920 2828   = ((float *) ((
+0002a570: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+0002a580: 6120 2b20 6931 2a28 2064 7374 2d3e 6e62  a + i1*( dst->nb
+0002a590: 5b31 5d29 2929 5b6b 5d3b 0a20 2020 2020  [1])))[k];.     
+0002a5a0: 2020 2020 2020 2055 4e55 5345 4428 7829         UNUSED(x)
+0002a5b0: 3b0a 2020 2020 2020 2020 2020 2020 6173  ;.            as
+0002a5c0: 7365 7274 2821 6973 6e61 6e28 7829 293b  sert(!isnan(x));
+0002a5d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002a5e0: 6572 7428 2169 7369 6e66 2878 2929 3b0a  ert(!isinf(x));.
+0002a5f0: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
+0002a600: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+0002a610: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0002a620: 7465 5f66 6f72 7761 7264 5f73 696c 7528  te_forward_silu(
+0002a630: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0002a640: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+0002a650: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+0002a660: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+0002a670: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0002a680: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+0002a690: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002a6a0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0002a6b0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+0002a6c0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+0002a6d0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0002a6e0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+0002a6f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0002a700: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+0002a710: 655f 666f 7277 6172 645f 7369 6c75 5f66  e_forward_silu_f
+0002a720: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
+0002a730: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+0002a740: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0002a750: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0002a760: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
+0002a770: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0002a780: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
+0002a790: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
+0002a7a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0002a7b0: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
+0002a7c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0002a7d0: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
+0002a7e0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0002a7f0: 4631 363a 0a20 2020 2020 2020 2063 6173  F16:.        cas
+0002a800: 6520 4747 4d4c 5f54 5950 455f 434f 554e  e GGML_TYPE_COUN
+0002a810: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+0002a820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a830: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+0002a840: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+0002a850: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+0002a860: 7d0a 0a0a 2f2f 2067 676d 6c5f 636f 6d70  }...// ggml_comp
+0002a870: 7574 655f 666f 7277 6172 645f 6e6f 726d  ute_forward_norm
+0002a880: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+0002a890: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0002a8a0: 7264 5f6e 6f72 6d5f 6633 3228 0a20 2020  rd_norm_f32(.   
+0002a8b0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0002a8c0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+0002a8d0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+0002a8e0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0002a8f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002a900: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+0002a910: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002a920: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+0002a930: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0002a940: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
+0002a950: 2873 7263 302c 2064 7374 2929 3b0a 0a20  (src0, dst));.. 
+0002a960: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+0002a970: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0002a980: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+0002a990: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0002a9a0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+0002a9b0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0002a9c0: 2020 207d 0a0a 2020 2020 4747 4d4c 5f41     }..    GGML_A
+0002a9d0: 5353 4552 5428 7372 6330 2d3e 6e62 5b30  SSERT(src0->nb[0
+0002a9e0: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+0002a9f0: 7429 293b 0a0a 2020 2020 636f 6e73 7420  t));..    const 
+0002aa00: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
+0002aa10: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
+0002aa20: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
+0002aa30: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
+0002aa40: 7374 2069 6e74 206e 6530 3020 3d20 7372  st int ne00 = sr
+0002aa50: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
+0002aa60: 6f6e 7374 2069 6e74 206e 6530 3120 3d20  onst int ne01 = 
+0002aa70: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
+0002aa80: 2063 6f6e 7374 2069 6e74 206e 6530 3220   const int ne02 
+0002aa90: 3d20 7372 6330 2d3e 6e65 5b32 5d3b 0a20  = src0->ne[2];. 
+0002aaa0: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+0002aab0: 3320 3d20 7372 6330 2d3e 6e65 5b33 5d3b  3 = src0->ne[3];
+0002aac0: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+0002aad0: 5f74 206e 6230 3120 3d20 7372 6330 2d3e  _t nb01 = src0->
+0002aae0: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
+0002aaf0: 2073 697a 655f 7420 6e62 3032 203d 2073   size_t nb02 = s
+0002ab00: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
+0002ab10: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0002ab20: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
+0002ab30: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+0002ab40: 5f74 206e 6231 203d 2064 7374 2d3e 6e62  _t nb1 = dst->nb
+0002ab50: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
+0002ab60: 697a 655f 7420 6e62 3220 3d20 6473 742d  ize_t nb2 = dst-
+0002ab70: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+0002ab80: 7420 7369 7a65 5f74 206e 6233 203d 2064  t size_t nb3 = d
+0002ab90: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
+0002aba0: 636f 6e73 7420 666c 6f61 7420 6570 7320  const float eps 
+0002abb0: 3d20 3165 2d35 663b 202f 2f20 544f 444f  = 1e-5f; // TODO
+0002abc0: 3a20 6d61 6b65 2074 6869 7320 6120 7061  : make this a pa
+0002abd0: 7261 6d65 7465 720a 0a20 2020 202f 2f20  rameter..    // 
+0002abe0: 544f 444f 3a20 6f70 7469 6d69 7a65 0a20  TODO: optimize. 
+0002abf0: 2020 2066 6f72 2028 696e 7420 6930 3320     for (int i03 
+0002ac00: 3d20 303b 2069 3033 203c 206e 6530 333b  = 0; i03 < ne03;
+0002ac10: 2069 3033 2b2b 2920 7b0a 2020 2020 2020   i03++) {.      
+0002ac20: 2020 666f 7220 2869 6e74 2069 3032 203d    for (int i02 =
+0002ac30: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+0002ac40: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+0002ac50: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+0002ac60: 3120 3d20 6974 683b 2069 3031 203c 206e  1 = ith; i01 < n
+0002ac70: 6530 313b 2069 3031 202b 3d20 6e74 6829  e01; i01 += nth)
+0002ac80: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002ac90: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
+0002aca0: 2078 203d 2028 666c 6f61 7420 2a29 2028   x = (float *) (
+0002acb0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+0002acc0: 6174 6120 2b20 6930 312a 6e62 3031 202b  ata + i01*nb01 +
+0002acd0: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
+0002ace0: 6e62 3033 293b 0a0a 2020 2020 2020 2020  nb03);..        
+0002acf0: 2020 2020 2020 2020 6767 6d6c 5f66 6c6f          ggml_flo
+0002ad00: 6174 2073 756d 203d 2030 2e30 3b0a 2020  at sum = 0.0;.  
+0002ad10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002ad20: 7220 2869 6e74 2069 3030 203d 2030 3b20  r (int i00 = 0; 
+0002ad30: 6930 3020 3c20 6e65 3030 3b20 6930 302b  i00 < ne00; i00+
+0002ad40: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0002ad50: 2020 2020 2020 2020 2073 756d 202b 3d20           sum += 
+0002ad60: 2867 676d 6c5f 666c 6f61 7429 785b 6930  (ggml_float)x[i0
+0002ad70: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+0002ad80: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0002ad90: 2020 2020 2020 2066 6c6f 6174 206d 6561         float mea
+0002ada0: 6e20 3d20 7375 6d2f 6e65 3030 3b0a 0a20  n = sum/ne00;.. 
+0002adb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002adc0: 6c6f 6174 202a 2079 203d 2028 666c 6f61  loat * y = (floa
+0002add0: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+0002ade0: 7374 2d3e 6461 7461 202b 2069 3031 2a6e  st->data + i01*n
+0002adf0: 6231 202b 2069 3032 2a6e 6232 202b 2069  b1 + i02*nb2 + i
+0002ae00: 3033 2a6e 6233 293b 0a0a 2020 2020 2020  03*nb3);..      
+0002ae10: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+0002ae20: 6c6f 6174 2073 756d 3220 3d20 302e 303b  loat sum2 = 0.0;
+0002ae30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ae40: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
+0002ae50: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
+0002ae60: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
+0002ae70: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0002ae80: 7420 7620 3d20 785b 6930 305d 202d 206d  t v = x[i00] - m
+0002ae90: 6561 6e3b 0a20 2020 2020 2020 2020 2020  ean;.           
+0002aea0: 2020 2020 2020 2020 2079 5b69 3030 5d20           y[i00] 
+0002aeb0: 3d20 763b 0a20 2020 2020 2020 2020 2020  = v;.           
+0002aec0: 2020 2020 2020 2020 2073 756d 3220 2b3d           sum2 +=
+0002aed0: 2028 6767 6d6c 5f66 6c6f 6174 2928 762a   (ggml_float)(v*
+0002aee0: 7629 3b0a 2020 2020 2020 2020 2020 2020  v);.            
+0002aef0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0002af00: 2020 2020 2020 2066 6c6f 6174 2076 6172         float var
+0002af10: 6961 6e63 6520 3d20 7375 6d32 2f6e 6530  iance = sum2/ne0
+0002af20: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0002af30: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
+0002af40: 6361 6c65 203d 2031 2e30 662f 7371 7274  cale = 1.0f/sqrt
+0002af50: 6628 7661 7269 616e 6365 202b 2065 7073  f(variance + eps
+0002af60: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0002af70: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
+0002af80: 6c65 5f66 3332 286e 6530 302c 2079 2c20  le_f32(ne00, y, 
+0002af90: 7363 616c 6529 3b0a 2020 2020 2020 2020  scale);.        
+0002afa0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+0002afb0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+0002afc0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+0002afd0: 655f 666f 7277 6172 645f 6e6f 726d 280a  e_forward_norm(.
+0002afe0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0002aff0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+0002b000: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+0002b010: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+0002b020: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002b030: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+0002b040: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002b050: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+0002b060: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+0002b070: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+0002b080: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0002b090: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+0002b0a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0002b0b0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+0002b0c0: 5f66 6f72 7761 7264 5f6e 6f72 6d5f 6633  _forward_norm_f3
+0002b0d0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+0002b0e0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+0002b0f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0002b100: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0002b110: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
+0002b120: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+0002b130: 345f 313a 0a20 2020 2020 2020 2063 6173  4_1:.        cas
+0002b140: 6520 4747 4d4c 5f54 5950 455f 4938 3a0a  e GGML_TYPE_I8:.
+0002b150: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0002b160: 4c5f 5459 5045 5f49 3136 3a0a 2020 2020  L_TYPE_I16:.    
+0002b170: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0002b180: 5045 5f49 3332 3a0a 2020 2020 2020 2020  PE_I32:.        
+0002b190: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+0002b1a0: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
+0002b1b0: 2047 474d 4c5f 5459 5045 5f43 4f55 4e54   GGML_TYPE_COUNT
+0002b1c0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0002b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1e0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0002b1f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0002b200: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+0002b210: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+0002b220: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0002b230: 7264 5f72 6d73 5f6e 6f72 6d5f 6633 3228  rd_rms_norm_f32(
+0002b240: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0002b250: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+0002b260: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+0002b270: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+0002b280: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0002b290: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+0002b2a0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002b2b0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0002b2c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0002b2d0: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+0002b2e0: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
+0002b2f0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+0002b300: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0002b310: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+0002b320: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+0002b330: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+0002b340: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+0002b350: 6e3b 0a20 2020 207d 0a0a 2020 2020 4747  n;.    }..    GG
+0002b360: 4d4c 5f41 5353 4552 5428 7372 6330 2d3e  ML_ASSERT(src0->
+0002b370: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+0002b380: 666c 6f61 7429 293b 0a0a 2020 2020 636f  float));..    co
+0002b390: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
+0002b3a0: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
+0002b3b0: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
+0002b3c0: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
+0002b3d0: 2063 6f6e 7374 2069 6e74 206e 6530 3020   const int ne00 
+0002b3e0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+0002b3f0: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+0002b400: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+0002b410: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002b420: 6530 3220 3d20 7372 6330 2d3e 6e65 5b32  e02 = src0->ne[2
+0002b430: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0002b440: 206e 6530 3320 3d20 7372 6330 2d3e 6e65   ne03 = src0->ne
+0002b450: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0002b460: 7369 7a65 5f74 206e 6230 3120 3d20 7372  size_t nb01 = sr
+0002b470: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+0002b480: 6f6e 7374 2073 697a 655f 7420 6e62 3032  onst size_t nb02
+0002b490: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+0002b4a0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0002b4b0: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
+0002b4c0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0002b4d0: 7369 7a65 5f74 206e 6231 203d 2064 7374  size_t nb1 = dst
+0002b4e0: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+0002b4f0: 7374 2073 697a 655f 7420 6e62 3220 3d20  st size_t nb2 = 
+0002b500: 6473 742d 3e6e 625b 325d 3b0a 2020 2020  dst->nb[2];.    
+0002b510: 636f 6e73 7420 7369 7a65 5f74 206e 6233  const size_t nb3
+0002b520: 203d 2064 7374 2d3e 6e62 5b33 5d3b 0a0a   = dst->nb[3];..
+0002b530: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+0002b540: 6570 7320 3d20 3165 2d36 663b 202f 2f20  eps = 1e-6f; // 
+0002b550: 544f 444f 3a20 6d61 6b65 2074 6869 7320  TODO: make this 
+0002b560: 6120 7061 7261 6d65 7465 720a 0a20 2020  a parameter..   
+0002b570: 202f 2f20 544f 444f 3a20 6f70 7469 6d69   // TODO: optimi
+0002b580: 7a65 0a20 2020 2066 6f72 2028 696e 7420  ze.    for (int 
+0002b590: 6930 3320 3d20 303b 2069 3033 203c 206e  i03 = 0; i03 < n
+0002b5a0: 6530 333b 2069 3033 2b2b 2920 7b0a 2020  e03; i03++) {.  
+0002b5b0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0002b5c0: 3032 203d 2030 3b20 6930 3220 3c20 6e65  02 = 0; i02 < ne
+0002b5d0: 3032 3b20 6930 322b 2b29 207b 0a20 2020  02; i02++) {.   
+0002b5e0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0002b5f0: 7420 6930 3120 3d20 6974 683b 2069 3031  t i01 = ith; i01
+0002b600: 203c 206e 6530 313b 2069 3031 202b 3d20   < ne01; i01 += 
+0002b610: 6e74 6829 207b 0a20 2020 2020 2020 2020  nth) {.         
+0002b620: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0002b630: 6174 202a 2078 203d 2028 666c 6f61 7420  at * x = (float 
+0002b640: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+0002b650: 302d 3e64 6174 6120 2b20 6930 312a 6e62  0->data + i01*nb
+0002b660: 3031 202b 2069 3032 2a6e 6230 3220 2b20  01 + i02*nb02 + 
+0002b670: 6930 332a 6e62 3033 293b 0a0a 2020 2020  i03*nb03);..    
+0002b680: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0002b690: 5f66 6c6f 6174 2073 756d 203d 2030 2e30  _float sum = 0.0
+0002b6a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0002b6b0: 2020 666f 7220 2869 6e74 2069 3030 203d    for (int i00 =
+0002b6c0: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
+0002b6d0: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
+0002b6e0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+0002b6f0: 202b 3d20 2867 676d 6c5f 666c 6f61 7429   += (ggml_float)
+0002b700: 2878 5b69 3030 5d20 2a20 785b 6930 305d  (x[i00] * x[i00]
+0002b710: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0002b720: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0002b730: 2020 2020 2020 666c 6f61 7420 6d65 616e        float mean
+0002b740: 203d 2073 756d 2f6e 6530 303b 0a0a 2020   = sum/ne00;..  
+0002b750: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0002b760: 6f61 7420 2a20 7920 3d20 2866 6c6f 6174  oat * y = (float
+0002b770: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+0002b780: 742d 3e64 6174 6120 2b20 6930 312a 6e62  t->data + i01*nb
+0002b790: 3120 2b20 6930 322a 6e62 3220 2b20 6930  1 + i02*nb2 + i0
+0002b7a0: 332a 6e62 3329 3b0a 0a20 2020 2020 2020  3*nb3);..       
+0002b7b0: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+0002b7c0: 792c 2078 2c20 6e65 3030 202a 2073 697a  y, x, ne00 * siz
+0002b7d0: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
+0002b7e0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0002b7f0: 666f 7220 2869 6e74 2069 3030 203d 2030  for (int i00 = 0
+0002b800: 3b20 6930 3020 3c20 6e65 3030 3b20 6930  ; i00 < ne00; i0
+0002b810: 302b 2b29 207b 0a20 2020 2020 2020 2020  0++) {.         
+0002b820: 2020 2020 2020 202f 2f20 2020 2020 795b         //     y[
+0002b830: 6930 305d 203d 2078 5b69 3030 5d3b 0a20  i00] = x[i00];. 
+0002b840: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0002b850: 2f20 7d0a 0a20 2020 2020 2020 2020 2020  / }..           
+0002b860: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+0002b870: 2073 6361 6c65 203d 2031 2e30 662f 7371   scale = 1.0f/sq
+0002b880: 7274 6628 6d65 616e 202b 2065 7073 293b  rtf(mean + eps);
+0002b890: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002b8a0: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
+0002b8b0: 5f66 3332 286e 6530 302c 2079 2c20 7363  _f32(ne00, y, sc
+0002b8c0: 616c 6529 3b0a 2020 2020 2020 2020 2020  ale);.          
+0002b8d0: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+0002b8e0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+0002b8f0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+0002b900: 666f 7277 6172 645f 726d 735f 6e6f 726d  forward_rms_norm
+0002b910: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0002b920: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0002b930: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0002b940: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0002b950: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0002b960: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0002b970: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002b980: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+0002b990: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+0002b9a0: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+0002b9b0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0002b9c0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+0002b9d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0002b9e0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0002b9f0: 7465 5f66 6f72 7761 7264 5f72 6d73 5f6e  te_forward_rms_n
+0002ba00: 6f72 6d5f 6633 3228 7061 7261 6d73 2c20  orm_f32(params, 
+0002ba10: 7372 6330 2c20 6473 7429 3b0a 2020 2020  src0, dst);.    
+0002ba20: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0002ba30: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0002ba40: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
+0002ba50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0002ba60: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
+0002ba70: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0002ba80: 455f 4938 3a0a 2020 2020 2020 2020 6361  E_I8:.        ca
+0002ba90: 7365 2047 474d 4c5f 5459 5045 5f49 3136  se GGML_TYPE_I16
+0002baa0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+0002bab0: 474d 4c5f 5459 5045 5f49 3332 3a0a 2020  GML_TYPE_I32:.  
+0002bac0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0002bad0: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
+0002bae0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0002baf0: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
+0002bb00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0002bb10: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0002bb20: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+0002bb30: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0002bb40: 2020 207d 0a7d 0a0a 0a2f 2f20 6767 6d6c     }.}...// ggml
+0002bb50: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0002bb60: 5f6d 756c 5f6d 6174 0a0a 2369 6620 6465  _mul_mat..#if de
+0002bb70: 6669 6e65 6428 4747 4d4c 5f55 5345 5f41  fined(GGML_USE_A
+0002bb80: 4343 454c 4552 4154 4529 207c 7c20 6465  CCELERATE) || de
+0002bb90: 6669 6e65 6428 4747 4d4c 5f55 5345 5f4f  fined(GGML_USE_O
+0002bba0: 5045 4e42 4c41 5329 0a2f 2f20 6865 6c70  PENBLAS).// help
+0002bbb0: 6572 2066 756e 6374 696f 6e20 746f 2064  er function to d
+0002bbc0: 6574 6572 6d69 6e65 2069 6620 6974 2069  etermine if it i
+0002bbd0: 7320 6265 7474 6572 2074 6f20 7573 6520  s better to use 
+0002bbe0: 424c 4153 206f 7220 6e6f 740a 2f2f 2066  BLAS or not.// f
+0002bbf0: 6f72 206c 6172 6765 206d 6174 7269 6365  or large matrice
+0002bc00: 732c 2042 4c41 5320 6973 2066 6173 7465  s, BLAS is faste
+0002bc10: 720a 7374 6174 6963 2062 6f6f 6c20 6767  r.static bool gg
+0002bc20: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0002bc30: 7264 5f6d 756c 5f6d 6174 5f75 7365 5f62  rd_mul_mat_use_b
+0002bc40: 6c61 7328 0a20 2020 2020 2020 2063 6f6e  las(.        con
+0002bc50: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0002bc60: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0002bc70: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0002bc80: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002bc90: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+0002bca0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002bcb0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0002bcc0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0002bcd0: 206e 6530 3020 3d20 7372 6330 2d3e 6e65   ne00 = src0->ne
+0002bce0: 5b30 5d3b 0a20 2020 202f 2f63 6f6e 7374  [0];.    //const
+0002bcf0: 2069 6e74 206e 6530 3120 3d20 7372 6330   int ne01 = src0
+0002bd00: 2d3e 6e65 5b31 5d3b 0a0a 2020 2020 636f  ->ne[1];..    co
+0002bd10: 6e73 7420 696e 7420 6e65 3130 203d 2073  nst int ne10 = s
+0002bd20: 7263 312d 3e6e 655b 305d 3b0a 0a20 2020  rc1->ne[0];..   
+0002bd30: 2063 6f6e 7374 2069 6e74 206e 6530 203d   const int ne0 =
+0002bd40: 2064 7374 2d3e 6e65 5b30 5d3b 0a20 2020   dst->ne[0];.   
+0002bd50: 2063 6f6e 7374 2069 6e74 206e 6531 203d   const int ne1 =
+0002bd60: 2064 7374 2d3e 6e65 5b31 5d3b 0a0a 2020   dst->ne[1];..  
+0002bd70: 2020 2f2f 2054 4f44 4f3a 2066 696e 6420    // TODO: find 
+0002bd80: 7468 6520 6f70 7469 6d61 6c20 7661 6c75  the optimal valu
+0002bd90: 6573 2066 6f72 2074 6865 7365 0a20 2020  es for these.   
+0002bda0: 2069 6620 2867 676d 6c5f 6973 5f63 6f6e   if (ggml_is_con
+0002bdb0: 7469 6775 6f75 7328 7372 6330 2920 2626  tiguous(src0) &&
+0002bdc0: 0a20 2020 2020 2020 2067 676d 6c5f 6973  .        ggml_is
+0002bdd0: 5f63 6f6e 7469 6775 6f75 7328 7372 6331  _contiguous(src1
+0002bde0: 2920 2626 2028 286e 6530 203e 3d20 3332  ) && ((ne0 >= 32
+0002bdf0: 2026 2620 6e65 3120 3e3d 2033 3220 2626   && ne1 >= 32 &&
+0002be00: 206e 6531 3020 3e3d 2033 3229 2929 207b   ne10 >= 32))) {
+0002be10: 0a0a 2020 2020 2020 2020 2f2a 7072 696e  ..        /*prin
+0002be20: 7466 2822 424c 4153 3a20 2564 2025 6420  tf("BLAS: %d %d 
+0002be30: 2564 2025 6420 2564 5c6e 222c 206e 6530  %d %d %d\n", ne0
+0002be40: 2c20 6e65 312c 206e 6531 302c 206e 6530  , ne1, ne10, ne0
+0002be50: 302c 206e 6530 3129 3b2a 2f0a 2020 2020  0, ne01);*/.    
+0002be60: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
+0002be70: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
+0002be80: 726e 2066 616c 7365 3b0a 7d0a 2365 6e64  rn false;.}.#end
+0002be90: 6966 0a0a 7374 6174 6963 2076 6f69 6420  if..static void 
+0002bea0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0002beb0: 7761 7264 5f6d 756c 5f6d 6174 5f66 3332  ward_mul_mat_f32
+0002bec0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0002bed0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0002bee0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0002bef0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0002bf00: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0002bf10: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0002bf20: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0002bf30: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002bf40: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+0002bf50: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002bf60: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0002bf70: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
+0002bf80: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
+0002bf90: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
+0002bfa0: 4428 7430 293b 0a0a 2020 2020 636f 6e73  D(t0);..    cons
+0002bfb0: 7420 696e 7420 6e65 3030 203d 2073 7263  t int ne00 = src
+0002bfc0: 302d 3e6e 655b 305d 3b0a 2020 2020 636f  0->ne[0];.    co
+0002bfd0: 6e73 7420 696e 7420 6e65 3031 203d 2073  nst int ne01 = s
+0002bfe0: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
+0002bff0: 636f 6e73 7420 696e 7420 6e65 3032 203d  const int ne02 =
+0002c000: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
+0002c010: 2020 636f 6e73 7420 696e 7420 6e65 3033    const int ne03
+0002c020: 203d 2073 7263 302d 3e6e 655b 335d 3b0a   = src0->ne[3];.
+0002c030: 0a23 6966 2064 6566 696e 6564 2847 474d  .#if defined(GGM
+0002c040: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
+0002c050: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
+0002c060: 4c5f 5553 455f 4f50 454e 424c 4153 290a  L_USE_OPENBLAS).
+0002c070: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0002c080: 3130 203d 2073 7263 312d 3e6e 655b 305d  10 = src1->ne[0]
+0002c090: 3b0a 2365 6e64 6966 0a20 2020 2063 6f6e  ;.#endif.    con
+0002c0a0: 7374 2069 6e74 206e 6531 3120 3d20 7372  st int ne11 = sr
+0002c0b0: 6331 2d3e 6e65 5b31 5d3b 0a23 6966 6e64  c1->ne[1];.#ifnd
+0002c0c0: 6566 204e 4445 4255 470a 2020 2020 636f  ef NDEBUG.    co
+0002c0d0: 6e73 7420 696e 7420 6e65 3132 203d 2073  nst int ne12 = s
+0002c0e0: 7263 312d 3e6e 655b 325d 3b0a 2020 2020  rc1->ne[2];.    
+0002c0f0: 636f 6e73 7420 696e 7420 6e65 3133 203d  const int ne13 =
+0002c100: 2073 7263 312d 3e6e 655b 335d 3b0a 0a20   src1->ne[3];.. 
+0002c110: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+0002c120: 2020 3d20 6473 742d 3e6e 655b 305d 3b0a    = dst->ne[0];.
+0002c130: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0002c140: 3120 203d 2064 7374 2d3e 6e65 5b31 5d3b  1  = dst->ne[1];
+0002c150: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002c160: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
+0002c170: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0002c180: 6e65 3320 203d 2064 7374 2d3e 6e65 5b33  ne3  = dst->ne[3
+0002c190: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0002c1a0: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+0002c1b0: 625b 305d 3b0a 2365 6e64 6966 0a20 2020  b[0];.#endif.   
+0002c1c0: 2063 6f6e 7374 2069 6e74 206e 6230 3120   const int nb01 
+0002c1d0: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
+0002c1e0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
+0002c1f0: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
+0002c200: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002c210: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
+0002c220: 5d3b 0a0a 2369 666e 6465 6620 4e44 4542  ];..#ifndef NDEB
+0002c230: 5547 0a20 2020 2063 6f6e 7374 2069 6e74  UG.    const int
+0002c240: 206e 6231 3020 3d20 7372 6331 2d3e 6e62   nb10 = src1->nb
+0002c250: 5b30 5d3b 0a23 656e 6469 660a 2020 2020  [0];.#endif.    
+0002c260: 636f 6e73 7420 696e 7420 6e62 3131 203d  const int nb11 =
+0002c270: 2073 7263 312d 3e6e 625b 315d 3b0a 2020   src1->nb[1];.  
+0002c280: 2020 636f 6e73 7420 696e 7420 6e62 3132    const int nb12
+0002c290: 203d 2073 7263 312d 3e6e 625b 325d 3b0a   = src1->nb[2];.
+0002c2a0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0002c2b0: 3133 203d 2073 7263 312d 3e6e 625b 335d  13 = src1->nb[3]
+0002c2c0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0002c2d0: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
+0002c2e0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0002c2f0: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
+0002c300: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0002c310: 6e74 206e 6232 2020 3d20 6473 742d 3e6e  nt nb2  = dst->n
+0002c320: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0002c330: 696e 7420 6e62 3320 203d 2064 7374 2d3e  int nb3  = dst->
+0002c340: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+0002c350: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
+0002c360: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
+0002c370: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
+0002c380: 616d 732d 3e6e 7468 3b0a 0a20 2020 2061  ams->nth;..    a
+0002c390: 7373 6572 7428 6e65 3032 203d 3d20 6e65  ssert(ne02 == ne
+0002c3a0: 3132 293b 0a20 2020 2061 7373 6572 7428  12);.    assert(
+0002c3b0: 6e65 3033 203d 3d20 6e65 3133 293b 0a20  ne03 == ne13);. 
+0002c3c0: 2020 2061 7373 6572 7428 6e65 3220 203d     assert(ne2  =
+0002c3d0: 3d20 6e65 3132 293b 0a20 2020 2061 7373  = ne12);.    ass
+0002c3e0: 6572 7428 6e65 3320 203d 3d20 6e65 3133  ert(ne3  == ne13
+0002c3f0: 293b 0a0a 2020 2020 2f2f 2077 6520 646f  );..    // we do
+0002c400: 6e27 7420 7375 7070 6f72 7420 7065 726d  n't support perm
+0002c410: 7574 6564 2073 7263 3020 6f72 2073 7263  uted src0 or src
+0002c420: 310a 2020 2020 6173 7365 7274 286e 6230  1.    assert(nb0
+0002c430: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+0002c440: 7429 293b 0a20 2020 2061 7373 6572 7428  t));.    assert(
+0002c450: 6e62 3130 203d 3d20 7369 7a65 6f66 2866  nb10 == sizeof(f
+0002c460: 6c6f 6174 2929 3b0a 0a20 2020 202f 2f20  loat));..    // 
+0002c470: 6473 7420 6361 6e6e 6f74 2062 6520 7472  dst cannot be tr
+0002c480: 616e 7370 6f73 6564 206f 7220 7065 726d  ansposed or perm
+0002c490: 7574 6564 0a20 2020 2061 7373 6572 7428  uted.    assert(
+0002c4a0: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
+0002c4b0: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
+0002c4c0: 7428 6e62 3020 3c3d 206e 6231 293b 0a20  t(nb0 <= nb1);. 
+0002c4d0: 2020 2061 7373 6572 7428 6e62 3120 3c3d     assert(nb1 <=
+0002c4e0: 206e 6232 293b 0a20 2020 2061 7373 6572   nb2);.    asser
+0002c4f0: 7428 6e62 3220 3c3d 206e 6233 293b 0a0a  t(nb2 <= nb3);..
+0002c500: 2020 2020 6173 7365 7274 286e 6530 203d      assert(ne0 =
+0002c510: 3d20 6e65 3031 293b 0a20 2020 2061 7373  = ne01);.    ass
+0002c520: 6572 7428 6e65 3120 3d3d 206e 6531 3129  ert(ne1 == ne11)
+0002c530: 3b0a 2020 2020 6173 7365 7274 286e 6532  ;.    assert(ne2
+0002c540: 203d 3d20 6e65 3032 293b 0a20 2020 2061   == ne02);.    a
+0002c550: 7373 6572 7428 6e65 3320 3d3d 206e 6530  ssert(ne3 == ne0
+0002c560: 3329 3b0a 0a20 2020 202f 2f20 6e62 3031  3);..    // nb01
+0002c570: 203e 3d20 6e62 3030 202d 2073 7263 3020   >= nb00 - src0 
+0002c580: 6973 206e 6f74 2074 7261 6e73 706f 7365  is not transpose
+0002c590: 640a 2020 2020 2f2f 2020 2063 6f6d 7075  d.    //   compu
+0002c5a0: 7465 2062 7920 7372 6330 2072 6f77 730a  te by src0 rows.
+0002c5b0: 0a23 6966 2064 6566 696e 6564 2847 474d  .#if defined(GGM
+0002c5c0: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
+0002c5d0: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
+0002c5e0: 4c5f 5553 455f 4f50 454e 424c 4153 290a  L_USE_OPENBLAS).
+0002c5f0: 2020 2020 6966 2028 6767 6d6c 5f63 6f6d      if (ggml_com
+0002c600: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+0002c610: 5f6d 6174 5f75 7365 5f62 6c61 7328 7372  _mat_use_blas(sr
+0002c620: 6330 2c20 7372 6331 2c20 6473 7429 2920  c0, src1, dst)) 
+0002c630: 7b0a 2020 2020 2020 2020 6966 2028 7061  {.        if (pa
+0002c640: 7261 6d73 2d3e 6974 6820 213d 2030 2920  rams->ith != 0) 
+0002c650: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+0002c660: 7475 726e 3b0a 2020 2020 2020 2020 7d0a  turn;.        }.
+0002c670: 0a20 2020 2020 2020 2069 6620 2870 6172  .        if (par
+0002c680: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+0002c690: 4c5f 5441 534b 5f49 4e49 5429 207b 0a20  L_TASK_INIT) {. 
+0002c6a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002c6b0: 6e3b 0a20 2020 2020 2020 207d 0a0a 2020  n;.        }..  
+0002c6c0: 2020 2020 2020 6966 2028 7061 7261 6d73        if (params
+0002c6d0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0002c6e0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+0002c6f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002c700: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
+0002c710: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0002c720: 6930 3320 3d20 303b 2069 3033 203c 206e  i03 = 0; i03 < n
+0002c730: 6530 333b 2069 3033 2b2b 2920 7b0a 2020  e03; i03++) {.  
+0002c740: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0002c750: 6e74 2069 3032 203d 2030 3b20 6930 3220  nt i02 = 0; i02 
+0002c760: 3c20 6e65 3032 3b20 6930 322b 2b29 207b  < ne02; i02++) {
+0002c770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c780: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+0002c790: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
+0002c7a0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0002c7b0: 6120 2b20 6930 322a 6e62 3032 202b 2069  a + i02*nb02 + i
+0002c7c0: 3033 2a6e 6230 3329 3b0a 2020 2020 2020  03*nb03);.      
+0002c7d0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0002c7e0: 666c 6f61 7420 2a20 7920 3d20 2866 6c6f  float * y = (flo
+0002c7f0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0002c800: 7372 6331 2d3e 6461 7461 202b 2069 3032  src1->data + i02
+0002c810: 2a6e 6231 3220 2b20 6930 332a 6e62 3133  *nb12 + i03*nb13
+0002c820: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0002c830: 2020 2020 666c 6f61 7420 2a20 6420 3d20      float * d = 
+0002c840: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0002c850: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0002c860: 6930 322a 6e62 3220 2b20 6930 332a 6e62  i02*nb2 + i03*nb
+0002c870: 3329 3b0a 0a20 2020 2020 2020 2020 2020  3);..           
+0002c880: 2020 2020 202f 2f20 7a54 203d 2079 202a       // zT = y *
+0002c890: 2078 540a 2020 2020 2020 2020 2020 2020   xT.            
+0002c8a0: 2020 2020 6362 6c61 735f 7367 656d 6d28      cblas_sgemm(
+0002c8b0: 4362 6c61 7352 6f77 4d61 6a6f 722c 2043  CblasRowMajor, C
+0002c8c0: 626c 6173 4e6f 5472 616e 732c 2043 626c  blasNoTrans, Cbl
+0002c8d0: 6173 5472 616e 732c 0a20 2020 2020 2020  asTrans,.       
+0002c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c8f0: 206e 6531 312c 206e 6530 312c 206e 6531   ne11, ne01, ne1
+0002c900: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+0002c910: 2020 2020 2020 2020 2020 2031 2e30 662c             1.0f,
+0002c920: 2020 2020 792c 206e 6531 302c 0a20 2020      y, ne10,.   
+0002c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c940: 2020 2020 2020 2020 2020 2020 2020 782c                x,
+0002c950: 206e 6531 302c 0a20 2020 2020 2020 2020   ne10,.         
+0002c960: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+0002c970: 2e30 662c 2020 2020 642c 206e 6530 3129  .0f,    d, ne01)
+0002c980: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0002c990: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0002c9a0: 2020 202f 2f70 7269 6e74 6628 2243 424c     //printf("CBL
+0002c9b0: 4153 2046 3332 203d 2025 6620 6d73 2c20  AS F32 = %f ms, 
+0002c9c0: 2564 2078 2025 6420 7820 2564 2078 2025  %d x %d x %d x %
+0002c9d0: 645c 6e22 2c20 2867 676d 6c5f 7065 7266  d\n", (ggml_perf
+0002c9e0: 5f74 696d 655f 7573 2829 202d 2074 3029  _time_us() - t0)
+0002c9f0: 2f31 3030 302e 302c 206e 6530 2c20 6e65  /1000.0, ne0, ne
+0002ca00: 312c 206e 6532 2c20 6e65 3329 3b0a 0a20  1, ne2, ne3);.. 
+0002ca10: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0002ca20: 2020 207d 0a23 656e 6469 660a 0a20 2020     }.#endif..   
+0002ca30: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0002ca40: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+0002ca50: 4e49 5429 207b 0a20 2020 2020 2020 2072  NIT) {.        r
+0002ca60: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0002ca70: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+0002ca80: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0002ca90: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+0002caa0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+0002cab0: 7d0a 0a20 2020 202f 2f20 7061 7261 6c6c  }..    // parall
+0002cac0: 656c 697a 6520 6279 2073 7263 3020 726f  elize by src0 ro
+0002cad0: 7773 2075 7369 6e67 2067 676d 6c5f 7665  ws using ggml_ve
+0002cae0: 635f 646f 745f 6633 320a 0a20 2020 202f  c_dot_f32..    /
+0002caf0: 2f20 746f 7461 6c20 726f 7773 2069 6e20  / total rows in 
+0002cb00: 7372 6330 0a20 2020 2063 6f6e 7374 2069  src0.    const i
+0002cb10: 6e74 206e 7220 3d20 6e65 3031 2a6e 6530  nt nr = ne01*ne0
+0002cb20: 322a 6e65 3033 3b0a 0a20 2020 202f 2f20  2*ne03;..    // 
+0002cb30: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+0002cb40: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+0002cb50: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+0002cb60: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
+0002cb70: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
+0002cb80: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
+0002cb90: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
+0002cba0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0002cbb0: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
+0002cbc0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
+0002cbd0: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
+0002cbe0: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
+0002cbf0: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
+0002cc00: 2073 7263 3020 696e 6469 6365 730a 2020   src0 indices.  
+0002cc10: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0002cc20: 6930 3320 3d20 6972 2f28 6e65 3032 2a6e  i03 = ir/(ne02*n
+0002cc30: 6530 3129 3b0a 2020 2020 2020 2020 636f  e01);.        co
+0002cc40: 6e73 7420 696e 7420 6930 3220 3d20 2869  nst int i02 = (i
+0002cc50: 7220 2d20 6930 332a 6e65 3032 2a6e 6530  r - i03*ne02*ne0
+0002cc60: 3129 2f6e 6530 313b 0a20 2020 2020 2020  1)/ne01;.       
+0002cc70: 2063 6f6e 7374 2069 6e74 2069 3031 203d   const int i01 =
+0002cc80: 2028 6972 202d 2069 3033 2a6e 6530 322a   (ir - i03*ne02*
+0002cc90: 6e65 3031 202d 2069 3032 2a6e 6530 3129  ne01 - i02*ne01)
+0002cca0: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
+0002ccb0: 696e 7420 6963 203d 2030 3b20 6963 203c  int ic = 0; ic <
+0002ccc0: 206e 6531 313b 202b 2b69 6329 207b 0a20   ne11; ++ic) {. 
+0002ccd0: 2020 2020 2020 2020 2020 202f 2f20 7372             // sr
+0002cce0: 6331 2069 6e64 6963 6573 0a20 2020 2020  c1 indices.     
+0002ccf0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0002cd00: 2069 3133 203d 2069 3033 3b0a 2020 2020   i13 = i03;.    
+0002cd10: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0002cd20: 7420 6931 3220 3d20 6930 323b 0a20 2020  t i12 = i02;.   
+0002cd30: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0002cd40: 6e74 2069 3131 203d 2069 633b 0a0a 2020  nt i11 = ic;..  
+0002cd50: 2020 2020 2020 2020 2020 2f2f 2064 7374            // dst
+0002cd60: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+0002cd70: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0002cd80: 3020 3d20 6930 313b 0a20 2020 2020 2020  0 = i01;.       
+0002cd90: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0002cda0: 3120 3d20 6931 313b 0a20 2020 2020 2020  1 = i11;.       
+0002cdb0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0002cdc0: 3220 3d20 6930 323b 0a20 2020 2020 2020  2 = i02;.       
+0002cdd0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0002cde0: 3320 3d20 6930 333b 0a0a 2020 2020 2020  3 = i03;..      
+0002cdf0: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+0002ce00: 6f74 5f66 3332 286e 6530 302c 0a20 2020  ot_f32(ne00,.   
 0002ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ce20: 2020 2066 6f72 2028 696e 7420 6931 3120     for (int i11 
-0002ce30: 3d20 303b 2069 3131 203c 206e 6531 313b  = 0; i11 < ne11;
-0002ce40: 202b 2b69 3131 2920 7b0a 2020 2020 2020   ++i11) {.      
-0002ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ce60: 2020 666f 7220 2869 6e74 2069 3130 203d    for (int i10 =
-0002ce70: 2030 3b20 6931 3020 3c20 6e65 3130 3b20   0; i10 < ne10; 
-0002ce80: 2b2b 6931 3029 207b 0a20 2020 2020 2020  ++i10) {.       
-0002ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cea0: 2020 2020 2077 6461 7461 5b69 642b 2b5d       wdata[id++]
-0002ceb0: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
-0002cec0: 4650 3136 282a 2866 6c6f 6174 202a 2928  FP16(*(float *)(
-0002ced0: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
-0002cee0: 6174 6120 2b20 6931 332a 6e62 3133 202b  ata + i13*nb13 +
-0002cef0: 2069 3132 2a6e 6231 3220 2b20 6931 312a   i12*nb12 + i11*
-0002cf00: 6e62 3131 202b 2069 3130 2a6e 6231 3029  nb11 + i10*nb10)
-0002cf10: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0002cf20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0002cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cf40: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0002cf50: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0002cf60: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-0002cf70: 4747 4d4c 5f41 5353 4552 5428 6964 2a73  GGML_ASSERT(id*s
-0002cf80: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-0002cf90: 7429 203c 3d20 7061 7261 6d73 2d3e 7773  t) <= params->ws
-0002cfa0: 697a 6529 3b0a 0a20 2020 2020 2020 2020  ize);..         
-0002cfb0: 2020 2072 6574 7572 6e3b 0a20 2020 2020     return;.     
-0002cfc0: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-0002cfd0: 2054 4f44 4f3a 2066 6978 2074 6869 7320   TODO: fix this 
-0002cfe0: 6d65 6d73 6574 2028 7773 697a 6520 6973  memset (wsize is
-0002cff0: 206f 7665 7265 7374 696d 6174 6564 290a   overestimated).
-0002d000: 2020 2020 2020 2020 6d65 6d73 6574 2870          memset(p
-0002d010: 6172 616d 732d 3e77 6461 7461 2c20 302c  arams->wdata, 0,
-0002d020: 2070 6172 616d 732d 3e77 7369 7a65 293b   params->wsize);
-0002d030: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-0002d040: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-0002d050: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0002d060: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-0002d070: 5a45 2920 7b0a 2020 2020 2020 2020 6966  ZE) {.        if
-0002d080: 2028 6e62 3031 203e 3d20 6e62 3030 2920   (nb01 >= nb00) 
-0002d090: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-0002d0a0: 7475 726e 3b0a 2020 2020 2020 2020 7d0a  turn;.        }.
-0002d0b0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
-0002d0c0: 3a20 6669 7820 7468 6973 206d 656d 7365  : fix this memse
-0002d0d0: 7420 2877 7369 7a65 2069 7320 6f76 6572  t (wsize is over
-0002d0e0: 6573 7469 6d61 7465 6429 0a20 2020 2020  estimated).     
-0002d0f0: 2020 202f 2f61 7373 6572 7428 7061 7261     //assert(para
-0002d100: 6d73 2d3e 7773 697a 6520 3d3d 2028 6767  ms->wsize == (gg
-0002d110: 6d6c 5f6e 6279 7465 7328 6473 7429 202b  ml_nbytes(dst) +
-0002d120: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-0002d130: 292a 6e74 6829 3b0a 0a20 2020 2020 2020  )*nth);..       
-0002d140: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-0002d150: 6f6e 7374 2077 6461 7461 203d 2070 6172  onst wdata = par
-0002d160: 616d 732d 3e77 6461 7461 3b0a 0a20 2020  ams->wdata;..   
-0002d170: 2020 2020 202f 2f20 636f 6c73 2070 6572       // cols per
-0002d180: 2074 6872 6561 640a 2020 2020 2020 2020   thread.        
-0002d190: 636f 6e73 7420 696e 7420 6463 203d 2028  const int dc = (
-0002d1a0: 6e65 202b 206e 7468 202d 2031 292f 6e74  ne + nth - 1)/nt
-0002d1b0: 683b 0a0a 2020 2020 2020 2020 2f2f 2063  h;..        // c
-0002d1c0: 6f6c 2072 616e 6765 2066 6f72 2074 6869  ol range for thi
-0002d1d0: 7320 7468 7265 6164 0a20 2020 2020 2020  s thread.       
-0002d1e0: 2063 6f6e 7374 2069 6e74 2069 6330 203d   const int ic0 =
-0002d1f0: 2064 632a 6974 683b 0a20 2020 2020 2020   dc*ith;.       
-0002d200: 2063 6f6e 7374 2069 6e74 2069 6331 203d   const int ic1 =
-0002d210: 204d 494e 2869 6330 202b 2064 632c 206e   MIN(ic0 + dc, n
-0002d220: 6529 3b0a 0a20 2020 2020 2020 2066 6f72  e);..        for
-0002d230: 2028 696e 7420 6920 3d20 6963 303b 2069   (int i = ic0; i
-0002d240: 203c 2069 6331 3b20 2b2b 6929 207b 0a20   < ic1; ++i) {. 
-0002d250: 2020 2020 2020 2020 2020 2028 2866 6c6f             ((flo
-0002d260: 6174 202a 2920 6473 742d 3e64 6174 6129  at *) dst->data)
-0002d270: 5b69 5d20 3d20 4747 4d4c 5f46 5031 365f  [i] = GGML_FP16_
-0002d280: 544f 5f46 5033 3228 7764 6174 615b 695d  TO_FP32(wdata[i]
-0002d290: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
-0002d2a0: 2020 2020 2020 666f 7220 2869 6e74 206b        for (int k
-0002d2b0: 203d 2031 3b20 6b20 3c20 6e74 683b 206b   = 1; k < nth; k
-0002d2c0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0002d2d0: 2020 666f 7220 2869 6e74 2069 203d 2069    for (int i = i
-0002d2e0: 6330 3b20 6920 3c20 6963 313b 202b 2b69  c0; i < ic1; ++i
-0002d2f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0002d300: 2020 2020 2828 666c 6f61 7420 2a29 2064      ((float *) d
-0002d310: 7374 2d3e 6461 7461 295b 695d 202b 3d20  st->data)[i] += 
-0002d320: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-0002d330: 3228 7764 6174 615b 286e 6520 2b20 4341  2(wdata[(ne + CA
-0002d340: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
-0002d350: 3229 2a6b 202b 2069 5d29 3b0a 2020 2020  2)*k + i]);.    
-0002d360: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0002d370: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
-0002d380: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-0002d390: 6966 2028 6e62 3031 203e 3d20 6e62 3030  if (nb01 >= nb00
-0002d3a0: 2920 7b0a 2020 2020 2020 2020 2f2f 2066  ) {.        // f
-0002d3b0: 7031 3620 2d3e 2068 616c 6620 7468 6520  p16 -> half the 
-0002d3c0: 7369 7a65 2c20 736f 2064 6976 6964 6520  size, so divide 
-0002d3d0: 6279 2032 0a20 2020 2020 2020 202f 2f20  by 2.        // 
-0002d3e0: 544f 444f 3a20 646f 206e 6f74 2073 7570  TODO: do not sup
-0002d3f0: 706f 7274 2074 7261 6e73 706f 7365 6420  port transposed 
-0002d400: 7372 6331 0a20 2020 2020 2020 2061 7373  src1.        ass
-0002d410: 6572 7428 6e62 3130 2f32 203d 3d20 7369  ert(nb10/2 == si
-0002d420: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
-0002d430: 2929 3b0a 0a20 2020 2020 2020 202f 2f20  ));..        // 
-0002d440: 7061 7261 6c6c 656c 697a 6520 6279 2073  parallelize by s
-0002d450: 7263 3020 726f 7773 2075 7369 6e67 2067  rc0 rows using g
-0002d460: 676d 6c5f 7665 635f 646f 745f 6631 360a  gml_vec_dot_f16.
-0002d470: 0a20 2020 2020 2020 202f 2f20 746f 7461  .        // tota
-0002d480: 6c20 726f 7773 2069 6e20 7372 6330 0a20  l rows in src0. 
-0002d490: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0002d4a0: 206e 7220 3d20 6e65 3031 2a6e 6530 322a   nr = ne01*ne02*
-0002d4b0: 6e65 3033 3b0a 0a20 2020 2020 2020 202f  ne03;..        /
-0002d4c0: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-0002d4d0: 640a 2020 2020 2020 2020 636f 6e73 7420  d.        const 
-0002d4e0: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
-0002d4f0: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-0002d500: 2020 2020 2020 2f2f 2072 6f77 2072 616e        // row ran
-0002d510: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-0002d520: 6164 0a20 2020 2020 2020 2063 6f6e 7374  ad.        const
-0002d530: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-0002d540: 683b 0a20 2020 2020 2020 2063 6f6e 7374  h;.        const
-0002d550: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-0002d560: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-0002d570: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-0002d580: 5f74 202a 2077 6461 7461 203d 2070 6172  _t * wdata = par
-0002d590: 616d 732d 3e77 6461 7461 3b0a 0a20 2020  ams->wdata;..   
-0002d5a0: 2020 2020 2066 6f72 2028 696e 7420 6972       for (int ir
-0002d5b0: 203d 2069 7230 3b20 6972 203c 2069 7231   = ir0; ir < ir1
-0002d5c0: 3b20 2b2b 6972 2920 7b0a 2020 2020 2020  ; ++ir) {.      
-0002d5d0: 2020 2020 2020 2f2f 2073 7263 3020 696e        // src0 in
-0002d5e0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-0002d5f0: 2020 636f 6e73 7420 696e 7420 6930 3320    const int i03 
-0002d600: 3d20 6972 2f28 6e65 3032 2a6e 6530 3129  = ir/(ne02*ne01)
-0002d610: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0002d620: 6e73 7420 696e 7420 6930 3220 3d20 2869  nst int i02 = (i
-0002d630: 7220 2d20 6930 332a 6e65 3032 2a6e 6530  r - i03*ne02*ne0
-0002d640: 3129 2f6e 6530 313b 0a20 2020 2020 2020  1)/ne01;.       
-0002d650: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0002d660: 3031 203d 2028 6972 202d 2069 3033 2a6e  01 = (ir - i03*n
-0002d670: 6530 322a 6e65 3031 202d 2069 3032 2a6e  e02*ne01 - i02*n
-0002d680: 6530 3129 3b0a 0a20 2020 2020 2020 2020  e01);..         
-0002d690: 2020 2063 6f6e 7374 2069 6e74 2069 3133     const int i13
-0002d6a0: 203d 2069 3033 3b0a 2020 2020 2020 2020   = i03;.        
-0002d6b0: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
-0002d6c0: 3220 3d20 6930 323b 0a0a 2020 2020 2020  2 = i02;..      
-0002d6d0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002d6e0: 6930 203d 2069 3031 3b0a 2020 2020 2020  i0 = i01;.      
-0002d6f0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002d700: 6932 203d 2069 3032 3b0a 2020 2020 2020  i2 = i02;.      
-0002d710: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002d720: 6933 203d 2069 3033 3b0a 0a20 2020 2020  i3 = i03;..     
-0002d730: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-0002d740: 5f74 202a 2073 7263 305f 726f 7720 3d20  _t * src0_row = 
-0002d750: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-0002d760: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-0002d770: 6461 7461 202b 2028 6930 312a 6e62 3031  data + (i01*nb01
-0002d780: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
-0002d790: 332a 6e62 3033 2929 3b0a 2020 2020 2020  3*nb03));.      
-0002d7a0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-0002d7b0: 7420 2a20 7372 6331 5f63 6f6c 203d 2020  t * src1_col =  
-0002d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d7d0: 2020 2020 2020 2020 2020 2020 2020 7764                wd
-0002d7e0: 6174 6120 2b20 2820 2020 2020 2020 3020  ata + (       0 
-0002d7f0: 2b20 6931 322a 6e65 3131 202b 2069 3133  + i12*ne11 + i13
-0002d800: 2a6e 6531 322a 6e65 3131 292a 6e65 3030  *ne12*ne11)*ne00
-0002d810: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
-0002d820: 6c6f 6174 202a 2064 7374 5f63 6f6c 203d  loat * dst_col =
-0002d830: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0002d840: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-0002d850: 2028 6930 2a6e 6230 202b 2030 2a6e 6231   (i0*nb0 + 0*nb1
-0002d860: 202b 2069 322a 6e62 3220 2b20 6933 2a6e   + i2*nb2 + i3*n
-0002d870: 6233 2929 3b0a 0a20 2020 2020 2020 2020  b3));..         
-0002d880: 2020 2061 7373 6572 7428 6e65 3030 2025     assert(ne00 %
-0002d890: 2033 3220 3d3d 2030 293b 0a0a 2020 2020   32 == 0);..    
-0002d8a0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0002d8b0: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
-0002d8c0: 3131 3b20 2b2b 6963 2920 7b0a 2020 2020  11; ++ic) {.    
-0002d8d0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0002d8e0: 5f76 6563 5f64 6f74 5f66 3136 286e 6530  _vec_dot_f16(ne0
-0002d8f0: 302c 2026 6473 745f 636f 6c5b 6963 2a6e  0, &dst_col[ic*n
-0002d900: 6530 5d2c 2073 7263 305f 726f 772c 2073  e0], src0_row, s
-0002d910: 7263 315f 636f 6c20 2b20 6963 2a6e 6530  rc1_col + ic*ne0
-0002d920: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-0002d930: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-0002d940: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-0002d950: 202f 2f20 7061 7261 6c6c 656c 697a 6520   // parallelize 
-0002d960: 6279 2073 7263 3120 636f 6c75 6d6e 7320  by src1 columns 
-0002d970: 7573 696e 6720 6767 6d6c 5f76 6563 5f6d  using ggml_vec_m
-0002d980: 6164 5f66 3136 0a20 2020 2020 2020 202f  ad_f16.        /
-0002d990: 2f20 6561 6368 2074 6872 6561 6420 6861  / each thread ha
-0002d9a0: 7320 6974 7320 6f77 6e20 776f 726b 2064  s its own work d
-0002d9b0: 6174 610a 2020 2020 2020 2020 2f2f 2064  ata.        // d
-0002d9c0: 7572 696e 6720 4649 4e41 4c49 5a45 2077  uring FINALIZE w
-0002d9d0: 6520 6163 6375 6d75 6c61 7465 2061 6c6c  e accumulate all
-0002d9e0: 2077 6f72 6b20 6461 7461 2069 6e74 6f20   work data into 
-0002d9f0: 6473 740a 0a20 2020 2020 2020 202f 2f20  dst..        // 
-0002da00: 746f 7461 6c20 636f 6c75 6d6e 7320 696e  total columns in
-0002da10: 2073 7263 310a 2020 2020 2020 2020 636f   src1.        co
-0002da20: 6e73 7420 696e 7420 6e63 203d 206e 6531  nst int nc = ne1
-0002da30: 303b 0a0a 2020 2020 2020 2020 2f2f 2063  0;..        // c
-0002da40: 6f6c 756d 6e73 2070 6572 2074 6872 6561  olumns per threa
-0002da50: 640a 2020 2020 2020 2020 636f 6e73 7420  d.        const 
-0002da60: 696e 7420 6463 203d 2028 6e63 202b 206e  int dc = (nc + n
-0002da70: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-0002da80: 2020 2020 2020 2f2f 2063 6f6c 756d 6e20        // column 
-0002da90: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
-0002daa0: 6872 6561 640a 2020 2020 2020 2020 636f  hread.        co
-0002dab0: 6e73 7420 696e 7420 6963 3020 3d20 6463  nst int ic0 = dc
-0002dac0: 2a69 7468 3b0a 2020 2020 2020 2020 636f  *ith;.        co
-0002dad0: 6e73 7420 696e 7420 6963 3120 3d20 4d49  nst int ic1 = MI
-0002dae0: 4e28 6963 3020 2b20 6463 2c20 6e63 293b  N(ic0 + dc, nc);
-0002daf0: 0a0a 2020 2020 2020 2020 2f2f 2077 6f72  ..        // wor
-0002db00: 6b20 6461 7461 2066 6f72 2074 6872 6561  k data for threa
-0002db10: 640a 2020 2020 2020 2020 636f 6e73 7420  d.        const 
-0002db20: 696e 7420 776f 203d 2028 6e65 202b 2043  int wo = (ne + C
-0002db30: 4143 4845 5f4c 494e 455f 5349 5a45 5f46  ACHE_LINE_SIZE_F
-0002db40: 3332 292a 6974 683b 0a20 2020 2020 2020  32)*ith;.       
-0002db50: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-0002db60: 6f6e 7374 2077 6461 7461 203d 2070 6172  onst wdata = par
-0002db70: 616d 732d 3e77 6461 7461 3b0a 0a20 2020  ams->wdata;..   
-0002db80: 2020 2020 2066 6f72 2028 696e 7420 6931       for (int i1
-0002db90: 3320 3d20 303b 2069 3133 203c 206e 6531  3 = 0; i13 < ne1
-0002dba0: 333b 202b 2b69 3133 2920 7b0a 2020 2020  3; ++i13) {.    
-0002dbb0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0002dbc0: 2069 3132 203d 2030 3b20 6931 3220 3c20   i12 = 0; i12 < 
-0002dbd0: 6e65 3132 3b20 2b2b 6931 3229 207b 0a20  ne12; ++i12) {. 
-0002dbe0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002dbf0: 6f72 2028 696e 7420 6931 3120 3d20 303b  or (int i11 = 0;
-0002dc00: 2069 3131 203c 206e 6531 313b 202b 2b69   i11 < ne11; ++i
-0002dc10: 3131 2920 7b0a 2020 2020 2020 2020 2020  11) {.          
-0002dc20: 2020 2020 2020 2020 2020 2f2f 2064 7374            // dst
-0002dc30: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-0002dc40: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0002dc50: 7374 2069 6e74 2069 3120 3d20 6931 313b  st int i1 = i11;
+0002ce20: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+0002ce30: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+0002ce40: 2b20 2869 302a 6e62 3020 2b20 6931 2a6e  + (i0*nb0 + i1*n
+0002ce50: 6231 202b 2069 322a 6e62 3220 2b20 6933  b1 + i2*nb2 + i3
+0002ce60: 2a6e 6233 2929 2c0a 2020 2020 2020 2020  *nb3)),.        
+0002ce70: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+0002ce80: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0002ce90: 7372 6330 2d3e 6461 7461 202b 2028 6930  src0->data + (i0
+0002cea0: 312a 6e62 3031 202b 2069 3032 2a6e 6230  1*nb01 + i02*nb0
+0002ceb0: 3220 2b20 6930 332a 6e62 3033 2929 2c0a  2 + i03*nb03)),.
+0002cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ced0: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+0002cee0: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
+0002cef0: 7461 202b 2028 6931 312a 6e62 3131 202b  ta + (i11*nb11 +
+0002cf00: 2069 3132 2a6e 6231 3220 2b20 6931 332a   i12*nb12 + i13*
+0002cf10: 6e62 3133 2929 293b 0a20 2020 2020 2020  nb13)));.       
+0002cf20: 207d 0a20 2020 207d 0a0a 2020 2020 2f2f   }.    }..    //
+0002cf30: 696e 7436 345f 7420 7431 203d 2067 676d  int64_t t1 = ggm
+0002cf40: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
+0002cf50: 3b0a 2020 2020 2f2f 7374 6174 6963 2069  ;.    //static i
+0002cf60: 6e74 3634 5f74 2061 6363 203d 2030 3b0a  nt64_t acc = 0;.
+0002cf70: 2020 2020 2f2f 6163 6320 2b3d 2074 3120      //acc += t1 
+0002cf80: 2d20 7430 3b0a 2020 2020 2f2f 6966 2028  - t0;.    //if (
+0002cf90: 7431 202d 2074 3020 3e20 3130 2920 7b0a  t1 - t0 > 10) {.
+0002cfa0: 2020 2020 2f2f 2020 2020 7072 696e 7466      //    printf
+0002cfb0: 2822 5c6e 2229 3b0a 2020 2020 2f2f 2020  ("\n");.    //  
+0002cfc0: 2020 7072 696e 7466 2822 6e65 3030 203d    printf("ne00 =
+0002cfd0: 2025 3564 2c20 6e65 3031 203d 2025 3564   %5d, ne01 = %5d
+0002cfe0: 2c20 6e65 3032 203d 2025 3564 2c20 6e65  , ne02 = %5d, ne
+0002cff0: 3033 203d 2025 3564 5c6e 222c 206e 6530  03 = %5d\n", ne0
+0002d000: 302c 206e 6530 312c 206e 6530 322c 206e  0, ne01, ne02, n
+0002d010: 6530 3329 3b0a 2020 2020 2f2f 2020 2020  e03);.    //    
+0002d020: 7072 696e 7466 2822 6e62 3030 203d 2025  printf("nb00 = %
+0002d030: 3564 2c20 6e62 3031 203d 2025 3564 2c20  5d, nb01 = %5d, 
+0002d040: 6e62 3032 203d 2025 3564 2c20 6e62 3033  nb02 = %5d, nb03
+0002d050: 203d 2025 3564 5c6e 222c 206e 6230 302c   = %5d\n", nb00,
+0002d060: 206e 6230 312c 206e 6230 322c 206e 6230   nb01, nb02, nb0
+0002d070: 3329 3b0a 2020 2020 2f2f 2020 2020 7072  3);.    //    pr
+0002d080: 696e 7466 2822 6e65 3130 203d 2025 3564  intf("ne10 = %5d
+0002d090: 2c20 6e65 3131 203d 2025 3564 2c20 6e65  , ne11 = %5d, ne
+0002d0a0: 3132 203d 2025 3564 2c20 6e65 3133 203d  12 = %5d, ne13 =
+0002d0b0: 2025 3564 5c6e 222c 206e 6531 302c 206e   %5d\n", ne10, n
+0002d0c0: 6531 312c 206e 6531 322c 206e 6531 3329  e11, ne12, ne13)
+0002d0d0: 3b0a 2020 2020 2f2f 2020 2020 7072 696e  ;.    //    prin
+0002d0e0: 7466 2822 6e62 3130 203d 2025 3564 2c20  tf("nb10 = %5d, 
+0002d0f0: 6e62 3131 203d 2025 3564 2c20 6e62 3132  nb11 = %5d, nb12
+0002d100: 203d 2025 3564 2c20 6e62 3133 203d 2025   = %5d, nb13 = %
+0002d110: 3564 5c6e 222c 206e 6231 302c 206e 6231  5d\n", nb10, nb1
+0002d120: 312c 206e 6231 322c 206e 6231 3329 3b0a  1, nb12, nb13);.
+0002d130: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
+0002d140: 6628 2258 5858 5858 5858 5858 5858 5858  f("XXXXXXXXXXXXX
+0002d150: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0002d160: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0002d170: 5858 5858 5858 5820 7461 736b 2025 642f  XXXXXXX task %d/
+0002d180: 2564 3a20 2564 2075 732c 2061 6363 203d  %d: %d us, acc =
+0002d190: 2025 645c 6e22 2c20 6974 682c 206e 7468   %d\n", ith, nth
+0002d1a0: 2c20 2869 6e74 2920 2874 3120 2d20 7430  , (int) (t1 - t0
+0002d1b0: 292c 2028 696e 7429 2061 6363 293b 0a20  ), (int) acc);. 
+0002d1c0: 2020 202f 2f7d 0a7d 0a0a 7374 6174 6963     //}.}..static
+0002d1d0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0002d1e0: 7465 5f66 6f72 7761 7264 5f6d 756c 5f6d  te_forward_mul_m
+0002d1f0: 6174 5f66 3136 5f66 3332 280a 2020 2020  at_f16_f32(.    
+0002d200: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0002d210: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0002d220: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0002d230: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0002d240: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002d250: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0002d260: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0002d270: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0002d280: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+0002d290: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002d2a0: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
+0002d2b0: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
+0002d2c0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
+0002d2d0: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
+0002d2e0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0002d2f0: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
+0002d300: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0002d310: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
+0002d320: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+0002d330: 696e 7420 6e65 3032 203d 2073 7263 302d  int ne02 = src0-
+0002d340: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
+0002d350: 7420 696e 7420 6e65 3033 203d 2073 7263  t int ne03 = src
+0002d360: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
+0002d370: 6f6e 7374 2069 6e74 206e 6531 3020 3d20  onst int ne10 = 
+0002d380: 7372 6331 2d3e 6e65 5b30 5d3b 0a20 2020  src1->ne[0];.   
+0002d390: 2063 6f6e 7374 2069 6e74 206e 6531 3120   const int ne11 
+0002d3a0: 3d20 7372 6331 2d3e 6e65 5b31 5d3b 0a20  = src1->ne[1];. 
+0002d3b0: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
+0002d3c0: 3220 3d20 7372 6331 2d3e 6e65 5b32 5d3b  2 = src1->ne[2];
+0002d3d0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002d3e0: 6531 3320 3d20 7372 6331 2d3e 6e65 5b33  e13 = src1->ne[3
+0002d3f0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0002d400: 7420 6e65 3020 203d 2064 7374 2d3e 6e65  t ne0  = dst->ne
+0002d410: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+0002d420: 6e74 206e 6531 2020 3d20 6473 742d 3e6e  nt ne1  = dst->n
+0002d430: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+0002d440: 696e 7420 6e65 3220 203d 2064 7374 2d3e  int ne2  = dst->
+0002d450: 6e65 5b32 5d3b 0a20 2020 2063 6f6e 7374  ne[2];.    const
+0002d460: 2069 6e74 206e 6533 2020 3d20 6473 742d   int ne3  = dst-
+0002d470: 3e6e 655b 335d 3b0a 2020 2020 2f2f 636f  >ne[3];.    //co
+0002d480: 6e73 7420 696e 7420 6e65 2020 203d 206e  nst int ne   = n
+0002d490: 6530 2a6e 6531 2a6e 6532 2a6e 6533 3b0a  e0*ne1*ne2*ne3;.
+0002d4a0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002d4b0: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
+0002d4c0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0002d4d0: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
+0002d4e0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0002d4f0: 6e74 206e 6230 3220 3d20 7372 6330 2d3e  nt nb02 = src0->
+0002d500: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+0002d510: 2069 6e74 206e 6230 3320 3d20 7372 6330   int nb03 = src0
+0002d520: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+0002d530: 6e73 7420 696e 7420 6e62 3130 203d 2073  nst int nb10 = s
+0002d540: 7263 312d 3e6e 625b 305d 3b0a 2020 2020  rc1->nb[0];.    
+0002d550: 636f 6e73 7420 696e 7420 6e62 3131 203d  const int nb11 =
+0002d560: 2073 7263 312d 3e6e 625b 315d 3b0a 2020   src1->nb[1];.  
+0002d570: 2020 636f 6e73 7420 696e 7420 6e62 3132    const int nb12
+0002d580: 203d 2073 7263 312d 3e6e 625b 325d 3b0a   = src1->nb[2];.
+0002d590: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0002d5a0: 3133 203d 2073 7263 312d 3e6e 625b 335d  13 = src1->nb[3]
+0002d5b0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0002d5c0: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
+0002d5d0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0002d5e0: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
+0002d5f0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0002d600: 6e74 206e 6232 2020 3d20 6473 742d 3e6e  nt nb2  = dst->n
+0002d610: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0002d620: 696e 7420 6e62 3320 203d 2064 7374 2d3e  int nb3  = dst->
+0002d630: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+0002d640: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
+0002d650: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
+0002d660: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
+0002d670: 616d 732d 3e6e 7468 3b0a 0a20 2020 2047  ams->nth;..    G
+0002d680: 474d 4c5f 4153 5345 5254 286e 6530 3220  GML_ASSERT(ne02 
+0002d690: 3d3d 206e 6531 3229 3b0a 2020 2020 4747  == ne12);.    GG
+0002d6a0: 4d4c 5f41 5353 4552 5428 6e65 3033 203d  ML_ASSERT(ne03 =
+0002d6b0: 3d20 6e65 3133 293b 0a20 2020 2047 474d  = ne13);.    GGM
+0002d6c0: 4c5f 4153 5345 5254 286e 6532 2020 3d3d  L_ASSERT(ne2  ==
+0002d6d0: 206e 6531 3229 3b0a 2020 2020 4747 4d4c   ne12);.    GGML
+0002d6e0: 5f41 5353 4552 5428 6e65 3320 203d 3d20  _ASSERT(ne3  == 
+0002d6f0: 6e65 3133 293b 0a0a 2020 2020 2f2f 2054  ne13);..    // T
+0002d700: 4f44 4f3a 2077 6520 646f 6e27 7420 7375  ODO: we don't su
+0002d710: 7070 6f72 7420 7065 726d 7574 6564 2073  pport permuted s
+0002d720: 7263 300a 2020 2020 4747 4d4c 5f41 5353  rc0.    GGML_ASS
+0002d730: 4552 5428 6e62 3030 203d 3d20 7369 7a65  ERT(nb00 == size
+0002d740: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+0002d750: 3b0a 0a20 2020 202f 2f20 6473 7420 6361  ;..    // dst ca
+0002d760: 6e6e 6f74 2062 6520 7472 616e 7370 6f73  nnot be transpos
+0002d770: 6564 206f 7220 7065 726d 7574 6564 0a20  ed or permuted. 
+0002d780: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0002d790: 6230 203d 3d20 7369 7a65 6f66 2866 6c6f  b0 == sizeof(flo
+0002d7a0: 6174 2929 3b0a 2020 2020 4747 4d4c 5f41  at));.    GGML_A
+0002d7b0: 5353 4552 5428 6e62 3020 3c3d 206e 6231  SSERT(nb0 <= nb1
+0002d7c0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0002d7d0: 5254 286e 6231 203c 3d20 6e62 3229 3b0a  RT(nb1 <= nb2);.
+0002d7e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0002d7f0: 6e62 3220 3c3d 206e 6233 293b 0a0a 2020  nb2 <= nb3);..  
+0002d800: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+0002d810: 3020 3d3d 206e 6530 3129 3b0a 2020 2020  0 == ne01);.    
+0002d820: 4747 4d4c 5f41 5353 4552 5428 6e65 3120  GGML_ASSERT(ne1 
+0002d830: 3d3d 206e 6531 3129 3b0a 2020 2020 4747  == ne11);.    GG
+0002d840: 4d4c 5f41 5353 4552 5428 6e65 3220 3d3d  ML_ASSERT(ne2 ==
+0002d850: 206e 6530 3229 3b0a 2020 2020 4747 4d4c   ne02);.    GGML
+0002d860: 5f41 5353 4552 5428 6e65 3320 3d3d 206e  _ASSERT(ne3 == n
+0002d870: 6530 3329 3b0a 0a20 2020 202f 2f20 6e62  e03);..    // nb
+0002d880: 3031 203e 3d20 6e62 3030 202d 2073 7263  01 >= nb00 - src
+0002d890: 3020 6973 206e 6f74 2074 7261 6e73 706f  0 is not transpo
+0002d8a0: 7365 640a 2020 2020 2f2f 2020 2063 6f6d  sed.    //   com
+0002d8b0: 7075 7465 2062 7920 7372 6330 2072 6f77  pute by src0 row
+0002d8c0: 730a 0a23 6966 2064 6566 696e 6564 2847  s..#if defined(G
+0002d8d0: 474d 4c5f 5553 455f 4143 4345 4c45 5241  GML_USE_ACCELERA
+0002d8e0: 5445 2920 7c7c 2064 6566 696e 6564 2847  TE) || defined(G
+0002d8f0: 474d 4c5f 5553 455f 4f50 454e 424c 4153  GML_USE_OPENBLAS
+0002d900: 290a 2020 2020 6966 2028 6767 6d6c 5f63  ).    if (ggml_c
+0002d910: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+0002d920: 756c 5f6d 6174 5f75 7365 5f62 6c61 7328  ul_mat_use_blas(
+0002d930: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+0002d940: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
+0002d950: 5f41 5353 4552 5428 6e62 3130 203d 3d20  _ASSERT(nb10 == 
+0002d960: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+0002d970: 0a20 2020 2020 2020 2069 6620 2870 6172  .        if (par
+0002d980: 616d 732d 3e69 7468 2021 3d20 3029 207b  ams->ith != 0) {
+0002d990: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002d9a0: 7572 6e3b 0a20 2020 2020 2020 207d 0a0a  urn;.        }..
+0002d9b0: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
+0002d9c0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+0002d9d0: 5f54 4153 4b5f 494e 4954 2920 7b0a 2020  _TASK_INIT) {.  
+0002d9e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002d9f0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+0002da00: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
+0002da10: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0002da20: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+0002da30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002da40: 6e3b 0a20 2020 2020 2020 207d 0a0a 2020  n;.        }..  
+0002da50: 2020 2020 2020 666c 6f61 7420 2a20 636f        float * co
+0002da60: 6e73 7420 7764 6174 6120 3d20 7061 7261  nst wdata = para
+0002da70: 6d73 2d3e 7764 6174 613b 0a0a 2020 2020  ms->wdata;..    
+0002da80: 2020 2020 666f 7220 2869 6e74 2069 3033      for (int i03
+0002da90: 203d 2030 3b20 6930 3320 3c20 6e65 3033   = 0; i03 < ne03
+0002daa0: 3b20 6930 332b 2b29 207b 0a20 2020 2020  ; i03++) {.     
+0002dab0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0002dac0: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
+0002dad0: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
+0002dae0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0002daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002db00: 2020 2020 7369 7a65 5f74 2069 6420 3d20      size_t id = 
+0002db10: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0002db20: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0002db30: 6930 3120 3d20 303b 2069 3031 203c 206e  i01 = 0; i01 < n
+0002db40: 6530 313b 202b 2b69 3031 2920 7b0a 2020  e01; ++i01) {.  
+0002db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002db60: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0002db70: 3030 203d 2030 3b20 6930 3020 3c20 6e65  00 = 0; i00 < ne
+0002db80: 3030 3b20 2b2b 6930 3029 207b 0a20 2020  00; ++i00) {.   
+0002db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dba0: 2020 2020 2020 2020 2077 6461 7461 5b69           wdata[i
+0002dbb0: 642b 2b5d 203d 2047 474d 4c5f 4650 3136  d++] = GGML_FP16
+0002dbc0: 5f54 4f5f 4650 3332 282a 2867 676d 6c5f  _TO_FP32(*(ggml_
+0002dbd0: 6670 3136 5f74 202a 2920 2828 6368 6172  fp16_t *) ((char
+0002dbe0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+0002dbf0: 2069 3033 2a6e 6230 3320 2b20 6930 322a   i03*nb03 + i02*
+0002dc00: 6e62 3032 202b 2069 3031 2a6e 6230 3120  nb02 + i01*nb01 
+0002dc10: 2b20 6930 302a 6e62 3030 2929 3b0a 2020  + i00*nb00));.  
+0002dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dc30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0002dc40: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0002dc50: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
 0002dc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002dc70: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0002dc80: 3220 3d20 6931 323b 0a20 2020 2020 2020  2 = i12;.       
-0002dc90: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0002dca0: 7374 2069 6e74 2069 3320 3d20 6931 333b  st int i3 = i13;
-0002dcb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002dcc0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-0002dcd0: 7420 2a20 6473 745f 726f 7720 3d20 7764  t * dst_row = wd
-0002dce0: 6174 6120 2b20 776f 202b 2069 332a 6e65  ata + wo + i3*ne
-0002dcf0: 322a 6e65 312a 6e65 3020 2b20 6932 2a6e  2*ne1*ne0 + i2*n
-0002dd00: 6531 2a6e 6530 202b 2069 312a 6e65 303b  e1*ne0 + i1*ne0;
-0002dd10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002dd20: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0002dd30: 6320 3d20 6963 303b 2069 6320 3c20 6963  c = ic0; ic < ic
-0002dd40: 313b 202b 2b69 6329 207b 0a20 2020 2020  1; ++ic) {.     
-0002dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd60: 2020 202f 2f20 7372 6331 2069 6e64 6963     // src1 indic
-0002dd70: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-0002dd80: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0002dd90: 2069 6e74 2069 3130 203d 2069 633b 0a0a   int i10 = ic;..
+0002dc70: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+0002dc80: 203d 2077 6461 7461 3b0a 2020 2020 2020   = wdata;.      
+0002dc90: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0002dca0: 666c 6f61 7420 2a20 7920 3d20 2866 6c6f  float * y = (flo
+0002dcb0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0002dcc0: 7372 6331 2d3e 6461 7461 202b 2069 3032  src1->data + i02
+0002dcd0: 2a6e 6231 3220 2b20 6930 332a 6e62 3133  *nb12 + i03*nb13
+0002dce0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0002dcf0: 2020 2020 666c 6f61 7420 2a20 6420 3d20      float * d = 
+0002dd00: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0002dd10: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0002dd20: 6930 322a 6e62 3220 2b20 6930 332a 6e62  i02*nb2 + i03*nb
+0002dd30: 3329 3b0a 0a20 2020 2020 2020 2020 2020  3);..           
+0002dd40: 2020 2020 202f 2f20 7a54 203d 2079 202a       // zT = y *
+0002dd50: 2078 540a 2020 2020 2020 2020 2020 2020   xT.            
+0002dd60: 2020 2020 6362 6c61 735f 7367 656d 6d28      cblas_sgemm(
+0002dd70: 4362 6c61 7352 6f77 4d61 6a6f 722c 2043  CblasRowMajor, C
+0002dd80: 626c 6173 4e6f 5472 616e 732c 2043 626c  blasNoTrans, Cbl
+0002dd90: 6173 5472 616e 732c 0a20 2020 2020 2020  asTrans,.       
 0002dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ddb0: 2020 2020 2020 2020 2f2f 2073 7263 3020          // src0 
-0002ddc0: 696e 6469 6365 730a 2020 2020 2020 2020  indices.        
-0002ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dde0: 636f 6e73 7420 696e 7420 6930 3320 3d20  const int i03 = 
-0002ddf0: 6931 333b 0a20 2020 2020 2020 2020 2020  i13;.           
-0002de00: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0002de10: 7374 2069 6e74 2069 3032 203d 2069 3132  st int i02 = i12
-0002de20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0002de30: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0002de40: 696e 7420 6930 3020 3d20 6963 3b0a 0a20  int i00 = ic;.. 
-0002de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de60: 2020 2020 2020 2061 7373 6572 7428 7369         assert(si
-0002de70: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
-0002de80: 292a 2877 6f20 2b20 6933 2a6e 6532 2a6e  )*(wo + i3*ne2*n
-0002de90: 6531 2a6e 6530 202b 2069 322a 6e65 312a  e1*ne0 + i2*ne1*
-0002dea0: 6e65 3020 2b20 6931 2a6e 6530 202b 206e  ne0 + i1*ne0 + n
-0002deb0: 6530 3129 203c 3d20 7061 7261 6d73 2d3e  e01) <= params->
-0002dec0: 7773 697a 6529 3b0a 0a20 2020 2020 2020  wsize);..       
-0002ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dee0: 2067 676d 6c5f 6670 3136 5f74 202a 2073   ggml_fp16_t * s
-0002def0: 7263 305f 636f 6c20 3d20 2028 6767 6d6c  rc0_col =  (ggml
-0002df00: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-0002df10: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0002df20: 2b20 2869 3030 2a6e 6230 3020 2b20 6930  + (i00*nb00 + i0
-0002df30: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
-0002df40: 3329 293b 0a20 2020 2020 2020 2020 2020  3));.           
-0002df50: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0002df60: 6174 2020 2020 2020 2020 2073 7263 315f  at         src1_
-0002df70: 7661 6c20 3d20 2a20 2020 2020 2028 666c  val = *      (fl
-0002df80: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-0002df90: 2073 7263 312d 3e64 6174 6120 2b20 2869   src1->data + (i
-0002dfa0: 3130 2a6e 6231 3020 2b20 6931 312a 6e62  10*nb10 + i11*nb
-0002dfb0: 3131 202b 2069 3132 2a6e 6231 3220 2b20  11 + i12*nb12 + 
-0002dfc0: 6931 332a 6e62 3133 2929 3b0a 0a20 2020  i13*nb13));..   
-0002dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dfe0: 2020 2020 2067 676d 6c5f 7665 635f 6d61       ggml_vec_ma
-0002dff0: 645f 6631 3628 6e65 3031 2c20 6473 745f  d_f16(ne01, dst_
-0002e000: 726f 772c 2073 7263 305f 636f 6c2c 2073  row, src0_col, s
-0002e010: 7263 315f 7661 6c29 3b0a 2020 2020 2020  rc1_val);.      
-0002e020: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0002e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e040: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0002e050: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0002e060: 0a20 2020 202f 2f69 6e74 3634 5f74 2074  .    //int64_t t
-0002e070: 3120 3d20 6767 6d6c 5f74 696d 655f 7573  1 = ggml_time_us
-0002e080: 2829 3b0a 2020 2020 2f2f 7374 6174 6963  ();.    //static
-0002e090: 2069 6e74 3634 5f74 2061 6363 203d 2030   int64_t acc = 0
-0002e0a0: 3b0a 2020 2020 2f2f 6163 6320 2b3d 2074  ;.    //acc += t
-0002e0b0: 3120 2d20 7430 3b0a 2020 2020 2f2f 6966  1 - t0;.    //if
-0002e0c0: 2028 7431 202d 2074 3020 3e20 3130 2920   (t1 - t0 > 10) 
-0002e0d0: 7b0a 2020 2020 2f2f 2020 2020 7072 696e  {.    //    prin
-0002e0e0: 7466 2822 5c6e 2229 3b0a 2020 2020 2f2f  tf("\n");.    //
-0002e0f0: 2020 2020 7072 696e 7466 2822 6e65 3030      printf("ne00
-0002e100: 203d 2025 3564 2c20 6e65 3031 203d 2025   = %5d, ne01 = %
-0002e110: 3564 2c20 6e65 3032 203d 2025 3564 2c20  5d, ne02 = %5d, 
-0002e120: 6e65 3033 203d 2025 3564 5c6e 222c 206e  ne03 = %5d\n", n
-0002e130: 6530 302c 206e 6530 312c 206e 6530 322c  e00, ne01, ne02,
-0002e140: 206e 6530 3329 3b0a 2020 2020 2f2f 2020   ne03);.    //  
-0002e150: 2020 7072 696e 7466 2822 6e62 3030 203d    printf("nb00 =
-0002e160: 2025 3564 2c20 6e62 3031 203d 2025 3564   %5d, nb01 = %5d
-0002e170: 2c20 6e62 3032 203d 2025 3564 2c20 6e62  , nb02 = %5d, nb
-0002e180: 3033 203d 2025 3564 5c6e 222c 206e 6230  03 = %5d\n", nb0
-0002e190: 302c 206e 6230 312c 206e 6230 322c 206e  0, nb01, nb02, n
-0002e1a0: 6230 3329 3b0a 2020 2020 2f2f 2020 2020  b03);.    //    
-0002e1b0: 7072 696e 7466 2822 6e65 3130 203d 2025  printf("ne10 = %
-0002e1c0: 3564 2c20 6e65 3131 203d 2025 3564 2c20  5d, ne11 = %5d, 
-0002e1d0: 6e65 3132 203d 2025 3564 2c20 6e65 3133  ne12 = %5d, ne13
-0002e1e0: 203d 2025 3564 5c6e 222c 206e 6531 302c   = %5d\n", ne10,
-0002e1f0: 206e 6531 312c 206e 6531 322c 206e 6531   ne11, ne12, ne1
-0002e200: 3329 3b0a 0a20 2020 202f 2f20 2020 2070  3);..    //    p
-0002e210: 7269 6e74 6628 2258 5858 5858 5858 5858  rintf("XXXXXXXXX
-0002e220: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-0002e230: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-0002e240: 5858 5858 5858 5858 5858 5820 7461 736b  XXXXXXXXXXX task
-0002e250: 2025 642f 2564 3a20 2564 2075 732c 2061   %d/%d: %d us, a
-0002e260: 6363 203d 2025 645c 6e22 2c20 6974 682c  cc = %d\n", ith,
-0002e270: 206e 7468 2c20 2869 6e74 2920 2874 3120   nth, (int) (t1 
-0002e280: 2d20 7430 292c 2028 696e 7429 2061 6363  - t0), (int) acc
-0002e290: 293b 0a20 2020 202f 2f7d 0a7d 0a0a 7374  );.    //}.}..st
-0002e2a0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0002e2b0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-0002e2c0: 756c 5f6d 6174 5f71 345f 305f 6633 3228  ul_mat_q4_0_f32(
-0002e2d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0002e2e0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0002e2f0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0002e300: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0002e310: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0002e320: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0002e330: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0002e340: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0002e350: 7372 6331 2c0a 2020 2020 2020 2020 2020  src1,.          
-0002e360: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0002e370: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-0002e380: 2020 2020 696e 7436 345f 7420 7430 203d      int64_t t0 =
-0002e390: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
-0002e3a0: 7573 2829 3b0a 2020 2020 554e 5553 4544  us();.    UNUSED
-0002e3b0: 2874 3029 3b0a 0a20 2020 2063 6f6e 7374  (t0);..    const
-0002e3c0: 2069 6e74 206e 6530 3020 3d20 7372 6330   int ne00 = src0
-0002e3d0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-0002e3e0: 7374 2069 6e74 206e 6530 3120 3d20 7372  st int ne01 = sr
-0002e3f0: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c0->ne[1];.    c
-0002e400: 6f6e 7374 2069 6e74 206e 6530 3220 3d20  onst int ne02 = 
-0002e410: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
-0002e420: 2063 6f6e 7374 2069 6e74 206e 6530 3320   const int ne03 
-0002e430: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
-0002e440: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-0002e450: 3130 203d 2073 7263 312d 3e6e 655b 305d  10 = src1->ne[0]
-0002e460: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0002e470: 6e65 3131 203d 2073 7263 312d 3e6e 655b  ne11 = src1->ne[
-0002e480: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0002e490: 7420 6e65 3132 203d 2073 7263 312d 3e6e  t ne12 = src1->n
-0002e4a0: 655b 325d 3b0a 2020 2020 636f 6e73 7420  e[2];.    const 
-0002e4b0: 696e 7420 6e65 3133 203d 2073 7263 312d  int ne13 = src1-
-0002e4c0: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
-0002e4d0: 7374 2069 6e74 206e 6530 2020 3d20 6473  st int ne0  = ds
-0002e4e0: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
-0002e4f0: 6e73 7420 696e 7420 6e65 3120 203d 2064  nst int ne1  = d
-0002e500: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 2063  st->ne[1];.    c
-0002e510: 6f6e 7374 2069 6e74 206e 6532 2020 3d20  onst int ne2  = 
-0002e520: 6473 742d 3e6e 655b 325d 3b0a 2020 2020  dst->ne[2];.    
-0002e530: 636f 6e73 7420 696e 7420 6e65 3320 203d  const int ne3  =
-0002e540: 2064 7374 2d3e 6e65 5b33 5d3b 0a20 2020   dst->ne[3];.   
-0002e550: 2063 6f6e 7374 2069 6e74 206e 6520 2020   const int ne   
-0002e560: 3d20 6e65 302a 6e65 312a 6e65 322a 6e65  = ne0*ne1*ne2*ne
-0002e570: 333b 0a0a 2020 2020 636f 6e73 7420 696e  3;..    const in
-0002e580: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
-0002e590: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-0002e5a0: 696e 7420 6e62 3031 203d 2073 7263 302d  int nb01 = src0-
-0002e5b0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-0002e5c0: 7420 696e 7420 6e62 3032 203d 2073 7263  t int nb02 = src
-0002e5d0: 302d 3e6e 625b 325d 3b0a 2020 2020 636f  0->nb[2];.    co
-0002e5e0: 6e73 7420 696e 7420 6e62 3033 203d 2073  nst int nb03 = s
-0002e5f0: 7263 302d 3e6e 625b 335d 3b0a 0a20 2020  rc0->nb[3];..   
-0002e600: 2063 6f6e 7374 2069 6e74 206e 6231 3020   const int nb10 
-0002e610: 3d20 7372 6331 2d3e 6e62 5b30 5d3b 0a20  = src1->nb[0];. 
-0002e620: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
-0002e630: 3120 3d20 7372 6331 2d3e 6e62 5b31 5d3b  1 = src1->nb[1];
-0002e640: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0002e650: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
-0002e660: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0002e670: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
-0002e680: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0002e690: 696e 7420 6e62 3020 203d 2064 7374 2d3e  int nb0  = dst->
-0002e6a0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-0002e6b0: 2069 6e74 206e 6231 2020 3d20 6473 742d   int nb1  = dst-
-0002e6c0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-0002e6d0: 7420 696e 7420 6e62 3220 203d 2064 7374  t int nb2  = dst
-0002e6e0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-0002e6f0: 7374 2069 6e74 206e 6233 2020 3d20 6473  st int nb3  = ds
-0002e700: 742d 3e6e 625b 335d 3b0a 0a20 2020 2063  t->nb[3];..    c
-0002e710: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
-0002e720: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
-0002e730: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
-0002e740: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
-0002e750: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-0002e760: 3032 203d 3d20 6e65 3132 293b 0a20 2020  02 == ne12);.   
-0002e770: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-0002e780: 3320 3d3d 206e 6531 3329 3b0a 2020 2020  3 == ne13);.    
-0002e790: 4747 4d4c 5f41 5353 4552 5428 6e65 3220  GGML_ASSERT(ne2 
-0002e7a0: 203d 3d20 6e65 3132 293b 0a20 2020 2047   == ne12);.    G
-0002e7b0: 474d 4c5f 4153 5345 5254 286e 6533 2020  GML_ASSERT(ne3  
-0002e7c0: 3d3d 206e 6531 3329 3b0a 0a20 2020 202f  == ne13);..    /
-0002e7d0: 2f20 544f 444f 3a20 7765 2064 6f6e 2774  / TODO: we don't
-0002e7e0: 2073 7570 706f 7274 2070 6572 6d75 7465   support permute
-0002e7f0: 6420 7372 6330 0a20 2020 2047 474d 4c5f  d src0.    GGML_
-0002e800: 4153 5345 5254 286e 6230 3020 3d3d 2028  ASSERT(nb00 == (
-0002e810: 696e 7429 2047 474d 4c5f 5459 5045 5f53  int) GGML_TYPE_S
-0002e820: 495a 455b 4747 4d4c 5f54 5950 455f 5134  IZE[GGML_TYPE_Q4
-0002e830: 5f30 5d20 7c7c 206e 6230 3120 3d3d 2028  _0] || nb01 == (
-0002e840: 696e 7429 2047 474d 4c5f 5459 5045 5f53  int) GGML_TYPE_S
-0002e850: 495a 455b 4747 4d4c 5f54 5950 455f 5134  IZE[GGML_TYPE_Q4
-0002e860: 5f30 5d29 3b0a 0a20 2020 202f 2f20 6473  _0]);..    // ds
-0002e870: 7420 6361 6e6e 6f74 2062 6520 7472 616e  t cannot be tran
-0002e880: 7370 6f73 6564 206f 7220 7065 726d 7574  sposed or permut
-0002e890: 6564 0a20 2020 2047 474d 4c5f 4153 5345  ed.    GGML_ASSE
-0002e8a0: 5254 286e 6230 203d 3d20 7369 7a65 6f66  RT(nb0 == sizeof
-0002e8b0: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
-0002e8c0: 4d4c 5f41 5353 4552 5428 6e62 3020 3c3d  ML_ASSERT(nb0 <=
-0002e8d0: 206e 6231 293b 0a20 2020 2047 474d 4c5f   nb1);.    GGML_
-0002e8e0: 4153 5345 5254 286e 6231 203c 3d20 6e62  ASSERT(nb1 <= nb
-0002e8f0: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
-0002e900: 4552 5428 6e62 3220 3c3d 206e 6233 293b  ERT(nb2 <= nb3);
-0002e910: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-0002e920: 5428 6e65 3020 3d3d 206e 6530 3129 3b0a  T(ne0 == ne01);.
-0002e930: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0002e940: 6e65 3120 3d3d 206e 6531 3129 3b0a 2020  ne1 == ne11);.  
-0002e950: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-0002e960: 3220 3d3d 206e 6530 3229 3b0a 2020 2020  2 == ne02);.    
-0002e970: 4747 4d4c 5f41 5353 4552 5428 6e65 3320  GGML_ASSERT(ne3 
-0002e980: 3d3d 206e 6530 3329 3b0a 0a20 2020 202f  == ne03);..    /
-0002e990: 2f20 6e62 3031 203e 3d20 6e62 3030 202d  / nb01 >= nb00 -
-0002e9a0: 2073 7263 3020 6973 206e 6f74 2074 7261   src0 is not tra
-0002e9b0: 6e73 706f 7365 640a 2020 2020 2f2f 2020  nsposed.    //  
-0002e9c0: 2063 6f6d 7075 7465 2062 7920 7372 6330   compute by src0
-0002e9d0: 2072 6f77 730a 2020 2020 2f2f 0a20 2020   rows.    //.   
-0002e9e0: 202f 2f20 6e62 3030 203c 2020 6e62 3031   // nb00 <  nb01
-0002e9f0: 202d 2073 7263 3020 6973 2074 7261 6e73   - src0 is trans
-0002ea00: 706f 7365 640a 2020 2020 2f2f 2020 2063  posed.    //   c
-0002ea10: 6f6d 7075 7465 2062 7920 7372 6330 2063  ompute by src0 c
-0002ea20: 6f6c 756d 6e73 0a0a 2369 6620 6465 6669  olumns..#if defi
-0002ea30: 6e65 6428 4747 4d4c 5f55 5345 5f41 4343  ned(GGML_USE_ACC
-0002ea40: 454c 4552 4154 4529 207c 7c20 6465 6669  ELERATE) || defi
-0002ea50: 6e65 6428 4747 4d4c 5f55 5345 5f4f 5045  ned(GGML_USE_OPE
-0002ea60: 4e42 4c41 5329 0a20 2020 2069 6620 2867  NBLAS).    if (g
-0002ea70: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0002ea80: 6172 645f 6d75 6c5f 6d61 745f 7573 655f  ard_mul_mat_use_
-0002ea90: 626c 6173 2873 7263 302c 2073 7263 312c  blas(src0, src1,
-0002eaa0: 2064 7374 2929 207b 0a20 2020 2020 2020   dst)) {.       
-0002eab0: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
-0002eac0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-0002ead0: 7429 293b 0a0a 2020 2020 2020 2020 6966  t));..        if
-0002eae0: 2028 7061 7261 6d73 2d3e 6974 6820 213d   (params->ith !=
-0002eaf0: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-0002eb00: 2020 7265 7475 726e 3b0a 2020 2020 2020    return;.      
-0002eb10: 2020 7d0a 0a20 2020 2020 2020 2069 6620    }..        if 
-0002eb20: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-0002eb30: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
-0002eb40: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
-0002eb50: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
-0002eb60: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
-0002eb70: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0002eb80: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-0002eb90: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0002eba0: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
-0002ebb0: 7d0a 0a20 2020 2020 2020 2066 6c6f 6174  }..        float
-0002ebc0: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
-0002ebd0: 2070 6172 616d 732d 3e77 6461 7461 3b0a   params->wdata;.
-0002ebe0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-0002ebf0: 7420 6930 3320 3d20 303b 2069 3033 203c  t i03 = 0; i03 <
-0002ec00: 206e 6530 333b 2069 3033 2b2b 2920 7b0a   ne03; i03++) {.
-0002ec10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002ec20: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
-0002ec30: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
-0002ec40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0002ec50: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0002ec60: 2020 2020 2020 2020 2069 6e74 2069 6420           int id 
-0002ec70: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-0002ec80: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0002ec90: 7420 6930 3120 3d20 303b 2069 3031 203c  t i01 = 0; i01 <
-0002eca0: 206e 6530 313b 202b 2b69 3031 2920 7b0a   ne01; ++i01) {.
-0002ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ecc0: 2020 2020 2020 2020 2f2f 666f 7220 2869          //for (i
-0002ecd0: 6e74 2069 3030 203d 2030 3b20 6930 3020  nt i00 = 0; i00 
-0002ece0: 3c20 6e65 3030 3b20 2b2b 6930 3029 207b  < ne00; ++i00) {
-0002ecf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ed00: 2020 2020 2020 2020 202f 2f20 2020 2077           //    w
-0002ed10: 6461 7461 5b69 642b 2b5d 203d 2047 474d  data[id++] = GGM
-0002ed20: 4c5f 4650 3136 5f54 4f5f 4650 3332 282a  L_FP16_TO_FP32(*
-0002ed30: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-0002ed40: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-0002ed50: 6461 7461 202b 2069 3033 2a6e 6230 3320  data + i03*nb03 
-0002ed60: 2b20 6930 322a 6e62 3032 202b 2069 3031  + i02*nb02 + i01
-0002ed70: 2a6e 6230 3120 2b20 6930 302a 6e62 3030  *nb01 + i00*nb00
-0002ed80: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-0002ed90: 2020 2020 2020 2020 2020 2020 2f2f 7d0a              //}.
-0002eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002edb0: 2020 2020 2020 2020 6465 7175 616e 7469          dequanti
-0002edc0: 7a65 5f72 6f77 5f71 345f 3028 2863 6861  ze_row_q4_0((cha
-0002edd0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0002ede0: 2b20 6930 332a 6e62 3033 202b 2069 3032  + i03*nb03 + i02
-0002edf0: 2a6e 6230 3220 2b20 6930 312a 6e62 3031  *nb02 + i01*nb01
-0002ee00: 2c20 7764 6174 6120 2b20 6964 2c20 6e65  , wdata + id, ne
-0002ee10: 3030 293b 0a20 2020 2020 2020 2020 2020  00);.           
-0002ee20: 2020 2020 2020 2020 2020 2020 2069 6420               id 
-0002ee30: 2b3d 206e 6530 303b 0a20 2020 2020 2020  += ne00;.       
-0002ee40: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0002ee50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0002ee60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002ee70: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
-0002ee80: 7820 3d20 7764 6174 613b 0a20 2020 2020  x = wdata;.     
-0002ee90: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0002eea0: 2066 6c6f 6174 202a 2079 203d 2028 666c   float * y = (fl
-0002eeb0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-0002eec0: 2073 7263 312d 3e64 6174 6120 2b20 6930   src1->data + i0
-0002eed0: 322a 6e62 3132 202b 2069 3033 2a6e 6231  2*nb12 + i03*nb1
-0002eee0: 3329 3b0a 0a20 2020 2020 2020 2020 2020  3);..           
-0002eef0: 2020 2020 202f 2f20 2020 2020 2066 6c6f       //      flo
-0002ef00: 6174 202a 207a 203d 2020 2020 2020 2020  at * z =        
-0002ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef20: 2020 7764 6174 6120 2b20 6e65 3030 2a6e    wdata + ne00*n
-0002ef30: 6530 313b 0a0a 2020 2020 2020 2020 2020  e01;..          
-0002ef40: 2020 2020 2020 2f2f 207a 203d 2078 202a        // z = x *
-0002ef50: 2079 540a 2020 2020 2020 2020 2020 2020   yT.            
-0002ef60: 2020 2020 2f2f 7b0a 2020 2020 2020 2020      //{.        
-0002ef70: 2020 2020 2020 2020 2f2f 2020 2020 6362          //    cb
-0002ef80: 6c61 735f 7367 656d 6d28 4362 6c61 7352  las_sgemm(CblasR
-0002ef90: 6f77 4d61 6a6f 722c 2043 626c 6173 4e6f  owMajor, CblasNo
-0002efa0: 5472 616e 732c 2043 626c 6173 5472 616e  Trans, CblasTran
-0002efb0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002efc0: 2020 202f 2f20 2020 2020 2020 2020 2020     //           
-0002efd0: 206e 6530 312c 206e 6531 312c 206e 6530   ne01, ne11, ne0
-0002efe0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0002eff0: 2020 202f 2f20 2020 2020 2020 2020 2020     //           
-0002f000: 2031 2e30 662c 2078 2c20 6e65 3030 2c0a   1.0f, x, ne00,.
-0002f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f020: 2f2f 2020 2020 2020 2020 2020 2020 2020  //              
-0002f030: 2020 2020 792c 206e 6530 302c 0a20 2020      y, ne00,.   
-0002f040: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0002f050: 2020 2020 2020 2020 2020 2030 2e30 662c             0.0f,
-0002f060: 207a 2c20 6e65 3131 293b 0a20 2020 2020   z, ne11);.     
-0002f070: 2020 2020 2020 2020 2020 202f 2f7d 0a0a             //}..
-0002f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f090: 666c 6f61 7420 2a20 6420 3d20 2866 6c6f  float * d = (flo
-0002f0a0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-0002f0b0: 6473 742d 3e64 6174 6120 2b20 6930 322a  dst->data + i02*
-0002f0c0: 6e62 3220 2b20 6930 332a 6e62 3329 3b0a  nb2 + i03*nb3);.
-0002f0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f0e0: 202f 2f20 7472 616e 7370 6f73 6520 7a0a   // transpose z.
-0002f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f100: 2f2f 666f 7220 2869 6e74 206a 203d 2030  //for (int j = 0
-0002f110: 3b20 6a20 3c20 6e65 3131 3b20 2b2b 6a29  ; j < ne11; ++j)
-0002f120: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0002f130: 2020 202f 2f20 2020 2066 6f72 2028 696e     //    for (in
-0002f140: 7420 6920 3d20 303b 2069 203c 206e 6530  t i = 0; i < ne0
-0002f150: 313b 202b 2b69 2920 7b0a 2020 2020 2020  1; ++i) {.      
-0002f160: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-0002f170: 2020 2020 645b 6a2a 6e65 3031 202b 2069      d[j*ne01 + i
-0002f180: 5d20 3d20 7a5b 692a 6e65 3131 202b 206a  ] = z[i*ne11 + j
-0002f190: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0002f1a0: 2020 202f 2f20 2020 207d 0a20 2020 2020     //    }.     
-0002f1b0: 2020 2020 2020 2020 2020 202f 2f7d 0a0a             //}..
-0002f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1d0: 7b0a 2369 6620 310a 2020 2020 2020 2020  {.#if 1.        
-0002f1e0: 2020 2020 2020 2020 2020 2020 2f2f 207a              // z
-0002f1f0: 5420 3d20 7920 2a20 7854 0a20 2020 2020  T = y * xT.     
-0002f200: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002f210: 626c 6173 5f73 6765 6d6d 2843 626c 6173  blas_sgemm(Cblas
-0002f220: 526f 774d 616a 6f72 2c20 4362 6c61 734e  RowMajor, CblasN
-0002f230: 6f54 7261 6e73 2c20 4362 6c61 7354 7261  oTrans, CblasTra
-0002f240: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0002f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f260: 6e65 3131 2c20 6e65 3031 2c20 6e65 3130  ne11, ne01, ne10
-0002f270: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002f280: 2020 2020 2020 2020 2020 2020 2020 312e                1.
-0002f290: 3066 2c20 2020 2079 2c20 6e65 3030 2c0a  0f,    y, ne00,.
-0002f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2c0: 2020 2020 2078 2c20 6e65 3030 2c0a 2020       x, ne00,.  
-0002f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2e0: 2020 2020 2020 2020 2020 302e 3066 2c20            0.0f, 
-0002f2f0: 2020 2064 2c20 6e65 3031 293b 0a23 656c     d, ne01);.#el
-0002f300: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0002f310: 2020 2020 2020 202f 2f20 7a54 203d 2028         // zT = (
-0002f320: 7854 202a 2079 2954 0a20 2020 2020 2020  xT * y)T.       
-0002f330: 2020 2020 2020 2020 2020 2020 2063 626c               cbl
-0002f340: 6173 5f73 6765 6d6d 2843 626c 6173 436f  as_sgemm(CblasCo
-0002f350: 6c4d 616a 6f72 2c20 4362 6c61 7354 7261  lMajor, CblasTra
-0002f360: 6e73 2c20 4362 6c61 734e 6f54 7261 6e73  ns, CblasNoTrans
-0002f370: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002f380: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0002f390: 3031 2c20 6e65 3131 2c20 6e65 3130 2c0a  01, ne11, ne10,.
-0002f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3b0: 2020 2020 2020 2020 2020 2020 312e 3066              1.0f
-0002f3c0: 2c20 2020 2078 2c20 6e65 3030 2c0a 2020  ,    x, ne00,.  
-0002f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3f0: 2020 2079 2c20 6e65 3030 2c0a 2020 2020     y, ne00,.    
-0002f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f410: 2020 2020 2020 2020 302e 3066 2c20 2020          0.0f,   
-0002f420: 2064 2c20 6e65 3031 293b 0a23 656e 6469   d, ne01);.#endi
-0002f430: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-0002f440: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0002f450: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0002f460: 2020 2020 202f 2a70 7269 6e74 6628 2243       /*printf("C
-0002f470: 424c 4153 2051 345f 3020 3d20 2566 206d  BLAS Q4_0 = %f m
-0002f480: 732c 2025 6420 7820 2564 2078 2025 6420  s, %d x %d x %d 
-0002f490: 7820 2564 5c6e 222c 2028 6767 6d6c 5f70  x %d\n", (ggml_p
-0002f4a0: 6572 665f 7469 6d65 5f75 7328 2920 2d20  erf_time_us() - 
-0002f4b0: 7430 292f 3130 3030 2e30 2c20 6e65 302c  t0)/1000.0, ne0,
-0002f4c0: 206e 6531 2c20 6e65 322c 206e 6533 293b   ne1, ne2, ne3);
-0002f4d0: 2a2f 0a0a 2020 2020 2020 2020 7265 7475  */..        retu
-0002f4e0: 726e 3b0a 2020 2020 7d0a 2365 6e64 6966  rn;.    }.#endif
-0002f4f0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0002f500: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0002f510: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-0002f520: 2020 2020 2f2f 7072 696e 7466 2822 4848      //printf("HH
-0002f530: 4848 4848 4848 4820 6974 6820 3d20 2564  HHHHHHH ith = %d
-0002f540: 2c20 6e74 6820 3d20 2564 5c6e 222c 2069  , nth = %d\n", i
-0002f550: 7468 2c20 6e74 6829 3b0a 2020 2020 2020  th, nth);.      
-0002f560: 2020 6966 2028 6e62 3031 203e 3d20 6e62    if (nb01 >= nb
-0002f570: 3030 2920 7b0a 2020 2020 2020 2020 2020  00) {.          
-0002f580: 2020 6368 6172 202a 2077 6461 7461 203d    char * wdata =
-0002f590: 2070 6172 616d 732d 3e77 6461 7461 3b0a   params->wdata;.
-0002f5a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0002f5b0: 2028 696e 7420 6931 3320 3d20 303b 2069   (int i13 = 0; i
-0002f5c0: 3133 203c 206e 6531 333b 202b 2b69 3133  13 < ne13; ++i13
-0002f5d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0002f5e0: 2020 2020 666f 7220 2869 6e74 2069 3132      for (int i12
-0002f5f0: 203d 2030 3b20 6931 3220 3c20 6e65 3132   = 0; i12 < ne12
-0002f600: 3b20 2b2b 6931 3229 207b 0a20 2020 2020  ; ++i12) {.     
-0002f610: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002f620: 6f72 2028 696e 7420 6931 3120 3d20 303b  or (int i11 = 0;
-0002f630: 2069 3131 203c 206e 6531 313b 202b 2b69   i11 < ne11; ++i
-0002f640: 3131 2920 7b0a 2020 2020 2020 2020 2020  11) {.          
-0002f650: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0002f660: 666f 7220 2869 6e74 2069 3130 203d 2030  for (int i10 = 0
-0002f670: 3b20 6931 3020 3c20 6e65 3130 3b20 2b2b  ; i10 < ne10; ++
-0002f680: 6931 3029 207b 0a20 2020 2020 2020 2020  i10) {.         
-0002f690: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0002f6a0: 2f20 2020 2077 6461 7461 5b69 642b 2b5d  /    wdata[id++]
-0002f6b0: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
-0002f6c0: 4650 3136 282a 2866 6c6f 6174 202a 2928  FP16(*(float *)(
-0002f6d0: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
-0002f6e0: 6174 6120 2b20 6931 332a 6e62 3133 202b  ata + i13*nb13 +
-0002f6f0: 2069 3132 2a6e 6231 3220 2b20 6931 312a   i12*nb12 + i11*
-0002f700: 6e62 3131 202b 2069 3130 2a6e 6231 3029  nb11 + i10*nb10)
-0002f710: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0002f720: 2020 2020 2020 2020 2020 202f 2f7d 0a20             //}. 
-0002f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f740: 2020 2020 2020 2071 7561 6e74 697a 655f         quantize_
-0002f750: 726f 775f 7134 5f30 2828 666c 6f61 7420  row_q4_0((float 
-0002f760: 2a29 2828 6368 6172 202a 2920 7372 6331  *)((char *) src1
-0002f770: 2d3e 6461 7461 202b 2069 3133 2a6e 6231  ->data + i13*nb1
-0002f780: 3320 2b20 6931 322a 6e62 3132 202b 2069  3 + i12*nb12 + i
-0002f790: 3131 2a6e 6231 3129 2c20 2876 6f69 6420  11*nb11), (void 
-0002f7a0: 2a29 2077 6461 7461 2c20 6e65 3130 293b  *) wdata, ne10);
-0002f7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f7c0: 2020 2020 2020 2020 2077 6461 7461 202b           wdata +
-0002f7d0: 3d20 286e 6531 302a 4747 4d4c 5f54 5950  = (ne10*GGML_TYP
-0002f7e0: 455f 5349 5a45 5b47 474d 4c5f 5459 5045  E_SIZE[GGML_TYPE
-0002f7f0: 5f51 345f 305d 292f 4747 4d4c 5f42 4c43  _Q4_0])/GGML_BLC
-0002f800: 4b5f 5349 5a45 5b47 474d 4c5f 5459 5045  K_SIZE[GGML_TYPE
-0002f810: 5f51 345f 305d 3b0a 2020 2020 2020 2020  _Q4_0];.        
-0002f820: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0002f830: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0002f840: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0002f850: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002f860: 6e3b 0a20 2020 2020 2020 207d 0a0a 2020  n;.        }..  
-0002f870: 2020 2020 2020 2f2f 2054 4f44 4f3a 2066        // TODO: f
-0002f880: 6978 2074 6869 7320 6d65 6d73 6574 2028  ix this memset (
-0002f890: 7773 697a 6520 6973 206f 7665 7265 7374  wsize is overest
-0002f8a0: 696d 6174 6564 290a 2020 2020 2020 2020  imated).        
-0002f8b0: 6d65 6d73 6574 2870 6172 616d 732d 3e77  memset(params->w
-0002f8c0: 6461 7461 2c20 302c 2070 6172 616d 732d  data, 0, params-
-0002f8d0: 3e77 7369 7a65 293b 0a20 2020 2020 2020  >wsize);.       
-0002f8e0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-0002f8f0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0002f900: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0002f910: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-0002f920: 2020 2020 2020 6966 2028 6e62 3031 203e        if (nb01 >
-0002f930: 3d20 6e62 3030 2920 7b0a 2020 2020 2020  = nb00) {.      
-0002f940: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0002f950: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0002f960: 2066 6c6f 6174 202a 2063 6f6e 7374 2077   float * const w
-0002f970: 6461 7461 203d 2070 6172 616d 732d 3e77  data = params->w
-0002f980: 6461 7461 3b0a 0a20 2020 2020 2020 202f  data;..        /
-0002f990: 2f20 636f 6c73 2070 6572 2074 6872 6561  / cols per threa
-0002f9a0: 640a 2020 2020 2020 2020 636f 6e73 7420  d.        const 
-0002f9b0: 696e 7420 6463 203d 2028 6e65 202b 206e  int dc = (ne + n
-0002f9c0: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-0002f9d0: 2020 2020 2020 2f2f 2063 6f6c 2072 616e        // col ran
-0002f9e0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-0002f9f0: 6164 0a20 2020 2020 2020 2063 6f6e 7374  ad.        const
-0002fa00: 2069 6e74 2069 6330 203d 2064 632a 6974   int ic0 = dc*it
-0002fa10: 683b 0a20 2020 2020 2020 2063 6f6e 7374  h;.        const
-0002fa20: 2069 6e74 2069 6331 203d 204d 494e 2869   int ic1 = MIN(i
-0002fa30: 6330 202b 2064 632c 206e 6529 3b0a 0a20  c0 + dc, ne);.. 
-0002fa40: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0002fa50: 6370 795f 6633 3228 6963 3120 2d20 6963  cpy_f32(ic1 - ic
-0002fa60: 302c 2028 666c 6f61 7420 2a29 2064 7374  0, (float *) dst
-0002fa70: 2d3e 6461 7461 202b 2069 6330 2c20 7764  ->data + ic0, wd
-0002fa80: 6174 6120 2b20 6963 3029 3b0a 0a20 2020  ata + ic0);..   
-0002fa90: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
-0002faa0: 3d20 313b 206b 203c 206e 7468 3b20 6b2b  = 1; k < nth; k+
-0002fab0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0002fac0: 2067 676d 6c5f 7665 635f 6163 635f 6633   ggml_vec_acc_f3
-0002fad0: 3228 6963 3120 2d20 6963 302c 2028 666c  2(ic1 - ic0, (fl
-0002fae0: 6f61 7420 2a29 2064 7374 2d3e 6461 7461  oat *) dst->data
-0002faf0: 202b 2069 6330 2c20 7764 6174 6120 2b20   + ic0, wdata + 
-0002fb00: 286e 6520 2b20 4341 4348 455f 4c49 4e45  (ne + CACHE_LINE
-0002fb10: 5f53 495a 455f 4633 3229 2a6b 202b 2069  _SIZE_F32)*k + i
-0002fb20: 6330 293b 0a20 2020 2020 2020 207d 0a0a  c0);.        }..
-0002fb30: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0002fb40: 2020 2020 7d0a 0a20 2020 2069 6620 286e      }..    if (n
-0002fb50: 6230 3120 3e3d 206e 6230 3029 207b 0a20  b01 >= nb00) {. 
-0002fb60: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
-0002fb70: 646f 206e 6f74 2073 7570 706f 7274 2074  do not support t
-0002fb80: 7261 6e73 706f 7365 6420 7372 6331 0a0a  ransposed src1..
-0002fb90: 2020 2020 2020 2020 2f2f 2070 6172 616c          // paral
-0002fba0: 6c65 6c69 7a65 2062 7920 7372 6330 2072  lelize by src0 r
-0002fbb0: 6f77 7320 7573 696e 6720 6767 6d6c 5f76  ows using ggml_v
-0002fbc0: 6563 5f64 6f74 5f71 345f 300a 0a20 2020  ec_dot_q4_0..   
-0002fbd0: 2020 2020 202f 2f20 746f 7461 6c20 726f       // total ro
-0002fbe0: 7773 2069 6e20 7372 6330 0a20 2020 2020  ws in src0.     
-0002fbf0: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
-0002fc00: 3d20 6e65 3031 2a6e 6530 322a 6e65 3033  = ne01*ne02*ne03
-0002fc10: 3b0a 0a20 2020 2020 2020 202f 2f20 726f  ;..        // ro
-0002fc20: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-0002fc30: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0002fc40: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-0002fc50: 2031 292f 6e74 683b 0a0a 2020 2020 2020   1)/nth;..      
-0002fc60: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-0002fc70: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-0002fc80: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0002fc90: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-0002fca0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0002fcb0: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-0002fcc0: 2064 722c 206e 7229 3b0a 0a20 2020 2020   dr, nr);..     
-0002fcd0: 2020 2076 6f69 6420 2a20 7764 6174 6120     void * wdata 
-0002fce0: 3d20 7061 7261 6d73 2d3e 7764 6174 613b  = params->wdata;
-0002fcf0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-0002fd00: 6e74 2069 7220 3d20 6972 303b 2069 7220  nt ir = ir0; ir 
-0002fd10: 3c20 6972 313b 202b 2b69 7229 207b 0a20  < ir1; ++ir) {. 
-0002fd20: 2020 2020 2020 2020 2020 202f 2f20 7372             // sr
-0002fd30: 6330 2069 6e64 6963 6573 0a20 2020 2020  c0 indices.     
-0002fd40: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0002fd50: 2069 3033 203d 2069 722f 286e 6530 322a   i03 = ir/(ne02*
-0002fd60: 6e65 3031 293b 0a20 2020 2020 2020 2020  ne01);.         
-0002fd70: 2020 2063 6f6e 7374 2069 6e74 2069 3032     const int i02
-0002fd80: 203d 2028 6972 202d 2069 3033 2a6e 6530   = (ir - i03*ne0
-0002fd90: 322a 6e65 3031 292f 6e65 3031 3b0a 2020  2*ne01)/ne01;.  
-0002fda0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0002fdb0: 696e 7420 6930 3120 3d20 2869 7220 2d20  int i01 = (ir - 
-0002fdc0: 6930 332a 6e65 3032 2a6e 6530 3120 2d20  i03*ne02*ne01 - 
-0002fdd0: 6930 322a 6e65 3031 293b 0a0a 2020 2020  i02*ne01);..    
-0002fde0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0002fdf0: 7420 6931 3320 3d20 6930 333b 0a20 2020  t i13 = i03;.   
-0002fe00: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-0002fe10: 6e74 2069 3132 203d 2069 3032 3b0a 0a20  nt i12 = i02;.. 
-0002fe20: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0002fe30: 2069 6e74 2069 3020 3d20 6930 313b 0a20   int i0 = i01;. 
-0002fe40: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0002fe50: 2069 6e74 2069 3220 3d20 6930 323b 0a20   int i2 = i02;. 
-0002fe60: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0002fe70: 2069 6e74 2069 3320 3d20 6930 333b 0a0a   int i3 = i03;..
-0002fe80: 2020 2020 2020 2020 2020 2020 766f 6964              void
-0002fe90: 202a 2073 7263 305f 726f 7720 3d20 2876   * src0_row = (v
-0002fea0: 6f69 6420 2a29 2028 2863 6861 7220 2a29  oid *) ((char *)
-0002feb0: 2073 7263 302d 3e64 6174 6120 2b20 2869   src0->data + (i
-0002fec0: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
-0002fed0: 3032 202b 2069 3033 2a6e 6230 3329 293b  02 + i03*nb03));
-0002fee0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-0002fef0: 7220 2a20 7372 6331 5f63 6f6c 203d 2020  r * src1_col =  
-0002ff00: 2020 2020 2020 2020 2828 6368 6172 202a          ((char *
-0002ff10: 2920 2020 2020 2077 6461 7461 202b 2028  )      wdata + (
-0002ff20: 2020 2020 2020 2830 202b 2069 3132 2a6e        (0 + i12*n
-0002ff30: 6531 3120 2b20 6931 332a 6e65 3132 2a6e  e11 + i13*ne12*n
-0002ff40: 6531 3129 2a6e 6530 302a 4747 4d4c 5f54  e11)*ne00*GGML_T
-0002ff50: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
-0002ff60: 5045 5f51 345f 305d 292f 4747 4d4c 5f42  PE_Q4_0])/GGML_B
-0002ff70: 4c43 4b5f 5349 5a45 5b47 474d 4c5f 5459  LCK_SIZE[GGML_TY
-0002ff80: 5045 5f51 345f 305d 293b 0a0a 2020 2020  PE_Q4_0]);..    
-0002ff90: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-0002ffa0: 6473 745f 636f 6c20 3d20 2866 6c6f 6174  dst_col = (float
-0002ffb0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-0002ffc0: 742d 3e64 6174 6120 2b20 2869 302a 6e62  t->data + (i0*nb
-0002ffd0: 3020 2b20 302a 6e62 3120 2b20 6932 2a6e  0 + 0*nb1 + i2*n
-0002ffe0: 6232 202b 2069 332a 6e62 3329 293b 0a0a  b2 + i3*nb3));..
-0002fff0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00030000: 7274 286e 6530 3020 2520 3332 203d 3d20  rt(ne00 % 32 == 
-00030010: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
-00030020: 2066 6f72 2028 696e 7420 6963 203d 2030   for (int ic = 0
-00030030: 3b20 6963 203c 206e 6531 313b 202b 2b69  ; ic < ne11; ++i
-00030040: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
-00030050: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
-00030060: 745f 7134 5f30 286e 6530 302c 2026 6473  t_q4_0(ne00, &ds
-00030070: 745f 636f 6c5b 6963 2a6e 6530 5d2c 2073  t_col[ic*ne0], s
-00030080: 7263 305f 726f 772c 2028 2876 6f69 6420  rc0_row, ((void 
-00030090: 2a29 2028 7372 6331 5f63 6f6c 202b 2028  *) (src1_col + (
-000300a0: 6963 2a6e 6530 302a 4747 4d4c 5f54 5950  ic*ne00*GGML_TYP
-000300b0: 455f 5349 5a45 5b47 474d 4c5f 5459 5045  E_SIZE[GGML_TYPE
-000300c0: 5f51 345f 305d 292f 4747 4d4c 5f42 4c43  _Q4_0])/GGML_BLC
-000300d0: 4b5f 5349 5a45 5b47 474d 4c5f 5459 5045  K_SIZE[GGML_TYPE
-000300e0: 5f51 345f 305d 2929 293b 0a20 2020 2020  _Q4_0])));.     
-000300f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00030100: 207d 0a20 2020 207d 2065 6c73 6520 7b0a   }.    } else {.
-00030110: 2020 2020 2020 2020 2f2f 7072 696e 7466          //printf
-00030120: 2822 4141 4141 4120 6974 6820 3d20 2564  ("AAAAA ith = %d
-00030130: 2c20 6e74 6820 3d20 2564 5c6e 222c 2069  , nth = %d\n", i
-00030140: 7468 2c20 6e74 6829 3b0a 2020 2020 2020  th, nth);.      
-00030150: 2020 2f2f 2070 6172 616c 6c65 6c69 7a65    // parallelize
-00030160: 2062 7920 7372 6331 2063 6f6c 756d 6e73   by src1 columns
-00030170: 2075 7369 6e67 2067 676d 6c5f 7665 635f   using ggml_vec_
-00030180: 6d61 645f 7134 5f30 0a20 2020 2020 2020  mad_q4_0.       
-00030190: 202f 2f20 6561 6368 2074 6872 6561 6420   // each thread 
-000301a0: 6861 7320 6974 7320 6f77 6e20 776f 726b  has its own work
-000301b0: 2064 6174 610a 2020 2020 2020 2020 2f2f   data.        //
-000301c0: 2064 7572 696e 6720 4649 4e41 4c49 5a45   during FINALIZE
-000301d0: 2077 6520 6163 6375 6d75 6c61 7465 2061   we accumulate a
-000301e0: 6c6c 2077 6f72 6b20 6461 7461 2069 6e74  ll work data int
-000301f0: 6f20 6473 740a 0a20 2020 2020 2020 202f  o dst..        /
-00030200: 2f20 746f 7461 6c20 636f 6c75 6d6e 7320  / total columns 
-00030210: 696e 2073 7263 310a 2020 2020 2020 2020  in src1.        
-00030220: 636f 6e73 7420 696e 7420 6e63 203d 206e  const int nc = n
-00030230: 6531 303b 0a0a 2020 2020 2020 2020 2f2f  e10;..        //
-00030240: 2063 6f6c 756d 6e73 2070 6572 2074 6872   columns per thr
-00030250: 6561 640a 2020 2020 2020 2020 636f 6e73  ead.        cons
-00030260: 7420 696e 7420 6463 203d 2028 6e63 202b  t int dc = (nc +
-00030270: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-00030280: 2020 2020 2020 2020 2f2f 2063 6f6c 756d          // colum
-00030290: 6e20 7261 6e67 6520 666f 7220 7468 6973  n range for this
-000302a0: 2074 6872 6561 640a 2020 2020 2020 2020   thread.        
-000302b0: 636f 6e73 7420 696e 7420 6963 3020 3d20  const int ic0 = 
-000302c0: 6463 2a69 7468 3b0a 2020 2020 2020 2020  dc*ith;.        
-000302d0: 636f 6e73 7420 696e 7420 6963 3120 3d20  const int ic1 = 
-000302e0: 4d49 4e28 6963 3020 2b20 6463 2c20 6e63  MIN(ic0 + dc, nc
-000302f0: 293b 0a0a 2020 2020 2020 2020 2f2f 2077  );..        // w
-00030300: 6f72 6b20 6461 7461 2066 6f72 2074 6872  ork data for thr
-00030310: 6561 640a 2020 2020 2020 2020 636f 6e73  ead.        cons
-00030320: 7420 696e 7420 776f 203d 2028 6e65 202b  t int wo = (ne +
-00030330: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-00030340: 5f46 3332 292a 6974 683b 0a20 2020 2020  _F32)*ith;.     
-00030350: 2020 2066 6c6f 6174 202a 2063 6f6e 7374     float * const
-00030360: 2077 6461 7461 203d 2070 6172 616d 732d   wdata = params-
-00030370: 3e77 6461 7461 3b0a 0a20 2020 2020 2020  >wdata;..       
-00030380: 2066 6f72 2028 696e 7420 6931 3320 3d20   for (int i13 = 
-00030390: 303b 2069 3133 203c 206e 6531 333b 202b  0; i13 < ne13; +
-000303a0: 2b69 3133 2920 7b0a 2020 2020 2020 2020  +i13) {.        
-000303b0: 2020 2020 666f 7220 2869 6e74 2069 3132      for (int i12
-000303c0: 203d 2030 3b20 6931 3220 3c20 6e65 3132   = 0; i12 < ne12
-000303d0: 3b20 2b2b 6931 3229 207b 0a20 2020 2020  ; ++i12) {.     
-000303e0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-000303f0: 696e 7420 6931 3120 3d20 303b 2069 3131  int i11 = 0; i11
-00030400: 203c 206e 6531 313b 202b 2b69 3131 2920   < ne11; ++i11) 
-00030410: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00030420: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
-00030430: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
-00030440: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00030450: 6e74 2069 3120 3d20 6931 313b 0a20 2020  nt i1 = i11;.   
-00030460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030470: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
-00030480: 6931 323b 0a20 2020 2020 2020 2020 2020  i12;.           
-00030490: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-000304a0: 6e74 2069 3320 3d20 6931 333b 0a0a 2020  nt i3 = i13;..  
-000304b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304c0: 2020 666c 6f61 7420 2a20 6473 745f 726f    float * dst_ro
-000304d0: 7720 3d20 7764 6174 6120 2b20 776f 202b  w = wdata + wo +
-000304e0: 2069 332a 6e65 322a 6e65 312a 6e65 3020   i3*ne2*ne1*ne0 
-000304f0: 2b20 6932 2a6e 6531 2a6e 6530 202b 2069  + i2*ne1*ne0 + i
-00030500: 312a 6e65 303b 0a0a 2020 2020 2020 2020  1*ne0;..        
-00030510: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00030520: 2869 6e74 2069 6320 3d20 6963 303b 2069  (int ic = ic0; i
-00030530: 6320 3c20 6963 313b 202b 2b69 6329 207b  c < ic1; ++ic) {
-00030540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030550: 2020 2020 2020 2020 202f 2f20 7372 6331           // src1
-00030560: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-00030570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030580: 2063 6f6e 7374 2069 6e74 2069 3130 203d   const int i10 =
-00030590: 2069 633b 0a0a 2020 2020 2020 2020 2020   ic;..          
-000305a0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-000305b0: 2073 7263 3020 696e 6469 6365 730a 2020   src0 indices.  
-000305c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305d0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-000305e0: 6930 3320 3d20 6931 333b 0a20 2020 2020  i03 = i13;.     
-000305f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030600: 2020 2063 6f6e 7374 2069 6e74 2069 3032     const int i02
-00030610: 203d 2069 3132 3b0a 2020 2020 2020 2020   = i12;.        
-00030620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030630: 636f 6e73 7420 696e 7420 6930 3020 3d20  const int i00 = 
-00030640: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
-00030650: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00030660: 6572 7428 7369 7a65 6f66 2866 6c6f 6174  ert(sizeof(float
-00030670: 292a 2877 6f20 2b20 6933 2a6e 6532 2a6e  )*(wo + i3*ne2*n
-00030680: 6531 2a6e 6530 202b 2069 322a 6e65 312a  e1*ne0 + i2*ne1*
-00030690: 6e65 3020 2b20 6931 2a6e 6530 202b 206e  ne0 + i1*ne0 + n
-000306a0: 6530 3129 203c 3d20 7061 7261 6d73 2d3e  e01) <= params->
-000306b0: 7773 697a 6529 3b0a 0a20 2020 2020 2020  wsize);..       
-000306c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000306d0: 2076 6f69 6420 2a20 7372 6330 5f63 6f6c   void * src0_col
-000306e0: 203d 2020 2028 766f 6964 202a 2920 2828   =   (void *) ((
-000306f0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00030700: 7461 202b 2028 6930 302a 6e62 3030 202b  ta + (i00*nb00 +
-00030710: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
-00030720: 6e62 3033 2929 3b0a 2020 2020 2020 2020  nb03));.        
-00030730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030740: 666c 6f61 7420 2073 7263 315f 7661 6c20  float  src1_val 
-00030750: 3d20 2a28 666c 6f61 7420 2a29 2028 2863  = *(float *) ((c
-00030760: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
-00030770: 6120 2b20 2869 3130 2a6e 6231 3020 2b20  a + (i10*nb10 + 
-00030780: 6931 312a 6e62 3131 202b 2069 3132 2a6e  i11*nb11 + i12*n
-00030790: 6231 3220 2b20 6931 332a 6e62 3133 2929  b12 + i13*nb13))
-000307a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000307b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000307c0: 7665 635f 6d61 645f 7134 5f30 286e 6530  vec_mad_q4_0(ne0
-000307d0: 312c 2064 7374 5f72 6f77 2c20 7372 6330  1, dst_row, src0
-000307e0: 5f63 6f6c 2c20 7372 6331 5f76 616c 293b  _col, src1_val);
-000307f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030800: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00030810: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00030820: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00030830: 0a20 2020 207d 0a0a 2020 2020 2f2f 696e  .    }..    //in
-00030840: 7436 345f 7420 7431 203d 2067 676d 6c5f  t64_t t1 = ggml_
-00030850: 7469 6d65 5f75 7328 293b 0a20 2020 202f  time_us();.    /
-00030860: 2f73 7461 7469 6320 696e 7436 345f 7420  /static int64_t 
-00030870: 6163 6320 3d20 303b 0a20 2020 202f 2f61  acc = 0;.    //a
-00030880: 6363 202b 3d20 7431 202d 2074 303b 0a20  cc += t1 - t0;. 
-00030890: 2020 202f 2f69 6620 2874 3120 2d20 7430     //if (t1 - t0
-000308a0: 203e 2031 3029 207b 0a20 2020 202f 2f20   > 10) {.    // 
-000308b0: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
-000308c0: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
-000308d0: 6628 226e 6530 3020 3d20 2535 642c 206e  f("ne00 = %5d, n
-000308e0: 6530 3120 3d20 2535 642c 206e 6530 3220  e01 = %5d, ne02 
-000308f0: 3d20 2535 642c 206e 6530 3320 3d20 2535  = %5d, ne03 = %5
-00030900: 645c 6e22 2c20 6e65 3030 2c20 6e65 3031  d\n", ne00, ne01
-00030910: 2c20 6e65 3032 2c20 6e65 3033 293b 0a20  , ne02, ne03);. 
-00030920: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
-00030930: 226e 6230 3020 3d20 2535 642c 206e 6230  "nb00 = %5d, nb0
-00030940: 3120 3d20 2535 642c 206e 6230 3220 3d20  1 = %5d, nb02 = 
-00030950: 2535 642c 206e 6230 3320 3d20 2535 645c  %5d, nb03 = %5d\
-00030960: 6e22 2c20 6e62 3030 2c20 6e62 3031 2c20  n", nb00, nb01, 
-00030970: 6e62 3032 2c20 6e62 3033 293b 0a20 2020  nb02, nb03);.   
-00030980: 202f 2f20 2020 2070 7269 6e74 6628 226e   //    printf("n
-00030990: 6531 3020 3d20 2535 642c 206e 6531 3120  e10 = %5d, ne11 
-000309a0: 3d20 2535 642c 206e 6531 3220 3d20 2535  = %5d, ne12 = %5
-000309b0: 642c 206e 6531 3320 3d20 2535 645c 6e22  d, ne13 = %5d\n"
-000309c0: 2c20 6e65 3130 2c20 6e65 3131 2c20 6e65  , ne10, ne11, ne
-000309d0: 3132 2c20 6e65 3133 293b 0a0a 2020 2020  12, ne13);..    
-000309e0: 2f2f 2020 2020 7072 696e 7466 2822 5858  //    printf("XX
-000309f0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00030a00: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00030a10: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00030a20: 5858 2074 6173 6b20 2564 2f25 643a 2025  XX task %d/%d: %
-00030a30: 6420 7573 2c20 6163 6320 3d20 2564 5c6e  d us, acc = %d\n
-00030a40: 222c 2069 7468 2c20 6e74 682c 2028 696e  ", ith, nth, (in
-00030a50: 7429 2028 7431 202d 2074 3029 2c20 2869  t) (t1 - t0), (i
-00030a60: 6e74 2920 6163 6329 3b0a 2020 2020 2f2f  nt) acc);.    //
-00030a70: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00030a80: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00030a90: 7277 6172 645f 6d75 6c5f 6d61 745f 7134  rward_mul_mat_q4
-00030aa0: 5f31 5f66 3332 280a 2020 2020 2020 2020  _1_f32(.        
-00030ab0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00030ac0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00030ad0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00030ae0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00030af0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00030b00: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-00030b10: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00030b20: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-00030b30: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00030b40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00030b50: 6473 7429 207b 0a20 2020 2069 6e74 3634  dst) {.    int64
-00030b60: 5f74 2074 3020 3d20 6767 6d6c 5f70 6572  _t t0 = ggml_per
-00030b70: 665f 7469 6d65 5f75 7328 293b 0a20 2020  f_time_us();.   
-00030b80: 2055 4e55 5345 4428 7430 293b 0a0a 2020   UNUSED(t0);..  
-00030b90: 2020 636f 6e73 7420 696e 7420 6e65 3030    const int ne00
-00030ba0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-00030bb0: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-00030bc0: 3031 203d 2073 7263 302d 3e6e 655b 315d  01 = src0->ne[1]
-00030bd0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00030be0: 6e65 3032 203d 2073 7263 302d 3e6e 655b  ne02 = src0->ne[
-00030bf0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-00030c00: 7420 6e65 3033 203d 2073 7263 302d 3e6e  t ne03 = src0->n
-00030c10: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
-00030c20: 2069 6e74 206e 6531 3020 3d20 7372 6331   int ne10 = src1
-00030c30: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-00030c40: 7374 2069 6e74 206e 6531 3120 3d20 7372  st int ne11 = sr
-00030c50: 6331 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c1->ne[1];.    c
-00030c60: 6f6e 7374 2069 6e74 206e 6531 3220 3d20  onst int ne12 = 
-00030c70: 7372 6331 2d3e 6e65 5b32 5d3b 0a20 2020  src1->ne[2];.   
-00030c80: 2063 6f6e 7374 2069 6e74 206e 6531 3320   const int ne13 
-00030c90: 3d20 7372 6331 2d3e 6e65 5b33 5d3b 0a0a  = src1->ne[3];..
-00030ca0: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-00030cb0: 3020 203d 2064 7374 2d3e 6e65 5b30 5d3b  0  = dst->ne[0];
-00030cc0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00030cd0: 6531 2020 3d20 6473 742d 3e6e 655b 315d  e1  = dst->ne[1]
-00030ce0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00030cf0: 6e65 3220 203d 2064 7374 2d3e 6e65 5b32  ne2  = dst->ne[2
-00030d00: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00030d10: 206e 6533 2020 3d20 6473 742d 3e6e 655b   ne3  = dst->ne[
-00030d20: 335d 3b0a 2020 2020 636f 6e73 7420 696e  3];.    const in
-00030d30: 7420 6e65 2020 203d 206e 6530 2a6e 6531  t ne   = ne0*ne1
-00030d40: 2a6e 6532 2a6e 6533 3b0a 0a20 2020 2063  *ne2*ne3;..    c
-00030d50: 6f6e 7374 2069 6e74 206e 6230 3020 3d20  onst int nb00 = 
-00030d60: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
-00030d70: 2063 6f6e 7374 2069 6e74 206e 6230 3120   const int nb01 
-00030d80: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
-00030d90: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-00030da0: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
-00030db0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00030dc0: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
-00030dd0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-00030de0: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
-00030df0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-00030e00: 696e 7420 6e62 3131 203d 2073 7263 312d  int nb11 = src1-
-00030e10: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-00030e20: 7420 696e 7420 6e62 3132 203d 2073 7263  t int nb12 = src
-00030e30: 312d 3e6e 625b 325d 3b0a 2020 2020 636f  1->nb[2];.    co
-00030e40: 6e73 7420 696e 7420 6e62 3133 203d 2073  nst int nb13 = s
-00030e50: 7263 312d 3e6e 625b 335d 3b0a 0a20 2020  rc1->nb[3];..   
-00030e60: 2063 6f6e 7374 2069 6e74 206e 6230 2020   const int nb0  
-00030e70: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-00030e80: 2020 636f 6e73 7420 696e 7420 6e62 3120    const int nb1 
-00030e90: 203d 2064 7374 2d3e 6e62 5b31 5d3b 0a20   = dst->nb[1];. 
-00030ea0: 2020 2063 6f6e 7374 2069 6e74 206e 6232     const int nb2
-00030eb0: 2020 3d20 6473 742d 3e6e 625b 325d 3b0a    = dst->nb[2];.
-00030ec0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00030ed0: 3320 203d 2064 7374 2d3e 6e62 5b33 5d3b  3  = dst->nb[3];
-00030ee0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00030ef0: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-00030f00: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00030f10: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-00030f20: 7468 3b0a 0a20 2020 2047 474d 4c5f 4153  th;..    GGML_AS
-00030f30: 5345 5254 286e 6530 3220 3d3d 206e 6531  SERT(ne02 == ne1
-00030f40: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
-00030f50: 4552 5428 6e65 3033 203d 3d20 6e65 3133  ERT(ne03 == ne13
-00030f60: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00030f70: 5254 286e 6532 2020 3d3d 206e 6531 3229  RT(ne2  == ne12)
-00030f80: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00030f90: 5428 6e65 3320 203d 3d20 6e65 3133 293b  T(ne3  == ne13);
-00030fa0: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2077  ..    // TODO: w
-00030fb0: 6520 646f 6e27 7420 7375 7070 6f72 7420  e don't support 
-00030fc0: 7065 726d 7574 6564 2073 7263 300a 2020  permuted src0.  
-00030fd0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00030fe0: 3030 203d 3d20 2869 6e74 2920 4747 4d4c  00 == (int) GGML
-00030ff0: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
-00031000: 5459 5045 5f51 345f 315d 207c 7c20 6e62  TYPE_Q4_1] || nb
-00031010: 3031 203d 3d20 2869 6e74 2920 4747 4d4c  01 == (int) GGML
-00031020: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
-00031030: 5459 5045 5f51 345f 315d 293b 0a0a 2020  TYPE_Q4_1]);..  
-00031040: 2020 2f2f 2064 7374 2063 616e 6e6f 7420    // dst cannot 
-00031050: 6265 2074 7261 6e73 706f 7365 6420 6f72  be transposed or
-00031060: 2070 6572 6d75 7465 640a 2020 2020 4747   permuted.    GG
-00031070: 4d4c 5f41 5353 4552 5428 6e62 3020 3d3d  ML_ASSERT(nb0 ==
-00031080: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00031090: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000310a0: 286e 6230 203c 3d20 6e62 3129 3b0a 2020  (nb0 <= nb1);.  
-000310b0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-000310c0: 3120 3c3d 206e 6232 293b 0a20 2020 2047  1 <= nb2);.    G
-000310d0: 474d 4c5f 4153 5345 5254 286e 6232 203c  GML_ASSERT(nb2 <
-000310e0: 3d20 6e62 3329 3b0a 0a20 2020 2047 474d  = nb3);..    GGM
-000310f0: 4c5f 4153 5345 5254 286e 6530 203d 3d20  L_ASSERT(ne0 == 
-00031100: 6e65 3031 293b 0a20 2020 2047 474d 4c5f  ne01);.    GGML_
-00031110: 4153 5345 5254 286e 6531 203d 3d20 6e65  ASSERT(ne1 == ne
-00031120: 3131 293b 0a20 2020 2047 474d 4c5f 4153  11);.    GGML_AS
-00031130: 5345 5254 286e 6532 203d 3d20 6e65 3032  SERT(ne2 == ne02
-00031140: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00031150: 5254 286e 6533 203d 3d20 6e65 3033 293b  RT(ne3 == ne03);
-00031160: 0a0a 2020 2020 2f2f 206e 6230 3120 3e3d  ..    // nb01 >=
-00031170: 206e 6230 3020 2d20 7372 6330 2069 7320   nb00 - src0 is 
-00031180: 6e6f 7420 7472 616e 7370 6f73 6564 0a20  not transposed. 
-00031190: 2020 202f 2f20 2020 636f 6d70 7574 6520     //   compute 
-000311a0: 6279 2073 7263 3020 726f 7773 0a20 2020  by src0 rows.   
-000311b0: 202f 2f0a 2020 2020 2f2f 206e 6230 3020   //.    // nb00 
-000311c0: 3c20 206e 6230 3120 2d20 7372 6330 2069  <  nb01 - src0 i
-000311d0: 7320 7472 616e 7370 6f73 6564 0a20 2020  s transposed.   
-000311e0: 202f 2f20 2020 636f 6d70 7574 6520 6279   //   compute by
-000311f0: 2073 7263 3020 636f 6c75 6d6e 730a 0a23   src0 columns..#
-00031200: 6966 2064 6566 696e 6564 2847 474d 4c5f  if defined(GGML_
-00031210: 5553 455f 4143 4345 4c45 5241 5445 2920  USE_ACCELERATE) 
-00031220: 7c7c 2064 6566 696e 6564 2847 474d 4c5f  || defined(GGML_
-00031230: 5553 455f 4f50 454e 424c 4153 290a 2020  USE_OPENBLAS).  
-00031240: 2020 6966 2028 6767 6d6c 5f63 6f6d 7075    if (ggml_compu
-00031250: 7465 5f66 6f72 7761 7264 5f6d 756c 5f6d  te_forward_mul_m
-00031260: 6174 5f75 7365 5f62 6c61 7328 7372 6330  at_use_blas(src0
-00031270: 2c20 7372 6331 2c20 6473 7429 2920 7b0a  , src1, dst)) {.
-00031280: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00031290: 4552 5428 6e62 3130 203d 3d20 7369 7a65  ERT(nb10 == size
-000312a0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-000312b0: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
-000312c0: 3e69 7468 2021 3d20 3029 207b 0a20 2020  >ith != 0) {.   
-000312d0: 2020 2020 2020 2020 2072 6574 7572 6e3b           return;
-000312e0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-000312f0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00031300: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00031310: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
-00031320: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00031330: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00031340: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00031350: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00031360: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00031370: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00031380: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00031390: 2020 666c 6f61 7420 2a20 636f 6e73 7420    float * const 
-000313a0: 7764 6174 6120 3d20 7061 7261 6d73 2d3e  wdata = params->
-000313b0: 7764 6174 613b 0a0a 2020 2020 2020 2020  wdata;..        
-000313c0: 666f 7220 2869 6e74 2069 3033 203d 2030  for (int i03 = 0
-000313d0: 3b20 6930 3320 3c20 6e65 3033 3b20 6930  ; i03 < ne03; i0
-000313e0: 332b 2b29 207b 0a20 2020 2020 2020 2020  3++) {.         
-000313f0: 2020 2066 6f72 2028 696e 7420 6930 3220     for (int i02 
-00031400: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
-00031410: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
-00031420: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00031430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031440: 696e 7420 6964 203d 2030 3b0a 2020 2020  int id = 0;.    
-00031450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031460: 666f 7220 2869 6e74 2069 3031 203d 2030  for (int i01 = 0
-00031470: 3b20 6930 3120 3c20 6e65 3031 3b20 2b2b  ; i01 < ne01; ++
-00031480: 6930 3129 207b 0a20 2020 2020 2020 2020  i01) {.         
-00031490: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-000314a0: 2f66 6f72 2028 696e 7420 6930 3020 3d20  /for (int i00 = 
-000314b0: 303b 2069 3030 203c 206e 6530 303b 202b  0; i00 < ne00; +
-000314c0: 2b69 3030 2920 7b0a 2020 2020 2020 2020  +i00) {.        
-000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314e0: 2f2f 2020 2020 7764 6174 615b 6964 2b2b  //    wdata[id++
-000314f0: 5d20 3d20 4747 4d4c 5f46 5031 365f 544f  ] = GGML_FP16_TO
-00031500: 5f46 5033 3228 2a28 6767 6d6c 5f66 7031  _FP32(*(ggml_fp1
-00031510: 365f 7420 2a29 2028 2863 6861 7220 2a29  6_t *) ((char *)
-00031520: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
-00031530: 332a 6e62 3033 202b 2069 3032 2a6e 6230  3*nb03 + i02*nb0
-00031540: 3220 2b20 6930 312a 6e62 3031 202b 2069  2 + i01*nb01 + i
-00031550: 3030 2a6e 6230 3029 293b 0a20 2020 2020  00*nb00));.     
-00031560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031570: 2020 202f 2f7d 0a20 2020 2020 2020 2020     //}.         
-00031580: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00031590: 6571 7561 6e74 697a 655f 726f 775f 7134  equantize_row_q4
-000315a0: 5f31 2828 6368 6172 202a 2920 7372 6330  _1((char *) src0
-000315b0: 2d3e 6461 7461 202b 2069 3033 2a6e 6230  ->data + i03*nb0
-000315c0: 3320 2b20 6930 322a 6e62 3032 202b 2069  3 + i02*nb02 + i
-000315d0: 3031 2a6e 6230 312c 2077 6461 7461 202b  01*nb01, wdata +
-000315e0: 2069 642c 206e 6530 3029 3b0a 2020 2020   id, ne00);.    
-000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031600: 2020 2020 6964 202b 3d20 6e65 3030 3b0a      id += ne00;.
-00031610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031620: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00031630: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00031640: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00031650: 6c6f 6174 202a 2078 203d 2077 6461 7461  loat * x = wdata
-00031660: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00031670: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
-00031680: 7920 3d20 2866 6c6f 6174 202a 2920 2828  y = (float *) ((
-00031690: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
-000316a0: 7461 202b 2069 3032 2a6e 6231 3220 2b20  ta + i02*nb12 + 
-000316b0: 6930 332a 6e62 3133 293b 0a0a 2020 2020  i03*nb13);..    
-000316c0: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-000316d0: 2020 2020 666c 6f61 7420 2a20 7a20 3d20      float * z = 
-000316e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316f0: 2020 2020 2020 2020 2077 6461 7461 202b           wdata +
-00031700: 206e 6530 302a 6e65 3031 3b0a 0a20 2020   ne00*ne01;..   
-00031710: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00031720: 7a20 3d20 7820 2a20 7954 0a20 2020 2020  z = x * yT.     
-00031730: 2020 2020 2020 2020 2020 202f 2f7b 0a20             //{. 
-00031740: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00031750: 2f20 2020 2063 626c 6173 5f73 6765 6d6d  /    cblas_sgemm
-00031760: 2843 626c 6173 526f 774d 616a 6f72 2c20  (CblasRowMajor, 
-00031770: 4362 6c61 734e 6f54 7261 6e73 2c20 4362  CblasNoTrans, Cb
-00031780: 6c61 7354 7261 6e73 2c0a 2020 2020 2020  lasTrans,.      
-00031790: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-000317a0: 2020 2020 2020 2020 6e65 3031 2c20 6e65          ne01, ne
-000317b0: 3131 2c20 6e65 3030 2c0a 2020 2020 2020  11, ne00,.      
-000317c0: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-000317d0: 2020 2020 2020 2020 312e 3066 2c20 782c          1.0f, x,
-000317e0: 206e 6530 302c 0a20 2020 2020 2020 2020   ne00,.         
-000317f0: 2020 2020 2020 202f 2f20 2020 2020 2020         //       
-00031800: 2020 2020 2020 2020 2020 2079 2c20 6e65             y, ne
-00031810: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00031820: 2020 2020 2f2f 2020 2020 2020 2020 2020      //          
-00031830: 2020 302e 3066 2c20 7a2c 206e 6531 3129    0.0f, z, ne11)
-00031840: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00031850: 2020 2f2f 7d0a 0a20 2020 2020 2020 2020    //}..         
-00031860: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
-00031870: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-00031880: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-00031890: 202b 2069 3032 2a6e 6232 202b 2069 3033   + i02*nb2 + i03
-000318a0: 2a6e 6233 293b 0a0a 2020 2020 2020 2020  *nb3);..        
-000318b0: 2020 2020 2020 2020 2f2f 2074 7261 6e73          // trans
-000318c0: 706f 7365 207a 0a20 2020 2020 2020 2020  pose z.         
-000318d0: 2020 2020 2020 202f 2f66 6f72 2028 696e         //for (in
-000318e0: 7420 6a20 3d20 303b 206a 203c 206e 6531  t j = 0; j < ne1
-000318f0: 313b 202b 2b6a 2920 7b0a 2020 2020 2020  1; ++j) {.      
-00031900: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-00031910: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00031920: 6920 3c20 6e65 3031 3b20 2b2b 6929 207b  i < ne01; ++i) {
-00031930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031940: 202f 2f20 2020 2020 2020 2064 5b6a 2a6e   //        d[j*n
-00031950: 6530 3120 2b20 695d 203d 207a 5b69 2a6e  e01 + i] = z[i*n
-00031960: 6531 3120 2b20 6a5d 3b0a 2020 2020 2020  e11 + j];.      
-00031970: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-00031980: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00031990: 2020 2f2f 7d0a 0a20 2020 2020 2020 2020    //}..         
-000319a0: 2020 2020 2020 207b 0a23 6966 2031 0a20         {.#if 1. 
-000319b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319c0: 2020 202f 2f20 7a54 203d 2079 202a 2078     // zT = y * x
-000319d0: 540a 2020 2020 2020 2020 2020 2020 2020  T.              
-000319e0: 2020 2020 2020 6362 6c61 735f 7367 656d        cblas_sgem
-000319f0: 6d28 4362 6c61 7352 6f77 4d61 6a6f 722c  m(CblasRowMajor,
-00031a00: 2043 626c 6173 4e6f 5472 616e 732c 2043   CblasNoTrans, C
-00031a10: 626c 6173 5472 616e 732c 0a20 2020 2020  blasTrans,.     
-00031a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a30: 2020 2020 2020 206e 6531 312c 206e 6530         ne11, ne0
-00031a40: 312c 206e 6531 302c 0a20 2020 2020 2020  1, ne10,.       
-00031a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a60: 2020 2020 2031 2e30 662c 2020 2020 792c       1.0f,    y,
-00031a70: 206e 6530 302c 0a20 2020 2020 2020 2020   ne00,.         
-00031a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a90: 2020 2020 2020 2020 2020 2020 782c 206e              x, n
-00031aa0: 6530 302c 0a20 2020 2020 2020 2020 2020  e00,.           
-00031ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ac0: 2030 2e30 662c 2020 2020 642c 206e 6530   0.0f,    d, ne0
-00031ad0: 3129 3b0a 2365 6c73 650a 2020 2020 2020  1);.#else.      
-00031ae0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00031af0: 207a 5420 3d20 2878 5420 2a20 7929 540a   zT = (xT * y)T.
-00031b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b10: 2020 2020 6362 6c61 735f 7367 656d 6d28      cblas_sgemm(
-00031b20: 4362 6c61 7343 6f6c 4d61 6a6f 722c 2043  CblasColMajor, C
-00031b30: 626c 6173 5472 616e 732c 2043 626c 6173  blasTrans, Cblas
-00031b40: 4e6f 5472 616e 732c 0a20 2020 2020 2020  NoTrans,.       
-00031b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b60: 2020 2020 206e 6530 312c 206e 6531 312c       ne01, ne11,
-00031b70: 206e 6531 302c 0a20 2020 2020 2020 2020   ne10,.         
-00031b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b90: 2020 2031 2e30 662c 2020 2020 782c 206e     1.0f,    x, n
-00031ba0: 6530 302c 0a20 2020 2020 2020 2020 2020  e00,.           
-00031bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031bc0: 2020 2020 2020 2020 2020 792c 206e 6530            y, ne0
-00031bd0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00031be0: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00031bf0: 2e30 662c 2020 2020 642c 206e 6530 3129  .0f,    d, ne01)
-00031c00: 3b0a 2365 6e64 6966 0a20 2020 2020 2020  ;.#endif.       
-00031c10: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00031c20: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00031c30: 207d 0a0a 2020 2020 2020 2020 2f2f 7072   }..        //pr
-00031c40: 696e 7466 2822 4342 4c41 5320 3d20 2566  intf("CBLAS = %f
-00031c50: 206d 732c 2025 6420 7820 2564 2078 2025   ms, %d x %d x %
-00031c60: 6420 7820 2564 5c6e 222c 2028 6767 6d6c  d x %d\n", (ggml
-00031c70: 5f70 6572 665f 7469 6d65 5f75 7328 2920  _perf_time_us() 
-00031c80: 2d20 7430 292f 3130 3030 2e30 2c20 6e65  - t0)/1000.0, ne
-00031c90: 302c 206e 6531 2c20 6e65 322c 206e 6533  0, ne1, ne2, ne3
-00031ca0: 293b 0a0a 2020 2020 2020 2020 7265 7475  );..        retu
-00031cb0: 726e 3b0a 2020 2020 7d0a 2365 6e64 6966  rn;.    }.#endif
-00031cc0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00031cd0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00031ce0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-00031cf0: 2020 2020 2f2f 7072 696e 7466 2822 4848      //printf("HH
-00031d00: 4848 4848 4848 4820 6974 6820 3d20 2564  HHHHHHH ith = %d
-00031d10: 2c20 6e74 6820 3d20 2564 5c6e 222c 2069  , nth = %d\n", i
-00031d20: 7468 2c20 6e74 6829 3b0a 2020 2020 2020  th, nth);.      
-00031d30: 2020 6966 2028 6e62 3031 203e 3d20 6e62    if (nb01 >= nb
-00031d40: 3030 2920 7b0a 2020 2020 2020 2020 2020  00) {.          
-00031d50: 2020 6368 6172 202a 2077 6461 7461 203d    char * wdata =
-00031d60: 2070 6172 616d 732d 3e77 6461 7461 3b0a   params->wdata;.
-00031d70: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00031d80: 2028 696e 7420 6931 3320 3d20 303b 2069   (int i13 = 0; i
-00031d90: 3133 203c 206e 6531 333b 202b 2b69 3133  13 < ne13; ++i13
-00031da0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00031db0: 2020 2020 666f 7220 2869 6e74 2069 3132      for (int i12
-00031dc0: 203d 2030 3b20 6931 3220 3c20 6e65 3132   = 0; i12 < ne12
-00031dd0: 3b20 2b2b 6931 3229 207b 0a20 2020 2020  ; ++i12) {.     
-00031de0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00031df0: 6f72 2028 696e 7420 6931 3120 3d20 303b  or (int i11 = 0;
-00031e00: 2069 3131 203c 206e 6531 313b 202b 2b69   i11 < ne11; ++i
-00031e10: 3131 2920 7b0a 2020 2020 2020 2020 2020  11) {.          
-00031e20: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00031e30: 666f 7220 2869 6e74 2069 3130 203d 2030  for (int i10 = 0
-00031e40: 3b20 6931 3020 3c20 6e65 3130 3b20 2b2b  ; i10 < ne10; ++
-00031e50: 6931 3029 207b 0a20 2020 2020 2020 2020  i10) {.         
-00031e60: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00031e70: 2f20 2020 2077 6461 7461 5b69 642b 2b5d  /    wdata[id++]
-00031e80: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
-00031e90: 4650 3136 282a 2866 6c6f 6174 202a 2928  FP16(*(float *)(
-00031ea0: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
-00031eb0: 6174 6120 2b20 6931 332a 6e62 3133 202b  ata + i13*nb13 +
-00031ec0: 2069 3132 2a6e 6231 3220 2b20 6931 312a   i12*nb12 + i11*
-00031ed0: 6e62 3131 202b 2069 3130 2a6e 6231 3029  nb11 + i10*nb10)
-00031ee0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00031ef0: 2020 2020 2020 2020 2020 202f 2f7d 0a20             //}. 
-00031f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031f10: 2020 2020 2020 2071 7561 6e74 697a 655f         quantize_
-00031f20: 726f 775f 7134 5f31 2828 666c 6f61 7420  row_q4_1((float 
-00031f30: 2a29 2828 6368 6172 202a 2920 7372 6331  *)((char *) src1
-00031f40: 2d3e 6461 7461 202b 2069 3133 2a6e 6231  ->data + i13*nb1
-00031f50: 3320 2b20 6931 322a 6e62 3132 202b 2069  3 + i12*nb12 + i
-00031f60: 3131 2a6e 6231 3129 2c20 2876 6f69 6420  11*nb11), (void 
-00031f70: 2a29 2077 6461 7461 2c20 6e65 3130 293b  *) wdata, ne10);
-00031f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031f90: 2020 2020 2020 2020 2077 6461 7461 202b           wdata +
-00031fa0: 3d20 286e 6531 302a 4747 4d4c 5f54 5950  = (ne10*GGML_TYP
-00031fb0: 455f 5349 5a45 5b47 474d 4c5f 5459 5045  E_SIZE[GGML_TYPE
-00031fc0: 5f51 345f 315d 292f 4747 4d4c 5f42 4c43  _Q4_1])/GGML_BLC
-00031fd0: 4b5f 5349 5a45 5b47 474d 4c5f 5459 5045  K_SIZE[GGML_TYPE
-00031fe0: 5f51 345f 315d 3b0a 2020 2020 2020 2020  _Q4_1];.        
-00031ff0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00032000: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00032010: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00032020: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00032030: 6e3b 0a20 2020 2020 2020 207d 0a0a 2020  n;.        }..  
-00032040: 2020 2020 2020 2f2f 2054 4f44 4f3a 2066        // TODO: f
-00032050: 6978 2074 6869 7320 6d65 6d73 6574 2028  ix this memset (
-00032060: 7773 697a 6520 6973 206f 7665 7265 7374  wsize is overest
-00032070: 696d 6174 6564 290a 2020 2020 2020 2020  imated).        
-00032080: 6d65 6d73 6574 2870 6172 616d 732d 3e77  memset(params->w
-00032090: 6461 7461 2c20 302c 2070 6172 616d 732d  data, 0, params-
-000320a0: 3e77 7369 7a65 293b 0a20 2020 2020 2020  >wsize);.       
-000320b0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000320c0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-000320d0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-000320e0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-000320f0: 2020 2020 2020 6966 2028 6e62 3031 203e        if (nb01 >
-00032100: 3d20 6e62 3030 2920 7b0a 2020 2020 2020  = nb00) {.      
-00032110: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00032120: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00032130: 2066 6c6f 6174 202a 2063 6f6e 7374 2077   float * const w
-00032140: 6461 7461 203d 2070 6172 616d 732d 3e77  data = params->w
-00032150: 6461 7461 3b0a 0a20 2020 2020 2020 202f  data;..        /
-00032160: 2f20 636f 6c73 2070 6572 2074 6872 6561  / cols per threa
-00032170: 640a 2020 2020 2020 2020 636f 6e73 7420  d.        const 
-00032180: 696e 7420 6463 203d 2028 6e65 202b 206e  int dc = (ne + n
-00032190: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-000321a0: 2020 2020 2020 2f2f 2063 6f6c 2072 616e        // col ran
-000321b0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-000321c0: 6164 0a20 2020 2020 2020 2063 6f6e 7374  ad.        const
-000321d0: 2069 6e74 2069 6330 203d 2064 632a 6974   int ic0 = dc*it
-000321e0: 683b 0a20 2020 2020 2020 2063 6f6e 7374  h;.        const
-000321f0: 2069 6e74 2069 6331 203d 204d 494e 2869   int ic1 = MIN(i
-00032200: 6330 202b 2064 632c 206e 6529 3b0a 0a20  c0 + dc, ne);.. 
-00032210: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00032220: 6370 795f 6633 3228 6963 3120 2d20 6963  cpy_f32(ic1 - ic
-00032230: 302c 2028 666c 6f61 7420 2a29 2064 7374  0, (float *) dst
-00032240: 2d3e 6461 7461 202b 2069 6330 2c20 7764  ->data + ic0, wd
-00032250: 6174 6120 2b20 6963 3029 3b0a 0a20 2020  ata + ic0);..   
-00032260: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
-00032270: 3d20 313b 206b 203c 206e 7468 3b20 6b2b  = 1; k < nth; k+
-00032280: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00032290: 2067 676d 6c5f 7665 635f 6163 635f 6633   ggml_vec_acc_f3
-000322a0: 3228 6963 3120 2d20 6963 302c 2028 666c  2(ic1 - ic0, (fl
-000322b0: 6f61 7420 2a29 2064 7374 2d3e 6461 7461  oat *) dst->data
-000322c0: 202b 2069 6330 2c20 7764 6174 6120 2b20   + ic0, wdata + 
-000322d0: 286e 6520 2b20 4341 4348 455f 4c49 4e45  (ne + CACHE_LINE
-000322e0: 5f53 495a 455f 4633 3229 2a6b 202b 2069  _SIZE_F32)*k + i
-000322f0: 6330 293b 0a20 2020 2020 2020 207d 0a0a  c0);.        }..
-00032300: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00032310: 2020 2020 7d0a 0a20 2020 2069 6620 286e      }..    if (n
-00032320: 6230 3120 3e3d 206e 6230 3029 207b 0a20  b01 >= nb00) {. 
-00032330: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
-00032340: 646f 206e 6f74 2073 7570 706f 7274 2074  do not support t
-00032350: 7261 6e73 706f 7365 6420 7372 6331 0a0a  ransposed src1..
-00032360: 2020 2020 2020 2020 2f2f 2070 6172 616c          // paral
-00032370: 6c65 6c69 7a65 2062 7920 7372 6330 2072  lelize by src0 r
-00032380: 6f77 7320 7573 696e 6720 6767 6d6c 5f76  ows using ggml_v
-00032390: 6563 5f64 6f74 5f71 345f 310a 0a20 2020  ec_dot_q4_1..   
-000323a0: 2020 2020 202f 2f20 746f 7461 6c20 726f       // total ro
-000323b0: 7773 2069 6e20 7372 6330 0a20 2020 2020  ws in src0.     
-000323c0: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
-000323d0: 3d20 6e65 3031 2a6e 6530 322a 6e65 3033  = ne01*ne02*ne03
-000323e0: 3b0a 0a20 2020 2020 2020 202f 2f20 726f  ;..        // ro
-000323f0: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-00032400: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00032410: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-00032420: 2031 292f 6e74 683b 0a0a 2020 2020 2020   1)/nth;..      
-00032430: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-00032440: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-00032450: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00032460: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-00032470: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00032480: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-00032490: 2064 722c 206e 7229 3b0a 0a20 2020 2020   dr, nr);..     
-000324a0: 2020 2076 6f69 6420 2a20 7764 6174 6120     void * wdata 
-000324b0: 3d20 7061 7261 6d73 2d3e 7764 6174 613b  = params->wdata;
-000324c0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-000324d0: 6e74 2069 7220 3d20 6972 303b 2069 7220  nt ir = ir0; ir 
-000324e0: 3c20 6972 313b 202b 2b69 7229 207b 0a20  < ir1; ++ir) {. 
-000324f0: 2020 2020 2020 2020 2020 202f 2f20 7372             // sr
-00032500: 6330 2069 6e64 6963 6573 0a20 2020 2020  c0 indices.     
-00032510: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00032520: 2069 3033 203d 2069 722f 286e 6530 322a   i03 = ir/(ne02*
-00032530: 6e65 3031 293b 0a20 2020 2020 2020 2020  ne01);.         
-00032540: 2020 2063 6f6e 7374 2069 6e74 2069 3032     const int i02
-00032550: 203d 2028 6972 202d 2069 3033 2a6e 6530   = (ir - i03*ne0
-00032560: 322a 6e65 3031 292f 6e65 3031 3b0a 2020  2*ne01)/ne01;.  
-00032570: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00032580: 696e 7420 6930 3120 3d20 2869 7220 2d20  int i01 = (ir - 
-00032590: 6930 332a 6e65 3032 2a6e 6530 3120 2d20  i03*ne02*ne01 - 
-000325a0: 6930 322a 6e65 3031 293b 0a0a 2020 2020  i02*ne01);..    
-000325b0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000325c0: 7420 6931 3320 3d20 6930 333b 0a20 2020  t i13 = i03;.   
-000325d0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-000325e0: 6e74 2069 3132 203d 2069 3032 3b0a 0a20  nt i12 = i02;.. 
-000325f0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00032600: 2069 6e74 2069 3020 3d20 6930 313b 0a20   int i0 = i01;. 
-00032610: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00032620: 2069 6e74 2069 3220 3d20 6930 323b 0a20   int i2 = i02;. 
-00032630: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00032640: 2069 6e74 2069 3320 3d20 6930 333b 0a0a   int i3 = i03;..
-00032650: 2020 2020 2020 2020 2020 2020 766f 6964              void
-00032660: 202a 2073 7263 305f 726f 7720 3d20 2876   * src0_row = (v
-00032670: 6f69 6420 2a29 2028 2863 6861 7220 2a29  oid *) ((char *)
-00032680: 2073 7263 302d 3e64 6174 6120 2b20 2869   src0->data + (i
-00032690: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
-000326a0: 3032 202b 2069 3033 2a6e 6230 3329 293b  02 + i03*nb03));
-000326b0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-000326c0: 7220 2a20 7372 6331 5f63 6f6c 203d 2020  r * src1_col =  
-000326d0: 2020 2020 2020 2020 2828 6368 6172 202a          ((char *
-000326e0: 2920 2020 2020 2077 6461 7461 202b 2028  )      wdata + (
-000326f0: 2020 2020 2020 2830 202b 2069 3132 2a6e        (0 + i12*n
-00032700: 6531 3120 2b20 6931 332a 6e65 3132 2a6e  e11 + i13*ne12*n
-00032710: 6531 3129 2a6e 6530 302a 4747 4d4c 5f54  e11)*ne00*GGML_T
-00032720: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
-00032730: 5045 5f51 345f 315d 292f 4747 4d4c 5f42  PE_Q4_1])/GGML_B
-00032740: 4c43 4b5f 5349 5a45 5b47 474d 4c5f 5459  LCK_SIZE[GGML_TY
-00032750: 5045 5f51 345f 315d 293b 0a0a 2020 2020  PE_Q4_1]);..    
-00032760: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00032770: 6473 745f 636f 6c20 3d20 2866 6c6f 6174  dst_col = (float
-00032780: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-00032790: 742d 3e64 6174 6120 2b20 2869 302a 6e62  t->data + (i0*nb
-000327a0: 3020 2b20 302a 6e62 3120 2b20 6932 2a6e  0 + 0*nb1 + i2*n
-000327b0: 6232 202b 2069 332a 6e62 3329 293b 0a0a  b2 + i3*nb3));..
-000327c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000327d0: 7274 286e 6530 3020 2520 3332 203d 3d20  rt(ne00 % 32 == 
-000327e0: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
-000327f0: 2066 6f72 2028 696e 7420 6963 203d 2030   for (int ic = 0
-00032800: 3b20 6963 203c 206e 6531 313b 202b 2b69  ; ic < ne11; ++i
-00032810: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
-00032820: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
-00032830: 745f 7134 5f31 286e 6530 302c 2026 6473  t_q4_1(ne00, &ds
-00032840: 745f 636f 6c5b 6963 2a6e 6530 5d2c 2073  t_col[ic*ne0], s
-00032850: 7263 305f 726f 772c 2028 2876 6f69 6420  rc0_row, ((void 
-00032860: 2a29 2028 7372 6331 5f63 6f6c 202b 2028  *) (src1_col + (
-00032870: 6963 2a6e 6530 302a 4747 4d4c 5f54 5950  ic*ne00*GGML_TYP
-00032880: 455f 5349 5a45 5b47 474d 4c5f 5459 5045  E_SIZE[GGML_TYPE
-00032890: 5f51 345f 315d 292f 4747 4d4c 5f42 4c43  _Q4_1])/GGML_BLC
-000328a0: 4b5f 5349 5a45 5b47 474d 4c5f 5459 5045  K_SIZE[GGML_TYPE
-000328b0: 5f51 345f 315d 2929 293b 0a20 2020 2020  _Q4_1])));.     
-000328c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000328d0: 207d 0a20 2020 207d 2065 6c73 6520 7b0a   }.    } else {.
-000328e0: 2020 2020 2020 2020 2f2f 7072 696e 7466          //printf
-000328f0: 2822 4141 4141 4120 6974 6820 3d20 2564  ("AAAAA ith = %d
-00032900: 2c20 6e74 6820 3d20 2564 5c6e 222c 2069  , nth = %d\n", i
-00032910: 7468 2c20 6e74 6829 3b0a 2020 2020 2020  th, nth);.      
-00032920: 2020 2f2f 2070 6172 616c 6c65 6c69 7a65    // parallelize
-00032930: 2062 7920 7372 6331 2063 6f6c 756d 6e73   by src1 columns
-00032940: 2075 7369 6e67 2067 676d 6c5f 7665 635f   using ggml_vec_
-00032950: 6d61 645f 7134 5f31 0a20 2020 2020 2020  mad_q4_1.       
-00032960: 202f 2f20 6561 6368 2074 6872 6561 6420   // each thread 
-00032970: 6861 7320 6974 7320 6f77 6e20 776f 726b  has its own work
-00032980: 2064 6174 610a 2020 2020 2020 2020 2f2f   data.        //
-00032990: 2064 7572 696e 6720 4649 4e41 4c49 5a45   during FINALIZE
-000329a0: 2077 6520 6163 6375 6d75 6c61 7465 2061   we accumulate a
-000329b0: 6c6c 2077 6f72 6b20 6461 7461 2069 6e74  ll work data int
-000329c0: 6f20 6473 740a 0a20 2020 2020 2020 202f  o dst..        /
-000329d0: 2f20 746f 7461 6c20 636f 6c75 6d6e 7320  / total columns 
-000329e0: 696e 2073 7263 310a 2020 2020 2020 2020  in src1.        
-000329f0: 636f 6e73 7420 696e 7420 6e63 203d 206e  const int nc = n
-00032a00: 6531 303b 0a0a 2020 2020 2020 2020 2f2f  e10;..        //
-00032a10: 2063 6f6c 756d 6e73 2070 6572 2074 6872   columns per thr
-00032a20: 6561 640a 2020 2020 2020 2020 636f 6e73  ead.        cons
-00032a30: 7420 696e 7420 6463 203d 2028 6e63 202b  t int dc = (nc +
-00032a40: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-00032a50: 2020 2020 2020 2020 2f2f 2063 6f6c 756d          // colum
-00032a60: 6e20 7261 6e67 6520 666f 7220 7468 6973  n range for this
-00032a70: 2074 6872 6561 640a 2020 2020 2020 2020   thread.        
-00032a80: 636f 6e73 7420 696e 7420 6963 3020 3d20  const int ic0 = 
-00032a90: 6463 2a69 7468 3b0a 2020 2020 2020 2020  dc*ith;.        
-00032aa0: 636f 6e73 7420 696e 7420 6963 3120 3d20  const int ic1 = 
-00032ab0: 4d49 4e28 6963 3020 2b20 6463 2c20 6e63  MIN(ic0 + dc, nc
-00032ac0: 293b 0a0a 2020 2020 2020 2020 2f2f 2077  );..        // w
-00032ad0: 6f72 6b20 6461 7461 2066 6f72 2074 6872  ork data for thr
-00032ae0: 6561 640a 2020 2020 2020 2020 636f 6e73  ead.        cons
-00032af0: 7420 696e 7420 776f 203d 2028 6e65 202b  t int wo = (ne +
-00032b00: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-00032b10: 5f46 3332 292a 6974 683b 0a20 2020 2020  _F32)*ith;.     
-00032b20: 2020 2066 6c6f 6174 202a 2063 6f6e 7374     float * const
-00032b30: 2077 6461 7461 203d 2070 6172 616d 732d   wdata = params-
-00032b40: 3e77 6461 7461 3b0a 0a20 2020 2020 2020  >wdata;..       
-00032b50: 2066 6f72 2028 696e 7420 6931 3320 3d20   for (int i13 = 
-00032b60: 303b 2069 3133 203c 206e 6531 333b 202b  0; i13 < ne13; +
-00032b70: 2b69 3133 2920 7b0a 2020 2020 2020 2020  +i13) {.        
-00032b80: 2020 2020 666f 7220 2869 6e74 2069 3132      for (int i12
-00032b90: 203d 2030 3b20 6931 3220 3c20 6e65 3132   = 0; i12 < ne12
-00032ba0: 3b20 2b2b 6931 3229 207b 0a20 2020 2020  ; ++i12) {.     
-00032bb0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00032bc0: 696e 7420 6931 3120 3d20 303b 2069 3131  int i11 = 0; i11
-00032bd0: 203c 206e 6531 313b 202b 2b69 3131 2920   < ne11; ++i11) 
-00032be0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00032bf0: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
-00032c00: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
-00032c10: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00032c20: 6e74 2069 3120 3d20 6931 313b 0a20 2020  nt i1 = i11;.   
-00032c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c40: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
-00032c50: 6931 323b 0a20 2020 2020 2020 2020 2020  i12;.           
-00032c60: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00032c70: 6e74 2069 3320 3d20 6931 333b 0a0a 2020  nt i3 = i13;..  
-00032c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c90: 2020 666c 6f61 7420 2a20 6473 745f 726f    float * dst_ro
-00032ca0: 7720 3d20 7764 6174 6120 2b20 776f 202b  w = wdata + wo +
-00032cb0: 2069 332a 6e65 322a 6e65 312a 6e65 3020   i3*ne2*ne1*ne0 
-00032cc0: 2b20 6932 2a6e 6531 2a6e 6530 202b 2069  + i2*ne1*ne0 + i
-00032cd0: 312a 6e65 303b 0a0a 2020 2020 2020 2020  1*ne0;..        
-00032ce0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00032cf0: 2869 6e74 2069 6320 3d20 6963 303b 2069  (int ic = ic0; i
-00032d00: 6320 3c20 6963 313b 202b 2b69 6329 207b  c < ic1; ++ic) {
-00032d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032d20: 2020 2020 2020 2020 202f 2f20 7372 6331           // src1
-00032d30: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-00032d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032d50: 2063 6f6e 7374 2069 6e74 2069 3130 203d   const int i10 =
-00032d60: 2069 633b 0a0a 2020 2020 2020 2020 2020   ic;..          
-00032d70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00032d80: 2073 7263 3020 696e 6469 6365 730a 2020   src0 indices.  
-00032d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032da0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00032db0: 6930 3320 3d20 6931 333b 0a20 2020 2020  i03 = i13;.     
-00032dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032dd0: 2020 2063 6f6e 7374 2069 6e74 2069 3032     const int i02
-00032de0: 203d 2069 3132 3b0a 2020 2020 2020 2020   = i12;.        
-00032df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e00: 636f 6e73 7420 696e 7420 6930 3020 3d20  const int i00 = 
-00032e10: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
-00032e20: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00032e30: 6572 7428 7369 7a65 6f66 2866 6c6f 6174  ert(sizeof(float
-00032e40: 292a 2877 6f20 2b20 6933 2a6e 6532 2a6e  )*(wo + i3*ne2*n
-00032e50: 6531 2a6e 6530 202b 2069 322a 6e65 312a  e1*ne0 + i2*ne1*
-00032e60: 6e65 3020 2b20 6931 2a6e 6530 202b 206e  ne0 + i1*ne0 + n
-00032e70: 6530 3129 203c 3d20 7061 7261 6d73 2d3e  e01) <= params->
-00032e80: 7773 697a 6529 3b0a 0a20 2020 2020 2020  wsize);..       
-00032e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ea0: 2076 6f69 6420 2a20 7372 6330 5f63 6f6c   void * src0_col
-00032eb0: 203d 2020 2028 766f 6964 202a 2920 2828   =   (void *) ((
-00032ec0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00032ed0: 7461 202b 2028 6930 302a 6e62 3030 202b  ta + (i00*nb00 +
-00032ee0: 2069 3032 2a6e 6230 3220 2b20 6930 332a   i02*nb02 + i03*
-00032ef0: 6e62 3033 2929 3b0a 2020 2020 2020 2020  nb03));.        
-00032f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032f10: 666c 6f61 7420 2073 7263 315f 7661 6c20  float  src1_val 
-00032f20: 3d20 2a28 666c 6f61 7420 2a29 2028 2863  = *(float *) ((c
-00032f30: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
-00032f40: 6120 2b20 2869 3130 2a6e 6231 3020 2b20  a + (i10*nb10 + 
-00032f50: 6931 312a 6e62 3131 202b 2069 3132 2a6e  i11*nb11 + i12*n
-00032f60: 6231 3220 2b20 6931 332a 6e62 3133 2929  b12 + i13*nb13))
-00032f70: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00032f80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00032f90: 7665 635f 6d61 645f 7134 5f31 286e 6530  vec_mad_q4_1(ne0
-00032fa0: 312c 2064 7374 5f72 6f77 2c20 7372 6330  1, dst_row, src0
-00032fb0: 5f63 6f6c 2c20 7372 6331 5f76 616c 293b  _col, src1_val);
-00032fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032fd0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00032fe0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00032ff0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00033000: 0a20 2020 207d 0a0a 2020 2020 2f2f 696e  .    }..    //in
-00033010: 7436 345f 7420 7431 203d 2067 676d 6c5f  t64_t t1 = ggml_
-00033020: 7469 6d65 5f75 7328 293b 0a20 2020 202f  time_us();.    /
-00033030: 2f73 7461 7469 6320 696e 7436 345f 7420  /static int64_t 
-00033040: 6163 6320 3d20 303b 0a20 2020 202f 2f61  acc = 0;.    //a
-00033050: 6363 202b 3d20 7431 202d 2074 303b 0a20  cc += t1 - t0;. 
-00033060: 2020 202f 2f69 6620 2874 3120 2d20 7430     //if (t1 - t0
-00033070: 203e 2031 3029 207b 0a20 2020 202f 2f20   > 10) {.    // 
-00033080: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
-00033090: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
-000330a0: 6628 226e 6530 3020 3d20 2535 642c 206e  f("ne00 = %5d, n
-000330b0: 6530 3120 3d20 2535 642c 206e 6530 3220  e01 = %5d, ne02 
-000330c0: 3d20 2535 642c 206e 6530 3320 3d20 2535  = %5d, ne03 = %5
-000330d0: 645c 6e22 2c20 6e65 3030 2c20 6e65 3031  d\n", ne00, ne01
-000330e0: 2c20 6e65 3032 2c20 6e65 3033 293b 0a20  , ne02, ne03);. 
-000330f0: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
-00033100: 226e 6230 3020 3d20 2535 642c 206e 6230  "nb00 = %5d, nb0
-00033110: 3120 3d20 2535 642c 206e 6230 3220 3d20  1 = %5d, nb02 = 
-00033120: 2535 642c 206e 6230 3320 3d20 2535 645c  %5d, nb03 = %5d\
-00033130: 6e22 2c20 6e62 3030 2c20 6e62 3031 2c20  n", nb00, nb01, 
-00033140: 6e62 3032 2c20 6e62 3033 293b 0a20 2020  nb02, nb03);.   
-00033150: 202f 2f20 2020 2070 7269 6e74 6628 226e   //    printf("n
-00033160: 6531 3020 3d20 2535 642c 206e 6531 3120  e10 = %5d, ne11 
-00033170: 3d20 2535 642c 206e 6531 3220 3d20 2535  = %5d, ne12 = %5
-00033180: 642c 206e 6531 3320 3d20 2535 645c 6e22  d, ne13 = %5d\n"
-00033190: 2c20 6e65 3130 2c20 6e65 3131 2c20 6e65  , ne10, ne11, ne
-000331a0: 3132 2c20 6e65 3133 293b 0a0a 2020 2020  12, ne13);..    
-000331b0: 2f2f 2020 2020 7072 696e 7466 2822 5858  //    printf("XX
-000331c0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000331d0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000331e0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000331f0: 5858 2074 6173 6b20 2564 2f25 643a 2025  XX task %d/%d: %
-00033200: 6420 7573 2c20 6163 6320 3d20 2564 5c6e  d us, acc = %d\n
-00033210: 222c 2069 7468 2c20 6e74 682c 2028 696e  ", ith, nth, (in
-00033220: 7429 2028 7431 202d 2074 3029 2c20 2869  t) (t1 - t0), (i
-00033230: 6e74 2920 6163 6329 3b0a 2020 2020 2f2f  nt) acc);.    //
-00033240: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00033250: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00033260: 7277 6172 645f 6d75 6c5f 6d61 7428 0a20  rward_mul_mat(. 
-00033270: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00033280: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00033290: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-000332a0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000332b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000332c0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-000332d0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000332e0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000332f0: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
-00033300: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00033310: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00033320: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00033330: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00033340: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
-00033350: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00033360: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00033370: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00033380: 645f 6d75 6c5f 6d61 745f 7134 5f30 5f66  d_mul_mat_q4_0_f
-00033390: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-000333a0: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-000333b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000333c0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000333d0: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
-000333e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000333f0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00033400: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00033410: 645f 6d75 6c5f 6d61 745f 7134 5f31 5f66  d_mul_mat_q4_1_f
-00033420: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00033430: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-00033440: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00033450: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00033460: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00033470: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00033480: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00033490: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000334a0: 5f6d 756c 5f6d 6174 5f66 3136 5f66 3332  _mul_mat_f16_f32
-000334b0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-000334c0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-000334d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000334e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000334f0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-00033500: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00033510: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00033520: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-00033530: 756c 5f6d 6174 5f66 3332 2870 6172 616d  ul_mat_f32(param
-00033540: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00033550: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00033560: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00033570: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00033580: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
-00033590: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
-000335a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000335b0: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
-000335c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-000335d0: 5950 455f 434f 554e 543a 0a20 2020 2020  YPE_COUNT:.     
-000335e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000335f0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00033600: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00033610: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00033620: 3b0a 2020 2020 7d0a 0a23 6966 2030 0a20  ;.    }..#if 0. 
-00033630: 2020 2069 6620 2873 7263 302d 3e74 7970     if (src0->typ
-00033640: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00033650: 3136 207c 7c20 7372 6330 2d3e 7479 7065  16 || src0->type
-00033660: 203d 3d20 4747 4d4c 5f54 5950 455f 5134   == GGML_TYPE_Q4
-00033670: 5f31 2920 7b0a 2020 2020 2020 2020 7374  _1) {.        st
-00033680: 6174 6963 2069 6e74 2066 6972 7374 203d  atic int first =
-00033690: 2038 3b0a 2020 2020 2020 2020 7072 696e   8;.        prin
-000336a0: 7466 2822 7372 6330 3a20 6e65 3020 3d20  tf("src0: ne0 = 
-000336b0: 2535 642c 206e 6531 203d 2025 3564 2c20  %5d, ne1 = %5d, 
-000336c0: 6e65 3220 3d20 2535 645c 6e22 2c20 7372  ne2 = %5d\n", sr
-000336d0: 6330 2d3e 6e65 5b30 5d2c 2073 7263 302d  c0->ne[0], src0-
-000336e0: 3e6e 655b 315d 2c20 7372 6330 2d3e 6e65  >ne[1], src0->ne
-000336f0: 5b32 5d29 3b0a 2020 2020 2020 2020 7072  [2]);.        pr
-00033700: 696e 7466 2822 7372 6331 3a20 6e65 3020  intf("src1: ne0 
-00033710: 3d20 2535 642c 206e 6531 203d 2025 3564  = %5d, ne1 = %5d
-00033720: 2c20 6e65 3220 3d20 2535 645c 6e22 2c20  , ne2 = %5d\n", 
-00033730: 7372 6331 2d3e 6e65 5b30 5d2c 2073 7263  src1->ne[0], src
-00033740: 312d 3e6e 655b 315d 2c20 7372 6331 2d3e  1->ne[1], src1->
-00033750: 6e65 5b32 5d29 3b0a 2020 2020 2020 2020  ne[2]);.        
-00033760: 7072 696e 7466 2822 6473 743a 2020 6e65  printf("dst:  ne
-00033770: 3020 3d20 2535 642c 206e 6531 203d 2025  0 = %5d, ne1 = %
-00033780: 3564 2c20 6e65 3220 3d20 2535 645c 6e22  5d, ne2 = %5d\n"
-00033790: 2c20 6473 742d 3e6e 655b 305d 2c20 6473  , dst->ne[0], ds
-000337a0: 742d 3e6e 655b 315d 2c20 6473 742d 3e6e  t->ne[1], dst->n
-000337b0: 655b 325d 293b 0a20 2020 2020 2020 2069  e[2]);.        i
-000337c0: 6620 2866 6972 7374 2920 7b0a 2020 2020  f (first) {.    
-000337d0: 2020 2020 2020 2020 2d2d 6669 7273 743b          --first;
-000337e0: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
-000337f0: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
-00033800: 7220 2869 6e74 206b 203d 2030 3b20 6b20  r (int k = 0; k 
-00033810: 3c20 6473 742d 3e6e 655b 315d 3b20 2b2b  < dst->ne[1]; ++
-00033820: 6b29 207b 0a20 2020 2020 2020 2020 2020  k) {.           
-00033830: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-00033840: 3d20 303b 206a 203c 2064 7374 2d3e 6e65  = 0; j < dst->ne
-00033850: 5b30 5d2f 3136 3b20 2b2b 6a29 207b 0a20  [0]/16; ++j) {. 
-00033860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033870: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00033880: 303b 2069 203c 2031 363b 202b 2b69 2920  0; i < 16; ++i) 
-00033890: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000338a0: 2020 2020 2020 2020 2020 7072 696e 7466            printf
-000338b0: 2822 2538 2e34 6620 222c 2028 2866 6c6f  ("%8.4f ", ((flo
-000338c0: 6174 202a 2920 6473 742d 3e64 6174 6129  at *) dst->data)
-000338d0: 5b6b 2a64 7374 2d3e 6e65 5b30 5d20 2b20  [k*dst->ne[0] + 
-000338e0: 6a2a 3136 202b 2069 5d29 3b0a 2020 2020  j*16 + i]);.    
-000338f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033900: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00033910: 2020 2020 2020 7072 696e 7466 2822 5c6e        printf("\n
-00033920: 2229 3b0a 2020 2020 2020 2020 2020 2020  ");.            
-00033930: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00033940: 2020 2020 2020 7072 696e 7466 2822 5c6e        printf("\n
-00033950: 2229 3b0a 2020 2020 2020 2020 2020 2020  ");.            
-00033960: 7d0a 2020 2020 2020 2020 2020 2020 7072  }.            pr
-00033970: 696e 7466 2822 5c6e 2229 3b0a 2020 2020  intf("\n");.    
-00033980: 2020 2020 2020 2020 6578 6974 2830 293b          exit(0);
-00033990: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-000339a0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-000339b0: 7072 696e 7466 2822 6161 6161 2073 7263  printf("aaaa src
-000339c0: 303a 206e 6530 203d 2025 3564 2c20 6e65  0: ne0 = %5d, ne
-000339d0: 3120 3d20 2535 642c 206e 6532 203d 2025  1 = %5d, ne2 = %
-000339e0: 3564 5c6e 222c 2073 7263 302d 3e6e 655b  5d\n", src0->ne[
-000339f0: 305d 2c20 7372 6330 2d3e 6e65 5b31 5d2c  0], src0->ne[1],
-00033a00: 2073 7263 302d 3e6e 655b 325d 293b 0a20   src0->ne[2]);. 
-00033a10: 2020 2020 2020 2070 7269 6e74 6628 2261         printf("a
-00033a20: 6161 6120 7372 6331 3a20 6e65 3020 3d20  aaa src1: ne0 = 
-00033a30: 2535 642c 206e 6531 203d 2025 3564 2c20  %5d, ne1 = %5d, 
-00033a40: 6e65 3220 3d20 2535 645c 6e22 2c20 7372  ne2 = %5d\n", sr
-00033a50: 6331 2d3e 6e65 5b30 5d2c 2073 7263 312d  c1->ne[0], src1-
-00033a60: 3e6e 655b 315d 2c20 7372 6331 2d3e 6e65  >ne[1], src1->ne
-00033a70: 5b32 5d29 3b0a 2020 2020 2020 2020 7072  [2]);.        pr
-00033a80: 696e 7466 2822 6161 6161 2064 7374 3a20  intf("aaaa dst: 
-00033a90: 206e 6530 203d 2025 3564 2c20 6e65 3120   ne0 = %5d, ne1 
-00033aa0: 3d20 2535 642c 206e 6532 203d 2025 3564  = %5d, ne2 = %5d
-00033ab0: 5c6e 222c 2064 7374 2d3e 6e65 5b30 5d2c  \n", dst->ne[0],
-00033ac0: 2064 7374 2d3e 6e65 5b31 5d2c 2064 7374   dst->ne[1], dst
-00033ad0: 2d3e 6e65 5b32 5d29 3b0a 2020 2020 7d0a  ->ne[2]);.    }.
-00033ae0: 2365 6e64 6966 0a7d 0a0a 2f2f 2067 676d  #endif.}..// ggm
-00033af0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00033b00: 645f 7363 616c 650a 0a73 7461 7469 6320  d_scale..static 
-00033b10: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-00033b20: 655f 666f 7277 6172 645f 7363 616c 655f  e_forward_scale_
-00033b30: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-00033b40: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00033b50: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00033b60: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00033b70: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00033b80: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00033b90: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00033ba0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00033bb0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00033bc0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00033bd0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00033be0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00033bf0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-00033c00: 2873 7263 3029 293b 0a20 2020 2047 474d  (src0));.    GGM
-00033c10: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-00033c20: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
-00033c30: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00033c40: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-00033c50: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-00033c60: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00033c70: 4552 5428 6767 6d6c 5f69 735f 7363 616c  ERT(ggml_is_scal
-00033c80: 6172 2873 7263 3129 293b 0a0a 2020 2020  ar(src1));..    
-00033c90: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00033ca0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-00033cb0: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-00033cc0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00033cd0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-00033ce0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00033cf0: 7d0a 0a20 2020 202f 2f20 7363 616c 6520  }..    // scale 
-00033d00: 6661 6374 6f72 0a20 2020 2063 6f6e 7374  factor.    const
-00033d10: 2066 6c6f 6174 2076 203d 202a 2866 6c6f   float v = *(flo
-00033d20: 6174 202a 2920 7372 6331 2d3e 6461 7461  at *) src1->data
-00033d30: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00033d40: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
-00033d50: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00033d60: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
-00033d70: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
-00033d80: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
-00033d90: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00033da0: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
-00033db0: 6f77 7328 7372 6330 293b 0a0a 2020 2020  ows(src0);..    
-00033dc0: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
-00033dd0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00033de0: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-00033df0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-00033e00: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-00033e10: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-00033e20: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-00033e30: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
-00033e40: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
-00033e50: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
-00033e60: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
-00033e70: 3d20 6972 303b 2069 3120 3c20 6972 313b  = ir0; i1 < ir1;
-00033e80: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
-00033e90: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
-00033ea0: 6633 3228 6e63 2c20 2866 6c6f 6174 202a  f32(nc, (float *
-00033eb0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-00033ec0: 3e64 6174 6120 2b20 6931 2a28 6473 742d  >data + i1*(dst-
-00033ed0: 3e6e 625b 315d 2929 2c20 7629 3b0a 2020  >nb[1])), v);.  
-00033ee0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-00033ef0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00033f00: 666f 7277 6172 645f 7363 616c 6528 0a20  forward_scale(. 
-00033f10: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00033f20: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00033f30: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00033f40: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00033f50: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00033f60: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-00033f70: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00033f80: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00033f90: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
-00033fa0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00033fb0: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00033fc0: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00033fd0: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00033fe0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-00033ff0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00034000: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00034010: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00034020: 5f73 6361 6c65 5f66 3332 2870 6172 616d  _scale_f32(param
-00034030: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00034040: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00034050: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00034060: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00034070: 5f51 345f 303a 0a20 2020 2020 2020 2063  _Q4_0:.        c
-00034080: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00034090: 5f31 3a0a 2020 2020 2020 2020 6361 7365  _1:.        case
-000340a0: 2047 474d 4c5f 5459 5045 5f49 383a 0a20   GGML_TYPE_I8:. 
-000340b0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000340c0: 5f54 5950 455f 4931 363a 0a20 2020 2020  _TYPE_I16:.     
-000340d0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000340e0: 455f 4933 323a 0a20 2020 2020 2020 2063  E_I32:.        c
-000340f0: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
-00034100: 363a 0a20 2020 2020 2020 2063 6173 6520  6:.        case 
-00034110: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
-00034120: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00034130: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00034140: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00034150: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00034160: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-00034170: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-00034180: 5f66 6f72 7761 7264 5f63 7079 0a0a 7374  _forward_cpy..st
-00034190: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-000341a0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-000341b0: 7079 280a 2020 2020 2020 2020 636f 6e73  py(.        cons
-000341c0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-000341d0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000341e0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000341f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00034200: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00034210: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00034220: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00034230: 2920 7b0a 2020 2020 6767 6d6c 5f63 6f6d  ) {.    ggml_com
-00034240: 7075 7465 5f66 6f72 7761 7264 5f64 7570  pute_forward_dup
-00034250: 2870 6172 616d 732c 2073 7263 302c 2064  (params, src0, d
-00034260: 7374 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  st);.}..// ggml_
-00034270: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00034280: 7265 7368 6170 650a 0a73 7461 7469 6320  reshape..static 
-00034290: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-000342a0: 655f 666f 7277 6172 645f 7265 7368 6170  e_forward_reshap
-000342b0: 6528 0a20 2020 2020 2020 2063 6f6e 7374  e(.        const
-000342c0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-000342d0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-000342e0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-000342f0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00034300: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-00034310: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00034320: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00034330: 207b 0a20 2020 202f 2f20 4e4f 500a 2020   {.    // NOP.  
-00034340: 2020 554e 5553 4544 2870 6172 616d 7329    UNUSED(params)
-00034350: 3b0a 2020 2020 554e 5553 4544 2873 7263  ;.    UNUSED(src
-00034360: 3029 3b0a 2020 2020 554e 5553 4544 2864  0);.    UNUSED(d
-00034370: 7374 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  st);.}..// ggml_
-00034380: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00034390: 7669 6577 0a0a 7374 6174 6963 2076 6f69  view..static voi
-000343a0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-000343b0: 6f72 7761 7264 5f76 6965 7728 0a20 2020  orward_view(.   
-000343c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000343d0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-000343e0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-000343f0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00034400: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00034410: 202a 2073 7263 3029 207b 0a20 2020 202f   * src0) {.    /
-00034420: 2f20 4e4f 500a 2020 2020 554e 5553 4544  / NOP.    UNUSED
-00034430: 2870 6172 616d 7329 3b0a 2020 2020 554e  (params);.    UN
-00034440: 5553 4544 2873 7263 3029 3b0a 7d0a 0a2f  USED(src0);.}../
-00034450: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00034460: 6f72 7761 7264 5f70 6572 6d75 7465 0a0a  orward_permute..
-00034470: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00034480: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00034490: 5f70 6572 6d75 7465 280a 2020 2020 2020  _permute(.      
-000344a0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000344b0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-000344c0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-000344d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000344e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000344f0: 7372 6330 2920 7b0a 2020 2020 2f2f 204e  src0) {.    // N
-00034500: 4f50 0a20 2020 2055 4e55 5345 4428 7061  OP.    UNUSED(pa
-00034510: 7261 6d73 293b 0a20 2020 2055 4e55 5345  rams);.    UNUSE
-00034520: 4428 7372 6330 293b 0a7d 0a0a 2f2f 2067  D(src0);.}..// g
-00034530: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00034540: 6172 645f 7472 616e 7370 6f73 650a 0a73  ard_transpose..s
-00034550: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00034560: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00034570: 7472 616e 7370 6f73 6528 0a20 2020 2020  transpose(.     
-00034580: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00034590: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-000345a0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-000345b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000345c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000345d0: 2073 7263 3029 207b 0a20 2020 202f 2f20   src0) {.    // 
-000345e0: 4e4f 500a 2020 2020 554e 5553 4544 2870  NOP.    UNUSED(p
-000345f0: 6172 616d 7329 3b0a 2020 2020 554e 5553  arams);.    UNUS
-00034600: 4544 2873 7263 3029 3b0a 7d0a 0a2f 2f20  ED(src0);.}..// 
-00034610: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00034620: 7761 7264 5f67 6574 5f72 6f77 730a 0a73  ward_get_rows..s
-00034630: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00034640: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00034650: 6765 745f 726f 7773 5f71 345f 3028 0a20  get_rows_q4_0(. 
-00034660: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00034670: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00034680: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00034690: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000346a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000346b0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-000346c0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000346d0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000346e0: 6331 2c0a 2020 2020 2020 2020 2020 2020  c1,.            
-000346f0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00034700: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00034710: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
-00034720: 3e69 7468 203d 3d20 3029 3b0a 0a20 2020  >ith == 0);..   
-00034730: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00034740: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-00034750: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-00034760: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00034770: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-00034780: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-00034790: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
-000347a0: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
-000347b0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-000347c0: 7420 6e72 203d 2067 676d 6c5f 6e65 6c65  t nr = ggml_nele
-000347d0: 6d65 6e74 7328 7372 6331 293b 0a0a 2020  ments(src1);..  
-000347e0: 2020 6173 7365 7274 2820 6473 742d 3e6e    assert( dst->n
-000347f0: 655b 305d 203d 3d20 6e63 293b 0a20 2020  e[0] == nc);.   
-00034800: 2061 7373 6572 7428 2064 7374 2d3e 6e65   assert( dst->ne
-00034810: 5b31 5d20 3d3d 206e 7229 3b0a 2020 2020  [1] == nr);.    
-00034820: 6173 7365 7274 2873 7263 302d 3e6e 625b  assert(src0->nb[
-00034830: 305d 203d 3d20 4747 4d4c 5f54 5950 455f  0] == GGML_TYPE_
-00034840: 5349 5a45 5b47 474d 4c5f 5459 5045 5f51  SIZE[GGML_TYPE_Q
-00034850: 345f 305d 293b 0a0a 2020 2020 666f 7220  4_0]);..    for 
-00034860: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00034870: 6e72 3b20 2b2b 6929 207b 0a20 2020 2020  nr; ++i) {.     
-00034880: 2020 2063 6f6e 7374 2069 6e74 2072 203d     const int r =
-00034890: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-000348a0: 6331 2d3e 6461 7461 295b 695d 3b0a 0a20  c1->data)[i];.. 
-000348b0: 2020 2020 2020 2064 6571 7561 6e74 697a         dequantiz
-000348c0: 655f 726f 775f 7134 5f30 280a 2020 2020  e_row_q4_0(.    
-000348d0: 2020 2020 2020 2020 2020 2020 2863 6f6e              (con
-000348e0: 7374 2076 6f69 6420 2a29 2028 2863 6861  st void *) ((cha
-000348f0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00034900: 2b20 722a 7372 6330 2d3e 6e62 5b31 5d29  + r*src0->nb[1])
-00034910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00034920: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00034930: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
-00034940: 3e64 6174 6120 2b20 692a 6473 742d 3e6e  >data + i*dst->n
-00034950: 625b 315d 292c 206e 6329 3b0a 2020 2020  b[1]), nc);.    
-00034960: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00034970: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00034980: 7277 6172 645f 6765 745f 726f 7773 5f71  rward_get_rows_q
-00034990: 345f 3128 0a20 2020 2020 2020 2063 6f6e  4_1(.        con
-000349a0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000349b0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000349c0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000349d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000349e0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-000349f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00034a00: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00034a10: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00034a20: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00034a30: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00034a40: 2920 7b0a 2020 2020 6173 7365 7274 2870  ) {.    assert(p
-00034a50: 6172 616d 732d 3e69 7468 203d 3d20 3029  arams->ith == 0)
-00034a60: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-00034a70: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00034a80: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-00034a90: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00034aa0: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-00034ab0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-00034ac0: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-00034ad0: 6e73 7420 696e 7420 6e63 203d 2073 7263  nst int nc = src
-00034ae0: 302d 3e6e 655b 305d 3b0a 2020 2020 636f  0->ne[0];.    co
-00034af0: 6e73 7420 696e 7420 6e72 203d 2067 676d  nst int nr = ggm
-00034b00: 6c5f 6e65 6c65 6d65 6e74 7328 7372 6331  l_nelements(src1
-00034b10: 293b 0a0a 2020 2020 6173 7365 7274 2820  );..    assert( 
-00034b20: 6473 742d 3e6e 655b 305d 203d 3d20 6e63  dst->ne[0] == nc
-00034b30: 293b 0a20 2020 2061 7373 6572 7428 2064  );.    assert( d
-00034b40: 7374 2d3e 6e65 5b31 5d20 3d3d 206e 7229  st->ne[1] == nr)
-00034b50: 3b0a 2020 2020 6173 7365 7274 2873 7263  ;.    assert(src
-00034b60: 302d 3e6e 625b 305d 203d 3d20 4747 4d4c  0->nb[0] == GGML
-00034b70: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
-00034b80: 5459 5045 5f51 345f 315d 293b 0a0a 2020  TYPE_Q4_1]);..  
-00034b90: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00034ba0: 3b20 6920 3c20 6e72 3b20 2b2b 6929 207b  ; i < nr; ++i) {
-00034bb0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00034bc0: 6e74 2072 203d 2028 2869 6e74 3332 5f74  nt r = ((int32_t
-00034bd0: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-00034be0: 695d 3b0a 0a20 2020 2020 2020 2064 6571  i];..        deq
-00034bf0: 7561 6e74 697a 655f 726f 775f 7134 5f31  uantize_row_q4_1
-00034c00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00034c10: 2020 2863 6f6e 7374 2076 6f69 6420 2a29    (const void *)
-00034c20: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00034c30: 3e64 6174 6120 2b20 722a 7372 6330 2d3e  >data + r*src0->
-00034c40: 6e62 5b31 5d29 2c0a 2020 2020 2020 2020  nb[1]),.        
-00034c50: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-00034c60: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00034c70: 2020 6473 742d 3e64 6174 6120 2b20 692a    dst->data + i*
-00034c80: 6473 742d 3e6e 625b 315d 292c 206e 6329  dst->nb[1]), nc)
-00034c90: 3b0a 2020 2020 7d0a 7d0a 0a73 7461 7469  ;.    }.}..stati
-00034ca0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00034cb0: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
-00034cc0: 726f 7773 5f66 3136 280a 2020 2020 2020  rows_f16(.      
-00034cd0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00034ce0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00034cf0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00034d00: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00034d10: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00034d20: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00034d30: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00034d40: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00034d50: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00034d60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00034d70: 2a20 6473 7429 207b 0a20 2020 2061 7373  * dst) {.    ass
-00034d80: 6572 7428 7061 7261 6d73 2d3e 6974 6820  ert(params->ith 
-00034d90: 3d3d 2030 293b 0a0a 2020 2020 6966 2028  == 0);..    if (
-00034da0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00034db0: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-00034dc0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00034dd0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00034de0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00034df0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00034e00: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
-00034e10: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
-00034e20: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
-00034e30: 3d20 6767 6d6c 5f6e 656c 656d 656e 7473  = ggml_nelements
-00034e40: 2873 7263 3129 3b0a 0a20 2020 2061 7373  (src1);..    ass
-00034e50: 6572 7428 2064 7374 2d3e 6e65 5b30 5d20  ert( dst->ne[0] 
-00034e60: 3d3d 206e 6329 3b0a 2020 2020 6173 7365  == nc);.    asse
-00034e70: 7274 2820 6473 742d 3e6e 655b 315d 203d  rt( dst->ne[1] =
-00034e80: 3d20 6e72 293b 0a20 2020 2061 7373 6572  = nr);.    asser
-00034e90: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
-00034ea0: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-00034eb0: 365f 7429 293b 0a0a 2020 2020 666f 7220  6_t));..    for 
-00034ec0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00034ed0: 6e72 3b20 2b2b 6929 207b 0a20 2020 2020  nr; ++i) {.     
-00034ee0: 2020 2063 6f6e 7374 2069 6e74 2072 203d     const int r =
-00034ef0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-00034f00: 6331 2d3e 6461 7461 295b 695d 3b0a 0a20  c1->data)[i];.. 
-00034f10: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00034f20: 6a20 3d20 303b 206a 203c 206e 633b 202b  j = 0; j < nc; +
-00034f30: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
-00034f40: 2020 6767 6d6c 5f66 7031 365f 7420 7620    ggml_fp16_t v 
-00034f50: 3d20 2828 6767 6d6c 5f66 7031 365f 7420  = ((ggml_fp16_t 
-00034f60: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-00034f70: 302d 3e64 6174 6120 2b20 722a 7372 6330  0->data + r*src0
-00034f80: 2d3e 6e62 5b31 5d29 295b 6a5d 3b0a 2020  ->nb[1]))[j];.  
-00034f90: 2020 2020 2020 2020 2020 2828 666c 6f61            ((floa
-00034fa0: 7420 2a29 2028 2863 6861 7220 2a29 2020  t *) ((char *)  
-00034fb0: 6473 742d 3e64 6174 6120 2b20 692a 6473  dst->data + i*ds
-00034fc0: 742d 3e6e 625b 315d 2929 5b6a 5d20 3d20  t->nb[1]))[j] = 
-00034fd0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-00034fe0: 3228 7629 3b0a 2020 2020 2020 2020 7d0a  2(v);.        }.
-00034ff0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-00035000: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-00035010: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-00035020: 7773 5f66 3332 280a 2020 2020 2020 2020  ws_f32(.        
-00035030: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00035040: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00035050: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00035060: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00035070: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00035080: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-00035090: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000350a0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-000350b0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-000350c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000350d0: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
-000350e0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
-000350f0: 2030 293b 0a0a 2020 2020 6966 2028 7061   0);..    if (pa
-00035100: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00035110: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-00035120: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00035130: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00035140: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00035150: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00035160: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-00035170: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
-00035180: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-00035190: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-000351a0: 7263 3129 3b0a 0a20 2020 2061 7373 6572  rc1);..    asser
-000351b0: 7428 2064 7374 2d3e 6e65 5b30 5d20 3d3d  t( dst->ne[0] ==
-000351c0: 206e 6329 3b0a 2020 2020 6173 7365 7274   nc);.    assert
-000351d0: 2820 6473 742d 3e6e 655b 315d 203d 3d20  ( dst->ne[1] == 
-000351e0: 6e72 293b 0a20 2020 2061 7373 6572 7428  nr);.    assert(
-000351f0: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
-00035200: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-00035210: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00035220: 2030 3b20 6920 3c20 6e72 3b20 2b2b 6929   0; i < nr; ++i)
-00035230: 207b 0a20 2020 2020 2020 2063 6f6e 7374   {.        const
-00035240: 2069 6e74 2072 203d 2028 2869 6e74 3332   int r = ((int32
-00035250: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-00035260: 295b 695d 3b0a 0a20 2020 2020 2020 2067  )[i];..        g
-00035270: 676d 6c5f 7665 635f 6370 795f 6633 3228  gml_vec_cpy_f32(
-00035280: 6e63 2c0a 2020 2020 2020 2020 2020 2020  nc,.            
-00035290: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-000352a0: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
-000352b0: 7461 202b 2069 2a64 7374 2d3e 6e62 5b31  ta + i*dst->nb[1
-000352c0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000352d0: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-000352e0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-000352f0: 7461 202b 2072 2a73 7263 302d 3e6e 625b  ta + r*src0->nb[
-00035300: 315d 2929 3b0a 2020 2020 7d0a 7d0a 0a73  1]));.    }.}..s
-00035310: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00035320: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00035330: 6765 745f 726f 7773 280a 2020 2020 2020  get_rows(.      
-00035340: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00035350: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00035360: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00035370: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00035380: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00035390: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-000353a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000353b0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-000353c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000353d0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000353e0: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-000353f0: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-00035400: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00035410: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
-00035420: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00035430: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00035440: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
-00035450: 5f72 6f77 735f 7134 5f30 2870 6172 616d  _rows_q4_0(param
-00035460: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00035470: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00035480: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00035490: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000354a0: 5f51 345f 313a 0a20 2020 2020 2020 2020  _Q4_1:.         
-000354b0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000354c0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-000354d0: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-000354e0: 7773 5f71 345f 3128 7061 7261 6d73 2c20  ws_q4_1(params, 
-000354f0: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-00035500: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00035510: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00035520: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
-00035530: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
-00035540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035550: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00035560: 7277 6172 645f 6765 745f 726f 7773 5f66  rward_get_rows_f
-00035570: 3136 2870 6172 616d 732c 2073 7263 302c  16(params, src0,
-00035580: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-00035590: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000355a0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000355b0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-000355c0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000355d0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000355e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000355f0: 5f67 6574 5f72 6f77 735f 6633 3228 7061  _get_rows_f32(pa
-00035600: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-00035610: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-00035620: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00035630: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00035640: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
-00035650: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-00035660: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
-00035670: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
-00035680: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00035690: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
-000356a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000356b0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-000356c0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-000356d0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000356e0: 6561 6b3b 0a20 2020 207d 0a0a 2020 2020  eak;.    }..    
-000356f0: 2f2f 7374 6174 6963 2062 6f6f 6c20 6669  //static bool fi
-00035700: 7273 7420 3d20 7472 7565 3b0a 2020 2020  rst = true;.    
-00035710: 2f2f 7072 696e 7466 2822 6e65 3020 3d20  //printf("ne0 = 
-00035720: 2564 2c20 6e65 3120 3d20 2564 2c20 6e65  %d, ne1 = %d, ne
-00035730: 3220 3d20 2564 5c6e 222c 2064 7374 2d3e  2 = %d\n", dst->
-00035740: 6e65 5b30 5d2c 2064 7374 2d3e 6e65 5b31  ne[0], dst->ne[1
-00035750: 5d2c 2064 7374 2d3e 6e65 5b32 5d29 3b0a  ], dst->ne[2]);.
-00035760: 2020 2020 2f2f 6966 2028 6669 7273 7429      //if (first)
-00035770: 207b 0a20 2020 202f 2f20 2020 2066 6972   {.    //    fir
-00035780: 7374 203d 2066 616c 7365 3b0a 2020 2020  st = false;.    
-00035790: 2f2f 7d20 656c 7365 207b 0a20 2020 202f  //} else {.    /
-000357a0: 2f20 2020 2066 6f72 2028 696e 7420 6b20  /    for (int k 
-000357b0: 3d20 303b 206b 203c 2064 7374 2d3e 6e65  = 0; k < dst->ne
-000357c0: 5b31 5d3b 202b 2b6b 2920 7b0a 2020 2020  [1]; ++k) {.    
-000357d0: 2f2f 2020 2020 2020 2020 666f 7220 2869  //        for (i
-000357e0: 6e74 206a 203d 2030 3b20 6a20 3c20 6473  nt j = 0; j < ds
-000357f0: 742d 3e6e 655b 305d 2f31 363b 202b 2b6a  t->ne[0]/16; ++j
-00035800: 2920 7b0a 2020 2020 2f2f 2020 2020 2020  ) {.    //      
-00035810: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00035820: 203d 2030 3b20 6920 3c20 3136 3b20 2b2b   = 0; i < 16; ++
-00035830: 6929 207b 0a20 2020 202f 2f20 2020 2020  i) {.    //     
-00035840: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00035850: 6628 2225 382e 3466 2022 2c20 2828 666c  f("%8.4f ", ((fl
-00035860: 6f61 7420 2a29 2064 7374 2d3e 6461 7461  oat *) dst->data
-00035870: 295b 6b2a 6473 742d 3e6e 655b 305d 202b  )[k*dst->ne[0] +
-00035880: 206a 2a31 3620 2b20 695d 293b 0a20 2020   j*16 + i]);.   
-00035890: 202f 2f20 2020 2020 2020 2020 2020 207d   //            }
-000358a0: 0a20 2020 202f 2f20 2020 2020 2020 2020  .    //         
-000358b0: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
-000358c0: 0a20 2020 202f 2f20 2020 2020 2020 207d  .    //        }
-000358d0: 0a20 2020 202f 2f20 2020 2020 2020 2070  .    //        p
-000358e0: 7269 6e74 6628 225c 6e22 293b 0a20 2020  rintf("\n");.   
-000358f0: 202f 2f20 2020 207d 0a20 2020 202f 2f20   //    }.    // 
-00035900: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
-00035910: 0a20 2020 202f 2f20 2020 2065 7869 7428  .    //    exit(
-00035920: 3029 3b0a 2020 2020 2f2f 7d0a 7d0a 0a2f  0);.    //}.}../
-00035930: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00035940: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
-00035950: 5f69 6e66 0a0a 7374 6174 6963 2076 6f69  _inf..static voi
-00035960: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00035970: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
-00035980: 5f69 6e66 5f66 3332 280a 2020 2020 2020  _inf_f32(.      
-00035990: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000359a0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-000359b0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-000359c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000359d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000359e0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-000359f0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00035a00: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00035a10: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00035a20: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00035a30: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
-00035a40: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
-00035a50: 0a20 2020 2061 7373 6572 7428 7372 6331  .    assert(src1
-00035a60: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00035a70: 5950 455f 4933 3229 3b0a 2020 2020 6173  YPE_I32);.    as
-00035a80: 7365 7274 2867 676d 6c5f 6e65 6c65 6d65  sert(ggml_neleme
-00035a90: 6e74 7328 7372 6331 2920 3d3d 2031 293b  nts(src1) == 1);
-00035aa0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00035ab0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00035ac0: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
-00035ad0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00035ae0: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
-00035af0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-00035b00: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
-00035b10: 7374 2069 6e74 206e 5f70 6173 7420 3d20  st int n_past = 
-00035b20: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
-00035b30: 312d 3e64 6174 6129 5b30 5d3b 0a0a 2020  1->data)[0];..  
-00035b40: 2020 2f2f 2054 4f44 4f3a 2068 616e 646c    // TODO: handl
-00035b50: 6520 7472 616e 7370 6f73 6564 2f70 6572  e transposed/per
-00035b60: 6d75 7465 6420 6d61 7472 6963 6573 0a0a  muted matrices..
-00035b70: 2020 2020 636f 6e73 7420 696e 7420 6e20      const int n 
-00035b80: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
-00035b90: 6330 293b 0a20 2020 2063 6f6e 7374 2069  c0);.    const i
-00035ba0: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
-00035bb0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00035bc0: 6e74 206e 7220 3d20 7372 6330 2d3e 6e65  nt nr = src0->ne
-00035bd0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00035be0: 6e74 206e 7a20 3d20 6e2f 6e72 3b0a 0a20  nt nz = n/nr;.. 
-00035bf0: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
-00035c00: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00035c10: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
-00035c20: 6572 7428 7372 6330 2d3e 6e62 5b30 5d20  ert(src0->nb[0] 
-00035c30: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00035c40: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-00035c50: 206b 203d 2030 3b20 6b20 3c20 6e7a 3b20   k = 0; k < nz; 
-00035c60: 6b2b 2b29 207b 0a20 2020 2020 2020 2066  k++) {.        f
-00035c70: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-00035c80: 203c 206e 723b 206a 2b2b 2920 7b0a 2020   < nr; j++) {.  
-00035c90: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00035ca0: 6e74 2069 203d 206e 5f70 6173 743b 2069  nt i = n_past; i
-00035cb0: 203c 206e 633b 2069 2b2b 2920 7b0a 2020   < nc; i++) {.  
-00035cc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00035cd0: 2028 6920 3e20 6e5f 7061 7374 202b 206a   (i > n_past + j
-00035ce0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00035cf0: 2020 2020 2020 2020 2a28 666c 6f61 7420          *(float 
-00035d00: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
-00035d10: 3e64 6174 6120 2b20 6b2a 6473 742d 3e6e  >data + k*dst->n
-00035d20: 625b 325d 202b 206a 2a64 7374 2d3e 6e62  b[2] + j*dst->nb
-00035d30: 5b31 5d20 2b20 692a 6473 742d 3e6e 625b  [1] + i*dst->nb[
-00035d40: 305d 2920 3d20 2d49 4e46 494e 4954 593b  0]) = -INFINITY;
-00035d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035d60: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-00035d70: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00035d80: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-00035d90: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00035da0: 7761 7264 5f64 6961 675f 6d61 736b 5f69  ward_diag_mask_i
-00035db0: 6e66 280a 2020 2020 2020 2020 636f 6e73  nf(.        cons
-00035dc0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00035dd0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00035de0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00035df0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00035e00: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00035e10: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00035e20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00035e30: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00035e40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00035e50: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00035e60: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-00035e70: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00035e80: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00035e90: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00035ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035eb0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00035ec0: 7277 6172 645f 6469 6167 5f6d 6173 6b5f  rward_diag_mask_
-00035ed0: 696e 665f 6633 3228 7061 7261 6d73 2c20  inf_f32(params, 
-00035ee0: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-00035ef0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00035f00: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00035f10: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00035f20: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
-00035f30: 2047 474d 4c5f 5459 5045 5f51 345f 313a   GGML_TYPE_Q4_1:
-00035f40: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00035f50: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
-00035f60: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00035f70: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
-00035f80: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-00035f90: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
-00035fa0: 2047 474d 4c5f 5459 5045 5f46 3136 3a0a   GGML_TYPE_F16:.
-00035fb0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00035fc0: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
-00035fd0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00035fe0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00035ff0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00036000: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00036010: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-00036020: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00036030: 7277 6172 645f 736f 6674 5f6d 6178 0a0a  rward_soft_max..
-00036040: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00036050: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00036060: 5f73 6f66 745f 6d61 785f 6633 3228 0a20  _soft_max_f32(. 
-00036070: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00036080: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00036090: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-000360a0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000360b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000360c0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-000360d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-000360e0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-000360f0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00036100: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
-00036110: 7328 7372 6330 2929 3b0a 2020 2020 4747  s(src0));.    GG
-00036120: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
-00036130: 735f 636f 6e74 6967 756f 7573 2864 7374  s_contiguous(dst
-00036140: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00036150: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
-00036160: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
-00036170: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
-00036180: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00036190: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-000361a0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-000361b0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-000361c0: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-000361d0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-000361e0: 202f 2f20 544f 444f 3a20 6861 6e64 6c65   // TODO: handle
-000361f0: 2074 7261 6e73 706f 7365 642f 7065 726d   transposed/perm
-00036200: 7574 6564 206d 6174 7269 6365 730a 0a20  uted matrices.. 
-00036210: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00036220: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00036230: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00036240: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-00036250: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00036260: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-00036270: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00036280: 6e72 203d 2067 676d 6c5f 6e72 6f77 7328  nr = ggml_nrows(
-00036290: 7372 6330 293b 0a0a 2020 2020 2f2f 2072  src0);..    // r
-000362a0: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
-000362b0: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
-000362c0: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
-000362d0: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
-000362e0: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
-000362f0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-00036300: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
-00036310: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00036320: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
-00036330: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
-00036340: 666f 7220 2869 6e74 2069 3120 3d20 6972  for (int i1 = ir
-00036350: 303b 2069 3120 3c20 6972 313b 2069 312b  0; i1 < ir1; i1+
-00036360: 2b29 207b 0a20 2020 2020 2020 2066 6c6f  +) {.        flo
-00036370: 6174 202a 7020 3d20 2866 6c6f 6174 202a  at *p = (float *
-00036380: 2928 2863 6861 7220 2a29 2064 7374 2d3e  )((char *) dst->
-00036390: 6461 7461 202b 2069 312a 6473 742d 3e6e  data + i1*dst->n
-000363a0: 625b 315d 293b 0a0a 2369 666e 6465 6620  b[1]);..#ifndef 
-000363b0: 4e44 4542 5547 0a20 2020 2020 2020 2066  NDEBUG.        f
-000363c0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-000363d0: 203c 206e 633b 202b 2b69 2920 7b0a 2020   < nc; ++i) {.  
-000363e0: 2020 2020 2020 2020 2020 2f2f 7072 696e            //prin
-000363f0: 7466 2822 705b 2564 5d20 3d20 2566 5c6e  tf("p[%d] = %f\n
-00036400: 222c 2069 2c20 705b 695d 293b 0a20 2020  ", i, p[i]);.   
-00036410: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00036420: 2169 736e 616e 2870 5b69 5d29 293b 0a20  !isnan(p[i]));. 
-00036430: 2020 2020 2020 207d 0a23 656e 6469 660a         }.#endif.
-00036440: 0a20 2020 2020 2020 2066 6c6f 6174 206d  .        float m
-00036450: 6178 203d 202d 494e 4649 4e49 5459 3b0a  ax = -INFINITY;.
-00036460: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00036470: 5f6d 6178 5f66 3332 286e 632c 2026 6d61  _max_f32(nc, &ma
-00036480: 782c 2070 293b 0a0a 2020 2020 2020 2020  x, p);..        
-00036490: 6767 6d6c 5f66 6c6f 6174 2073 756d 203d  ggml_float sum =
-000364a0: 2030 2e30 3b0a 0a20 2020 2020 2020 2075   0.0;..        u
-000364b0: 696e 7431 365f 7420 7363 7674 3b0a 2020  int16_t scvt;.  
-000364c0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-000364d0: 203d 2030 3b20 6920 3c20 6e63 3b20 692b   = 0; i < nc; i+
-000364e0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000364f0: 2069 6620 2870 5b69 5d20 3d3d 202d 494e   if (p[i] == -IN
-00036500: 4649 4e49 5459 2920 7b0a 2020 2020 2020  FINITY) {.      
-00036510: 2020 2020 2020 2020 2020 705b 695d 203d            p[i] =
-00036520: 2030 2e30 663b 0a20 2020 2020 2020 2020   0.0f;.         
-00036530: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-00036540: 2020 2020 2020 2020 2020 2020 2f2f 636f              //co
-00036550: 6e73 7420 666c 6f61 7420 7661 6c20 3d20  nst float val = 
-00036560: 2870 5b69 5d20 3d3d 202d 494e 4649 4e49  (p[i] == -INFINI
-00036570: 5459 2920 3f20 302e 3020 3a20 6578 7028  TY) ? 0.0 : exp(
-00036580: 705b 695d 202d 206d 6178 293b 0a20 2020  p[i] - max);.   
-00036590: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000365a0: 6c5f 6670 3136 5f74 2073 203d 2047 474d  l_fp16_t s = GGM
-000365b0: 4c5f 4650 3332 5f54 4f5f 4650 3136 2870  L_FP32_TO_FP16(p
-000365c0: 5b69 5d20 2d20 6d61 7829 3b0a 2020 2020  [i] - max);.    
-000365d0: 2020 2020 2020 2020 2020 2020 6d65 6d63              memc
-000365e0: 7079 2826 7363 7674 2c20 2673 2c20 7369  py(&scvt, &s, si
-000365f0: 7a65 6f66 2873 6376 7429 293b 0a20 2020  zeof(scvt));.   
-00036600: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00036610: 7374 2066 6c6f 6174 2076 616c 203d 2047  st float val = G
-00036620: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
-00036630: 2874 6162 6c65 5f65 7870 5f66 3136 5b73  (table_exp_f16[s
-00036640: 6376 745d 293b 0a20 2020 2020 2020 2020  cvt]);.         
-00036650: 2020 2020 2020 2073 756d 202b 3d20 7661         sum += va
-00036660: 6c3b 0a20 2020 2020 2020 2020 2020 2020  l;.             
-00036670: 2020 2070 5b69 5d20 3d20 7661 6c3b 0a20     p[i] = val;. 
-00036680: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00036690: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000366a0: 6173 7365 7274 2873 756d 203e 2030 2e30  assert(sum > 0.0
-000366b0: 6629 3b0a 0a20 2020 2020 2020 2073 756d  f);..        sum
-000366c0: 203d 2031 2e30 2f73 756d 3b0a 2020 2020   = 1.0/sum;.    
-000366d0: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
-000366e0: 6c65 5f66 3332 286e 632c 2070 2c20 7375  le_f32(nc, p, su
-000366f0: 6d29 3b0a 0a23 6966 6e64 6566 204e 4445  m);..#ifndef NDE
-00036700: 4255 470a 2020 2020 2020 2020 666f 7220  BUG.        for 
-00036710: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00036720: 6e63 3b20 2b2b 6929 207b 0a20 2020 2020  nc; ++i) {.     
-00036730: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
-00036740: 736e 616e 2870 5b69 5d29 293b 0a20 2020  snan(p[i]));.   
-00036750: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00036760: 2169 7369 6e66 2870 5b69 5d29 293b 0a20  !isinf(p[i]));. 
-00036770: 2020 2020 2020 207d 0a23 656e 6469 660a         }.#endif.
-00036780: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-00036790: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-000367a0: 655f 666f 7277 6172 645f 736f 6674 5f6d  e_forward_soft_m
-000367b0: 6178 280a 2020 2020 2020 2020 636f 6e73  ax(.        cons
-000367c0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-000367d0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000367e0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000367f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00036800: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00036810: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00036820: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00036830: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00036840: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00036850: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00036860: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00036870: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00036880: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00036890: 7075 7465 5f66 6f72 7761 7264 5f73 6f66  pute_forward_sof
-000368a0: 745f 6d61 785f 6633 3228 7061 7261 6d73  t_max_f32(params
-000368b0: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
-000368c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000368d0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000368e0: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
-000368f0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00036900: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
-00036910: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00036920: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
-00036930: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-00036940: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
-00036950: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
+0002ddb0: 206e 6531 312c 206e 6530 312c 206e 6531   ne11, ne01, ne1
+0002ddc0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+0002ddd0: 2020 2020 2020 2020 2020 2031 2e30 662c             1.0f,
+0002dde0: 2020 2020 792c 206e 6531 302c 0a20 2020      y, ne10,.   
+0002ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de00: 2020 2020 2020 2020 2020 2020 2020 782c                x,
+0002de10: 206e 6531 302c 0a20 2020 2020 2020 2020   ne10,.         
+0002de20: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+0002de30: 2e30 662c 2020 2020 642c 206e 6530 3129  .0f,    d, ne01)
+0002de40: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0002de50: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0002de60: 2020 202f 2a70 7269 6e74 6628 2243 424c     /*printf("CBL
+0002de70: 4153 2046 3136 203d 2025 6620 6d73 2c20  AS F16 = %f ms, 
+0002de80: 2564 2078 2025 6420 7820 2564 2078 2025  %d x %d x %d x %
+0002de90: 645c 6e22 2c20 2867 676d 6c5f 7065 7266  d\n", (ggml_perf
+0002dea0: 5f74 696d 655f 7573 2829 202d 2074 3029  _time_us() - t0)
+0002deb0: 2f31 3030 302e 302c 206e 6530 2c20 6e65  /1000.0, ne0, ne
+0002dec0: 312c 206e 6532 2c20 6e65 3329 3b2a 2f0a  1, ne2, ne3);*/.
+0002ded0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0002dee0: 0a20 2020 207d 0a23 656e 6469 660a 0a20  .    }.#endif.. 
+0002def0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+0002df00: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0002df10: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
+0002df20: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
+0002df30: 6f6e 7374 2077 6461 7461 203d 2070 6172  onst wdata = par
+0002df40: 616d 732d 3e77 6461 7461 3b0a 0a20 2020  ams->wdata;..   
+0002df50: 2020 2020 2073 697a 655f 7420 6964 203d       size_t id =
+0002df60: 2030 3b0a 2020 2020 2020 2020 666f 7220   0;.        for 
+0002df70: 2869 6e74 2069 3133 203d 2030 3b20 6931  (int i13 = 0; i1
+0002df80: 3320 3c20 6e65 3133 3b20 2b2b 6931 3329  3 < ne13; ++i13)
+0002df90: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0002dfa0: 6f72 2028 696e 7420 6931 3220 3d20 303b  or (int i12 = 0;
+0002dfb0: 2069 3132 203c 206e 6531 323b 202b 2b69   i12 < ne12; ++i
+0002dfc0: 3132 2920 7b0a 2020 2020 2020 2020 2020  12) {.          
+0002dfd0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0002dfe0: 3131 203d 2030 3b20 6931 3120 3c20 6e65  11 = 0; i11 < ne
+0002dff0: 3131 3b20 2b2b 6931 3129 207b 0a20 2020  11; ++i11) {.   
+0002e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e010: 2066 6f72 2028 696e 7420 6931 3020 3d20   for (int i10 = 
+0002e020: 303b 2069 3130 203c 206e 6531 303b 202b  0; i10 < ne10; +
+0002e030: 2b69 3130 2920 7b0a 2020 2020 2020 2020  +i10) {.        
+0002e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e050: 7764 6174 615b 6964 2b2b 5d20 3d20 4747  wdata[id++] = GG
+0002e060: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+0002e070: 2a28 666c 6f61 7420 2a29 2828 6368 6172  *(float *)((char
+0002e080: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
+0002e090: 2069 3133 2a6e 6231 3320 2b20 6931 322a   i13*nb13 + i12*
+0002e0a0: 6e62 3132 202b 2069 3131 2a6e 6231 3120  nb12 + i11*nb11 
+0002e0b0: 2b20 6931 302a 6e62 3130 2929 3b0a 2020  + i10*nb10));.  
+0002e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e0d0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0002e0e0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0002e0f0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+0002e100: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0002e110: 5254 2869 642a 7369 7a65 6f66 2867 676d  RT(id*sizeof(ggm
+0002e120: 6c5f 6670 3136 5f74 2920 3c3d 2070 6172  l_fp16_t) <= par
+0002e130: 616d 732d 3e77 7369 7a65 293b 0a0a 2020  ams->wsize);..  
+0002e140: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0002e150: 2020 7d0a 0a20 2020 2069 6620 2870 6172    }..    if (par
+0002e160: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+0002e170: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+0002e180: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+0002e190: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
+0002e1a0: 2066 7031 3620 2d3e 2068 616c 6620 7468   fp16 -> half th
+0002e1b0: 6520 7369 7a65 2c20 736f 2064 6976 6964  e size, so divid
+0002e1c0: 6520 6279 2032 0a20 2020 202f 2f20 544f  e by 2.    // TO
+0002e1d0: 444f 3a20 646f 206e 6f74 2073 7570 706f  DO: do not suppo
+0002e1e0: 7274 2074 7261 6e73 706f 7365 6420 7372  rt transposed sr
+0002e1f0: 6331 0a20 2020 2061 7373 6572 7428 6e62  c1.    assert(nb
+0002e200: 3130 2f32 203d 3d20 7369 7a65 6f66 2867  10/2 == sizeof(g
+0002e210: 676d 6c5f 6670 3136 5f74 2929 3b0a 0a20  gml_fp16_t));.. 
+0002e220: 2020 202f 2f20 7061 7261 6c6c 656c 697a     // paralleliz
+0002e230: 6520 6279 2073 7263 3020 726f 7773 2075  e by src0 rows u
+0002e240: 7369 6e67 2067 676d 6c5f 7665 635f 646f  sing ggml_vec_do
+0002e250: 745f 6631 360a 0a20 2020 202f 2f20 746f  t_f16..    // to
+0002e260: 7461 6c20 726f 7773 2069 6e20 7372 6330  tal rows in src0
+0002e270: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002e280: 7220 3d20 6e65 3031 2a6e 6530 322a 6e65  r = ne01*ne02*ne
+0002e290: 3033 3b0a 0a20 2020 202f 2f20 726f 7773  03;..    // rows
+0002e2a0: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
+0002e2b0: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
+0002e2c0: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
+0002e2d0: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
+0002e2e0: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
+0002e2f0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+0002e300: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
+0002e310: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+0002e320: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
+0002e330: 722c 206e 7229 3b0a 0a20 2020 2067 676d  r, nr);..    ggm
+0002e340: 6c5f 6670 3136 5f74 202a 2077 6461 7461  l_fp16_t * wdata
+0002e350: 203d 2070 6172 616d 732d 3e77 6461 7461   = params->wdata
+0002e360: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+0002e370: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
+0002e380: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
+0002e390: 2020 2020 2f2f 2073 7263 3020 696e 6469      // src0 indi
+0002e3a0: 6365 730a 2020 2020 2020 2020 636f 6e73  ces.        cons
+0002e3b0: 7420 696e 7420 6930 3320 3d20 6972 2f28  t int i03 = ir/(
+0002e3c0: 6e65 3032 2a6e 6530 3129 3b0a 2020 2020  ne02*ne01);.    
+0002e3d0: 2020 2020 636f 6e73 7420 696e 7420 6930      const int i0
+0002e3e0: 3220 3d20 2869 7220 2d20 6930 332a 6e65  2 = (ir - i03*ne
+0002e3f0: 3032 2a6e 6530 3129 2f6e 6530 313b 0a20  02*ne01)/ne01;. 
+0002e400: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0002e410: 2069 3031 203d 2028 6972 202d 2069 3033   i01 = (ir - i03
+0002e420: 2a6e 6530 322a 6e65 3031 202d 2069 3032  *ne02*ne01 - i02
+0002e430: 2a6e 6530 3129 3b0a 0a20 2020 2020 2020  *ne01);..       
+0002e440: 2063 6f6e 7374 2069 6e74 2069 3133 203d   const int i13 =
+0002e450: 2069 3033 3b0a 2020 2020 2020 2020 636f   i03;.        co
+0002e460: 6e73 7420 696e 7420 6931 3220 3d20 6930  nst int i12 = i0
+0002e470: 323b 0a0a 2020 2020 2020 2020 636f 6e73  2;..        cons
+0002e480: 7420 696e 7420 6930 203d 2069 3031 3b0a  t int i0 = i01;.
+0002e490: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0002e4a0: 7420 6932 203d 2069 3032 3b0a 2020 2020  t i2 = i02;.    
+0002e4b0: 2020 2020 636f 6e73 7420 696e 7420 6933      const int i3
+0002e4c0: 203d 2069 3033 3b0a 0a20 2020 2020 2020   = i03;..       
+0002e4d0: 2067 676d 6c5f 6670 3136 5f74 202a 2073   ggml_fp16_t * s
+0002e4e0: 7263 305f 726f 7720 3d20 2867 676d 6c5f  rc0_row = (ggml_
+0002e4f0: 6670 3136 5f74 202a 2920 2828 6368 6172  fp16_t *) ((char
+0002e500: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+0002e510: 2028 6930 312a 6e62 3031 202b 2069 3032   (i01*nb01 + i02
+0002e520: 2a6e 6230 3220 2b20 6930 332a 6e62 3033  *nb02 + i03*nb03
+0002e530: 2929 3b0a 2020 2020 2020 2020 6767 6d6c  ));.        ggml
+0002e540: 5f66 7031 365f 7420 2a20 7372 6331 5f63  _fp16_t * src1_c
+0002e550: 6f6c 203d 2020 2020 2020 2020 2020 2020  ol =            
+0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e570: 2020 2020 7764 6174 6120 2b20 2820 2020      wdata + (   
+0002e580: 2020 2020 3020 2b20 6931 322a 6e65 3131      0 + i12*ne11
+0002e590: 202b 2069 3133 2a6e 6531 322a 6e65 3131   + i13*ne12*ne11
+0002e5a0: 292a 6e65 3030 3b0a 0a20 2020 2020 2020  )*ne00;..       
+0002e5b0: 2066 6c6f 6174 202a 2064 7374 5f63 6f6c   float * dst_col
+0002e5c0: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
+0002e5d0: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
+0002e5e0: 202b 2028 6930 2a6e 6230 202b 2030 2a6e   + (i0*nb0 + 0*n
+0002e5f0: 6231 202b 2069 322a 6e62 3220 2b20 6933  b1 + i2*nb2 + i3
+0002e600: 2a6e 6233 2929 3b0a 0a20 2020 2020 2020  *nb3));..       
+0002e610: 2066 6f72 2028 696e 7420 6963 203d 2030   for (int ic = 0
+0002e620: 3b20 6963 203c 206e 6531 313b 202b 2b69  ; ic < ne11; ++i
+0002e630: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
+0002e640: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
+0002e650: 3628 6e65 3030 2c20 2664 7374 5f63 6f6c  6(ne00, &dst_col
+0002e660: 5b69 632a 6e65 305d 2c20 7372 6330 5f72  [ic*ne0], src0_r
+0002e670: 6f77 2c20 7372 6331 5f63 6f6c 202b 2069  ow, src1_col + i
+0002e680: 632a 6e65 3030 293b 0a20 2020 2020 2020  c*ne00);.       
+0002e690: 207d 0a20 2020 207d 0a0a 2020 2020 2f2f   }.    }..    //
+0002e6a0: 696e 7436 345f 7420 7431 203d 2067 676d  int64_t t1 = ggm
+0002e6b0: 6c5f 7469 6d65 5f75 7328 293b 0a20 2020  l_time_us();.   
+0002e6c0: 202f 2f73 7461 7469 6320 696e 7436 345f   //static int64_
+0002e6d0: 7420 6163 6320 3d20 303b 0a20 2020 202f  t acc = 0;.    /
+0002e6e0: 2f61 6363 202b 3d20 7431 202d 2074 303b  /acc += t1 - t0;
+0002e6f0: 0a20 2020 202f 2f69 6620 2874 3120 2d20  .    //if (t1 - 
+0002e700: 7430 203e 2031 3029 207b 0a20 2020 202f  t0 > 10) {.    /
+0002e710: 2f20 2020 2070 7269 6e74 6628 225c 6e22  /    printf("\n"
+0002e720: 293b 0a20 2020 202f 2f20 2020 2070 7269  );.    //    pri
+0002e730: 6e74 6628 226e 6530 3020 3d20 2535 642c  ntf("ne00 = %5d,
+0002e740: 206e 6530 3120 3d20 2535 642c 206e 6530   ne01 = %5d, ne0
+0002e750: 3220 3d20 2535 642c 206e 6530 3320 3d20  2 = %5d, ne03 = 
+0002e760: 2535 645c 6e22 2c20 6e65 3030 2c20 6e65  %5d\n", ne00, ne
+0002e770: 3031 2c20 6e65 3032 2c20 6e65 3033 293b  01, ne02, ne03);
+0002e780: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
+0002e790: 6628 226e 6230 3020 3d20 2535 642c 206e  f("nb00 = %5d, n
+0002e7a0: 6230 3120 3d20 2535 642c 206e 6230 3220  b01 = %5d, nb02 
+0002e7b0: 3d20 2535 642c 206e 6230 3320 3d20 2535  = %5d, nb03 = %5
+0002e7c0: 645c 6e22 2c20 6e62 3030 2c20 6e62 3031  d\n", nb00, nb01
+0002e7d0: 2c20 6e62 3032 2c20 6e62 3033 293b 0a20  , nb02, nb03);. 
+0002e7e0: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
+0002e7f0: 226e 6531 3020 3d20 2535 642c 206e 6531  "ne10 = %5d, ne1
+0002e800: 3120 3d20 2535 642c 206e 6531 3220 3d20  1 = %5d, ne12 = 
+0002e810: 2535 642c 206e 6531 3320 3d20 2535 645c  %5d, ne13 = %5d\
+0002e820: 6e22 2c20 6e65 3130 2c20 6e65 3131 2c20  n", ne10, ne11, 
+0002e830: 6e65 3132 2c20 6e65 3133 293b 0a0a 2020  ne12, ne13);..  
+0002e840: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
+0002e850: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0002e860: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0002e870: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0002e880: 5858 5858 2074 6173 6b20 2564 2f25 643a  XXXX task %d/%d:
+0002e890: 2025 6420 7573 2c20 6163 6320 3d20 2564   %d us, acc = %d
+0002e8a0: 5c6e 222c 2069 7468 2c20 6e74 682c 2028  \n", ith, nth, (
+0002e8b0: 696e 7429 2028 7431 202d 2074 3029 2c20  int) (t1 - t0), 
+0002e8c0: 2869 6e74 2920 6163 6329 3b0a 2020 2020  (int) acc);.    
+0002e8d0: 2f2f 7d0a 7d0a 0a74 7970 6564 6566 2076  //}.}..typedef v
+0002e8e0: 6f69 6420 282a 6465 7175 616e 7469 7a65  oid (*dequantize
+0002e8f0: 5f72 6f77 5f71 5f74 2928 636f 6e73 7420  _row_q_t)(const 
+0002e900: 766f 6964 202a 2072 6573 7472 6963 7420  void * restrict 
+0002e910: 782c 2066 6c6f 6174 202a 2072 6573 7472  x, float * restr
+0002e920: 6963 7420 792c 2069 6e74 206b 293b 0a74  ict y, int k);.t
+0002e930: 7970 6564 6566 2076 6f69 6420 282a 7175  ypedef void (*qu
+0002e940: 616e 7469 7a65 5f72 6f77 5f71 5f74 2928  antize_row_q_t)(
+0002e950: 636f 6e73 7420 666c 6f61 7420 2a20 7265  const float * re
+0002e960: 7374 7269 6374 2078 2c20 766f 6964 202a  strict x, void *
+0002e970: 2072 6573 7472 6963 7420 792c 2069 6e74   restrict y, int
+0002e980: 206b 293b 0a74 7970 6564 6566 2076 6f69   k);.typedef voi
+0002e990: 6420 282a 7665 635f 646f 745f 715f 7429  d (*vec_dot_q_t)
+0002e9a0: 2863 6f6e 7374 2069 6e74 206e 2c20 666c  (const int n, fl
+0002e9b0: 6f61 7420 2a20 7265 7374 7269 6374 2073  oat * restrict s
+0002e9c0: 2c20 636f 6e73 7420 766f 6964 202a 2072  , const void * r
+0002e9d0: 6573 7472 6963 7420 782c 2063 6f6e 7374  estrict x, const
+0002e9e0: 2076 6f69 6420 2a20 7265 7374 7269 6374   void * restrict
+0002e9f0: 2079 293b 0a0a 7479 7065 6465 6620 7374   y);..typedef st
+0002ea00: 7275 6374 207b 0a20 2020 2064 6571 7561  ruct {.    dequa
+0002ea10: 6e74 697a 655f 726f 775f 715f 7420 6465  ntize_row_q_t de
+0002ea20: 7175 616e 7469 7a65 5f72 6f77 5f71 3b0a  quantize_row_q;.
+0002ea30: 2020 2020 7175 616e 7469 7a65 5f72 6f77      quantize_row
+0002ea40: 5f71 5f74 2020 2071 7561 6e74 697a 655f  _q_t   quantize_
+0002ea50: 726f 775f 713b 0a20 2020 2076 6563 5f64  row_q;.    vec_d
+0002ea60: 6f74 5f71 5f74 2020 2020 2020 2020 7665  ot_q_t        ve
+0002ea70: 635f 646f 745f 713b 0a7d 2071 7561 6e74  c_dot_q;.} quant
+0002ea80: 697a 655f 666e 735f 743b 0a0a 7374 6174  ize_fns_t;..stat
+0002ea90: 6963 2063 6f6e 7374 2071 7561 6e74 697a  ic const quantiz
+0002eaa0: 655f 666e 735f 7420 7175 616e 7469 7a65  e_fns_t quantize
+0002eab0: 5f66 6e73 5b47 474d 4c5f 5459 5045 5f43  _fns[GGML_TYPE_C
+0002eac0: 4f55 4e54 5d20 3d20 7b0a 2020 2020 5b47  OUNT] = {.    [G
+0002ead0: 474d 4c5f 5459 5045 5f51 345f 305d 203d  GML_TYPE_Q4_0] =
+0002eae0: 207b 0a20 2020 2020 2020 202e 6465 7175   {.        .dequ
+0002eaf0: 616e 7469 7a65 5f72 6f77 5f71 203d 2064  antize_row_q = d
+0002eb00: 6571 7561 6e74 697a 655f 726f 775f 7134  equantize_row_q4
+0002eb10: 5f30 2c0a 2020 2020 2020 2020 2e71 7561  _0,.        .qua
+0002eb20: 6e74 697a 655f 726f 775f 7120 2020 3d20  ntize_row_q   = 
+0002eb30: 7175 616e 7469 7a65 5f72 6f77 5f71 345f  quantize_row_q4_
+0002eb40: 302c 0a20 2020 2020 2020 202e 7665 635f  0,.        .vec_
+0002eb50: 646f 745f 7120 2020 2020 2020 203d 2067  dot_q        = g
+0002eb60: 676d 6c5f 7665 635f 646f 745f 7134 5f30  gml_vec_dot_q4_0
+0002eb70: 2c0a 2020 2020 7d2c 0a20 2020 205b 4747  ,.    },.    [GG
+0002eb80: 4d4c 5f54 5950 455f 5134 5f31 5d20 3d20  ML_TYPE_Q4_1] = 
+0002eb90: 7b0a 2020 2020 2020 2020 2e64 6571 7561  {.        .dequa
+0002eba0: 6e74 697a 655f 726f 775f 7120 3d20 6465  ntize_row_q = de
+0002ebb0: 7175 616e 7469 7a65 5f72 6f77 5f71 345f  quantize_row_q4_
+0002ebc0: 312c 0a20 2020 2020 2020 202e 7175 616e  1,.        .quan
+0002ebd0: 7469 7a65 5f72 6f77 5f71 2020 203d 2071  tize_row_q   = q
+0002ebe0: 7561 6e74 697a 655f 726f 775f 7134 5f31  uantize_row_q4_1
+0002ebf0: 2c0a 2020 2020 2020 2020 2e76 6563 5f64  ,.        .vec_d
+0002ec00: 6f74 5f71 2020 2020 2020 2020 3d20 6767  ot_q        = gg
+0002ec10: 6d6c 5f76 6563 5f64 6f74 5f71 345f 312c  ml_vec_dot_q4_1,
+0002ec20: 0a20 2020 207d 2c0a 7d3b 0a0a 7374 6174  .    },.};..stat
+0002ec30: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+0002ec40: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+0002ec50: 5f6d 6174 5f71 5f66 3332 280a 2020 2020  _mat_q_f32(.    
+0002ec60: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0002ec70: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0002ec80: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0002ec90: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0002eca0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002ecb0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0002ecc0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0002ecd0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0002ece0: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+0002ecf0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002ed00: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
+0002ed10: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
+0002ed20: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
+0002ed30: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
+0002ed40: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0002ed50: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
+0002ed60: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0002ed70: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
+0002ed80: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+0002ed90: 696e 7420 6e65 3032 203d 2073 7263 302d  int ne02 = src0-
+0002eda0: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
+0002edb0: 7420 696e 7420 6e65 3033 203d 2073 7263  t int ne03 = src
+0002edc0: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
+0002edd0: 6f6e 7374 2069 6e74 206e 6531 3020 3d20  onst int ne10 = 
+0002ede0: 7372 6331 2d3e 6e65 5b30 5d3b 0a20 2020  src1->ne[0];.   
+0002edf0: 2063 6f6e 7374 2069 6e74 206e 6531 3120   const int ne11 
+0002ee00: 3d20 7372 6331 2d3e 6e65 5b31 5d3b 0a20  = src1->ne[1];. 
+0002ee10: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
+0002ee20: 3220 3d20 7372 6331 2d3e 6e65 5b32 5d3b  2 = src1->ne[2];
+0002ee30: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002ee40: 6531 3320 3d20 7372 6331 2d3e 6e65 5b33  e13 = src1->ne[3
+0002ee50: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0002ee60: 7420 6e65 3020 203d 2064 7374 2d3e 6e65  t ne0  = dst->ne
+0002ee70: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+0002ee80: 6e74 206e 6531 2020 3d20 6473 742d 3e6e  nt ne1  = dst->n
+0002ee90: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+0002eea0: 696e 7420 6e65 3220 203d 2064 7374 2d3e  int ne2  = dst->
+0002eeb0: 6e65 5b32 5d3b 0a20 2020 2063 6f6e 7374  ne[2];.    const
+0002eec0: 2069 6e74 206e 6533 2020 3d20 6473 742d   int ne3  = dst-
+0002eed0: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
+0002eee0: 7374 2069 6e74 206e 6230 3020 3d20 7372  st int nb00 = sr
+0002eef0: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
+0002ef00: 6f6e 7374 2069 6e74 206e 6230 3120 3d20  onst int nb01 = 
+0002ef10: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
+0002ef20: 2063 6f6e 7374 2069 6e74 206e 6230 3220   const int nb02 
+0002ef30: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
+0002ef40: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
+0002ef50: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
+0002ef60: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0002ef70: 6e62 3130 203d 2073 7263 312d 3e6e 625b  nb10 = src1->nb[
+0002ef80: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0002ef90: 7420 6e62 3131 203d 2073 7263 312d 3e6e  t nb11 = src1->n
+0002efa0: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+0002efb0: 696e 7420 6e62 3132 203d 2073 7263 312d  int nb12 = src1-
+0002efc0: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+0002efd0: 7420 696e 7420 6e62 3133 203d 2073 7263  t int nb13 = src
+0002efe0: 312d 3e6e 625b 335d 3b0a 0a20 2020 2063  1->nb[3];..    c
+0002eff0: 6f6e 7374 2069 6e74 206e 6230 2020 3d20  onst int nb0  = 
+0002f000: 6473 742d 3e6e 625b 305d 3b0a 2020 2020  dst->nb[0];.    
+0002f010: 636f 6e73 7420 696e 7420 6e62 3120 203d  const int nb1  =
+0002f020: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
+0002f030: 2063 6f6e 7374 2069 6e74 206e 6232 2020   const int nb2  
+0002f040: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
+0002f050: 2020 636f 6e73 7420 696e 7420 6e62 3320    const int nb3 
+0002f060: 203d 2064 7374 2d3e 6e62 5b33 5d3b 0a0a   = dst->nb[3];..
+0002f070: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+0002f080: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+0002f090: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0002f0a0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+0002f0b0: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0002f0c0: 5254 286e 6530 3220 3d3d 206e 6531 3229  RT(ne02 == ne12)
+0002f0d0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0002f0e0: 5428 6e65 3033 203d 3d20 6e65 3133 293b  T(ne03 == ne13);
+0002f0f0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0002f100: 286e 6532 2020 3d3d 206e 6531 3229 3b0a  (ne2  == ne12);.
+0002f110: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0002f120: 6e65 3320 203d 3d20 6e65 3133 293b 0a0a  ne3  == ne13);..
+0002f130: 2020 2020 636f 6e73 7420 656e 756d 2067      const enum g
+0002f140: 676d 6c5f 7479 7065 2074 7970 6520 3d20  gml_type type = 
+0002f150: 7372 6330 2d3e 7479 7065 3b0a 2020 2020  src0->type;.    
+0002f160: 7175 616e 7469 7a65 5f72 6f77 5f71 5f74  quantize_row_q_t
+0002f170: 2063 6f6e 7374 2071 7561 6e74 697a 655f   const quantize_
+0002f180: 726f 775f 7120 3d20 7175 616e 7469 7a65  row_q = quantize
+0002f190: 5f66 6e73 5b74 7970 655d 2e71 7561 6e74  _fns[type].quant
+0002f1a0: 697a 655f 726f 775f 713b 0a20 2020 2076  ize_row_q;.    v
+0002f1b0: 6563 5f64 6f74 5f71 5f74 2020 2020 2020  ec_dot_q_t      
+0002f1c0: 636f 6e73 7420 7665 635f 646f 745f 7120  const vec_dot_q 
+0002f1d0: 2020 2020 203d 2071 7561 6e74 697a 655f       = quantize_
+0002f1e0: 666e 735b 7479 7065 5d2e 7665 635f 646f  fns[type].vec_do
+0002f1f0: 745f 713b 0a0a 2020 2020 2f2f 2077 6520  t_q;..    // we 
+0002f200: 646f 6e27 7420 7375 7070 6f72 7420 7065  don't support pe
+0002f210: 726d 7574 6564 2073 7263 3020 6f72 2073  rmuted src0 or s
+0002f220: 7263 310a 2020 2020 4747 4d4c 5f41 5353  rc1.    GGML_ASS
+0002f230: 4552 5428 6e62 3030 203d 3d20 2869 6e74  ERT(nb00 == (int
+0002f240: 2920 4747 4d4c 5f54 5950 455f 5349 5a45  ) GGML_TYPE_SIZE
+0002f250: 5b74 7970 655d 293b 0a20 2020 2047 474d  [type]);.    GGM
+0002f260: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
+0002f270: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+0002f280: 0a0a 2020 2020 2f2f 2064 7374 2063 616e  ..    // dst can
+0002f290: 6e6f 7420 6265 2074 7261 6e73 706f 7365  not be transpose
+0002f2a0: 6420 6f72 2070 6572 6d75 7465 640a 2020  d or permuted.  
+0002f2b0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0002f2c0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+0002f2d0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+0002f2e0: 5345 5254 286e 6230 203c 3d20 6e62 3129  SERT(nb0 <= nb1)
+0002f2f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0002f300: 5428 6e62 3120 3c3d 206e 6232 293b 0a20  T(nb1 <= nb2);. 
+0002f310: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0002f320: 6232 203c 3d20 6e62 3329 3b0a 0a20 2020  b2 <= nb3);..   
+0002f330: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
+0002f340: 203d 3d20 6e65 3031 293b 0a20 2020 2047   == ne01);.    G
+0002f350: 474d 4c5f 4153 5345 5254 286e 6531 203d  GML_ASSERT(ne1 =
+0002f360: 3d20 6e65 3131 293b 0a20 2020 2047 474d  = ne11);.    GGM
+0002f370: 4c5f 4153 5345 5254 286e 6532 203d 3d20  L_ASSERT(ne2 == 
+0002f380: 6e65 3032 293b 0a20 2020 2047 474d 4c5f  ne02);.    GGML_
+0002f390: 4153 5345 5254 286e 6533 203d 3d20 6e65  ASSERT(ne3 == ne
+0002f3a0: 3033 293b 0a0a 2020 2020 2f2f 206e 6230  03);..    // nb0
+0002f3b0: 3120 3e3d 206e 6230 3020 2d20 7372 6330  1 >= nb00 - src0
+0002f3c0: 2069 7320 6e6f 7420 7472 616e 7370 6f73   is not transpos
+0002f3d0: 6564 0a20 2020 202f 2f20 2020 636f 6d70  ed.    //   comp
+0002f3e0: 7574 6520 6279 2073 7263 3020 726f 7773  ute by src0 rows
+0002f3f0: 0a0a 2369 6620 6465 6669 6e65 6428 4747  ..#if defined(GG
+0002f400: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
+0002f410: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
+0002f420: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
+0002f430: 0a20 2020 2069 6620 2867 676d 6c5f 636f  .    if (ggml_co
+0002f440: 6d70 7574 655f 666f 7277 6172 645f 6d75  mpute_forward_mu
+0002f450: 6c5f 6d61 745f 7573 655f 626c 6173 2873  l_mat_use_blas(s
+0002f460: 7263 302c 2073 7263 312c 2064 7374 2929  rc0, src1, dst))
+0002f470: 207b 0a20 2020 2020 2020 2069 6620 2870   {.        if (p
+0002f480: 6172 616d 732d 3e69 7468 2021 3d20 3029  arams->ith != 0)
+0002f490: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
+0002f4a0: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
+0002f4b0: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
+0002f4c0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+0002f4d0: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
+0002f4e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002f4f0: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
+0002f500: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
+0002f510: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0002f520: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+0002f530: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002f540: 7572 6e3b 0a20 2020 2020 2020 207d 0a0a  urn;.        }..
+0002f550: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0002f560: 636f 6e73 7420 7764 6174 6120 3d20 7061  const wdata = pa
+0002f570: 7261 6d73 2d3e 7764 6174 613b 0a20 2020  rams->wdata;.   
+0002f580: 2020 2020 2064 6571 7561 6e74 697a 655f       dequantize_
+0002f590: 726f 775f 715f 7420 636f 6e73 7420 6465  row_q_t const de
+0002f5a0: 7175 616e 7469 7a65 5f72 6f77 5f71 203d  quantize_row_q =
+0002f5b0: 2071 7561 6e74 697a 655f 666e 735b 7479   quantize_fns[ty
+0002f5c0: 7065 5d2e 6465 7175 616e 7469 7a65 5f72  pe].dequantize_r
+0002f5d0: 6f77 5f71 3b0a 0a20 2020 2020 2020 2066  ow_q;..        f
+0002f5e0: 6f72 2028 696e 7420 6930 3320 3d20 303b  or (int i03 = 0;
+0002f5f0: 2069 3033 203c 206e 6530 333b 2069 3033   i03 < ne03; i03
+0002f600: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0002f610: 2020 666f 7220 2869 6e74 2069 3032 203d    for (int i02 =
+0002f620: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+0002f630: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+0002f640: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0002f650: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002f660: 697a 655f 7420 6964 203d 2030 3b0a 2020  ize_t id = 0;.  
+0002f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f680: 2020 666f 7220 2869 6e74 2069 3031 203d    for (int i01 =
+0002f690: 2030 3b20 6930 3120 3c20 6e65 3031 3b20   0; i01 < ne01; 
+0002f6a0: 2b2b 6930 3129 207b 0a20 2020 2020 2020  ++i01) {.       
+0002f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6c0: 2064 6571 7561 6e74 697a 655f 726f 775f   dequantize_row_
+0002f6d0: 7128 2863 6861 7220 2a29 2073 7263 302d  q((char *) src0-
+0002f6e0: 3e64 6174 6120 2b20 6930 332a 6e62 3033  >data + i03*nb03
+0002f6f0: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
+0002f700: 312a 6e62 3031 2c20 7764 6174 6120 2b20  1*nb01, wdata + 
+0002f710: 6964 2c20 6e65 3030 293b 0a20 2020 2020  id, ne00);.     
+0002f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f730: 2020 2069 6420 2b3d 206e 6530 303b 0a20     id += ne00;. 
+0002f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f750: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0002f760: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0002f770: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+0002f780: 6f61 7420 2a20 7820 3d20 7764 6174 613b  oat * x = wdata;
+0002f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f7a0: 2063 6f6e 7374 2066 6c6f 6174 202a 2079   const float * y
+0002f7b0: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
+0002f7c0: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
+0002f7d0: 6120 2b20 6930 322a 6e62 3132 202b 2069  a + i02*nb12 + i
+0002f7e0: 3033 2a6e 6231 3329 3b0a 0a20 2020 2020  03*nb13);..     
+0002f7f0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0002f800: 202a 2064 203d 2028 666c 6f61 7420 2a29   * d = (float *)
+0002f810: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+0002f820: 6461 7461 202b 2069 3032 2a6e 6232 202b  data + i02*nb2 +
+0002f830: 2069 3033 2a6e 6233 293b 0a0a 2020 2020   i03*nb3);..    
+0002f840: 2020 2020 2020 2020 2020 2020 2f2f 207a              // z
+0002f850: 5420 3d20 7920 2a20 7854 0a20 2020 2020  T = y * xT.     
+0002f860: 2020 2020 2020 2020 2020 2063 626c 6173             cblas
+0002f870: 5f73 6765 6d6d 2843 626c 6173 526f 774d  _sgemm(CblasRowM
+0002f880: 616a 6f72 2c20 4362 6c61 734e 6f54 7261  ajor, CblasNoTra
+0002f890: 6e73 2c20 4362 6c61 7354 7261 6e73 2c0a  ns, CblasTrans,.
+0002f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8b0: 2020 2020 2020 2020 6e65 3131 2c20 6e65          ne11, ne
+0002f8c0: 3031 2c20 6e65 3130 2c0a 2020 2020 2020  01, ne10,.      
+0002f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8e0: 2020 312e 3066 2c20 2020 2079 2c20 6e65    1.0f,    y, ne
+0002f8f0: 3130 2c0a 2020 2020 2020 2020 2020 2020  10,.            
+0002f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f910: 2020 2020 2078 2c20 6e65 3130 2c0a 2020       x, ne10,.  
+0002f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f930: 2020 2020 2020 302e 3066 2c20 2020 2064        0.0f,    d
+0002f940: 2c20 6e65 3031 293b 0a20 2020 2020 2020  , ne01);.       
+0002f950: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+0002f960: 0a0a 2020 2020 2020 2020 2f2f 7072 696e  ..        //prin
+0002f970: 7466 2822 4342 4c41 5320 3d20 2566 206d  tf("CBLAS = %f m
+0002f980: 732c 2025 6420 7820 2564 2078 2025 6420  s, %d x %d x %d 
+0002f990: 7820 2564 5c6e 222c 2028 6767 6d6c 5f70  x %d\n", (ggml_p
+0002f9a0: 6572 665f 7469 6d65 5f75 7328 2920 2d20  erf_time_us() - 
+0002f9b0: 7430 292f 3130 3030 2e30 2c20 6e65 302c  t0)/1000.0, ne0,
+0002f9c0: 206e 6531 2c20 6e65 322c 206e 6533 293b   ne1, ne2, ne3);
+0002f9d0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0002f9e0: 3b0a 2020 2020 7d0a 2365 6e64 6966 0a0a  ;.    }.#endif..
+0002f9f0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+0002fa00: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+0002fa10: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
+0002fa20: 2020 6368 6172 202a 2077 6461 7461 203d    char * wdata =
+0002fa30: 2070 6172 616d 732d 3e77 6461 7461 3b0a   params->wdata;.
+0002fa40: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0002fa50: 7a65 5f74 2072 6f77 5f73 697a 6520 3d20  ze_t row_size = 
+0002fa60: 6e65 3130 2a47 474d 4c5f 5459 5045 5f53  ne10*GGML_TYPE_S
+0002fa70: 495a 455b 7479 7065 5d2f 4747 4d4c 5f42  IZE[type]/GGML_B
+0002fa80: 4c43 4b5f 5349 5a45 5b74 7970 655d 3b0a  LCK_SIZE[type];.
+0002fa90: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+0002faa0: 7420 6931 3320 3d20 303b 2069 3133 203c  t i13 = 0; i13 <
+0002fab0: 206e 6531 333b 202b 2b69 3133 2920 7b0a   ne13; ++i13) {.
+0002fac0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0002fad0: 2869 6e74 2069 3132 203d 2030 3b20 6931  (int i12 = 0; i1
+0002fae0: 3220 3c20 6e65 3132 3b20 2b2b 6931 3229  2 < ne12; ++i12)
+0002faf0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002fb00: 2020 2066 6f72 2028 696e 7420 6931 3120     for (int i11 
+0002fb10: 3d20 303b 2069 3131 203c 206e 6531 313b  = 0; i11 < ne11;
+0002fb20: 202b 2b69 3131 2920 7b0a 2020 2020 2020   ++i11) {.      
+0002fb30: 2020 2020 2020 2020 2020 2020 2020 7175                qu
+0002fb40: 616e 7469 7a65 5f72 6f77 5f71 2828 666c  antize_row_q((fl
+0002fb50: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+0002fb60: 7372 6331 2d3e 6461 7461 202b 2069 3133  src1->data + i13
+0002fb70: 2a6e 6231 3320 2b20 6931 322a 6e62 3132  *nb13 + i12*nb12
+0002fb80: 202b 2069 3131 2a6e 6231 3129 2c20 2876   + i11*nb11), (v
+0002fb90: 6f69 6420 2a29 2077 6461 7461 2c20 6e65  oid *) wdata, ne
+0002fba0: 3130 293b 0a20 2020 2020 2020 2020 2020  10);.           
+0002fbb0: 2020 2020 2020 2020 2077 6461 7461 202b           wdata +
+0002fbc0: 3d20 726f 775f 7369 7a65 3b0a 2020 2020  = row_size;.    
+0002fbd0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0002fbe0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0002fbf0: 2020 2020 7d0a 0a20 2020 2020 2020 2072      }..        r
+0002fc00: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0002fc10: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+0002fc20: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0002fc30: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+0002fc40: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+0002fc50: 7d0a 0a20 2020 202f 2f20 7061 7261 6c6c  }..    // parall
+0002fc60: 656c 697a 6520 6279 2073 7263 3020 726f  elize by src0 ro
+0002fc70: 7773 2075 7369 6e67 2067 676d 6c5f 7665  ws using ggml_ve
+0002fc80: 635f 646f 745f 710a 0a20 2020 202f 2f20  c_dot_q..    // 
+0002fc90: 746f 7461 6c20 726f 7773 2069 6e20 7372  total rows in sr
+0002fca0: 6330 0a20 2020 2063 6f6e 7374 2069 6e74  c0.    const int
+0002fcb0: 206e 7220 3d20 6e65 3031 2a6e 6530 322a   nr = ne01*ne02*
+0002fcc0: 6e65 3033 3b0a 0a20 2020 202f 2f20 726f  ne03;..    // ro
+0002fcd0: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
+0002fce0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
+0002fcf0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
+0002fd00: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
+0002fd10: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
+0002fd20: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+0002fd30: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
+0002fd40: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+0002fd50: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
+0002fd60: 2064 722c 206e 7229 3b0a 0a20 2020 2076   dr, nr);..    v
+0002fd70: 6f69 6420 2a20 7764 6174 6120 3d20 7061  oid * wdata = pa
+0002fd80: 7261 6d73 2d3e 7764 6174 613b 0a20 2020  rams->wdata;.   
+0002fd90: 2063 6f6e 7374 2073 697a 655f 7420 726f   const size_t ro
+0002fda0: 775f 7369 7a65 203d 206e 6530 302a 4747  w_size = ne00*GG
+0002fdb0: 4d4c 5f54 5950 455f 5349 5a45 5b74 7970  ML_TYPE_SIZE[typ
+0002fdc0: 655d 2f47 474d 4c5f 424c 434b 5f53 495a  e]/GGML_BLCK_SIZ
+0002fdd0: 455b 7479 7065 5d3b 0a0a 2020 2020 666f  E[type];..    fo
+0002fde0: 7220 2869 6e74 2069 7220 3d20 6972 303b  r (int ir = ir0;
+0002fdf0: 2069 7220 3c20 6972 313b 202b 2b69 7229   ir < ir1; ++ir)
+0002fe00: 207b 0a20 2020 2020 2020 202f 2f20 7372   {.        // sr
+0002fe10: 6330 2069 6e64 6963 6573 0a20 2020 2020  c0 indices.     
+0002fe20: 2020 2063 6f6e 7374 2069 6e74 2069 3033     const int i03
+0002fe30: 203d 2069 722f 286e 6530 322a 6e65 3031   = ir/(ne02*ne01
+0002fe40: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0002fe50: 2069 6e74 2069 3032 203d 2028 6972 202d   int i02 = (ir -
+0002fe60: 2069 3033 2a6e 6530 322a 6e65 3031 292f   i03*ne02*ne01)/
+0002fe70: 6e65 3031 3b0a 2020 2020 2020 2020 636f  ne01;.        co
+0002fe80: 6e73 7420 696e 7420 6930 3120 3d20 2869  nst int i01 = (i
+0002fe90: 7220 2d20 6930 332a 6e65 3032 2a6e 6530  r - i03*ne02*ne0
+0002fea0: 3120 2d20 6930 322a 6e65 3031 293b 0a0a  1 - i02*ne01);..
+0002feb0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0002fec0: 7420 6931 3320 3d20 6930 333b 0a20 2020  t i13 = i03;.   
+0002fed0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0002fee0: 3132 203d 2069 3032 3b0a 0a20 2020 2020  12 = i02;..     
+0002fef0: 2020 2063 6f6e 7374 2069 6e74 2069 3020     const int i0 
+0002ff00: 3d20 6930 313b 0a20 2020 2020 2020 2063  = i01;.        c
+0002ff10: 6f6e 7374 2069 6e74 2069 3220 3d20 6930  onst int i2 = i0
+0002ff20: 323b 0a20 2020 2020 2020 2063 6f6e 7374  2;.        const
+0002ff30: 2069 6e74 2069 3320 3d20 6930 333b 0a0a   int i3 = i03;..
+0002ff40: 2020 2020 2020 2020 766f 6964 202a 2073          void * s
+0002ff50: 7263 305f 726f 7720 3d20 2876 6f69 6420  rc0_row = (void 
+0002ff60: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+0002ff70: 302d 3e64 6174 6120 2b20 2869 3031 2a6e  0->data + (i01*n
+0002ff80: 6230 3120 2b20 6930 322a 6e62 3032 202b  b01 + i02*nb02 +
+0002ff90: 2069 3033 2a6e 6230 3329 293b 0a20 2020   i03*nb03));.   
+0002ffa0: 2020 2020 2063 6861 7220 2a20 7372 6331       char * src1
+0002ffb0: 5f63 6f6c 203d 2020 2020 2020 2020 2020  _col =          
+0002ffc0: 2828 6368 6172 202a 2920 2020 2020 2077  ((char *)      w
+0002ffd0: 6461 7461 202b 2028 2020 2020 2020 2830  data + (      (0
+0002ffe0: 202b 2069 3132 2a6e 6531 3120 2b20 6931   + i12*ne11 + i1
+0002fff0: 332a 6e65 3132 2a6e 6531 3129 2a72 6f77  3*ne12*ne11)*row
+00030000: 5f73 697a 6529 293b 0a0a 2020 2020 2020  _size));..      
+00030010: 2020 666c 6f61 7420 2a20 6473 745f 636f    float * dst_co
+00030020: 6c20 3d20 2866 6c6f 6174 202a 2920 2828  l = (float *) ((
+00030030: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+00030040: 6120 2b20 2869 302a 6e62 3020 2b20 302a  a + (i0*nb0 + 0*
+00030050: 6e62 3120 2b20 6932 2a6e 6232 202b 2069  nb1 + i2*nb2 + i
+00030060: 332a 6e62 3329 293b 0a0a 2020 2020 2020  3*nb3));..      
+00030070: 2020 6173 7365 7274 286e 6530 3020 2520    assert(ne00 % 
+00030080: 3332 203d 3d20 3029 3b0a 0a20 2020 2020  32 == 0);..     
+00030090: 2020 2066 6f72 2028 696e 7420 6963 203d     for (int ic =
+000300a0: 2030 3b20 6963 203c 206e 6531 313b 202b   0; ic < ne11; +
+000300b0: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
+000300c0: 2020 2076 6563 5f64 6f74 5f71 286e 6530     vec_dot_q(ne0
+000300d0: 302c 2026 6473 745f 636f 6c5b 6963 2a6e  0, &dst_col[ic*n
+000300e0: 6530 5d2c 2073 7263 305f 726f 772c 2028  e0], src0_row, (
+000300f0: 766f 6964 202a 2920 2873 7263 315f 636f  void *) (src1_co
+00030100: 6c20 2b20 6963 2a72 6f77 5f73 697a 6529  l + ic*row_size)
+00030110: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
+00030120: 207d 0a0a 2020 2020 2f2f 696e 7436 345f   }..    //int64_
+00030130: 7420 7431 203d 2067 676d 6c5f 7469 6d65  t t1 = ggml_time
+00030140: 5f75 7328 293b 0a20 2020 202f 2f73 7461  _us();.    //sta
+00030150: 7469 6320 696e 7436 345f 7420 6163 6320  tic int64_t acc 
+00030160: 3d20 303b 0a20 2020 202f 2f61 6363 202b  = 0;.    //acc +
+00030170: 3d20 7431 202d 2074 303b 0a20 2020 202f  = t1 - t0;.    /
+00030180: 2f69 6620 2874 3120 2d20 7430 203e 2031  /if (t1 - t0 > 1
+00030190: 3029 207b 0a20 2020 202f 2f20 2020 2070  0) {.    //    p
+000301a0: 7269 6e74 6628 225c 6e22 293b 0a20 2020  rintf("\n");.   
+000301b0: 202f 2f20 2020 2070 7269 6e74 6628 226e   //    printf("n
+000301c0: 6530 3020 3d20 2535 642c 206e 6530 3120  e00 = %5d, ne01 
+000301d0: 3d20 2535 642c 206e 6530 3220 3d20 2535  = %5d, ne02 = %5
+000301e0: 642c 206e 6530 3320 3d20 2535 645c 6e22  d, ne03 = %5d\n"
+000301f0: 2c20 6e65 3030 2c20 6e65 3031 2c20 6e65  , ne00, ne01, ne
+00030200: 3032 2c20 6e65 3033 293b 0a20 2020 202f  02, ne03);.    /
+00030210: 2f20 2020 2070 7269 6e74 6628 226e 6230  /    printf("nb0
+00030220: 3020 3d20 2535 642c 206e 6230 3120 3d20  0 = %5d, nb01 = 
+00030230: 2535 642c 206e 6230 3220 3d20 2535 642c  %5d, nb02 = %5d,
+00030240: 206e 6230 3320 3d20 2535 645c 6e22 2c20   nb03 = %5d\n", 
+00030250: 6e62 3030 2c20 6e62 3031 2c20 6e62 3032  nb00, nb01, nb02
+00030260: 2c20 6e62 3033 293b 0a20 2020 202f 2f20  , nb03);.    // 
+00030270: 2020 2070 7269 6e74 6628 226e 6531 3020     printf("ne10 
+00030280: 3d20 2535 642c 206e 6531 3120 3d20 2535  = %5d, ne11 = %5
+00030290: 642c 206e 6531 3220 3d20 2535 642c 206e  d, ne12 = %5d, n
+000302a0: 6531 3320 3d20 2535 645c 6e22 2c20 6e65  e13 = %5d\n", ne
+000302b0: 3130 2c20 6e65 3131 2c20 6e65 3132 2c20  10, ne11, ne12, 
+000302c0: 6e65 3133 293b 0a0a 2020 2020 2f2f 2020  ne13);..    //  
+000302d0: 2020 7072 696e 7466 2822 5858 5858 5858    printf("XXXXXX
+000302e0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+000302f0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00030300: 5858 5858 5858 5858 5858 5858 5858 2074  XXXXXXXXXXXXXX t
+00030310: 6173 6b20 2564 2f25 643a 2025 6420 7573  ask %d/%d: %d us
+00030320: 2c20 6163 6320 3d20 2564 5c6e 222c 2069  , acc = %d\n", i
+00030330: 7468 2c20 6e74 682c 2028 696e 7429 2028  th, nth, (int) (
+00030340: 7431 202d 2074 3029 2c20 2869 6e74 2920  t1 - t0), (int) 
+00030350: 6163 6329 3b0a 2020 2020 2f2f 7d0a 7d0a  acc);.    //}.}.
+00030360: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00030370: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00030380: 645f 6d75 6c5f 6d61 7428 0a20 2020 2020  d_mul_mat(.     
+00030390: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000303a0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+000303b0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+000303c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000303d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000303e0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+000303f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00030400: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00030410: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00030420: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00030430: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00030440: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00030450: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00030460: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
+00030470: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00030480: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
+00030490: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000304a0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+000304b0: 7465 5f66 6f72 7761 7264 5f6d 756c 5f6d  te_forward_mul_m
+000304c0: 6174 5f71 5f66 3332 2870 6172 616d 732c  at_q_f32(params,
+000304d0: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
+000304e0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000304f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00030500: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00030510: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
+00030520: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00030530: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00030540: 6f72 7761 7264 5f6d 756c 5f6d 6174 5f66  orward_mul_mat_f
+00030550: 3136 5f66 3332 2870 6172 616d 732c 2073  16_f32(params, s
+00030560: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+00030570: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00030580: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00030590: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
+000305a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000305b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000305d0: 7761 7264 5f6d 756c 5f6d 6174 5f66 3332  ward_mul_mat_f32
+000305e0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+000305f0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00030600: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00030610: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00030620: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
+00030630: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00030640: 455f 4931 363a 0a20 2020 2020 2020 2063  E_I16:.        c
+00030650: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
+00030660: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
+00030670: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
+00030680: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00030690: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+000306a0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+000306b0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000306c0: 2062 7265 616b 3b0a 2020 2020 7d0a 0a23   break;.    }..#
+000306d0: 6966 2030 0a20 2020 2069 6620 2873 7263  if 0.    if (src
+000306e0: 302d 3e74 7970 6520 3d3d 2047 474d 4c5f  0->type == GGML_
+000306f0: 5459 5045 5f46 3136 207c 7c20 7372 6330  TYPE_F16 || src0
+00030700: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00030710: 5950 455f 5134 5f31 2920 7b0a 2020 2020  YPE_Q4_1) {.    
+00030720: 2020 2020 7374 6174 6963 2069 6e74 2066      static int f
+00030730: 6972 7374 203d 2038 3b0a 2020 2020 2020  irst = 8;.      
+00030740: 2020 7072 696e 7466 2822 7372 6330 3a20    printf("src0: 
+00030750: 6e65 3020 3d20 2535 642c 206e 6531 203d  ne0 = %5d, ne1 =
+00030760: 2025 3564 2c20 6e65 3220 3d20 2535 645c   %5d, ne2 = %5d\
+00030770: 6e22 2c20 7372 6330 2d3e 6e65 5b30 5d2c  n", src0->ne[0],
+00030780: 2073 7263 302d 3e6e 655b 315d 2c20 7372   src0->ne[1], sr
+00030790: 6330 2d3e 6e65 5b32 5d29 3b0a 2020 2020  c0->ne[2]);.    
+000307a0: 2020 2020 7072 696e 7466 2822 7372 6331      printf("src1
+000307b0: 3a20 6e65 3020 3d20 2535 642c 206e 6531  : ne0 = %5d, ne1
+000307c0: 203d 2025 3564 2c20 6e65 3220 3d20 2535   = %5d, ne2 = %5
+000307d0: 645c 6e22 2c20 7372 6331 2d3e 6e65 5b30  d\n", src1->ne[0
+000307e0: 5d2c 2073 7263 312d 3e6e 655b 315d 2c20  ], src1->ne[1], 
+000307f0: 7372 6331 2d3e 6e65 5b32 5d29 3b0a 2020  src1->ne[2]);.  
+00030800: 2020 2020 2020 7072 696e 7466 2822 6473        printf("ds
+00030810: 743a 2020 6e65 3020 3d20 2535 642c 206e  t:  ne0 = %5d, n
+00030820: 6531 203d 2025 3564 2c20 6e65 3220 3d20  e1 = %5d, ne2 = 
+00030830: 2535 645c 6e22 2c20 6473 742d 3e6e 655b  %5d\n", dst->ne[
+00030840: 305d 2c20 6473 742d 3e6e 655b 315d 2c20  0], dst->ne[1], 
+00030850: 6473 742d 3e6e 655b 325d 293b 0a20 2020  dst->ne[2]);.   
+00030860: 2020 2020 2069 6620 2866 6972 7374 2920       if (first) 
+00030870: 7b0a 2020 2020 2020 2020 2020 2020 2d2d  {.            --
+00030880: 6669 7273 743b 0a20 2020 2020 2020 207d  first;.        }
+00030890: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+000308a0: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
+000308b0: 2030 3b20 6b20 3c20 6473 742d 3e6e 655b   0; k < dst->ne[
+000308c0: 315d 3b20 2b2b 6b29 207b 0a20 2020 2020  1]; ++k) {.     
+000308d0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+000308e0: 696e 7420 6a20 3d20 303b 206a 203c 2064  int j = 0; j < d
+000308f0: 7374 2d3e 6e65 5b30 5d2f 3136 3b20 2b2b  st->ne[0]/16; ++
+00030900: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+00030910: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00030920: 7420 6920 3d20 303b 2069 203c 2031 363b  t i = 0; i < 16;
+00030930: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00030940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030950: 7072 696e 7466 2822 2538 2e34 6620 222c  printf("%8.4f ",
+00030960: 2028 2866 6c6f 6174 202a 2920 6473 742d   ((float *) dst-
+00030970: 3e64 6174 6129 5b6b 2a64 7374 2d3e 6e65  >data)[k*dst->ne
+00030980: 5b30 5d20 2b20 6a2a 3136 202b 2069 5d29  [0] + j*16 + i])
+00030990: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000309a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000309b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000309c0: 7466 2822 5c6e 2229 3b0a 2020 2020 2020  tf("\n");.      
+000309d0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000309e0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000309f0: 7466 2822 5c6e 2229 3b0a 2020 2020 2020  tf("\n");.      
+00030a00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00030a10: 2020 2020 7072 696e 7466 2822 5c6e 2229      printf("\n")
+00030a20: 3b0a 2020 2020 2020 2020 2020 2020 6578  ;.            ex
+00030a30: 6974 2830 293b 0a20 2020 2020 2020 207d  it(0);.        }
+00030a40: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
+00030a50: 2020 2020 2020 7072 696e 7466 2822 6161        printf("aa
+00030a60: 6161 2073 7263 303a 206e 6530 203d 2025  aa src0: ne0 = %
+00030a70: 3564 2c20 6e65 3120 3d20 2535 642c 206e  5d, ne1 = %5d, n
+00030a80: 6532 203d 2025 3564 5c6e 222c 2073 7263  e2 = %5d\n", src
+00030a90: 302d 3e6e 655b 305d 2c20 7372 6330 2d3e  0->ne[0], src0->
+00030aa0: 6e65 5b31 5d2c 2073 7263 302d 3e6e 655b  ne[1], src0->ne[
+00030ab0: 325d 293b 0a20 2020 2020 2020 2070 7269  2]);.        pri
+00030ac0: 6e74 6628 2261 6161 6120 7372 6331 3a20  ntf("aaaa src1: 
+00030ad0: 6e65 3020 3d20 2535 642c 206e 6531 203d  ne0 = %5d, ne1 =
+00030ae0: 2025 3564 2c20 6e65 3220 3d20 2535 645c   %5d, ne2 = %5d\
+00030af0: 6e22 2c20 7372 6331 2d3e 6e65 5b30 5d2c  n", src1->ne[0],
+00030b00: 2073 7263 312d 3e6e 655b 315d 2c20 7372   src1->ne[1], sr
+00030b10: 6331 2d3e 6e65 5b32 5d29 3b0a 2020 2020  c1->ne[2]);.    
+00030b20: 2020 2020 7072 696e 7466 2822 6161 6161      printf("aaaa
+00030b30: 2064 7374 3a20 206e 6530 203d 2025 3564   dst:  ne0 = %5d
+00030b40: 2c20 6e65 3120 3d20 2535 642c 206e 6532  , ne1 = %5d, ne2
+00030b50: 203d 2025 3564 5c6e 222c 2064 7374 2d3e   = %5d\n", dst->
+00030b60: 6e65 5b30 5d2c 2064 7374 2d3e 6e65 5b31  ne[0], dst->ne[1
+00030b70: 5d2c 2064 7374 2d3e 6e65 5b32 5d29 3b0a  ], dst->ne[2]);.
+00030b80: 2020 2020 7d0a 2365 6e64 6966 0a7d 0a0a      }.#endif.}..
+00030b90: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
+00030ba0: 666f 7277 6172 645f 7363 616c 650a 0a73  forward_scale..s
+00030bb0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00030bc0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00030bd0: 7363 616c 655f 6633 3228 0a20 2020 2020  scale_f32(.     
+00030be0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00030bf0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00030c00: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00030c10: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00030c20: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00030c30: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00030c40: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00030c50: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00030c60: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00030c70: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00030c80: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+00030c90: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
+00030ca0: 6967 756f 7573 2873 7263 3029 293b 0a20  iguous(src0));. 
+00030cb0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+00030cc0: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+00030cd0: 7328 6473 7429 293b 0a20 2020 2047 474d  s(dst));.    GGM
+00030ce0: 4c5f 4153 5345 5254 2867 676d 6c5f 6172  L_ASSERT(ggml_ar
+00030cf0: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
+00030d00: 302c 2064 7374 2929 3b0a 2020 2020 4747  0, dst));.    GG
+00030d10: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00030d20: 735f 7363 616c 6172 2873 7263 3129 293b  s_scalar(src1));
+00030d30: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00030d40: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00030d50: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+00030d60: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00030d70: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+00030d80: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00030d90: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+00030da0: 7363 616c 6520 6661 6374 6f72 0a20 2020  scale factor.   
+00030db0: 2063 6f6e 7374 2066 6c6f 6174 2076 203d   const float v =
+00030dc0: 202a 2866 6c6f 6174 202a 2920 7372 6331   *(float *) src1
+00030dd0: 2d3e 6461 7461 3b0a 0a20 2020 2063 6f6e  ->data;..    con
+00030de0: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00030df0: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00030e00: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00030e10: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00030e20: 636f 6e73 7420 696e 7420 6e63 203d 2073  const int nc = s
+00030e30: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
+00030e40: 636f 6e73 7420 696e 7420 6e72 203d 2067  const int nr = g
+00030e50: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
+00030e60: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
+00030e70: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
+00030e80: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
+00030e90: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
+00030ea0: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
+00030eb0: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
+00030ec0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+00030ed0: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
+00030ee0: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
+00030ef0: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
+00030f00: 6e72 293b 0a0a 2020 2020 666f 7220 2869  nr);..    for (i
+00030f10: 6e74 2069 3120 3d20 6972 303b 2069 3120  nt i1 = ir0; i1 
+00030f20: 3c20 6972 313b 2069 312b 2b29 207b 0a20  < ir1; i1++) {. 
+00030f30: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00030f40: 7363 616c 655f 6633 3228 6e63 2c20 2866  scale_f32(nc, (f
+00030f50: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00030f60: 2920 6473 742d 3e64 6174 6120 2b20 6931  ) dst->data + i1
+00030f70: 2a28 6473 742d 3e6e 625b 315d 2929 2c20  *(dst->nb[1])), 
+00030f80: 7629 3b0a 2020 2020 7d0a 7d0a 0a73 7461  v);.    }.}..sta
+00030f90: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00030fa0: 6d70 7574 655f 666f 7277 6172 645f 7363  mpute_forward_sc
+00030fb0: 616c 6528 0a20 2020 2020 2020 2063 6f6e  ale(.        con
+00030fc0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00030fd0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00030fe0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00030ff0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00031000: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00031010: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00031020: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00031030: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00031040: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00031050: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00031060: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+00031070: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+00031080: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00031090: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+000310a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000310b0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000310c0: 6f72 7761 7264 5f73 6361 6c65 5f66 3332  orward_scale_f32
+000310d0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+000310e0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+000310f0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00031100: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00031110: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
+00031120: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00031130: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
+00031140: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00031150: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
+00031160: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
+00031170: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00031180: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
+00031190: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000311a0: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+000311b0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+000311c0: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
+000311d0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000311e0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+000311f0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00031200: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00031210: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+00031220: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00031230: 7079 0a0a 7374 6174 6963 2076 6f69 6420  py..static void 
+00031240: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00031250: 7761 7264 5f63 7079 280a 2020 2020 2020  ward_cpy(.      
+00031260: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00031270: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00031280: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00031290: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000312a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000312b0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+000312c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000312d0: 202a 2064 7374 2920 7b0a 2020 2020 6767   * dst) {.    gg
+000312e0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000312f0: 7264 5f64 7570 2870 6172 616d 732c 2073  rd_dup(params, s
+00031300: 7263 302c 2064 7374 293b 0a7d 0a0a 2f2f  rc0, dst);.}..//
+00031310: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00031320: 7277 6172 645f 7265 7368 6170 650a 0a73  rward_reshape..s
+00031330: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00031340: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00031350: 7265 7368 6170 6528 0a20 2020 2020 2020  reshape(.       
+00031360: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00031370: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00031380: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00031390: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000313a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+000313b0: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
+000313c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000313d0: 2a20 6473 7429 207b 0a20 2020 202f 2f20  * dst) {.    // 
+000313e0: 4e4f 500a 2020 2020 554e 5553 4544 2870  NOP.    UNUSED(p
+000313f0: 6172 616d 7329 3b0a 2020 2020 554e 5553  arams);.    UNUS
+00031400: 4544 2873 7263 3029 3b0a 2020 2020 554e  ED(src0);.    UN
+00031410: 5553 4544 2864 7374 293b 0a7d 0a0a 2f2f  USED(dst);.}..//
+00031420: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00031430: 7277 6172 645f 7669 6577 0a0a 7374 6174  rward_view..stat
+00031440: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00031450: 7075 7465 5f66 6f72 7761 7264 5f76 6965  pute_forward_vie
+00031460: 7728 0a20 2020 2020 2020 2063 6f6e 7374  w(.        const
+00031470: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00031480: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00031490: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+000314a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000314b0: 7465 6e73 6f72 202a 2073 7263 3029 207b  tensor * src0) {
+000314c0: 0a20 2020 202f 2f20 4e4f 500a 2020 2020  .    // NOP.    
+000314d0: 554e 5553 4544 2870 6172 616d 7329 3b0a  UNUSED(params);.
+000314e0: 2020 2020 554e 5553 4544 2873 7263 3029      UNUSED(src0)
+000314f0: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  ;.}..// ggml_com
+00031500: 7075 7465 5f66 6f72 7761 7264 5f70 6572  pute_forward_per
+00031510: 6d75 7465 0a0a 7374 6174 6963 2076 6f69  mute..static voi
+00031520: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00031530: 6f72 7761 7264 5f70 6572 6d75 7465 280a  orward_permute(.
+00031540: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00031550: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00031560: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00031570: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00031580: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00031590: 736f 7220 2a20 7372 6330 2920 7b0a 2020  sor * src0) {.  
+000315a0: 2020 2f2f 204e 4f50 0a20 2020 2055 4e55    // NOP.    UNU
+000315b0: 5345 4428 7061 7261 6d73 293b 0a20 2020  SED(params);.   
+000315c0: 2055 4e55 5345 4428 7372 6330 293b 0a7d   UNUSED(src0);.}
+000315d0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+000315e0: 655f 666f 7277 6172 645f 7472 616e 7370  e_forward_transp
+000315f0: 6f73 650a 0a73 7461 7469 6320 766f 6964  ose..static void
+00031600: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00031610: 7277 6172 645f 7472 616e 7370 6f73 6528  rward_transpose(
+00031620: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00031630: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00031640: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00031650: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00031660: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00031670: 6e73 6f72 202a 2073 7263 3029 207b 0a20  nsor * src0) {. 
+00031680: 2020 202f 2f20 4e4f 500a 2020 2020 554e     // NOP.    UN
+00031690: 5553 4544 2870 6172 616d 7329 3b0a 2020  USED(params);.  
+000316a0: 2020 554e 5553 4544 2873 7263 3029 3b0a    UNUSED(src0);.
+000316b0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+000316c0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+000316d0: 6f77 730a 0a73 7461 7469 6320 766f 6964  ows..static void
+000316e0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000316f0: 7277 6172 645f 6765 745f 726f 7773 5f71  rward_get_rows_q
+00031700: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00031710: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00031720: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00031730: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00031740: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00031750: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00031760: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00031770: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00031780: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+00031790: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000317a0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+000317b0: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
+000317c0: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a0a  ms->ith == 0);..
+000317d0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+000317e0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000317f0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00031800: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00031810: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00031820: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00031830: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00031840: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
+00031850: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00031860: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
+00031870: 656c 656d 656e 7473 2873 7263 3129 3b0a  elements(src1);.
+00031880: 2020 2020 636f 6e73 7420 656e 756d 2067      const enum g
+00031890: 676d 6c5f 7479 7065 2074 7970 6520 3d20  gml_type type = 
+000318a0: 7372 6330 2d3e 7479 7065 3b0a 2020 2020  src0->type;.    
+000318b0: 6465 7175 616e 7469 7a65 5f72 6f77 5f71  dequantize_row_q
+000318c0: 5f74 2063 6f6e 7374 2064 6571 7561 6e74  _t const dequant
+000318d0: 697a 655f 726f 775f 7120 3d20 7175 616e  ize_row_q = quan
+000318e0: 7469 7a65 5f66 6e73 5b74 7970 655d 2e64  tize_fns[type].d
+000318f0: 6571 7561 6e74 697a 655f 726f 775f 713b  equantize_row_q;
+00031900: 0a0a 2020 2020 6173 7365 7274 2820 6473  ..    assert( ds
+00031910: 742d 3e6e 655b 305d 203d 3d20 6e63 293b  t->ne[0] == nc);
+00031920: 0a20 2020 2061 7373 6572 7428 2064 7374  .    assert( dst
+00031930: 2d3e 6e65 5b31 5d20 3d3d 206e 7229 3b0a  ->ne[1] == nr);.
+00031940: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
+00031950: 3e6e 625b 305d 203d 3d20 4747 4d4c 5f54  >nb[0] == GGML_T
+00031960: 5950 455f 5349 5a45 5b74 7970 655d 293b  YPE_SIZE[type]);
+00031970: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00031980: 203d 2030 3b20 6920 3c20 6e72 3b20 2b2b   = 0; i < nr; ++
+00031990: 6929 207b 0a20 2020 2020 2020 2063 6f6e  i) {.        con
+000319a0: 7374 2069 6e74 2072 203d 2028 2869 6e74  st int r = ((int
+000319b0: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
+000319c0: 7461 295b 695d 3b0a 0a20 2020 2020 2020  ta)[i];..       
+000319d0: 2064 6571 7561 6e74 697a 655f 726f 775f   dequantize_row_
+000319e0: 7128 0a20 2020 2020 2020 2020 2020 2020  q(.             
+000319f0: 2020 2028 636f 6e73 7420 766f 6964 202a     (const void *
+00031a00: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+00031a10: 2d3e 6461 7461 202b 2072 2a73 7263 302d  ->data + r*src0-
+00031a20: 3e6e 625b 315d 292c 0a20 2020 2020 2020  >nb[1]),.       
+00031a30: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00031a40: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00031a50: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
+00031a60: 2a64 7374 2d3e 6e62 5b31 5d29 2c20 6e63  *dst->nb[1]), nc
+00031a70: 293b 0a20 2020 207d 0a7d 0a0a 7374 6174  );.    }.}..stat
+00031a80: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00031a90: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
+00031aa0: 5f72 6f77 735f 6631 3628 0a20 2020 2020  _rows_f16(.     
+00031ab0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00031ac0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00031ad0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00031ae0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00031af0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00031b00: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00031b10: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00031b20: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00031b30: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00031b40: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00031b50: 202a 2064 7374 2920 7b0a 2020 2020 6173   * dst) {.    as
+00031b60: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
+00031b70: 203d 3d20 3029 3b0a 0a20 2020 2069 6620   == 0);..    if 
+00031b80: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00031b90: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00031ba0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00031bb0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00031bc0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00031bd0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00031be0: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
+00031bf0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
+00031c00: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
+00031c10: 203d 2067 676d 6c5f 6e65 6c65 6d65 6e74   = ggml_nelement
+00031c20: 7328 7372 6331 293b 0a0a 2020 2020 6173  s(src1);..    as
+00031c30: 7365 7274 2820 6473 742d 3e6e 655b 305d  sert( dst->ne[0]
+00031c40: 203d 3d20 6e63 293b 0a20 2020 2061 7373   == nc);.    ass
+00031c50: 6572 7428 2064 7374 2d3e 6e65 5b31 5d20  ert( dst->ne[1] 
+00031c60: 3d3d 206e 7229 3b0a 2020 2020 6173 7365  == nr);.    asse
+00031c70: 7274 2873 7263 302d 3e6e 625b 305d 203d  rt(src0->nb[0] =
+00031c80: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
+00031c90: 3136 5f74 2929 3b0a 0a20 2020 2066 6f72  16_t));..    for
+00031ca0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00031cb0: 206e 723b 202b 2b69 2920 7b0a 2020 2020   nr; ++i) {.    
+00031cc0: 2020 2020 636f 6e73 7420 696e 7420 7220      const int r 
+00031cd0: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+00031ce0: 7263 312d 3e64 6174 6129 5b69 5d3b 0a0a  rc1->data)[i];..
+00031cf0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00031d00: 206a 203d 2030 3b20 6a20 3c20 6e63 3b20   j = 0; j < nc; 
+00031d10: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
+00031d20: 2020 2067 676d 6c5f 6670 3136 5f74 2076     ggml_fp16_t v
+00031d30: 203d 2028 2867 676d 6c5f 6670 3136 5f74   = ((ggml_fp16_t
+00031d40: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
+00031d50: 6330 2d3e 6461 7461 202b 2072 2a73 7263  c0->data + r*src
+00031d60: 302d 3e6e 625b 315d 2929 5b6a 5d3b 0a20  0->nb[1]))[j];. 
+00031d70: 2020 2020 2020 2020 2020 2028 2866 6c6f             ((flo
+00031d80: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00031d90: 2064 7374 2d3e 6461 7461 202b 2069 2a64   dst->data + i*d
+00031da0: 7374 2d3e 6e62 5b31 5d29 295b 6a5d 203d  st->nb[1]))[j] =
+00031db0: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
+00031dc0: 3332 2876 293b 0a20 2020 2020 2020 207d  32(v);.        }
+00031dd0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00031de0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00031df0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+00031e00: 6f77 735f 6633 3228 0a20 2020 2020 2020  ows_f32(.       
+00031e10: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00031e20: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00031e30: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00031e40: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00031e50: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00031e60: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+00031e70: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00031e80: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+00031e90: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00031ea0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00031eb0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+00031ec0: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
+00031ed0: 3d20 3029 3b0a 0a20 2020 2069 6620 2870  = 0);..    if (p
+00031ee0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+00031ef0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+00031f00: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+00031f10: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+00031f20: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+00031f30: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+00031f40: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
+00031f50: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+00031f60: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
+00031f70: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
+00031f80: 7372 6331 293b 0a0a 2020 2020 6173 7365  src1);..    asse
+00031f90: 7274 2820 6473 742d 3e6e 655b 305d 203d  rt( dst->ne[0] =
+00031fa0: 3d20 6e63 293b 0a20 2020 2061 7373 6572  = nc);.    asser
+00031fb0: 7428 2064 7374 2d3e 6e65 5b31 5d20 3d3d  t( dst->ne[1] ==
+00031fc0: 206e 7229 3b0a 2020 2020 6173 7365 7274   nr);.    assert
+00031fd0: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
+00031fe0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+00031ff0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00032000: 3d20 303b 2069 203c 206e 723b 202b 2b69  = 0; i < nr; ++i
+00032010: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
+00032020: 7420 696e 7420 7220 3d20 2828 696e 7433  t int r = ((int3
+00032030: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+00032040: 6129 5b69 5d3b 0a0a 2020 2020 2020 2020  a)[i];..        
+00032050: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
+00032060: 286e 632c 0a20 2020 2020 2020 2020 2020  (nc,.           
+00032070: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00032080: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+00032090: 6174 6120 2b20 692a 6473 742d 3e6e 625b  ata + i*dst->nb[
+000320a0: 315d 292c 0a20 2020 2020 2020 2020 2020  1]),.           
+000320b0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+000320c0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+000320d0: 6174 6120 2b20 722a 7372 6330 2d3e 6e62  ata + r*src0->nb
+000320e0: 5b31 5d29 293b 0a20 2020 207d 0a7d 0a0a  [1]));.    }.}..
+000320f0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00032100: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00032110: 5f67 6574 5f72 6f77 7328 0a20 2020 2020  _get_rows(.     
+00032120: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00032130: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00032140: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00032150: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00032160: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00032170: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00032180: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00032190: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+000321a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000321b0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+000321c0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+000321d0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+000321e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000321f0: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
+00032200: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00032210: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
+00032220: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00032230: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00032240: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+00032250: 6f77 735f 7128 7061 7261 6d73 2c20 7372  ows_q(params, sr
+00032260: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
+00032270: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00032280: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00032290: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
+000322a0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000322b0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000322c0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000322d0: 6172 645f 6765 745f 726f 7773 5f66 3136  ard_get_rows_f16
+000322e0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+000322f0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00032300: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00032310: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00032320: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00032330: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00032340: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00032350: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
+00032360: 6574 5f72 6f77 735f 6633 3228 7061 7261  et_rows_f32(para
+00032370: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+00032380: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+00032390: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000323a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000323b0: 455f 4938 3a0a 2020 2020 2020 2020 6361  E_I8:.        ca
+000323c0: 7365 2047 474d 4c5f 5459 5045 5f49 3136  se GGML_TYPE_I16
+000323d0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+000323e0: 474d 4c5f 5459 5045 5f49 3332 3a0a 2020  GML_TYPE_I32:.  
+000323f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00032400: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
+00032410: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00032420: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00032430: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00032440: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00032450: 6b3b 0a20 2020 207d 0a0a 2020 2020 2f2f  k;.    }..    //
+00032460: 7374 6174 6963 2062 6f6f 6c20 6669 7273  static bool firs
+00032470: 7420 3d20 7472 7565 3b0a 2020 2020 2f2f  t = true;.    //
+00032480: 7072 696e 7466 2822 6e65 3020 3d20 2564  printf("ne0 = %d
+00032490: 2c20 6e65 3120 3d20 2564 2c20 6e65 3220  , ne1 = %d, ne2 
+000324a0: 3d20 2564 5c6e 222c 2064 7374 2d3e 6e65  = %d\n", dst->ne
+000324b0: 5b30 5d2c 2064 7374 2d3e 6e65 5b31 5d2c  [0], dst->ne[1],
+000324c0: 2064 7374 2d3e 6e65 5b32 5d29 3b0a 2020   dst->ne[2]);.  
+000324d0: 2020 2f2f 6966 2028 6669 7273 7429 207b    //if (first) {
+000324e0: 0a20 2020 202f 2f20 2020 2066 6972 7374  .    //    first
+000324f0: 203d 2066 616c 7365 3b0a 2020 2020 2f2f   = false;.    //
+00032500: 7d20 656c 7365 207b 0a20 2020 202f 2f20  } else {.    // 
+00032510: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
+00032520: 303b 206b 203c 2064 7374 2d3e 6e65 5b31  0; k < dst->ne[1
+00032530: 5d3b 202b 2b6b 2920 7b0a 2020 2020 2f2f  ]; ++k) {.    //
+00032540: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00032550: 206a 203d 2030 3b20 6a20 3c20 6473 742d   j = 0; j < dst-
+00032560: 3e6e 655b 305d 2f31 363b 202b 2b6a 2920  >ne[0]/16; ++j) 
+00032570: 7b0a 2020 2020 2f2f 2020 2020 2020 2020  {.    //        
+00032580: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00032590: 2030 3b20 6920 3c20 3136 3b20 2b2b 6929   0; i < 16; ++i)
+000325a0: 207b 0a20 2020 202f 2f20 2020 2020 2020   {.    //       
+000325b0: 2020 2020 2020 2020 2070 7269 6e74 6628           printf(
+000325c0: 2225 382e 3466 2022 2c20 2828 666c 6f61  "%8.4f ", ((floa
+000325d0: 7420 2a29 2064 7374 2d3e 6461 7461 295b  t *) dst->data)[
+000325e0: 6b2a 6473 742d 3e6e 655b 305d 202b 206a  k*dst->ne[0] + j
+000325f0: 2a31 3620 2b20 695d 293b 0a20 2020 202f  *16 + i]);.    /
+00032600: 2f20 2020 2020 2020 2020 2020 207d 0a20  /            }. 
+00032610: 2020 202f 2f20 2020 2020 2020 2020 2020     //           
+00032620: 2070 7269 6e74 6628 225c 6e22 293b 0a20   printf("\n");. 
+00032630: 2020 202f 2f20 2020 2020 2020 207d 0a20     //        }. 
+00032640: 2020 202f 2f20 2020 2020 2020 2070 7269     //        pri
+00032650: 6e74 6628 225c 6e22 293b 0a20 2020 202f  ntf("\n");.    /
+00032660: 2f20 2020 207d 0a20 2020 202f 2f20 2020  /    }.    //   
+00032670: 2070 7269 6e74 6628 225c 6e22 293b 0a20   printf("\n");. 
+00032680: 2020 202f 2f20 2020 2065 7869 7428 3029     //    exit(0)
+00032690: 3b0a 2020 2020 2f2f 7d0a 7d0a 0a2f 2f20  ;.    //}.}..// 
+000326a0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000326b0: 7761 7264 5f64 6961 675f 6d61 736b 5f69  ward_diag_mask_i
+000326c0: 6e66 0a0a 7374 6174 6963 2076 6f69 6420  nf..static void 
+000326d0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000326e0: 7761 7264 5f64 6961 675f 6d61 736b 5f69  ward_diag_mask_i
+000326f0: 6e66 5f66 3332 280a 2020 2020 2020 2020  nf_f32(.        
+00032700: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00032710: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00032720: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00032730: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00032740: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00032750: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+00032760: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00032770: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+00032780: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00032790: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+000327a0: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
+000327b0: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a20  ms->ith == 0);. 
+000327c0: 2020 2061 7373 6572 7428 7372 6331 2d3e     assert(src1->
+000327d0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+000327e0: 455f 4933 3229 3b0a 2020 2020 6173 7365  E_I32);.    asse
+000327f0: 7274 2867 676d 6c5f 6e65 6c65 6d65 6e74  rt(ggml_nelement
+00032800: 7328 7372 6331 2920 3d3d 2031 293b 0a0a  s(src1) == 1);..
+00032810: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00032820: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00032830: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00032840: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00032850: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00032860: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00032870: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00032880: 2069 6e74 206e 5f70 6173 7420 3d20 2828   int n_past = ((
+00032890: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
+000328a0: 3e64 6174 6129 5b30 5d3b 0a0a 2020 2020  >data)[0];..    
+000328b0: 2f2f 2054 4f44 4f3a 2068 616e 646c 6520  // TODO: handle 
+000328c0: 7472 616e 7370 6f73 6564 2f70 6572 6d75  transposed/permu
+000328d0: 7465 6420 6d61 7472 6963 6573 0a0a 2020  ted matrices..  
+000328e0: 2020 636f 6e73 7420 696e 7420 6e20 203d    const int n  =
+000328f0: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
+00032900: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
+00032910: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
+00032920: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00032930: 206e 7220 3d20 7372 6330 2d3e 6e65 5b31   nr = src0->ne[1
+00032940: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00032950: 206e 7a20 3d20 6e2f 6e72 3b0a 0a20 2020   nz = n/nr;..   
+00032960: 2061 7373 6572 7428 2064 7374 2d3e 6e62   assert( dst->nb
+00032970: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+00032980: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
+00032990: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
+000329a0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000329b0: 0a0a 2020 2020 666f 7220 2869 6e74 206b  ..    for (int k
+000329c0: 203d 2030 3b20 6b20 3c20 6e7a 3b20 6b2b   = 0; k < nz; k+
+000329d0: 2b29 207b 0a20 2020 2020 2020 2066 6f72  +) {.        for
+000329e0: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+000329f0: 206e 723b 206a 2b2b 2920 7b0a 2020 2020   nr; j++) {.    
+00032a00: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00032a10: 2069 203d 206e 5f70 6173 743b 2069 203c   i = n_past; i <
+00032a20: 206e 633b 2069 2b2b 2920 7b0a 2020 2020   nc; i++) {.    
+00032a30: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00032a40: 6920 3e20 6e5f 7061 7374 202b 206a 2920  i > n_past + j) 
+00032a50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00032a60: 2020 2020 2020 2a28 666c 6f61 7420 2a29        *(float *)
+00032a70: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
+00032a80: 6174 6120 2b20 6b2a 6473 742d 3e6e 625b  ata + k*dst->nb[
+00032a90: 325d 202b 206a 2a64 7374 2d3e 6e62 5b31  2] + j*dst->nb[1
+00032aa0: 5d20 2b20 692a 6473 742d 3e6e 625b 305d  ] + i*dst->nb[0]
+00032ab0: 2920 3d20 2d49 4e46 494e 4954 593b 0a20  ) = -INFINITY;. 
+00032ac0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00032ad0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00032ae0: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00032af0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00032b00: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00032b10: 7264 5f64 6961 675f 6d61 736b 5f69 6e66  rd_diag_mask_inf
+00032b20: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00032b30: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00032b40: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00032b50: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00032b60: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00032b70: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00032b80: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00032b90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00032ba0: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+00032bb0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00032bc0: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+00032bd0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+00032be0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00032bf0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+00032c00: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00032c10: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00032c20: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00032c30: 6172 645f 6469 6167 5f6d 6173 6b5f 696e  ard_diag_mask_in
+00032c40: 665f 6633 3228 7061 7261 6d73 2c20 7372  f_f32(params, sr
+00032c50: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
+00032c60: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00032c70: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00032c80: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
+00032c90: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00032ca0: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
+00032cb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00032cc0: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
+00032cd0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00032ce0: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
+00032cf0: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
+00032d00: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00032d10: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
+00032d20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00032d30: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
+00032d40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00032d50: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00032d60: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00032d70: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00032d80: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00032d90: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00032da0: 6172 645f 736f 6674 5f6d 6178 0a0a 7374  ard_soft_max..st
+00032db0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00032dc0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00032dd0: 6f66 745f 6d61 785f 6633 3228 0a20 2020  oft_max_f32(.   
+00032de0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00032df0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00032e00: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00032e10: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00032e20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00032e30: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00032e40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00032e50: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00032e60: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00032e70: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+00032e80: 7372 6330 2929 3b0a 2020 2020 4747 4d4c  src0));.    GGML
+00032e90: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+00032ea0: 636f 6e74 6967 756f 7573 2864 7374 2929  contiguous(dst))
+00032eb0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00032ec0: 5428 6767 6d6c 5f61 7265 5f73 616d 655f  T(ggml_are_same_
+00032ed0: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
+00032ee0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+00032ef0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00032f00: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+00032f10: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00032f20: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+00032f30: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+00032f40: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
+00032f50: 2f20 544f 444f 3a20 6861 6e64 6c65 2074  / TODO: handle t
+00032f60: 7261 6e73 706f 7365 642f 7065 726d 7574  ransposed/permut
+00032f70: 6564 206d 6174 7269 6365 730a 0a20 2020  ed matrices..   
+00032f80: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
+00032f90: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
+00032fa0: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
+00032fb0: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
+00032fc0: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
+00032fd0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
+00032fe0: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
+00032ff0: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
+00033000: 6330 293b 0a0a 2020 2020 2f2f 2072 6f77  c0);..    // row
+00033010: 7320 7065 7220 7468 7265 6164 0a20 2020  s per thread.   
+00033020: 2063 6f6e 7374 2069 6e74 2064 7220 3d20   const int dr = 
+00033030: 286e 7220 2b20 6e74 6820 2d20 3129 2f6e  (nr + nth - 1)/n
+00033040: 7468 3b0a 0a20 2020 202f 2f20 726f 7720  th;..    // row 
+00033050: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
+00033060: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+00033070: 696e 7420 6972 3020 3d20 6472 2a69 7468  int ir0 = dr*ith
+00033080: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00033090: 6972 3120 3d20 4d49 4e28 6972 3020 2b20  ir1 = MIN(ir0 + 
+000330a0: 6472 2c20 6e72 293b 0a0a 2020 2020 666f  dr, nr);..    fo
+000330b0: 7220 2869 6e74 2069 3120 3d20 6972 303b  r (int i1 = ir0;
+000330c0: 2069 3120 3c20 6972 313b 2069 312b 2b29   i1 < ir1; i1++)
+000330d0: 207b 0a20 2020 2020 2020 2066 6c6f 6174   {.        float
+000330e0: 202a 7020 3d20 2866 6c6f 6174 202a 2928   *p = (float *)(
+000330f0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
+00033100: 7461 202b 2069 312a 6473 742d 3e6e 625b  ta + i1*dst->nb[
+00033110: 315d 293b 0a0a 2369 666e 6465 6620 4e44  1]);..#ifndef ND
+00033120: 4542 5547 0a20 2020 2020 2020 2066 6f72  EBUG.        for
+00033130: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00033140: 206e 633b 202b 2b69 2920 7b0a 2020 2020   nc; ++i) {.    
+00033150: 2020 2020 2020 2020 2f2f 7072 696e 7466          //printf
+00033160: 2822 705b 2564 5d20 3d20 2566 5c6e 222c  ("p[%d] = %f\n",
+00033170: 2069 2c20 705b 695d 293b 0a20 2020 2020   i, p[i]);.     
+00033180: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
+00033190: 736e 616e 2870 5b69 5d29 293b 0a20 2020  snan(p[i]));.   
+000331a0: 2020 2020 207d 0a23 656e 6469 660a 0a20       }.#endif.. 
+000331b0: 2020 2020 2020 2066 6c6f 6174 206d 6178         float max
+000331c0: 203d 202d 494e 4649 4e49 5459 3b0a 2020   = -INFINITY;.  
+000331d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
+000331e0: 6178 5f66 3332 286e 632c 2026 6d61 782c  ax_f32(nc, &max,
+000331f0: 2070 293b 0a0a 2020 2020 2020 2020 6767   p);..        gg
+00033200: 6d6c 5f66 6c6f 6174 2073 756d 203d 2030  ml_float sum = 0
+00033210: 2e30 3b0a 0a20 2020 2020 2020 2075 696e  .0;..        uin
+00033220: 7431 365f 7420 7363 7674 3b0a 2020 2020  t16_t scvt;.    
+00033230: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00033240: 2030 3b20 6920 3c20 6e63 3b20 692b 2b29   0; i < nc; i++)
+00033250: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
+00033260: 6620 2870 5b69 5d20 3d3d 202d 494e 4649  f (p[i] == -INFI
+00033270: 4e49 5459 2920 7b0a 2020 2020 2020 2020  NITY) {.        
+00033280: 2020 2020 2020 2020 705b 695d 203d 2030          p[i] = 0
+00033290: 2e30 663b 0a20 2020 2020 2020 2020 2020  .0f;.           
+000332a0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+000332b0: 2020 2020 2020 2020 2020 2f2f 636f 6e73            //cons
+000332c0: 7420 666c 6f61 7420 7661 6c20 3d20 2870  t float val = (p
+000332d0: 5b69 5d20 3d3d 202d 494e 4649 4e49 5459  [i] == -INFINITY
+000332e0: 2920 3f20 302e 3020 3a20 6578 7028 705b  ) ? 0.0 : exp(p[
+000332f0: 695d 202d 206d 6178 293b 0a20 2020 2020  i] - max);.     
+00033300: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00033310: 6670 3136 5f74 2073 203d 2047 474d 4c5f  fp16_t s = GGML_
+00033320: 4650 3332 5f54 4f5f 4650 3136 2870 5b69  FP32_TO_FP16(p[i
+00033330: 5d20 2d20 6d61 7829 3b0a 2020 2020 2020  ] - max);.      
+00033340: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
+00033350: 2826 7363 7674 2c20 2673 2c20 7369 7a65  (&scvt, &s, size
+00033360: 6f66 2873 6376 7429 293b 0a20 2020 2020  of(scvt));.     
+00033370: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00033380: 2066 6c6f 6174 2076 616c 203d 2047 474d   float val = GGM
+00033390: 4c5f 4650 3136 5f54 4f5f 4650 3332 2874  L_FP16_TO_FP32(t
+000333a0: 6162 6c65 5f65 7870 5f66 3136 5b73 6376  able_exp_f16[scv
+000333b0: 745d 293b 0a20 2020 2020 2020 2020 2020  t]);.           
+000333c0: 2020 2020 2073 756d 202b 3d20 2867 676d       sum += (ggm
+000333d0: 6c5f 666c 6f61 7429 7661 6c3b 0a20 2020  l_float)val;.   
+000333e0: 2020 2020 2020 2020 2020 2020 2070 5b69               p[i
+000333f0: 5d20 3d20 7661 6c3b 0a20 2020 2020 2020  ] = val;.       
+00033400: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00033410: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
+00033420: 2873 756d 203e 2030 2e30 293b 0a0a 2020  (sum > 0.0);..  
+00033430: 2020 2020 2020 7375 6d20 3d20 312e 302f        sum = 1.0/
+00033440: 7375 6d3b 0a20 2020 2020 2020 2067 676d  sum;.        ggm
+00033450: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+00033460: 6e63 2c20 702c 2073 756d 293b 0a0a 2369  nc, p, sum);..#i
+00033470: 666e 6465 6620 4e44 4542 5547 0a20 2020  fndef NDEBUG.   
+00033480: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00033490: 3d20 303b 2069 203c 206e 633b 202b 2b69  = 0; i < nc; ++i
+000334a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000334b0: 6173 7365 7274 2821 6973 6e61 6e28 705b  assert(!isnan(p[
+000334c0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+000334d0: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
+000334e0: 705b 695d 2929 3b0a 2020 2020 2020 2020  p[i]));.        
+000334f0: 7d0a 2365 6e64 6966 0a20 2020 207d 0a7d  }.#endif.    }.}
+00033500: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00033510: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00033520: 7264 5f73 6f66 745f 6d61 7828 0a20 2020  rd_soft_max(.   
+00033530: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00033540: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00033550: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00033560: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00033570: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00033580: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00033590: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000335a0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+000335b0: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
+000335c0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
+000335d0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+000335e0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+000335f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033600: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00033610: 7277 6172 645f 736f 6674 5f6d 6178 5f66  rward_soft_max_f
+00033620: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
+00033630: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00033640: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00033650: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00033660: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
+00033670: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00033680: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
+00033690: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
+000336a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000336b0: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
+000336c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000336d0: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
+000336e0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+000336f0: 4631 363a 0a20 2020 2020 2020 2063 6173  F16:.        cas
+00033700: 6520 4747 4d4c 5f54 5950 455f 434f 554e  e GGML_TYPE_COUN
+00033710: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+00033720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033730: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+00033740: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+00033750: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+00033760: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00033770: 7465 5f66 6f72 7761 7264 5f72 6f70 650a  te_forward_rope.
+00033780: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00033790: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000337a0: 645f 726f 7065 5f66 3332 280a 2020 2020  d_rope_f32(.    
+000337b0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000337c0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+000337d0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+000337e0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000337f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00033800: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00033810: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00033820: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+00033830: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00033840: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00033850: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
+00033860: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
+00033870: 293b 0a20 2020 2061 7373 6572 7428 7372  );.    assert(sr
+00033880: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
+00033890: 5f54 5950 455f 4933 3229 3b0a 2020 2020  _TYPE_I32);.    
+000338a0: 6173 7365 7274 2867 676d 6c5f 6e65 6c65  assert(ggml_nele
+000338b0: 6d65 6e74 7328 7372 6331 2920 3d3d 2033  ments(src1) == 3
+000338c0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+000338d0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+000338e0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+000338f0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00033900: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+00033910: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+00033920: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
+00033930: 6f6e 7374 2069 6e74 206e 5f70 6173 7420  onst int n_past 
+00033940: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+00033950: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
+00033960: 2020 2063 6f6e 7374 2069 6e74 206e 5f64     const int n_d
+00033970: 696d 7320 3d20 2828 696e 7433 325f 7420  ims = ((int32_t 
+00033980: 2a29 2073 7263 312d 3e64 6174 6129 5b31  *) src1->data)[1
+00033990: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000339a0: 206d 6f64 6520 2020 3d20 2828 696e 7433   mode   = ((int3
+000339b0: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+000339c0: 6129 5b32 5d3b 0a0a 2020 2020 2f2f 636f  a)[2];..    //co
+000339d0: 6e73 7420 696e 7420 6e65 3020 3d20 7372  nst int ne0 = sr
+000339e0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
+000339f0: 6f6e 7374 2069 6e74 206e 6531 203d 2073  onst int ne1 = s
+00033a00: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
+00033a10: 636f 6e73 7420 696e 7420 6e65 3220 3d20  const int ne2 = 
+00033a20: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
+00033a30: 2063 6f6e 7374 2069 6e74 206e 6533 203d   const int ne3 =
+00033a40: 2073 7263 302d 3e6e 655b 335d 3b0a 0a20   src0->ne[3];.. 
+00033a50: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
+00033a60: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
+00033a70: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00033a80: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
+00033a90: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00033aa0: 6232 203d 2073 7263 302d 3e6e 625b 325d  b2 = src0->nb[2]
+00033ab0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00033ac0: 6e62 3320 3d20 7372 6330 2d3e 6e62 5b33  nb3 = src0->nb[3
+00033ad0: 5d3b 0a0a 2020 2020 2f2f 7072 696e 7466  ];..    //printf
+00033ae0: 2822 6e65 303a 2025 642c 206e 6531 3a20  ("ne0: %d, ne1: 
+00033af0: 2564 2c20 6e65 323a 2025 642c 206e 6533  %d, ne2: %d, ne3
+00033b00: 3a20 2564 5c6e 222c 206e 6530 2c20 6e65  : %d\n", ne0, ne
+00033b10: 312c 206e 6532 2c20 6e65 3329 3b0a 2020  1, ne2, ne3);.  
+00033b20: 2020 2f2f 7072 696e 7466 2822 6e5f 7061    //printf("n_pa
+00033b30: 7374 203d 2025 642c 206e 6532 203d 2025  st = %d, ne2 = %
+00033b40: 645c 6e22 2c20 6e5f 7061 7374 2c20 6e65  d\n", n_past, ne
+00033b50: 3229 3b0a 0a20 2020 2061 7373 6572 7428  2);..    assert(
+00033b60: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
+00033b70: 6f61 7429 293b 0a0a 2020 2020 2f2f 2054  oat));..    // T
+00033b80: 4f44 4f3a 206f 7074 696d 697a 650a 2020  ODO: optimize.  
+00033b90: 2020 666f 7220 2869 6e74 2069 3320 3d20    for (int i3 = 
+00033ba0: 303b 2069 3320 3c20 6e65 333b 2069 332b  0; i3 < ne3; i3+
+00033bb0: 2b29 207b 0a20 2020 2020 2020 2066 6f72  +) {.        for
+00033bc0: 2028 696e 7420 6932 203d 2028 6d6f 6465   (int i2 = (mode
+00033bd0: 203d 3d20 3020 3f20 3020 3a20 6e5f 7061   == 0 ? 0 : n_pa
+00033be0: 7374 293b 2069 3220 3c20 6e65 323b 2069  st); i2 < ne2; i
+00033bf0: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+00033c00: 2020 2063 6f6e 7374 2069 6e74 2070 203d     const int p =
+00033c10: 2028 6d6f 6465 203d 3d20 3020 3f20 6e5f   (mode == 0 ? n_
+00033c20: 7061 7374 202b 2069 3220 3a20 6932 293b  past + i2 : i2);
+00033c30: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00033c40: 2028 696e 7420 6931 203d 2030 3b20 6931   (int i1 = 0; i1
+00033c50: 203c 206e 6531 3b20 6931 2b2b 2920 7b0a   < ne1; i1++) {.
+00033c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033c70: 666f 7220 2869 6e74 2069 3020 3d20 303b  for (int i0 = 0;
+00033c80: 2069 3020 3c20 6e5f 6469 6d73 3b20 6930   i0 < n_dims; i0
+00033c90: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
+00033ca0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00033cb0: 7374 2066 6c6f 6174 2074 6865 7461 203d  st float theta =
+00033cc0: 2070 6f77 6628 3130 3030 302e 302c 2028   powf(10000.0, (
+00033cd0: 2866 6c6f 6174 292d 6930 292f 6e5f 6469  (float)-i0)/n_di
+00033ce0: 6d73 293b 0a0a 2020 2020 2020 2020 2020  ms);..          
+00033cf0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00033d00: 666c 6f61 7420 636f 735f 7468 6574 6120  float cos_theta 
+00033d10: 3d20 636f 7366 2870 2a74 6865 7461 293b  = cosf(p*theta);
+00033d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033d30: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00033d40: 2073 696e 5f74 6865 7461 203d 2073 696e   sin_theta = sin
+00033d50: 6628 702a 7468 6574 6129 3b0a 0a20 2020  f(p*theta);..   
+00033d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033d70: 2063 6f6e 7374 2066 6c6f 6174 202a 2063   const float * c
+00033d80: 6f6e 7374 2073 7263 203d 2028 666c 6f61  onst src = (floa
+00033d90: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
+00033da0: 6330 2d3e 6461 7461 202b 2069 332a 6e62  c0->data + i3*nb
+00033db0: 3320 2b20 6932 2a6e 6232 202b 2069 312a  3 + i2*nb2 + i1*
+00033dc0: 6e62 3120 2b20 6930 2a6e 6230 293b 0a20  nb1 + i0*nb0);. 
+00033dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033de0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+00033df0: 2064 7374 5f64 6174 6120 203d 2028 666c   dst_data  = (fl
+00033e00: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+00033e10: 2064 7374 2d3e 6461 7461 202b 2069 332a   dst->data + i3*
+00033e20: 6e62 3320 2b20 6932 2a6e 6232 202b 2069  nb3 + i2*nb2 + i
+00033e30: 312a 6e62 3120 2b20 6930 2a6e 6230 293b  1*nb1 + i0*nb0);
+00033e40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00033e50: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+00033e60: 7420 7830 203d 2073 7263 5b30 5d3b 0a20  t x0 = src[0];. 
+00033e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e80: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
+00033e90: 3120 3d20 7372 635b 315d 3b0a 0a20 2020  1 = src[1];..   
+00033ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033eb0: 2064 7374 5f64 6174 615b 305d 203d 2078   dst_data[0] = x
+00033ec0: 302a 636f 735f 7468 6574 6120 2d20 7831  0*cos_theta - x1
+00033ed0: 2a73 696e 5f74 6865 7461 3b0a 2020 2020  *sin_theta;.    
+00033ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ef0: 6473 745f 6461 7461 5b31 5d20 3d20 7830  dst_data[1] = x0
+00033f00: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
+00033f10: 636f 735f 7468 6574 613b 0a20 2020 2020  cos_theta;.     
+00033f20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00033f30: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00033f40: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+00033f50: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00033f60: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+00033f70: 6f70 655f 6631 3628 0a20 2020 2020 2020  ope_f16(.       
+00033f80: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00033f90: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00033fa0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00033fb0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00033fc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00033fd0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+00033fe0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00033ff0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+00034000: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00034010: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00034020: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
+00034030: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
+00034040: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
+00034050: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00034060: 5045 5f49 3332 293b 0a20 2020 2061 7373  PE_I32);.    ass
+00034070: 6572 7428 6767 6d6c 5f6e 656c 656d 656e  ert(ggml_nelemen
+00034080: 7473 2873 7263 3129 203d 3d20 3329 3b0a  ts(src1) == 3);.
+00034090: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+000340a0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+000340b0: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+000340c0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000340d0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+000340e0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+000340f0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+00034100: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
+00034110: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+00034120: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+00034130: 636f 6e73 7420 696e 7420 6e5f 6469 6d73  const int n_dims
+00034140: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+00034150: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
+00034160: 2020 2020 636f 6e73 7420 696e 7420 6d6f      const int mo
+00034170: 6465 2020 203d 2028 2869 6e74 3332 5f74  de   = ((int32_t
+00034180: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+00034190: 325d 3b0a 0a20 2020 202f 2f63 6f6e 7374  2];..    //const
+000341a0: 2069 6e74 206e 6530 203d 2073 7263 302d   int ne0 = src0-
+000341b0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+000341c0: 7420 696e 7420 6e65 3120 3d20 7372 6330  t int ne1 = src0
+000341d0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+000341e0: 7374 2069 6e74 206e 6532 203d 2073 7263  st int ne2 = src
+000341f0: 302d 3e6e 655b 325d 3b0a 2020 2020 636f  0->ne[2];.    co
+00034200: 6e73 7420 696e 7420 6e65 3320 3d20 7372  nst int ne3 = sr
+00034210: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
+00034220: 636f 6e73 7420 696e 7420 6e62 3020 3d20  const int nb0 = 
+00034230: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
+00034240: 2063 6f6e 7374 2069 6e74 206e 6231 203d   const int nb1 =
+00034250: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
+00034260: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
+00034270: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
+00034280: 2020 2063 6f6e 7374 2069 6e74 206e 6233     const int nb3
+00034290: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
+000342a0: 0a20 2020 202f 2f70 7269 6e74 6628 226e  .    //printf("n
+000342b0: 6530 3a20 2564 2c20 6e65 313a 2025 642c  e0: %d, ne1: %d,
+000342c0: 206e 6532 3a20 2564 2c20 6e65 333a 2025   ne2: %d, ne3: %
+000342d0: 645c 6e22 2c20 6e65 302c 206e 6531 2c20  d\n", ne0, ne1, 
+000342e0: 6e65 322c 206e 6533 293b 0a20 2020 202f  ne2, ne3);.    /
+000342f0: 2f70 7269 6e74 6628 226e 5f70 6173 7420  /printf("n_past 
+00034300: 3d20 2564 2c20 6e65 3220 3d20 2564 5c6e  = %d, ne2 = %d\n
+00034310: 222c 206e 5f70 6173 742c 206e 6532 293b  ", n_past, ne2);
+00034320: 0a0a 2020 2020 6173 7365 7274 286e 6230  ..    assert(nb0
+00034330: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+00034340: 6670 3136 5f74 2929 3b0a 0a20 2020 2066  fp16_t));..    f
+00034350: 6f72 2028 696e 7420 6933 203d 2030 3b20  or (int i3 = 0; 
+00034360: 6933 203c 206e 6533 3b20 6933 2b2b 2920  i3 < ne3; i3++) 
+00034370: 7b0a 2020 2020 2020 2020 666f 7220 2869  {.        for (i
+00034380: 6e74 2069 3220 3d20 286d 6f64 6520 3d3d  nt i2 = (mode ==
+00034390: 2030 203f 2030 203a 206e 5f70 6173 7429   0 ? 0 : n_past)
+000343a0: 3b20 6932 203c 206e 6532 3b20 6932 2b2b  ; i2 < ne2; i2++
+000343b0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000343c0: 636f 6e73 7420 696e 7420 7020 3d20 286d  const int p = (m
+000343d0: 6f64 6520 3d3d 2030 203f 206e 5f70 6173  ode == 0 ? n_pas
+000343e0: 7420 2b20 6932 203a 2069 3229 3b0a 2020  t + i2 : i2);.  
+000343f0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00034400: 6e74 2069 3120 3d20 303b 2069 3120 3c20  nt i1 = 0; i1 < 
+00034410: 6e65 313b 2069 312b 2b29 207b 0a20 2020  ne1; i1++) {.   
+00034420: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00034430: 2028 696e 7420 6930 203d 2030 3b20 6930   (int i0 = 0; i0
+00034440: 203c 206e 5f64 696d 733b 2069 3020 2b3d   < n_dims; i0 +=
+00034450: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
+00034460: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00034470: 666c 6f61 7420 7468 6574 6120 3d20 706f  float theta = po
+00034480: 7766 2831 3030 3030 2e30 2c20 2828 666c  wf(10000.0, ((fl
+00034490: 6f61 7429 2d69 3029 2f6e 5f64 696d 7329  oat)-i0)/n_dims)
+000344a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000344b0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+000344c0: 6174 2063 6f73 5f74 6865 7461 203d 2063  at cos_theta = c
+000344d0: 6f73 6628 702a 7468 6574 6129 3b0a 2020  osf(p*theta);.  
+000344e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000344f0: 2020 636f 6e73 7420 666c 6f61 7420 7369    const float si
+00034500: 6e5f 7468 6574 6120 3d20 7369 6e66 2870  n_theta = sinf(p
+00034510: 2a74 6865 7461 293b 0a0a 2020 2020 2020  *theta);..      
+00034520: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00034530: 6e73 7420 6767 6d6c 5f66 7031 365f 7420  nst ggml_fp16_t 
+00034540: 2a20 636f 6e73 7420 7372 6320 3d20 2867  * const src = (g
+00034550: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
+00034560: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00034570: 6120 2b20 6933 2a6e 6233 202b 2069 322a  a + i3*nb3 + i2*
+00034580: 6e62 3220 2b20 6931 2a6e 6231 202b 2069  nb2 + i1*nb1 + i
+00034590: 302a 6e62 3029 3b0a 2020 2020 2020 2020  0*nb0);.        
+000345a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000345b0: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+000345c0: 6473 745f 6461 7461 2020 3d20 2867 676d  dst_data  = (ggm
+000345d0: 6c5f 6670 3136 5f74 202a 2928 2863 6861  l_fp16_t *)((cha
+000345e0: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+000345f0: 2b20 6933 2a6e 6233 202b 2069 322a 6e62  + i3*nb3 + i2*nb
+00034600: 3220 2b20 6931 2a6e 6231 202b 2069 302a  2 + i1*nb1 + i0*
+00034610: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
+00034620: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00034630: 2066 6c6f 6174 2078 3020 3d20 6767 6d6c   float x0 = ggml
+00034640: 5f66 7031 365f 746f 5f66 7033 3228 7372  _fp16_to_fp32(sr
+00034650: 635b 305d 293b 0a20 2020 2020 2020 2020  c[0]);.         
+00034660: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00034670: 2066 6c6f 6174 2078 3120 3d20 6767 6d6c   float x1 = ggml
+00034680: 5f66 7031 365f 746f 5f66 7033 3228 7372  _fp16_to_fp32(sr
+00034690: 635b 315d 293b 0a0a 2020 2020 2020 2020  c[1]);..        
+000346a0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
+000346b0: 6461 7461 5b30 5d20 3d20 6767 6d6c 5f66  data[0] = ggml_f
+000346c0: 7033 325f 746f 5f66 7031 3628 7830 2a63  p32_to_fp16(x0*c
+000346d0: 6f73 5f74 6865 7461 202d 2078 312a 7369  os_theta - x1*si
+000346e0: 6e5f 7468 6574 6129 3b0a 2020 2020 2020  n_theta);.      
+000346f0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00034700: 745f 6461 7461 5b31 5d20 3d20 6767 6d6c  t_data[1] = ggml
+00034710: 5f66 7033 325f 746f 5f66 7031 3628 7830  _fp32_to_fp16(x0
+00034720: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
+00034730: 636f 735f 7468 6574 6129 3b0a 2020 2020  cos_theta);.    
+00034740: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00034750: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00034760: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00034770: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00034780: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00034790: 726f 7065 280a 2020 2020 2020 2020 636f  rope(.        co
+000347a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000347b0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+000347c0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+000347d0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+000347e0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+000347f0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00034800: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00034810: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+00034820: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00034830: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00034840: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+00034850: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00034860: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00034870: 4631 363a 0a20 2020 2020 2020 2020 2020  F16:.           
+00034880: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00034890: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+000348a0: 666f 7277 6172 645f 726f 7065 5f66 3136  forward_rope_f16
+000348b0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+000348c0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+000348d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000348e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000348f0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00034900: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00034910: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00034920: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+00034930: 6f70 655f 6633 3228 7061 7261 6d73 2c20  ope_f32(params, 
+00034940: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00034950: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00034960: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00034970: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+00034980: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+00034990: 2047 474d 4c5f 5459 5045 5f51 345f 313a   GGML_TYPE_Q4_1:
+000349a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000349b0: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
+000349c0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+000349d0: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
+000349e0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+000349f0: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
+00034a00: 2047 474d 4c5f 5459 5045 5f43 4f55 4e54   GGML_TYPE_COUNT
+00034a10: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00034a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034a30: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00034a40: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00034a50: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+00034a60: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+00034a70: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
+00034a80: 645f 3173 0a0a 7374 6174 6963 2076 6f69  d_1s..static voi
+00034a90: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00034aa0: 6f72 7761 7264 5f63 6f6e 765f 3164 5f31  orward_conv_1d_1
+00034ab0: 735f 6631 365f 6633 3228 0a20 2020 2020  s_f16_f32(.     
+00034ac0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00034ad0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00034ae0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00034af0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00034b00: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00034b10: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00034b20: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00034b30: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00034b40: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00034b50: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00034b60: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
+00034b70: 4d4c 5f41 5353 4552 5428 7372 6330 2d3e  ML_ASSERT(src0->
+00034b80: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00034b90: 455f 4631 3629 3b0a 2020 2020 4747 4d4c  E_F16);.    GGML
+00034ba0: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
+00034bb0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00034bc0: 4633 3229 3b0a 2020 2020 4747 4d4c 5f41  F32);.    GGML_A
+00034bd0: 5353 4552 5428 2064 7374 2d3e 7479 7065  SSERT( dst->type
+00034be0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+00034bf0: 3229 3b0a 0a20 2020 2069 6e74 3634 5f74  2);..    int64_t
+00034c00: 2074 3020 3d20 6767 6d6c 5f70 6572 665f   t0 = ggml_perf_
+00034c10: 7469 6d65 5f75 7328 293b 0a20 2020 2055  time_us();.    U
+00034c20: 4e55 5345 4428 7430 293b 0a0a 2020 2020  NUSED(t0);..    
+00034c30: 636f 6e73 7420 696e 7420 6e65 3030 203d  const int ne00 =
+00034c40: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+00034c50: 2020 636f 6e73 7420 696e 7420 6e65 3031    const int ne01
+00034c60: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
+00034c70: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+00034c80: 3032 203d 2073 7263 302d 3e6e 655b 325d  02 = src0->ne[2]
+00034c90: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00034ca0: 7420 6e65 3033 203d 2073 7263 302d 3e6e  t ne03 = src0->n
+00034cb0: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+00034cc0: 2069 6e74 206e 6531 3020 3d20 7372 6331   int ne10 = src1
+00034cd0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00034ce0: 7374 2069 6e74 206e 6531 3120 3d20 7372  st int ne11 = sr
+00034cf0: 6331 2d3e 6e65 5b31 5d3b 0a20 2020 202f  c1->ne[1];.    /
+00034d00: 2f63 6f6e 7374 2069 6e74 206e 6531 3220  /const int ne12 
+00034d10: 3d20 7372 6331 2d3e 6e65 5b32 5d3b 0a20  = src1->ne[2];. 
+00034d20: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00034d30: 6531 3320 3d20 7372 6331 2d3e 6e65 5b33  e13 = src1->ne[3
+00034d40: 5d3b 0a0a 2020 2020 2f2f 636f 6e73 7420  ];..    //const 
+00034d50: 696e 7420 6e65 3020 203d 2064 7374 2d3e  int ne0  = dst->
+00034d60: 6e65 5b30 5d3b 0a20 2020 202f 2f63 6f6e  ne[0];.    //con
+00034d70: 7374 2069 6e74 206e 6531 2020 3d20 6473  st int ne1  = ds
+00034d80: 742d 3e6e 655b 315d 3b0a 2020 2020 2f2f  t->ne[1];.    //
+00034d90: 636f 6e73 7420 696e 7420 6e65 3220 203d  const int ne2  =
+00034da0: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
+00034db0: 202f 2f63 6f6e 7374 2069 6e74 206e 6533   //const int ne3
+00034dc0: 2020 3d20 6473 742d 3e6e 655b 335d 3b0a    = dst->ne[3];.
+00034dd0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00034de0: 6e65 2020 203d 206e 6530 2a6e 6531 2a6e  ne   = ne0*ne1*n
+00034df0: 6532 2a6e 6533 3b0a 0a20 2020 2063 6f6e  e2*ne3;..    con
+00034e00: 7374 2069 6e74 206e 6230 3020 3d20 7372  st int nb00 = sr
+00034e10: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
+00034e20: 6f6e 7374 2069 6e74 206e 6230 3120 3d20  onst int nb01 = 
+00034e30: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
+00034e40: 2063 6f6e 7374 2069 6e74 206e 6230 3220   const int nb02 
+00034e50: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
+00034e60: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00034e70: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
+00034e80: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00034e90: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
+00034ea0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00034eb0: 696e 7420 6e62 3131 203d 2073 7263 312d  int nb11 = src1-
+00034ec0: 3e6e 625b 315d 3b0a 2020 2020 2f2f 636f  >nb[1];.    //co
+00034ed0: 6e73 7420 696e 7420 6e62 3132 203d 2073  nst int nb12 = s
+00034ee0: 7263 312d 3e6e 625b 325d 3b0a 2020 2020  rc1->nb[2];.    
+00034ef0: 2f2f 636f 6e73 7420 696e 7420 6e62 3133  //const int nb13
+00034f00: 203d 2073 7263 312d 3e6e 625b 335d 3b0a   = src1->nb[3];.
+00034f10: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00034f20: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
+00034f30: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00034f40: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
+00034f50: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
+00034f60: 2069 6e74 206e 6232 2020 3d20 6473 742d   int nb2  = dst-
+00034f70: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
+00034f80: 6e73 7420 696e 7420 6e62 3320 203d 2064  nst int nb3  = d
+00034f90: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
+00034fa0: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
+00034fb0: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
+00034fc0: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
+00034fd0: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
+00034fe0: 2020 2063 6f6e 7374 2069 6e74 206e 6b20     const int nk 
+00034ff0: 3d20 6e65 3030 3b0a 2020 2020 636f 6e73  = ne00;.    cons
+00035000: 7420 696e 7420 6e68 203d 206e 6b2f 323b  t int nh = nk/2;
+00035010: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00035020: 6577 3020 3d20 6767 6d6c 5f75 7033 3228  ew0 = ggml_up32(
+00035030: 6e65 3031 293b 0a0a 2020 2020 4747 4d4c  ne01);..    GGML
+00035040: 5f41 5353 4552 5428 6e65 3030 2025 2032  _ASSERT(ne00 % 2
+00035050: 203d 3d20 3129 3b20 2f2f 2054 4f44 4f3a   == 1); // TODO:
+00035060: 2073 7570 706f 7274 2065 7665 6e20 6b65   support even ke
+00035070: 726e 656c 2073 697a 6573 0a20 2020 2047  rnel sizes.    G
+00035080: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+00035090: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+000350a0: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
+000350b0: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
+000350c0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000350d0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+000350e0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+000350f0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
+00035100: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
+00035110: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
+00035120: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
+00035130: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
+00035140: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
+00035150: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
+00035160: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
+00035170: 2f2f 2070 7265 7061 7265 206b 6572 6e65  // prepare kerne
+00035180: 6c20 6461 7461 2028 7372 6330 290a 2020  l data (src0).  
+00035190: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000351a0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+000351b0: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
+000351c0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+000351d0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+000351e0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
+000351f0: 666f 7220 2869 6e74 2069 3032 203d 2030  for (int i02 = 0
+00035200: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
+00035210: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+00035220: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00035230: 6930 3120 3d20 303b 2069 3031 203c 206e  i01 = 0; i01 < n
+00035240: 6530 313b 2069 3031 2b2b 2920 7b0a 2020  e01; i01++) {.  
+00035250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035260: 2020 636f 6e73 7420 6767 6d6c 5f66 7031    const ggml_fp1
+00035270: 365f 7420 2a20 636f 6e73 7420 7372 6320  6_t * const src 
+00035280: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+00035290: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
+000352a0: 3e64 6174 6120 2b20 6930 322a 6e62 3032  >data + i02*nb02
+000352b0: 202b 2069 3031 2a6e 6230 3129 3b0a 2020   + i01*nb01);.  
+000352c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000352d0: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+000352e0: 6473 745f 6461 7461 203d 2077 6461 7461  dst_data = wdata
+000352f0: 202b 2069 3032 2a65 7730 2a6e 6530 303b   + i02*ew0*ne00;
+00035300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035310: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00035320: 3020 3d20 303b 2069 3030 203c 206e 6530  0 = 0; i00 < ne0
+00035330: 303b 2069 3030 2b2b 2920 7b0a 2020 2020  0; i00++) {.    
+00035340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035350: 2020 2020 6473 745f 6461 7461 5b69 3030      dst_data[i00
+00035360: 2a65 7730 202b 2069 3031 5d20 3d20 7372  *ew0 + i01] = sr
+00035370: 635b 6930 305d 3b0a 2020 2020 2020 2020  c[i00];.        
+00035380: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00035390: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000353a0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+000353b0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000353c0: 202f 2f20 7072 6570 6172 6520 736f 7572   // prepare sour
+000353d0: 6365 2064 6174 6120 2873 7263 3129 0a20  ce data (src1). 
+000353e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000353f0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+00035400: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
+00035410: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00035420: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00035430: 206e 6530 322a 6577 302a 6e65 3030 3b0a   ne02*ew0*ne00;.
+00035440: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00035450: 2028 696e 7420 6931 3120 3d20 303b 2069   (int i11 = 0; i
+00035460: 3131 203c 206e 6531 313b 2069 3131 2b2b  11 < ne11; i11++
+00035470: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00035480: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00035490: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
+000354a0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+000354b0: 2073 7263 312d 3e64 6174 6120 2b20 6931   src1->data + i1
+000354c0: 312a 6e62 3131 293b 0a20 2020 2020 2020  1*nb11);.       
+000354d0: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
+000354e0: 3136 5f74 202a 2064 7374 5f64 6174 6120  16_t * dst_data 
+000354f0: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
+00035500: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00035510: 7420 6931 3020 3d20 303b 2069 3130 203c  t i10 = 0; i10 <
+00035520: 206e 6531 303b 2069 3130 2b2b 2920 7b0a   ne10; i10++) {.
+00035530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035540: 2020 2020 6473 745f 6461 7461 5b28 6931      dst_data[(i1
+00035550: 3020 2b20 6e68 292a 6577 3020 2b20 6931  0 + nh)*ew0 + i1
+00035560: 315d 203d 2047 474d 4c5f 4650 3332 5f54  1] = GGML_FP32_T
+00035570: 4f5f 4650 3136 2873 7263 5b69 3130 5d29  O_FP16(src[i10])
+00035580: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00035590: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000355a0: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
+000355b0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+000355c0: 207d 0a0a 2020 2020 6966 2028 7061 7261   }..    if (para
+000355d0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+000355e0: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+000355f0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00035600: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+00035610: 746f 7461 6c20 726f 7773 2069 6e20 6473  total rows in ds
+00035620: 740a 2020 2020 636f 6e73 7420 696e 7420  t.    const int 
+00035630: 6e72 203d 206e 6530 323b 0a0a 2020 2020  nr = ne02;..    
+00035640: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+00035650: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00035660: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
+00035670: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
+00035680: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
+00035690: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
+000356a0: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
+000356b0: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
+000356c0: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+000356d0: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+000356e0: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
+000356f0: 3d20 6972 303b 2069 3120 3c20 6972 313b  = ir0; i1 < ir1;
+00035700: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
+00035710: 2066 6c6f 6174 202a 2064 7374 5f64 6174   float * dst_dat
+00035720: 6120 3d20 2866 6c6f 6174 202a 2928 2863  a = (float *)((c
+00035730: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
+00035740: 202b 2069 312a 6e62 3129 3b0a 2020 2020   + i1*nb1);.    
+00035750: 2020 2020 666f 7220 2869 6e74 2069 3020      for (int i0 
+00035760: 3d20 303b 2069 3020 3c20 6e65 3130 3b20  = 0; i0 < ne10; 
+00035770: 2b2b 6930 2920 7b0a 2020 2020 2020 2020  ++i0) {.        
+00035780: 2020 2020 6473 745f 6461 7461 5b69 305d      dst_data[i0]
+00035790: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+000357a0: 2020 666f 7220 2869 6e74 206b 203d 202d    for (int k = -
+000357b0: 6e68 3b20 6b20 3c3d 206e 683b 206b 2b2b  nh; k <= nh; k++
+000357c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000357d0: 2020 2020 666c 6f61 7420 7620 3d20 302e      float v = 0.
+000357e0: 3066 3b0a 2020 2020 2020 2020 2020 2020  0f;.            
+000357f0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00035800: 5f66 3136 2865 7730 2c20 2676 2c0a 2020  _f16(ew0, &v,.  
+00035810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035820: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
+00035830: 5f74 202a 2920 7061 7261 6d73 2d3e 7764  _t *) params->wd
+00035840: 6174 6120 2b20 2020 6931 2a65 7730 2a6e  ata +   i1*ew0*n
+00035850: 6530 3020 2b20 2020 2020 2028 6e68 202b  e00 +      (nh +
+00035860: 206b 292a 6577 302c 0a20 2020 2020 2020   k)*ew0,.       
+00035870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035880: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00035890: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+000358a0: 206e 6530 322a 6577 302a 6e65 3030 202b   ne02*ew0*ne00 +
+000358b0: 2028 6930 202b 206e 6820 2b20 6b29 2a65   (i0 + nh + k)*e
+000358c0: 7730 293b 0a0a 2020 2020 2020 2020 2020  w0);..          
+000358d0: 2020 2020 2020 6473 745f 6461 7461 5b69        dst_data[i
+000358e0: 305d 202b 3d20 763b 0a20 2020 2020 2020  0] += v;.       
+000358f0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00035900: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00035910: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00035920: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+00035930: 3164 5f31 735f 6633 3228 0a20 2020 2020  1d_1s_f32(.     
+00035940: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00035950: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00035960: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00035970: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00035980: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00035990: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+000359a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000359b0: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+000359c0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000359d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000359e0: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
+000359f0: 4d4c 5f41 5353 4552 5428 7372 6330 2d3e  ML_ASSERT(src0->
+00035a00: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00035a10: 455f 4633 3229 3b0a 2020 2020 4747 4d4c  E_F32);.    GGML
+00035a20: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
+00035a30: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00035a40: 4633 3229 3b0a 2020 2020 4747 4d4c 5f41  F32);.    GGML_A
+00035a50: 5353 4552 5428 2064 7374 2d3e 7479 7065  SSERT( dst->type
+00035a60: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+00035a70: 3229 3b0a 0a20 2020 2069 6e74 3634 5f74  2);..    int64_t
+00035a80: 2074 3020 3d20 6767 6d6c 5f70 6572 665f   t0 = ggml_perf_
+00035a90: 7469 6d65 5f75 7328 293b 0a20 2020 2055  time_us();.    U
+00035aa0: 4e55 5345 4428 7430 293b 0a0a 2020 2020  NUSED(t0);..    
+00035ab0: 636f 6e73 7420 696e 7420 6e65 3030 203d  const int ne00 =
+00035ac0: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+00035ad0: 2020 636f 6e73 7420 696e 7420 6e65 3031    const int ne01
+00035ae0: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
+00035af0: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+00035b00: 3032 203d 2073 7263 302d 3e6e 655b 325d  02 = src0->ne[2]
+00035b10: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00035b20: 7420 6e65 3033 203d 2073 7263 302d 3e6e  t ne03 = src0->n
+00035b30: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+00035b40: 2069 6e74 206e 6531 3020 3d20 7372 6331   int ne10 = src1
+00035b50: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00035b60: 7374 2069 6e74 206e 6531 3120 3d20 7372  st int ne11 = sr
+00035b70: 6331 2d3e 6e65 5b31 5d3b 0a20 2020 202f  c1->ne[1];.    /
+00035b80: 2f63 6f6e 7374 2069 6e74 206e 6531 3220  /const int ne12 
+00035b90: 3d20 7372 6331 2d3e 6e65 5b32 5d3b 0a20  = src1->ne[2];. 
+00035ba0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00035bb0: 6531 3320 3d20 7372 6331 2d3e 6e65 5b33  e13 = src1->ne[3
+00035bc0: 5d3b 0a0a 2020 2020 2f2f 636f 6e73 7420  ];..    //const 
+00035bd0: 696e 7420 6e65 3020 203d 2064 7374 2d3e  int ne0  = dst->
+00035be0: 6e65 5b30 5d3b 0a20 2020 202f 2f63 6f6e  ne[0];.    //con
+00035bf0: 7374 2069 6e74 206e 6531 2020 3d20 6473  st int ne1  = ds
+00035c00: 742d 3e6e 655b 315d 3b0a 2020 2020 2f2f  t->ne[1];.    //
+00035c10: 636f 6e73 7420 696e 7420 6e65 3220 203d  const int ne2  =
+00035c20: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
+00035c30: 202f 2f63 6f6e 7374 2069 6e74 206e 6533   //const int ne3
+00035c40: 2020 3d20 6473 742d 3e6e 655b 335d 3b0a    = dst->ne[3];.
+00035c50: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00035c60: 6e65 2020 203d 206e 6530 2a6e 6531 2a6e  ne   = ne0*ne1*n
+00035c70: 6532 2a6e 6533 3b0a 0a20 2020 2063 6f6e  e2*ne3;..    con
+00035c80: 7374 2069 6e74 206e 6230 3020 3d20 7372  st int nb00 = sr
+00035c90: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
+00035ca0: 6f6e 7374 2069 6e74 206e 6230 3120 3d20  onst int nb01 = 
+00035cb0: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
+00035cc0: 2063 6f6e 7374 2069 6e74 206e 6230 3220   const int nb02 
+00035cd0: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
+00035ce0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00035cf0: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
+00035d00: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00035d10: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
+00035d20: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00035d30: 696e 7420 6e62 3131 203d 2073 7263 312d  int nb11 = src1-
+00035d40: 3e6e 625b 315d 3b0a 2020 2020 2f2f 636f  >nb[1];.    //co
+00035d50: 6e73 7420 696e 7420 6e62 3132 203d 2073  nst int nb12 = s
+00035d60: 7263 312d 3e6e 625b 325d 3b0a 2020 2020  rc1->nb[2];.    
+00035d70: 2f2f 636f 6e73 7420 696e 7420 6e62 3133  //const int nb13
+00035d80: 203d 2073 7263 312d 3e6e 625b 335d 3b0a   = src1->nb[3];.
+00035d90: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00035da0: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
+00035db0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00035dc0: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
+00035dd0: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
+00035de0: 2069 6e74 206e 6232 2020 3d20 6473 742d   int nb2  = dst-
+00035df0: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
+00035e00: 6e73 7420 696e 7420 6e62 3320 203d 2064  nst int nb3  = d
+00035e10: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
+00035e20: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
+00035e30: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
+00035e40: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
+00035e50: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
+00035e60: 2020 2063 6f6e 7374 2069 6e74 206e 6b20     const int nk 
+00035e70: 3d20 6e65 3030 3b0a 2020 2020 636f 6e73  = ne00;.    cons
+00035e80: 7420 696e 7420 6e68 203d 206e 6b2f 323b  t int nh = nk/2;
+00035e90: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00035ea0: 6577 3020 3d20 6767 6d6c 5f75 7033 3228  ew0 = ggml_up32(
+00035eb0: 6e65 3031 293b 0a0a 2020 2020 4747 4d4c  ne01);..    GGML
+00035ec0: 5f41 5353 4552 5428 6e65 3030 2025 2032  _ASSERT(ne00 % 2
+00035ed0: 203d 3d20 3129 3b20 2f2f 2054 4f44 4f3a   == 1); // TODO:
+00035ee0: 2073 7570 706f 7274 2065 7665 6e20 6b65   support even ke
+00035ef0: 726e 656c 2073 697a 6573 0a20 2020 2047  rnel sizes.    G
+00035f00: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+00035f10: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00035f20: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00035f30: 5254 286e 6231 3020 3d3d 2073 697a 656f  RT(nb10 == sizeo
+00035f40: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00035f50: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00035f60: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+00035f70: 4954 2920 7b0a 2020 2020 2020 2020 2f2f  IT) {.        //
+00035f80: 2054 4f44 4f3a 2066 6978 2074 6869 7320   TODO: fix this 
+00035f90: 6d65 6d73 6574 2028 7773 697a 6520 6973  memset (wsize is
+00035fa0: 206f 7665 7265 7374 696d 6174 6564 290a   overestimated).
+00035fb0: 2020 2020 2020 2020 6d65 6d73 6574 2870          memset(p
+00035fc0: 6172 616d 732d 3e77 6461 7461 2c20 302c  arams->wdata, 0,
+00035fd0: 2070 6172 616d 732d 3e77 7369 7a65 293b   params->wsize);
+00035fe0: 0a0a 2020 2020 2020 2020 2f2f 2070 7265  ..        // pre
+00035ff0: 7061 7265 206b 6572 6e65 6c20 6461 7461  pare kernel data
+00036000: 2028 7372 6330 290a 2020 2020 2020 2020   (src0).        
+00036010: 7b0a 2020 2020 2020 2020 2020 2020 666c  {.            fl
+00036020: 6f61 7420 2a20 636f 6e73 7420 7764 6174  oat * const wdat
+00036030: 6120 3d20 2866 6c6f 6174 202a 2920 7061  a = (float *) pa
+00036040: 7261 6d73 2d3e 7764 6174 6120 2b20 303b  rams->wdata + 0;
+00036050: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00036060: 7220 2869 6e74 2069 3032 203d 2030 3b20  r (int i02 = 0; 
+00036070: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
+00036080: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00036090: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+000360a0: 3120 3d20 303b 2069 3031 203c 206e 6530  1 = 0; i01 < ne0
+000360b0: 313b 2069 3031 2b2b 2920 7b0a 2020 2020  1; i01++) {.    
+000360c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000360d0: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
+000360e0: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
+000360f0: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
+00036100: 302d 3e64 6174 6120 2b20 6930 322a 6e62  0->data + i02*nb
+00036110: 3032 202b 2069 3031 2a6e 6230 3129 3b0a  02 + i01*nb01);.
+00036120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036130: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
+00036140: 6461 7461 203d 2077 6461 7461 202b 2069  data = wdata + i
+00036150: 3032 2a65 7730 2a6e 6530 303b 0a20 2020  02*ew0*ne00;.   
+00036160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036170: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
+00036180: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
+00036190: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
+000361a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000361b0: 6473 745f 6461 7461 5b69 3030 2a65 7730  dst_data[i00*ew0
+000361c0: 202b 2069 3031 5d20 3d20 7372 635b 6930   + i01] = src[i0
+000361d0: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+000361e0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000361f0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00036200: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00036210: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00036220: 7072 6570 6172 6520 736f 7572 6365 2064  prepare source d
+00036230: 6174 6120 2873 7263 3129 0a20 2020 2020  ata (src1).     
+00036240: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00036250: 2066 6c6f 6174 202a 2063 6f6e 7374 2077   float * const w
+00036260: 6461 7461 203d 2028 666c 6f61 7420 2a29  data = (float *)
+00036270: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00036280: 206e 6530 322a 6577 302a 6e65 3030 3b0a   ne02*ew0*ne00;.
+00036290: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000362a0: 2028 696e 7420 6931 3120 3d20 303b 2069   (int i11 = 0; i
+000362b0: 3131 203c 206e 6531 313b 2069 3131 2b2b  11 < ne11; i11++
+000362c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000362d0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+000362e0: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
+000362f0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+00036300: 2073 7263 312d 3e64 6174 6120 2b20 6931   src1->data + i1
+00036310: 312a 6e62 3131 293b 0a20 2020 2020 2020  1*nb11);.       
+00036320: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+00036330: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
+00036340: 613b 0a20 2020 2020 2020 2020 2020 2020  a;.             
+00036350: 2020 2066 6f72 2028 696e 7420 6931 3020     for (int i10 
+00036360: 3d20 303b 2069 3130 203c 206e 6531 303b  = 0; i10 < ne10;
+00036370: 2069 3130 2b2b 2920 7b0a 2020 2020 2020   i10++) {.      
+00036380: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00036390: 745f 6461 7461 5b28 6931 3020 2b20 6e68  t_data[(i10 + nh
+000363a0: 292a 6577 3020 2b20 6931 315d 203d 2073  )*ew0 + i11] = s
+000363b0: 7263 5b69 3130 5d3b 0a20 2020 2020 2020  rc[i10];.       
+000363c0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000363d0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000363e0: 207d 0a0a 2020 2020 2020 2020 7265 7475   }..        retu
+000363f0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
+00036400: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00036410: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00036420: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00036430: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00036440: 2020 2020 2f2f 2074 6f74 616c 2072 6f77      // total row
+00036450: 7320 696e 2064 7374 0a20 2020 2063 6f6e  s in dst.    con
+00036460: 7374 2069 6e74 206e 7220 3d20 6e65 3032  st int nr = ne02
+00036470: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+00036480: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+00036490: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+000364a0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+000364b0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+000364c0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+000364d0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+000364e0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+000364f0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+00036500: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+00036510: 206e 7229 3b0a 0a20 2020 2066 6f72 2028   nr);..    for (
+00036520: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
+00036530: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
+00036540: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+00036550: 6473 745f 6461 7461 203d 2028 666c 6f61  dst_data = (floa
+00036560: 7420 2a29 2828 6368 6172 202a 2920 6473  t *)((char *) ds
+00036570: 742d 3e64 6174 6120 2b20 6931 2a6e 6231  t->data + i1*nb1
+00036580: 293b 0a20 2020 2020 2020 2066 6f72 2028  );.        for (
+00036590: 696e 7420 6930 203d 2030 3b20 6930 203c  int i0 = 0; i0 <
+000365a0: 206e 6531 303b 202b 2b69 3029 207b 0a20   ne10; ++i0) {. 
+000365b0: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+000365c0: 6174 615b 6930 5d20 3d20 303b 0a20 2020  ata[i0] = 0;.   
+000365d0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+000365e0: 7420 6b20 3d20 2d6e 683b 206b 203c 3d20  t k = -nh; k <= 
+000365f0: 6e68 3b20 6b2b 2b29 207b 0a20 2020 2020  nh; k++) {.     
+00036600: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00036610: 2076 203d 2030 2e30 663b 0a20 2020 2020   v = 0.0f;.     
+00036620: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00036630: 7665 635f 646f 745f 6633 3228 6577 302c  vec_dot_f32(ew0,
+00036640: 2026 762c 0a20 2020 2020 2020 2020 2020   &v,.           
+00036650: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+00036660: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
+00036670: 6461 7461 202b 2020 2069 312a 6577 302a  data +   i1*ew0*
+00036680: 6e65 3030 202b 2020 2020 2020 286e 6820  ne00 +      (nh 
+00036690: 2b20 6b29 2a65 7730 2c0a 2020 2020 2020  + k)*ew0,.      
+000366a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000366b0: 2020 2866 6c6f 6174 202a 2920 7061 7261    (float *) para
+000366c0: 6d73 2d3e 7764 6174 6120 2b20 6e65 3032  ms->wdata + ne02
+000366d0: 2a65 7730 2a6e 6530 3020 2b20 2869 3020  *ew0*ne00 + (i0 
+000366e0: 2b20 6e68 202b 206b 292a 6577 3029 3b0a  + nh + k)*ew0);.
+000366f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036700: 2064 7374 5f64 6174 615b 6930 5d20 2b3d   dst_data[i0] +=
+00036710: 2076 3b0a 2020 2020 2020 2020 2020 2020   v;.            
+00036720: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+00036730: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+00036740: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00036750: 7277 6172 645f 636f 6e76 5f31 645f 3173  rward_conv_1d_1s
+00036760: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00036770: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00036780: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00036790: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+000367a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000367b0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+000367c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000367d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000367e0: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+000367f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00036800: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+00036810: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+00036820: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00036830: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
+00036840: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00036850: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00036860: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00036870: 6172 645f 636f 6e76 5f31 645f 3173 5f66  ard_conv_1d_1s_f
+00036880: 3136 5f66 3332 2870 6172 616d 732c 2073  16_f32(params, s
+00036890: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+000368a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000368b0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000368c0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
+000368d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000368e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000368f0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00036900: 7761 7264 5f63 6f6e 765f 3164 5f31 735f  ward_conv_1d_1s_
+00036910: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+00036920: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
+00036930: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00036940: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00036950: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
 00036960: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00036970: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
-00036980: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00036990: 5045 5f43 4f55 4e54 3a0a 2020 2020 2020  PE_COUNT:.      
-000369a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000369b0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-000369c0: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-000369d0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000369e0: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
-000369f0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00036a00: 645f 726f 7065 0a0a 7374 6174 6963 2076  d_rope..static v
-00036a10: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00036a20: 5f66 6f72 7761 7264 5f72 6f70 655f 6633  _forward_rope_f3
-00036a30: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
-00036a40: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00036a50: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00036a60: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-00036a70: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00036a80: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-00036a90: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00036aa0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00036ab0: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-00036ac0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00036ad0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00036ae0: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
-00036af0: 7468 203d 3d20 3029 3b0a 2020 2020 6173  th == 0);.    as
-00036b00: 7365 7274 2873 7263 312d 3e74 7970 6520  sert(src1->type 
-00036b10: 3d3d 2047 474d 4c5f 5459 5045 5f49 3332  == GGML_TYPE_I32
-00036b20: 293b 0a20 2020 2061 7373 6572 7428 6767  );.    assert(gg
-00036b30: 6d6c 5f6e 656c 656d 656e 7473 2873 7263  ml_nelements(src
-00036b40: 3129 203d 3d20 3329 3b0a 0a20 2020 2069  1) == 3);..    i
-00036b50: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00036b60: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00036b70: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-00036b80: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00036b90: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00036ba0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00036bb0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00036bc0: 6e5f 7061 7374 203d 2028 2869 6e74 3332  n_past = ((int32
-00036bd0: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-00036be0: 295b 305d 3b0a 2020 2020 636f 6e73 7420  )[0];.    const 
-00036bf0: 696e 7420 6e5f 6469 6d73 203d 2028 2869  int n_dims = ((i
-00036c00: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-00036c10: 6461 7461 295b 315d 3b0a 2020 2020 636f  data)[1];.    co
-00036c20: 6e73 7420 696e 7420 6d6f 6465 2020 203d  nst int mode   =
-00036c30: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-00036c40: 6331 2d3e 6461 7461 295b 325d 3b0a 0a20  c1->data)[2];.. 
-00036c50: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-00036c60: 6530 203d 2073 7263 302d 3e6e 655b 305d  e0 = src0->ne[0]
-00036c70: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00036c80: 6e65 3120 3d20 7372 6330 2d3e 6e65 5b31  ne1 = src0->ne[1
-00036c90: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00036ca0: 206e 6532 203d 2073 7263 302d 3e6e 655b   ne2 = src0->ne[
-00036cb0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-00036cc0: 7420 6e65 3320 3d20 7372 6330 2d3e 6e65  t ne3 = src0->ne
-00036cd0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00036ce0: 696e 7420 6e62 3020 3d20 7372 6330 2d3e  int nb0 = src0->
-00036cf0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00036d00: 2069 6e74 206e 6231 203d 2073 7263 302d   int nb1 = src0-
-00036d10: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-00036d20: 7420 696e 7420 6e62 3220 3d20 7372 6330  t int nb2 = src0
-00036d30: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00036d40: 7374 2069 6e74 206e 6233 203d 2073 7263  st int nb3 = src
-00036d50: 302d 3e6e 625b 335d 3b0a 0a20 2020 202f  0->nb[3];..    /
-00036d60: 2f70 7269 6e74 6628 226e 6530 3a20 2564  /printf("ne0: %d
-00036d70: 2c20 6e65 313a 2025 642c 206e 6532 3a20  , ne1: %d, ne2: 
-00036d80: 2564 2c20 6e65 333a 2025 645c 6e22 2c20  %d, ne3: %d\n", 
-00036d90: 6e65 302c 206e 6531 2c20 6e65 322c 206e  ne0, ne1, ne2, n
-00036da0: 6533 293b 0a20 2020 202f 2f70 7269 6e74  e3);.    //print
-00036db0: 6628 226e 5f70 6173 7420 3d20 2564 2c20  f("n_past = %d, 
-00036dc0: 6e65 3220 3d20 2564 5c6e 222c 206e 5f70  ne2 = %d\n", n_p
-00036dd0: 6173 742c 206e 6532 293b 0a0a 2020 2020  ast, ne2);..    
-00036de0: 6173 7365 7274 286e 6230 203d 3d20 7369  assert(nb0 == si
-00036df0: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-00036e00: 2020 202f 2f20 544f 444f 3a20 6f70 7469     // TODO: opti
-00036e10: 6d69 7a65 0a20 2020 2066 6f72 2028 696e  mize.    for (in
-00036e20: 7420 6933 203d 2030 3b20 6933 203c 206e  t i3 = 0; i3 < n
-00036e30: 6533 3b20 6933 2b2b 2920 7b0a 2020 2020  e3; i3++) {.    
-00036e40: 2020 2020 666f 7220 2869 6e74 2069 3220      for (int i2 
-00036e50: 3d20 286d 6f64 6520 3d3d 2030 203f 2030  = (mode == 0 ? 0
-00036e60: 203a 206e 5f70 6173 7429 3b20 6932 203c   : n_past); i2 <
-00036e70: 206e 6532 3b20 6932 2b2b 2920 7b0a 2020   ne2; i2++) {.  
-00036e80: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00036e90: 696e 7420 7020 3d20 286d 6f64 6520 3d3d  int p = (mode ==
-00036ea0: 2030 203f 206e 5f70 6173 7420 2b20 6932   0 ? n_past + i2
-00036eb0: 203a 2069 3229 3b0a 2020 2020 2020 2020   : i2);.        
-00036ec0: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
-00036ed0: 3d20 303b 2069 3120 3c20 6e65 313b 2069  = 0; i1 < ne1; i
-00036ee0: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
-00036ef0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00036f00: 6930 203d 2030 3b20 6930 203c 206e 5f64  i0 = 0; i0 < n_d
-00036f10: 696d 733b 2069 3020 2b3d 2032 2920 7b0a  ims; i0 += 2) {.
-00036f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036f30: 2020 2020 636f 6e73 7420 646f 7562 6c65      const double
-00036f40: 2074 6865 7461 203d 2070 6f77 2831 3030   theta = pow(100
-00036f50: 3030 2e30 2c20 2828 646f 7562 6c65 292d  00.0, ((double)-
-00036f60: 6930 292f 6e5f 6469 6d73 293b 0a0a 2020  i0)/n_dims);..  
-00036f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036f80: 2020 636f 6e73 7420 646f 7562 6c65 2063    const double c
-00036f90: 6f73 5f74 6865 7461 203d 2063 6f73 2870  os_theta = cos(p
-00036fa0: 2a74 6865 7461 293b 0a20 2020 2020 2020  *theta);.       
-00036fb0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00036fc0: 7374 2064 6f75 626c 6520 7369 6e5f 7468  st double sin_th
-00036fd0: 6574 6120 3d20 7369 6e28 702a 7468 6574  eta = sin(p*thet
-00036fe0: 6129 3b0a 0a20 2020 2020 2020 2020 2020  a);..           
-00036ff0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00037000: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
-00037010: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-00037020: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-00037030: 202b 2069 332a 6e62 3320 2b20 6932 2a6e   + i3*nb3 + i2*n
-00037040: 6232 202b 2069 312a 6e62 3120 2b20 6930  b2 + i1*nb1 + i0
-00037050: 2a6e 6230 293b 0a20 2020 2020 2020 2020  *nb0);.         
-00037060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037070: 2066 6c6f 6174 202a 2064 7374 5f64 6174   float * dst_dat
-00037080: 6120 203d 2028 666c 6f61 7420 2a29 2828  a  = (float *)((
-00037090: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
-000370a0: 7461 202b 2069 332a 6e62 3320 2b20 6932  ta + i3*nb3 + i2
-000370b0: 2a6e 6232 202b 2069 312a 6e62 3120 2b20  *nb2 + i1*nb1 + 
-000370c0: 6930 2a6e 6230 293b 0a0a 2020 2020 2020  i0*nb0);..      
-000370d0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-000370e0: 7562 6c65 2078 3020 3d20 7372 635b 305d  uble x0 = src[0]
-000370f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00037100: 2020 2020 2020 646f 7562 6c65 2078 3120        double x1 
-00037110: 3d20 7372 635b 315d 3b0a 0a20 2020 2020  = src[1];..     
-00037120: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00037130: 7374 5f64 6174 615b 305d 203d 2078 302a  st_data[0] = x0*
-00037140: 636f 735f 7468 6574 6120 2d20 7831 2a73  cos_theta - x1*s
-00037150: 696e 5f74 6865 7461 3b0a 2020 2020 2020  in_theta;.      
-00037160: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00037170: 745f 6461 7461 5b31 5d20 3d20 7830 2a73  t_data[1] = x0*s
-00037180: 696e 5f74 6865 7461 202b 2078 312a 636f  in_theta + x1*co
-00037190: 735f 7468 6574 613b 0a20 2020 2020 2020  s_theta;.       
-000371a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000371b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000371c0: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
-000371d0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-000371e0: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
-000371f0: 655f 6631 3628 0a20 2020 2020 2020 2063  e_f16(.        c
-00037200: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00037210: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00037220: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00037230: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00037240: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00037250: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00037260: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00037270: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00037280: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00037290: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-000372a0: 2020 2020 6173 7365 7274 2870 6172 616d      assert(param
-000372b0: 732d 3e69 7468 203d 3d20 3029 3b0a 2020  s->ith == 0);.  
-000372c0: 2020 6173 7365 7274 2873 7263 312d 3e74    assert(src1->t
-000372d0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-000372e0: 5f49 3332 293b 0a20 2020 2061 7373 6572  _I32);.    asser
-000372f0: 7428 6767 6d6c 5f6e 656c 656d 656e 7473  t(ggml_nelements
-00037300: 2873 7263 3129 203d 3d20 3329 3b0a 0a20  (src1) == 3);.. 
-00037310: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-00037320: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00037330: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-00037340: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00037350: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-00037360: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00037370: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-00037380: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
-00037390: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-000373a0: 6461 7461 295b 305d 3b0a 2020 2020 636f  data)[0];.    co
-000373b0: 6e73 7420 696e 7420 6e5f 6469 6d73 203d  nst int n_dims =
-000373c0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-000373d0: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
-000373e0: 2020 636f 6e73 7420 696e 7420 6d6f 6465    const int mode
-000373f0: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
-00037400: 2920 7372 6331 2d3e 6461 7461 295b 325d  ) src1->data)[2]
-00037410: 3b0a 0a20 2020 202f 2f63 6f6e 7374 2069  ;..    //const i
-00037420: 6e74 206e 6530 203d 2073 7263 302d 3e6e  nt ne0 = src0->n
-00037430: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00037440: 696e 7420 6e65 3120 3d20 7372 6330 2d3e  int ne1 = src0->
-00037450: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-00037460: 2069 6e74 206e 6532 203d 2073 7263 302d   int ne2 = src0-
-00037470: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-00037480: 7420 696e 7420 6e65 3320 3d20 7372 6330  t int ne3 = src0
-00037490: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-000374a0: 6e73 7420 696e 7420 6e62 3020 3d20 7372  nst int nb0 = sr
-000374b0: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-000374c0: 6f6e 7374 2069 6e74 206e 6231 203d 2073  onst int nb1 = s
-000374d0: 7263 302d 3e6e 625b 315d 3b0a 2020 2020  rc0->nb[1];.    
-000374e0: 636f 6e73 7420 696e 7420 6e62 3220 3d20  const int nb2 = 
-000374f0: 7372 6330 2d3e 6e62 5b32 5d3b 0a20 2020  src0->nb[2];.   
-00037500: 2063 6f6e 7374 2069 6e74 206e 6233 203d   const int nb3 =
-00037510: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
-00037520: 2020 202f 2f70 7269 6e74 6628 226e 6530     //printf("ne0
-00037530: 3a20 2564 2c20 6e65 313a 2025 642c 206e  : %d, ne1: %d, n
-00037540: 6532 3a20 2564 2c20 6e65 333a 2025 645c  e2: %d, ne3: %d\
-00037550: 6e22 2c20 6e65 302c 206e 6531 2c20 6e65  n", ne0, ne1, ne
-00037560: 322c 206e 6533 293b 0a20 2020 202f 2f70  2, ne3);.    //p
-00037570: 7269 6e74 6628 226e 5f70 6173 7420 3d20  rintf("n_past = 
-00037580: 2564 2c20 6e65 3220 3d20 2564 5c6e 222c  %d, ne2 = %d\n",
-00037590: 206e 5f70 6173 742c 206e 6532 293b 0a0a   n_past, ne2);..
-000375a0: 2020 2020 6173 7365 7274 286e 6230 203d      assert(nb0 =
-000375b0: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
-000375c0: 3136 5f74 2929 3b0a 0a20 2020 2066 6f72  16_t));..    for
-000375d0: 2028 696e 7420 6933 203d 2030 3b20 6933   (int i3 = 0; i3
-000375e0: 203c 206e 6533 3b20 6933 2b2b 2920 7b0a   < ne3; i3++) {.
-000375f0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00037600: 2069 3220 3d20 286d 6f64 6520 3d3d 2030   i2 = (mode == 0
-00037610: 203f 2030 203a 206e 5f70 6173 7429 3b20   ? 0 : n_past); 
-00037620: 6932 203c 206e 6532 3b20 6932 2b2b 2920  i2 < ne2; i2++) 
-00037630: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
-00037640: 6e73 7420 696e 7420 7020 3d20 286d 6f64  nst int p = (mod
-00037650: 6520 3d3d 2030 203f 206e 5f70 6173 7420  e == 0 ? n_past 
-00037660: 2b20 6932 203a 2069 3229 3b0a 2020 2020  + i2 : i2);.    
-00037670: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00037680: 2069 3120 3d20 303b 2069 3120 3c20 6e65   i1 = 0; i1 < ne
-00037690: 313b 2069 312b 2b29 207b 0a20 2020 2020  1; i1++) {.     
-000376a0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-000376b0: 696e 7420 6930 203d 2030 3b20 6930 203c  int i0 = 0; i0 <
-000376c0: 206e 5f64 696d 733b 2069 3020 2b3d 2032   n_dims; i0 += 2
-000376d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000376e0: 2020 2020 2020 2020 636f 6e73 7420 646f          const do
-000376f0: 7562 6c65 2074 6865 7461 203d 2070 6f77  uble theta = pow
-00037700: 2831 3030 3030 2e30 2c20 2828 646f 7562  (10000.0, ((doub
-00037710: 6c65 292d 6930 292f 6e5f 6469 6d73 293b  le)-i0)/n_dims);
-00037720: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00037730: 2020 2020 2020 636f 6e73 7420 646f 7562        const doub
-00037740: 6c65 2063 6f73 5f74 6865 7461 203d 2063  le cos_theta = c
-00037750: 6f73 2870 2a74 6865 7461 293b 0a20 2020  os(p*theta);.   
-00037760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037770: 2063 6f6e 7374 2064 6f75 626c 6520 7369   const double si
-00037780: 6e5f 7468 6574 6120 3d20 7369 6e28 702a  n_theta = sin(p*
-00037790: 7468 6574 6129 3b0a 0a20 2020 2020 2020  theta);..       
-000377a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000377b0: 7374 2067 676d 6c5f 6670 3136 5f74 202a  st ggml_fp16_t *
-000377c0: 2063 6f6e 7374 2073 7263 203d 2028 6767   const src = (gg
-000377d0: 6d6c 5f66 7031 365f 7420 2a29 2828 6368  ml_fp16_t *)((ch
-000377e0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-000377f0: 202b 2069 332a 6e62 3320 2b20 6932 2a6e   + i3*nb3 + i2*n
-00037800: 6232 202b 2069 312a 6e62 3120 2b20 6930  b2 + i1*nb1 + i0
-00037810: 2a6e 6230 293b 0a20 2020 2020 2020 2020  *nb0);.         
-00037820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037830: 2067 676d 6c5f 6670 3136 5f74 202a 2064   ggml_fp16_t * d
-00037840: 7374 5f64 6174 6120 203d 2028 6767 6d6c  st_data  = (ggml
-00037850: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
-00037860: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
-00037870: 2069 332a 6e62 3320 2b20 6932 2a6e 6232   i3*nb3 + i2*nb2
-00037880: 202b 2069 312a 6e62 3120 2b20 6930 2a6e   + i1*nb1 + i0*n
-00037890: 6230 293b 0a0a 2020 2020 2020 2020 2020  b0);..          
-000378a0: 2020 2020 2020 2020 2020 646f 7562 6c65            double
-000378b0: 2078 3020 3d20 6767 6d6c 5f66 7031 365f   x0 = ggml_fp16_
-000378c0: 746f 5f66 7033 3228 7372 635b 305d 293b  to_fp32(src[0]);
-000378d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000378e0: 2020 2020 2064 6f75 626c 6520 7831 203d       double x1 =
-000378f0: 2067 676d 6c5f 6670 3136 5f74 6f5f 6670   ggml_fp16_to_fp
-00037900: 3332 2873 7263 5b31 5d29 3b0a 0a20 2020  32(src[1]);..   
-00037910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037920: 2064 7374 5f64 6174 615b 305d 203d 2067   dst_data[0] = g
-00037930: 676d 6c5f 6670 3332 5f74 6f5f 6670 3136  gml_fp32_to_fp16
-00037940: 2878 302a 636f 735f 7468 6574 6120 2d20  (x0*cos_theta - 
-00037950: 7831 2a73 696e 5f74 6865 7461 293b 0a20  x1*sin_theta);. 
-00037960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037970: 2020 2064 7374 5f64 6174 615b 315d 203d     dst_data[1] =
-00037980: 2067 676d 6c5f 6670 3332 5f74 6f5f 6670   ggml_fp32_to_fp
-00037990: 3136 2878 302a 7369 6e5f 7468 6574 6120  16(x0*sin_theta 
-000379a0: 2b20 7831 2a63 6f73 5f74 6865 7461 293b  + x1*cos_theta);
-000379b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000379c0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-000379d0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-000379e0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-000379f0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00037a00: 7761 7264 5f72 6f70 6528 0a20 2020 2020  ward_rope(.     
-00037a10: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00037a20: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00037a30: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00037a40: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00037a50: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00037a60: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-00037a70: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00037a80: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-00037a90: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00037aa0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00037ab0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00037ac0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00037ad0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00037ae0: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
-00037af0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00037b00: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00037b10: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
-00037b20: 655f 6631 3628 7061 7261 6d73 2c20 7372  e_f16(params, sr
-00037b30: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-00037b40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00037b50: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00037b60: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-00037b70: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00037b80: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00037b90: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00037ba0: 6172 645f 726f 7065 5f66 3332 2870 6172  ard_rope_f32(par
-00037bb0: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00037bc0: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00037bd0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00037be0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00037bf0: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
-00037c00: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00037c10: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
-00037c20: 7365 2047 474d 4c5f 5459 5045 5f49 383a  se GGML_TYPE_I8:
-00037c30: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00037c40: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
-00037c50: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00037c60: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
-00037c70: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00037c80: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
-00037c90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00037ca0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00037cb0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00037cc0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00037cd0: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00037ce0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00037cf0: 6f6e 765f 3164 5f31 730a 0a73 7461 7469  onv_1d_1s..stati
-00037d00: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00037d10: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
-00037d20: 5f31 645f 3173 5f66 3136 5f66 3332 280a  _1d_1s_f16_f32(.
-00037d30: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00037d40: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00037d50: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00037d60: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00037d70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00037d80: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00037d90: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00037da0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00037db0: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
-00037dc0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00037dd0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00037de0: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-00037df0: 7263 302d 3e74 7970 6520 3d3d 2047 474d  rc0->type == GGM
-00037e00: 4c5f 5459 5045 5f46 3136 293b 0a20 2020  L_TYPE_F16);.   
-00037e10: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
-00037e20: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-00037e30: 5459 5045 5f46 3332 293b 0a20 2020 2047  TYPE_F32);.    G
-00037e40: 474d 4c5f 4153 5345 5254 2820 6473 742d  GML_ASSERT( dst-
-00037e50: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00037e60: 5045 5f46 3332 293b 0a0a 2020 2020 696e  PE_F32);..    in
-00037e70: 7436 345f 7420 7430 203d 2067 676d 6c5f  t64_t t0 = ggml_
-00037e80: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
-00037e90: 2020 2020 554e 5553 4544 2874 3029 3b0a      UNUSED(t0);.
-00037ea0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00037eb0: 6530 3020 3d20 7372 6330 2d3e 6e65 5b30  e00 = src0->ne[0
-00037ec0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00037ed0: 206e 6530 3120 3d20 7372 6330 2d3e 6e65   ne01 = src0->ne
-00037ee0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00037ef0: 6e74 206e 6530 3220 3d20 7372 6330 2d3e  nt ne02 = src0->
-00037f00: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-00037f10: 7374 2069 6e74 206e 6530 3320 3d20 7372  st int ne03 = sr
-00037f20: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
-00037f30: 636f 6e73 7420 696e 7420 6e65 3130 203d  const int ne10 =
-00037f40: 2073 7263 312d 3e6e 655b 305d 3b0a 2020   src1->ne[0];.  
-00037f50: 2020 636f 6e73 7420 696e 7420 6e65 3131    const int ne11
-00037f60: 203d 2073 7263 312d 3e6e 655b 315d 3b0a   = src1->ne[1];.
-00037f70: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-00037f80: 6e65 3132 203d 2073 7263 312d 3e6e 655b  ne12 = src1->ne[
-00037f90: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00037fa0: 696e 7420 6e65 3133 203d 2073 7263 312d  int ne13 = src1-
-00037fb0: 3e6e 655b 335d 3b0a 0a20 2020 202f 2f63  >ne[3];..    //c
-00037fc0: 6f6e 7374 2069 6e74 206e 6530 2020 3d20  onst int ne0  = 
-00037fd0: 6473 742d 3e6e 655b 305d 3b0a 2020 2020  dst->ne[0];.    
-00037fe0: 2f2f 636f 6e73 7420 696e 7420 6e65 3120  //const int ne1 
-00037ff0: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
-00038000: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-00038010: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
-00038020: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-00038030: 7420 6e65 3320 203d 2064 7374 2d3e 6e65  t ne3  = dst->ne
-00038040: 5b33 5d3b 0a20 2020 202f 2f63 6f6e 7374  [3];.    //const
-00038050: 2069 6e74 206e 6520 2020 3d20 6e65 302a   int ne   = ne0*
-00038060: 6e65 312a 6e65 322a 6e65 333b 0a0a 2020  ne1*ne2*ne3;..  
-00038070: 2020 636f 6e73 7420 696e 7420 6e62 3030    const int nb00
-00038080: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
-00038090: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-000380a0: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
-000380b0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000380c0: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
-000380d0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-000380e0: 696e 7420 6e62 3033 203d 2073 7263 302d  int nb03 = src0-
-000380f0: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-00038100: 7374 2069 6e74 206e 6231 3020 3d20 7372  st int nb10 = sr
-00038110: 6331 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c1->nb[0];.    c
-00038120: 6f6e 7374 2069 6e74 206e 6231 3120 3d20  onst int nb11 = 
-00038130: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
-00038140: 202f 2f63 6f6e 7374 2069 6e74 206e 6231   //const int nb1
-00038150: 3220 3d20 7372 6331 2d3e 6e62 5b32 5d3b  2 = src1->nb[2];
-00038160: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00038170: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
-00038180: 5b33 5d3b 0a0a 2020 2020 2f2f 636f 6e73  [3];..    //cons
-00038190: 7420 696e 7420 6e62 3020 203d 2064 7374  t int nb0  = dst
-000381a0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-000381b0: 7374 2069 6e74 206e 6231 2020 3d20 6473  st int nb1  = ds
-000381c0: 742d 3e6e 625b 315d 3b0a 2020 2020 2f2f  t->nb[1];.    //
-000381d0: 636f 6e73 7420 696e 7420 6e62 3220 203d  const int nb2  =
-000381e0: 2064 7374 2d3e 6e62 5b32 5d3b 0a20 2020   dst->nb[2];.   
-000381f0: 202f 2f63 6f6e 7374 2069 6e74 206e 6233   //const int nb3
-00038200: 2020 3d20 6473 742d 3e6e 625b 335d 3b0a    = dst->nb[3];.
-00038210: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00038220: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-00038230: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00038240: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-00038250: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
-00038260: 7420 6e6b 203d 206e 6530 303b 0a20 2020  t nk = ne00;.   
-00038270: 2063 6f6e 7374 2069 6e74 206e 6820 3d20   const int nh = 
-00038280: 6e6b 2f32 3b0a 0a20 2020 2063 6f6e 7374  nk/2;..    const
-00038290: 2069 6e74 2065 7730 203d 2067 676d 6c5f   int ew0 = ggml_
-000382a0: 7570 3332 286e 6530 3129 3b0a 0a20 2020  up32(ne01);..   
-000382b0: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-000382c0: 3020 2520 3220 3d3d 2031 293b 202f 2f20  0 % 2 == 1); // 
-000382d0: 544f 444f 3a20 7375 7070 6f72 7420 6576  TODO: support ev
-000382e0: 656e 206b 6572 6e65 6c20 7369 7a65 730a  en kernel sizes.
-000382f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00038300: 6e62 3030 203d 3d20 7369 7a65 6f66 2867  nb00 == sizeof(g
-00038310: 676d 6c5f 6670 3136 5f74 2929 3b0a 2020  gml_fp16_t));.  
-00038320: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00038330: 3130 203d 3d20 7369 7a65 6f66 2866 6c6f  10 == sizeof(flo
-00038340: 6174 2929 3b0a 0a20 2020 2069 6620 2870  at));..    if (p
-00038350: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00038360: 474d 4c5f 5441 534b 5f49 4e49 5429 207b  GML_TASK_INIT) {
-00038370: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
-00038380: 3a20 6669 7820 7468 6973 206d 656d 7365  : fix this memse
-00038390: 7420 2877 7369 7a65 2069 7320 6f76 6572  t (wsize is over
-000383a0: 6573 7469 6d61 7465 6429 0a20 2020 2020  estimated).     
-000383b0: 2020 206d 656d 7365 7428 7061 7261 6d73     memset(params
-000383c0: 2d3e 7764 6174 612c 2030 2c20 7061 7261  ->wdata, 0, para
-000383d0: 6d73 2d3e 7773 697a 6529 3b0a 0a20 2020  ms->wsize);..   
-000383e0: 2020 2020 202f 2f20 7072 6570 6172 6520       // prepare 
-000383f0: 6b65 726e 656c 2064 6174 6120 2873 7263  kernel data (src
-00038400: 3029 0a20 2020 2020 2020 207b 0a20 2020  0).        {.   
-00038410: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
-00038420: 3136 5f74 202a 2063 6f6e 7374 2077 6461  16_t * const wda
-00038430: 7461 203d 2028 6767 6d6c 5f66 7031 365f  ta = (ggml_fp16_
-00038440: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-00038450: 7461 202b 2030 3b0a 0a20 2020 2020 2020  ta + 0;..       
-00038460: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
-00038470: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
-00038480: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
-00038490: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000384a0: 2869 6e74 2069 3031 203d 2030 3b20 6930  (int i01 = 0; i0
-000384b0: 3120 3c20 6e65 3031 3b20 6930 312b 2b29  1 < ne01; i01++)
-000384c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000384d0: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
-000384e0: 6c5f 6670 3136 5f74 202a 2063 6f6e 7374  l_fp16_t * const
-000384f0: 2073 7263 203d 2028 6767 6d6c 5f66 7031   src = (ggml_fp1
-00038500: 365f 7420 2a29 2828 6368 6172 202a 2920  6_t *)((char *) 
-00038510: 7372 6330 2d3e 6461 7461 202b 2069 3032  src0->data + i02
-00038520: 2a6e 6230 3220 2b20 6930 312a 6e62 3031  *nb02 + i01*nb01
-00038530: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00038540: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-00038550: 5f74 202a 2064 7374 5f64 6174 6120 3d20  _t * dst_data = 
-00038560: 7764 6174 6120 2b20 6930 322a 6577 302a  wdata + i02*ew0*
-00038570: 6e65 3030 3b0a 2020 2020 2020 2020 2020  ne00;.          
-00038580: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00038590: 6e74 2069 3030 203d 2030 3b20 6930 3020  nt i00 = 0; i00 
-000385a0: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
-000385b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000385c0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-000385d0: 615b 6930 302a 6577 3020 2b20 6930 315d  a[i00*ew0 + i01]
-000385e0: 203d 2073 7263 5b69 3030 5d3b 0a20 2020   = src[i00];.   
-000385f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038600: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00038610: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00038620: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-00038630: 2020 2020 2020 2f2f 2070 7265 7061 7265        // prepare
-00038640: 2073 6f75 7263 6520 6461 7461 2028 7372   source data (sr
-00038650: 6331 290a 2020 2020 2020 2020 7b0a 2020  c1).        {.  
-00038660: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-00038670: 7031 365f 7420 2a20 636f 6e73 7420 7764  p16_t * const wd
-00038680: 6174 6120 3d20 2867 676d 6c5f 6670 3136  ata = (ggml_fp16
-00038690: 5f74 202a 2920 7061 7261 6d73 2d3e 7764  _t *) params->wd
-000386a0: 6174 6120 2b20 6e65 3032 2a65 7730 2a6e  ata + ne02*ew0*n
-000386b0: 6530 303b 0a0a 2020 2020 2020 2020 2020  e00;..          
-000386c0: 2020 666f 7220 2869 6e74 2069 3131 203d    for (int i11 =
-000386d0: 2030 3b20 6931 3120 3c20 6e65 3131 3b20   0; i11 < ne11; 
-000386e0: 6931 312b 2b29 207b 0a20 2020 2020 2020  i11++) {.       
-000386f0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00038700: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
-00038710: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-00038720: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
-00038730: 202b 2069 3131 2a6e 6231 3129 3b0a 2020   + i11*nb11);.  
-00038740: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00038750: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
-00038760: 6461 7461 203d 2077 6461 7461 3b0a 2020  data = wdata;.  
-00038770: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00038780: 7220 2869 6e74 2069 3130 203d 2030 3b20  r (int i10 = 0; 
-00038790: 6931 3020 3c20 6e65 3130 3b20 6931 302b  i10 < ne10; i10+
-000387a0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000387b0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-000387c0: 615b 2869 3130 202b 206e 6829 2a65 7730  a[(i10 + nh)*ew0
-000387d0: 202b 2069 3131 5d20 3d20 4747 4d4c 5f46   + i11] = GGML_F
-000387e0: 5033 325f 544f 5f46 5031 3628 7372 635b  P32_TO_FP16(src[
-000387f0: 6931 305d 293b 0a20 2020 2020 2020 2020  i10]);.         
-00038800: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00038810: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00038820: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00038830: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
-00038840: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00038850: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-00038860: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-00038870: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00038880: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
-00038890: 696e 2064 7374 0a20 2020 2063 6f6e 7374  in dst.    const
-000388a0: 2069 6e74 206e 7220 3d20 6e65 3032 3b0a   int nr = ne02;.
-000388b0: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
-000388c0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-000388d0: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
-000388e0: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-000388f0: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
-00038900: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-00038910: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00038920: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
-00038930: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
-00038940: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
-00038950: 7229 3b0a 0a20 2020 2066 6f72 2028 696e  r);..    for (in
-00038960: 7420 6931 203d 2069 7230 3b20 6931 203c  t i1 = ir0; i1 <
-00038970: 2069 7231 3b20 6931 2b2b 2920 7b0a 2020   ir1; i1++) {.  
-00038980: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-00038990: 745f 6461 7461 203d 2028 666c 6f61 7420  t_data = (float 
-000389a0: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
-000389b0: 3e64 6174 6120 2b20 6931 2a6e 6231 293b  >data + i1*nb1);
-000389c0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-000389d0: 7420 6930 203d 2030 3b20 6930 203c 206e  t i0 = 0; i0 < n
-000389e0: 6531 303b 202b 2b69 3029 207b 0a20 2020  e10; ++i0) {.   
-000389f0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-00038a00: 615b 6930 5d20 3d20 303b 0a20 2020 2020  a[i0] = 0;.     
-00038a10: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00038a20: 6b20 3d20 2d6e 683b 206b 203c 3d20 6e68  k = -nh; k <= nh
-00038a30: 3b20 6b2b 2b29 207b 0a20 2020 2020 2020  ; k++) {.       
-00038a40: 2020 2020 2020 2020 2066 6c6f 6174 2076           float v
-00038a50: 203d 2030 2e30 663b 0a20 2020 2020 2020   = 0.0f;.       
-00038a60: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00038a70: 635f 646f 745f 6631 3628 6577 302c 2026  c_dot_f16(ew0, &
-00038a80: 762c 0a20 2020 2020 2020 2020 2020 2020  v,.             
-00038a90: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
-00038aa0: 5f66 7031 365f 7420 2a29 2070 6172 616d  _fp16_t *) param
-00038ab0: 732d 3e77 6461 7461 202b 2020 2069 312a  s->wdata +   i1*
-00038ac0: 6577 302a 6e65 3030 202b 2020 2020 2020  ew0*ne00 +      
-00038ad0: 286e 6820 2b20 6b29 2a65 7730 2c0a 2020  (nh + k)*ew0,.  
-00038ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038af0: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
-00038b00: 5f74 202a 2920 7061 7261 6d73 2d3e 7764  _t *) params->wd
-00038b10: 6174 6120 2b20 6e65 3032 2a65 7730 2a6e  ata + ne02*ew0*n
-00038b20: 6530 3020 2b20 2869 3020 2b20 6e68 202b  e00 + (i0 + nh +
-00038b30: 206b 292a 6577 3029 3b0a 0a20 2020 2020   k)*ew0);..     
-00038b40: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
-00038b50: 6174 615b 6930 5d20 2b3d 2076 3b0a 2020  ata[i0] += v;.  
-00038b60: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00038b70: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-00038b80: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00038b90: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00038ba0: 636f 6e76 5f31 645f 3173 5f66 3332 280a  conv_1d_1s_f32(.
-00038bb0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00038bc0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00038bd0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00038be0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00038bf0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00038c00: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00038c10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00038c20: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00038c30: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
-00038c40: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00038c50: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00038c60: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-00038c70: 7263 302d 3e74 7970 6520 3d3d 2047 474d  rc0->type == GGM
-00038c80: 4c5f 5459 5045 5f46 3332 293b 0a20 2020  L_TYPE_F32);.   
-00038c90: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
-00038ca0: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-00038cb0: 5459 5045 5f46 3332 293b 0a20 2020 2047  TYPE_F32);.    G
-00038cc0: 474d 4c5f 4153 5345 5254 2820 6473 742d  GML_ASSERT( dst-
-00038cd0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00038ce0: 5045 5f46 3332 293b 0a0a 2020 2020 696e  PE_F32);..    in
-00038cf0: 7436 345f 7420 7430 203d 2067 676d 6c5f  t64_t t0 = ggml_
-00038d00: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
-00038d10: 2020 2020 554e 5553 4544 2874 3029 3b0a      UNUSED(t0);.
-00038d20: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00038d30: 6530 3020 3d20 7372 6330 2d3e 6e65 5b30  e00 = src0->ne[0
-00038d40: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00038d50: 206e 6530 3120 3d20 7372 6330 2d3e 6e65   ne01 = src0->ne
-00038d60: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00038d70: 6e74 206e 6530 3220 3d20 7372 6330 2d3e  nt ne02 = src0->
-00038d80: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-00038d90: 7374 2069 6e74 206e 6530 3320 3d20 7372  st int ne03 = sr
-00038da0: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
-00038db0: 636f 6e73 7420 696e 7420 6e65 3130 203d  const int ne10 =
-00038dc0: 2073 7263 312d 3e6e 655b 305d 3b0a 2020   src1->ne[0];.  
-00038dd0: 2020 636f 6e73 7420 696e 7420 6e65 3131    const int ne11
-00038de0: 203d 2073 7263 312d 3e6e 655b 315d 3b0a   = src1->ne[1];.
-00038df0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-00038e00: 6e65 3132 203d 2073 7263 312d 3e6e 655b  ne12 = src1->ne[
-00038e10: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00038e20: 696e 7420 6e65 3133 203d 2073 7263 312d  int ne13 = src1-
-00038e30: 3e6e 655b 335d 3b0a 0a20 2020 202f 2f63  >ne[3];..    //c
-00038e40: 6f6e 7374 2069 6e74 206e 6530 2020 3d20  onst int ne0  = 
-00038e50: 6473 742d 3e6e 655b 305d 3b0a 2020 2020  dst->ne[0];.    
-00038e60: 2f2f 636f 6e73 7420 696e 7420 6e65 3120  //const int ne1 
-00038e70: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
-00038e80: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-00038e90: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
-00038ea0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-00038eb0: 7420 6e65 3320 203d 2064 7374 2d3e 6e65  t ne3  = dst->ne
-00038ec0: 5b33 5d3b 0a20 2020 202f 2f63 6f6e 7374  [3];.    //const
-00038ed0: 2069 6e74 206e 6520 2020 3d20 6e65 302a   int ne   = ne0*
-00038ee0: 6e65 312a 6e65 322a 6e65 333b 0a0a 2020  ne1*ne2*ne3;..  
-00038ef0: 2020 636f 6e73 7420 696e 7420 6e62 3030    const int nb00
-00038f00: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
-00038f10: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00038f20: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
-00038f30: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00038f40: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
-00038f50: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00038f60: 696e 7420 6e62 3033 203d 2073 7263 302d  int nb03 = src0-
-00038f70: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-00038f80: 7374 2069 6e74 206e 6231 3020 3d20 7372  st int nb10 = sr
-00038f90: 6331 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c1->nb[0];.    c
-00038fa0: 6f6e 7374 2069 6e74 206e 6231 3120 3d20  onst int nb11 = 
-00038fb0: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
-00038fc0: 202f 2f63 6f6e 7374 2069 6e74 206e 6231   //const int nb1
-00038fd0: 3220 3d20 7372 6331 2d3e 6e62 5b32 5d3b  2 = src1->nb[2];
-00038fe0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00038ff0: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
-00039000: 5b33 5d3b 0a0a 2020 2020 2f2f 636f 6e73  [3];..    //cons
-00039010: 7420 696e 7420 6e62 3020 203d 2064 7374  t int nb0  = dst
-00039020: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-00039030: 7374 2069 6e74 206e 6231 2020 3d20 6473  st int nb1  = ds
-00039040: 742d 3e6e 625b 315d 3b0a 2020 2020 2f2f  t->nb[1];.    //
-00039050: 636f 6e73 7420 696e 7420 6e62 3220 203d  const int nb2  =
-00039060: 2064 7374 2d3e 6e62 5b32 5d3b 0a20 2020   dst->nb[2];.   
-00039070: 202f 2f63 6f6e 7374 2069 6e74 206e 6233   //const int nb3
-00039080: 2020 3d20 6473 742d 3e6e 625b 335d 3b0a    = dst->nb[3];.
-00039090: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-000390a0: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-000390b0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000390c0: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-000390d0: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
-000390e0: 7420 6e6b 203d 206e 6530 303b 0a20 2020  t nk = ne00;.   
-000390f0: 2063 6f6e 7374 2069 6e74 206e 6820 3d20   const int nh = 
-00039100: 6e6b 2f32 3b0a 0a20 2020 2063 6f6e 7374  nk/2;..    const
-00039110: 2069 6e74 2065 7730 203d 2067 676d 6c5f   int ew0 = ggml_
-00039120: 7570 3332 286e 6530 3129 3b0a 0a20 2020  up32(ne01);..   
-00039130: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-00039140: 3020 2520 3220 3d3d 2031 293b 202f 2f20  0 % 2 == 1); // 
-00039150: 544f 444f 3a20 7375 7070 6f72 7420 6576  TODO: support ev
-00039160: 656e 206b 6572 6e65 6c20 7369 7a65 730a  en kernel sizes.
-00039170: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00039180: 6e62 3030 203d 3d20 7369 7a65 6f66 2866  nb00 == sizeof(f
-00039190: 6c6f 6174 2929 3b0a 2020 2020 4747 4d4c  loat));.    GGML
-000391a0: 5f41 5353 4552 5428 6e62 3130 203d 3d20  _ASSERT(nb10 == 
-000391b0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-000391c0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-000391d0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-000391e0: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
-000391f0: 2020 202f 2f20 544f 444f 3a20 6669 7820     // TODO: fix 
-00039200: 7468 6973 206d 656d 7365 7420 2877 7369  this memset (wsi
-00039210: 7a65 2069 7320 6f76 6572 6573 7469 6d61  ze is overestima
-00039220: 7465 6429 0a20 2020 2020 2020 206d 656d  ted).        mem
-00039230: 7365 7428 7061 7261 6d73 2d3e 7764 6174  set(params->wdat
-00039240: 612c 2030 2c20 7061 7261 6d73 2d3e 7773  a, 0, params->ws
-00039250: 697a 6529 3b0a 0a20 2020 2020 2020 202f  ize);..        /
-00039260: 2f20 7072 6570 6172 6520 6b65 726e 656c  / prepare kernel
-00039270: 2064 6174 6120 2873 7263 3029 0a20 2020   data (src0).   
-00039280: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00039290: 2020 2066 6c6f 6174 202a 2063 6f6e 7374     float * const
-000392a0: 2077 6461 7461 203d 2028 666c 6f61 7420   wdata = (float 
-000392b0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
-000392c0: 202b 2030 3b0a 0a20 2020 2020 2020 2020   + 0;..         
-000392d0: 2020 2066 6f72 2028 696e 7420 6930 3220     for (int i02 
-000392e0: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
-000392f0: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
-00039300: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00039310: 6e74 2069 3031 203d 2030 3b20 6930 3120  nt i01 = 0; i01 
-00039320: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
-00039330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039340: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-00039350: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
-00039360: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-00039370: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-00039380: 3032 2a6e 6230 3220 2b20 6930 312a 6e62  02*nb02 + i01*nb
-00039390: 3031 293b 0a20 2020 2020 2020 2020 2020  01);.           
-000393a0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-000393b0: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
-000393c0: 6120 2b20 6930 322a 6577 302a 6e65 3030  a + i02*ew0*ne00
-000393d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000393e0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-000393f0: 3030 203d 2030 3b20 6930 3020 3c20 6e65  00 = 0; i00 < ne
-00039400: 3030 3b20 6930 302b 2b29 207b 0a20 2020  00; i00++) {.   
-00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039420: 2020 2020 2064 7374 5f64 6174 615b 6930       dst_data[i0
-00039430: 302a 6577 3020 2b20 6930 315d 203d 2073  0*ew0 + i01] = s
-00039440: 7263 5b69 3030 5d3b 0a20 2020 2020 2020  rc[i00];.       
-00039450: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00039460: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00039470: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00039480: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00039490: 2020 2f2f 2070 7265 7061 7265 2073 6f75    // prepare sou
-000394a0: 7263 6520 6461 7461 2028 7372 6331 290a  rce data (src1).
-000394b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000394c0: 2020 2020 2020 666c 6f61 7420 2a20 636f        float * co
-000394d0: 6e73 7420 7764 6174 6120 3d20 2866 6c6f  nst wdata = (flo
-000394e0: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-000394f0: 6174 6120 2b20 6e65 3032 2a65 7730 2a6e  ata + ne02*ew0*n
-00039500: 6530 303b 0a0a 2020 2020 2020 2020 2020  e00;..          
-00039510: 2020 666f 7220 2869 6e74 2069 3131 203d    for (int i11 =
-00039520: 2030 3b20 6931 3120 3c20 6e65 3131 3b20   0; i11 < ne11; 
-00039530: 6931 312b 2b29 207b 0a20 2020 2020 2020  i11++) {.       
-00039540: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00039550: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
-00039560: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-00039570: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
-00039580: 202b 2069 3131 2a6e 6231 3129 3b0a 2020   + i11*nb11);.  
-00039590: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-000395a0: 6f61 7420 2a20 6473 745f 6461 7461 203d  oat * dst_data =
-000395b0: 2077 6461 7461 3b0a 2020 2020 2020 2020   wdata;.        
-000395c0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000395d0: 2069 3130 203d 2030 3b20 6931 3020 3c20   i10 = 0; i10 < 
-000395e0: 6e65 3130 3b20 6931 302b 2b29 207b 0a20  ne10; i10++) {. 
-000395f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039600: 2020 2064 7374 5f64 6174 615b 2869 3130     dst_data[(i10
-00039610: 202b 206e 6829 2a65 7730 202b 2069 3131   + nh)*ew0 + i11
-00039620: 5d20 3d20 7372 635b 6931 305d 3b0a 2020  ] = src[i10];.  
-00039630: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00039640: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00039650: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00039660: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00039670: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00039680: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00039690: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-000396a0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-000396b0: 2020 7d0a 0a20 2020 202f 2f20 746f 7461    }..    // tota
-000396c0: 6c20 726f 7773 2069 6e20 6473 740a 2020  l rows in dst.  
-000396d0: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
-000396e0: 206e 6530 323b 0a0a 2020 2020 2f2f 2072   ne02;..    // r
-000396f0: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
-00039700: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
-00039710: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
-00039720: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
-00039730: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
-00039740: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-00039750: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
-00039760: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00039770: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
-00039780: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
-00039790: 666f 7220 2869 6e74 2069 3120 3d20 6972  for (int i1 = ir
-000397a0: 303b 2069 3120 3c20 6972 313b 2069 312b  0; i1 < ir1; i1+
-000397b0: 2b29 207b 0a20 2020 2020 2020 2066 6c6f  +) {.        flo
-000397c0: 6174 202a 2064 7374 5f64 6174 6120 3d20  at * dst_data = 
-000397d0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-000397e0: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
-000397f0: 312a 6e62 3129 3b0a 2020 2020 2020 2020  1*nb1);.        
-00039800: 666f 7220 2869 6e74 2069 3020 3d20 303b  for (int i0 = 0;
-00039810: 2069 3020 3c20 6e65 3130 3b20 2b2b 6930   i0 < ne10; ++i0
-00039820: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00039830: 6473 745f 6461 7461 5b69 305d 203d 2030  dst_data[i0] = 0
-00039840: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
-00039850: 7220 2869 6e74 206b 203d 202d 6e68 3b20  r (int k = -nh; 
-00039860: 6b20 3c3d 206e 683b 206b 2b2b 2920 7b0a  k <= nh; k++) {.
-00039870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039880: 666c 6f61 7420 7620 3d20 302e 3066 3b0a  float v = 0.0f;.
-00039890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398a0: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
-000398b0: 2865 7730 2c20 2676 2c0a 2020 2020 2020  (ew0, &v,.      
-000398c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398d0: 2020 2866 6c6f 6174 202a 2920 7061 7261    (float *) para
-000398e0: 6d73 2d3e 7764 6174 6120 2b20 2020 6931  ms->wdata +   i1
-000398f0: 2a65 7730 2a6e 6530 3020 2b20 2020 2020  *ew0*ne00 +     
-00039900: 2028 6e68 202b 206b 292a 6577 302c 0a20   (nh + k)*ew0,. 
-00039910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039920: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00039930: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
-00039940: 206e 6530 322a 6577 302a 6e65 3030 202b   ne02*ew0*ne00 +
-00039950: 2028 6930 202b 206e 6820 2b20 6b29 2a65   (i0 + nh + k)*e
-00039960: 7730 293b 0a0a 2020 2020 2020 2020 2020  w0);..          
-00039970: 2020 2020 2020 6473 745f 6461 7461 5b69        dst_data[i
-00039980: 305d 202b 3d20 763b 0a20 2020 2020 2020  0] += v;.       
-00039990: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-000399a0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-000399b0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000399c0: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
-000399d0: 3164 5f31 7328 0a20 2020 2020 2020 2063  1d_1s(.        c
-000399e0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000399f0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00039a00: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00039a10: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00039a20: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00039a30: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00039a40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00039a50: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00039a60: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00039a70: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00039a80: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-00039a90: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00039aa0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00039ab0: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
-00039ac0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00039ad0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00039ae0: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
-00039af0: 5f31 735f 6631 365f 6633 3228 7061 7261  _1s_f16_f32(para
-00039b00: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
-00039b10: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
-00039b20: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00039b30: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00039b40: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00039b50: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00039b60: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00039b70: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
-00039b80: 645f 3173 5f66 3332 2870 6172 616d 732c  d_1s_f32(params,
-00039b90: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
-00039ba0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00039bb0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00039bc0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00039bd0: 345f 303a 0a20 2020 2020 2020 2063 6173  4_0:.        cas
-00039be0: 6520 4747 4d4c 5f54 5950 455f 5134 5f31  e GGML_TYPE_Q4_1
-00039bf0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00039c00: 474d 4c5f 5459 5045 5f49 383a 0a20 2020  GML_TYPE_I8:.   
-00039c10: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00039c20: 5950 455f 4931 363a 0a20 2020 2020 2020  YPE_I16:.       
-00039c30: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00039c40: 4933 323a 0a20 2020 2020 2020 2063 6173  I32:.        cas
-00039c50: 6520 4747 4d4c 5f54 5950 455f 434f 554e  e GGML_TYPE_COUN
-00039c60: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-00039c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039c80: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00039c90: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00039ca0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00039cb0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00039cc0: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
-00039cd0: 3164 5f32 730a 0a73 7461 7469 6320 766f  1d_2s..static vo
-00039ce0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00039cf0: 666f 7277 6172 645f 636f 6e76 5f31 645f  forward_conv_1d_
-00039d00: 3273 5f66 3136 5f66 3332 280a 2020 2020  2s_f16_f32(.    
-00039d10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00039d20: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00039d30: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00039d40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00039d50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00039d60: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00039d70: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00039d80: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-00039d90: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
-00039da0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00039db0: 7220 2a20 6473 7429 207b 0a20 2020 2047  r * dst) {.    G
-00039dc0: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
-00039dd0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00039de0: 5045 5f46 3136 293b 0a20 2020 2047 474d  PE_F16);.    GGM
-00039df0: 4c5f 4153 5345 5254 2873 7263 312d 3e74  L_ASSERT(src1->t
-00039e00: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00039e10: 5f46 3332 293b 0a20 2020 2047 474d 4c5f  _F32);.    GGML_
-00039e20: 4153 5345 5254 2820 6473 742d 3e74 7970  ASSERT( dst->typ
-00039e30: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00039e40: 3332 293b 0a0a 2020 2020 696e 7436 345f  32);..    int64_
-00039e50: 7420 7430 203d 2067 676d 6c5f 7065 7266  t t0 = ggml_perf
-00039e60: 5f74 696d 655f 7573 2829 3b0a 2020 2020  _time_us();.    
-00039e70: 554e 5553 4544 2874 3029 3b0a 0a20 2020  UNUSED(t0);..   
-00039e80: 2063 6f6e 7374 2069 6e74 206e 6530 3020   const int ne00 
-00039e90: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
-00039ea0: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
-00039eb0: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
-00039ec0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00039ed0: 6530 3220 3d20 7372 6330 2d3e 6e65 5b32  e02 = src0->ne[2
-00039ee0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-00039ef0: 6e74 206e 6530 3320 3d20 7372 6330 2d3e  nt ne03 = src0->
-00039f00: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-00039f10: 7420 696e 7420 6e65 3130 203d 2073 7263  t int ne10 = src
-00039f20: 312d 3e6e 655b 305d 3b0a 2020 2020 636f  1->ne[0];.    co
-00039f30: 6e73 7420 696e 7420 6e65 3131 203d 2073  nst int ne11 = s
-00039f40: 7263 312d 3e6e 655b 315d 3b0a 2020 2020  rc1->ne[1];.    
-00039f50: 2f2f 636f 6e73 7420 696e 7420 6e65 3132  //const int ne12
-00039f60: 203d 2073 7263 312d 3e6e 655b 325d 3b0a   = src1->ne[2];.
-00039f70: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-00039f80: 6e65 3133 203d 2073 7263 312d 3e6e 655b  ne13 = src1->ne[
-00039f90: 335d 3b0a 0a20 2020 202f 2f63 6f6e 7374  3];..    //const
-00039fa0: 2069 6e74 206e 6530 2020 3d20 6473 742d   int ne0  = dst-
-00039fb0: 3e6e 655b 305d 3b0a 2020 2020 2f2f 636f  >ne[0];.    //co
-00039fc0: 6e73 7420 696e 7420 6e65 3120 203d 2064  nst int ne1  = d
-00039fd0: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 202f  st->ne[1];.    /
-00039fe0: 2f63 6f6e 7374 2069 6e74 206e 6532 2020  /const int ne2  
-00039ff0: 3d20 6473 742d 3e6e 655b 325d 3b0a 2020  = dst->ne[2];.  
-0003a000: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
-0003a010: 3320 203d 2064 7374 2d3e 6e65 5b33 5d3b  3  = dst->ne[3];
-0003a020: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0003a030: 206e 6520 2020 3d20 6e65 302a 6e65 312a   ne   = ne0*ne1*
-0003a040: 6e65 322a 6e65 333b 0a0a 2020 2020 636f  ne2*ne3;..    co
-0003a050: 6e73 7420 696e 7420 6e62 3030 203d 2073  nst int nb00 = s
-0003a060: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
-0003a070: 636f 6e73 7420 696e 7420 6e62 3031 203d  const int nb01 =
-0003a080: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
-0003a090: 2020 636f 6e73 7420 696e 7420 6e62 3032    const int nb02
-0003a0a0: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
-0003a0b0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0003a0c0: 6e62 3033 203d 2073 7263 302d 3e6e 625b  nb03 = src0->nb[
-0003a0d0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-0003a0e0: 6e74 206e 6231 3020 3d20 7372 6331 2d3e  nt nb10 = src1->
-0003a0f0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-0003a100: 2069 6e74 206e 6231 3120 3d20 7372 6331   int nb11 = src1
-0003a110: 2d3e 6e62 5b31 5d3b 0a20 2020 202f 2f63  ->nb[1];.    //c
-0003a120: 6f6e 7374 2069 6e74 206e 6231 3220 3d20  onst int nb12 = 
-0003a130: 7372 6331 2d3e 6e62 5b32 5d3b 0a20 2020  src1->nb[2];.   
-0003a140: 202f 2f63 6f6e 7374 2069 6e74 206e 6231   //const int nb1
-0003a150: 3320 3d20 7372 6331 2d3e 6e62 5b33 5d3b  3 = src1->nb[3];
-0003a160: 0a0a 2020 2020 2f2f 636f 6e73 7420 696e  ..    //const in
-0003a170: 7420 6e62 3020 203d 2064 7374 2d3e 6e62  t nb0  = dst->nb
-0003a180: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0003a190: 6e74 206e 6231 2020 3d20 6473 742d 3e6e  nt nb1  = dst->n
-0003a1a0: 625b 315d 3b0a 2020 2020 2f2f 636f 6e73  b[1];.    //cons
-0003a1b0: 7420 696e 7420 6e62 3220 203d 2064 7374  t int nb2  = dst
-0003a1c0: 2d3e 6e62 5b32 5d3b 0a20 2020 202f 2f63  ->nb[2];.    //c
-0003a1d0: 6f6e 7374 2069 6e74 206e 6233 2020 3d20  onst int nb3  = 
-0003a1e0: 6473 742d 3e6e 625b 335d 3b0a 0a20 2020  dst->nb[3];..   
-0003a1f0: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-0003a200: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-0003a210: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-0003a220: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-0003a230: 2020 2020 636f 6e73 7420 696e 7420 6e6b      const int nk
-0003a240: 203d 206e 6530 303b 0a20 2020 2063 6f6e   = ne00;.    con
-0003a250: 7374 2069 6e74 206e 6820 3d20 6e6b 2f32  st int nh = nk/2
-0003a260: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0003a270: 2065 7730 203d 2067 676d 6c5f 7570 3332   ew0 = ggml_up32
-0003a280: 286e 6530 3129 3b0a 0a20 2020 2047 474d  (ne01);..    GGM
-0003a290: 4c5f 4153 5345 5254 286e 6530 3020 2520  L_ASSERT(ne00 % 
-0003a2a0: 3220 3d3d 2031 293b 202f 2f20 544f 444f  2 == 1); // TODO
-0003a2b0: 3a20 7375 7070 6f72 7420 6576 656e 206b  : support even k
-0003a2c0: 6572 6e65 6c20 7369 7a65 730a 2020 2020  ernel sizes.    
-0003a2d0: 4747 4d4c 5f41 5353 4552 5428 6e62 3030  GGML_ASSERT(nb00
-0003a2e0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
-0003a2f0: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
-0003a300: 4d4c 5f41 5353 4552 5428 6e62 3130 203d  ML_ASSERT(nb10 =
-0003a310: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0003a320: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-0003a330: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0003a340: 5441 534b 5f49 4e49 5429 207b 0a20 2020  TASK_INIT) {.   
-0003a350: 2020 2020 202f 2f20 544f 444f 3a20 6669       // TODO: fi
-0003a360: 7820 7468 6973 206d 656d 7365 7420 2877  x this memset (w
-0003a370: 7369 7a65 2069 7320 6f76 6572 6573 7469  size is overesti
-0003a380: 6d61 7465 6429 0a20 2020 2020 2020 206d  mated).        m
-0003a390: 656d 7365 7428 7061 7261 6d73 2d3e 7764  emset(params->wd
-0003a3a0: 6174 612c 2030 2c20 7061 7261 6d73 2d3e  ata, 0, params->
-0003a3b0: 7773 697a 6529 3b0a 0a20 2020 2020 2020  wsize);..       
-0003a3c0: 202f 2f20 7072 6570 6172 6520 6b65 726e   // prepare kern
-0003a3d0: 656c 2064 6174 6120 2873 7263 3029 0a20  el data (src0). 
-0003a3e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0003a3f0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
-0003a400: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
-0003a410: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-0003a420: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
-0003a430: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
-0003a440: 2066 6f72 2028 696e 7420 6930 3220 3d20   for (int i02 = 
-0003a450: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
-0003a460: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
-0003a470: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0003a480: 2069 3031 203d 2030 3b20 6930 3120 3c20   i01 = 0; i01 < 
-0003a490: 6e65 3031 3b20 6930 312b 2b29 207b 0a20  ne01; i01++) {. 
-0003a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a4b0: 2020 2063 6f6e 7374 2067 676d 6c5f 6670     const ggml_fp
-0003a4c0: 3136 5f74 202a 2063 6f6e 7374 2073 7263  16_t * const src
-0003a4d0: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
-0003a4e0: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
-0003a4f0: 2d3e 6461 7461 202b 2069 3032 2a6e 6230  ->data + i02*nb0
-0003a500: 3220 2b20 6930 312a 6e62 3031 293b 0a20  2 + i01*nb01);. 
-0003a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a520: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
-0003a530: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
-0003a540: 6120 2b20 6930 322a 6577 302a 6e65 3030  a + i02*ew0*ne00
-0003a550: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003a560: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0003a570: 3030 203d 2030 3b20 6930 3020 3c20 6e65  00 = 0; i00 < ne
-0003a580: 3030 3b20 6930 302b 2b29 207b 0a20 2020  00; i00++) {.   
-0003a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a5a0: 2020 2020 2064 7374 5f64 6174 615b 6930       dst_data[i0
-0003a5b0: 302a 6577 3020 2b20 6930 315d 203d 2073  0*ew0 + i01] = s
-0003a5c0: 7263 5b69 3030 5d3b 0a20 2020 2020 2020  rc[i00];.       
-0003a5d0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0003a5e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003a5f0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0003a600: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0003a610: 2020 2f2f 2070 7265 7061 7265 2073 6f75    // prepare sou
-0003a620: 7263 6520 6461 7461 2028 7372 6331 290a  rce data (src1).
-0003a630: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0003a640: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-0003a650: 7420 2a20 636f 6e73 7420 7764 6174 6120  t * const wdata 
-0003a660: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
-0003a670: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-0003a680: 2b20 6e65 3032 2a65 7730 2a6e 6530 303b  + ne02*ew0*ne00;
-0003a690: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-0003a6a0: 7220 2869 6e74 2069 3131 203d 2030 3b20  r (int i11 = 0; 
-0003a6b0: 6931 3120 3c20 6e65 3131 3b20 6931 312b  i11 < ne11; i11+
-0003a6c0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0003a6d0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-0003a6e0: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
-0003a6f0: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-0003a700: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
-0003a710: 3131 2a6e 6231 3129 3b0a 2020 2020 2020  11*nb11);.      
-0003a720: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-0003a730: 7031 365f 7420 2a20 6473 745f 6461 7461  p16_t * dst_data
-0003a740: 203d 2077 6461 7461 3b0a 2020 2020 2020   = wdata;.      
-0003a750: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0003a760: 6e74 2069 3130 203d 2030 3b20 6931 3020  nt i10 = 0; i10 
-0003a770: 3c20 6e65 3130 3b20 6931 302b 2b29 207b  < ne10; i10++) {
-0003a780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a790: 2020 2020 2064 7374 5f64 6174 615b 2869       dst_data[(i
-0003a7a0: 3130 202b 206e 6829 2a65 7730 202b 2069  10 + nh)*ew0 + i
-0003a7b0: 3131 5d20 3d20 4747 4d4c 5f46 5033 325f  11] = GGML_FP32_
-0003a7c0: 544f 5f46 5031 3628 7372 635b 6931 305d  TO_FP16(src[i10]
-0003a7d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0003a7e0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0003a7f0: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-0003a800: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0003a810: 2020 7d0a 0a20 2020 2069 6620 2870 6172    }..    if (par
-0003a820: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0003a830: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-0003a840: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-0003a850: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
-0003a860: 2074 6f74 616c 2072 6f77 7320 696e 2064   total rows in d
-0003a870: 7374 0a20 2020 2063 6f6e 7374 2069 6e74  st.    const int
-0003a880: 206e 7220 3d20 6e65 3032 3b0a 0a20 2020   nr = ne02;..   
-0003a890: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
-0003a8a0: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-0003a8b0: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
-0003a8c0: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
-0003a8d0: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
-0003a8e0: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
-0003a8f0: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
-0003a900: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
-0003a910: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
-0003a920: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
-0003a930: 0a20 2020 2066 6f72 2028 696e 7420 6931  .    for (int i1
-0003a940: 203d 2069 7230 3b20 6931 203c 2069 7231   = ir0; i1 < ir1
-0003a950: 3b20 6931 2b2b 2920 7b0a 2020 2020 2020  ; i1++) {.      
-0003a960: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
-0003a970: 7461 203d 2028 666c 6f61 7420 2a29 2828  ta = (float *)((
-0003a980: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-0003a990: 6120 2b20 6931 2a6e 6231 293b 0a20 2020  a + i1*nb1);.   
-0003a9a0: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
-0003a9b0: 203d 2030 3b20 6930 203c 206e 6531 303b   = 0; i0 < ne10;
-0003a9c0: 2069 3020 2b3d 2032 2920 7b0a 2020 2020   i0 += 2) {.    
-0003a9d0: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-0003a9e0: 5b69 302f 325d 203d 2030 3b0a 2020 2020  [i0/2] = 0;.    
-0003a9f0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0003aa00: 206b 203d 202d 6e68 3b20 6b20 3c3d 206e   k = -nh; k <= n
-0003aa10: 683b 206b 2b2b 2920 7b0a 2020 2020 2020  h; k++) {.      
-0003aa20: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-0003aa30: 7620 3d20 302e 3066 3b0a 2020 2020 2020  v = 0.0f;.      
-0003aa40: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0003aa50: 6563 5f64 6f74 5f66 3136 2865 7730 2c20  ec_dot_f16(ew0, 
-0003aa60: 2676 2c0a 2020 2020 2020 2020 2020 2020  &v,.            
-0003aa70: 2020 2020 2020 2020 2020 2020 2867 676d              (ggm
-0003aa80: 6c5f 6670 3136 5f74 202a 2920 7061 7261  l_fp16_t *) para
-0003aa90: 6d73 2d3e 7764 6174 6120 2b20 2020 6931  ms->wdata +   i1
-0003aaa0: 2a65 7730 2a6e 6530 3020 2b20 2020 2020  *ew0*ne00 +     
-0003aab0: 2028 6e68 202b 206b 292a 6577 302c 0a20   (nh + k)*ew0,. 
-0003aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aad0: 2020 2020 2020 2028 6767 6d6c 5f66 7031         (ggml_fp1
-0003aae0: 365f 7420 2a29 2070 6172 616d 732d 3e77  6_t *) params->w
-0003aaf0: 6461 7461 202b 206e 6530 322a 6577 302a  data + ne02*ew0*
-0003ab00: 6e65 3030 202b 2028 6930 202b 206e 6820  ne00 + (i0 + nh 
-0003ab10: 2b20 6b29 2a65 7730 293b 0a0a 2020 2020  + k)*ew0);..    
-0003ab20: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0003ab30: 6461 7461 5b69 302f 325d 202b 3d20 763b  data[i0/2] += v;
-0003ab40: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0003ab50: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
-0003ab60: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-0003ab70: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0003ab80: 7264 5f63 6f6e 765f 3164 5f32 735f 6633  rd_conv_1d_2s_f3
-0003ab90: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
-0003aba0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-0003abb0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-0003abc0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-0003abd0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0003abe0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-0003abf0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0003ac00: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0003ac10: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-0003ac20: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0003ac30: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-0003ac40: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-0003ac50: 5428 7372 6330 2d3e 7479 7065 203d 3d20  T(src0->type == 
-0003ac60: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
-0003ac70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003ac80: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-0003ac90: 4d4c 5f54 5950 455f 4633 3229 3b0a 2020  ML_TYPE_F32);.  
-0003aca0: 2020 4747 4d4c 5f41 5353 4552 5428 2064    GGML_ASSERT( d
-0003acb0: 7374 2d3e 7479 7065 203d 3d20 4747 4d4c  st->type == GGML
-0003acc0: 5f54 5950 455f 4633 3229 3b0a 0a20 2020  _TYPE_F32);..   
-0003acd0: 2069 6e74 3634 5f74 2074 3020 3d20 6767   int64_t t0 = gg
-0003ace0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-0003acf0: 293b 0a20 2020 2055 4e55 5345 4428 7430  );.    UNUSED(t0
-0003ad00: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-0003ad10: 7420 6e65 3030 203d 2073 7263 302d 3e6e  t ne00 = src0->n
-0003ad20: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0003ad30: 696e 7420 6e65 3031 203d 2073 7263 302d  int ne01 = src0-
-0003ad40: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-0003ad50: 7420 696e 7420 6e65 3032 203d 2073 7263  t int ne02 = src
-0003ad60: 302d 3e6e 655b 325d 3b0a 2020 2020 2f2f  0->ne[2];.    //
-0003ad70: 636f 6e73 7420 696e 7420 6e65 3033 203d  const int ne03 =
-0003ad80: 2073 7263 302d 3e6e 655b 335d 3b0a 0a20   src0->ne[3];.. 
-0003ad90: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
-0003ada0: 3020 3d20 7372 6331 2d3e 6e65 5b30 5d3b  0 = src1->ne[0];
-0003adb0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0003adc0: 6531 3120 3d20 7372 6331 2d3e 6e65 5b31  e11 = src1->ne[1
-0003add0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-0003ade0: 6e74 206e 6531 3220 3d20 7372 6331 2d3e  nt ne12 = src1->
-0003adf0: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-0003ae00: 7374 2069 6e74 206e 6531 3320 3d20 7372  st int ne13 = sr
-0003ae10: 6331 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c1->ne[3];..    
-0003ae20: 2f2f 636f 6e73 7420 696e 7420 6e65 3020  //const int ne0 
-0003ae30: 203d 2064 7374 2d3e 6e65 5b30 5d3b 0a20   = dst->ne[0];. 
-0003ae40: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0003ae50: 6531 2020 3d20 6473 742d 3e6e 655b 315d  e1  = dst->ne[1]
-0003ae60: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0003ae70: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
-0003ae80: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-0003ae90: 2069 6e74 206e 6533 2020 3d20 6473 742d   int ne3  = dst-
-0003aea0: 3e6e 655b 335d 3b0a 2020 2020 2f2f 636f  >ne[3];.    //co
-0003aeb0: 6e73 7420 696e 7420 6e65 2020 203d 206e  nst int ne   = n
-0003aec0: 6530 2a6e 6531 2a6e 6532 2a6e 6533 3b0a  e0*ne1*ne2*ne3;.
-0003aed0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0003aee0: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
-0003aef0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0003af00: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
-0003af10: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-0003af20: 6e74 206e 6230 3220 3d20 7372 6330 2d3e  nt nb02 = src0->
-0003af30: 6e62 5b32 5d3b 0a20 2020 202f 2f63 6f6e  nb[2];.    //con
-0003af40: 7374 2069 6e74 206e 6230 3320 3d20 7372  st int nb03 = sr
-0003af50: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
-0003af60: 636f 6e73 7420 696e 7420 6e62 3130 203d  const int nb10 =
-0003af70: 2073 7263 312d 3e6e 625b 305d 3b0a 2020   src1->nb[0];.  
-0003af80: 2020 636f 6e73 7420 696e 7420 6e62 3131    const int nb11
-0003af90: 203d 2073 7263 312d 3e6e 625b 315d 3b0a   = src1->nb[1];.
-0003afa0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0003afb0: 6e62 3132 203d 2073 7263 312d 3e6e 625b  nb12 = src1->nb[
-0003afc0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-0003afd0: 696e 7420 6e62 3133 203d 2073 7263 312d  int nb13 = src1-
-0003afe0: 3e6e 625b 335d 3b0a 0a20 2020 202f 2f63  >nb[3];..    //c
-0003aff0: 6f6e 7374 2069 6e74 206e 6230 2020 3d20  onst int nb0  = 
-0003b000: 6473 742d 3e6e 625b 305d 3b0a 2020 2020  dst->nb[0];.    
-0003b010: 636f 6e73 7420 696e 7420 6e62 3120 203d  const int nb1  =
-0003b020: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
-0003b030: 202f 2f63 6f6e 7374 2069 6e74 206e 6232   //const int nb2
-0003b040: 2020 3d20 6473 742d 3e6e 625b 325d 3b0a    = dst->nb[2];.
-0003b050: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0003b060: 6e62 3320 203d 2064 7374 2d3e 6e62 5b33  nb3  = dst->nb[3
-0003b070: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-0003b080: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
-0003b090: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0003b0a0: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
-0003b0b0: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
-0003b0c0: 2069 6e74 206e 6b20 3d20 6e65 3030 3b0a   int nk = ne00;.
-0003b0d0: 2020 2020 636f 6e73 7420 696e 7420 6e68      const int nh
-0003b0e0: 203d 206e 6b2f 323b 0a0a 2020 2020 636f   = nk/2;..    co
-0003b0f0: 6e73 7420 696e 7420 6577 3020 3d20 6767  nst int ew0 = gg
-0003b100: 6d6c 5f75 7033 3228 6e65 3031 293b 0a0a  ml_up32(ne01);..
-0003b110: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003b120: 6e65 3030 2025 2032 203d 3d20 3129 3b20  ne00 % 2 == 1); 
-0003b130: 2f2f 2054 4f44 4f3a 2073 7570 706f 7274  // TODO: support
-0003b140: 2065 7665 6e20 6b65 726e 656c 2073 697a   even kernel siz
-0003b150: 6573 0a20 2020 2047 474d 4c5f 4153 5345  es.    GGML_ASSE
-0003b160: 5254 286e 6230 3020 3d3d 2073 697a 656f  RT(nb00 == sizeo
-0003b170: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
-0003b180: 474d 4c5f 4153 5345 5254 286e 6231 3020  GML_ASSERT(nb10 
-0003b190: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-0003b1a0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
-0003b1b0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-0003b1c0: 5f54 4153 4b5f 494e 4954 2920 7b0a 2020  _TASK_INIT) {.  
-0003b1d0: 2020 2020 2020 2f2f 2054 4f44 4f3a 2066        // TODO: f
-0003b1e0: 6978 2074 6869 7320 6d65 6d73 6574 2028  ix this memset (
-0003b1f0: 7773 697a 6520 6973 206f 7665 7265 7374  wsize is overest
-0003b200: 696d 6174 6564 290a 2020 2020 2020 2020  imated).        
-0003b210: 6d65 6d73 6574 2870 6172 616d 732d 3e77  memset(params->w
-0003b220: 6461 7461 2c20 302c 2070 6172 616d 732d  data, 0, params-
-0003b230: 3e77 7369 7a65 293b 0a0a 2020 2020 2020  >wsize);..      
-0003b240: 2020 2f2f 2070 7265 7061 7265 206b 6572    // prepare ker
-0003b250: 6e65 6c20 6461 7461 2028 7372 6330 290a  nel data (src0).
-0003b260: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0003b270: 2020 2020 2020 666c 6f61 7420 2a20 636f        float * co
-0003b280: 6e73 7420 7764 6174 6120 3d20 2866 6c6f  nst wdata = (flo
-0003b290: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-0003b2a0: 6174 6120 2b20 303b 0a0a 2020 2020 2020  ata + 0;..      
-0003b2b0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0003b2c0: 3032 203d 2030 3b20 6930 3220 3c20 6e65  02 = 0; i02 < ne
-0003b2d0: 3032 3b20 6930 322b 2b29 207b 0a20 2020  02; i02++) {.   
-0003b2e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003b2f0: 2028 696e 7420 6930 3120 3d20 303b 2069   (int i01 = 0; i
-0003b300: 3031 203c 206e 6530 313b 2069 3031 2b2b  01 < ne01; i01++
-0003b310: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003b320: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0003b330: 6f61 7420 2a20 636f 6e73 7420 7372 6320  oat * const src 
-0003b340: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
-0003b350: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0003b360: 2b20 6930 322a 6e62 3032 202b 2069 3031  + i02*nb02 + i01
-0003b370: 2a6e 6230 3129 3b0a 2020 2020 2020 2020  *nb01);.        
-0003b380: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0003b390: 7420 2a20 6473 745f 6461 7461 203d 2077  t * dst_data = w
-0003b3a0: 6461 7461 202b 2069 3032 2a65 7730 2a6e  data + i02*ew0*n
-0003b3b0: 6530 303b 0a20 2020 2020 2020 2020 2020  e00;.           
-0003b3c0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0003b3d0: 7420 6930 3020 3d20 303b 2069 3030 203c  t i00 = 0; i00 <
-0003b3e0: 206e 6530 303b 2069 3030 2b2b 2920 7b0a   ne00; i00++) {.
-0003b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b400: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-0003b410: 5b69 3030 2a65 7730 202b 2069 3031 5d20  [i00*ew0 + i01] 
-0003b420: 3d20 7372 635b 6930 305d 3b0a 2020 2020  = src[i00];.    
-0003b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b440: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003b450: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003b460: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0003b470: 2020 2020 202f 2f20 7072 6570 6172 6520       // prepare 
-0003b480: 736f 7572 6365 2064 6174 6120 2873 7263  source data (src
-0003b490: 3129 0a20 2020 2020 2020 207b 0a20 2020  1).        {.   
-0003b4a0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-0003b4b0: 2063 6f6e 7374 2077 6461 7461 203d 2028   const wdata = (
-0003b4c0: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
-0003b4d0: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
-0003b4e0: 302a 6e65 3030 3b0a 0a20 2020 2020 2020  0*ne00;..       
-0003b4f0: 2020 2020 2066 6f72 2028 696e 7420 6931       for (int i1
-0003b500: 3120 3d20 303b 2069 3131 203c 206e 6531  1 = 0; i11 < ne1
-0003b510: 313b 2069 3131 2b2b 2920 7b0a 2020 2020  1; i11++) {.    
-0003b520: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0003b530: 7420 666c 6f61 7420 2a20 636f 6e73 7420  t float * const 
-0003b540: 7372 6320 3d20 2866 6c6f 6174 202a 2928  src = (float *)(
-0003b550: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
-0003b560: 6174 6120 2b20 6931 312a 6e62 3131 293b  ata + i11*nb11);
-0003b570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b580: 2066 6c6f 6174 202a 2064 7374 5f64 6174   float * dst_dat
-0003b590: 6120 3d20 7764 6174 613b 0a20 2020 2020  a = wdata;.     
-0003b5a0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0003b5b0: 696e 7420 6931 3020 3d20 303b 2069 3130  int i10 = 0; i10
-0003b5c0: 203c 206e 6531 303b 2069 3130 2b2b 2920   < ne10; i10++) 
-0003b5d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003b5e0: 2020 2020 2020 6473 745f 6461 7461 5b28        dst_data[(
-0003b5f0: 6931 3020 2b20 6e68 292a 6577 3020 2b20  i10 + nh)*ew0 + 
-0003b600: 6931 315d 203d 2073 7263 5b69 3130 5d3b  i11] = src[i10];
-0003b610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b620: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0003b630: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0003b640: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-0003b650: 7d0a 0a20 2020 2069 6620 2870 6172 616d  }..    if (param
-0003b660: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0003b670: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-0003b680: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-0003b690: 0a20 2020 207d 0a0a 2020 2020 2f2f 2074  .    }..    // t
-0003b6a0: 6f74 616c 2072 6f77 7320 696e 2064 7374  otal rows in dst
-0003b6b0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0003b6c0: 7220 3d20 6e65 3032 3b0a 0a20 2020 202f  r = ne02;..    /
-0003b6d0: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-0003b6e0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-0003b6f0: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-0003b700: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-0003b710: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-0003b720: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-0003b730: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-0003b740: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-0003b750: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-0003b760: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-0003b770: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
-0003b780: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
-0003b790: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
-0003b7a0: 666c 6f61 7420 2a20 6473 745f 6461 7461  float * dst_data
-0003b7b0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-0003b7c0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-0003b7d0: 2b20 6931 2a6e 6231 293b 0a20 2020 2020  + i1*nb1);.     
-0003b7e0: 2020 2066 6f72 2028 696e 7420 6930 203d     for (int i0 =
-0003b7f0: 2030 3b20 6930 203c 206e 6531 303b 2069   0; i0 < ne10; i
-0003b800: 3020 2b3d 2032 2920 7b0a 2020 2020 2020  0 += 2) {.      
-0003b810: 2020 2020 2020 6473 745f 6461 7461 5b69        dst_data[i
-0003b820: 302f 325d 203d 2030 3b0a 2020 2020 2020  0/2] = 0;.      
-0003b830: 2020 2020 2020 666f 7220 2869 6e74 206b        for (int k
-0003b840: 203d 202d 6e68 3b20 6b20 3c3d 206e 683b   = -nh; k <= nh;
-0003b850: 206b 2b2b 2920 7b0a 2020 2020 2020 2020   k++) {.        
-0003b860: 2020 2020 2020 2020 666c 6f61 7420 7620          float v 
-0003b870: 3d20 302e 3066 3b0a 2020 2020 2020 2020  = 0.0f;.        
-0003b880: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0003b890: 5f64 6f74 5f66 3332 2865 7730 2c20 2676  _dot_f32(ew0, &v
-0003b8a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003b8b0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-0003b8c0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
-0003b8d0: 6120 2b20 2020 6931 2a65 7730 2a6e 6530  a +   i1*ew0*ne0
-0003b8e0: 3020 2b20 2020 2020 2028 6e68 202b 206b  0 +      (nh + k
-0003b8f0: 292a 6577 302c 0a20 2020 2020 2020 2020  )*ew0,.         
-0003b900: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0003b910: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
-0003b920: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
-0003b930: 302a 6e65 3030 202b 2028 6930 202b 206e  0*ne00 + (i0 + n
-0003b940: 6820 2b20 6b29 2a65 7730 293b 0a0a 2020  h + k)*ew0);..  
-0003b950: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-0003b960: 745f 6461 7461 5b69 302f 325d 202b 3d20  t_data[i0/2] += 
-0003b970: 763b 0a20 2020 2020 2020 2020 2020 207d  v;.            }
-0003b980: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0003b990: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-0003b9a0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0003b9b0: 7761 7264 5f63 6f6e 765f 3164 5f32 7328  ward_conv_1d_2s(
-0003b9c0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0003b9d0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0003b9e0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0003b9f0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0003ba00: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0003ba10: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0003ba20: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0003ba30: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0003ba40: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-0003ba50: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0003ba60: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-0003ba70: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-0003ba80: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-0003ba90: 2047 474d 4c5f 5459 5045 5f46 3136 3a0a   GGML_TYPE_F16:.
-0003baa0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0003bab0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0003bac0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0003bad0: 7264 5f63 6f6e 765f 3164 5f32 735f 6631  rd_conv_1d_2s_f1
-0003bae0: 365f 6633 3228 7061 7261 6d73 2c20 7372  6_f32(params, sr
-0003baf0: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-0003bb00: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0003bb10: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0003bb20: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-0003bb30: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0003bb40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0003bb50: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0003bb60: 6172 645f 636f 6e76 5f31 645f 3273 5f66  ard_conv_1d_2s_f
-0003bb70: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-0003bb80: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-0003bb90: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0003bba0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0003bbb0: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
-0003bbc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0003bbd0: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
-0003bbe0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0003bbf0: 5045 5f49 383a 0a20 2020 2020 2020 2063  PE_I8:.        c
-0003bc00: 6173 6520 4747 4d4c 5f54 5950 455f 4931  ase GGML_TYPE_I1
-0003bc10: 363a 0a20 2020 2020 2020 2063 6173 6520  6:.        case 
-0003bc20: 4747 4d4c 5f54 5950 455f 4933 323a 0a20  GGML_TYPE_I32:. 
-0003bc30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0003bc40: 5f54 5950 455f 434f 554e 543a 0a20 2020  _TYPE_COUNT:.   
-0003bc50: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0003bc60: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0003bc70: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-0003bc80: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0003bc90: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-0003bca0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0003bcb0: 7761 7264 5f66 6c61 7368 5f61 7474 6e0a  ward_flash_attn.
-0003bcc0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0003bcd0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0003bce0: 645f 666c 6173 685f 6174 746e 5f66 3332  d_flash_attn_f32
-0003bcf0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-0003bd00: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-0003bd10: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-0003bd20: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-0003bd30: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0003bd40: 656e 736f 7220 2a20 712c 0a20 2020 2020  ensor * q,.     
-0003bd50: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0003bd60: 6767 6d6c 5f74 656e 736f 7220 2a20 6b2c  ggml_tensor * k,
-0003bd70: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0003bd80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0003bd90: 7220 2a20 762c 0a20 2020 2020 2020 2063  r * v,.        c
-0003bda0: 6f6e 7374 2062 6f6f 6c20 6d61 736b 6564  onst bool masked
-0003bdb0: 2c0a 2020 2020 2020 2020 2020 2020 2073  ,.             s
-0003bdc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0003bdd0: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
-0003bde0: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
-0003bdf0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
-0003be00: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
-0003be10: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0003be20: 6e65 7130 203d 2071 2d3e 6e65 5b30 5d3b  neq0 = q->ne[0];
-0003be30: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0003be40: 6571 3120 3d20 712d 3e6e 655b 315d 3b0a  eq1 = q->ne[1];.
-0003be50: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-0003be60: 7132 203d 2071 2d3e 6e65 5b32 5d3b 0a20  q2 = q->ne[2];. 
-0003be70: 2020 2063 6f6e 7374 2069 6e74 206e 6571     const int neq
-0003be80: 3320 3d20 712d 3e6e 655b 335d 3b0a 0a20  3 = q->ne[3];.. 
-0003be90: 2020 2063 6f6e 7374 2069 6e74 206e 656b     const int nek
-0003bea0: 3020 3d20 6b2d 3e6e 655b 305d 3b0a 2020  0 = k->ne[0];.  
-0003beb0: 2020 636f 6e73 7420 696e 7420 6e65 6b31    const int nek1
-0003bec0: 203d 206b 2d3e 6e65 5b31 5d3b 0a20 2020   = k->ne[1];.   
-0003bed0: 202f 2f63 6f6e 7374 2069 6e74 206e 656b   //const int nek
-0003bee0: 3220 3d20 6b2d 3e6e 655b 325d 3b0a 2020  2 = k->ne[2];.  
-0003bef0: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
-0003bf00: 6b33 203d 206b 2d3e 6e65 5b33 5d3b 0a0a  k3 = k->ne[3];..
-0003bf10: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0003bf20: 6e65 7630 203d 2076 2d3e 6e65 5b30 5d3b  nev0 = v->ne[0];
-0003bf30: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0003bf40: 6576 3120 3d20 762d 3e6e 655b 315d 3b0a  ev1 = v->ne[1];.
-0003bf50: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0003bf60: 6e65 7632 203d 2076 2d3e 6e65 5b32 5d3b  nev2 = v->ne[2];
-0003bf70: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0003bf80: 206e 6576 3320 3d20 762d 3e6e 655b 335d   nev3 = v->ne[3]
-0003bf90: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0003bfa0: 206e 6530 2020 3d20 6473 742d 3e6e 655b   ne0  = dst->ne[
-0003bfb0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0003bfc0: 7420 6e65 3120 203d 2064 7374 2d3e 6e65  t ne1  = dst->ne
-0003bfd0: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-0003bfe0: 2069 6e74 206e 6532 2020 3d20 6473 742d   int ne2  = dst-
-0003bff0: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
-0003c000: 6e73 7420 696e 7420 6e65 3320 203d 2064  nst int ne3  = d
-0003c010: 7374 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  st->ne[3];..    
-0003c020: 636f 6e73 7420 696e 7420 6e62 6b30 203d  const int nbk0 =
-0003c030: 206b 2d3e 6e62 5b30 5d3b 0a20 2020 2063   k->nb[0];.    c
-0003c040: 6f6e 7374 2069 6e74 206e 626b 3120 3d20  onst int nbk1 = 
-0003c050: 6b2d 3e6e 625b 315d 3b0a 2020 2020 636f  k->nb[1];.    co
-0003c060: 6e73 7420 696e 7420 6e62 6b32 203d 206b  nst int nbk2 = k
-0003c070: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-0003c080: 7374 2069 6e74 206e 626b 3320 3d20 6b2d  st int nbk3 = k-
-0003c090: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-0003c0a0: 7374 2069 6e74 206e 6271 3020 3d20 712d  st int nbq0 = q-
-0003c0b0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0003c0c0: 7420 696e 7420 6e62 7131 203d 2071 2d3e  t int nbq1 = q->
-0003c0d0: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-0003c0e0: 2069 6e74 206e 6271 3220 3d20 712d 3e6e   int nbq2 = q->n
-0003c0f0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-0003c100: 696e 7420 6e62 7133 203d 2071 2d3e 6e62  int nbq3 = q->nb
-0003c110: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0003c120: 696e 7420 6e62 7630 203d 2076 2d3e 6e62  int nbv0 = v->nb
-0003c130: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0003c140: 6e74 206e 6276 3120 3d20 762d 3e6e 625b  nt nbv1 = v->nb[
-0003c150: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0003c160: 7420 6e62 7632 203d 2076 2d3e 6e62 5b32  t nbv2 = v->nb[2
-0003c170: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0003c180: 206e 6276 3320 3d20 762d 3e6e 625b 335d   nbv3 = v->nb[3]
-0003c190: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0003c1a0: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
-0003c1b0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0003c1c0: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
-0003c1d0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-0003c1e0: 6e74 206e 6232 2020 3d20 6473 742d 3e6e  nt nb2  = dst->n
-0003c1f0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-0003c200: 696e 7420 6e62 3320 203d 2064 7374 2d3e  int nb3  = dst->
-0003c210: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-0003c220: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-0003c230: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
-0003c240: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-0003c250: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
-0003c260: 6f6e 7374 2069 6e74 2044 203d 206e 6571  onst int D = neq
-0003c270: 303b 0a20 2020 2063 6f6e 7374 2069 6e74  0;.    const int
-0003c280: 204e 203d 206e 6571 313b 0a20 2020 2063   N = neq1;.    c
-0003c290: 6f6e 7374 2069 6e74 2050 203d 206e 656b  onst int P = nek
-0003c2a0: 3120 2d20 4e3b 0a20 2020 2063 6f6e 7374  1 - N;.    const
-0003c2b0: 2069 6e74 204d 203d 2050 202b 204e 3b0a   int M = P + N;.
-0003c2c0: 0a20 2020 2063 6f6e 7374 2069 6e74 204d  .    const int M
-0003c2d0: 7570 203d 2067 676d 6c5f 7570 284d 2c20  up = ggml_up(M, 
-0003c2e0: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
-0003c2f0: 524f 4c4c 293b 0a0a 2020 2020 4747 4d4c  ROLL);..    GGML
-0003c300: 5f41 5353 4552 5428 6e65 3020 3d3d 2044  _ASSERT(ne0 == D
-0003c310: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0003c320: 5254 286e 6531 203d 3d20 4e29 3b0a 2020  RT(ne1 == N);.  
-0003c330: 2020 4747 4d4c 5f41 5353 4552 5428 5020    GGML_ASSERT(P 
-0003c340: 3e3d 2030 293b 0a0a 2020 2020 4747 4d4c  >= 0);..    GGML
-0003c350: 5f41 5353 4552 5428 6e62 7130 203d 3d20  _ASSERT(nbq0 == 
-0003c360: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-0003c370: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003c380: 6e62 6b30 203d 3d20 7369 7a65 6f66 2866  nbk0 == sizeof(f
-0003c390: 6c6f 6174 2929 3b0a 2020 2020 4747 4d4c  loat));.    GGML
-0003c3a0: 5f41 5353 4552 5428 6e62 7630 203d 3d20  _ASSERT(nbv0 == 
-0003c3b0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-0003c3c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0003c3d0: 286e 6571 3020 3d3d 2044 293b 0a20 2020  (neq0 == D);.   
-0003c3e0: 2047 474d 4c5f 4153 5345 5254 286e 656b   GGML_ASSERT(nek
-0003c3f0: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
-0003c400: 4c5f 4153 5345 5254 286e 6576 3120 3d3d  L_ASSERT(nev1 ==
-0003c410: 2044 293b 0a0a 2020 2020 4747 4d4c 5f41   D);..    GGML_A
-0003c420: 5353 4552 5428 6e65 7131 203d 3d20 4e29  SSERT(neq1 == N)
-0003c430: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0003c440: 5428 6e65 6b31 203d 3d20 4e20 2b20 5029  T(nek1 == N + P)
-0003c450: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0003c460: 5428 6e65 7631 203d 3d20 4429 3b0a 0a20  T(nev1 == D);.. 
-0003c470: 2020 202f 2f20 6473 7420 6361 6e6e 6f74     // dst cannot
-0003c480: 2062 6520 7472 616e 7370 6f73 6564 206f   be transposed o
-0003c490: 7220 7065 726d 7574 6564 0a20 2020 2047  r permuted.    G
-0003c4a0: 474d 4c5f 4153 5345 5254 286e 6230 203d  GML_ASSERT(nb0 =
-0003c4b0: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0003c4c0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0003c4d0: 5428 6e62 3020 3c3d 206e 6231 293b 0a20  T(nb0 <= nb1);. 
-0003c4e0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0003c4f0: 6231 203c 3d20 6e62 3229 3b0a 2020 2020  b1 <= nb2);.    
-0003c500: 4747 4d4c 5f41 5353 4552 5428 6e62 3220  GGML_ASSERT(nb2 
-0003c510: 3c3d 206e 6233 293b 0a0a 2020 2020 6966  <= nb3);..    if
-0003c520: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-0003c530: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-0003c540: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-0003c550: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
-0003c560: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-0003c570: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-0003c580: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-0003c590: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-0003c5a0: 2020 2020 2f2f 2070 6172 616c 6c65 6c69      // paralleli
-0003c5b0: 7a65 2062 7920 7120 726f 7773 2075 7369  ze by q rows usi
-0003c5c0: 6e67 2067 676d 6c5f 7665 635f 646f 745f  ng ggml_vec_dot_
-0003c5d0: 6633 320a 0a20 2020 202f 2f20 746f 7461  f32..    // tota
-0003c5e0: 6c20 726f 7773 2069 6e20 710a 2020 2020  l rows in q.    
-0003c5f0: 636f 6e73 7420 696e 7420 6e72 203d 206e  const int nr = n
-0003c600: 6571 312a 6e65 7132 2a6e 6571 333b 0a0a  eq1*neq2*neq3;..
-0003c610: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
-0003c620: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-0003c630: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
-0003c640: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
-0003c650: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
-0003c660: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
-0003c670: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-0003c680: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
-0003c690: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
-0003c6a0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
-0003c6b0: 293b 0a0a 2020 2020 636f 6e73 7420 666c  );..    const fl
-0003c6c0: 6f61 7420 7363 616c 6520 3d20 312e 302f  oat scale = 1.0/
-0003c6d0: 7371 7274 2828 646f 7562 6c65 2920 4429  sqrt((double) D)
-0003c6e0: 3b0a 0a20 2020 202f 2f70 7269 6e74 6628  ;..    //printf(
-0003c6f0: 2250 3d25 6420 4e3d 2564 2044 3d25 6420  "P=%d N=%d D=%d 
-0003c700: 6972 303d 2564 2069 7231 3d25 6420 7363  ir0=%d ir1=%d sc
-0003c710: 616c 6520 3d20 2566 5c6e 222c 2050 2c20  ale = %f\n", P, 
-0003c720: 4e2c 2044 2c20 6972 302c 2069 7231 2c20  N, D, ir0, ir1, 
-0003c730: 7363 616c 6529 3b0a 0a20 2020 2066 6f72  scale);..    for
-0003c740: 2028 696e 7420 6972 203d 2069 7230 3b20   (int ir = ir0; 
-0003c750: 6972 203c 2069 7231 3b20 2b2b 6972 2920  ir < ir1; ++ir) 
-0003c760: 7b0a 2020 2020 2020 2020 2f2f 2071 2069  {.        // q i
-0003c770: 6e64 6963 6573 0a20 2020 2020 2020 2063  ndices.        c
-0003c780: 6f6e 7374 2069 6e74 2069 7133 203d 2069  onst int iq3 = i
-0003c790: 722f 286e 6571 322a 6e65 7131 293b 0a20  r/(neq2*neq1);. 
-0003c7a0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0003c7b0: 2069 7132 203d 2028 6972 202d 2069 7133   iq2 = (ir - iq3
-0003c7c0: 2a6e 6571 322a 6e65 7131 292f 6e65 7131  *neq2*neq1)/neq1
-0003c7d0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0003c7e0: 696e 7420 6971 3120 3d20 2869 7220 2d20  int iq1 = (ir - 
-0003c7f0: 6971 332a 6e65 7132 2a6e 6571 3120 2d20  iq3*neq2*neq1 - 
-0003c800: 6971 322a 6e65 7131 293b 0a0a 2020 2020  iq2*neq1);..    
-0003c810: 2020 2020 666c 6f61 7420 2a20 5320 3d20      float * S = 
-0003c820: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
-0003c830: 2d3e 7764 6174 6120 2b20 6974 682a 284d  ->wdata + ith*(M
-0003c840: 7570 202b 2043 4143 4845 5f4c 494e 455f  up + CACHE_LINE_
-0003c850: 5349 5a45 5f46 3332 293b 0a0a 2020 2020  SIZE_F32);..    
-0003c860: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-0003c870: 204d 3b20 6920 3c20 4d75 703b 202b 2b69   M; i < Mup; ++i
-0003c880: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003c890: 535b 695d 203d 202d 494e 4649 4e49 5459  S[i] = -INFINITY
-0003c8a0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-0003c8b0: 2020 2020 2066 6f72 2028 696e 7420 6963       for (int ic
-0003c8c0: 203d 2030 3b20 6963 203c 206e 656b 313b   = 0; ic < nek1;
-0003c8d0: 202b 2b69 6329 207b 0a20 2020 2020 2020   ++ic) {.       
-0003c8e0: 2020 2020 202f 2f20 6b20 696e 6469 6365       // k indice
-0003c8f0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
-0003c900: 6e73 7420 696e 7420 696b 3320 3d20 6971  nst int ik3 = iq
-0003c910: 333b 0a20 2020 2020 2020 2020 2020 2063  3;.            c
-0003c920: 6f6e 7374 2069 6e74 2069 6b32 203d 2069  onst int ik2 = i
-0003c930: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-0003c940: 636f 6e73 7420 696e 7420 696b 3120 3d20  const int ik1 = 
-0003c950: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
-0003c960: 202f 2f20 5320 696e 6469 6365 730a 2020   // S indices.  
-0003c970: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0003c980: 696e 7420 6931 203d 2069 6b31 3b0a 0a20  int i1 = ik1;.. 
-0003c990: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0003c9a0: 7665 635f 646f 745f 6633 3228 6e65 7130  vec_dot_f32(neq0
-0003c9b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003c9c0: 2020 2020 2020 5320 2b20 6931 2c0a 2020        S + i1,.  
-0003c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c9e0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-0003c9f0: 6172 202a 2920 6b2d 3e64 6174 6120 2b20  ar *) k->data + 
-0003ca00: 2869 6b31 2a6e 626b 3120 2b20 696b 322a  (ik1*nbk1 + ik2*
-0003ca10: 6e62 6b32 202b 2069 6b33 2a6e 626b 3329  nbk2 + ik3*nbk3)
-0003ca20: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0003ca30: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0003ca40: 2028 2863 6861 7220 2a29 2071 2d3e 6461   ((char *) q->da
-0003ca50: 7461 202b 2028 6971 312a 6e62 7131 202b  ta + (iq1*nbq1 +
-0003ca60: 2069 7132 2a6e 6271 3220 2b20 6971 332a   iq2*nbq2 + iq3*
-0003ca70: 6e62 7133 2929 293b 0a20 2020 2020 2020  nbq3)));.       
-0003ca80: 207d 0a0a 2020 2020 2020 2020 2f2f 2073   }..        // s
-0003ca90: 6361 6c65 0a20 2020 2020 2020 2067 676d  cale.        ggm
-0003caa0: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
-0003cab0: 6e65 6b31 2c20 532c 2073 6361 6c65 293b  nek1, S, scale);
-0003cac0: 0a0a 2020 2020 2020 2020 6966 2028 6d61  ..        if (ma
-0003cad0: 736b 6564 2920 7b0a 2020 2020 2020 2020  sked) {.        
-0003cae0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-0003caf0: 2050 3b20 6920 3c20 4d3b 2069 2b2b 2920   P; i < M; i++) 
-0003cb00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003cb10: 2020 6966 2028 6920 3e20 5020 2b20 6971    if (i > P + iq
-0003cb20: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-0003cb30: 2020 2020 2020 2020 2053 5b69 5d20 3d20           S[i] = 
-0003cb40: 2d49 4e46 494e 4954 593b 0a20 2020 2020  -INFINITY;.     
-0003cb50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003cb60: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0003cb70: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-0003cb80: 2073 6f66 746d 6178 0a20 2020 2020 2020   softmax.       
-0003cb90: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-0003cba0: 6c6f 6174 206d 6178 203d 202d 494e 4649  loat max = -INFI
-0003cbb0: 4e49 5459 3b0a 2020 2020 2020 2020 2020  NITY;.          
-0003cbc0: 2020 6767 6d6c 5f76 6563 5f6d 6178 5f66    ggml_vec_max_f
-0003cbd0: 3332 284d 2c20 266d 6178 2c20 5329 3b0a  32(M, &max, S);.
-0003cbe0: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
-0003cbf0: 6174 2073 756d 203d 2030 2e30 663b 0a20  at sum = 0.0f;. 
-0003cc00: 2020 2020 2020 2020 2020 207b 0a23 6966             {.#if
-0003cc10: 6465 6620 4747 4d4c 5f53 4f46 545f 4d41  def GGML_SOFT_MA
-0003cc20: 585f 4143 4345 4c45 5241 5445 0a20 2020  X_ACCELERATE.   
-0003cc30: 2020 2020 2020 2020 2020 2020 206d 6178               max
-0003cc40: 203d 202d 6d61 783b 0a20 2020 2020 2020   = -max;.       
-0003cc50: 2020 2020 2020 2020 2076 4453 505f 7673           vDSP_vs
-0003cc60: 6164 6428 532c 2031 2c20 266d 6178 2c20  add(S, 1, &max, 
-0003cc70: 532c 2031 2c20 4d75 7029 3b0a 2020 2020  S, 1, Mup);.    
-0003cc80: 2020 2020 2020 2020 2020 2020 7676 6578              vvex
-0003cc90: 7066 2853 2c20 532c 2026 4d75 7029 3b0a  pf(S, S, &Mup);.
-0003cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ccb0: 6767 6d6c 5f76 6563 5f73 756d 5f66 3332  ggml_vec_sum_f32
-0003ccc0: 284d 7570 2c20 2673 756d 2c20 5329 3b0a  (Mup, &sum, S);.
-0003ccd0: 2365 6c73 650a 2020 2020 2020 2020 2020  #else.          
-0003cce0: 2020 2020 2020 7569 6e74 3136 5f74 2020        uint16_t  
-0003ccf0: 2073 6376 745b 4747 4d4c 5f53 4f46 545f   scvt[GGML_SOFT_
-0003cd00: 4d41 585f 554e 524f 4c4c 5d3b 0a20 2020  MAX_UNROLL];.   
-0003cd10: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0003cd20: 6c5f 666c 6f61 7420 7375 6d70 5b47 474d  l_float sump[GGM
-0003cd30: 4c5f 534f 4654 5f4d 4158 5f55 4e52 4f4c  L_SOFT_MAX_UNROL
-0003cd40: 4c5d 203d 207b 2030 2e30 207d 3b0a 0a20  L] = { 0.0 };.. 
-0003cd50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0003cd60: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0003cd70: 203c 204d 7570 3b20 6920 2b3d 2047 474d   < Mup; i += GGM
-0003cd80: 4c5f 534f 4654 5f4d 4158 5f55 4e52 4f4c  L_SOFT_MAX_UNROL
-0003cd90: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
-0003cda0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-0003cdb0: 2053 5320 3d20 5320 2b20 693b 0a0a 2020   SS = S + i;..  
-0003cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cdd0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-0003cde0: 3b20 6a20 3c20 4747 4d4c 5f53 4f46 545f  ; j < GGML_SOFT_
-0003cdf0: 4d41 585f 554e 524f 4c4c 3b20 2b2b 6a29  MAX_UNROLL; ++j)
-0003ce00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0003ce10: 2020 2020 2020 2020 2020 2069 6620 2853             if (S
-0003ce20: 535b 6a5d 203d 3d20 2d49 4e46 494e 4954  S[j] == -INFINIT
-0003ce30: 5929 207b 0a20 2020 2020 2020 2020 2020  Y) {.           
-0003ce40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce50: 2053 535b 6a5d 203d 2030 2e30 663b 0a20   SS[j] = 0.0f;. 
-0003ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce70: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-0003ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce90: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0003cea0: 5f66 7031 365f 7420 7320 3d20 4747 4d4c  _fp16_t s = GGML
-0003ceb0: 5f46 5033 325f 544f 5f46 5031 3628 5353  _FP32_TO_FP16(SS
-0003cec0: 5b6a 5d20 2d20 6d61 7829 3b0a 2020 2020  [j] - max);.    
-0003ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cee0: 2020 2020 2020 2020 6d65 6d63 7079 2826          memcpy(&
-0003cef0: 7363 7674 5b6a 5d2c 2026 732c 2073 697a  scvt[j], &s, siz
-0003cf00: 656f 6628 7569 6e74 3136 5f74 2929 3b0a  eof(uint16_t));.
-0003cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cf20: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0003cf30: 7420 666c 6f61 7420 7661 6c20 3d20 4747  t float val = GG
-0003cf40: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-0003cf50: 7461 626c 655f 6578 705f 6631 365b 7363  table_exp_f16[sc
-0003cf60: 7674 5b6a 5d5d 293b 0a20 2020 2020 2020  vt[j]]);.       
-0003cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cf80: 2020 2020 2073 756d 705b 6a5d 202b 3d20       sump[j] += 
-0003cf90: 7661 6c3b 0a20 2020 2020 2020 2020 2020  val;.           
-0003cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cfb0: 2053 535b 6a5d 203d 2076 616c 3b0a 2020   SS[j] = val;.  
-0003cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cfd0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003cfe0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0003cff0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0003d000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d010: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0003d020: 2069 203c 2047 474d 4c5f 534f 4654 5f4d   i < GGML_SOFT_M
-0003d030: 4158 5f55 4e52 4f4c 4c3b 2069 2b2b 2920  AX_UNROLL; i++) 
-0003d040: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003d050: 2020 2020 2020 7375 6d20 2b3d 2073 756d        sum += sum
-0003d060: 705b 695d 3b0a 2020 2020 2020 2020 2020  p[i];.          
-0003d070: 2020 2020 2020 7d0a 2365 6e64 6966 0a20        }.#endif. 
-0003d080: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0003d090: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0003d0a0: 2873 756d 203e 2030 2e30 6629 3b0a 0a20  (sum > 0.0f);.. 
-0003d0b0: 2020 2020 2020 2020 2020 2073 756d 203d             sum =
-0003d0c0: 2031 2e30 2f73 756d 3b0a 2020 2020 2020   1.0/sum;.      
-0003d0d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-0003d0e0: 6361 6c65 5f66 3332 284d 2c20 532c 2073  cale_f32(M, S, s
-0003d0f0: 756d 293b 0a0a 2369 666e 6465 6620 4e44  um);..#ifndef ND
-0003d100: 4542 5547 0a20 2020 2020 2020 2020 2020  EBUG.           
-0003d110: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0003d120: 2069 203c 204d 3b20 2b2b 6929 207b 0a20   i < M; ++i) {. 
-0003d130: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0003d140: 7373 6572 7428 2169 736e 616e 2853 5b69  ssert(!isnan(S[i
-0003d150: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
-0003d160: 2020 2020 2061 7373 6572 7428 2169 7369       assert(!isi
-0003d170: 6e66 2853 5b69 5d29 293b 0a20 2020 2020  nf(S[i]));.     
-0003d180: 2020 2020 2020 207d 0a23 656e 6469 660a         }.#endif.
-0003d190: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0003d1a0: 2020 2066 6f72 2028 696e 7420 6963 203d     for (int ic =
-0003d1b0: 2030 3b20 6963 203c 206e 6576 313b 202b   0; ic < nev1; +
-0003d1c0: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
-0003d1d0: 2020 202f 2f20 6473 7420 696e 6469 6365     // dst indice
-0003d1e0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
-0003d1f0: 6e73 7420 696e 7420 6931 203d 2069 7131  nst int i1 = iq1
-0003d200: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0003d210: 6e73 7420 696e 7420 6932 203d 2069 7132  nst int i2 = iq2
-0003d220: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0003d230: 6e73 7420 696e 7420 6933 203d 2069 7133  nst int i3 = iq3
-0003d240: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
-0003d250: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
-0003d260: 6e65 6b31 2c0a 2020 2020 2020 2020 2020  nek1,.          
-0003d270: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-0003d280: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-0003d290: 742d 3e64 6174 6120 2b20 2869 632a 6e62  t->data + (ic*nb
-0003d2a0: 3020 2b20 6931 2a6e 6231 2020 2b20 6932  0 + i1*nb1  + i2
-0003d2b0: 2a6e 6232 2020 2b20 6933 2a6e 6233 2929  *nb2  + i3*nb3))
-0003d2c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003d2d0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0003d2e0: 2828 6368 6172 202a 2920 762d 3e64 6174  ((char *) v->dat
-0003d2f0: 6120 2020 2b20 2820 2020 2020 2020 2020  a   + (         
-0003d300: 6963 2a6e 6276 3120 2b20 6932 2a6e 6276  ic*nbv1 + i2*nbv
-0003d310: 3220 2b20 6933 2a6e 6276 3329 292c 0a20  2 + i3*nbv3)),. 
-0003d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d330: 2020 2053 293b 0a20 2020 2020 2020 207d     S);.        }
-0003d340: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-0003d350: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-0003d360: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
-0003d370: 5f61 7474 6e5f 6631 3628 0a20 2020 2020  _attn_f16(.     
-0003d380: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0003d390: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-0003d3a0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-0003d3b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0003d3c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0003d3d0: 2071 2c0a 2020 2020 2020 2020 636f 6e73   q,.        cons
-0003d3e0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0003d3f0: 6e73 6f72 202a 206b 2c0a 2020 2020 2020  nsor * k,.      
-0003d400: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0003d410: 676d 6c5f 7465 6e73 6f72 202a 2076 2c0a  gml_tensor * v,.
-0003d420: 2020 2020 2020 2020 636f 6e73 7420 626f          const bo
-0003d430: 6f6c 206d 6173 6b65 642c 0a20 2020 2020  ol masked,.     
-0003d440: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0003d450: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-0003d460: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
-0003d470: 7430 203d 2067 676d 6c5f 7065 7266 5f74  t0 = ggml_perf_t
-0003d480: 696d 655f 7573 2829 3b0a 2020 2020 554e  ime_us();.    UN
-0003d490: 5553 4544 2874 3029 3b0a 0a20 2020 2063  USED(t0);..    c
-0003d4a0: 6f6e 7374 2069 6e74 206e 6571 3020 3d20  onst int neq0 = 
-0003d4b0: 712d 3e6e 655b 305d 3b0a 2020 2020 636f  q->ne[0];.    co
-0003d4c0: 6e73 7420 696e 7420 6e65 7131 203d 2071  nst int neq1 = q
-0003d4d0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
-0003d4e0: 7374 2069 6e74 206e 6571 3220 3d20 712d  st int neq2 = q-
-0003d4f0: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-0003d500: 7420 696e 7420 6e65 7133 203d 2071 2d3e  t int neq3 = q->
-0003d510: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-0003d520: 7420 696e 7420 6e65 6b30 203d 206b 2d3e  t int nek0 = k->
-0003d530: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-0003d540: 2069 6e74 206e 656b 3120 3d20 6b2d 3e6e   int nek1 = k->n
-0003d550: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
-0003d560: 7420 696e 7420 6e65 6b32 203d 206b 2d3e  t int nek2 = k->
-0003d570: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-0003d580: 7374 2069 6e74 206e 656b 3320 3d20 6b2d  st int nek3 = k-
-0003d590: 3e6e 655b 335d 3b0a 0a20 2020 202f 2f63  >ne[3];..    //c
-0003d5a0: 6f6e 7374 2069 6e74 206e 6576 3020 3d20  onst int nev0 = 
-0003d5b0: 762d 3e6e 655b 305d 3b0a 2020 2020 636f  v->ne[0];.    co
-0003d5c0: 6e73 7420 696e 7420 6e65 7631 203d 2076  nst int nev1 = v
-0003d5d0: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
-0003d5e0: 6f6e 7374 2069 6e74 206e 6576 3220 3d20  onst int nev2 = 
-0003d5f0: 762d 3e6e 655b 325d 3b0a 2020 2020 2f2f  v->ne[2];.    //
-0003d600: 636f 6e73 7420 696e 7420 6e65 7633 203d  const int nev3 =
-0003d610: 2076 2d3e 6e65 5b33 5d3b 0a0a 2020 2020   v->ne[3];..    
-0003d620: 636f 6e73 7420 696e 7420 6e65 3020 203d  const int ne0  =
-0003d630: 2064 7374 2d3e 6e65 5b30 5d3b 0a20 2020   dst->ne[0];.   
-0003d640: 2063 6f6e 7374 2069 6e74 206e 6531 2020   const int ne1  
-0003d650: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
-0003d660: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
-0003d670: 3220 203d 2064 7374 2d3e 6e65 5b32 5d3b  2  = dst->ne[2];
-0003d680: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0003d690: 206e 6533 2020 3d20 6473 742d 3e6e 655b   ne3  = dst->ne[
-0003d6a0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-0003d6b0: 6e74 206e 626b 3020 3d20 6b2d 3e6e 625b  nt nbk0 = k->nb[
-0003d6c0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0003d6d0: 7420 6e62 6b31 203d 206b 2d3e 6e62 5b31  t nbk1 = k->nb[1
-0003d6e0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0003d6f0: 206e 626b 3220 3d20 6b2d 3e6e 625b 325d   nbk2 = k->nb[2]
-0003d700: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0003d710: 6e62 6b33 203d 206b 2d3e 6e62 5b33 5d3b  nbk3 = k->nb[3];
-0003d720: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0003d730: 6e62 7130 203d 2071 2d3e 6e62 5b30 5d3b  nbq0 = q->nb[0];
-0003d740: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0003d750: 6271 3120 3d20 712d 3e6e 625b 315d 3b0a  bq1 = q->nb[1];.
-0003d760: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0003d770: 7132 203d 2071 2d3e 6e62 5b32 5d3b 0a20  q2 = q->nb[2];. 
-0003d780: 2020 2063 6f6e 7374 2069 6e74 206e 6271     const int nbq
-0003d790: 3320 3d20 712d 3e6e 625b 335d 3b0a 0a20  3 = q->nb[3];.. 
-0003d7a0: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
-0003d7b0: 3020 3d20 762d 3e6e 625b 305d 3b0a 2020  0 = v->nb[0];.  
-0003d7c0: 2020 636f 6e73 7420 696e 7420 6e62 7631    const int nbv1
-0003d7d0: 203d 2076 2d3e 6e62 5b31 5d3b 0a20 2020   = v->nb[1];.   
-0003d7e0: 2063 6f6e 7374 2069 6e74 206e 6276 3220   const int nbv2 
-0003d7f0: 3d20 762d 3e6e 625b 325d 3b0a 2020 2020  = v->nb[2];.    
-0003d800: 636f 6e73 7420 696e 7420 6e62 7633 203d  const int nbv3 =
-0003d810: 2076 2d3e 6e62 5b33 5d3b 0a0a 2020 2020   v->nb[3];..    
-0003d820: 636f 6e73 7420 696e 7420 6e62 3020 203d  const int nb0  =
-0003d830: 2064 7374 2d3e 6e62 5b30 5d3b 0a20 2020   dst->nb[0];.   
-0003d840: 2063 6f6e 7374 2069 6e74 206e 6231 2020   const int nb1  
-0003d850: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-0003d860: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
-0003d870: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
-0003d880: 2020 2063 6f6e 7374 2069 6e74 206e 6233     const int nb3
-0003d890: 2020 3d20 6473 742d 3e6e 625b 335d 3b0a    = dst->nb[3];.
-0003d8a0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-0003d8b0: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-0003d8c0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0003d8d0: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-0003d8e0: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
-0003d8f0: 7420 4420 3d20 6e65 7130 3b0a 2020 2020  t D = neq0;.    
-0003d900: 636f 6e73 7420 696e 7420 4e20 3d20 6e65  const int N = ne
-0003d910: 7131 3b0a 2020 2020 636f 6e73 7420 696e  q1;.    const in
-0003d920: 7420 5020 3d20 6e65 6b31 202d 204e 3b0a  t P = nek1 - N;.
-0003d930: 2020 2020 636f 6e73 7420 696e 7420 4d20      const int M 
-0003d940: 3d20 5020 2b20 4e3b 0a0a 2020 2020 636f  = P + N;..    co
-0003d950: 6e73 7420 696e 7420 4d75 7020 3d20 6767  nst int Mup = gg
-0003d960: 6d6c 5f75 7028 4d2c 2047 474d 4c5f 534f  ml_up(M, GGML_SO
-0003d970: 4654 5f4d 4158 5f55 4e52 4f4c 4c29 3b0a  FT_MAX_UNROLL);.
-0003d980: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0003d990: 286e 6530 203d 3d20 4429 3b0a 2020 2020  (ne0 == D);.    
-0003d9a0: 4747 4d4c 5f41 5353 4552 5428 6e65 3120  GGML_ASSERT(ne1 
-0003d9b0: 3d3d 204e 293b 0a20 2020 2047 474d 4c5f  == N);.    GGML_
-0003d9c0: 4153 5345 5254 2850 203e 3d20 3029 3b0a  ASSERT(P >= 0);.
-0003d9d0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0003d9e0: 286e 6271 3020 3d3d 2073 697a 656f 6628  (nbq0 == sizeof(
-0003d9f0: 6767 6d6c 5f66 7031 365f 7429 293b 0a20  ggml_fp16_t));. 
-0003da00: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0003da10: 626b 3020 3d3d 2073 697a 656f 6628 6767  bk0 == sizeof(gg
-0003da20: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
-0003da30: 2047 474d 4c5f 4153 5345 5254 286e 6276   GGML_ASSERT(nbv
-0003da40: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
-0003da50: 5f66 7031 365f 7429 293b 0a0a 2020 2020  _fp16_t));..    
-0003da60: 4747 4d4c 5f41 5353 4552 5428 6e65 7130  GGML_ASSERT(neq0
-0003da70: 203d 3d20 4429 3b0a 2020 2020 4747 4d4c   == D);.    GGML
-0003da80: 5f41 5353 4552 5428 6e65 6b30 203d 3d20  _ASSERT(nek0 == 
-0003da90: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
-0003daa0: 4552 5428 6e65 7631 203d 3d20 4429 3b0a  ERT(nev1 == D);.
-0003dab0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0003dac0: 286e 6571 3120 3d3d 204e 293b 0a20 2020  (neq1 == N);.   
-0003dad0: 2047 474d 4c5f 4153 5345 5254 286e 656b   GGML_ASSERT(nek
-0003dae0: 3120 3d3d 204e 202b 2050 293b 0a20 2020  1 == N + P);.   
-0003daf0: 2047 474d 4c5f 4153 5345 5254 286e 6576   GGML_ASSERT(nev
-0003db00: 3120 3d3d 2044 293b 0a0a 2020 2020 2f2f  1 == D);..    //
-0003db10: 2064 7374 2063 616e 6e6f 7420 6265 2074   dst cannot be t
-0003db20: 7261 6e73 706f 7365 6420 6f72 2070 6572  ransposed or per
-0003db30: 6d75 7465 640a 2020 2020 4747 4d4c 5f41  muted.    GGML_A
-0003db40: 5353 4552 5428 6e62 3020 3d3d 2073 697a  SSERT(nb0 == siz
-0003db50: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-0003db60: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-0003db70: 203c 3d20 6e62 3129 3b0a 2020 2020 4747   <= nb1);.    GG
-0003db80: 4d4c 5f41 5353 4552 5428 6e62 3120 3c3d  ML_ASSERT(nb1 <=
-0003db90: 206e 6232 293b 0a20 2020 2047 474d 4c5f   nb2);.    GGML_
-0003dba0: 4153 5345 5254 286e 6232 203c 3d20 6e62  ASSERT(nb2 <= nb
-0003dbb0: 3329 3b0a 0a20 2020 2069 6620 2870 6172  3);..    if (par
-0003dbc0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0003dbd0: 4c5f 5441 534b 5f49 4e49 5429 207b 0a20  L_TASK_INIT) {. 
-0003dbe0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-0003dbf0: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
-0003dc00: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0003dc10: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-0003dc20: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-0003dc30: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
-0003dc40: 2f20 7061 7261 6c6c 656c 697a 6520 6279  / parallelize by
-0003dc50: 2071 2072 6f77 7320 7573 696e 6720 6767   q rows using gg
-0003dc60: 6d6c 5f76 6563 5f64 6f74 5f66 3332 0a0a  ml_vec_dot_f32..
-0003dc70: 2020 2020 2f2f 2074 6f74 616c 2072 6f77      // total row
-0003dc80: 7320 696e 2071 0a20 2020 2063 6f6e 7374  s in q.    const
-0003dc90: 2069 6e74 206e 7220 3d20 6e65 7131 2a6e   int nr = neq1*n
-0003dca0: 6571 322a 6e65 7133 3b0a 0a20 2020 202f  eq2*neq3;..    /
-0003dcb0: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-0003dcc0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-0003dcd0: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-0003dce0: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-0003dcf0: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-0003dd00: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-0003dd10: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-0003dd20: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-0003dd30: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-0003dd40: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-0003dd50: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
-0003dd60: 6361 6c65 203d 2031 2e30 2f73 7172 7428  cale = 1.0/sqrt(
-0003dd70: 2864 6f75 626c 6529 2044 293b 0a0a 2020  (double) D);..  
-0003dd80: 2020 2f2f 7072 696e 7466 2822 503d 2564    //printf("P=%d
-0003dd90: 204e 3d25 6420 443d 2564 2069 7230 3d25   N=%d D=%d ir0=%
-0003dda0: 6420 6972 313d 2564 2073 6361 6c65 203d  d ir1=%d scale =
-0003ddb0: 2025 665c 6e22 2c20 502c 204e 2c20 442c   %f\n", P, N, D,
-0003ddc0: 2069 7230 2c20 6972 312c 2073 6361 6c65   ir0, ir1, scale
-0003ddd0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-0003dde0: 2069 7220 3d20 6972 303b 2069 7220 3c20   ir = ir0; ir < 
-0003ddf0: 6972 313b 202b 2b69 7229 207b 0a20 2020  ir1; ++ir) {.   
-0003de00: 2020 2020 202f 2f20 7120 696e 6469 6365       // q indice
-0003de10: 730a 2020 2020 2020 2020 636f 6e73 7420  s.        const 
-0003de20: 696e 7420 6971 3320 3d20 6972 2f28 6e65  int iq3 = ir/(ne
-0003de30: 7132 2a6e 6571 3129 3b0a 2020 2020 2020  q2*neq1);.      
-0003de40: 2020 636f 6e73 7420 696e 7420 6971 3220    const int iq2 
-0003de50: 3d20 2869 7220 2d20 6971 332a 6e65 7132  = (ir - iq3*neq2
-0003de60: 2a6e 6571 3129 2f6e 6571 313b 0a20 2020  *neq1)/neq1;.   
-0003de70: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0003de80: 7131 203d 2028 6972 202d 2069 7133 2a6e  q1 = (ir - iq3*n
-0003de90: 6571 322a 6e65 7131 202d 2069 7132 2a6e  eq2*neq1 - iq2*n
-0003dea0: 6571 3129 3b0a 0a20 2020 2020 2020 2066  eq1);..        f
-0003deb0: 6c6f 6174 202a 2053 203d 2028 666c 6f61  loat * S = (floa
-0003dec0: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-0003ded0: 7461 202b 2069 7468 2a28 322a 4d75 7020  ta + ith*(2*Mup 
-0003dee0: 2b20 4341 4348 455f 4c49 4e45 5f53 495a  + CACHE_LINE_SIZ
-0003def0: 455f 4633 3229 3b0a 0a20 2020 2020 2020  E_F32);..       
-0003df00: 2066 6f72 2028 696e 7420 6920 3d20 4d3b   for (int i = M;
-0003df10: 2069 203c 204d 7570 3b20 2b2b 6929 207b   i < Mup; ++i) {
-0003df20: 0a20 2020 2020 2020 2020 2020 2053 5b69  .            S[i
-0003df30: 5d20 3d20 2d49 4e46 494e 4954 593b 0a20  ] = -INFINITY;. 
-0003df40: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0003df50: 2020 6966 2028 4747 4d4c 5f56 4543 5f44    if (GGML_VEC_D
-0003df60: 4f54 5f55 4e52 4f4c 4c20 3e20 3220 7c7c  OT_UNROLL > 2 ||
-0003df70: 206e 656b 3120 2520 4747 4d4c 5f56 4543   nek1 % GGML_VEC
-0003df80: 5f44 4f54 5f55 4e52 4f4c 4c20 213d 2030  _DOT_UNROLL != 0
-0003df90: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003dfa0: 666f 7220 2869 6e74 2069 6320 3d20 303b  for (int ic = 0;
-0003dfb0: 2069 6320 3c20 6e65 6b31 3b20 2b2b 6963   ic < nek1; ++ic
-0003dfc0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003dfd0: 2020 2020 2f2f 206b 2069 6e64 6963 6573      // k indices
-0003dfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003dff0: 2063 6f6e 7374 2069 6e74 2069 6b33 203d   const int ik3 =
-0003e000: 2069 7133 3b0a 2020 2020 2020 2020 2020   iq3;.          
-0003e010: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0003e020: 696b 3220 3d20 6971 323b 0a20 2020 2020  ik2 = iq2;.     
-0003e030: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0003e040: 2069 6e74 2069 6b31 203d 2069 633b 0a0a   int ik1 = ic;..
-0003e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e060: 2f2f 2053 2069 6e64 6963 6573 0a20 2020  // S indices.   
-0003e070: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0003e080: 7374 2069 6e74 2069 3120 3d20 696b 313b  st int i1 = ik1;
-0003e090: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003e0a0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
-0003e0b0: 3136 286e 6571 302c 0a20 2020 2020 2020  16(neq0,.       
-0003e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e0d0: 2053 202b 2069 312c 0a20 2020 2020 2020   S + i1,.       
-0003e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e0f0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-0003e100: 2028 2863 6861 7220 2a29 206b 2d3e 6461   ((char *) k->da
-0003e110: 7461 202b 2028 696b 312a 6e62 6b31 202b  ta + (ik1*nbk1 +
-0003e120: 2069 6b32 2a6e 626b 3220 2b20 696b 332a   ik2*nbk2 + ik3*
-0003e130: 6e62 6b33 2929 2c0a 2020 2020 2020 2020  nbk3)),.        
-0003e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e150: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-0003e160: 2828 6368 6172 202a 2920 712d 3e64 6174  ((char *) q->dat
-0003e170: 6120 2b20 2869 7131 2a6e 6271 3120 2b20  a + (iq1*nbq1 + 
-0003e180: 6971 322a 6e62 7132 202b 2069 7133 2a6e  iq2*nbq2 + iq3*n
-0003e190: 6271 3329 2929 3b0a 2020 2020 2020 2020  bq3)));.        
-0003e1a0: 2020 2020 7d0a 2020 2020 2020 2020 7d20      }.        } 
-0003e1b0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-0003e1c0: 2020 2066 6f72 2028 696e 7420 6963 203d     for (int ic =
-0003e1d0: 2030 3b20 6963 203c 206e 656b 313b 2069   0; ic < nek1; i
-0003e1e0: 6320 2b3d 2047 474d 4c5f 5645 435f 444f  c += GGML_VEC_DO
-0003e1f0: 545f 554e 524f 4c4c 2920 7b0a 2020 2020  T_UNROLL) {.    
-0003e200: 2020 2020 2020 2020 2020 2020 2f2f 206b              // k
-0003e210: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-0003e220: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-0003e230: 6e74 2069 6b33 203d 2069 7133 3b0a 2020  nt ik3 = iq3;.  
-0003e240: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003e250: 6e73 7420 696e 7420 696b 3220 3d20 6971  nst int ik2 = iq
-0003e260: 323b 0a20 2020 2020 2020 2020 2020 2020  2;.             
-0003e270: 2020 2063 6f6e 7374 2069 6e74 2069 6b31     const int ik1
-0003e280: 203d 2069 633b 0a0a 2020 2020 2020 2020   = ic;..        
-0003e290: 2020 2020 2020 2020 2f2f 2053 2069 6e64          // S ind
-0003e2a0: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
-0003e2b0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0003e2c0: 3120 3d20 696b 313b 0a0a 2020 2020 2020  1 = ik1;..      
-0003e2d0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0003e2e0: 6563 5f64 6f74 5f66 3136 5f75 6e72 6f6c  ec_dot_f16_unrol
-0003e2f0: 6c28 6e65 7130 2c20 6e62 6b31 2c0a 2020  l(neq0, nbk1,.  
-0003e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e310: 2020 2020 2020 5320 2b20 6931 2c0a 2020        S + i1,.  
-0003e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e330: 2020 2020 2020 2828 6368 6172 202a 2920        ((char *) 
-0003e340: 6b2d 3e64 6174 6120 2b20 2869 6b31 2a6e  k->data + (ik1*n
-0003e350: 626b 3120 2b20 696b 322a 6e62 6b32 202b  bk1 + ik2*nbk2 +
-0003e360: 2069 6b33 2a6e 626b 3329 292c 0a20 2020   ik3*nbk3)),.   
-0003e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e380: 2020 2020 2028 6767 6d6c 5f66 7031 365f       (ggml_fp16_
-0003e390: 7420 2a29 2028 2863 6861 7220 2a29 2071  t *) ((char *) q
-0003e3a0: 2d3e 6461 7461 202b 2028 6971 312a 6e62  ->data + (iq1*nb
-0003e3b0: 7131 202b 2069 7132 2a6e 6271 3220 2b20  q1 + iq2*nbq2 + 
-0003e3c0: 6971 332a 6e62 7133 2929 293b 0a20 2020  iq3*nbq3)));.   
-0003e3d0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0003e3e0: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-0003e3f0: 2073 6361 6c65 0a20 2020 2020 2020 2067   scale.        g
-0003e400: 676d 6c5f 7665 635f 7363 616c 655f 6633  gml_vec_scale_f3
-0003e410: 3228 6e65 6b31 2c20 532c 2073 6361 6c65  2(nek1, S, scale
-0003e420: 293b 0a0a 2020 2020 2020 2020 6966 2028  );..        if (
-0003e430: 6d61 736b 6564 2920 7b0a 2020 2020 2020  masked) {.      
-0003e440: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0003e450: 203d 2050 3b20 6920 3c20 4d3b 2069 2b2b   = P; i < M; i++
-0003e460: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003e470: 2020 2020 6966 2028 6920 3e20 5020 2b20      if (i > P + 
-0003e480: 6971 3129 207b 0a20 2020 2020 2020 2020  iq1) {.         
-0003e490: 2020 2020 2020 2020 2020 2053 5b69 5d20             S[i] 
-0003e4a0: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
-0003e4b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0003e4c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003e4d0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0003e4e0: 2f2f 2073 6f66 746d 6178 0a20 2020 2020  // softmax.     
-0003e4f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0003e500: 2066 6c6f 6174 206d 6178 203d 202d 494e   float max = -IN
-0003e510: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
-0003e520: 2020 2020 6767 6d6c 5f76 6563 5f6d 6178      ggml_vec_max
-0003e530: 5f66 3332 284d 2c20 266d 6178 2c20 5329  _f32(M, &max, S)
-0003e540: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
-0003e550: 6c6f 6174 2073 756d 203d 2030 2e30 663b  loat sum = 0.0f;
-0003e560: 0a20 2020 2020 2020 2020 2020 207b 0a23  .            {.#
-0003e570: 6966 6465 6620 4747 4d4c 5f53 4f46 545f  ifdef GGML_SOFT_
-0003e580: 4d41 585f 4143 4345 4c45 5241 5445 0a20  MAX_ACCELERATE. 
-0003e590: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0003e5a0: 6178 203d 202d 6d61 783b 0a20 2020 2020  ax = -max;.     
-0003e5b0: 2020 2020 2020 2020 2020 2076 4453 505f             vDSP_
-0003e5c0: 7673 6164 6428 532c 2031 2c20 266d 6178  vsadd(S, 1, &max
-0003e5d0: 2c20 532c 2031 2c20 4d75 7029 3b0a 2020  , S, 1, Mup);.  
-0003e5e0: 2020 2020 2020 2020 2020 2020 2020 7676                vv
-0003e5f0: 6578 7066 2853 2c20 532c 2026 4d75 7029  expf(S, S, &Mup)
-0003e600: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003e610: 2020 6767 6d6c 5f76 6563 5f73 756d 5f66    ggml_vec_sum_f
-0003e620: 3332 284d 7570 2c20 2673 756d 2c20 5329  32(Mup, &sum, S)
-0003e630: 3b0a 2365 6c73 650a 2020 2020 2020 2020  ;.#else.        
-0003e640: 2020 2020 2020 2020 7569 6e74 3136 5f74          uint16_t
-0003e650: 2020 2073 6376 745b 4747 4d4c 5f53 4f46     scvt[GGML_SOF
-0003e660: 545f 4d41 585f 554e 524f 4c4c 5d3b 0a20  T_MAX_UNROLL];. 
-0003e670: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0003e680: 676d 6c5f 666c 6f61 7420 7375 6d70 5b47  gml_float sump[G
-0003e690: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-0003e6a0: 4f4c 4c5d 203d 207b 2030 2e30 207d 3b0a  OLL] = { 0.0 };.
-0003e6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e6c0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0003e6d0: 2069 203c 204d 7570 3b20 6920 2b3d 2047   i < Mup; i += G
-0003e6e0: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-0003e6f0: 4f4c 4c29 207b 0a20 2020 2020 2020 2020  OLL) {.         
-0003e700: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0003e710: 202a 2053 5320 3d20 5320 2b20 693b 0a0a   * SS = S + i;..
-0003e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e730: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-0003e740: 2030 3b20 6a20 3c20 4747 4d4c 5f53 4f46   0; j < GGML_SOF
-0003e750: 545f 4d41 585f 554e 524f 4c4c 3b20 2b2b  T_MAX_UNROLL; ++
-0003e760: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-0003e770: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003e780: 2853 535b 6a5d 203d 3d20 2d49 4e46 494e  (SS[j] == -INFIN
-0003e790: 4954 5929 207b 0a20 2020 2020 2020 2020  ITY) {.         
-0003e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e7b0: 2020 2053 535b 6a5d 203d 2030 2e30 663b     SS[j] = 0.0f;
-0003e7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e7d0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-0003e7e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003e7f0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0003e800: 6d6c 5f66 7031 365f 7420 7320 3d20 4747  ml_fp16_t s = GG
-0003e810: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-0003e820: 5353 5b6a 5d20 2d20 6d61 7829 3b0a 2020  SS[j] - max);.  
-0003e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e840: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
-0003e850: 2826 7363 7674 5b6a 5d2c 2026 732c 2073  (&scvt[j], &s, s
-0003e860: 697a 656f 6628 7569 6e74 3136 5f74 2929  izeof(uint16_t))
-0003e870: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003e880: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003e890: 6e73 7420 666c 6f61 7420 7661 6c20 3d20  nst float val = 
-0003e8a0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-0003e8b0: 3228 7461 626c 655f 6578 705f 6631 365b  2(table_exp_f16[
-0003e8c0: 7363 7674 5b6a 5d5d 293b 0a20 2020 2020  scvt[j]]);.     
-0003e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e8e0: 2020 2020 2020 2073 756d 705b 6a5d 202b         sump[j] +
-0003e8f0: 3d20 7661 6c3b 0a20 2020 2020 2020 2020  = val;.         
-0003e900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e910: 2020 2053 535b 6a5d 203d 2076 616c 3b0a     SS[j] = val;.
-0003e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e930: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0003e940: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0003e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e960: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-0003e970: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0003e980: 303b 2069 203c 2047 474d 4c5f 534f 4654  0; i < GGML_SOFT
-0003e990: 5f4d 4158 5f55 4e52 4f4c 4c3b 2069 2b2b  _MAX_UNROLL; i++
-0003e9a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003e9b0: 2020 2020 2020 2020 7375 6d20 2b3d 2073          sum += s
-0003e9c0: 756d 705b 695d 3b0a 2020 2020 2020 2020  ump[i];.        
-0003e9d0: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
-0003e9e0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-0003e9f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0003ea00: 7274 2873 756d 203e 2030 2e30 6629 3b0a  rt(sum > 0.0f);.
-0003ea10: 0a20 2020 2020 2020 2020 2020 2073 756d  .            sum
-0003ea20: 203d 2031 2e30 2f73 756d 3b0a 2020 2020   = 1.0/sum;.    
-0003ea30: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0003ea40: 5f73 6361 6c65 5f66 3332 284d 2c20 532c  _scale_f32(M, S,
-0003ea50: 2073 756d 293b 0a0a 2369 666e 6465 6620   sum);..#ifndef 
-0003ea60: 4e44 4542 5547 0a20 2020 2020 2020 2020  NDEBUG.         
-0003ea70: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0003ea80: 303b 2069 203c 204d 3b20 2b2b 6929 207b  0; i < M; ++i) {
-0003ea90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003eaa0: 2061 7373 6572 7428 2169 736e 616e 2853   assert(!isnan(S
-0003eab0: 5b69 5d29 293b 0a20 2020 2020 2020 2020  [i]));.         
-0003eac0: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
-0003ead0: 7369 6e66 2853 5b69 5d29 293b 0a20 2020  sinf(S[i]));.   
-0003eae0: 2020 2020 2020 2020 207d 0a23 656e 6469           }.#endi
-0003eaf0: 660a 2020 2020 2020 2020 7d0a 0a20 2020  f.        }..   
-0003eb00: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
-0003eb10: 202a 2053 3136 203d 2028 6767 6d6c 5f66   * S16 = (ggml_f
-0003eb20: 7031 365f 7420 2a29 2028 2866 6c6f 6174  p16_t *) ((float
-0003eb30: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
-0003eb40: 6120 2b20 6974 682a 2832 2a4d 7570 202b  a + ith*(2*Mup +
-0003eb50: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-0003eb60: 5f46 3332 2920 2b20 4d75 7029 3b0a 0a20  _F32) + Mup);.. 
-0003eb70: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0003eb80: 6920 3d20 303b 2069 203c 204d 3b20 692b  i = 0; i < M; i+
-0003eb90: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0003eba0: 2053 3136 5b69 5d20 3d20 4747 4d4c 5f46   S16[i] = GGML_F
-0003ebb0: 5033 325f 544f 5f46 5031 3628 535b 695d  P32_TO_FP16(S[i]
-0003ebc0: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
-0003ebd0: 2020 2020 2020 6966 2028 4747 4d4c 5f56        if (GGML_V
-0003ebe0: 4543 5f44 4f54 5f55 4e52 4f4c 4c20 3d3d  EC_DOT_UNROLL ==
-0003ebf0: 2031 207c 7c20 286e 6576 3120 2520 4747   1 || (nev1 % GG
-0003ec00: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
-0003ec10: 4c20 213d 2030 2929 207b 0a20 2020 2020  L != 0)) {.     
-0003ec20: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0003ec30: 6963 203d 2030 3b20 6963 203c 206e 6576  ic = 0; ic < nev
-0003ec40: 313b 202b 2b69 6329 207b 0a20 2020 2020  1; ++ic) {.     
-0003ec50: 2020 2020 2020 2020 2020 202f 2f20 6473             // ds
-0003ec60: 7420 696e 6469 6365 730a 2020 2020 2020  t indices.      
-0003ec70: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0003ec80: 696e 7420 6931 203d 2069 7131 3b0a 2020  int i1 = iq1;.  
-0003ec90: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003eca0: 6e73 7420 696e 7420 6932 203d 2069 7132  nst int i2 = iq2
-0003ecb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003ecc0: 2020 636f 6e73 7420 696e 7420 6933 203d    const int i3 =
-0003ecd0: 2069 7133 3b0a 0a20 2020 2020 2020 2020   iq3;..         
-0003ece0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0003ecf0: 646f 745f 6631 3628 6e65 6b31 2c0a 2020  dot_f16(nek1,.  
-0003ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed10: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0003ed20: 2020 2020 2020 2828 6368 6172 202a 2920        ((char *) 
-0003ed30: 6473 742d 3e64 6174 6120 2b20 2869 632a  dst->data + (ic*
-0003ed40: 6e62 3020 2b20 6931 2a6e 6231 2020 2b20  nb0 + i1*nb1  + 
-0003ed50: 6932 2a6e 6232 2020 2b20 6933 2a6e 6233  i2*nb2  + i3*nb3
-0003ed60: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0003ed70: 2020 2020 2020 2020 2020 2020 2867 676d              (ggm
-0003ed80: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
-0003ed90: 6172 202a 2920 762d 3e64 6174 6120 2020  ar *) v->data   
-0003eda0: 2b20 2820 2020 2020 2020 2020 6963 2a6e  + (         ic*n
-0003edb0: 6276 3120 2b20 6932 2a6e 6276 3220 2b20  bv1 + i2*nbv2 + 
-0003edc0: 6933 2a6e 6276 3329 292c 0a20 2020 2020  i3*nbv3)),.     
-0003edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ede0: 2020 2053 3136 293b 0a20 2020 2020 2020     S16);.       
-0003edf0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0003ee00: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0003ee10: 2020 2020 666f 7220 2869 6e74 2069 6320      for (int ic 
-0003ee20: 3d20 303b 2069 6320 3c20 6e65 7631 3b20  = 0; ic < nev1; 
-0003ee30: 6963 202b 3d20 4747 4d4c 5f56 4543 5f44  ic += GGML_VEC_D
-0003ee40: 4f54 5f55 4e52 4f4c 4c29 207b 0a20 2020  OT_UNROLL) {.   
-0003ee50: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0003ee60: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-0003ee70: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0003ee80: 7420 696e 7420 6931 203d 2069 7131 3b0a  t int i1 = iq1;.
-0003ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003eea0: 636f 6e73 7420 696e 7420 6932 203d 2069  const int i2 = i
-0003eeb0: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-0003eec0: 2020 2020 636f 6e73 7420 696e 7420 6933      const int i3
-0003eed0: 203d 2069 7133 3b0a 0a20 2020 2020 2020   = iq3;..       
-0003eee0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0003eef0: 635f 646f 745f 6631 365f 756e 726f 6c6c  c_dot_f16_unroll
-0003ef00: 286e 656b 312c 206e 6276 312c 0a20 2020  (nek1, nbv1,.   
-0003ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef20: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-0003ef30: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-0003ef40: 7461 202b 2028 6963 2a6e 6230 202b 2069  ta + (ic*nb0 + i
-0003ef50: 312a 6e62 3120 202b 2069 322a 6e62 3220  1*nb1  + i2*nb2 
-0003ef60: 202b 2069 332a 6e62 3329 292c 0a20 2020   + i3*nb3)),.   
+00036970: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
+00036980: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00036990: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
+000369a0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+000369b0: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
+000369c0: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
+000369d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000369e0: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
+000369f0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00036a00: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00036a10: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00036a20: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00036a30: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
+00036a40: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00036a50: 7277 6172 645f 636f 6e76 5f31 645f 3273  rward_conv_1d_2s
+00036a60: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00036a70: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00036a80: 7264 5f63 6f6e 765f 3164 5f32 735f 6631  rd_conv_1d_2s_f1
+00036a90: 365f 6633 3228 0a20 2020 2020 2020 2063  6_f32(.        c
+00036aa0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00036ab0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00036ac0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00036ad0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00036ae0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00036af0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+00036b00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00036b10: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+00036b20: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+00036b30: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00036b40: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
+00036b50: 5353 4552 5428 7372 6330 2d3e 7479 7065  SSERT(src0->type
+00036b60: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
+00036b70: 3629 3b0a 2020 2020 4747 4d4c 5f41 5353  6);.    GGML_ASS
+00036b80: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
+00036b90: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+00036ba0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00036bb0: 5428 2064 7374 2d3e 7479 7065 203d 3d20  T( dst->type == 
+00036bc0: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
+00036bd0: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
+00036be0: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
+00036bf0: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
+00036c00: 4428 7430 293b 0a0a 2020 2020 636f 6e73  D(t0);..    cons
+00036c10: 7420 696e 7420 6e65 3030 203d 2073 7263  t int ne00 = src
+00036c20: 302d 3e6e 655b 305d 3b0a 2020 2020 636f  0->ne[0];.    co
+00036c30: 6e73 7420 696e 7420 6e65 3031 203d 2073  nst int ne01 = s
+00036c40: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
+00036c50: 636f 6e73 7420 696e 7420 6e65 3032 203d  const int ne02 =
+00036c60: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
+00036c70: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
+00036c80: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
+00036c90: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00036ca0: 206e 6531 3020 3d20 7372 6331 2d3e 6e65   ne10 = src1->ne
+00036cb0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00036cc0: 6e74 206e 6531 3120 3d20 7372 6331 2d3e  nt ne11 = src1->
+00036cd0: 6e65 5b31 5d3b 0a20 2020 202f 2f63 6f6e  ne[1];.    //con
+00036ce0: 7374 2069 6e74 206e 6531 3220 3d20 7372  st int ne12 = sr
+00036cf0: 6331 2d3e 6e65 5b32 5d3b 0a20 2020 202f  c1->ne[2];.    /
+00036d00: 2f63 6f6e 7374 2069 6e74 206e 6531 3320  /const int ne13 
+00036d10: 3d20 7372 6331 2d3e 6e65 5b33 5d3b 0a0a  = src1->ne[3];..
+00036d20: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00036d30: 6e65 3020 203d 2064 7374 2d3e 6e65 5b30  ne0  = dst->ne[0
+00036d40: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00036d50: 6e74 206e 6531 2020 3d20 6473 742d 3e6e  nt ne1  = dst->n
+00036d60: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
+00036d70: 7420 696e 7420 6e65 3220 203d 2064 7374  t int ne2  = dst
+00036d80: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
+00036d90: 6f6e 7374 2069 6e74 206e 6533 2020 3d20  onst int ne3  = 
+00036da0: 6473 742d 3e6e 655b 335d 3b0a 2020 2020  dst->ne[3];.    
+00036db0: 2f2f 636f 6e73 7420 696e 7420 6e65 2020  //const int ne  
+00036dc0: 203d 206e 6530 2a6e 6531 2a6e 6532 2a6e   = ne0*ne1*ne2*n
+00036dd0: 6533 3b0a 0a20 2020 2063 6f6e 7374 2069  e3;..    const i
+00036de0: 6e74 206e 6230 3020 3d20 7372 6330 2d3e  nt nb00 = src0->
+00036df0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+00036e00: 2069 6e74 206e 6230 3120 3d20 7372 6330   int nb01 = src0
+00036e10: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+00036e20: 7374 2069 6e74 206e 6230 3220 3d20 7372  st int nb02 = sr
+00036e30: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 202f  c0->nb[2];.    /
+00036e40: 2f63 6f6e 7374 2069 6e74 206e 6230 3320  /const int nb03 
+00036e50: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
+00036e60: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00036e70: 3130 203d 2073 7263 312d 3e6e 625b 305d  10 = src1->nb[0]
+00036e80: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00036e90: 6e62 3131 203d 2073 7263 312d 3e6e 625b  nb11 = src1->nb[
+00036ea0: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
+00036eb0: 696e 7420 6e62 3132 203d 2073 7263 312d  int nb12 = src1-
+00036ec0: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
+00036ed0: 6e73 7420 696e 7420 6e62 3133 203d 2073  nst int nb13 = s
+00036ee0: 7263 312d 3e6e 625b 335d 3b0a 0a20 2020  rc1->nb[3];..   
+00036ef0: 202f 2f63 6f6e 7374 2069 6e74 206e 6230   //const int nb0
+00036f00: 2020 3d20 6473 742d 3e6e 625b 305d 3b0a    = dst->nb[0];.
+00036f10: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00036f20: 3120 203d 2064 7374 2d3e 6e62 5b31 5d3b  1  = dst->nb[1];
+00036f30: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00036f40: 206e 6232 2020 3d20 6473 742d 3e6e 625b   nb2  = dst->nb[
+00036f50: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+00036f60: 696e 7420 6e62 3320 203d 2064 7374 2d3e  int nb3  = dst->
+00036f70: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+00036f80: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
+00036f90: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
+00036fa0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
+00036fb0: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
+00036fc0: 6f6e 7374 2069 6e74 206e 6b20 3d20 6e65  onst int nk = ne
+00036fd0: 3030 3b0a 2020 2020 636f 6e73 7420 696e  00;.    const in
+00036fe0: 7420 6e68 203d 206e 6b2f 323b 0a0a 2020  t nh = nk/2;..  
+00036ff0: 2020 636f 6e73 7420 696e 7420 6577 3020    const int ew0 
+00037000: 3d20 6767 6d6c 5f75 7033 3228 6e65 3031  = ggml_up32(ne01
+00037010: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+00037020: 4552 5428 6e65 3030 2025 2032 203d 3d20  ERT(ne00 % 2 == 
+00037030: 3129 3b20 2f2f 2054 4f44 4f3a 2073 7570  1); // TODO: sup
+00037040: 706f 7274 2065 7665 6e20 6b65 726e 656c  port even kernel
+00037050: 2073 697a 6573 0a20 2020 2047 474d 4c5f   sizes.    GGML_
+00037060: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
+00037070: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+00037080: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+00037090: 5345 5254 286e 6231 3020 3d3d 2073 697a  SERT(nb10 == siz
+000370a0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+000370b0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+000370c0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000370d0: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
+000370e0: 2f2f 2054 4f44 4f3a 2066 6978 2074 6869  // TODO: fix thi
+000370f0: 7320 6d65 6d73 6574 2028 7773 697a 6520  s memset (wsize 
+00037100: 6973 206f 7665 7265 7374 696d 6174 6564  is overestimated
+00037110: 290a 2020 2020 2020 2020 6d65 6d73 6574  ).        memset
+00037120: 2870 6172 616d 732d 3e77 6461 7461 2c20  (params->wdata, 
+00037130: 302c 2070 6172 616d 732d 3e77 7369 7a65  0, params->wsize
+00037140: 293b 0a0a 2020 2020 2020 2020 2f2f 2070  );..        // p
+00037150: 7265 7061 7265 206b 6572 6e65 6c20 6461  repare kernel da
+00037160: 7461 2028 7372 6330 290a 2020 2020 2020  ta (src0).      
+00037170: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00037180: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
+00037190: 6e73 7420 7764 6174 6120 3d20 2867 676d  nst wdata = (ggm
+000371a0: 6c5f 6670 3136 5f74 202a 2920 7061 7261  l_fp16_t *) para
+000371b0: 6d73 2d3e 7764 6174 6120 2b20 303b 0a0a  ms->wdata + 0;..
+000371c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000371d0: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
+000371e0: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
+000371f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00037200: 2020 2066 6f72 2028 696e 7420 6930 3120     for (int i01 
+00037210: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
+00037220: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
+00037230: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00037240: 6e73 7420 6767 6d6c 5f66 7031 365f 7420  nst ggml_fp16_t 
+00037250: 2a20 636f 6e73 7420 7372 6320 3d20 2867  * const src = (g
+00037260: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
+00037270: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00037280: 6120 2b20 6930 322a 6e62 3032 202b 2069  a + i02*nb02 + i
+00037290: 3031 2a6e 6230 3129 3b0a 2020 2020 2020  01*nb01);.      
+000372a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000372b0: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
+000372c0: 6461 7461 203d 2077 6461 7461 202b 2069  data = wdata + i
+000372d0: 3032 2a65 7730 2a6e 6530 303b 0a20 2020  02*ew0*ne00;.   
+000372e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000372f0: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
+00037300: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
+00037310: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
+00037320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037330: 6473 745f 6461 7461 5b69 3030 2a65 7730  dst_data[i00*ew0
+00037340: 202b 2069 3031 5d20 3d20 7372 635b 6930   + i01] = src[i0
+00037350: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+00037360: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00037370: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00037380: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00037390: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+000373a0: 7072 6570 6172 6520 736f 7572 6365 2064  prepare source d
+000373b0: 6174 6120 2873 7263 3129 0a20 2020 2020  ata (src1).     
+000373c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000373d0: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
+000373e0: 6f6e 7374 2077 6461 7461 203d 2028 6767  onst wdata = (gg
+000373f0: 6d6c 5f66 7031 365f 7420 2a29 2070 6172  ml_fp16_t *) par
+00037400: 616d 732d 3e77 6461 7461 202b 206e 6530  ams->wdata + ne0
+00037410: 322a 6577 302a 6e65 3030 3b0a 0a20 2020  2*ew0*ne00;..   
+00037420: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00037430: 7420 6931 3120 3d20 303b 2069 3131 203c  t i11 = 0; i11 <
+00037440: 206e 6531 313b 2069 3131 2b2b 2920 7b0a   ne11; i11++) {.
+00037450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037460: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
+00037470: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
+00037480: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
+00037490: 312d 3e64 6174 6120 2b20 6931 312a 6e62  1->data + i11*nb
+000374a0: 3131 293b 0a20 2020 2020 2020 2020 2020  11);.           
+000374b0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+000374c0: 202a 2064 7374 5f64 6174 6120 3d20 7764   * dst_data = wd
+000374d0: 6174 613b 0a20 2020 2020 2020 2020 2020  ata;.           
+000374e0: 2020 2020 2066 6f72 2028 696e 7420 6931       for (int i1
+000374f0: 3020 3d20 303b 2069 3130 203c 206e 6531  0 = 0; i10 < ne1
+00037500: 303b 2069 3130 2b2b 2920 7b0a 2020 2020  0; i10++) {.    
+00037510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037520: 6473 745f 6461 7461 5b28 6931 3020 2b20  dst_data[(i10 + 
+00037530: 6e68 292a 6577 3020 2b20 6931 315d 203d  nh)*ew0 + i11] =
+00037540: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
+00037550: 3136 2873 7263 5b69 3130 5d29 3b0a 2020  16(src[i10]);.  
+00037560: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00037570: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00037580: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00037590: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+000375a0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+000375b0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000375c0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+000375d0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+000375e0: 2020 7d0a 0a20 2020 202f 2f20 746f 7461    }..    // tota
+000375f0: 6c20 726f 7773 2069 6e20 6473 740a 2020  l rows in dst.  
+00037600: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
+00037610: 206e 6530 323b 0a0a 2020 2020 2f2f 2072   ne02;..    // r
+00037620: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+00037630: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+00037640: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+00037650: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+00037660: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+00037670: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00037680: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+00037690: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+000376a0: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+000376b0: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+000376c0: 666f 7220 2869 6e74 2069 3120 3d20 6972  for (int i1 = ir
+000376d0: 303b 2069 3120 3c20 6972 313b 2069 312b  0; i1 < ir1; i1+
+000376e0: 2b29 207b 0a20 2020 2020 2020 2066 6c6f  +) {.        flo
+000376f0: 6174 202a 2064 7374 5f64 6174 6120 3d20  at * dst_data = 
+00037700: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+00037710: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
+00037720: 312a 6e62 3129 3b0a 2020 2020 2020 2020  1*nb1);.        
+00037730: 666f 7220 2869 6e74 2069 3020 3d20 303b  for (int i0 = 0;
+00037740: 2069 3020 3c20 6e65 3130 3b20 6930 202b   i0 < ne10; i0 +
+00037750: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
+00037760: 2020 2064 7374 5f64 6174 615b 6930 2f32     dst_data[i0/2
+00037770: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
+00037780: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
+00037790: 2d6e 683b 206b 203c 3d20 6e68 3b20 6b2b  -nh; k <= nh; k+
+000377a0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000377b0: 2020 2020 2066 6c6f 6174 2076 203d 2030       float v = 0
+000377c0: 2e30 663b 0a20 2020 2020 2020 2020 2020  .0f;.           
+000377d0: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
+000377e0: 745f 6631 3628 6577 302c 2026 762c 0a20  t_f16(ew0, &v,. 
+000377f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037800: 2020 2020 2020 2028 6767 6d6c 5f66 7031         (ggml_fp1
+00037810: 365f 7420 2a29 2070 6172 616d 732d 3e77  6_t *) params->w
+00037820: 6461 7461 202b 2020 2069 312a 6577 302a  data +   i1*ew0*
+00037830: 6e65 3030 202b 2020 2020 2020 286e 6820  ne00 +      (nh 
+00037840: 2b20 6b29 2a65 7730 2c0a 2020 2020 2020  + k)*ew0,.      
+00037850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037860: 2020 2867 676d 6c5f 6670 3136 5f74 202a    (ggml_fp16_t *
+00037870: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
+00037880: 2b20 6e65 3032 2a65 7730 2a6e 6530 3020  + ne02*ew0*ne00 
+00037890: 2b20 2869 3020 2b20 6e68 202b 206b 292a  + (i0 + nh + k)*
+000378a0: 6577 3029 3b0a 0a20 2020 2020 2020 2020  ew0);..         
+000378b0: 2020 2020 2020 2064 7374 5f64 6174 615b         dst_data[
+000378c0: 6930 2f32 5d20 2b3d 2076 3b0a 2020 2020  i0/2] += v;.    
+000378d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000378e0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
+000378f0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00037900: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
+00037910: 6e76 5f31 645f 3273 5f66 3332 280a 2020  nv_1d_2s_f32(.  
+00037920: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00037930: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00037940: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00037950: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00037960: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00037970: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00037980: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00037990: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+000379a0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+000379b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000379c0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+000379d0: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+000379e0: 302d 3e74 7970 6520 3d3d 2047 474d 4c5f  0->type == GGML_
+000379f0: 5459 5045 5f46 3332 293b 0a20 2020 2047  TYPE_F32);.    G
+00037a00: 474d 4c5f 4153 5345 5254 2873 7263 312d  GML_ASSERT(src1-
+00037a10: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00037a20: 5045 5f46 3332 293b 0a20 2020 2047 474d  PE_F32);.    GGM
+00037a30: 4c5f 4153 5345 5254 2820 6473 742d 3e74  L_ASSERT( dst->t
+00037a40: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00037a50: 5f46 3332 293b 0a0a 2020 2020 696e 7436  _F32);..    int6
+00037a60: 345f 7420 7430 203d 2067 676d 6c5f 7065  4_t t0 = ggml_pe
+00037a70: 7266 5f74 696d 655f 7573 2829 3b0a 2020  rf_time_us();.  
+00037a80: 2020 554e 5553 4544 2874 3029 3b0a 0a20    UNUSED(t0);.. 
+00037a90: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+00037aa0: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
+00037ab0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00037ac0: 6530 3120 3d20 7372 6330 2d3e 6e65 5b31  e01 = src0->ne[1
+00037ad0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00037ae0: 206e 6530 3220 3d20 7372 6330 2d3e 6e65   ne02 = src0->ne
+00037af0: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+00037b00: 2069 6e74 206e 6530 3320 3d20 7372 6330   int ne03 = src0
+00037b10: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+00037b20: 6e73 7420 696e 7420 6e65 3130 203d 2073  nst int ne10 = s
+00037b30: 7263 312d 3e6e 655b 305d 3b0a 2020 2020  rc1->ne[0];.    
+00037b40: 636f 6e73 7420 696e 7420 6e65 3131 203d  const int ne11 =
+00037b50: 2073 7263 312d 3e6e 655b 315d 3b0a 2020   src1->ne[1];.  
+00037b60: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
+00037b70: 3132 203d 2073 7263 312d 3e6e 655b 325d  12 = src1->ne[2]
+00037b80: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00037b90: 7420 6e65 3133 203d 2073 7263 312d 3e6e  t ne13 = src1->n
+00037ba0: 655b 335d 3b0a 0a20 2020 202f 2f63 6f6e  e[3];..    //con
+00037bb0: 7374 2069 6e74 206e 6530 2020 3d20 6473  st int ne0  = ds
+00037bc0: 742d 3e6e 655b 305d 3b0a 2020 2020 2f2f  t->ne[0];.    //
+00037bd0: 636f 6e73 7420 696e 7420 6e65 3120 203d  const int ne1  =
+00037be0: 2064 7374 2d3e 6e65 5b31 5d3b 0a20 2020   dst->ne[1];.   
+00037bf0: 202f 2f63 6f6e 7374 2069 6e74 206e 6532   //const int ne2
+00037c00: 2020 3d20 6473 742d 3e6e 655b 325d 3b0a    = dst->ne[2];.
+00037c10: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00037c20: 6e65 3320 203d 2064 7374 2d3e 6e65 5b33  ne3  = dst->ne[3
+00037c30: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00037c40: 6e74 206e 6520 2020 3d20 6e65 302a 6e65  nt ne   = ne0*ne
+00037c50: 312a 6e65 322a 6e65 333b 0a0a 2020 2020  1*ne2*ne3;..    
+00037c60: 636f 6e73 7420 696e 7420 6e62 3030 203d  const int nb00 =
+00037c70: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
+00037c80: 2020 636f 6e73 7420 696e 7420 6e62 3031    const int nb01
+00037c90: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
+00037ca0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00037cb0: 3032 203d 2073 7263 302d 3e6e 625b 325d  02 = src0->nb[2]
+00037cc0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00037cd0: 7420 6e62 3033 203d 2073 7263 302d 3e6e  t nb03 = src0->n
+00037ce0: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00037cf0: 2069 6e74 206e 6231 3020 3d20 7372 6331   int nb10 = src1
+00037d00: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00037d10: 7374 2069 6e74 206e 6231 3120 3d20 7372  st int nb11 = sr
+00037d20: 6331 2d3e 6e62 5b31 5d3b 0a20 2020 202f  c1->nb[1];.    /
+00037d30: 2f63 6f6e 7374 2069 6e74 206e 6231 3220  /const int nb12 
+00037d40: 3d20 7372 6331 2d3e 6e62 5b32 5d3b 0a20  = src1->nb[2];. 
+00037d50: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00037d60: 6231 3320 3d20 7372 6331 2d3e 6e62 5b33  b13 = src1->nb[3
+00037d70: 5d3b 0a0a 2020 2020 2f2f 636f 6e73 7420  ];..    //const 
+00037d80: 696e 7420 6e62 3020 203d 2064 7374 2d3e  int nb0  = dst->
+00037d90: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+00037da0: 2069 6e74 206e 6231 2020 3d20 6473 742d   int nb1  = dst-
+00037db0: 3e6e 625b 315d 3b0a 2020 2020 2f2f 636f  >nb[1];.    //co
+00037dc0: 6e73 7420 696e 7420 6e62 3220 203d 2064  nst int nb2  = d
+00037dd0: 7374 2d3e 6e62 5b32 5d3b 0a20 2020 202f  st->nb[2];.    /
+00037de0: 2f63 6f6e 7374 2069 6e74 206e 6233 2020  /const int nb3  
+00037df0: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
+00037e00: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
+00037e10: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
+00037e20: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
+00037e30: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
+00037e40: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00037e50: 6e6b 203d 206e 6530 303b 0a20 2020 2063  nk = ne00;.    c
+00037e60: 6f6e 7374 2069 6e74 206e 6820 3d20 6e6b  onst int nh = nk
+00037e70: 2f32 3b0a 0a20 2020 2063 6f6e 7374 2069  /2;..    const i
+00037e80: 6e74 2065 7730 203d 2067 676d 6c5f 7570  nt ew0 = ggml_up
+00037e90: 3332 286e 6530 3129 3b0a 0a20 2020 2047  32(ne01);..    G
+00037ea0: 474d 4c5f 4153 5345 5254 286e 6530 3020  GML_ASSERT(ne00 
+00037eb0: 2520 3220 3d3d 2031 293b 202f 2f20 544f  % 2 == 1); // TO
+00037ec0: 444f 3a20 7375 7070 6f72 7420 6576 656e  DO: support even
+00037ed0: 206b 6572 6e65 6c20 7369 7a65 730a 2020   kernel sizes.  
+00037ee0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+00037ef0: 3030 203d 3d20 7369 7a65 6f66 2866 6c6f  00 == sizeof(flo
+00037f00: 6174 2929 3b0a 2020 2020 4747 4d4c 5f41  at));.    GGML_A
+00037f10: 5353 4552 5428 6e62 3130 203d 3d20 7369  SSERT(nb10 == si
+00037f20: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
+00037f30: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+00037f40: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00037f50: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
+00037f60: 202f 2f20 544f 444f 3a20 6669 7820 7468   // TODO: fix th
+00037f70: 6973 206d 656d 7365 7420 2877 7369 7a65  is memset (wsize
+00037f80: 2069 7320 6f76 6572 6573 7469 6d61 7465   is overestimate
+00037f90: 6429 0a20 2020 2020 2020 206d 656d 7365  d).        memse
+00037fa0: 7428 7061 7261 6d73 2d3e 7764 6174 612c  t(params->wdata,
+00037fb0: 2030 2c20 7061 7261 6d73 2d3e 7773 697a   0, params->wsiz
+00037fc0: 6529 3b0a 0a20 2020 2020 2020 202f 2f20  e);..        // 
+00037fd0: 7072 6570 6172 6520 6b65 726e 656c 2064  prepare kernel d
+00037fe0: 6174 6120 2873 7263 3029 0a20 2020 2020  ata (src0).     
+00037ff0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00038000: 2066 6c6f 6174 202a 2063 6f6e 7374 2077   float * const w
+00038010: 6461 7461 203d 2028 666c 6f61 7420 2a29  data = (float *)
+00038020: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00038030: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
+00038040: 2066 6f72 2028 696e 7420 6930 3220 3d20   for (int i02 = 
+00038050: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
+00038060: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
+00038070: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00038080: 2069 3031 203d 2030 3b20 6930 3120 3c20   i01 = 0; i01 < 
+00038090: 6e65 3031 3b20 6930 312b 2b29 207b 0a20  ne01; i01++) {. 
+000380a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000380b0: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
+000380c0: 2063 6f6e 7374 2073 7263 203d 2028 666c   const src = (fl
+000380d0: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+000380e0: 7372 6330 2d3e 6461 7461 202b 2069 3032  src0->data + i02
+000380f0: 2a6e 6230 3220 2b20 6930 312a 6e62 3031  *nb02 + i01*nb01
+00038100: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00038110: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
+00038120: 7374 5f64 6174 6120 3d20 7764 6174 6120  st_data = wdata 
+00038130: 2b20 6930 322a 6577 302a 6e65 3030 3b0a  + i02*ew0*ne00;.
+00038140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038150: 2020 2020 666f 7220 2869 6e74 2069 3030      for (int i00
+00038160: 203d 2030 3b20 6930 3020 3c20 6e65 3030   = 0; i00 < ne00
+00038170: 3b20 6930 302b 2b29 207b 0a20 2020 2020  ; i00++) {.     
+00038180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038190: 2020 2064 7374 5f64 6174 615b 6930 302a     dst_data[i00*
+000381a0: 6577 3020 2b20 6930 315d 203d 2073 7263  ew0 + i01] = src
+000381b0: 5b69 3030 5d3b 0a20 2020 2020 2020 2020  [i00];.         
+000381c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000381d0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000381e0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000381f0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00038200: 2f2f 2070 7265 7061 7265 2073 6f75 7263  // prepare sourc
+00038210: 6520 6461 7461 2028 7372 6331 290a 2020  e data (src1).  
+00038220: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00038230: 2020 2020 666c 6f61 7420 2a20 636f 6e73      float * cons
+00038240: 7420 7764 6174 6120 3d20 2866 6c6f 6174  t wdata = (float
+00038250: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+00038260: 6120 2b20 6e65 3032 2a65 7730 2a6e 6530  a + ne02*ew0*ne0
+00038270: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
+00038280: 666f 7220 2869 6e74 2069 3131 203d 2030  for (int i11 = 0
+00038290: 3b20 6931 3120 3c20 6e65 3131 3b20 6931  ; i11 < ne11; i1
+000382a0: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+000382b0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+000382c0: 6174 202a 2063 6f6e 7374 2073 7263 203d  at * const src =
+000382d0: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+000382e0: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
+000382f0: 2069 3131 2a6e 6231 3129 3b0a 2020 2020   i11*nb11);.    
+00038300: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+00038310: 7420 2a20 6473 745f 6461 7461 203d 2077  t * dst_data = w
+00038320: 6461 7461 3b0a 2020 2020 2020 2020 2020  data;.          
+00038330: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00038340: 3130 203d 2030 3b20 6931 3020 3c20 6e65  10 = 0; i10 < ne
+00038350: 3130 3b20 6931 302b 2b29 207b 0a20 2020  10; i10++) {.   
+00038360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038370: 2064 7374 5f64 6174 615b 2869 3130 202b   dst_data[(i10 +
+00038380: 206e 6829 2a65 7730 202b 2069 3131 5d20   nh)*ew0 + i11] 
+00038390: 3d20 7372 635b 6931 305d 3b0a 2020 2020  = src[i10];.    
+000383a0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+000383b0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000383c0: 2020 2020 7d0a 0a20 2020 2020 2020 2072      }..        r
+000383d0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+000383e0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+000383f0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00038400: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00038410: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00038420: 7d0a 0a20 2020 202f 2f20 746f 7461 6c20  }..    // total 
+00038430: 726f 7773 2069 6e20 6473 740a 2020 2020  rows in dst.    
+00038440: 636f 6e73 7420 696e 7420 6e72 203d 206e  const int nr = n
+00038450: 6530 323b 0a0a 2020 2020 2f2f 2072 6f77  e02;..    // row
+00038460: 7320 7065 7220 7468 7265 6164 0a20 2020  s per thread.   
+00038470: 2063 6f6e 7374 2069 6e74 2064 7220 3d20   const int dr = 
+00038480: 286e 7220 2b20 6e74 6820 2d20 3129 2f6e  (nr + nth - 1)/n
+00038490: 7468 3b0a 0a20 2020 202f 2f20 726f 7720  th;..    // row 
+000384a0: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
+000384b0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+000384c0: 696e 7420 6972 3020 3d20 6472 2a69 7468  int ir0 = dr*ith
+000384d0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000384e0: 6972 3120 3d20 4d49 4e28 6972 3020 2b20  ir1 = MIN(ir0 + 
+000384f0: 6472 2c20 6e72 293b 0a0a 2020 2020 666f  dr, nr);..    fo
+00038500: 7220 2869 6e74 2069 3120 3d20 6972 303b  r (int i1 = ir0;
+00038510: 2069 3120 3c20 6972 313b 2069 312b 2b29   i1 < ir1; i1++)
+00038520: 207b 0a20 2020 2020 2020 2066 6c6f 6174   {.        float
+00038530: 202a 2064 7374 5f64 6174 6120 3d20 2866   * dst_data = (f
+00038540: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+00038550: 2064 7374 2d3e 6461 7461 202b 2069 312a   dst->data + i1*
+00038560: 6e62 3129 3b0a 2020 2020 2020 2020 666f  nb1);.        fo
+00038570: 7220 2869 6e74 2069 3020 3d20 303b 2069  r (int i0 = 0; i
+00038580: 3020 3c20 6e65 3130 3b20 6930 202b 3d20  0 < ne10; i0 += 
+00038590: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
+000385a0: 2064 7374 5f64 6174 615b 6930 2f32 5d20   dst_data[i0/2] 
+000385b0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+000385c0: 2066 6f72 2028 696e 7420 6b20 3d20 2d6e   for (int k = -n
+000385d0: 683b 206b 203c 3d20 6e68 3b20 6b2b 2b29  h; k <= nh; k++)
+000385e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000385f0: 2020 2066 6c6f 6174 2076 203d 2030 2e30     float v = 0.0
+00038600: 663b 0a20 2020 2020 2020 2020 2020 2020  f;.             
+00038610: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
+00038620: 6633 3228 6577 302c 2026 762c 0a20 2020  f32(ew0, &v,.   
+00038630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038640: 2020 2020 2028 666c 6f61 7420 2a29 2070       (float *) p
+00038650: 6172 616d 732d 3e77 6461 7461 202b 2020  arams->wdata +  
+00038660: 2069 312a 6577 302a 6e65 3030 202b 2020   i1*ew0*ne00 +  
+00038670: 2020 2020 286e 6820 2b20 6b29 2a65 7730      (nh + k)*ew0
+00038680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00038690: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+000386a0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+000386b0: 6120 2b20 6e65 3032 2a65 7730 2a6e 6530  a + ne02*ew0*ne0
+000386c0: 3020 2b20 2869 3020 2b20 6e68 202b 206b  0 + (i0 + nh + k
+000386d0: 292a 6577 3029 3b0a 0a20 2020 2020 2020  )*ew0);..       
+000386e0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+000386f0: 615b 6930 2f32 5d20 2b3d 2076 3b0a 2020  a[i0/2] += v;.  
+00038700: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00038710: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00038720: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00038730: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00038740: 636f 6e76 5f31 645f 3273 280a 2020 2020  conv_1d_2s(.    
+00038750: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00038760: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00038770: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00038780: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00038790: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000387a0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+000387b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000387c0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+000387d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000387e0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+000387f0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+00038800: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00038810: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00038820: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
+00038830: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00038840: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00038850: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
+00038860: 6e76 5f31 645f 3273 5f66 3136 5f66 3332  nv_1d_2s_f16_f32
+00038870: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+00038880: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00038890: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000388a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000388b0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+000388c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000388d0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+000388e0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+000388f0: 6f6e 765f 3164 5f32 735f 6633 3228 7061  onv_1d_2s_f32(pa
+00038900: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
+00038910: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+00038920: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00038930: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00038940: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
+00038950: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00038960: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
+00038970: 6173 6520 4747 4d4c 5f54 5950 455f 4938  ase GGML_TYPE_I8
+00038980: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00038990: 474d 4c5f 5459 5045 5f49 3136 3a0a 2020  GML_TYPE_I16:.  
+000389a0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000389b0: 5459 5045 5f49 3332 3a0a 2020 2020 2020  TYPE_I32:.      
+000389c0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+000389d0: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
+000389e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000389f0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00038a00: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+00038a10: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00038a20: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
+00038a30: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00038a40: 666c 6173 685f 6174 746e 0a0a 7374 6174  flash_attn..stat
+00038a50: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00038a60: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
+00038a70: 7368 5f61 7474 6e5f 6633 3228 0a20 2020  sh_attn_f32(.   
+00038a80: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00038a90: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00038aa0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00038ab0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00038ac0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00038ad0: 202a 2071 2c0a 2020 2020 2020 2020 636f   * q,.        co
+00038ae0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00038af0: 7465 6e73 6f72 202a 206b 2c0a 2020 2020  tensor * k,.    
+00038b00: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00038b10: 2067 676d 6c5f 7465 6e73 6f72 202a 2076   ggml_tensor * v
+00038b20: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00038b30: 626f 6f6c 206d 6173 6b65 642c 0a20 2020  bool masked,.   
+00038b40: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+00038b50: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00038b60: 7374 2920 7b0a 2020 2020 696e 7436 345f  st) {.    int64_
+00038b70: 7420 7430 203d 2067 676d 6c5f 7065 7266  t t0 = ggml_perf
+00038b80: 5f74 696d 655f 7573 2829 3b0a 2020 2020  _time_us();.    
+00038b90: 554e 5553 4544 2874 3029 3b0a 0a20 2020  UNUSED(t0);..   
+00038ba0: 2063 6f6e 7374 2069 6e74 206e 6571 3020   const int neq0 
+00038bb0: 3d20 712d 3e6e 655b 305d 3b0a 2020 2020  = q->ne[0];.    
+00038bc0: 636f 6e73 7420 696e 7420 6e65 7131 203d  const int neq1 =
+00038bd0: 2071 2d3e 6e65 5b31 5d3b 0a20 2020 2063   q->ne[1];.    c
+00038be0: 6f6e 7374 2069 6e74 206e 6571 3220 3d20  onst int neq2 = 
+00038bf0: 712d 3e6e 655b 325d 3b0a 2020 2020 636f  q->ne[2];.    co
+00038c00: 6e73 7420 696e 7420 6e65 7133 203d 2071  nst int neq3 = q
+00038c10: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+00038c20: 6e73 7420 696e 7420 6e65 6b30 203d 206b  nst int nek0 = k
+00038c30: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00038c40: 7374 2069 6e74 206e 656b 3120 3d20 6b2d  st int nek1 = k-
+00038c50: 3e6e 655b 315d 3b0a 2020 2020 2f2f 636f  >ne[1];.    //co
+00038c60: 6e73 7420 696e 7420 6e65 6b32 203d 206b  nst int nek2 = k
+00038c70: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
+00038c80: 6f6e 7374 2069 6e74 206e 656b 3320 3d20  onst int nek3 = 
+00038c90: 6b2d 3e6e 655b 335d 3b0a 0a20 2020 202f  k->ne[3];..    /
+00038ca0: 2f63 6f6e 7374 2069 6e74 206e 6576 3020  /const int nev0 
+00038cb0: 3d20 762d 3e6e 655b 305d 3b0a 2020 2020  = v->ne[0];.    
+00038cc0: 636f 6e73 7420 696e 7420 6e65 7631 203d  const int nev1 =
+00038cd0: 2076 2d3e 6e65 5b31 5d3b 0a20 2020 202f   v->ne[1];.    /
+00038ce0: 2f63 6f6e 7374 2069 6e74 206e 6576 3220  /const int nev2 
+00038cf0: 3d20 762d 3e6e 655b 325d 3b0a 2020 2020  = v->ne[2];.    
+00038d00: 2f2f 636f 6e73 7420 696e 7420 6e65 7633  //const int nev3
+00038d10: 203d 2076 2d3e 6e65 5b33 5d3b 0a0a 2020   = v->ne[3];..  
+00038d20: 2020 636f 6e73 7420 696e 7420 6e65 3020    const int ne0 
+00038d30: 203d 2064 7374 2d3e 6e65 5b30 5d3b 0a20   = dst->ne[0];. 
+00038d40: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
+00038d50: 2020 3d20 6473 742d 3e6e 655b 315d 3b0a    = dst->ne[1];.
+00038d60: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00038d70: 6e65 3220 203d 2064 7374 2d3e 6e65 5b32  ne2  = dst->ne[2
+00038d80: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00038d90: 6e74 206e 6533 2020 3d20 6473 742d 3e6e  nt ne3  = dst->n
+00038da0: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+00038db0: 2069 6e74 206e 626b 3020 3d20 6b2d 3e6e   int nbk0 = k->n
+00038dc0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00038dd0: 696e 7420 6e62 6b31 203d 206b 2d3e 6e62  int nbk1 = k->nb
+00038de0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00038df0: 6e74 206e 626b 3220 3d20 6b2d 3e6e 625b  nt nbk2 = k->nb[
+00038e00: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00038e10: 7420 6e62 6b33 203d 206b 2d3e 6e62 5b33  t nbk3 = k->nb[3
+00038e20: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00038e30: 7420 6e62 7130 203d 2071 2d3e 6e62 5b30  t nbq0 = q->nb[0
+00038e40: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00038e50: 206e 6271 3120 3d20 712d 3e6e 625b 315d   nbq1 = q->nb[1]
+00038e60: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00038e70: 6e62 7132 203d 2071 2d3e 6e62 5b32 5d3b  nbq2 = q->nb[2];
+00038e80: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00038e90: 6271 3320 3d20 712d 3e6e 625b 335d 3b0a  bq3 = q->nb[3];.
+00038ea0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00038eb0: 6276 3020 3d20 762d 3e6e 625b 305d 3b0a  bv0 = v->nb[0];.
+00038ec0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00038ed0: 7631 203d 2076 2d3e 6e62 5b31 5d3b 0a20  v1 = v->nb[1];. 
+00038ee0: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
+00038ef0: 3220 3d20 762d 3e6e 625b 325d 3b0a 2020  2 = v->nb[2];.  
+00038f00: 2020 636f 6e73 7420 696e 7420 6e62 7633    const int nbv3
+00038f10: 203d 2076 2d3e 6e62 5b33 5d3b 0a0a 2020   = v->nb[3];..  
+00038f20: 2020 636f 6e73 7420 696e 7420 6e62 3020    const int nb0 
+00038f30: 203d 2064 7374 2d3e 6e62 5b30 5d3b 0a20   = dst->nb[0];. 
+00038f40: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+00038f50: 2020 3d20 6473 742d 3e6e 625b 315d 3b0a    = dst->nb[1];.
+00038f60: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00038f70: 3220 203d 2064 7374 2d3e 6e62 5b32 5d3b  2  = dst->nb[2];
+00038f80: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00038f90: 6233 2020 3d20 6473 742d 3e6e 625b 335d  b3  = dst->nb[3]
+00038fa0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00038fb0: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+00038fc0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00038fd0: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+00038fe0: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+00038ff0: 696e 7420 4420 3d20 6e65 7130 3b0a 2020  int D = neq0;.  
+00039000: 2020 636f 6e73 7420 696e 7420 4e20 3d20    const int N = 
+00039010: 6e65 7131 3b0a 2020 2020 636f 6e73 7420  neq1;.    const 
+00039020: 696e 7420 5020 3d20 6e65 6b31 202d 204e  int P = nek1 - N
+00039030: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00039040: 4d20 3d20 5020 2b20 4e3b 0a0a 2020 2020  M = P + N;..    
+00039050: 636f 6e73 7420 696e 7420 4d75 7020 3d20  const int Mup = 
+00039060: 6767 6d6c 5f75 7028 4d2c 2047 474d 4c5f  ggml_up(M, GGML_
+00039070: 534f 4654 5f4d 4158 5f55 4e52 4f4c 4c29  SOFT_MAX_UNROLL)
+00039080: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00039090: 5254 286e 6530 203d 3d20 4429 3b0a 2020  RT(ne0 == D);.  
+000390a0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+000390b0: 3120 3d3d 204e 293b 0a20 2020 2047 474d  1 == N);.    GGM
+000390c0: 4c5f 4153 5345 5254 2850 203e 3d20 3029  L_ASSERT(P >= 0)
+000390d0: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+000390e0: 5254 286e 6271 3020 3d3d 2073 697a 656f  RT(nbq0 == sizeo
+000390f0: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
+00039100: 474d 4c5f 4153 5345 5254 286e 626b 3020  GML_ASSERT(nbk0 
+00039110: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00039120: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00039130: 5254 286e 6276 3020 3d3d 2073 697a 656f  RT(nbv0 == sizeo
+00039140: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00039150: 4747 4d4c 5f41 5353 4552 5428 6e65 7130  GGML_ASSERT(neq0
+00039160: 203d 3d20 4429 3b0a 2020 2020 4747 4d4c   == D);.    GGML
+00039170: 5f41 5353 4552 5428 6e65 6b30 203d 3d20  _ASSERT(nek0 == 
+00039180: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
+00039190: 4552 5428 6e65 7631 203d 3d20 4429 3b0a  ERT(nev1 == D);.
+000391a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000391b0: 286e 6571 3120 3d3d 204e 293b 0a20 2020  (neq1 == N);.   
+000391c0: 2047 474d 4c5f 4153 5345 5254 286e 656b   GGML_ASSERT(nek
+000391d0: 3120 3d3d 204e 202b 2050 293b 0a20 2020  1 == N + P);.   
+000391e0: 2047 474d 4c5f 4153 5345 5254 286e 6576   GGML_ASSERT(nev
+000391f0: 3120 3d3d 2044 293b 0a0a 2020 2020 2f2f  1 == D);..    //
+00039200: 2064 7374 2063 616e 6e6f 7420 6265 2074   dst cannot be t
+00039210: 7261 6e73 706f 7365 6420 6f72 2070 6572  ransposed or per
+00039220: 6d75 7465 640a 2020 2020 4747 4d4c 5f41  muted.    GGML_A
+00039230: 5353 4552 5428 6e62 3020 3d3d 2073 697a  SSERT(nb0 == siz
+00039240: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
+00039250: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
+00039260: 203c 3d20 6e62 3129 3b0a 2020 2020 4747   <= nb1);.    GG
+00039270: 4d4c 5f41 5353 4552 5428 6e62 3120 3c3d  ML_ASSERT(nb1 <=
+00039280: 206e 6232 293b 0a20 2020 2047 474d 4c5f   nb2);.    GGML_
+00039290: 4153 5345 5254 286e 6232 203c 3d20 6e62  ASSERT(nb2 <= nb
+000392a0: 3329 3b0a 0a20 2020 2069 6620 2870 6172  3);..    if (par
+000392b0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+000392c0: 4c5f 5441 534b 5f49 4e49 5429 207b 0a20  L_TASK_INIT) {. 
+000392d0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+000392e0: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
+000392f0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00039300: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+00039310: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+00039320: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
+00039330: 2f20 7061 7261 6c6c 656c 697a 6520 6279  / parallelize by
+00039340: 2071 2072 6f77 7320 7573 696e 6720 6767   q rows using gg
+00039350: 6d6c 5f76 6563 5f64 6f74 5f66 3332 0a0a  ml_vec_dot_f32..
+00039360: 2020 2020 2f2f 2074 6f74 616c 2072 6f77      // total row
+00039370: 7320 696e 2071 0a20 2020 2063 6f6e 7374  s in q.    const
+00039380: 2069 6e74 206e 7220 3d20 6e65 7131 2a6e   int nr = neq1*n
+00039390: 6571 322a 6e65 7133 3b0a 0a20 2020 202f  eq2*neq3;..    /
+000393a0: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
+000393b0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+000393c0: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
+000393d0: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
+000393e0: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
+000393f0: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
+00039400: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
+00039410: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
+00039420: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
+00039430: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
+00039440: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
+00039450: 6361 6c65 203d 2031 2e30 662f 7371 7274  cale = 1.0f/sqrt
+00039460: 6628 4429 3b0a 0a20 2020 202f 2f70 7269  f(D);..    //pri
+00039470: 6e74 6628 2250 3d25 6420 4e3d 2564 2044  ntf("P=%d N=%d D
+00039480: 3d25 6420 6972 303d 2564 2069 7231 3d25  =%d ir0=%d ir1=%
+00039490: 6420 7363 616c 6520 3d20 2566 5c6e 222c  d scale = %f\n",
+000394a0: 2050 2c20 4e2c 2044 2c20 6972 302c 2069   P, N, D, ir0, i
+000394b0: 7231 2c20 7363 616c 6529 3b0a 0a20 2020  r1, scale);..   
+000394c0: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
+000394d0: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
+000394e0: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
+000394f0: 2071 2069 6e64 6963 6573 0a20 2020 2020   q indices.     
+00039500: 2020 2063 6f6e 7374 2069 6e74 2069 7133     const int iq3
+00039510: 203d 2069 722f 286e 6571 322a 6e65 7131   = ir/(neq2*neq1
+00039520: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+00039530: 2069 6e74 2069 7132 203d 2028 6972 202d   int iq2 = (ir -
+00039540: 2069 7133 2a6e 6571 322a 6e65 7131 292f   iq3*neq2*neq1)/
+00039550: 6e65 7131 3b0a 2020 2020 2020 2020 636f  neq1;.        co
+00039560: 6e73 7420 696e 7420 6971 3120 3d20 2869  nst int iq1 = (i
+00039570: 7220 2d20 6971 332a 6e65 7132 2a6e 6571  r - iq3*neq2*neq
+00039580: 3120 2d20 6971 322a 6e65 7131 293b 0a0a  1 - iq2*neq1);..
+00039590: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+000395a0: 5320 3d20 2866 6c6f 6174 202a 2920 7061  S = (float *) pa
+000395b0: 7261 6d73 2d3e 7764 6174 6120 2b20 6974  rams->wdata + it
+000395c0: 682a 284d 7570 202b 2043 4143 4845 5f4c  h*(Mup + CACHE_L
+000395d0: 494e 455f 5349 5a45 5f46 3332 293b 0a0a  INE_SIZE_F32);..
+000395e0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000395f0: 2069 203d 204d 3b20 6920 3c20 4d75 703b   i = M; i < Mup;
+00039600: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00039610: 2020 2020 535b 695d 203d 202d 494e 4649      S[i] = -INFI
+00039620: 4e49 5459 3b0a 2020 2020 2020 2020 7d0a  NITY;.        }.
+00039630: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00039640: 7420 6963 203d 2030 3b20 6963 203c 206e  t ic = 0; ic < n
+00039650: 656b 313b 202b 2b69 6329 207b 0a20 2020  ek1; ++ic) {.   
+00039660: 2020 2020 2020 2020 202f 2f20 6b20 696e           // k in
+00039670: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+00039680: 2020 636f 6e73 7420 696e 7420 696b 3320    const int ik3 
+00039690: 3d20 6971 333b 0a20 2020 2020 2020 2020  = iq3;.         
+000396a0: 2020 2063 6f6e 7374 2069 6e74 2069 6b32     const int ik2
+000396b0: 203d 2069 7132 3b0a 2020 2020 2020 2020   = iq2;.        
+000396c0: 2020 2020 636f 6e73 7420 696e 7420 696b      const int ik
+000396d0: 3120 3d20 6963 3b0a 0a20 2020 2020 2020  1 = ic;..       
+000396e0: 2020 2020 202f 2f20 5320 696e 6469 6365       // S indice
+000396f0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
+00039700: 6e73 7420 696e 7420 6931 203d 2069 6b31  nst int i1 = ik1
+00039710: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
+00039720: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
+00039730: 6e65 7130 2c0a 2020 2020 2020 2020 2020  neq0,.          
+00039740: 2020 2020 2020 2020 2020 5320 2b20 6931            S + i1
+00039750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00039760: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00039770: 2828 6368 6172 202a 2920 6b2d 3e64 6174  ((char *) k->dat
+00039780: 6120 2b20 2869 6b31 2a6e 626b 3120 2b20  a + (ik1*nbk1 + 
+00039790: 696b 322a 6e62 6b32 202b 2069 6b33 2a6e  ik2*nbk2 + ik3*n
+000397a0: 626b 3329 292c 0a20 2020 2020 2020 2020  bk3)),.         
+000397b0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+000397c0: 7420 2a29 2028 2863 6861 7220 2a29 2071  t *) ((char *) q
+000397d0: 2d3e 6461 7461 202b 2028 6971 312a 6e62  ->data + (iq1*nb
+000397e0: 7131 202b 2069 7132 2a6e 6271 3220 2b20  q1 + iq2*nbq2 + 
+000397f0: 6971 332a 6e62 7133 2929 293b 0a20 2020  iq3*nbq3)));.   
+00039800: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00039810: 2f2f 2073 6361 6c65 0a20 2020 2020 2020  // scale.       
+00039820: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
+00039830: 6633 3228 6e65 6b31 2c20 532c 2073 6361  f32(nek1, S, sca
+00039840: 6c65 293b 0a0a 2020 2020 2020 2020 6966  le);..        if
+00039850: 2028 6d61 736b 6564 2920 7b0a 2020 2020   (masked) {.    
+00039860: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00039870: 2069 203d 2050 3b20 6920 3c20 4d3b 2069   i = P; i < M; i
+00039880: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00039890: 2020 2020 2020 6966 2028 6920 3e20 5020        if (i > P 
+000398a0: 2b20 6971 3129 207b 0a20 2020 2020 2020  + iq1) {.       
+000398b0: 2020 2020 2020 2020 2020 2020 2053 5b69               S[i
+000398c0: 5d20 3d20 2d49 4e46 494e 4954 593b 0a20  ] = -INFINITY;. 
+000398d0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000398e0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+000398f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00039900: 2020 2f2f 2073 6f66 746d 6178 0a20 2020    // softmax.   
+00039910: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00039920: 2020 2066 6c6f 6174 206d 6178 203d 202d     float max = -
+00039930: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
+00039940: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
+00039950: 6178 5f66 3332 284d 2c20 266d 6178 2c20  ax_f32(M, &max, 
+00039960: 5329 3b0a 0a20 2020 2020 2020 2020 2020  S);..           
+00039970: 2067 676d 6c5f 666c 6f61 7420 7375 6d20   ggml_float sum 
+00039980: 3d20 302e 303b 0a20 2020 2020 2020 2020  = 0.0;.         
+00039990: 2020 207b 0a23 6966 6465 6620 4747 4d4c     {.#ifdef GGML
+000399a0: 5f53 4f46 545f 4d41 585f 4143 4345 4c45  _SOFT_MAX_ACCELE
+000399b0: 5241 5445 0a20 2020 2020 2020 2020 2020  RATE.           
+000399c0: 2020 2020 206d 6178 203d 202d 6d61 783b       max = -max;
+000399d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000399e0: 2076 4453 505f 7673 6164 6428 532c 2031   vDSP_vsadd(S, 1
+000399f0: 2c20 266d 6178 2c20 532c 2031 2c20 4d75  , &max, S, 1, Mu
+00039a00: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
+00039a10: 2020 2020 7676 6578 7066 2853 2c20 532c      vvexpf(S, S,
+00039a20: 2026 4d75 7029 3b0a 2020 2020 2020 2020   &Mup);.        
+00039a30: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00039a40: 5f73 756d 5f66 3332 284d 7570 2c20 2673  _sum_f32(Mup, &s
+00039a50: 756d 2c20 5329 3b0a 2365 6c73 650a 2020  um, S);.#else.  
+00039a60: 2020 2020 2020 2020 2020 2020 2020 7569                ui
+00039a70: 6e74 3136 5f74 2020 2073 6376 745b 4747  nt16_t   scvt[GG
+00039a80: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
+00039a90: 4c4c 5d3b 0a20 2020 2020 2020 2020 2020  LL];.           
+00039aa0: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
+00039ab0: 7375 6d70 5b47 474d 4c5f 534f 4654 5f4d  sump[GGML_SOFT_M
+00039ac0: 4158 5f55 4e52 4f4c 4c5d 203d 207b 2030  AX_UNROLL] = { 0
+00039ad0: 2e30 207d 3b0a 0a20 2020 2020 2020 2020  .0 };..         
+00039ae0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00039af0: 6920 3d20 303b 2069 203c 204d 7570 3b20  i = 0; i < Mup; 
+00039b00: 6920 2b3d 2047 474d 4c5f 534f 4654 5f4d  i += GGML_SOFT_M
+00039b10: 4158 5f55 4e52 4f4c 4c29 207b 0a20 2020  AX_UNROLL) {.   
+00039b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b30: 2066 6c6f 6174 202a 2053 5320 3d20 5320   float * SS = S 
+00039b40: 2b20 693b 0a0a 2020 2020 2020 2020 2020  + i;..          
+00039b50: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00039b60: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
+00039b70: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
+00039b80: 4c4c 3b20 2b2b 6a29 207b 0a20 2020 2020  LL; ++j) {.     
+00039b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039ba0: 2020 2069 6620 2853 535b 6a5d 203d 3d20     if (SS[j] == 
+00039bb0: 2d49 4e46 494e 4954 5929 207b 0a20 2020  -INFINITY) {.   
+00039bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039bd0: 2020 2020 2020 2020 2053 535b 6a5d 203d           SS[j] =
+00039be0: 2030 2e30 663b 0a20 2020 2020 2020 2020   0.0f;.         
+00039bf0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00039c00: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00039c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c20: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+00039c30: 7320 3d20 4747 4d4c 5f46 5033 325f 544f  s = GGML_FP32_TO
+00039c40: 5f46 5031 3628 5353 5b6a 5d20 2d20 6d61  _FP16(SS[j] - ma
+00039c50: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
+00039c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c70: 6d65 6d63 7079 2826 7363 7674 5b6a 5d2c  memcpy(&scvt[j],
+00039c80: 2026 732c 2073 697a 656f 6628 7569 6e74   &s, sizeof(uint
+00039c90: 3136 5f74 2929 3b0a 2020 2020 2020 2020  16_t));.        
+00039ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039cb0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00039cc0: 7661 6c20 3d20 4747 4d4c 5f46 5031 365f  val = GGML_FP16_
+00039cd0: 544f 5f46 5033 3228 7461 626c 655f 6578  TO_FP32(table_ex
+00039ce0: 705f 6631 365b 7363 7674 5b6a 5d5d 293b  p_f16[scvt[j]]);
+00039cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039d00: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+00039d10: 705b 6a5d 202b 3d20 2867 676d 6c5f 666c  p[j] += (ggml_fl
+00039d20: 6f61 7429 7661 6c3b 0a20 2020 2020 2020  oat)val;.       
+00039d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d40: 2020 2020 2053 535b 6a5d 203d 2076 616c       SS[j] = val
+00039d50: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00039d60: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00039d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d80: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00039d90: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00039da0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00039db0: 3d20 303b 2069 203c 2047 474d 4c5f 534f  = 0; i < GGML_SO
+00039dc0: 4654 5f4d 4158 5f55 4e52 4f4c 4c3b 2069  FT_MAX_UNROLL; i
+00039dd0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00039de0: 2020 2020 2020 2020 2020 7375 6d20 2b3d            sum +=
+00039df0: 2073 756d 705b 695d 3b0a 2020 2020 2020   sump[i];.      
+00039e00: 2020 2020 2020 2020 2020 7d0a 2365 6e64            }.#end
+00039e10: 6966 0a20 2020 2020 2020 2020 2020 207d  if.            }
+00039e20: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+00039e30: 7365 7274 2873 756d 203e 2030 2e30 293b  sert(sum > 0.0);
+00039e40: 0a0a 2020 2020 2020 2020 2020 2020 7375  ..            su
+00039e50: 6d20 3d20 312e 302f 7375 6d3b 0a20 2020  m = 1.0/sum;.   
+00039e60: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00039e70: 635f 7363 616c 655f 6633 3228 4d2c 2053  c_scale_f32(M, S
+00039e80: 2c20 7375 6d29 3b0a 0a23 6966 6e64 6566  , sum);..#ifndef
+00039e90: 204e 4445 4255 470a 2020 2020 2020 2020   NDEBUG.        
+00039ea0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00039eb0: 2030 3b20 6920 3c20 4d3b 202b 2b69 2920   0; i < M; ++i) 
+00039ec0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00039ed0: 2020 6173 7365 7274 2821 6973 6e61 6e28    assert(!isnan(
+00039ee0: 535b 695d 2929 3b0a 2020 2020 2020 2020  S[i]));.        
+00039ef0: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
+00039f00: 6973 696e 6628 535b 695d 2929 3b0a 2020  isinf(S[i]));.  
+00039f10: 2020 2020 2020 2020 2020 7d0a 2365 6e64            }.#end
+00039f20: 6966 0a20 2020 2020 2020 207d 0a0a 2020  if.        }..  
+00039f30: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00039f40: 6320 3d20 303b 2069 6320 3c20 6e65 7631  c = 0; ic < nev1
+00039f50: 3b20 2b2b 6963 2920 7b0a 2020 2020 2020  ; ++ic) {.      
+00039f60: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
+00039f70: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
+00039f80: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
+00039f90: 6971 313b 0a20 2020 2020 2020 2020 2020  iq1;.           
+00039fa0: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
+00039fb0: 6971 323b 0a20 2020 2020 2020 2020 2020  iq2;.           
+00039fc0: 2063 6f6e 7374 2069 6e74 2069 3320 3d20   const int i3 = 
+00039fd0: 6971 333b 0a0a 2020 2020 2020 2020 2020  iq3;..          
+00039fe0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+00039ff0: 3332 286e 656b 312c 0a20 2020 2020 2020  32(nek1,.       
+0003a000: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+0003a010: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0003a020: 2064 7374 2d3e 6461 7461 202b 2028 6963   dst->data + (ic
+0003a030: 2a6e 6230 202b 2069 312a 6e62 3120 202b  *nb0 + i1*nb1  +
+0003a040: 2069 322a 6e62 3220 202b 2069 332a 6e62   i2*nb2  + i3*nb
+0003a050: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+0003a060: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+0003a070: 2a29 2028 2863 6861 7220 2a29 2076 2d3e  *) ((char *) v->
+0003a080: 6461 7461 2020 202b 2028 2020 2020 2020  data   + (      
+0003a090: 2020 2069 632a 6e62 7631 202b 2069 322a     ic*nbv1 + i2*
+0003a0a0: 6e62 7632 202b 2069 332a 6e62 7633 2929  nbv2 + i3*nbv3))
+0003a0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003a0c0: 2020 2020 2020 5329 3b0a 2020 2020 2020        S);.      
+0003a0d0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
+0003a0e0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+0003a0f0: 6d70 7574 655f 666f 7277 6172 645f 666c  mpute_forward_fl
+0003a100: 6173 685f 6174 746e 5f66 3136 280a 2020  ash_attn_f16(.  
+0003a110: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0003a120: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0003a130: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0003a140: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0003a150: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0003a160: 7220 2a20 712c 0a20 2020 2020 2020 2063  r * q,.        c
+0003a170: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0003a180: 5f74 656e 736f 7220 2a20 6b2c 0a20 2020  _tensor * k,.   
+0003a190: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0003a1a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0003a1b0: 762c 0a20 2020 2020 2020 2063 6f6e 7374  v,.        const
+0003a1c0: 2062 6f6f 6c20 6d61 736b 6564 2c0a 2020   bool masked,.  
+0003a1d0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+0003a1e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0003a1f0: 6473 7429 207b 0a20 2020 2069 6e74 3634  dst) {.    int64
+0003a200: 5f74 2074 3020 3d20 6767 6d6c 5f70 6572  _t t0 = ggml_per
+0003a210: 665f 7469 6d65 5f75 7328 293b 0a20 2020  f_time_us();.   
+0003a220: 2055 4e55 5345 4428 7430 293b 0a0a 2020   UNUSED(t0);..  
+0003a230: 2020 636f 6e73 7420 696e 7420 6e65 7130    const int neq0
+0003a240: 203d 2071 2d3e 6e65 5b30 5d3b 0a20 2020   = q->ne[0];.   
+0003a250: 2063 6f6e 7374 2069 6e74 206e 6571 3120   const int neq1 
+0003a260: 3d20 712d 3e6e 655b 315d 3b0a 2020 2020  = q->ne[1];.    
+0003a270: 636f 6e73 7420 696e 7420 6e65 7132 203d  const int neq2 =
+0003a280: 2071 2d3e 6e65 5b32 5d3b 0a20 2020 2063   q->ne[2];.    c
+0003a290: 6f6e 7374 2069 6e74 206e 6571 3320 3d20  onst int neq3 = 
+0003a2a0: 712d 3e6e 655b 335d 3b0a 0a20 2020 2063  q->ne[3];..    c
+0003a2b0: 6f6e 7374 2069 6e74 206e 656b 3020 3d20  onst int nek0 = 
+0003a2c0: 6b2d 3e6e 655b 305d 3b0a 2020 2020 636f  k->ne[0];.    co
+0003a2d0: 6e73 7420 696e 7420 6e65 6b31 203d 206b  nst int nek1 = k
+0003a2e0: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+0003a2f0: 6f6e 7374 2069 6e74 206e 656b 3220 3d20  onst int nek2 = 
+0003a300: 6b2d 3e6e 655b 325d 3b0a 2020 2020 2f2f  k->ne[2];.    //
+0003a310: 636f 6e73 7420 696e 7420 6e65 6b33 203d  const int nek3 =
+0003a320: 206b 2d3e 6e65 5b33 5d3b 0a0a 2020 2020   k->ne[3];..    
+0003a330: 2f2f 636f 6e73 7420 696e 7420 6e65 7630  //const int nev0
+0003a340: 203d 2076 2d3e 6e65 5b30 5d3b 0a20 2020   = v->ne[0];.   
+0003a350: 2063 6f6e 7374 2069 6e74 206e 6576 3120   const int nev1 
+0003a360: 3d20 762d 3e6e 655b 315d 3b0a 2020 2020  = v->ne[1];.    
+0003a370: 2f2f 636f 6e73 7420 696e 7420 6e65 7632  //const int nev2
+0003a380: 203d 2076 2d3e 6e65 5b32 5d3b 0a20 2020   = v->ne[2];.   
+0003a390: 202f 2f63 6f6e 7374 2069 6e74 206e 6576   //const int nev
+0003a3a0: 3320 3d20 762d 3e6e 655b 335d 3b0a 0a20  3 = v->ne[3];.. 
+0003a3b0: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+0003a3c0: 2020 3d20 6473 742d 3e6e 655b 305d 3b0a    = dst->ne[0];.
+0003a3d0: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0003a3e0: 3120 203d 2064 7374 2d3e 6e65 5b31 5d3b  1  = dst->ne[1];
+0003a3f0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0003a400: 206e 6532 2020 3d20 6473 742d 3e6e 655b   ne2  = dst->ne[
+0003a410: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+0003a420: 696e 7420 6e65 3320 203d 2064 7374 2d3e  int ne3  = dst->
+0003a430: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+0003a440: 7420 696e 7420 6e62 6b30 203d 206b 2d3e  t int nbk0 = k->
+0003a450: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+0003a460: 2069 6e74 206e 626b 3120 3d20 6b2d 3e6e   int nbk1 = k->n
+0003a470: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+0003a480: 696e 7420 6e62 6b32 203d 206b 2d3e 6e62  int nbk2 = k->nb
+0003a490: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
+0003a4a0: 6e74 206e 626b 3320 3d20 6b2d 3e6e 625b  nt nbk3 = k->nb[
+0003a4b0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
+0003a4c0: 6e74 206e 6271 3020 3d20 712d 3e6e 625b  nt nbq0 = q->nb[
+0003a4d0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0003a4e0: 7420 6e62 7131 203d 2071 2d3e 6e62 5b31  t nbq1 = q->nb[1
+0003a4f0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003a500: 206e 6271 3220 3d20 712d 3e6e 625b 325d   nbq2 = q->nb[2]
+0003a510: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0003a520: 6e62 7133 203d 2071 2d3e 6e62 5b33 5d3b  nbq3 = q->nb[3];
+0003a530: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0003a540: 6e62 7630 203d 2076 2d3e 6e62 5b30 5d3b  nbv0 = v->nb[0];
+0003a550: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003a560: 6276 3120 3d20 762d 3e6e 625b 315d 3b0a  bv1 = v->nb[1];.
+0003a570: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0003a580: 7632 203d 2076 2d3e 6e62 5b32 5d3b 0a20  v2 = v->nb[2];. 
+0003a590: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
+0003a5a0: 3320 3d20 762d 3e6e 625b 335d 3b0a 0a20  3 = v->nb[3];.. 
+0003a5b0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
+0003a5c0: 2020 3d20 6473 742d 3e6e 625b 305d 3b0a    = dst->nb[0];.
+0003a5d0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0003a5e0: 3120 203d 2064 7374 2d3e 6e62 5b31 5d3b  1  = dst->nb[1];
+0003a5f0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003a600: 6232 2020 3d20 6473 742d 3e6e 625b 325d  b2  = dst->nb[2]
+0003a610: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0003a620: 6e62 3320 203d 2064 7374 2d3e 6e62 5b33  nb3  = dst->nb[3
+0003a630: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0003a640: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+0003a650: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0003a660: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+0003a670: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
+0003a680: 2069 6e74 2044 203d 206e 6571 303b 0a20   int D = neq0;. 
+0003a690: 2020 2063 6f6e 7374 2069 6e74 204e 203d     const int N =
+0003a6a0: 206e 6571 313b 0a20 2020 2063 6f6e 7374   neq1;.    const
+0003a6b0: 2069 6e74 2050 203d 206e 656b 3120 2d20   int P = nek1 - 
+0003a6c0: 4e3b 0a20 2020 2063 6f6e 7374 2069 6e74  N;.    const int
+0003a6d0: 204d 203d 2050 202b 204e 3b0a 0a20 2020   M = P + N;..   
+0003a6e0: 2063 6f6e 7374 2069 6e74 204d 7570 203d   const int Mup =
+0003a6f0: 2067 676d 6c5f 7570 284d 2c20 4747 4d4c   ggml_up(M, GGML
+0003a700: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
+0003a710: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+0003a720: 4552 5428 6e65 3020 3d3d 2044 293b 0a20  ERT(ne0 == D);. 
+0003a730: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0003a740: 6531 203d 3d20 4e29 3b0a 2020 2020 4747  e1 == N);.    GG
+0003a750: 4d4c 5f41 5353 4552 5428 5020 3e3d 2030  ML_ASSERT(P >= 0
+0003a760: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+0003a770: 4552 5428 6e62 7130 203d 3d20 7369 7a65  ERT(nbq0 == size
+0003a780: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+0003a790: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0003a7a0: 5428 6e62 6b30 203d 3d20 7369 7a65 6f66  T(nbk0 == sizeof
+0003a7b0: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
+0003a7c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003a7d0: 6e62 7630 203d 3d20 7369 7a65 6f66 2867  nbv0 == sizeof(g
+0003a7e0: 676d 6c5f 6670 3136 5f74 2929 3b0a 0a20  gml_fp16_t));.. 
+0003a7f0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0003a800: 6571 3020 3d3d 2044 293b 0a20 2020 2047  eq0 == D);.    G
+0003a810: 474d 4c5f 4153 5345 5254 286e 656b 3020  GML_ASSERT(nek0 
+0003a820: 3d3d 2044 293b 0a20 2020 2047 474d 4c5f  == D);.    GGML_
+0003a830: 4153 5345 5254 286e 6576 3120 3d3d 2044  ASSERT(nev1 == D
+0003a840: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+0003a850: 4552 5428 6e65 7131 203d 3d20 4e29 3b0a  ERT(neq1 == N);.
+0003a860: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003a870: 6e65 6b31 203d 3d20 4e20 2b20 5029 3b0a  nek1 == N + P);.
+0003a880: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003a890: 6e65 7631 203d 3d20 4429 3b0a 0a20 2020  nev1 == D);..   
+0003a8a0: 202f 2f20 6473 7420 6361 6e6e 6f74 2062   // dst cannot b
+0003a8b0: 6520 7472 616e 7370 6f73 6564 206f 7220  e transposed or 
+0003a8c0: 7065 726d 7574 6564 0a20 2020 2047 474d  permuted.    GGM
+0003a8d0: 4c5f 4153 5345 5254 286e 6230 203d 3d20  L_ASSERT(nb0 == 
+0003a8e0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+0003a8f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003a900: 6e62 3020 3c3d 206e 6231 293b 0a20 2020  nb0 <= nb1);.   
+0003a910: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
+0003a920: 203c 3d20 6e62 3229 3b0a 2020 2020 4747   <= nb2);.    GG
+0003a930: 4d4c 5f41 5353 4552 5428 6e62 3220 3c3d  ML_ASSERT(nb2 <=
+0003a940: 206e 6233 293b 0a0a 2020 2020 6966 2028   nb3);..    if (
+0003a950: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+0003a960: 4747 4d4c 5f54 4153 4b5f 494e 4954 2920  GGML_TASK_INIT) 
+0003a970: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+0003a980: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
+0003a990: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+0003a9a0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0003a9b0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0003a9c0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0003a9d0: 2020 2f2f 2070 6172 616c 6c65 6c69 7a65    // parallelize
+0003a9e0: 2062 7920 7120 726f 7773 2075 7369 6e67   by q rows using
+0003a9f0: 2067 676d 6c5f 7665 635f 646f 745f 6633   ggml_vec_dot_f3
+0003aa00: 320a 0a20 2020 202f 2f20 746f 7461 6c20  2..    // total 
+0003aa10: 726f 7773 2069 6e20 710a 2020 2020 636f  rows in q.    co
+0003aa20: 6e73 7420 696e 7420 6e72 203d 206e 6571  nst int nr = neq
+0003aa30: 312a 6e65 7132 2a6e 6571 333b 0a0a 2020  1*neq2*neq3;..  
+0003aa40: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
+0003aa50: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+0003aa60: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
+0003aa70: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
+0003aa80: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
+0003aa90: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
+0003aaa0: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
+0003aab0: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
+0003aac0: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
+0003aad0: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
+0003aae0: 0a0a 2020 2020 636f 6e73 7420 666c 6f61  ..    const floa
+0003aaf0: 7420 7363 616c 6520 3d20 312e 3066 2f73  t scale = 1.0f/s
+0003ab00: 7172 7466 2844 293b 0a0a 2020 2020 2f2f  qrtf(D);..    //
+0003ab10: 7072 696e 7466 2822 503d 2564 204e 3d25  printf("P=%d N=%
+0003ab20: 6420 443d 2564 2069 7230 3d25 6420 6972  d D=%d ir0=%d ir
+0003ab30: 313d 2564 2073 6361 6c65 203d 2025 665c  1=%d scale = %f\
+0003ab40: 6e22 2c20 502c 204e 2c20 442c 2069 7230  n", P, N, D, ir0
+0003ab50: 2c20 6972 312c 2073 6361 6c65 293b 0a0a  , ir1, scale);..
+0003ab60: 2020 2020 666f 7220 2869 6e74 2069 7220      for (int ir 
+0003ab70: 3d20 6972 303b 2069 7220 3c20 6972 313b  = ir0; ir < ir1;
+0003ab80: 202b 2b69 7229 207b 0a20 2020 2020 2020   ++ir) {.       
+0003ab90: 202f 2f20 7120 696e 6469 6365 730a 2020   // q indices.  
+0003aba0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0003abb0: 6971 3320 3d20 6972 2f28 6e65 7132 2a6e  iq3 = ir/(neq2*n
+0003abc0: 6571 3129 3b0a 2020 2020 2020 2020 636f  eq1);.        co
+0003abd0: 6e73 7420 696e 7420 6971 3220 3d20 2869  nst int iq2 = (i
+0003abe0: 7220 2d20 6971 332a 6e65 7132 2a6e 6571  r - iq3*neq2*neq
+0003abf0: 3129 2f6e 6571 313b 0a20 2020 2020 2020  1)/neq1;.       
+0003ac00: 2063 6f6e 7374 2069 6e74 2069 7131 203d   const int iq1 =
+0003ac10: 2028 6972 202d 2069 7133 2a6e 6571 322a   (ir - iq3*neq2*
+0003ac20: 6e65 7131 202d 2069 7132 2a6e 6571 3129  neq1 - iq2*neq1)
+0003ac30: 3b0a 0a20 2020 2020 2020 2066 6c6f 6174  ;..        float
+0003ac40: 202a 2053 203d 2028 666c 6f61 7420 2a29   * S = (float *)
+0003ac50: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+0003ac60: 2069 7468 2a28 322a 4d75 7020 2b20 4341   ith*(2*Mup + CA
+0003ac70: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
+0003ac80: 3229 3b0a 0a20 2020 2020 2020 2066 6f72  2);..        for
+0003ac90: 2028 696e 7420 6920 3d20 4d3b 2069 203c   (int i = M; i <
+0003aca0: 204d 7570 3b20 2b2b 6929 207b 0a20 2020   Mup; ++i) {.   
+0003acb0: 2020 2020 2020 2020 2053 5b69 5d20 3d20           S[i] = 
+0003acc0: 2d49 4e46 494e 4954 593b 0a20 2020 2020  -INFINITY;.     
+0003acd0: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
+0003ace0: 2028 4747 4d4c 5f56 4543 5f44 4f54 5f55   (GGML_VEC_DOT_U
+0003acf0: 4e52 4f4c 4c20 3e20 3220 7c7c 206e 656b  NROLL > 2 || nek
+0003ad00: 3120 2520 4747 4d4c 5f56 4543 5f44 4f54  1 % GGML_VEC_DOT
+0003ad10: 5f55 4e52 4f4c 4c20 213d 2030 2920 7b0a  _UNROLL != 0) {.
+0003ad20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003ad30: 2869 6e74 2069 6320 3d20 303b 2069 6320  (int ic = 0; ic 
+0003ad40: 3c20 6e65 6b31 3b20 2b2b 6963 2920 7b0a  < nek1; ++ic) {.
+0003ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ad60: 2f2f 206b 2069 6e64 6963 6573 0a20 2020  // k indices.   
+0003ad70: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0003ad80: 7374 2069 6e74 2069 6b33 203d 2069 7133  st int ik3 = iq3
+0003ad90: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003ada0: 2020 636f 6e73 7420 696e 7420 696b 3220    const int ik2 
+0003adb0: 3d20 6971 323b 0a20 2020 2020 2020 2020  = iq2;.         
+0003adc0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0003add0: 2069 6b31 203d 2069 633b 0a0a 2020 2020   ik1 = ic;..    
+0003ade0: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
+0003adf0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+0003ae00: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0003ae10: 6e74 2069 3120 3d20 696b 313b 0a0a 2020  nt i1 = ik1;..  
+0003ae20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0003ae30: 6d6c 5f76 6563 5f64 6f74 5f66 3136 286e  ml_vec_dot_f16(n
+0003ae40: 6571 302c 0a20 2020 2020 2020 2020 2020  eq0,.           
+0003ae50: 2020 2020 2020 2020 2020 2020 2053 202b               S +
+0003ae60: 2069 312c 0a20 2020 2020 2020 2020 2020   i1,.           
+0003ae70: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
+0003ae80: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
+0003ae90: 6861 7220 2a29 206b 2d3e 6461 7461 202b  har *) k->data +
+0003aea0: 2028 696b 312a 6e62 6b31 202b 2069 6b32   (ik1*nbk1 + ik2
+0003aeb0: 2a6e 626b 3220 2b20 696b 332a 6e62 6b33  *nbk2 + ik3*nbk3
+0003aec0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0003aed0: 2020 2020 2020 2020 2020 2020 2867 676d              (ggm
+0003aee0: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
+0003aef0: 6172 202a 2920 712d 3e64 6174 6120 2b20  ar *) q->data + 
+0003af00: 2869 7131 2a6e 6271 3120 2b20 6971 322a  (iq1*nbq1 + iq2*
+0003af10: 6e62 7132 202b 2069 7133 2a6e 6271 3329  nbq2 + iq3*nbq3)
+0003af20: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+0003af30: 7d0a 2020 2020 2020 2020 7d20 656c 7365  }.        } else
+0003af40: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0003af50: 6f72 2028 696e 7420 6963 203d 2030 3b20  or (int ic = 0; 
+0003af60: 6963 203c 206e 656b 313b 2069 6320 2b3d  ic < nek1; ic +=
+0003af70: 2047 474d 4c5f 5645 435f 444f 545f 554e   GGML_VEC_DOT_UN
+0003af80: 524f 4c4c 2920 7b0a 2020 2020 2020 2020  ROLL) {.        
+0003af90: 2020 2020 2020 2020 2f2f 206b 2069 6e64          // k ind
+0003afa0: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
+0003afb0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0003afc0: 6b33 203d 2069 7133 3b0a 2020 2020 2020  k3 = iq3;.      
+0003afd0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0003afe0: 696e 7420 696b 3220 3d20 6971 323b 0a20  int ik2 = iq2;. 
+0003aff0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003b000: 6f6e 7374 2069 6e74 2069 6b31 203d 2069  onst int ik1 = i
+0003b010: 633b 0a0a 2020 2020 2020 2020 2020 2020  c;..            
+0003b020: 2020 2020 2f2f 2053 2069 6e64 6963 6573      // S indices
+0003b030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b040: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
+0003b050: 696b 313b 0a0a 2020 2020 2020 2020 2020  ik1;..          
+0003b060: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+0003b070: 6f74 5f66 3136 5f75 6e72 6f6c 6c28 6e65  ot_f16_unroll(ne
+0003b080: 7130 2c20 6e62 6b31 2c0a 2020 2020 2020  q0, nbk1,.      
+0003b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b0a0: 2020 5320 2b20 6931 2c0a 2020 2020 2020    S + i1,.      
+0003b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b0c0: 2020 2828 6368 6172 202a 2920 6b2d 3e64    ((char *) k->d
+0003b0d0: 6174 6120 2b20 2869 6b31 2a6e 626b 3120  ata + (ik1*nbk1 
+0003b0e0: 2b20 696b 322a 6e62 6b32 202b 2069 6b33  + ik2*nbk2 + ik3
+0003b0f0: 2a6e 626b 3329 292c 0a20 2020 2020 2020  *nbk3)),.       
+0003b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b110: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+0003b120: 2028 2863 6861 7220 2a29 2071 2d3e 6461   ((char *) q->da
+0003b130: 7461 202b 2028 6971 312a 6e62 7131 202b  ta + (iq1*nbq1 +
+0003b140: 2069 7132 2a6e 6271 3220 2b20 6971 332a   iq2*nbq2 + iq3*
+0003b150: 6e62 7133 2929 293b 0a20 2020 2020 2020  nbq3)));.       
+0003b160: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+0003b170: 0a0a 2020 2020 2020 2020 2f2f 2073 6361  ..        // sca
+0003b180: 6c65 0a20 2020 2020 2020 2067 676d 6c5f  le.        ggml_
+0003b190: 7665 635f 7363 616c 655f 6633 3228 6e65  vec_scale_f32(ne
+0003b1a0: 6b31 2c20 532c 2073 6361 6c65 293b 0a0a  k1, S, scale);..
+0003b1b0: 2020 2020 2020 2020 6966 2028 6d61 736b          if (mask
+0003b1c0: 6564 2920 7b0a 2020 2020 2020 2020 2020  ed) {.          
+0003b1d0: 2020 666f 7220 2869 6e74 2069 203d 2050    for (int i = P
+0003b1e0: 3b20 6920 3c20 4d3b 2069 2b2b 2920 7b0a  ; i < M; i++) {.
+0003b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b200: 6966 2028 6920 3e20 5020 2b20 6971 3129  if (i > P + iq1)
+0003b210: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003b220: 2020 2020 2020 2053 5b69 5d20 3d20 2d49         S[i] = -I
+0003b230: 4e46 494e 4954 593b 0a20 2020 2020 2020  NFINITY;.       
+0003b240: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0003b250: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0003b260: 207d 0a0a 2020 2020 2020 2020 2f2f 2073   }..        // s
+0003b270: 6f66 746d 6178 0a20 2020 2020 2020 207b  oftmax.        {
+0003b280: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
+0003b290: 6174 206d 6178 203d 202d 494e 4649 4e49  at max = -INFINI
+0003b2a0: 5459 3b0a 2020 2020 2020 2020 2020 2020  TY;.            
+0003b2b0: 6767 6d6c 5f76 6563 5f6d 6178 5f66 3332  ggml_vec_max_f32
+0003b2c0: 284d 2c20 266d 6178 2c20 5329 3b0a 0a20  (M, &max, S);.. 
+0003b2d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003b2e0: 666c 6f61 7420 7375 6d20 3d20 302e 303b  float sum = 0.0;
+0003b2f0: 0a20 2020 2020 2020 2020 2020 207b 0a23  .            {.#
+0003b300: 6966 6465 6620 4747 4d4c 5f53 4f46 545f  ifdef GGML_SOFT_
+0003b310: 4d41 585f 4143 4345 4c45 5241 5445 0a20  MAX_ACCELERATE. 
+0003b320: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0003b330: 6178 203d 202d 6d61 783b 0a20 2020 2020  ax = -max;.     
+0003b340: 2020 2020 2020 2020 2020 2076 4453 505f             vDSP_
+0003b350: 7673 6164 6428 532c 2031 2c20 266d 6178  vsadd(S, 1, &max
+0003b360: 2c20 532c 2031 2c20 4d75 7029 3b0a 2020  , S, 1, Mup);.  
+0003b370: 2020 2020 2020 2020 2020 2020 2020 7676                vv
+0003b380: 6578 7066 2853 2c20 532c 2026 4d75 7029  expf(S, S, &Mup)
+0003b390: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003b3a0: 2020 6767 6d6c 5f76 6563 5f73 756d 5f66    ggml_vec_sum_f
+0003b3b0: 3332 284d 7570 2c20 2673 756d 2c20 5329  32(Mup, &sum, S)
+0003b3c0: 3b0a 2365 6c73 650a 2020 2020 2020 2020  ;.#else.        
+0003b3d0: 2020 2020 2020 2020 7569 6e74 3136 5f74          uint16_t
+0003b3e0: 2020 2073 6376 745b 4747 4d4c 5f53 4f46     scvt[GGML_SOF
+0003b3f0: 545f 4d41 585f 554e 524f 4c4c 5d3b 0a20  T_MAX_UNROLL];. 
+0003b400: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0003b410: 676d 6c5f 666c 6f61 7420 7375 6d70 5b47  gml_float sump[G
+0003b420: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
+0003b430: 4f4c 4c5d 203d 207b 2030 2e30 207d 3b0a  OLL] = { 0.0 };.
+0003b440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b450: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0003b460: 2069 203c 204d 7570 3b20 6920 2b3d 2047   i < Mup; i += G
+0003b470: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
+0003b480: 4f4c 4c29 207b 0a20 2020 2020 2020 2020  OLL) {.         
+0003b490: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0003b4a0: 202a 2053 5320 3d20 5320 2b20 693b 0a0a   * SS = S + i;..
+0003b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b4c0: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+0003b4d0: 2030 3b20 6a20 3c20 4747 4d4c 5f53 4f46   0; j < GGML_SOF
+0003b4e0: 545f 4d41 585f 554e 524f 4c4c 3b20 2b2b  T_MAX_UNROLL; ++
+0003b4f0: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+0003b500: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003b510: 2853 535b 6a5d 203d 3d20 2d49 4e46 494e  (SS[j] == -INFIN
+0003b520: 4954 5929 207b 0a20 2020 2020 2020 2020  ITY) {.         
+0003b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b540: 2020 2053 535b 6a5d 203d 2030 2e30 663b     SS[j] = 0.0f;
+0003b550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b560: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+0003b570: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003b580: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0003b590: 6d6c 5f66 7031 365f 7420 7320 3d20 4747  ml_fp16_t s = GG
+0003b5a0: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+0003b5b0: 5353 5b6a 5d20 2d20 6d61 7829 3b0a 2020  SS[j] - max);.  
+0003b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b5d0: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
+0003b5e0: 2826 7363 7674 5b6a 5d2c 2026 732c 2073  (&scvt[j], &s, s
+0003b5f0: 697a 656f 6628 7569 6e74 3136 5f74 2929  izeof(uint16_t))
+0003b600: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003b610: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0003b620: 6e73 7420 666c 6f61 7420 7661 6c20 3d20  nst float val = 
+0003b630: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+0003b640: 3228 7461 626c 655f 6578 705f 6631 365b  2(table_exp_f16[
+0003b650: 7363 7674 5b6a 5d5d 293b 0a20 2020 2020  scvt[j]]);.     
+0003b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b670: 2020 2020 2020 2073 756d 705b 6a5d 202b         sump[j] +
+0003b680: 3d20 2867 676d 6c5f 666c 6f61 7429 7661  = (ggml_float)va
+0003b690: 6c3b 0a20 2020 2020 2020 2020 2020 2020  l;.             
+0003b6a0: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+0003b6b0: 535b 6a5d 203d 2076 616c 3b0a 2020 2020  S[j] = val;.    
+0003b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b6d0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0003b6e0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0003b6f0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0003b700: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003b710: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0003b720: 203c 2047 474d 4c5f 534f 4654 5f4d 4158   < GGML_SOFT_MAX
+0003b730: 5f55 4e52 4f4c 4c3b 2069 2b2b 2920 7b0a  _UNROLL; i++) {.
+0003b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b750: 2020 2020 7375 6d20 2b3d 2073 756d 705b      sum += sump[
+0003b760: 695d 3b0a 2020 2020 2020 2020 2020 2020  i];.            
+0003b770: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
+0003b780: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0003b790: 2020 2020 2020 2020 6173 7365 7274 2873          assert(s
+0003b7a0: 756d 203e 2030 2e30 293b 0a0a 2020 2020  um > 0.0);..    
+0003b7b0: 2020 2020 2020 2020 7375 6d20 3d20 312e          sum = 1.
+0003b7c0: 302f 7375 6d3b 0a20 2020 2020 2020 2020  0/sum;.         
+0003b7d0: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
+0003b7e0: 655f 6633 3228 4d2c 2053 2c20 7375 6d29  e_f32(M, S, sum)
+0003b7f0: 3b0a 0a23 6966 6e64 6566 204e 4445 4255  ;..#ifndef NDEBU
+0003b800: 470a 2020 2020 2020 2020 2020 2020 666f  G.            fo
+0003b810: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0003b820: 3c20 4d3b 202b 2b69 2920 7b0a 2020 2020  < M; ++i) {.    
+0003b830: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0003b840: 7274 2821 6973 6e61 6e28 535b 695d 2929  rt(!isnan(S[i]))
+0003b850: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003b860: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
+0003b870: 535b 695d 2929 3b0a 2020 2020 2020 2020  S[i]));.        
+0003b880: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
+0003b890: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0003b8a0: 6767 6d6c 5f66 7031 365f 7420 2a20 5331  ggml_fp16_t * S1
+0003b8b0: 3620 3d20 2867 676d 6c5f 6670 3136 5f74  6 = (ggml_fp16_t
+0003b8c0: 202a 2920 2828 666c 6f61 7420 2a29 2070   *) ((float *) p
+0003b8d0: 6172 616d 732d 3e77 6461 7461 202b 2069  arams->wdata + i
+0003b8e0: 7468 2a28 322a 4d75 7020 2b20 4341 4348  th*(2*Mup + CACH
+0003b8f0: 455f 4c49 4e45 5f53 495a 455f 4633 3229  E_LINE_SIZE_F32)
+0003b900: 202b 204d 7570 293b 0a0a 2020 2020 2020   + Mup);..      
+0003b910: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0003b920: 3b20 6920 3c20 4d3b 2069 2b2b 2920 7b0a  ; i < M; i++) {.
+0003b930: 2020 2020 2020 2020 2020 2020 5331 365b              S16[
+0003b940: 695d 203d 2047 474d 4c5f 4650 3332 5f54  i] = GGML_FP32_T
+0003b950: 4f5f 4650 3136 2853 5b69 5d29 3b0a 2020  O_FP16(S[i]);.  
+0003b960: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0003b970: 2069 6620 2847 474d 4c5f 5645 435f 444f   if (GGML_VEC_DO
+0003b980: 545f 554e 524f 4c4c 203d 3d20 3120 7c7c  T_UNROLL == 1 ||
+0003b990: 2028 6e65 7631 2025 2047 474d 4c5f 5645   (nev1 % GGML_VE
+0003b9a0: 435f 444f 545f 554e 524f 4c4c 2021 3d20  C_DOT_UNROLL != 
+0003b9b0: 3029 2920 7b0a 2020 2020 2020 2020 2020  0)) {.          
+0003b9c0: 2020 666f 7220 2869 6e74 2069 6320 3d20    for (int ic = 
+0003b9d0: 303b 2069 6320 3c20 6e65 7631 3b20 2b2b  0; ic < nev1; ++
+0003b9e0: 6963 2920 7b0a 2020 2020 2020 2020 2020  ic) {.          
+0003b9f0: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
+0003ba00: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
+0003ba10: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0003ba20: 3120 3d20 6971 313b 0a20 2020 2020 2020  1 = iq1;.       
+0003ba30: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0003ba40: 6e74 2069 3220 3d20 6971 323b 0a20 2020  nt i2 = iq2;.   
+0003ba50: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0003ba60: 7374 2069 6e74 2069 3320 3d20 6971 333b  st int i3 = iq3;
+0003ba70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003ba80: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+0003ba90: 3136 286e 656b 312c 0a20 2020 2020 2020  16(nek1,.       
+0003baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bab0: 2028 666c 6f61 7420 2a29 2020 2020 2020   (float *)      
+0003bac0: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+0003bad0: 6461 7461 202b 2028 6963 2a6e 6230 202b  data + (ic*nb0 +
+0003bae0: 2069 312a 6e62 3120 202b 2069 322a 6e62   i1*nb1  + i2*nb
+0003baf0: 3220 202b 2069 332a 6e62 3329 292c 0a20  2  + i3*nb3)),. 
+0003bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bb10: 2020 2020 2020 2028 6767 6d6c 5f66 7031         (ggml_fp1
+0003bb20: 365f 7420 2a29 2028 2863 6861 7220 2a29  6_t *) ((char *)
+0003bb30: 2076 2d3e 6461 7461 2020 202b 2028 2020   v->data   + (  
+0003bb40: 2020 2020 2020 2069 632a 6e62 7631 202b         ic*nbv1 +
+0003bb50: 2069 322a 6e62 7632 202b 2069 332a 6e62   i2*nbv2 + i3*nb
+0003bb60: 7633 2929 2c0a 2020 2020 2020 2020 2020  v3)),.          
+0003bb70: 2020 2020 2020 2020 2020 2020 2020 5331                S1
+0003bb80: 3629 3b0a 2020 2020 2020 2020 2020 2020  6);.            
+0003bb90: 7d0a 2020 2020 2020 2020 7d20 656c 7365  }.        } else
+0003bba0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0003bbb0: 6f72 2028 696e 7420 6963 203d 2030 3b20  or (int ic = 0; 
+0003bbc0: 6963 203c 206e 6576 313b 2069 6320 2b3d  ic < nev1; ic +=
+0003bbd0: 2047 474d 4c5f 5645 435f 444f 545f 554e   GGML_VEC_DOT_UN
+0003bbe0: 524f 4c4c 2920 7b0a 2020 2020 2020 2020  ROLL) {.        
+0003bbf0: 2020 2020 2020 2020 2f2f 2064 7374 2069          // dst i
+0003bc00: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+0003bc10: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0003bc20: 2069 3120 3d20 6971 313b 0a20 2020 2020   i1 = iq1;.     
+0003bc30: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0003bc40: 2069 6e74 2069 3220 3d20 6971 323b 0a20   int i2 = iq2;. 
+0003bc50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003bc60: 6f6e 7374 2069 6e74 2069 3320 3d20 6971  onst int i3 = iq
+0003bc70: 333b 0a0a 2020 2020 2020 2020 2020 2020  3;..            
+0003bc80: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+0003bc90: 5f66 3136 5f75 6e72 6f6c 6c28 6e65 6b31  _f16_unroll(nek1
+0003bca0: 2c20 6e62 7631 2c0a 2020 2020 2020 2020  , nbv1,.        
+0003bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bcc0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0003bcd0: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0003bce0: 2869 632a 6e62 3020 2b20 6931 2a6e 6231  (ic*nb0 + i1*nb1
+0003bcf0: 2020 2b20 6932 2a6e 6232 2020 2b20 6933    + i2*nb2  + i3
+0003bd00: 2a6e 6233 2929 2c0a 2020 2020 2020 2020  *nb3)),.        
+0003bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bd20: 2828 6368 6172 202a 2920 762d 3e64 6174  ((char *) v->dat
+0003bd30: 6120 2020 2b20 2820 2020 2020 2020 2020  a   + (         
+0003bd40: 6963 2a6e 6276 3120 2b20 6932 2a6e 6276  ic*nbv1 + i2*nbv
+0003bd50: 3220 2b20 6933 2a6e 6276 3329 292c 0a20  2 + i3*nbv3)),. 
+0003bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bd70: 2020 2020 2020 2053 3136 293b 0a20 2020         S16);.   
+0003bd80: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0003bd90: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+0003bda0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0003bdb0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f66  ompute_forward_f
+0003bdc0: 6c61 7368 5f61 7474 6e28 0a20 2020 2020  lash_attn(.     
+0003bdd0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0003bde0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0003bdf0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0003be00: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0003be10: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0003be20: 2071 2c0a 2020 2020 2020 2020 636f 6e73   q,.        cons
+0003be30: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0003be40: 6e73 6f72 202a 206b 2c0a 2020 2020 2020  nsor * k,.      
+0003be50: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0003be60: 676d 6c5f 7465 6e73 6f72 202a 2076 2c0a  gml_tensor * v,.
+0003be70: 2020 2020 2020 2020 636f 6e73 7420 626f          const bo
+0003be80: 6f6c 206d 6173 6b65 642c 0a20 2020 2020  ol masked,.     
+0003be90: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0003bea0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+0003beb0: 2020 2073 7769 7463 6820 2871 2d3e 7479     switch (q->ty
+0003bec0: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
+0003bed0: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
+0003bee0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0003bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf00: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0003bf10: 7761 7264 5f66 6c61 7368 5f61 7474 6e5f  ward_flash_attn_
+0003bf20: 6631 3628 7061 7261 6d73 2c20 712c 206b  f16(params, q, k
+0003bf30: 2c20 762c 206d 6173 6b65 642c 2064 7374  , v, masked, dst
+0003bf40: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0003bf50: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0003bf60: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+0003bf70: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+0003bf80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003bf90: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0003bfa0: 6f72 7761 7264 5f66 6c61 7368 5f61 7474  orward_flash_att
+0003bfb0: 6e5f 6633 3228 7061 7261 6d73 2c20 712c  n_f32(params, q,
+0003bfc0: 206b 2c20 762c 206d 6173 6b65 642c 2064   k, v, masked, d
+0003bfd0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+0003bfe0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0003bff0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0003c000: 5f51 345f 303a 0a20 2020 2020 2020 2063  _Q4_0:.        c
+0003c010: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+0003c020: 5f31 3a0a 2020 2020 2020 2020 6361 7365  _1:.        case
+0003c030: 2047 474d 4c5f 5459 5045 5f49 383a 0a20   GGML_TYPE_I8:. 
+0003c040: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0003c050: 5f54 5950 455f 4931 363a 0a20 2020 2020  _TYPE_I16:.     
+0003c060: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0003c070: 455f 4933 323a 0a20 2020 2020 2020 2063  E_I32:.        c
+0003c080: 6173 6520 4747 4d4c 5f54 5950 455f 434f  ase GGML_TYPE_CO
+0003c090: 554e 543a 0a20 2020 2020 2020 2020 2020  UNT:.           
+0003c0a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003c0b0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+0003c0c0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+0003c0d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0003c0e0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+0003c0f0: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
+0003c100: 7368 5f66 660a 0a73 7461 7469 6320 766f  sh_ff..static vo
+0003c110: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+0003c120: 666f 7277 6172 645f 666c 6173 685f 6666  forward_flash_ff
+0003c130: 5f66 3136 280a 2020 2020 2020 2020 636f  _f16(.        co
+0003c140: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0003c150: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0003c160: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0003c170: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0003c180: 6d6c 5f74 656e 736f 7220 2a20 612c 2020  ml_tensor * a,  
+0003c190: 2f2f 2046 3136 0a20 2020 2020 2020 2063  // F16.        c
+0003c1a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0003c1b0: 5f74 656e 736f 7220 2a20 6230 2c20 2f2f  _tensor * b0, //
+0003c1c0: 2046 3136 2066 635f 770a 2020 2020 2020   F16 fc_w.      
+0003c1d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0003c1e0: 676d 6c5f 7465 6e73 6f72 202a 2062 312c  gml_tensor * b1,
+0003c1f0: 202f 2f20 4633 3220 6663 5f62 0a20 2020   // F32 fc_b.   
+0003c200: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0003c210: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0003c220: 6330 2c20 2f2f 2046 3136 2070 726f 6a5f  c0, // F16 proj_
+0003c230: 770a 2020 2020 2020 2020 636f 6e73 7420  w.        const 
+0003c240: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0003c250: 6f72 202a 2063 312c 202f 2f20 4633 3220  or * c1, // F32 
+0003c260: 7072 6f6a 5f62 0a20 2020 2020 2020 2073  proj_b.        s
+0003c270: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0003c280: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
+0003c290: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
+0003c2a0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
+0003c2b0: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
+0003c2c0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0003c2d0: 6e65 6130 203d 2061 2d3e 6e65 5b30 5d3b  nea0 = a->ne[0];
+0003c2e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003c2f0: 6561 3120 3d20 612d 3e6e 655b 315d 3b0a  ea1 = a->ne[1];.
+0003c300: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0003c310: 6132 203d 2061 2d3e 6e65 5b32 5d3b 0a20  a2 = a->ne[2];. 
+0003c320: 2020 2063 6f6e 7374 2069 6e74 206e 6561     const int nea
+0003c330: 3320 3d20 612d 3e6e 655b 335d 3b0a 0a20  3 = a->ne[3];.. 
+0003c340: 2020 2063 6f6e 7374 2069 6e74 206e 6562     const int neb
+0003c350: 3030 203d 2062 302d 3e6e 655b 305d 3b0a  00 = b0->ne[0];.
+0003c360: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0003c370: 6230 3120 3d20 6230 2d3e 6e65 5b31 5d3b  b01 = b0->ne[1];
+0003c380: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0003c390: 206e 6562 3032 203d 2062 302d 3e6e 655b   neb02 = b0->ne[
+0003c3a0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+0003c3b0: 696e 7420 6e65 6230 3320 3d20 6230 2d3e  int neb03 = b0->
+0003c3c0: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+0003c3d0: 7420 696e 7420 6e65 6231 3020 3d20 6231  t int neb10 = b1
+0003c3e0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+0003c3f0: 7374 2069 6e74 206e 6562 3131 203d 2062  st int neb11 = b
+0003c400: 312d 3e6e 655b 315d 3b0a 2020 2020 2f2f  1->ne[1];.    //
+0003c410: 636f 6e73 7420 696e 7420 6e65 6231 3220  const int neb12 
+0003c420: 3d20 6231 2d3e 6e65 5b32 5d3b 0a20 2020  = b1->ne[2];.   
+0003c430: 202f 2f63 6f6e 7374 2069 6e74 206e 6562   //const int neb
+0003c440: 3133 203d 2062 312d 3e6e 655b 335d 3b0a  13 = b1->ne[3];.
+0003c450: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003c460: 6563 3030 203d 2063 302d 3e6e 655b 305d  ec00 = c0->ne[0]
+0003c470: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0003c480: 6e65 6330 3120 3d20 6330 2d3e 6e65 5b31  nec01 = c0->ne[1
+0003c490: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0003c4a0: 6e74 206e 6563 3032 203d 2063 302d 3e6e  nt nec02 = c0->n
+0003c4b0: 655b 325d 3b0a 2020 2020 2f2f 636f 6e73  e[2];.    //cons
+0003c4c0: 7420 696e 7420 6e65 6330 3320 3d20 6330  t int nec03 = c0
+0003c4d0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+0003c4e0: 6e73 7420 696e 7420 6e65 6331 3020 3d20  nst int nec10 = 
+0003c4f0: 6331 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c1->ne[0];.    c
+0003c500: 6f6e 7374 2069 6e74 206e 6563 3131 203d  onst int nec11 =
+0003c510: 2063 312d 3e6e 655b 315d 3b0a 2020 2020   c1->ne[1];.    
+0003c520: 2f2f 636f 6e73 7420 696e 7420 6e65 6331  //const int nec1
+0003c530: 3220 3d20 6331 2d3e 6e65 5b32 5d3b 0a20  2 = c1->ne[2];. 
+0003c540: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+0003c550: 6563 3133 203d 2063 312d 3e6e 655b 335d  ec13 = c1->ne[3]
+0003c560: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0003c570: 206e 6530 203d 2064 7374 2d3e 6e65 5b30   ne0 = dst->ne[0
+0003c580: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003c590: 206e 6531 203d 2064 7374 2d3e 6e65 5b31   ne1 = dst->ne[1
+0003c5a0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003c5b0: 206e 6532 203d 2064 7374 2d3e 6e65 5b32   ne2 = dst->ne[2
+0003c5c0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0003c5d0: 6e74 206e 6533 203d 2064 7374 2d3e 6e65  nt ne3 = dst->ne
+0003c5e0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0003c5f0: 696e 7420 6e62 6130 203d 2061 2d3e 6e62  int nba0 = a->nb
+0003c600: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+0003c610: 6e74 206e 6261 3120 3d20 612d 3e6e 625b  nt nba1 = a->nb[
+0003c620: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+0003c630: 7420 6e62 6132 203d 2061 2d3e 6e62 5b32  t nba2 = a->nb[2
+0003c640: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003c650: 206e 6261 3320 3d20 612d 3e6e 625b 335d   nba3 = a->nb[3]
+0003c660: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0003c670: 206e 6262 3030 203d 2062 302d 3e6e 625b   nbb00 = b0->nb[
+0003c680: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0003c690: 7420 6e62 6230 3120 3d20 6230 2d3e 6e62  t nbb01 = b0->nb
+0003c6a0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0003c6b0: 6e74 206e 6262 3032 203d 2062 302d 3e6e  nt nbb02 = b0->n
+0003c6c0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0003c6d0: 696e 7420 6e62 6230 3320 3d20 6230 2d3e  int nbb03 = b0->
+0003c6e0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+0003c6f0: 7420 696e 7420 6e62 6231 3020 3d20 6231  t int nbb10 = b1
+0003c700: 2d3e 6e62 5b30 5d3b 0a20 2020 202f 2f63  ->nb[0];.    //c
+0003c710: 6f6e 7374 2069 6e74 206e 6262 3131 203d  onst int nbb11 =
+0003c720: 2062 312d 3e6e 625b 315d 3b0a 2020 2020   b1->nb[1];.    
+0003c730: 2f2f 636f 6e73 7420 696e 7420 6e62 6231  //const int nbb1
+0003c740: 3220 3d20 6231 2d3e 6e62 5b32 5d3b 0a20  2 = b1->nb[2];. 
+0003c750: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+0003c760: 6262 3133 203d 2062 312d 3e6e 625b 335d  bb13 = b1->nb[3]
+0003c770: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0003c780: 206e 6263 3030 203d 2063 302d 3e6e 625b   nbc00 = c0->nb[
+0003c790: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0003c7a0: 7420 6e62 6330 3120 3d20 6330 2d3e 6e62  t nbc01 = c0->nb
+0003c7b0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0003c7c0: 6e74 206e 6263 3032 203d 2063 302d 3e6e  nt nbc02 = c0->n
+0003c7d0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0003c7e0: 696e 7420 6e62 6330 3320 3d20 6330 2d3e  int nbc03 = c0->
+0003c7f0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+0003c800: 7420 696e 7420 6e62 6331 3020 3d20 6331  t int nbc10 = c1
+0003c810: 2d3e 6e62 5b30 5d3b 0a20 2020 202f 2f63  ->nb[0];.    //c
+0003c820: 6f6e 7374 2069 6e74 206e 6263 3131 203d  onst int nbc11 =
+0003c830: 2063 312d 3e6e 625b 315d 3b0a 2020 2020   c1->nb[1];.    
+0003c840: 2f2f 636f 6e73 7420 696e 7420 6e62 6331  //const int nbc1
+0003c850: 3220 3d20 6331 2d3e 6e62 5b32 5d3b 0a20  2 = c1->nb[2];. 
+0003c860: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+0003c870: 6263 3133 203d 2063 312d 3e6e 625b 335d  bc13 = c1->nb[3]
+0003c880: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0003c890: 206e 6230 203d 2064 7374 2d3e 6e62 5b30   nb0 = dst->nb[0
+0003c8a0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003c8b0: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
+0003c8c0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003c8d0: 206e 6232 203d 2064 7374 2d3e 6e62 5b32   nb2 = dst->nb[2
+0003c8e0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003c8f0: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
+0003c900: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0003c910: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+0003c920: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0003c930: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+0003c940: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
+0003c950: 2069 6e74 2044 203d 206e 6561 303b 0a20   int D = nea0;. 
+0003c960: 2020 202f 2f63 6f6e 7374 2069 6e74 204e     //const int N
+0003c970: 203d 206e 6561 313b 0a20 2020 2063 6f6e   = nea1;.    con
+0003c980: 7374 2069 6e74 204d 203d 206e 6562 3031  st int M = neb01
+0003c990: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0003c9a0: 5254 286e 6530 203d 3d20 6e65 6130 293b  RT(ne0 == nea0);
+0003c9b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0003c9c0: 286e 6531 203d 3d20 6e65 6131 293b 0a20  (ne1 == nea1);. 
+0003c9d0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0003c9e0: 6532 203d 3d20 6e65 6132 293b 0a0a 2020  e2 == nea2);..  
+0003c9f0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0003ca00: 6130 2020 3d3d 2073 697a 656f 6628 6767  a0  == sizeof(gg
+0003ca10: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
+0003ca20: 2047 474d 4c5f 4153 5345 5254 286e 6262   GGML_ASSERT(nbb
+0003ca30: 3030 203d 3d20 7369 7a65 6f66 2867 676d  00 == sizeof(ggm
+0003ca40: 6c5f 6670 3136 5f74 2929 3b0a 2020 2020  l_fp16_t));.    
+0003ca50: 4747 4d4c 5f41 5353 4552 5428 6e62 6231  GGML_ASSERT(nbb1
+0003ca60: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+0003ca70: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+0003ca80: 5345 5254 286e 6263 3030 203d 3d20 7369  SERT(nbc00 == si
+0003ca90: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+0003caa0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+0003cab0: 4552 5428 6e62 6331 3020 3d3d 2073 697a  ERT(nbc10 == siz
+0003cac0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+0003cad0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+0003cae0: 6230 3020 3d3d 2044 293b 0a20 2020 2047  b00 == D);.    G
+0003caf0: 474d 4c5f 4153 5345 5254 286e 6562 3031  GML_ASSERT(neb01
+0003cb00: 203d 3d20 4d29 3b0a 2020 2020 4747 4d4c   == M);.    GGML
+0003cb10: 5f41 5353 4552 5428 6e65 6231 3020 3d3d  _ASSERT(neb10 ==
+0003cb20: 204d 293b 0a20 2020 2047 474d 4c5f 4153   M);.    GGML_AS
+0003cb30: 5345 5254 286e 6562 3131 203d 3d20 3129  SERT(neb11 == 1)
+0003cb40: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0003cb50: 5254 286e 6563 3030 203d 3d20 4d29 3b0a  RT(nec00 == M);.
+0003cb60: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003cb70: 6e65 6330 3120 3d3d 2044 293b 0a20 2020  nec01 == D);.   
+0003cb80: 2047 474d 4c5f 4153 5345 5254 286e 6563   GGML_ASSERT(nec
+0003cb90: 3130 203d 3d20 4429 3b0a 2020 2020 4747  10 == D);.    GG
+0003cba0: 4d4c 5f41 5353 4552 5428 6e65 6331 3120  ML_ASSERT(nec11 
+0003cbb0: 3d3d 2031 293b 0a0a 2020 2020 2f2f 2064  == 1);..    // d
+0003cbc0: 7374 2063 616e 6e6f 7420 6265 2074 7261  st cannot be tra
+0003cbd0: 6e73 706f 7365 6420 6f72 2070 6572 6d75  nsposed or permu
+0003cbe0: 7465 640a 2020 2020 4747 4d4c 5f41 5353  ted.    GGML_ASS
+0003cbf0: 4552 5428 6e62 3020 3d3d 2073 697a 656f  ERT(nb0 == sizeo
+0003cc00: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
+0003cc10: 474d 4c5f 4153 5345 5254 286e 6230 203c  GML_ASSERT(nb0 <
+0003cc20: 3d20 6e62 3129 3b0a 2020 2020 4747 4d4c  = nb1);.    GGML
+0003cc30: 5f41 5353 4552 5428 6e62 3120 3c3d 206e  _ASSERT(nb1 <= n
+0003cc40: 6232 293b 0a20 2020 2047 474d 4c5f 4153  b2);.    GGML_AS
+0003cc50: 5345 5254 286e 6232 203c 3d20 6e62 3329  SERT(nb2 <= nb3)
+0003cc60: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+0003cc70: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0003cc80: 5441 534b 5f49 4e49 5429 207b 0a20 2020  TASK_INIT) {.   
+0003cc90: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+0003cca0: 207d 0a0a 2020 2020 6966 2028 7061 7261   }..    if (para
+0003ccb0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+0003ccc0: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+0003ccd0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+0003cce0: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+0003ccf0: 7061 7261 6c6c 656c 697a 6520 6279 2061  parallelize by a
+0003cd00: 2072 6f77 7320 7573 696e 6720 6767 6d6c   rows using ggml
+0003cd10: 5f76 6563 5f64 6f74 5f66 3332 0a0a 2020  _vec_dot_f32..  
+0003cd20: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
+0003cd30: 696e 2061 0a20 2020 2063 6f6e 7374 2069  in a.    const i
+0003cd40: 6e74 206e 7220 3d20 6e65 6131 2a6e 6561  nt nr = nea1*nea
+0003cd50: 322a 6e65 6133 3b0a 0a20 2020 202f 2f20  2*nea3;..    // 
+0003cd60: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+0003cd70: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+0003cd80: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+0003cd90: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
+0003cda0: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
+0003cdb0: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
+0003cdc0: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
+0003cdd0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0003cde0: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
+0003cdf0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
+0003ce00: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
+0003ce10: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
+0003ce20: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
+0003ce30: 2061 2069 6e64 6963 6573 0a20 2020 2020   a indices.     
+0003ce40: 2020 2063 6f6e 7374 2069 6e74 2069 6133     const int ia3
+0003ce50: 203d 2069 722f 286e 6561 322a 6e65 6131   = ir/(nea2*nea1
+0003ce60: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0003ce70: 2069 6e74 2069 6132 203d 2028 6972 202d   int ia2 = (ir -
+0003ce80: 2069 6133 2a6e 6561 322a 6e65 6131 292f   ia3*nea2*nea1)/
+0003ce90: 6e65 6131 3b0a 2020 2020 2020 2020 636f  nea1;.        co
+0003cea0: 6e73 7420 696e 7420 6961 3120 3d20 2869  nst int ia1 = (i
+0003ceb0: 7220 2d20 6961 332a 6e65 6132 2a6e 6561  r - ia3*nea2*nea
+0003cec0: 3120 2d20 6961 322a 6e65 6131 293b 0a0a  1 - ia2*nea1);..
+0003ced0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0003cee0: 5320 3d20 2866 6c6f 6174 202a 2920 7061  S = (float *) pa
+0003cef0: 7261 6d73 2d3e 7764 6174 6120 2b20 6974  rams->wdata + it
+0003cf00: 682a 2832 2a4d 202b 2043 4143 4845 5f4c  h*(2*M + CACHE_L
+0003cf10: 494e 455f 5349 5a45 5f46 3332 293b 0a0a  INE_SIZE_F32);..
+0003cf20: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0003cf30: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
+0003cf40: 6230 313b 202b 2b69 6329 207b 0a20 2020  b01; ++ic) {.   
+0003cf50: 2020 2020 2020 2020 202f 2f20 6230 2069           // b0 i
+0003cf60: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+0003cf70: 2020 2063 6f6e 7374 2069 6e74 2069 6230     const int ib0
+0003cf80: 3320 3d20 6961 333b 0a20 2020 2020 2020  3 = ia3;.       
+0003cf90: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0003cfa0: 6230 3220 3d20 6961 323b 0a20 2020 2020  b02 = ia2;.     
+0003cfb0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0003cfc0: 2069 6230 3120 3d20 6963 3b0a 0a20 2020   ib01 = ic;..   
+0003cfd0: 2020 2020 2020 2020 202f 2f20 5320 696e           // S in
+0003cfe0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+0003cff0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+0003d000: 2069 6230 313b 0a0a 2020 2020 2020 2020   ib01;..        
+0003d010: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+0003d020: 5f66 3136 286e 6561 302c 0a20 2020 2020  _f16(nea0,.     
+0003d030: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+0003d040: 202b 2069 312c 0a20 2020 2020 2020 2020   + i1,.         
+0003d050: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
+0003d060: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
+0003d070: 7220 2a29 2062 302d 3e64 6174 6120 2b20  r *) b0->data + 
+0003d080: 2869 6230 312a 6e62 6230 3120 2b20 6962  (ib01*nbb01 + ib
+0003d090: 3032 2a6e 6262 3032 202b 2069 6230 332a  02*nbb02 + ib03*
+0003d0a0: 6e62 6230 3329 292c 0a20 2020 2020 2020  nbb03)),.       
+0003d0b0: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
+0003d0c0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
+0003d0d0: 6861 7220 2a29 2020 612d 3e64 6174 6120  har *)  a->data 
+0003d0e0: 2b20 2820 6961 312a 6e62 6131 2020 2b20  + ( ia1*nba1  + 
+0003d0f0: 2069 6132 2a6e 6261 3220 202b 2020 6961   ia2*nba2  +  ia
+0003d100: 332a 6e62 6133 2929 293b 0a20 2020 2020  3*nba3)));.     
+0003d110: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
+0003d120: 6d6c 5f76 6563 5f61 6464 5f66 3332 286e  ml_vec_add_f32(n
+0003d130: 6562 3031 2c20 532c 2053 2c20 2866 6c6f  eb01, S, S, (flo
+0003d140: 6174 202a 2920 6231 2d3e 6461 7461 293b  at *) b1->data);
+0003d150: 0a20 2020 2020 2020 202f 2f67 676d 6c5f  .        //ggml_
+0003d160: 7665 635f 6765 6c75 5f66 3332 286e 6562  vec_gelu_f32(neb
+0003d170: 3031 2c20 532c 2053 293b 0a0a 2020 2020  01, S, S);..    
+0003d180: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+0003d190: 2a20 5331 3620 3d20 2867 676d 6c5f 6670  * S16 = (ggml_fp
+0003d1a0: 3136 5f74 202a 2920 2828 666c 6f61 7420  16_t *) ((float 
+0003d1b0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
+0003d1c0: 202b 2069 7468 2a28 322a 4d20 2b20 4341   + ith*(2*M + CA
+0003d1d0: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
+0003d1e0: 3229 202b 204d 293b 0a0a 2020 2020 2020  2) + M);..      
+0003d1f0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0003d200: 3b20 6920 3c20 4d3b 2069 2b2b 2920 7b0a  ; i < M; i++) {.
+0003d210: 2020 2020 2020 2020 2020 2020 5331 365b              S16[
+0003d220: 695d 203d 2047 474d 4c5f 4650 3332 5f54  i] = GGML_FP32_T
+0003d230: 4f5f 4650 3136 2853 5b69 5d29 3b0a 2020  O_FP16(S[i]);.  
+0003d240: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0003d250: 2067 676d 6c5f 7665 635f 6765 6c75 5f66   ggml_vec_gelu_f
+0003d260: 3136 286e 6562 3031 2c20 5331 362c 2053  16(neb01, S16, S
+0003d270: 3136 293b 0a0a 2020 2020 2020 2020 7b0a  16);..        {.
+0003d280: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
+0003d290: 7374 2069 6e64 6963 6573 0a20 2020 2020  st indices.     
+0003d2a0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0003d2b0: 2069 3120 3d20 6961 313b 0a20 2020 2020   i1 = ia1;.     
+0003d2c0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0003d2d0: 2069 3220 3d20 6961 323b 0a20 2020 2020   i2 = ia2;.     
+0003d2e0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0003d2f0: 2069 3320 3d20 6961 333b 0a0a 2020 2020   i3 = ia3;..    
+0003d300: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0003d310: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
+0003d320: 6330 313b 202b 2b69 6329 207b 0a0a 2020  c01; ++ic) {..  
+0003d330: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0003d340: 6d6c 5f76 6563 5f64 6f74 5f66 3136 286e  ml_vec_dot_f16(n
+0003d350: 6562 3031 2c0a 2020 2020 2020 2020 2020  eb01,.          
+0003d360: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+0003d370: 6c6f 6174 202a 2920 2020 2020 2020 2828  loat *)       ((
+0003d380: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+0003d390: 6120 2b20 2869 632a 6e62 3020 2b20 6931  a + (ic*nb0 + i1
+0003d3a0: 2a6e 6231 2020 202b 2069 322a 6e62 3220  *nb1   + i2*nb2 
+0003d3b0: 2020 2b20 6933 2a6e 6233 2929 2c0a 2020    + i3*nb3)),.  
+0003d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d3d0: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
+0003d3e0: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+0003d3f0: 6330 2d3e 6461 7461 2020 2b20 2820 2020  c0->data  + (   
+0003d400: 2020 2020 2020 6963 2a6e 6263 3031 202b        ic*nbc01 +
+0003d410: 2069 322a 6e62 6330 3220 2b20 6933 2a6e   i2*nbc02 + i3*n
+0003d420: 6263 3033 2929 2c0a 2020 2020 2020 2020  bc03)),.        
+0003d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d440: 5331 3629 3b0a 2020 2020 2020 2020 2020  S16);.          
+0003d450: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+0003d460: 2067 676d 6c5f 7665 635f 6164 645f 6633   ggml_vec_add_f3
+0003d470: 3228 6e65 6330 312c 0a20 2020 2020 2020  2(nec01,.       
+0003d480: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+0003d490: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0003d4a0: 2064 7374 2d3e 6461 7461 202b 2028 6931   dst->data + (i1
+0003d4b0: 2a6e 6231 202b 2069 322a 6e62 3220 2b20  *nb1 + i2*nb2 + 
+0003d4c0: 6933 2a6e 6233 2929 2c0a 2020 2020 2020  i3*nb3)),.      
+0003d4d0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+0003d4e0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+0003d4f0: 2920 6473 742d 3e64 6174 6120 2b20 2869  ) dst->data + (i
+0003d500: 312a 6e62 3120 2b20 6932 2a6e 6232 202b  1*nb1 + i2*nb2 +
+0003d510: 2069 332a 6e62 3329 292c 0a20 2020 2020   i3*nb3)),.     
+0003d520: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0003d530: 666c 6f61 7420 2a29 2063 312d 3e64 6174  float *) c1->dat
+0003d540: 6129 3b0a 2020 2020 2020 2020 7d0a 2020  a);.        }.  
+0003d550: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+0003d560: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+0003d570: 666f 7277 6172 645f 666c 6173 685f 6666  forward_flash_ff
+0003d580: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0003d590: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0003d5a0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0003d5b0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0003d5c0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0003d5d0: 656e 736f 7220 2a20 612c 0a20 2020 2020  ensor * a,.     
+0003d5e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0003d5f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6230  ggml_tensor * b0
+0003d600: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0003d610: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0003d620: 6f72 202a 2062 312c 0a20 2020 2020 2020  or * b1,.       
+0003d630: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0003d640: 6d6c 5f74 656e 736f 7220 2a20 6330 2c0a  ml_tensor * c0,.
+0003d650: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0003d660: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0003d670: 202a 2063 312c 0a20 2020 2020 2020 2073   * c1,.        s
+0003d680: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0003d690: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+0003d6a0: 7769 7463 6820 2862 302d 3e74 7970 6529  witch (b0->type)
+0003d6b0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+0003d6c0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+0003d6d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003d6e0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003d6f0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003d700: 645f 666c 6173 685f 6666 5f66 3136 2870  d_flash_ff_f16(p
+0003d710: 6172 616d 732c 2061 2c20 6230 2c20 6231  arams, a, b0, b1
+0003d720: 2c20 6330 2c20 6331 2c20 6473 7429 3b0a  , c0, c1, dst);.
+0003d730: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0003d740: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0003d750: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+0003d760: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0003d770: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0003d780: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0003d790: 293b 202f 2f20 544f 444f 0a20 2020 2020  ); // TODO.     
+0003d7a0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0003d7b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0003d7c0: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
+0003d7d0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0003d7e0: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
+0003d7f0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0003d800: 5f49 383a 0a20 2020 2020 2020 2063 6173  _I8:.        cas
+0003d810: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
+0003d820: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0003d830: 4d4c 5f54 5950 455f 4933 323a 0a20 2020  ML_TYPE_I32:.   
+0003d840: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0003d850: 5950 455f 434f 554e 543a 0a20 2020 2020  YPE_COUNT:.     
+0003d860: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0003d870: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0003d880: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+0003d890: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0003d8a0: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f2f 2f2f  ;.    }.}../////
+0003d8b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0003d8c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a 7374  ////////////..st
+0003d8d0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0003d8e0: 6f6d 7075 7465 5f66 6f72 7761 7264 2873  ompute_forward(s
+0003d8f0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+0003d900: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+0003d910: 6d73 2c20 7374 7275 6374 2067 676d 6c5f  ms, struct ggml_
+0003d920: 7465 6e73 6f72 202a 2074 656e 736f 7229  tensor * tensor)
+0003d930: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+0003d940: 5254 2870 6172 616d 7329 3b0a 0a20 2020  RT(params);..   
+0003d950: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
+0003d960: 3e6f 7029 207b 0a20 2020 2020 2020 2063  >op) {.        c
+0003d970: 6173 6520 4747 4d4c 5f4f 505f 4455 503a  ase GGML_OP_DUP:
+0003d980: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0003d990: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0003d9a0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0003d9b0: 6172 645f 6475 7028 7061 7261 6d73 2c20  ard_dup(params, 
+0003d9c0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+0003d9d0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+0003d9e0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0003d9f0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0003da00: 5f41 4444 3a0a 2020 2020 2020 2020 2020  _ADD:.          
+0003da10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0003da20: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+0003da30: 5f66 6f72 7761 7264 5f61 6464 2870 6172  _forward_add(par
+0003da40: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+0003da50: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
+0003da60: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+0003da70: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0003da80: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0003da90: 5f4f 505f 5355 423a 0a20 2020 2020 2020  _OP_SUB:.       
+0003daa0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0003dab0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+0003dac0: 7574 655f 666f 7277 6172 645f 7375 6228  ute_forward_sub(
+0003dad0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+0003dae0: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+0003daf0: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+0003db00: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0003db10: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0003db20: 474d 4c5f 4f50 5f4d 554c 3a0a 2020 2020  GML_OP_MUL:.    
+0003db30: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003db40: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0003db50: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+0003db60: 756c 2870 6172 616d 732c 2074 656e 736f  ul(params, tenso
+0003db70: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+0003db80: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
+0003db90: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0003dba0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0003dbb0: 6520 4747 4d4c 5f4f 505f 4449 563a 0a20  e GGML_OP_DIV:. 
+0003dbc0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003dbd0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003dbe0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003dbf0: 645f 6469 7628 7061 7261 6d73 2c20 7465  d_div(params, te
+0003dc00: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+0003dc10: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
+0003dc20: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0003dc30: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0003dc40: 6361 7365 2047 474d 4c5f 4f50 5f53 5152  case GGML_OP_SQR
+0003dc50: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0003dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dc70: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0003dc80: 7761 7264 5f73 7172 2870 6172 616d 732c  ward_sqr(params,
+0003dc90: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+0003dca0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+0003dcb0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0003dcc0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0003dcd0: 505f 5351 5254 3a0a 2020 2020 2020 2020  P_SQRT:.        
+0003dce0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003dcf0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0003dd00: 7465 5f66 6f72 7761 7264 5f73 7172 7428  te_forward_sqrt(
+0003dd10: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+0003dd20: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
+0003dd30: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0003dd40: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0003dd50: 2047 474d 4c5f 4f50 5f53 554d 3a0a 2020   GGML_OP_SUM:.  
+0003dd60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0003dd70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0003dd80: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0003dd90: 5f73 756d 2870 6172 616d 732c 2074 656e  _sum(params, ten
+0003dda0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+0003ddb0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+0003ddc0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0003ddd0: 2063 6173 6520 4747 4d4c 5f4f 505f 4d45   case GGML_OP_ME
+0003dde0: 414e 3a0a 2020 2020 2020 2020 2020 2020  AN:.            
+0003ddf0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003de00: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0003de10: 6f72 7761 7264 5f6d 6561 6e28 7061 7261  orward_mean(para
+0003de20: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+0003de30: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+0003de40: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0003de50: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0003de60: 4c5f 4f50 5f52 4550 4541 543a 0a20 2020  L_OP_REPEAT:.   
+0003de70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0003de80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003de90: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0003dea0: 7265 7065 6174 2870 6172 616d 732c 2074  repeat(params, t
+0003deb0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+0003dec0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+0003ded0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0003dee0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0003def0: 4142 533a 0a20 2020 2020 2020 2020 2020  ABS:.           
+0003df00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003df10: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+0003df20: 666f 7277 6172 645f 6162 7328 7061 7261  forward_abs(para
+0003df30: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+0003df40: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+0003df50: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0003df60: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0003df70: 4c5f 4f50 5f53 474e 3a0a 2020 2020 2020  L_OP_SGN:.      
+0003df80: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0003df90: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+0003dfa0: 7075 7465 5f66 6f72 7761 7264 5f73 676e  pute_forward_sgn
+0003dfb0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+0003dfc0: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
+0003dfd0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0003dfe0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0003dff0: 6520 4747 4d4c 5f4f 505f 4e45 473a 0a20  e GGML_OP_NEG:. 
+0003e000: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003e010: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003e020: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003e030: 645f 6e65 6728 7061 7261 6d73 2c20 7465  d_neg(params, te
+0003e040: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+0003e050: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+0003e060: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0003e070: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+0003e080: 5445 503a 0a20 2020 2020 2020 2020 2020  TEP:.           
+0003e090: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003e0a0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+0003e0b0: 666f 7277 6172 645f 7374 6570 2870 6172  forward_step(par
+0003e0c0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+0003e0d0: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
+0003e0e0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0003e0f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0003e100: 4d4c 5f4f 505f 5245 4c55 3a0a 2020 2020  ML_OP_RELU:.    
+0003e110: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003e120: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0003e130: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+0003e140: 656c 7528 7061 7261 6d73 2c20 7465 6e73  elu(params, tens
+0003e150: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+0003e160: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0003e170: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0003e180: 6361 7365 2047 474d 4c5f 4f50 5f47 454c  case GGML_OP_GEL
+0003e190: 553a 0a20 2020 2020 2020 2020 2020 207b  U:.            {
+0003e1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e1b0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0003e1c0: 7277 6172 645f 6765 6c75 2870 6172 616d  rward_gelu(param
+0003e1d0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+0003e1e0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+0003e1f0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0003e200: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0003e210: 5f4f 505f 5349 4c55 3a0a 2020 2020 2020  _OP_SILU:.      
+0003e220: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0003e230: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+0003e240: 7075 7465 5f66 6f72 7761 7264 5f73 696c  pute_forward_sil
+0003e250: 7528 7061 7261 6d73 2c20 7465 6e73 6f72  u(params, tensor
+0003e260: 2d3e 7372 6330 2c20 7465 6e73 6f72 293b  ->src0, tensor);
+0003e270: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0003e280: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0003e290: 7365 2047 474d 4c5f 4f50 5f4e 4f52 4d3a  se GGML_OP_NORM:
+0003e2a0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0003e2b0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0003e2c0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0003e2d0: 6172 645f 6e6f 726d 2870 6172 616d 732c  ard_norm(params,
+0003e2e0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+0003e2f0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+0003e300: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0003e310: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0003e320: 505f 524d 535f 4e4f 524d 3a0a 2020 2020  P_RMS_NORM:.    
+0003e330: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003e340: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0003e350: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+0003e360: 6d73 5f6e 6f72 6d28 7061 7261 6d73 2c20  ms_norm(params, 
+0003e370: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+0003e380: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+0003e390: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0003e3a0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0003e3b0: 5f4d 554c 5f4d 4154 3a0a 2020 2020 2020  _MUL_MAT:.      
+0003e3c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0003e3d0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+0003e3e0: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+0003e3f0: 5f6d 6174 2870 6172 616d 732c 2074 656e  _mat(params, ten
+0003e400: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+0003e410: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
+0003e420: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0003e430: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0003e440: 6173 6520 4747 4d4c 5f4f 505f 5343 414c  ase GGML_OP_SCAL
+0003e450: 453a 0a20 2020 2020 2020 2020 2020 207b  E:.            {
+0003e460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e470: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0003e480: 7277 6172 645f 7363 616c 6528 7061 7261  rward_scale(para
+0003e490: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+0003e4a0: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+0003e4b0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+0003e4c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0003e4d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0003e4e0: 4f50 5f43 5059 3a0a 2020 2020 2020 2020  OP_CPY:.        
+0003e4f0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003e500: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0003e510: 7465 5f66 6f72 7761 7264 5f63 7079 2870  te_forward_cpy(p
+0003e520: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+0003e530: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
+0003e540: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0003e550: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0003e560: 4747 4d4c 5f4f 505f 5245 5348 4150 453a  GGML_OP_RESHAPE:
+0003e570: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0003e580: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0003e590: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0003e5a0: 6172 645f 7265 7368 6170 6528 7061 7261  ard_reshape(para
+0003e5b0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+0003e5c0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+0003e5d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0003e5e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0003e5f0: 4c5f 4f50 5f56 4945 573a 0a20 2020 2020  L_OP_VIEW:.     
+0003e600: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0003e610: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+0003e620: 6d70 7574 655f 666f 7277 6172 645f 7669  mpute_forward_vi
+0003e630: 6577 2870 6172 616d 732c 2074 656e 736f  ew(params, tenso
+0003e640: 722d 3e73 7263 3029 3b0a 2020 2020 2020  r->src0);.      
+0003e650: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0003e660: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0003e670: 5f4f 505f 5045 524d 5554 453a 0a20 2020  _OP_PERMUTE:.   
+0003e680: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0003e690: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003e6a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0003e6b0: 7065 726d 7574 6528 7061 7261 6d73 2c20  permute(params, 
+0003e6c0: 7465 6e73 6f72 2d3e 7372 6330 293b 0a20  tensor->src0);. 
+0003e6d0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0003e6e0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0003e6f0: 2047 474d 4c5f 4f50 5f54 5241 4e53 504f   GGML_OP_TRANSPO
+0003e700: 5345 3a0a 2020 2020 2020 2020 2020 2020  SE:.            
+0003e710: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003e720: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0003e730: 6f72 7761 7264 5f74 7261 6e73 706f 7365  orward_transpose
+0003e740: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+0003e750: 3e73 7263 3029 3b0a 2020 2020 2020 2020  >src0);.        
+0003e760: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0003e770: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0003e780: 505f 4745 545f 524f 5753 3a0a 2020 2020  P_GET_ROWS:.    
+0003e790: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003e7a0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0003e7b0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
+0003e7c0: 6574 5f72 6f77 7328 7061 7261 6d73 2c20  et_rows(params, 
+0003e7d0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+0003e7e0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+0003e7f0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+0003e800: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0003e810: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
+0003e820: 4941 475f 4d41 534b 5f49 4e46 3a0a 2020  IAG_MASK_INF:.  
+0003e830: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0003e840: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0003e850: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0003e860: 5f64 6961 675f 6d61 736b 5f69 6e66 2870  _diag_mask_inf(p
+0003e870: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+0003e880: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
+0003e890: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
+0003e8a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0003e8b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0003e8c0: 4d4c 5f4f 505f 534f 4654 5f4d 4158 3a0a  ML_OP_SOFT_MAX:.
+0003e8d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0003e8e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0003e8f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0003e900: 7264 5f73 6f66 745f 6d61 7828 7061 7261  rd_soft_max(para
+0003e910: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+0003e920: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+0003e930: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0003e940: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0003e950: 4c5f 4f50 5f52 4f50 453a 0a20 2020 2020  L_OP_ROPE:.     
+0003e960: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0003e970: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+0003e980: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
+0003e990: 7065 2870 6172 616d 732c 2074 656e 736f  pe(params, tenso
+0003e9a0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+0003e9b0: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
+0003e9c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0003e9d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0003e9e0: 6520 4747 4d4c 5f4f 505f 434f 4e56 5f31  e GGML_OP_CONV_1
+0003e9f0: 445f 3153 3a0a 2020 2020 2020 2020 2020  D_1S:.          
+0003ea00: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0003ea10: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+0003ea20: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
+0003ea30: 5f31 7328 7061 7261 6d73 2c20 7465 6e73  _1s(params, tens
+0003ea40: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+0003ea50: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
+0003ea60: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0003ea70: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0003ea80: 7365 2047 474d 4c5f 4f50 5f43 4f4e 565f  se GGML_OP_CONV_
+0003ea90: 3144 5f32 533a 0a20 2020 2020 2020 2020  1D_2S:.         
+0003eaa0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0003eab0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+0003eac0: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
+0003ead0: 645f 3273 2870 6172 616d 732c 2074 656e  d_2s(params, ten
+0003eae0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+0003eaf0: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
+0003eb00: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0003eb10: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0003eb20: 6173 6520 4747 4d4c 5f4f 505f 464c 4153  ase GGML_OP_FLAS
+0003eb30: 485f 4154 544e 3a0a 2020 2020 2020 2020  H_ATTN:.        
+0003eb40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003eb50: 2020 2020 2020 696e 7433 325f 7420 7420        int32_t t 
+0003eb60: 3d20 6767 6d6c 5f67 6574 5f69 3332 5f31  = ggml_get_i32_1
+0003eb70: 6428 7465 6e73 6f72 2d3e 6f70 745b 315d  d(tensor->opt[1]
+0003eb80: 2c20 3029 3b0a 2020 2020 2020 2020 2020  , 0);.          
+0003eb90: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0003eba0: 5428 7420 3d3d 2030 207c 7c20 7420 3d3d  T(t == 0 || t ==
+0003ebb0: 2031 293b 0a20 2020 2020 2020 2020 2020   1);.           
+0003ebc0: 2020 2020 2062 6f6f 6c20 6d61 736b 6564       bool masked
+0003ebd0: 203d 2074 2021 3d20 303b 0a20 2020 2020   = t != 0;.     
+0003ebe0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003ebf0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0003ec00: 666c 6173 685f 6174 746e 2870 6172 616d  flash_attn(param
+0003ec10: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+0003ec20: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
+0003ec30: 656e 736f 722d 3e6f 7074 5b30 5d2c 206d  ensor->opt[0], m
+0003ec40: 6173 6b65 642c 2074 656e 736f 7229 3b0a  asked, tensor);.
+0003ec50: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0003ec60: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0003ec70: 6520 4747 4d4c 5f4f 505f 464c 4153 485f  e GGML_OP_FLASH_
+0003ec80: 4646 3a0a 2020 2020 2020 2020 2020 2020  FF:.            
+0003ec90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003eca0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0003ecb0: 6f72 7761 7264 5f66 6c61 7368 5f66 6628  orward_flash_ff(
+0003ecc0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+0003ecd0: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+0003ece0: 6331 2c20 7465 6e73 6f72 2d3e 6f70 745b  c1, tensor->opt[
+0003ecf0: 305d 2c20 7465 6e73 6f72 2d3e 6f70 745b  0], tensor->opt[
+0003ed00: 315d 2c20 7465 6e73 6f72 2d3e 6f70 745b  1], tensor->opt[
+0003ed10: 325d 2c20 7465 6e73 6f72 293b 0a20 2020  2], tensor);.   
+0003ed20: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0003ed30: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0003ed40: 474d 4c5f 4f50 5f4e 4f4e 453a 0a20 2020  GML_OP_NONE:.   
+0003ed50: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0003ed60: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
+0003ed70: 700a 2020 2020 2020 2020 2020 2020 7d20  p.            } 
+0003ed80: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0003ed90: 6173 6520 4747 4d4c 5f4f 505f 434f 554e  ase GGML_OP_COUN
+0003eda0: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+0003edb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003edc0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+0003edd0: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+0003ede0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+0003edf0: 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  }../////////////
+0003ee00: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0003ee10: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0003ee20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0003ee30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0003ee40: 2f2f 2f0a 0a73 7461 7469 6320 766f 6964  ///..static void
+0003ee50: 2067 676d 6c5f 636f 6d70 7574 655f 6261   ggml_compute_ba
+0003ee60: 636b 7761 7264 2873 7472 7563 7420 6767  ckward(struct gg
+0003ee70: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0003ee80: 2c20 7374 7275 6374 2067 676d 6c5f 7465  , struct ggml_te
+0003ee90: 6e73 6f72 202a 2074 656e 736f 722c 2062  nsor * tensor, b
+0003eea0: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
+0003eeb0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0003eec0: 656e 736f 7220 2a20 7372 6330 203d 2074  ensor * src0 = t
+0003eed0: 656e 736f 722d 3e73 7263 303b 0a20 2020  ensor->src0;.   
+0003eee0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0003eef0: 736f 7220 2a20 7372 6331 203d 2074 656e  sor * src1 = ten
+0003ef00: 736f 722d 3e73 7263 313b 0a0a 2020 2020  sor->src1;..    
+0003ef10: 7377 6974 6368 2028 7465 6e73 6f72 2d3e  switch (tensor->
+0003ef20: 6f70 2920 7b0a 2020 2020 2020 2020 6361  op) {.        ca
+0003ef30: 7365 2047 474d 4c5f 4f50 5f44 5550 3a0a  se GGML_OP_DUP:.
+0003ef40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0003ef50: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003ef60: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
 0003ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef80: 2020 2020 2028 2863 6861 7220 2a29 2076       ((char *) v
-0003ef90: 2d3e 6461 7461 2020 202b 2028 2020 2020  ->data   + (    
-0003efa0: 2020 2020 2069 632a 6e62 7631 202b 2069       ic*nbv1 + i
-0003efb0: 322a 6e62 7632 202b 2069 332a 6e62 7633  2*nbv2 + i3*nbv3
-0003efc0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0003efd0: 2020 2020 2020 2020 2020 2020 5331 3629              S16)
-0003efe0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0003eff0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0003f000: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-0003f010: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0003f020: 6172 645f 666c 6173 685f 6174 746e 280a  ard_flash_attn(.
-0003f030: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0003f040: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0003f050: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-0003f060: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-0003f070: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0003f080: 736f 7220 2a20 712c 0a20 2020 2020 2020  sor * q,.       
-0003f090: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0003f0a0: 6d6c 5f74 656e 736f 7220 2a20 6b2c 0a20  ml_tensor * k,. 
-0003f0b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0003f0c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0003f0d0: 2a20 762c 0a20 2020 2020 2020 2063 6f6e  * v,.        con
-0003f0e0: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
-0003f0f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0003f100: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-0003f110: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-0003f120: 712d 3e74 7970 6529 207b 0a20 2020 2020  q->type) {.     
-0003f130: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0003f140: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
-0003f150: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0003f160: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0003f170: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
-0003f180: 6174 746e 5f66 3136 2870 6172 616d 732c  attn_f16(params,
-0003f190: 2071 2c20 6b2c 2076 2c20 6d61 736b 6564   q, k, v, masked
-0003f1a0: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-0003f1b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0003f1c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0003f1d0: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-0003f1e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0003f1f0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-0003f200: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
-0003f210: 685f 6174 746e 5f66 3332 2870 6172 616d  h_attn_f32(param
-0003f220: 732c 2071 2c20 6b2c 2076 2c20 6d61 736b  s, q, k, v, mask
-0003f230: 6564 2c20 6473 7429 3b0a 2020 2020 2020  ed, dst);.      
-0003f240: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0003f250: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0003f260: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
-0003f270: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0003f280: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
-0003f290: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0003f2a0: 4938 3a0a 2020 2020 2020 2020 6361 7365  I8:.        case
-0003f2b0: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
-0003f2c0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0003f2d0: 4c5f 5459 5045 5f49 3332 3a0a 2020 2020  L_TYPE_I32:.    
-0003f2e0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0003f2f0: 5045 5f43 4f55 4e54 3a0a 2020 2020 2020  PE_COUNT:.      
-0003f300: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0003f310: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0003f320: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-0003f330: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0003f340: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
-0003f350: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0003f360: 645f 666c 6173 685f 6666 0a0a 7374 6174  d_flash_ff..stat
-0003f370: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-0003f380: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
-0003f390: 7368 5f66 665f 6631 3628 0a20 2020 2020  sh_ff_f16(.     
-0003f3a0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0003f3b0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-0003f3c0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-0003f3d0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0003f3e0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0003f3f0: 2061 2c20 202f 2f20 4631 360a 2020 2020   a,  // F16.    
-0003f400: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0003f410: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-0003f420: 302c 202f 2f20 4631 3620 6663 5f77 0a20  0, // F16 fc_w. 
-0003f430: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0003f440: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0003f450: 2a20 6231 2c20 2f2f 2046 3332 2066 635f  * b1, // F32 fc_
-0003f460: 620a 2020 2020 2020 2020 636f 6e73 7420  b.        const 
-0003f470: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0003f480: 6f72 202a 2063 302c 202f 2f20 4631 3620  or * c0, // F16 
-0003f490: 7072 6f6a 5f77 0a20 2020 2020 2020 2063  proj_w.        c
-0003f4a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0003f4b0: 5f74 656e 736f 7220 2a20 6331 2c20 2f2f  _tensor * c1, //
-0003f4c0: 2046 3332 2070 726f 6a5f 620a 2020 2020   F32 proj_b.    
-0003f4d0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0003f4e0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-0003f4f0: 2020 2020 696e 7436 345f 7420 7430 203d      int64_t t0 =
-0003f500: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
-0003f510: 7573 2829 3b0a 2020 2020 554e 5553 4544  us();.    UNUSED
-0003f520: 2874 3029 3b0a 0a20 2020 2063 6f6e 7374  (t0);..    const
-0003f530: 2069 6e74 206e 6561 3020 3d20 612d 3e6e   int nea0 = a->n
-0003f540: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0003f550: 696e 7420 6e65 6131 203d 2061 2d3e 6e65  int nea1 = a->ne
-0003f560: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-0003f570: 6e74 206e 6561 3220 3d20 612d 3e6e 655b  nt nea2 = a->ne[
-0003f580: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-0003f590: 7420 6e65 6133 203d 2061 2d3e 6e65 5b33  t nea3 = a->ne[3
-0003f5a0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-0003f5b0: 7420 6e65 6230 3020 3d20 6230 2d3e 6e65  t neb00 = b0->ne
-0003f5c0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0003f5d0: 6e74 206e 6562 3031 203d 2062 302d 3e6e  nt neb01 = b0->n
-0003f5e0: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
-0003f5f0: 7420 696e 7420 6e65 6230 3220 3d20 6230  t int neb02 = b0
-0003f600: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
-0003f610: 6f6e 7374 2069 6e74 206e 6562 3033 203d  onst int neb03 =
-0003f620: 2062 302d 3e6e 655b 335d 3b0a 0a20 2020   b0->ne[3];..   
-0003f630: 2063 6f6e 7374 2069 6e74 206e 6562 3130   const int neb10
-0003f640: 203d 2062 312d 3e6e 655b 305d 3b0a 2020   = b1->ne[0];.  
-0003f650: 2020 636f 6e73 7420 696e 7420 6e65 6231    const int neb1
-0003f660: 3120 3d20 6231 2d3e 6e65 5b31 5d3b 0a20  1 = b1->ne[1];. 
-0003f670: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0003f680: 6562 3132 203d 2062 312d 3e6e 655b 325d  eb12 = b1->ne[2]
-0003f690: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0003f6a0: 7420 6e65 6231 3320 3d20 6231 2d3e 6e65  t neb13 = b1->ne
-0003f6b0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0003f6c0: 696e 7420 6e65 6330 3020 3d20 6330 2d3e  int nec00 = c0->
-0003f6d0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-0003f6e0: 2069 6e74 206e 6563 3031 203d 2063 302d   int nec01 = c0-
-0003f6f0: 3e6e 655b 315d 3b0a 2020 2020 2f2f 636f  >ne[1];.    //co
-0003f700: 6e73 7420 696e 7420 6e65 6330 3220 3d20  nst int nec02 = 
-0003f710: 6330 2d3e 6e65 5b32 5d3b 0a20 2020 202f  c0->ne[2];.    /
-0003f720: 2f63 6f6e 7374 2069 6e74 206e 6563 3033  /const int nec03
-0003f730: 203d 2063 302d 3e6e 655b 335d 3b0a 0a20   = c0->ne[3];.. 
-0003f740: 2020 2063 6f6e 7374 2069 6e74 206e 6563     const int nec
-0003f750: 3130 203d 2063 312d 3e6e 655b 305d 3b0a  10 = c1->ne[0];.
-0003f760: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-0003f770: 6331 3120 3d20 6331 2d3e 6e65 5b31 5d3b  c11 = c1->ne[1];
-0003f780: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0003f790: 206e 6563 3132 203d 2063 312d 3e6e 655b   nec12 = c1->ne[
-0003f7a0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-0003f7b0: 696e 7420 6e65 6331 3320 3d20 6331 2d3e  int nec13 = c1->
-0003f7c0: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-0003f7d0: 7420 696e 7420 6e65 3020 3d20 6473 742d  t int ne0 = dst-
-0003f7e0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-0003f7f0: 7420 696e 7420 6e65 3120 3d20 6473 742d  t int ne1 = dst-
-0003f800: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-0003f810: 7420 696e 7420 6e65 3220 3d20 6473 742d  t int ne2 = dst-
-0003f820: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
-0003f830: 6e73 7420 696e 7420 6e65 3320 3d20 6473  nst int ne3 = ds
-0003f840: 742d 3e6e 655b 335d 3b0a 0a20 2020 2063  t->ne[3];..    c
-0003f850: 6f6e 7374 2069 6e74 206e 6261 3020 3d20  onst int nba0 = 
-0003f860: 612d 3e6e 625b 305d 3b0a 2020 2020 636f  a->nb[0];.    co
-0003f870: 6e73 7420 696e 7420 6e62 6131 203d 2061  nst int nba1 = a
-0003f880: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-0003f890: 7374 2069 6e74 206e 6261 3220 3d20 612d  st int nba2 = a-
-0003f8a0: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-0003f8b0: 7420 696e 7420 6e62 6133 203d 2061 2d3e  t int nba3 = a->
-0003f8c0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-0003f8d0: 7420 696e 7420 6e62 6230 3020 3d20 6230  t int nbb00 = b0
-0003f8e0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-0003f8f0: 7374 2069 6e74 206e 6262 3031 203d 2062  st int nbb01 = b
-0003f900: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
-0003f910: 6e73 7420 696e 7420 6e62 6230 3220 3d20  nst int nbb02 = 
-0003f920: 6230 2d3e 6e62 5b32 5d3b 0a20 2020 2063  b0->nb[2];.    c
-0003f930: 6f6e 7374 2069 6e74 206e 6262 3033 203d  onst int nbb03 =
-0003f940: 2062 302d 3e6e 625b 335d 3b0a 0a20 2020   b0->nb[3];..   
-0003f950: 2063 6f6e 7374 2069 6e74 206e 6262 3130   const int nbb10
-0003f960: 203d 2062 312d 3e6e 625b 305d 3b0a 2020   = b1->nb[0];.  
-0003f970: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-0003f980: 6231 3120 3d20 6231 2d3e 6e62 5b31 5d3b  b11 = b1->nb[1];
-0003f990: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0003f9a0: 206e 6262 3132 203d 2062 312d 3e6e 625b   nbb12 = b1->nb[
-0003f9b0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-0003f9c0: 696e 7420 6e62 6231 3320 3d20 6231 2d3e  int nbb13 = b1->
-0003f9d0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-0003f9e0: 7420 696e 7420 6e62 6330 3020 3d20 6330  t int nbc00 = c0
-0003f9f0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-0003fa00: 7374 2069 6e74 206e 6263 3031 203d 2063  st int nbc01 = c
-0003fa10: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
-0003fa20: 6e73 7420 696e 7420 6e62 6330 3220 3d20  nst int nbc02 = 
-0003fa30: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
-0003fa40: 6f6e 7374 2069 6e74 206e 6263 3033 203d  onst int nbc03 =
-0003fa50: 2063 302d 3e6e 625b 335d 3b0a 0a20 2020   c0->nb[3];..   
-0003fa60: 2063 6f6e 7374 2069 6e74 206e 6263 3130   const int nbc10
-0003fa70: 203d 2063 312d 3e6e 625b 305d 3b0a 2020   = c1->nb[0];.  
-0003fa80: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-0003fa90: 6331 3120 3d20 6331 2d3e 6e62 5b31 5d3b  c11 = c1->nb[1];
-0003faa0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0003fab0: 206e 6263 3132 203d 2063 312d 3e6e 625b   nbc12 = c1->nb[
-0003fac0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-0003fad0: 696e 7420 6e62 6331 3320 3d20 6331 2d3e  int nbc13 = c1->
-0003fae0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-0003faf0: 7420 696e 7420 6e62 3020 3d20 6473 742d  t int nb0 = dst-
-0003fb00: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0003fb10: 7420 696e 7420 6e62 3120 3d20 6473 742d  t int nb1 = dst-
-0003fb20: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-0003fb30: 7420 696e 7420 6e62 3220 3d20 6473 742d  t int nb2 = dst-
-0003fb40: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-0003fb50: 7420 696e 7420 6e62 3320 3d20 6473 742d  t int nb3 = dst-
-0003fb60: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-0003fb70: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
-0003fb80: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
-0003fb90: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
-0003fba0: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
-0003fbb0: 636f 6e73 7420 696e 7420 4420 3d20 6e65  const int D = ne
-0003fbc0: 6130 3b0a 2020 2020 2f2f 636f 6e73 7420  a0;.    //const 
-0003fbd0: 696e 7420 4e20 3d20 6e65 6131 3b0a 2020  int N = nea1;.  
-0003fbe0: 2020 636f 6e73 7420 696e 7420 4d20 3d20    const int M = 
-0003fbf0: 6e65 6230 313b 0a0a 2020 2020 4747 4d4c  neb01;..    GGML
-0003fc00: 5f41 5353 4552 5428 6e65 3020 3d3d 206e  _ASSERT(ne0 == n
-0003fc10: 6561 3029 3b0a 2020 2020 4747 4d4c 5f41  ea0);.    GGML_A
-0003fc20: 5353 4552 5428 6e65 3120 3d3d 206e 6561  SSERT(ne1 == nea
-0003fc30: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
-0003fc40: 4552 5428 6e65 3220 3d3d 206e 6561 3229  ERT(ne2 == nea2)
-0003fc50: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
-0003fc60: 5254 286e 6261 3020 203d 3d20 7369 7a65  RT(nba0  == size
-0003fc70: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
-0003fc80: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0003fc90: 5428 6e62 6230 3020 3d3d 2073 697a 656f  T(nbb00 == sizeo
-0003fca0: 6628 6767 6d6c 5f66 7031 365f 7429 293b  f(ggml_fp16_t));
-0003fcb0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0003fcc0: 286e 6262 3130 203d 3d20 7369 7a65 6f66  (nbb10 == sizeof
-0003fcd0: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
-0003fce0: 4d4c 5f41 5353 4552 5428 6e62 6330 3020  ML_ASSERT(nbc00 
-0003fcf0: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-0003fd00: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
-0003fd10: 4c5f 4153 5345 5254 286e 6263 3130 203d  L_ASSERT(nbc10 =
-0003fd20: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0003fd30: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
-0003fd40: 5254 286e 6562 3030 203d 3d20 4429 3b0a  RT(neb00 == D);.
-0003fd50: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003fd60: 6e65 6230 3120 3d3d 204d 293b 0a20 2020  neb01 == M);.   
-0003fd70: 2047 474d 4c5f 4153 5345 5254 286e 6562   GGML_ASSERT(neb
-0003fd80: 3130 203d 3d20 4d29 3b0a 2020 2020 4747  10 == M);.    GG
-0003fd90: 4d4c 5f41 5353 4552 5428 6e65 6231 3120  ML_ASSERT(neb11 
-0003fda0: 3d3d 2031 293b 0a0a 2020 2020 4747 4d4c  == 1);..    GGML
-0003fdb0: 5f41 5353 4552 5428 6e65 6330 3020 3d3d  _ASSERT(nec00 ==
-0003fdc0: 204d 293b 0a20 2020 2047 474d 4c5f 4153   M);.    GGML_AS
-0003fdd0: 5345 5254 286e 6563 3031 203d 3d20 4429  SERT(nec01 == D)
-0003fde0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0003fdf0: 5428 6e65 6331 3020 3d3d 2044 293b 0a20  T(nec10 == D);. 
-0003fe00: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0003fe10: 6563 3131 203d 3d20 3129 3b0a 0a20 2020  ec11 == 1);..   
-0003fe20: 202f 2f20 6473 7420 6361 6e6e 6f74 2062   // dst cannot b
-0003fe30: 6520 7472 616e 7370 6f73 6564 206f 7220  e transposed or 
-0003fe40: 7065 726d 7574 6564 0a20 2020 2047 474d  permuted.    GGM
-0003fe50: 4c5f 4153 5345 5254 286e 6230 203d 3d20  L_ASSERT(nb0 == 
-0003fe60: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-0003fe70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003fe80: 6e62 3020 3c3d 206e 6231 293b 0a20 2020  nb0 <= nb1);.   
-0003fe90: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
-0003fea0: 203c 3d20 6e62 3229 3b0a 2020 2020 4747   <= nb2);.    GG
-0003feb0: 4d4c 5f41 5353 4552 5428 6e62 3220 3c3d  ML_ASSERT(nb2 <=
-0003fec0: 206e 6233 293b 0a0a 2020 2020 6966 2028   nb3);..    if (
-0003fed0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0003fee0: 4747 4d4c 5f54 4153 4b5f 494e 4954 2920  GGML_TASK_INIT) 
-0003fef0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-0003ff00: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
-0003ff10: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-0003ff20: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-0003ff30: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-0003ff40: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-0003ff50: 2020 2f2f 2070 6172 616c 6c65 6c69 7a65    // parallelize
-0003ff60: 2062 7920 6120 726f 7773 2075 7369 6e67   by a rows using
-0003ff70: 2067 676d 6c5f 7665 635f 646f 745f 6633   ggml_vec_dot_f3
-0003ff80: 320a 0a20 2020 202f 2f20 746f 7461 6c20  2..    // total 
-0003ff90: 726f 7773 2069 6e20 610a 2020 2020 636f  rows in a.    co
-0003ffa0: 6e73 7420 696e 7420 6e72 203d 206e 6561  nst int nr = nea
-0003ffb0: 312a 6e65 6132 2a6e 6561 333b 0a0a 2020  1*nea2*nea3;..  
-0003ffc0: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
-0003ffd0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-0003ffe0: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
-0003fff0: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
-00040000: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
-00040010: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
-00040020: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
-00040030: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
-00040040: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
-00040050: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
-00040060: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-00040070: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
-00040080: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
-00040090: 2020 202f 2f20 6120 696e 6469 6365 730a     // a indices.
-000400a0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000400b0: 7420 6961 3320 3d20 6972 2f28 6e65 6132  t ia3 = ir/(nea2
-000400c0: 2a6e 6561 3129 3b0a 2020 2020 2020 2020  *nea1);.        
-000400d0: 636f 6e73 7420 696e 7420 6961 3220 3d20  const int ia2 = 
-000400e0: 2869 7220 2d20 6961 332a 6e65 6132 2a6e  (ir - ia3*nea2*n
-000400f0: 6561 3129 2f6e 6561 313b 0a20 2020 2020  ea1)/nea1;.     
-00040100: 2020 2063 6f6e 7374 2069 6e74 2069 6131     const int ia1
-00040110: 203d 2028 6972 202d 2069 6133 2a6e 6561   = (ir - ia3*nea
-00040120: 322a 6e65 6131 202d 2069 6132 2a6e 6561  2*nea1 - ia2*nea
-00040130: 3129 3b0a 0a20 2020 2020 2020 2066 6c6f  1);..        flo
-00040140: 6174 202a 2053 203d 2028 666c 6f61 7420  at * S = (float 
-00040150: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
-00040160: 202b 2069 7468 2a28 322a 4d20 2b20 4341   + ith*(2*M + CA
-00040170: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
-00040180: 3229 3b0a 0a20 2020 2020 2020 2066 6f72  2);..        for
-00040190: 2028 696e 7420 6963 203d 2030 3b20 6963   (int ic = 0; ic
-000401a0: 203c 206e 6562 3031 3b20 2b2b 6963 2920   < neb01; ++ic) 
-000401b0: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
-000401c0: 2062 3020 696e 6469 6365 730a 2020 2020   b0 indices.    
-000401d0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000401e0: 7420 6962 3033 203d 2069 6133 3b0a 2020  t ib03 = ia3;.  
-000401f0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00040200: 696e 7420 6962 3032 203d 2069 6132 3b0a  int ib02 = ia2;.
-00040210: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00040220: 7420 696e 7420 6962 3031 203d 2069 633b  t int ib01 = ic;
-00040230: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-00040240: 2053 2069 6e64 6963 6573 0a20 2020 2020   S indices.     
-00040250: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00040260: 2069 3120 3d20 6962 3031 3b0a 0a20 2020   i1 = ib01;..   
-00040270: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00040280: 635f 646f 745f 6631 3628 6e65 6130 2c0a  c_dot_f16(nea0,.
-00040290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000402a0: 2020 2020 5320 2b20 6931 2c0a 2020 2020      S + i1,.    
-000402b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000402c0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-000402d0: 2828 6368 6172 202a 2920 6230 2d3e 6461  ((char *) b0->da
-000402e0: 7461 202b 2028 6962 3031 2a6e 6262 3031  ta + (ib01*nbb01
-000402f0: 202b 2069 6230 322a 6e62 6230 3220 2b20   + ib02*nbb02 + 
-00040300: 6962 3033 2a6e 6262 3033 2929 2c0a 2020  ib03*nbb03)),.  
+0003ef80: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+0003ef90: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+0003efa0: 7478 2c20 7372 6330 2d3e 6772 6164 2c20  tx, src0->grad, 
+0003efb0: 7465 6e73 6f72 2d3e 6772 6164 2c20 696e  tensor->grad, in
+0003efc0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0003efd0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0003efe0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0003eff0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0003f000: 5f4f 505f 4144 443a 0a20 2020 2020 2020  _OP_ADD:.       
+0003f010: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0003f020: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+0003f030: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0003f040: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0003f050: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
+0003f060: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
+0003f070: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
+0003f080: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
+0003f090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f0a0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0003f0b0: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
+0003f0c0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0003f0d0: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
+0003f0e0: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+0003f0f0: 6d70 6c28 6374 782c 2073 7263 312d 3e67  mpl(ctx, src1->g
+0003f100: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+0003f110: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+0003f120: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0003f130: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0003f140: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0003f150: 2047 474d 4c5f 4f50 5f53 5542 3a0a 2020   GGML_OP_SUB:.  
+0003f160: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0003f170: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0003f180: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+0003f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f1a0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+0003f1b0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+0003f1c0: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
+0003f1d0: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
+0003f1e0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0003f1f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003f200: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+0003f210: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0003f220: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0003f230: 6331 2d3e 6772 6164 203d 2067 676d 6c5f  c1->grad = ggml_
+0003f240: 7375 625f 696d 706c 2863 7478 2c20 7372  sub_impl(ctx, sr
+0003f250: 6331 2d3e 6772 6164 2c20 7465 6e73 6f72  c1->grad, tensor
+0003f260: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
+0003f270: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003f280: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003f290: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0003f2a0: 2063 6173 6520 4747 4d4c 5f4f 505f 4d55   case GGML_OP_MU
+0003f2b0: 4c3a 0a20 2020 2020 2020 2020 2020 207b  L:.            {
+0003f2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f2d0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+0003f2e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003f2f0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0003f300: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+0003f310: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0003f320: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+0003f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f340: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003f350: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+0003f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f370: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003f380: 6d75 6c28 6374 782c 2073 7263 312c 2074  mul(ctx, src1, t
+0003f390: 656e 736f 722d 3e67 7261 6429 2c0a 2020  ensor->grad),.  
+0003f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3b0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0003f3c0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0003f3d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0003f3e0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0003f3f0: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
+0003f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f410: 7372 6331 2d3e 6772 6164 203d 0a20 2020  src1->grad =.   
+0003f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f430: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+0003f440: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0003f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f460: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+0003f470: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0003f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f490: 2020 2020 6767 6d6c 5f6d 756c 2863 7478      ggml_mul(ctx
+0003f4a0: 2c20 7372 6330 2c20 7465 6e73 6f72 2d3e  , src0, tensor->
+0003f4b0: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+0003f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f4d0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0003f4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f4f0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0003f500: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0003f510: 6361 7365 2047 474d 4c5f 4f50 5f44 4956  case GGML_OP_DIV
+0003f520: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0003f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f540: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0003f550: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003f560: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0003f570: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
+0003f580: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003f590: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
+0003f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f5b0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0003f5c0: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+0003f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f5e0: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
+0003f5f0: 6976 2863 7478 2c20 7465 6e73 6f72 2d3e  iv(ctx, tensor->
+0003f600: 6772 6164 2c20 7372 6331 292c 0a20 2020  grad, src1),.   
+0003f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f620: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+0003f630: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+0003f640: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0003f650: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0003f660: 312d 3e67 7261 6429 207b 0a20 2020 2020  1->grad) {.     
+0003f670: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003f680: 7263 312d 3e67 7261 6420 3d0a 2020 2020  rc1->grad =.    
+0003f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6a0: 2020 2020 6767 6d6c 5f73 7562 5f69 6d70      ggml_sub_imp
+0003f6b0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0003f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6d0: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+0003f6e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0003f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f700: 2020 2067 676d 6c5f 6d75 6c28 6374 782c     ggml_mul(ctx,
+0003f710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f730: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+0003f740: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0003f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f760: 2020 2020 2020 2067 676d 6c5f 6469 7628         ggml_div(
+0003f770: 6374 782c 2074 656e 736f 722c 2073 7263  ctx, tensor, src
+0003f780: 3129 292c 0a20 2020 2020 2020 2020 2020  1)),.           
+0003f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f7a0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+0003f7b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0003f7c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0003f7d0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0003f7e0: 7365 2047 474d 4c5f 4f50 5f53 5152 3a0a  se GGML_OP_SQR:.
+0003f7f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0003f800: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003f810: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
+0003f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f830: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+0003f840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f850: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+0003f860: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+0003f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f880: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0003f890: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0003f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f8b0: 2020 2020 2020 2020 6767 6d6c 5f6d 756c          ggml_mul
+0003f8c0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+0003f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f8e0: 2020 2020 2020 2020 2020 6767 6d6c 5f6d            ggml_m
+0003f8f0: 756c 2863 7478 2c20 7372 6330 2c20 7465  ul(ctx, src0, te
+0003f900: 6e73 6f72 2d3e 6772 6164 292c 0a20 2020  nsor->grad),.   
+0003f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f930: 2067 676d 6c5f 7265 7065 6174 2863 7478   ggml_repeat(ctx
+0003f940: 2c20 6767 6d6c 5f6e 6577 5f66 3332 2863  , ggml_new_f32(c
+0003f950: 7478 2c20 322e 3066 292c 2073 7263 3029  tx, 2.0f), src0)
+0003f960: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0003f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f980: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+0003f990: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0003f9a0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0003f9b0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0003f9c0: 2047 474d 4c5f 4f50 5f53 5152 543a 0a20   GGML_OP_SQRT:. 
+0003f9d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003f9e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003f9f0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0003fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fa10: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
+0003fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fa30: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0003fa40: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+0003fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fa60: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0003fa70: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0003fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fa90: 2020 2020 2020 2067 676d 6c5f 6469 7628         ggml_div(
+0003faa0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0003fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fac0: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
+0003fad0: 7065 6174 2863 7478 2c20 6767 6d6c 5f6e  peat(ctx, ggml_n
+0003fae0: 6577 5f66 3332 2863 7478 2c20 302e 3566  ew_f32(ctx, 0.5f
+0003faf0: 292c 2074 656e 736f 7229 2c0a 2020 2020  ), tensor),.    
+0003fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fb20: 7465 6e73 6f72 292c 0a20 2020 2020 2020  tensor),.       
+0003fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fb40: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+0003fb50: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0003fb60: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0003fb70: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0003fb80: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+0003fb90: 554d 3a0a 2020 2020 2020 2020 2020 2020  UM:.            
+0003fba0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003fbb0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0003fbc0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0003fbd0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0003fbe0: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+0003fbf0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003fc00: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+0003fc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fc30: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+0003fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fc50: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0003fc60: 5f72 6570 6561 7428 6374 782c 2074 656e  _repeat(ctx, ten
+0003fc70: 736f 722d 3e67 7261 642c 2073 7263 302d  sor->grad, src0-
+0003fc80: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+0003fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fca0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0003fcb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003fcc0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003fcd0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0003fce0: 2063 6173 6520 4747 4d4c 5f4f 505f 4d45   case GGML_OP_ME
+0003fcf0: 414e 3a0a 2020 2020 2020 2020 2020 2020  AN:.            
+0003fd00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003fd10: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0003fd20: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 2069  lse); // TODO: i
+0003fd30: 6d70 6c65 6d65 6e74 0a20 2020 2020 2020  mplement.       
+0003fd40: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0003fd50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0003fd60: 4f50 5f52 4550 4541 543a 0a20 2020 2020  OP_REPEAT:.     
+0003fd70: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0003fd80: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0003fd90: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0003fda0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003fdb0: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0003fdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fdd0: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0003fde0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0003fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe00: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0003fe10: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0003fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe30: 2020 2067 676d 6c5f 7375 6d28 6374 782c     ggml_sum(ctx,
+0003fe40: 2074 656e 736f 722d 3e67 7261 6429 2c0a   tensor->grad),.
+0003fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe70: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+0003fe80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0003fe90: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0003fea0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0003feb0: 4d4c 5f4f 505f 4142 533a 0a20 2020 2020  ML_OP_ABS:.     
+0003fec0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0003fed0: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0003fee0: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0003fef0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003ff00: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0003ff10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ff20: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0003ff30: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0003ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ff50: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0003ff60: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0003ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ff80: 2020 2067 676d 6c5f 6d75 6c28 6374 782c     ggml_mul(ctx,
+0003ff90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ffb0: 2020 2020 2067 676d 6c5f 7367 6e28 6374       ggml_sgn(ct
+0003ffc0: 782c 2073 7263 3029 2c0a 2020 2020 2020  x, src0),.      
+0003ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ffe0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0003fff0: 6e73 6f72 2d3e 6772 6164 292c 0a20 2020  nsor->grad),.   
+00040000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040010: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00040020: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00040030: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00040040: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00040050: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00040060: 4f50 5f53 474e 3a0a 2020 2020 2020 2020  OP_SGN:.        
+00040070: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00040080: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00040090: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+000400a0: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+000400b0: 6f6f 700a 2020 2020 2020 2020 2020 2020  oop.            
+000400c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000400d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000400e0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+000400f0: 4e45 473a 0a20 2020 2020 2020 2020 2020  NEG:.           
+00040100: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00040110: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+00040120: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00040130: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+00040140: 7261 6420 3d20 6767 6d6c 5f73 7562 5f69  rad = ggml_sub_i
+00040150: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
+00040160: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+00040170: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+00040180: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00040190: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000401a0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000401b0: 2047 474d 4c5f 4f50 5f53 5445 503a 0a20   GGML_OP_STEP:. 
+000401c0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000401d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000401e0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+000401f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040200: 2020 202f 2f20 6e6f 6f70 0a20 2020 2020     // noop.     
+00040210: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00040220: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00040230: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00040240: 474d 4c5f 4f50 5f52 454c 553a 0a20 2020  GML_OP_RELU:.   
+00040250: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00040260: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+00040270: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+00040280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040290: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
+000402a0: 6d6c 5f73 7562 5f69 6d70 6c28 6374 782c  ml_sub_impl(ctx,
+000402b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000402c0: 2020 2020 2020 2020 2020 2020 2073 7263               src
+000402d0: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
+000402e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000402f0: 2020 2020 2067 676d 6c5f 6d75 6c28 6374       ggml_mul(ct
+00040300: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
 00040310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040320: 2020 2867 676d 6c5f 6670 3136 5f74 202a    (ggml_fp16_t *
-00040330: 2920 2828 6368 6172 202a 2920 2061 2d3e  ) ((char *)  a->
-00040340: 6461 7461 202b 2028 2069 6131 2a6e 6261  data + ( ia1*nba
-00040350: 3120 202b 2020 6961 322a 6e62 6132 2020  1  +  ia2*nba2  
-00040360: 2b20 2069 6133 2a6e 6261 3329 2929 3b0a  +  ia3*nba3)));.
-00040370: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00040380: 2020 2067 676d 6c5f 7665 635f 6164 645f     ggml_vec_add_
-00040390: 6633 3228 6e65 6230 312c 2053 2c20 532c  f32(neb01, S, S,
-000403a0: 2028 666c 6f61 7420 2a29 2062 312d 3e64   (float *) b1->d
-000403b0: 6174 6129 3b0a 2020 2020 2020 2020 2f2f  ata);.        //
-000403c0: 6767 6d6c 5f76 6563 5f67 656c 755f 6633  ggml_vec_gelu_f3
-000403d0: 3228 6e65 6230 312c 2053 2c20 5329 3b0a  2(neb01, S, S);.
-000403e0: 0a20 2020 2020 2020 2067 676d 6c5f 6670  .        ggml_fp
-000403f0: 3136 5f74 202a 2053 3136 203d 2028 6767  16_t * S16 = (gg
-00040400: 6d6c 5f66 7031 365f 7420 2a29 2028 2866  ml_fp16_t *) ((f
-00040410: 6c6f 6174 202a 2920 7061 7261 6d73 2d3e  loat *) params->
-00040420: 7764 6174 6120 2b20 6974 682a 2832 2a4d  wdata + ith*(2*M
-00040430: 202b 2043 4143 4845 5f4c 494e 455f 5349   + CACHE_LINE_SI
-00040440: 5a45 5f46 3332 2920 2b20 4d29 3b0a 0a20  ZE_F32) + M);.. 
-00040450: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00040460: 6920 3d20 303b 2069 203c 204d 3b20 692b  i = 0; i < M; i+
-00040470: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00040480: 2053 3136 5b69 5d20 3d20 4747 4d4c 5f46   S16[i] = GGML_F
-00040490: 5033 325f 544f 5f46 5031 3628 535b 695d  P32_TO_FP16(S[i]
-000404a0: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
-000404b0: 2020 2020 2020 6767 6d6c 5f76 6563 5f67        ggml_vec_g
-000404c0: 656c 755f 6631 3628 6e65 6230 312c 2053  elu_f16(neb01, S
-000404d0: 3136 2c20 5331 3629 3b0a 0a20 2020 2020  16, S16);..     
-000404e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000404f0: 202f 2f20 6473 7420 696e 6469 6365 730a   // dst indices.
-00040500: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00040510: 7420 696e 7420 6931 203d 2069 6131 3b0a  t int i1 = ia1;.
-00040520: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00040530: 7420 696e 7420 6932 203d 2069 6132 3b0a  t int i2 = ia2;.
-00040540: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00040550: 7420 696e 7420 6933 203d 2069 6133 3b0a  t int i3 = ia3;.
-00040560: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00040570: 2028 696e 7420 6963 203d 2030 3b20 6963   (int ic = 0; ic
-00040580: 203c 206e 6563 3031 3b20 2b2b 6963 2920   < nec01; ++ic) 
-00040590: 7b0a 0a20 2020 2020 2020 2020 2020 2020  {..             
-000405a0: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
-000405b0: 6631 3628 6e65 6230 312c 0a20 2020 2020  f16(neb01,.     
-000405c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000405d0: 2020 2028 666c 6f61 7420 2a29 2020 2020     (float *)    
-000405e0: 2020 2028 2863 6861 7220 2a29 2064 7374     ((char *) dst
-000405f0: 2d3e 6461 7461 202b 2028 6963 2a6e 6230  ->data + (ic*nb0
-00040600: 202b 2069 312a 6e62 3120 2020 2b20 6932   + i1*nb1   + i2
-00040610: 2a6e 6232 2020 202b 2069 332a 6e62 3329  *nb2   + i3*nb3)
-00040620: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00040630: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
-00040640: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-00040650: 7220 2a29 2063 302d 3e64 6174 6120 202b  r *) c0->data  +
-00040660: 2028 2020 2020 2020 2020 2069 632a 6e62   (         ic*nb
-00040670: 6330 3120 2b20 6932 2a6e 6263 3032 202b  c01 + i2*nbc02 +
-00040680: 2069 332a 6e62 6330 3329 292c 0a20 2020   i3*nbc03)),.   
+00040320: 2020 2067 676d 6c5f 7374 6570 2863 7478     ggml_step(ctx
+00040330: 2c20 7372 6330 292c 0a20 2020 2020 2020  , src0),.       
+00040340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040350: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00040360: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+00040370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040380: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00040390: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000403a0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000403b0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000403c0: 6520 4747 4d4c 5f4f 505f 4745 4c55 3a0a  e GGML_OP_GELU:.
+000403d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000403e0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+000403f0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00040400: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
+00040410: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+00040420: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00040430: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00040440: 4c5f 4f50 5f53 494c 553a 0a20 2020 2020  L_OP_SILU:.     
+00040450: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00040460: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00040470: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+00040480: 544f 444f 3a20 6e6f 7420 696d 706c 656d  TODO: not implem
+00040490: 656e 7465 640a 2020 2020 2020 2020 2020  ented.          
+000404a0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000404b0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+000404c0: 4e4f 524d 3a0a 2020 2020 2020 2020 2020  NORM:.          
+000404d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000404e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000404f0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
+00040500: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+00040510: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00040520: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00040530: 7365 2047 474d 4c5f 4f50 5f52 4d53 5f4e  se GGML_OP_RMS_N
+00040540: 4f52 4d3a 0a20 2020 2020 2020 2020 2020  ORM:.           
+00040550: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00040560: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00040570: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00040580: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+00040590: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000405a0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000405b0: 6520 4747 4d4c 5f4f 505f 4d55 4c5f 4d41  e GGML_OP_MUL_MA
+000405c0: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+000405d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000405e0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+000405f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00040600: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
+00040610: 7468 6973 2072 6571 7569 7265 7320 6f75  this requires ou
+00040620: 7465 7220 7072 6f64 7563 7420 2d20 6767  ter product - gg
+00040630: 6d6c 5f6f 7574 5f70 726f 6428 6374 782c  ml_out_prod(ctx,
+00040640: 2073 7263 312c 2074 656e 736f 722d 3e67   src1, tensor->g
+00040650: 7261 6429 3b0a 2020 2020 2020 2020 2020  rad);.          
+00040660: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00040670: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00040680: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
 00040690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000406a0: 2020 2020 2053 3136 293b 0a20 2020 2020       S16);.     
-000406b0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-000406c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
-000406d0: 6464 5f66 3332 286e 6563 3031 2c0a 2020  dd_f32(nec01,.  
-000406e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000406f0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00040700: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-00040710: 2b20 2869 312a 6e62 3120 2b20 6932 2a6e  + (i1*nb1 + i2*n
-00040720: 6232 202b 2069 332a 6e62 3329 292c 0a20  b2 + i3*nb3)),. 
+000406a0: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+000406b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000406c0: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
+000406d0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
+000406e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000406f0: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
+00040700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040710: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00040720: 6331 2d3e 6772 6164 2c0a 2020 2020 2020  c1->grad,.      
 00040730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040740: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-00040750: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-00040760: 202b 2028 6931 2a6e 6231 202b 2069 322a   + (i1*nb1 + i2*
-00040770: 6e62 3220 2b20 6933 2a6e 6233 2929 2c0a  nb2 + i3*nb3)),.
-00040780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040790: 2020 2020 2866 6c6f 6174 202a 2920 6331      (float *) c1
-000407a0: 2d3e 6461 7461 293b 0a20 2020 2020 2020  ->data);.       
-000407b0: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
-000407c0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-000407d0: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
-000407e0: 7368 5f66 6628 0a20 2020 2020 2020 2063  sh_ff(.        c
-000407f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00040800: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00040810: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00040820: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00040830: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-00040840: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00040850: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00040860: 202a 2062 302c 0a20 2020 2020 2020 2063   * b0,.        c
-00040870: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00040880: 5f74 656e 736f 7220 2a20 6231 2c0a 2020  _tensor * b1,.  
-00040890: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000408a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000408b0: 2063 302c 0a20 2020 2020 2020 2063 6f6e   c0,.        con
-000408c0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000408d0: 656e 736f 7220 2a20 6331 2c0a 2020 2020  ensor * c1,.    
-000408e0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000408f0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00040900: 2020 2020 7377 6974 6368 2028 6230 2d3e      switch (b0->
-00040910: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00040920: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00040930: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
-00040940: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00040950: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00040960: 6f72 7761 7264 5f66 6c61 7368 5f66 665f  orward_flash_ff_
-00040970: 6631 3628 7061 7261 6d73 2c20 612c 2062  f16(params, a, b
-00040980: 302c 2062 312c 2063 302c 2063 312c 2064  0, b1, c0, c1, d
-00040990: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-000409a0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000409b0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000409c0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-000409d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000409e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000409f0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f0a  false); // TODO.
-00040a00: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00040a10: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00040a20: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
-00040a30: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00040a40: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
-00040a50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00040a60: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
-00040a70: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00040a80: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
-00040a90: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
-00040aa0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00040ab0: 474d 4c5f 5459 5045 5f43 4f55 4e54 3a0a  GML_TYPE_COUNT:.
-00040ac0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00040ad0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00040ae0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00040af0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00040b00: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00040b10: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00040b20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00040b30: 2f0a 0a73 7461 7469 6320 766f 6964 2067  /..static void g
-00040b40: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00040b50: 6172 6428 7374 7275 6374 2067 676d 6c5f  ard(struct ggml_
-00040b60: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00040b70: 2070 6172 616d 732c 2073 7472 7563 7420   params, struct 
-00040b80: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-00040b90: 6e73 6f72 2920 7b0a 2020 2020 4747 4d4c  nsor) {.    GGML
-00040ba0: 5f41 5353 4552 5428 7061 7261 6d73 293b  _ASSERT(params);
-00040bb0: 0a0a 2020 2020 7377 6974 6368 2028 7465  ..    switch (te
-00040bc0: 6e73 6f72 2d3e 6f70 2920 7b0a 2020 2020  nsor->op) {.    
-00040bd0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00040be0: 5f44 5550 3a0a 2020 2020 2020 2020 2020  _DUP:.          
-00040bf0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00040c00: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00040c10: 5f66 6f72 7761 7264 5f64 7570 2870 6172  _forward_dup(par
-00040c20: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00040c30: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-00040c40: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00040c50: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00040c60: 4d4c 5f4f 505f 4144 443a 0a20 2020 2020  ML_OP_ADD:.     
-00040c70: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00040c80: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00040c90: 6d70 7574 655f 666f 7277 6172 645f 6164  mpute_forward_ad
-00040ca0: 6428 7061 7261 6d73 2c20 7465 6e73 6f72  d(params, tensor
-00040cb0: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
-00040cc0: 7372 6331 2c20 7465 6e73 6f72 293b 0a20  src1, tensor);. 
-00040cd0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00040ce0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00040cf0: 2047 474d 4c5f 4f50 5f53 5542 3a0a 2020   GGML_OP_SUB:.  
-00040d00: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00040d10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00040d20: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00040d30: 5f73 7562 2870 6172 616d 732c 2074 656e  _sub(params, ten
-00040d40: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00040d50: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-00040d60: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00040d70: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00040d80: 6173 6520 4747 4d4c 5f4f 505f 4d55 4c3a  ase GGML_OP_MUL:
-00040d90: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00040da0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00040db0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00040dc0: 6172 645f 6d75 6c28 7061 7261 6d73 2c20  ard_mul(params, 
-00040dd0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00040de0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-00040df0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00040e00: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00040e10: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-00040e20: 4956 3a0a 2020 2020 2020 2020 2020 2020  IV:.            
-00040e30: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00040e40: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00040e50: 6f72 7761 7264 5f64 6976 2870 6172 616d  orward_div(param
-00040e60: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00040e70: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
-00040e80: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00040e90: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00040ea0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00040eb0: 505f 5351 523a 0a20 2020 2020 2020 2020  P_SQR:.         
-00040ec0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00040ed0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00040ee0: 655f 666f 7277 6172 645f 7371 7228 7061  e_forward_sqr(pa
-00040ef0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00040f00: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
-00040f10: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00040f20: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00040f30: 474d 4c5f 4f50 5f53 5152 543a 0a20 2020  GML_OP_SQRT:.   
-00040f40: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00040f50: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00040f60: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00040f70: 7371 7274 2870 6172 616d 732c 2074 656e  sqrt(params, ten
-00040f80: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00040f90: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00040fa0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00040fb0: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
-00040fc0: 4d3a 0a20 2020 2020 2020 2020 2020 207b  M:.            {
-00040fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040fe0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00040ff0: 7277 6172 645f 7375 6d28 7061 7261 6d73  rward_sum(params
-00041000: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00041010: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00041020: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00041030: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00041040: 4f50 5f4d 4541 4e3a 0a20 2020 2020 2020  OP_MEAN:.       
-00041050: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00041060: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00041070: 7574 655f 666f 7277 6172 645f 6d65 616e  ute_forward_mean
-00041080: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00041090: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-000410a0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000410b0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000410c0: 6520 4747 4d4c 5f4f 505f 5245 5045 4154  e GGML_OP_REPEAT
-000410d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000410e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000410f0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00041100: 7761 7264 5f72 6570 6561 7428 7061 7261  ward_repeat(para
-00041110: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00041120: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00041130: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00041140: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00041150: 4c5f 4f50 5f41 4253 3a0a 2020 2020 2020  L_OP_ABS:.      
-00041160: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00041170: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00041180: 7075 7465 5f66 6f72 7761 7264 5f61 6273  pute_forward_abs
-00041190: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-000411a0: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-000411b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000411c0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000411d0: 6520 4747 4d4c 5f4f 505f 5347 4e3a 0a20  e GGML_OP_SGN:. 
-000411e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000411f0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00041200: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00041210: 645f 7367 6e28 7061 7261 6d73 2c20 7465  d_sgn(params, te
-00041220: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-00041230: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00041240: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00041250: 2020 6361 7365 2047 474d 4c5f 4f50 5f4e    case GGML_OP_N
-00041260: 4547 3a0a 2020 2020 2020 2020 2020 2020  EG:.            
-00041270: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00041280: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00041290: 6f72 7761 7264 5f6e 6567 2870 6172 616d  orward_neg(param
-000412a0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-000412b0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-000412c0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000412d0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000412e0: 5f4f 505f 5354 4550 3a0a 2020 2020 2020  _OP_STEP:.      
-000412f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00041300: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00041310: 7075 7465 5f66 6f72 7761 7264 5f73 7465  pute_forward_ste
-00041320: 7028 7061 7261 6d73 2c20 7465 6e73 6f72  p(params, tensor
-00041330: 2d3e 7372 6330 2c20 7465 6e73 6f72 293b  ->src0, tensor);
-00041340: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00041350: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00041360: 7365 2047 474d 4c5f 4f50 5f52 454c 553a  se GGML_OP_RELU:
-00041370: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00041380: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00041390: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000413a0: 6172 645f 7265 6c75 2870 6172 616d 732c  ard_relu(params,
-000413b0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-000413c0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-000413d0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000413e0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000413f0: 505f 4745 4c55 3a0a 2020 2020 2020 2020  P_GELU:.        
-00041400: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00041410: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00041420: 7465 5f66 6f72 7761 7264 5f67 656c 7528  te_forward_gelu(
-00041430: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00041440: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00041450: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00041460: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00041470: 2047 474d 4c5f 4f50 5f53 494c 553a 0a20   GGML_OP_SILU:. 
-00041480: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00041490: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000414a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000414b0: 645f 7369 6c75 2870 6172 616d 732c 2074  d_silu(params, t
-000414c0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-000414d0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-000414e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000414f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00041500: 4e4f 524d 3a0a 2020 2020 2020 2020 2020  NORM:.          
-00041510: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00041520: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00041530: 5f66 6f72 7761 7264 5f6e 6f72 6d28 7061  _forward_norm(pa
-00041540: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00041550: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
-00041560: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00041570: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00041580: 474d 4c5f 4f50 5f52 4d53 5f4e 4f52 4d3a  GML_OP_RMS_NORM:
-00041590: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000415a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000415b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000415c0: 6172 645f 726d 735f 6e6f 726d 2870 6172  ard_rms_norm(par
-000415d0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-000415e0: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-000415f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00041600: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00041610: 4d4c 5f4f 505f 4d55 4c5f 4d41 543a 0a20  ML_OP_MUL_MAT:. 
-00041620: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00041630: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00041640: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00041650: 645f 6d75 6c5f 6d61 7428 7061 7261 6d73  d_mul_mat(params
-00041660: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00041670: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-00041680: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00041690: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000416a0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000416b0: 5f53 4341 4c45 3a0a 2020 2020 2020 2020  _SCALE:.        
-000416c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000416d0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-000416e0: 7465 5f66 6f72 7761 7264 5f73 6361 6c65  te_forward_scale
-000416f0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00041700: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
-00041710: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
-00041720: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00041730: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00041740: 4747 4d4c 5f4f 505f 4350 593a 0a20 2020  GGML_OP_CPY:.   
-00041750: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00041760: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00041770: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00041780: 6370 7928 7061 7261 6d73 2c20 7465 6e73  cpy(params, tens
-00041790: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-000417a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000417b0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000417c0: 6361 7365 2047 474d 4c5f 4f50 5f52 4553  case GGML_OP_RES
-000417d0: 4841 5045 3a0a 2020 2020 2020 2020 2020  HAPE:.          
-000417e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000417f0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00041800: 5f66 6f72 7761 7264 5f72 6573 6861 7065  _forward_reshape
-00041810: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00041820: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-00041830: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00041840: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00041850: 6520 4747 4d4c 5f4f 505f 5649 4557 3a0a  e GGML_OP_VIEW:.
-00041860: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00041870: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00041880: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00041890: 7264 5f76 6965 7728 7061 7261 6d73 2c20  rd_view(params, 
-000418a0: 7465 6e73 6f72 2d3e 7372 6330 293b 0a20  tensor->src0);. 
-000418b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000418c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-000418d0: 2047 474d 4c5f 4f50 5f50 4552 4d55 5445   GGML_OP_PERMUTE
-000418e0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000418f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041900: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00041910: 7761 7264 5f70 6572 6d75 7465 2870 6172  ward_permute(par
-00041920: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00041930: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-00041940: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00041950: 2063 6173 6520 4747 4d4c 5f4f 505f 5452   case GGML_OP_TR
-00041960: 414e 5350 4f53 453a 0a20 2020 2020 2020  ANSPOSE:.       
-00041970: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00041980: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00041990: 7574 655f 666f 7277 6172 645f 7472 616e  ute_forward_tran
-000419a0: 7370 6f73 6528 7061 7261 6d73 2c20 7465  spose(params, te
-000419b0: 6e73 6f72 2d3e 7372 6330 293b 0a20 2020  nsor->src0);.   
-000419c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000419d0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000419e0: 474d 4c5f 4f50 5f47 4554 5f52 4f57 533a  GML_OP_GET_ROWS:
-000419f0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00041a00: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00041a10: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00041a20: 6172 645f 6765 745f 726f 7773 2870 6172  ard_get_rows(par
-00041a30: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00041a40: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
-00041a50: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00041a60: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00041a70: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00041a80: 5f4f 505f 4449 4147 5f4d 4153 4b5f 494e  _OP_DIAG_MASK_IN
-00041a90: 463a 0a20 2020 2020 2020 2020 2020 207b  F:.            {
-00041aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041ab0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00041ac0: 7277 6172 645f 6469 6167 5f6d 6173 6b5f  rward_diag_mask_
-00041ad0: 696e 6628 7061 7261 6d73 2c20 7465 6e73  inf(params, tens
-00041ae0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00041af0: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
-00041b00: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00041b10: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00041b20: 7365 2047 474d 4c5f 4f50 5f53 4f46 545f  se GGML_OP_SOFT_
-00041b30: 4d41 583a 0a20 2020 2020 2020 2020 2020  MAX:.           
-00041b40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00041b50: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00041b60: 666f 7277 6172 645f 736f 6674 5f6d 6178  forward_soft_max
-00041b70: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00041b80: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-00041b90: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00041ba0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00041bb0: 6520 4747 4d4c 5f4f 505f 524f 5045 3a0a  e GGML_OP_ROPE:.
-00041bc0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00041bd0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00041be0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00041bf0: 7264 5f72 6f70 6528 7061 7261 6d73 2c20  rd_rope(params, 
-00041c00: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00041c10: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-00041c20: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00041c30: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00041c40: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-00041c50: 4f4e 565f 3144 5f31 533a 0a20 2020 2020  ONV_1D_1S:.     
-00041c60: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00041c70: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00041c80: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
-00041c90: 6e76 5f31 645f 3173 2870 6172 616d 732c  nv_1d_1s(params,
-00041ca0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00041cb0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
-00041cc0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00041cd0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00041ce0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00041cf0: 434f 4e56 5f31 445f 3253 3a0a 2020 2020  CONV_1D_2S:.    
-00041d00: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00041d10: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00041d20: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00041d30: 6f6e 765f 3164 5f32 7328 7061 7261 6d73  onv_1d_2s(params
-00041d40: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00041d50: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-00041d60: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00041d70: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00041d80: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00041d90: 5f46 4c41 5348 5f41 5454 4e3a 0a20 2020  _FLASH_ATTN:.   
-00041da0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00041db0: 2020 2020 2020 2020 2020 2069 6e74 3332             int32
-00041dc0: 5f74 2074 203d 2067 676d 6c5f 6765 745f  _t t = ggml_get_
-00041dd0: 6933 325f 3164 2874 656e 736f 722d 3e6f  i32_1d(tensor->o
-00041de0: 7074 5b31 5d2c 2030 293b 0a20 2020 2020  pt[1], 0);.     
-00041df0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00041e00: 4153 5345 5254 2874 203d 3d20 3020 7c7c  ASSERT(t == 0 ||
-00041e10: 2074 203d 3d20 3129 3b0a 2020 2020 2020   t == 1);.      
-00041e20: 2020 2020 2020 2020 2020 626f 6f6c 206d            bool m
-00041e30: 6173 6b65 6420 3d20 7420 213d 2030 3b0a  asked = t != 0;.
-00041e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041e50: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00041e60: 7761 7264 5f66 6c61 7368 5f61 7474 6e28  ward_flash_attn(
-00041e70: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00041e80: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
-00041e90: 6331 2c20 7465 6e73 6f72 2d3e 6f70 745b  c1, tensor->opt[
-00041ea0: 305d 2c20 6d61 736b 6564 2c20 7465 6e73  0], masked, tens
-00041eb0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00041ec0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00041ed0: 2020 6361 7365 2047 474d 4c5f 4f50 5f46    case GGML_OP_F
-00041ee0: 4c41 5348 5f46 463a 0a20 2020 2020 2020  LASH_FF:.       
-00041ef0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00041f00: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00041f10: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
-00041f20: 685f 6666 2870 6172 616d 732c 2074 656e  h_ff(params, ten
-00041f30: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00041f40: 722d 3e73 7263 312c 2074 656e 736f 722d  r->src1, tensor-
-00041f50: 3e6f 7074 5b30 5d2c 2074 656e 736f 722d  >opt[0], tensor-
-00041f60: 3e6f 7074 5b31 5d2c 2074 656e 736f 722d  >opt[1], tensor-
-00041f70: 3e6f 7074 5b32 5d2c 2074 656e 736f 7229  >opt[2], tensor)
-00041f80: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00041f90: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00041fa0: 6173 6520 4747 4d4c 5f4f 505f 4e4f 4e45  ase GGML_OP_NONE
-00041fb0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00041fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041fd0: 2f2f 206e 6f70 0a20 2020 2020 2020 2020  // nop.         
-00041fe0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00041ff0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00042000: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
-00042010: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00042020: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00042030: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00042040: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00042050: 2020 207d 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f     }.}..////////
-00042060: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00042070: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00042080: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00042090: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000420a0: 2f2f 2f2f 2f2f 2f2f 0a0a 7374 6174 6963  ////////..static
-000420b0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000420c0: 7465 5f62 6163 6b77 6172 6428 7374 7275  te_backward(stru
-000420d0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-000420e0: 2a20 6374 782c 2073 7472 7563 7420 6767  * ctx, struct gg
-000420f0: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-00042100: 6f72 2c20 626f 6f6c 2069 6e70 6c61 6365  or, bool inplace
-00042110: 2920 7b0a 2020 2020 7374 7275 6374 2067  ) {.    struct g
-00042120: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00042130: 3020 3d20 7465 6e73 6f72 2d3e 7372 6330  0 = tensor->src0
-00042140: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
-00042150: 6c5f 7465 6e73 6f72 202a 2073 7263 3120  l_tensor * src1 
-00042160: 3d20 7465 6e73 6f72 2d3e 7372 6331 3b0a  = tensor->src1;.
-00042170: 0a20 2020 2073 7769 7463 6820 2874 656e  .    switch (ten
-00042180: 736f 722d 3e6f 7029 207b 0a20 2020 2020  sor->op) {.     
-00042190: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000421a0: 4455 503a 0a20 2020 2020 2020 2020 2020  DUP:.           
-000421b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000421c0: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-000421d0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-000421e0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-000421f0: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
-00042200: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-00042210: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
-00042220: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
-00042230: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00042240: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00042250: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00042260: 2047 474d 4c5f 4f50 5f41 4444 3a0a 2020   GGML_OP_ADD:.  
-00042270: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00042280: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00042290: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-000422a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000422b0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
-000422c0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-000422d0: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
-000422e0: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
-000422f0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
-00042300: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00042310: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
-00042320: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-00042330: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00042340: 6331 2d3e 6772 6164 203d 2067 676d 6c5f  c1->grad = ggml_
-00042350: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
-00042360: 6331 2d3e 6772 6164 2c20 7465 6e73 6f72  c1->grad, tensor
-00042370: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
-00042380: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00042390: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000423a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000423b0: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
-000423c0: 423a 0a20 2020 2020 2020 2020 2020 207b  B:.            {
-000423d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000423e0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-000423f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00042400: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-00042410: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
-00042420: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
-00042430: 642c 2074 656e 736f 722d 3e67 7261 642c  d, tensor->grad,
-00042440: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-00042450: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00042460: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00042470: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
-00042480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042490: 2020 2073 7263 312d 3e67 7261 6420 3d20     src1->grad = 
-000424a0: 6767 6d6c 5f73 7562 5f69 6d70 6c28 6374  ggml_sub_impl(ct
-000424b0: 782c 2073 7263 312d 3e67 7261 642c 2074  x, src1->grad, t
-000424c0: 656e 736f 722d 3e67 7261 642c 2069 6e70  ensor->grad, inp
-000424d0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-000424e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000424f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00042500: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00042510: 4f50 5f4d 554c 3a0a 2020 2020 2020 2020  OP_MUL:.        
-00042520: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00042530: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-00042540: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-00042550: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-00042560: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
-00042570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042580: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-00042590: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-000425a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000425b0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-000425c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000425d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000425e0: 6767 6d6c 5f6d 756c 2863 7478 2c20 7372  ggml_mul(ctx, sr
-000425f0: 6331 2c20 7465 6e73 6f72 2d3e 6772 6164  c1, tensor->grad
-00042600: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00042610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042620: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-00042630: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00042640: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00042650: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
-00042660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042670: 2020 2020 2073 7263 312d 3e67 7261 6420       src1->grad 
-00042680: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-00042690: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
-000426a0: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
-000426b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000426c0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-000426d0: 312d 3e67 7261 642c 0a20 2020 2020 2020  1->grad,.       
-000426e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000426f0: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
-00042700: 6c28 6374 782c 2073 7263 302c 2074 656e  l(ctx, src0, ten
-00042710: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
-00042720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042730: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
-00042740: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
-00042750: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00042760: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00042770: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00042780: 505f 4449 563a 0a20 2020 2020 2020 2020  P_DIV:.         
-00042790: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000427a0: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
-000427b0: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-000427c0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-000427d0: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
-000427e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000427f0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-00042800: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00042810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042820: 2020 2073 7263 302d 3e67 7261 642c 0a20     src0->grad,. 
-00042830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042840: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00042850: 676d 6c5f 6469 7628 6374 782c 2074 656e  gml_div(ctx, ten
-00042860: 736f 722d 3e67 7261 642c 2073 7263 3129  sor->grad, src1)
-00042870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00042880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042890: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-000428a0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000428b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000428c0: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
-000428d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000428e0: 2020 2020 7372 6331 2d3e 6772 6164 203d      src1->grad =
-000428f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042900: 2020 2020 2020 2020 2067 676d 6c5f 7375           ggml_su
-00042910: 625f 696d 706c 2863 7478 2c0a 2020 2020  b_impl(ctx,.    
-00042920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042930: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-00042940: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-00042950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042960: 2020 2020 2020 2020 6767 6d6c 5f6d 756c          ggml_mul
-00042970: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-00042980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042990: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-000429a0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-000429b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000429c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000429d0: 5f64 6976 2863 7478 2c20 7465 6e73 6f72  _div(ctx, tensor
-000429e0: 2c20 7372 6331 2929 2c0a 2020 2020 2020  , src1)),.      
-000429f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042a00: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-00042a10: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00042a20: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00042a30: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00042a40: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00042a50: 5351 523a 0a20 2020 2020 2020 2020 2020  SQR:.           
-00042a60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00042a70: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-00042a80: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-00042a90: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-00042aa0: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
-00042ab0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00042ac0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-00042ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042af0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-00042b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042b10: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00042b20: 6c5f 6d75 6c28 6374 782c 0a20 2020 2020  l_mul(ctx,.     
-00042b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042b40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00042b50: 676d 6c5f 6d75 6c28 6374 782c 2073 7263  gml_mul(ctx, src
-00042b60: 302c 2074 656e 736f 722d 3e67 7261 6429  0, tensor->grad)
-00042b70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00042b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042b90: 2020 2020 2020 6767 6d6c 5f72 6570 6561        ggml_repea
-00042ba0: 7428 6374 782c 2067 676d 6c5f 6e65 775f  t(ctx, ggml_new_
-00042bb0: 6633 3228 6374 782c 2032 2e30 6629 2c20  f32(ctx, 2.0f), 
-00042bc0: 7372 6330 2929 2c0a 2020 2020 2020 2020  src0)),.        
-00042bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042be0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-00042bf0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00042c00: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00042c10: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00042c20: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
-00042c30: 5254 3a0a 2020 2020 2020 2020 2020 2020  RT:.            
-00042c40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00042c50: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00042c60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00042c70: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00042c80: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
-00042c90: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00042ca0: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-00042cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042cd0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
-00042ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042cf0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00042d00: 5f64 6976 2863 7478 2c0a 2020 2020 2020  _div(ctx,.      
-00042d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042d20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00042d30: 6d6c 5f72 6570 6561 7428 6374 782c 2067  ml_repeat(ctx, g
-00042d40: 676d 6c5f 6e65 775f 6633 3228 6374 782c  gml_new_f32(ctx,
-00042d50: 2030 2e35 6629 2c20 7465 6e73 6f72 292c   0.5f), tensor),
-00042d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042d80: 2020 2020 2074 656e 736f 7229 2c0a 2020       tensor),.  
-00042d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042da0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00042db0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-00042dc0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00042dd0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00042de0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00042df0: 5f4f 505f 5355 4d3a 0a20 2020 2020 2020  _OP_SUM:.       
-00042e00: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00042e10: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-00042e20: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00042e30: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00042e40: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
-00042e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042e60: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-00042e70: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00042e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042e90: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
-00042ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042ec0: 2067 676d 6c5f 7265 7065 6174 2863 7478   ggml_repeat(ctx
-00042ed0: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
-00042ee0: 7372 6330 2d3e 6772 6164 292c 0a20 2020  src0->grad),.   
-00042ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042f00: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00042f10: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-00042f20: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00042f30: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00042f40: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00042f50: 4f50 5f4d 4541 4e3a 0a20 2020 2020 2020  OP_MEAN:.       
-00042f60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00042f70: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00042f80: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-00042f90: 444f 3a20 696d 706c 656d 656e 740a 2020  DO: implement.  
-00042fa0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00042fb0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00042fc0: 4747 4d4c 5f4f 505f 5245 5045 4154 3a0a  GGML_OP_REPEAT:.
-00042fd0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00042fe0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00042ff0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-00043000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043010: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-00043020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043030: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
-00043040: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
-00043050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043060: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-00043070: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-00043080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043090: 2020 2020 2020 2020 6767 6d6c 5f73 756d          ggml_sum
-000430a0: 2863 7478 2c20 7465 6e73 6f72 2d3e 6772  (ctx, tensor->gr
-000430b0: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
-000430c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000430d0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-000430e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000430f0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00043100: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00043110: 7365 2047 474d 4c5f 4f50 5f41 4253 3a0a  se GGML_OP_ABS:.
-00043120: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00043130: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00043140: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-00043150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043160: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-00043170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043180: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
-00043190: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
-000431a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000431b0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-000431c0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-000431d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000431e0: 2020 2020 2020 2020 6767 6d6c 5f6d 756c          ggml_mul
-000431f0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-00043200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043210: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
-00043220: 676e 2863 7478 2c20 7372 6330 292c 0a20  gn(ctx, src0),. 
-00043230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043250: 2020 2074 656e 736f 722d 3e67 7261 6429     tensor->grad)
-00043260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00043270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043280: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-00043290: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000432a0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000432b0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000432c0: 4747 4d4c 5f4f 505f 5347 4e3a 0a20 2020  GGML_OP_SGN:.   
-000432d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000432e0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-000432f0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-00043300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043310: 202f 2f20 6e6f 6f70 0a20 2020 2020 2020   // noop.       
-00043320: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00043330: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00043340: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00043350: 4c5f 4f50 5f4e 4547 3a0a 2020 2020 2020  L_OP_NEG:.      
-00043360: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00043370: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-00043380: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-00043390: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-000433a0: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-000433b0: 7375 625f 696d 706c 2863 7478 2c20 7372  sub_impl(ctx, sr
-000433c0: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
-000433d0: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
-000433e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000433f0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00043400: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00043410: 2063 6173 6520 4747 4d4c 5f4f 505f 5354   case GGML_OP_ST
-00043420: 4550 3a0a 2020 2020 2020 2020 2020 2020  EP:.            
-00043430: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00043440: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00043450: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00043460: 2020 2020 2020 2020 2f2f 206e 6f6f 700a          // noop.
-00043470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043480: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00043490: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000434a0: 6173 6520 4747 4d4c 5f4f 505f 5245 4c55  ase GGML_OP_RELU
-000434b0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000434c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000434d0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-000434e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000434f0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-00043500: 203d 2067 676d 6c5f 7375 625f 696d 706c   = ggml_sub_impl
-00043510: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-00043520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043530: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
+00040740: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
+00040750: 4f3a 2066 6978 2074 7261 6e73 706f 7365  O: fix transpose
+00040760: 2c20 7468 6520 6e6f 6465 2077 696c 6c20  , the node will 
+00040770: 6272 6561 6b20 7468 6520 6772 6170 6820  break the graph 
+00040780: 636f 6e6e 6563 7469 6f6e 730a 2020 2020  connections.    
+00040790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000407a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000407b0: 5f6d 756c 5f6d 6174 2863 7478 2c20 6767  _mul_mat(ctx, gg
+000407c0: 6d6c 5f74 7261 6e73 706f 7365 2863 7478  ml_transpose(ctx
+000407d0: 2c20 7372 6330 292c 2074 656e 736f 722d  , src0), tensor-
+000407e0: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+000407f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040800: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+00040810: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00040820: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00040830: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00040840: 2063 6173 6520 4747 4d4c 5f4f 505f 5343   case GGML_OP_SC
+00040850: 414c 453a 0a20 2020 2020 2020 2020 2020  ALE:.           
+00040860: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00040870: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00040880: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00040890: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+000408a0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000408b0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000408c0: 6520 4747 4d4c 5f4f 505f 4350 593a 0a20  e GGML_OP_CPY:. 
+000408d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000408e0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+000408f0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00040900: 202f 2f20 544f 444f 3a20 6e6f 7420 696d   // TODO: not im
+00040910: 706c 656d 656e 7465 640a 2020 2020 2020  plemented.      
+00040920: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00040930: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00040940: 5f4f 505f 5245 5348 4150 453a 0a20 2020  _OP_RESHAPE:.   
+00040950: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00040960: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00040970: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+00040980: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
+00040990: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
+000409a0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000409b0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000409c0: 505f 5649 4557 3a0a 2020 2020 2020 2020  P_VIEW:.        
+000409d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000409e0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000409f0: 5428 6661 6c73 6529 3b20 2f2f 206e 6f74  T(false); // not
+00040a00: 2073 7570 706f 7274 6564 0a20 2020 2020   supported.     
+00040a10: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00040a20: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00040a30: 4c5f 4f50 5f50 4552 4d55 5445 3a0a 2020  L_OP_PERMUTE:.  
+00040a40: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00040a50: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00040a60: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+00040a70: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
+00040a80: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
+00040a90: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00040aa0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00040ab0: 4f50 5f54 5241 4e53 504f 5345 3a0a 2020  OP_TRANSPOSE:.  
+00040ac0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00040ad0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00040ae0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+00040af0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
+00040b00: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
+00040b10: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00040b20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00040b30: 4f50 5f47 4554 5f52 4f57 533a 0a20 2020  OP_GET_ROWS:.   
+00040b40: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00040b50: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00040b60: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+00040b70: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
+00040b80: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
+00040b90: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00040ba0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00040bb0: 505f 4449 4147 5f4d 4153 4b5f 494e 463a  P_DIAG_MASK_INF:
+00040bc0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00040bd0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00040be0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00040bf0: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
+00040c00: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
+00040c10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00040c20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00040c30: 4d4c 5f4f 505f 534f 4654 5f4d 4158 3a0a  ML_OP_SOFT_MAX:.
+00040c40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00040c50: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00040c60: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00040c70: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
+00040c80: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+00040c90: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00040ca0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00040cb0: 4c5f 4f50 5f52 4f50 453a 0a20 2020 2020  L_OP_ROPE:.     
+00040cc0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00040cd0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00040ce0: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+00040cf0: 544f 444f 3a20 6e6f 7420 696d 706c 656d  TODO: not implem
+00040d00: 656e 7465 640a 2020 2020 2020 2020 2020  ented.          
+00040d10: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00040d20: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00040d30: 434f 4e56 5f31 445f 3153 3a0a 2020 2020  CONV_1D_1S:.    
+00040d40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00040d50: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00040d60: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00040d70: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+00040d80: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+00040d90: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00040da0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00040db0: 5f43 4f4e 565f 3144 5f32 533a 0a20 2020  _CONV_1D_2S:.   
+00040dc0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00040dd0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00040de0: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+00040df0: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
+00040e00: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
+00040e10: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00040e20: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00040e30: 505f 464c 4153 485f 4154 544e 3a0a 2020  P_FLASH_ATTN:.  
+00040e40: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00040e50: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00040e60: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+00040e70: 2f2f 206e 6f74 2073 7570 706f 7274 6564  // not supported
+00040e80: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00040e90: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00040ea0: 7365 2047 474d 4c5f 4f50 5f46 4c41 5348  se GGML_OP_FLASH
+00040eb0: 5f46 463a 0a20 2020 2020 2020 2020 2020  _FF:.           
+00040ec0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00040ed0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00040ee0: 616c 7365 293b 202f 2f20 6e6f 7420 7375  alse); // not su
+00040ef0: 7070 6f72 7465 640a 2020 2020 2020 2020  pported.        
+00040f00: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00040f10: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00040f20: 505f 4e4f 4e45 3a0a 2020 2020 2020 2020  P_NONE:.        
+00040f30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00040f40: 2020 2020 2020 2f2f 206e 6f70 0a20 2020        // nop.   
+00040f50: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00040f60: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00040f70: 474d 4c5f 4f50 5f43 4f55 4e54 3a0a 2020  GML_OP_COUNT:.  
+00040f80: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00040f90: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00040fa0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00040fb0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00040fc0: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 7374  eak;.    }.}..st
+00040fd0: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
+00040fe0: 6973 6974 5f70 6172 656e 7473 2873 7472  isit_parents(str
+00040ff0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+00041000: 2a20 6367 7261 7068 2c20 7374 7275 6374  * cgraph, struct
+00041010: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+00041020: 6f64 6529 207b 0a20 2020 2069 6620 286e  ode) {.    if (n
+00041030: 6f64 652d 3e67 7261 6420 3d3d 204e 554c  ode->grad == NUL
+00041040: 4c29 207b 0a20 2020 2020 2020 202f 2f20  L) {.        // 
+00041050: 7468 6973 2075 7375 616c 6c79 2068 6170  this usually hap
+00041060: 7065 6e73 2077 6865 6e20 7765 2067 656e  pens when we gen
+00041070: 6572 6174 6520 696e 7465 726d 6564 6961  erate intermedia
+00041080: 7465 206e 6f64 6573 2066 726f 6d20 636f  te nodes from co
+00041090: 6e73 7461 6e74 7320 696e 2074 6865 2062  nstants in the b
+000410a0: 6163 6b77 6172 6420 7061 7373 0a20 2020  ackward pass.   
+000410b0: 2020 2020 202f 2f20 6974 2063 616e 2061       // it can a
+000410c0: 6c73 6f20 6861 7070 656e 2064 7572 696e  lso happen durin
+000410d0: 6720 666f 7277 6172 6420 7061 7373 2c20  g forward pass, 
+000410e0: 6966 2074 6865 2075 7365 7220 7065 7266  if the user perf
+000410f0: 6f72 6d73 2063 6f6d 7075 7461 7469 6f6e  orms computation
+00041100: 7320 7769 7468 2063 6f6e 7374 616e 7473  s with constants
+00041110: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
+00041120: 652d 3e6f 7020 213d 2047 474d 4c5f 4f50  e->op != GGML_OP
+00041130: 5f4e 4f4e 4529 207b 0a20 2020 2020 2020  _NONE) {.       
+00041140: 2020 2020 202f 2f47 474d 4c5f 5052 494e       //GGML_PRIN
+00041150: 545f 4445 4255 4728 2225 733a 2077 6172  T_DEBUG("%s: war
+00041160: 6e69 6e67 3a20 6e6f 6465 2025 7020 6861  ning: node %p ha
+00041170: 7320 6e6f 2067 7261 642c 2062 7574 206f  s no grad, but o
+00041180: 7020 2564 5c6e 222c 205f 5f66 756e 635f  p %d\n", __func_
+00041190: 5f2c 2028 766f 6964 202a 2920 6e6f 6465  _, (void *) node
+000411a0: 2c20 6e6f 6465 2d3e 6f70 293b 0a20 2020  , node->op);.   
+000411b0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
+000411c0: 2020 2f2f 2063 6865 636b 2069 6620 616c    // check if al
+000411d0: 7265 6164 7920 7669 7369 7465 640a 2020  ready visited.  
+000411e0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+000411f0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+00041200: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+00041210: 2020 2020 2020 6966 2028 6367 7261 7068        if (cgraph
+00041220: 2d3e 6e6f 6465 735b 695d 203d 3d20 6e6f  ->nodes[i] == no
+00041230: 6465 2920 7b0a 2020 2020 2020 2020 2020  de) {.          
+00041240: 2020 7265 7475 726e 3b0a 2020 2020 2020    return;.      
+00041250: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
+00041260: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00041270: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
+00041280: 6673 3b20 692b 2b29 207b 0a20 2020 2020  fs; i++) {.     
+00041290: 2020 2069 6620 2863 6772 6170 682d 3e6c     if (cgraph->l
+000412a0: 6561 6673 5b69 5d20 3d3d 206e 6f64 6529  eafs[i] == node)
+000412b0: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
+000412c0: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
+000412d0: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+000412e0: 6e6f 6465 2d3e 7372 6330 2920 7b0a 2020  node->src0) {.  
+000412f0: 2020 2020 2020 6767 6d6c 5f76 6973 6974        ggml_visit
+00041300: 5f70 6172 656e 7473 2863 6772 6170 682c  _parents(cgraph,
+00041310: 206e 6f64 652d 3e73 7263 3029 3b0a 2020   node->src0);.  
+00041320: 2020 7d0a 0a20 2020 2069 6620 286e 6f64    }..    if (nod
+00041330: 652d 3e73 7263 3129 207b 0a20 2020 2020  e->src1) {.     
+00041340: 2020 2067 676d 6c5f 7669 7369 745f 7061     ggml_visit_pa
+00041350: 7265 6e74 7328 6367 7261 7068 2c20 6e6f  rents(cgraph, no
+00041360: 6465 2d3e 7372 6331 293b 0a20 2020 207d  de->src1);.    }
+00041370: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00041380: 203d 2030 3b20 6920 3c20 4747 4d4c 5f4d   = 0; i < GGML_M
+00041390: 4158 5f4f 5054 3b20 2b2b 6929 207b 0a20  AX_OPT; ++i) {. 
+000413a0: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
+000413b0: 3e6f 7074 5b69 5d29 207b 0a20 2020 2020  >opt[i]) {.     
+000413c0: 2020 2020 2020 2067 676d 6c5f 7669 7369         ggml_visi
+000413d0: 745f 7061 7265 6e74 7328 6367 7261 7068  t_parents(cgraph
+000413e0: 2c20 6e6f 6465 2d3e 6f70 745b 695d 293b  , node->opt[i]);
+000413f0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00041400: 0a0a 2020 2020 6966 2028 6e6f 6465 2d3e  ..    if (node->
+00041410: 6f70 203d 3d20 4747 4d4c 5f4f 505f 4e4f  op == GGML_OP_NO
+00041420: 4e45 2026 2620 6e6f 6465 2d3e 6772 6164  NE && node->grad
+00041430: 203d 3d20 4e55 4c4c 2920 7b0a 2020 2020   == NULL) {.    
+00041440: 2020 2020 2f2f 2072 6561 6368 6564 2061      // reached a
+00041450: 206c 6561 6620 6e6f 6465 2c20 6e6f 7420   leaf node, not 
+00041460: 7061 7274 206f 6620 7468 6520 6772 6164  part of the grad
+00041470: 6965 6e74 2067 7261 7068 2028 652e 672e  ient graph (e.g.
+00041480: 2061 2063 6f6e 7374 616e 7429 0a20 2020   a constant).   
+00041490: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+000414a0: 2863 6772 6170 682d 3e6e 5f6c 6561 6673  (cgraph->n_leafs
+000414b0: 203c 2047 474d 4c5f 4d41 585f 4e4f 4445   < GGML_MAX_NODE
+000414c0: 5329 3b0a 0a20 2020 2020 2020 2063 6772  S);..        cgr
+000414d0: 6170 682d 3e6c 6561 6673 5b63 6772 6170  aph->leafs[cgrap
+000414e0: 682d 3e6e 5f6c 6561 6673 5d20 3d20 6e6f  h->n_leafs] = no
+000414f0: 6465 3b0a 2020 2020 2020 2020 6367 7261  de;.        cgra
+00041500: 7068 2d3e 6e5f 6c65 6166 732b 2b3b 0a20  ph->n_leafs++;. 
+00041510: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00041520: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00041530: 6367 7261 7068 2d3e 6e5f 6e6f 6465 7320  cgraph->n_nodes 
+00041540: 3c20 4747 4d4c 5f4d 4158 5f4e 4f44 4553  < GGML_MAX_NODES
+00041550: 293b 0a0a 2020 2020 2020 2020 6367 7261  );..        cgra
+00041560: 7068 2d3e 6e6f 6465 735b 6367 7261 7068  ph->nodes[cgraph
+00041570: 2d3e 6e5f 6e6f 6465 735d 203d 206e 6f64  ->n_nodes] = nod
+00041580: 653b 0a20 2020 2020 2020 2063 6772 6170  e;.        cgrap
+00041590: 682d 3e67 7261 6473 5b63 6772 6170 682d  h->grads[cgraph-
+000415a0: 3e6e 5f6e 6f64 6573 5d20 3d20 6e6f 6465  >n_nodes] = node
+000415b0: 2d3e 6772 6164 3b0a 2020 2020 2020 2020  ->grad;.        
+000415c0: 6367 7261 7068 2d3e 6e5f 6e6f 6465 732b  cgraph->n_nodes+
+000415d0: 2b3b 0a20 2020 207d 0a7d 0a0a 7374 6174  +;.    }.}..stat
+000415e0: 6963 2076 6f69 6420 6767 6d6c 5f62 7569  ic void ggml_bui
+000415f0: 6c64 5f66 6f72 7761 7264 5f69 6d70 6c28  ld_forward_impl(
+00041600: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+00041610: 7068 202a 2063 6772 6170 682c 2073 7472  ph * cgraph, str
+00041620: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00041630: 2a20 7465 6e73 6f72 2c20 626f 6f6c 2065  * tensor, bool e
+00041640: 7870 616e 6429 207b 0a20 2020 2069 6620  xpand) {.    if 
+00041650: 2821 6578 7061 6e64 2920 7b0a 2020 2020  (!expand) {.    
+00041660: 2020 2020 6367 7261 7068 2d3e 6e5f 6e6f      cgraph->n_no
+00041670: 6465 7320 3d20 303b 0a20 2020 2020 2020  des = 0;.       
+00041680: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
+00041690: 203d 2030 3b0a 2020 2020 7d0a 0a20 2020   = 0;.    }..   
+000416a0: 2063 6f6e 7374 2069 6e74 206e 3020 3d20   const int n0 = 
+000416b0: 6367 7261 7068 2d3e 6e5f 6e6f 6465 733b  cgraph->n_nodes;
+000416c0: 0a20 2020 2055 4e55 5345 4428 6e30 293b  .    UNUSED(n0);
+000416d0: 0a0a 2020 2020 6767 6d6c 5f76 6973 6974  ..    ggml_visit
+000416e0: 5f70 6172 656e 7473 2863 6772 6170 682c  _parents(cgraph,
+000416f0: 2074 656e 736f 7229 3b0a 0a20 2020 2063   tensor);..    c
+00041700: 6f6e 7374 2069 6e74 206e 5f6e 6577 203d  onst int n_new =
+00041710: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
+00041720: 202d 206e 303b 0a20 2020 2047 474d 4c5f   - n0;.    GGML_
+00041730: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
+00041740: 2076 6973 6974 6564 2025 6420 6e65 7720   visited %d new 
+00041750: 6e6f 6465 735c 6e22 2c20 5f5f 6675 6e63  nodes\n", __func
+00041760: 5f5f 2c20 6e5f 6e65 7729 3b0a 0a20 2020  __, n_new);..   
+00041770: 2069 6620 286e 5f6e 6577 203e 2030 2920   if (n_new > 0) 
+00041780: 7b0a 2020 2020 2020 2020 2f2f 2074 6865  {.        // the
+00041790: 206c 6173 7420 6164 6465 6420 6e6f 6465   last added node
+000417a0: 2073 686f 756c 6420 616c 7761 7973 2062   should always b
+000417b0: 6520 7374 6172 7469 6e67 2070 6f69 6e74  e starting point
+000417c0: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
+000417d0: 5345 5254 2863 6772 6170 682d 3e6e 6f64  SERT(cgraph->nod
+000417e0: 6573 5b63 6772 6170 682d 3e6e 5f6e 6f64  es[cgraph->n_nod
+000417f0: 6573 202d 2031 5d20 3d3d 2074 656e 736f  es - 1] == tenso
+00041800: 7229 3b0a 2020 2020 7d0a 7d0a 0a76 6f69  r);.    }.}..voi
+00041810: 6420 6767 6d6c 5f62 7569 6c64 5f66 6f72  d ggml_build_for
+00041820: 7761 7264 5f65 7870 616e 6428 7374 7275  ward_expand(stru
+00041830: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+00041840: 2063 6772 6170 682c 2073 7472 7563 7420   cgraph, struct 
+00041850: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+00041860: 6e73 6f72 2920 7b0a 2020 2020 6767 6d6c  nsor) {.    ggml
+00041870: 5f62 7569 6c64 5f66 6f72 7761 7264 5f69  _build_forward_i
+00041880: 6d70 6c28 6367 7261 7068 2c20 7465 6e73  mpl(cgraph, tens
+00041890: 6f72 2c20 7472 7565 293b 0a7d 0a0a 7374  or, true);.}..st
+000418a0: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+000418b0: 2067 676d 6c5f 6275 696c 645f 666f 7277   ggml_build_forw
+000418c0: 6172 6428 7374 7275 6374 2067 676d 6c5f  ard(struct ggml_
+000418d0: 7465 6e73 6f72 202a 2074 656e 736f 7229  tensor * tensor)
+000418e0: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
+000418f0: 6d6c 5f63 6772 6170 6820 7265 7375 6c74  ml_cgraph result
+00041900: 203d 207b 0a20 2020 2020 2020 202f 2a2e   = {.        /*.
+00041910: 6e5f 6e6f 6465 7320 2020 2020 203d 2a2f  n_nodes      =*/
+00041920: 2030 2c0a 2020 2020 2020 2020 2f2a 2e6e   0,.        /*.n
+00041930: 5f6c 6561 6673 2020 2020 2020 3d2a 2f20  _leafs      =*/ 
+00041940: 302c 0a20 2020 2020 2020 202f 2a2e 6e5f  0,.        /*.n_
+00041950: 7468 7265 6164 7320 2020 203d 2a2f 2030  threads    =*/ 0
+00041960: 2c0a 2020 2020 2020 2020 2f2a 2e77 6f72  ,.        /*.wor
+00041970: 6b5f 7369 7a65 2020 2020 3d2a 2f20 302c  k_size    =*/ 0,
+00041980: 0a20 2020 2020 2020 202f 2a2e 776f 726b  .        /*.work
+00041990: 2020 2020 2020 2020 203d 2a2f 204e 554c           =*/ NUL
+000419a0: 4c2c 0a20 2020 2020 2020 202f 2a2e 6e6f  L,.        /*.no
+000419b0: 6465 7320 2020 2020 2020 203d 2a2f 207b  des        =*/ {
+000419c0: 204e 554c 4c20 7d2c 0a20 2020 2020 2020   NULL },.       
+000419d0: 202f 2a2e 6772 6164 7320 2020 2020 2020   /*.grads       
+000419e0: 203d 2a2f 207b 204e 554c 4c20 7d2c 0a20   =*/ { NULL },. 
+000419f0: 2020 2020 2020 202f 2a2e 6c65 6166 7320         /*.leafs 
+00041a00: 2020 2020 2020 203d 2a2f 207b 204e 554c         =*/ { NUL
+00041a10: 4c20 7d2c 0a20 2020 2020 2020 202f 2a2e  L },.        /*.
+00041a20: 7065 7266 5f72 756e 7320 2020 203d 2a2f  perf_runs    =*/
+00041a30: 2030 2c0a 2020 2020 2020 2020 2f2a 2e70   0,.        /*.p
+00041a40: 6572 665f 6379 636c 6573 2020 3d2a 2f20  erf_cycles  =*/ 
+00041a50: 302c 0a20 2020 2020 2020 202f 2a2e 7065  0,.        /*.pe
+00041a60: 7266 5f74 696d 655f 7573 203d 2a2f 2030  rf_time_us =*/ 0
+00041a70: 2c0a 2020 2020 7d3b 0a0a 2020 2020 6767  ,.    };..    gg
+00041a80: 6d6c 5f62 7569 6c64 5f66 6f72 7761 7264  ml_build_forward
+00041a90: 5f69 6d70 6c28 2672 6573 756c 742c 2074  _impl(&result, t
+00041aa0: 656e 736f 722c 2066 616c 7365 293b 0a0a  ensor, false);..
+00041ab0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00041ac0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+00041ad0: 6c5f 6367 7261 7068 2067 676d 6c5f 6275  l_cgraph ggml_bu
+00041ae0: 696c 645f 6261 636b 7761 7264 2873 7472  ild_backward(str
+00041af0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00041b00: 202a 2063 7478 2c20 7374 7275 6374 2067   * ctx, struct g
+00041b10: 676d 6c5f 6367 7261 7068 202a 2067 662c  gml_cgraph * gf,
+00041b20: 2062 6f6f 6c20 6b65 6570 2920 7b0a 2020   bool keep) {.  
+00041b30: 2020 7374 7275 6374 2067 676d 6c5f 6367    struct ggml_cg
+00041b40: 7261 7068 2072 6573 756c 7420 3d20 2a67  raph result = *g
+00041b50: 663b 0a0a 2020 2020 4747 4d4c 5f41 5353  f;..    GGML_ASS
+00041b60: 4552 5428 6766 2d3e 6e5f 6e6f 6465 7320  ERT(gf->n_nodes 
+00041b70: 3e20 3029 3b0a 0a20 2020 202f 2f20 6966  > 0);..    // if
+00041b80: 2077 6520 6172 6520 6b65 6570 696e 6720   we are keeping 
+00041b90: 7468 6520 6772 6164 6965 6e74 2067 7261  the gradient gra
+00041ba0: 7068 2c20 7765 2068 6176 6520 746f 2064  ph, we have to d
+00041bb0: 6574 6163 6820 7468 6520 6772 6164 6965  etach the gradie
+00041bc0: 6e74 206e 6f64 6573 2066 726f 6d20 7468  nt nodes from th
+00041bd0: 6520 6f72 6967 696e 616c 2067 7261 7068  e original graph
+00041be0: 0a20 2020 2069 6620 286b 6565 7029 207b  .    if (keep) {
+00041bf0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00041c00: 7420 6920 3d20 303b 2069 203c 2067 662d  t i = 0; i < gf-
+00041c10: 3e6e 5f6e 6f64 6573 3b20 692b 2b29 207b  >n_nodes; i++) {
+00041c20: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00041c30: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00041c40: 2a20 6e6f 6465 203d 2067 662d 3e6e 6f64  * node = gf->nod
+00041c50: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
+00041c60: 2020 2020 6966 2028 6e6f 6465 2d3e 6772      if (node->gr
+00041c70: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00041c80: 2020 2020 2020 6e6f 6465 2d3e 6772 6164        node->grad
+00041c90: 203d 2067 676d 6c5f 6475 705f 7465 6e73   = ggml_dup_tens
+00041ca0: 6f72 2863 7478 2c20 6e6f 6465 293b 0a20  or(ctx, node);. 
+00041cb0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00041cc0: 662d 3e67 7261 6473 5b69 5d20 3d20 6e6f  f->grads[i] = no
+00041cd0: 6465 2d3e 6772 6164 3b0a 2020 2020 2020  de->grad;.      
+00041ce0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00041cf0: 7d0a 2020 2020 7d0a 0a20 2020 2066 6f72  }.    }..    for
+00041d00: 2028 696e 7420 6920 3d20 6766 2d3e 6e5f   (int i = gf->n_
+00041d10: 6e6f 6465 7320 2d20 313b 2069 203e 3d20  nodes - 1; i >= 
+00041d20: 303b 2069 2d2d 2920 7b0a 2020 2020 2020  0; i--) {.      
+00041d30: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00041d40: 6e73 6f72 202a 206e 6f64 6520 3d20 6766  nsor * node = gf
+00041d50: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+00041d60: 2020 2020 202f 2f20 6265 6361 7573 6520       // because 
+00041d70: 7765 2064 6574 6163 6865 6420 7468 6520  we detached the 
+00041d80: 6772 6164 206e 6f64 6573 2066 726f 6d20  grad nodes from 
+00041d90: 7468 6520 6f72 6967 696e 616c 2067 7261  the original gra
+00041da0: 7068 2c20 7765 2063 616e 2061 6666 6f72  ph, we can affor
+00041db0: 6420 696e 706c 6163 6520 6f70 6572 6174  d inplace operat
+00041dc0: 696f 6e73 0a20 2020 2020 2020 2069 6620  ions.        if 
+00041dd0: 286e 6f64 652d 3e67 7261 6429 207b 0a20  (node->grad) {. 
+00041de0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00041df0: 636f 6d70 7574 655f 6261 636b 7761 7264  compute_backward
+00041e00: 2863 7478 2c20 6e6f 6465 2c20 6b65 6570  (ctx, node, keep
+00041e10: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
+00041e20: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
+00041e30: 2069 203d 2067 662d 3e6e 5f6e 6f64 6573   i = gf->n_nodes
+00041e40: 202d 2031 3b20 6920 3e3d 2030 3b20 692d   - 1; i >= 0; i-
+00041e50: 2d29 207b 0a20 2020 2020 2020 2073 7472  -) {.        str
+00041e60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00041e70: 2a20 6e6f 6465 203d 2067 662d 3e6e 6f64  * node = gf->nod
+00041e80: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
+00041e90: 6966 2028 6e6f 6465 2d3e 6973 5f70 6172  if (node->is_par
+00041ea0: 616d 2920 7b0a 2020 2020 2020 2020 2020  am) {.          
+00041eb0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+00041ec0: 5547 2822 2573 3a20 666f 756e 6420 726f  UG("%s: found ro
+00041ed0: 6f74 206e 6f64 6520 2570 5c6e 222c 205f  ot node %p\n", _
+00041ee0: 5f66 756e 635f 5f2c 2028 766f 6964 202a  _func__, (void *
+00041ef0: 2920 6e6f 6465 293b 0a20 2020 2020 2020  ) node);.       
+00041f00: 2020 2020 2067 676d 6c5f 6275 696c 645f       ggml_build_
+00041f10: 666f 7277 6172 645f 696d 706c 2826 7265  forward_impl(&re
+00041f20: 7375 6c74 2c20 6e6f 6465 2d3e 6772 6164  sult, node->grad
+00041f30: 2c20 7472 7565 293b 0a20 2020 2020 2020  , true);.       
+00041f40: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
+00041f50: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+00041f60: 2f2f 0a2f 2f20 7468 7265 6164 2064 6174  //.// thread dat
+00041f70: 610a 2f2f 0a2f 2f20 7379 6e63 6872 6f6e  a.//.// synchron
+00041f80: 697a 6174 696f 6e20 6973 2064 6f6e 6520  ization is done 
+00041f90: 7669 6120 6275 7379 206c 6f6f 7073 0a2f  via busy loops./
+00041fa0: 2f20 4920 7472 6965 6420 7573 696e 6720  / I tried using 
+00041fb0: 7370 696e 206c 6f63 6b73 2c20 6275 7420  spin locks, but 
+00041fc0: 6e6f 7420 7375 7265 2068 6f77 2074 6f20  not sure how to 
+00041fd0: 7573 6520 7468 656d 2063 6f72 7265 6374  use them correct
+00041fe0: 6c79 202d 2074 6865 2074 6869 6e67 7320  ly - the things 
+00041ff0: 4920 7472 6965 6420 7765 7265 2073 6c6f  I tried were slo
+00042000: 7765 7220 7468 616e 2062 7573 7920 6c6f  wer than busy lo
+00042010: 6f70 730a 2f2f 0a0a 2369 6664 6566 205f  ops.//..#ifdef _
+00042020: 5f41 5050 4c45 5f5f 0a0a 2f2f 2369 6e63  _APPLE__..//#inc
+00042030: 6c75 6465 203c 6f73 2f6c 6f63 6b2e 683e  lude <os/lock.h>
+00042040: 0a2f 2f0a 2f2f 7479 7065 6465 6620 6f73  .//.//typedef os
+00042050: 5f75 6e66 6169 725f 6c6f 636b 2067 676d  _unfair_lock ggm
+00042060: 6c5f 6c6f 636b 5f74 3b0a 2f2f 0a2f 2f23  l_lock_t;.//.//#
+00042070: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
+00042080: 5f69 6e69 7428 7829 2020 2020 554e 5553  _init(x)    UNUS
+00042090: 4544 2878 290a 2f2f 2364 6566 696e 6520  ED(x).//#define 
+000420a0: 6767 6d6c 5f6c 6f63 6b5f 6465 7374 726f  ggml_lock_destro
+000420b0: 7928 7829 2055 4e55 5345 4428 7829 0a2f  y(x) UNUSED(x)./
+000420c0: 2f23 6465 6669 6e65 2067 676d 6c5f 6c6f  /#define ggml_lo
+000420d0: 636b 5f6c 6f63 6b20 2020 2020 2020 6f73  ck_lock       os
+000420e0: 5f75 6e66 6169 725f 6c6f 636b 5f6c 6f63  _unfair_lock_loc
+000420f0: 6b0a 2f2f 2364 6566 696e 6520 6767 6d6c  k.//#define ggml
+00042100: 5f6c 6f63 6b5f 756e 6c6f 636b 2020 2020  _lock_unlock    
+00042110: 206f 735f 756e 6661 6972 5f6c 6f63 6b5f   os_unfair_lock_
+00042120: 756e 6c6f 636b 0a2f 2f0a 2f2f 2364 6566  unlock.//.//#def
+00042130: 696e 6520 4747 4d4c 5f4c 4f43 4b5f 494e  ine GGML_LOCK_IN
+00042140: 4954 4941 4c49 5a45 5220 4f53 5f55 4e46  ITIALIZER OS_UNF
+00042150: 4149 525f 4c4f 434b 5f49 4e49 540a 0a74  AIR_LOCK_INIT..t
+00042160: 7970 6564 6566 2069 6e74 2067 676d 6c5f  ypedef int ggml_
+00042170: 6c6f 636b 5f74 3b0a 0a23 6465 6669 6e65  lock_t;..#define
+00042180: 2067 676d 6c5f 6c6f 636b 5f69 6e69 7428   ggml_lock_init(
+00042190: 7829 2020 2020 554e 5553 4544 2878 290a  x)    UNUSED(x).
+000421a0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+000421b0: 6b5f 6465 7374 726f 7928 7829 2055 4e55  k_destroy(x) UNU
+000421c0: 5345 4428 7829 0a23 6465 6669 6e65 2067  SED(x).#define g
+000421d0: 676d 6c5f 6c6f 636b 5f6c 6f63 6b28 7829  gml_lock_lock(x)
+000421e0: 2020 2020 554e 5553 4544 2878 290a 2364      UNUSED(x).#d
+000421f0: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
+00042200: 756e 6c6f 636b 2878 2920 2055 4e55 5345  unlock(x)  UNUSE
+00042210: 4428 7829 0a0a 2364 6566 696e 6520 4747  D(x)..#define GG
+00042220: 4d4c 5f4c 4f43 4b5f 494e 4954 4941 4c49  ML_LOCK_INITIALI
+00042230: 5a45 5220 300a 0a74 7970 6564 6566 2070  ZER 0..typedef p
+00042240: 7468 7265 6164 5f74 2067 676d 6c5f 7468  thread_t ggml_th
+00042250: 7265 6164 5f74 3b0a 0a23 6465 6669 6e65  read_t;..#define
+00042260: 2067 676d 6c5f 7468 7265 6164 5f63 7265   ggml_thread_cre
+00042270: 6174 6520 7074 6872 6561 645f 6372 6561  ate pthread_crea
+00042280: 7465 0a23 6465 6669 6e65 2067 676d 6c5f  te.#define ggml_
+00042290: 7468 7265 6164 5f6a 6f69 6e20 2020 7074  thread_join   pt
+000422a0: 6872 6561 645f 6a6f 696e 0a0a 2365 6c73  hread_join..#els
+000422b0: 650a 0a2f 2f74 7970 6564 6566 2070 7468  e..//typedef pth
+000422c0: 7265 6164 5f73 7069 6e6c 6f63 6b5f 7420  read_spinlock_t 
+000422d0: 6767 6d6c 5f6c 6f63 6b5f 743b 0a0a 2f2f  ggml_lock_t;..//
+000422e0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+000422f0: 6b5f 696e 6974 2878 2920 7074 6872 6561  k_init(x) pthrea
+00042300: 645f 7370 696e 5f69 6e69 7428 782c 2050  d_spin_init(x, P
+00042310: 5448 5245 4144 5f50 524f 4345 5353 5f50  THREAD_PROCESS_P
+00042320: 5249 5641 5445 290a 2f2f 2364 6566 696e  RIVATE).//#defin
+00042330: 6520 6767 6d6c 5f6c 6f63 6b5f 6465 7374  e ggml_lock_dest
+00042340: 726f 7920 7074 6872 6561 645f 7370 696e  roy pthread_spin
+00042350: 5f64 6573 7472 6f79 0a2f 2f23 6465 6669  _destroy.//#defi
+00042360: 6e65 2067 676d 6c5f 6c6f 636b 5f6c 6f63  ne ggml_lock_loc
+00042370: 6b20 2020 2070 7468 7265 6164 5f73 7069  k    pthread_spi
+00042380: 6e5f 6c6f 636b 0a2f 2f23 6465 6669 6e65  n_lock.//#define
+00042390: 2067 676d 6c5f 6c6f 636b 5f75 6e6c 6f63   ggml_lock_unloc
+000423a0: 6b20 2070 7468 7265 6164 5f73 7069 6e5f  k  pthread_spin_
+000423b0: 756e 6c6f 636b 0a0a 7479 7065 6465 6620  unlock..typedef 
+000423c0: 696e 7420 6767 6d6c 5f6c 6f63 6b5f 743b  int ggml_lock_t;
+000423d0: 0a0a 2364 6566 696e 6520 6767 6d6c 5f6c  ..#define ggml_l
+000423e0: 6f63 6b5f 696e 6974 2878 2920 2020 2055  ock_init(x)    U
+000423f0: 4e55 5345 4428 7829 0a23 6465 6669 6e65  NUSED(x).#define
+00042400: 2067 676d 6c5f 6c6f 636b 5f64 6573 7472   ggml_lock_destr
+00042410: 6f79 2878 2920 554e 5553 4544 2878 290a  oy(x) UNUSED(x).
+00042420: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+00042430: 6b5f 6c6f 636b 2878 2920 2020 2055 4e55  k_lock(x)    UNU
+00042440: 5345 4428 7829 0a23 6465 6669 6e65 2067  SED(x).#define g
+00042450: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28  gml_lock_unlock(
+00042460: 7829 2020 554e 5553 4544 2878 290a 0a23  x)  UNUSED(x)..#
+00042470: 6465 6669 6e65 2047 474d 4c5f 4c4f 434b  define GGML_LOCK
+00042480: 5f49 4e49 5449 414c 495a 4552 2030 0a0a  _INITIALIZER 0..
+00042490: 7479 7065 6465 6620 7074 6872 6561 645f  typedef pthread_
+000424a0: 7420 6767 6d6c 5f74 6872 6561 645f 743b  t ggml_thread_t;
+000424b0: 0a0a 2364 6566 696e 6520 6767 6d6c 5f74  ..#define ggml_t
+000424c0: 6872 6561 645f 6372 6561 7465 2070 7468  hread_create pth
+000424d0: 7265 6164 5f63 7265 6174 650a 2364 6566  read_create.#def
+000424e0: 696e 6520 6767 6d6c 5f74 6872 6561 645f  ine ggml_thread_
+000424f0: 6a6f 696e 2020 2070 7468 7265 6164 5f6a  join   pthread_j
+00042500: 6f69 6e0a 0a23 656e 6469 660a 0a73 7472  oin..#endif..str
+00042510: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00042520: 5f73 7461 7465 5f73 6861 7265 6420 7b0a  _state_shared {.
+00042530: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 7420      ggml_lock_t 
+00042540: 7370 696e 3b0a 0a20 2020 2069 6e74 206e  spin;..    int n
+00042550: 5f74 6872 6561 6473 3b0a 0a20 2020 202f  _threads;..    /
+00042560: 2f20 7379 6e63 6872 6f6e 697a 6174 696f  / synchronizatio
+00042570: 6e20 7072 696d 6974 6976 6573 0a20 2020  n primitives.   
+00042580: 2061 746f 6d69 635f 696e 7420 206e 5f72   atomic_int  n_r
+00042590: 6561 6479 3b0a 2020 2020 6174 6f6d 6963  eady;.    atomic
+000425a0: 5f62 6f6f 6c20 6861 735f 776f 726b 3b0a  _bool has_work;.
+000425b0: 2020 2020 6174 6f6d 6963 5f62 6f6f 6c20      atomic_bool 
+000425c0: 7374 6f70 3b20 2f2f 2073 746f 7020 616c  stop; // stop al
+000425d0: 6c20 7468 7265 6164 730a 7d3b 0a0a 7374  l threads.};..st
+000425e0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+000425f0: 655f 7374 6174 6520 7b0a 2020 2020 6767  e_state {.    gg
+00042600: 6d6c 5f74 6872 6561 645f 7420 7468 7264  ml_thread_t thrd
+00042610: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+00042620: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00042630: 7320 7061 7261 6d73 3b0a 2020 2020 7374  s params;.    st
+00042640: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00042650: 202a 206e 6f64 653b 0a0a 2020 2020 7374   * node;..    st
+00042660: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00042670: 655f 7374 6174 655f 7368 6172 6564 202a  e_state_shared *
+00042680: 2073 6861 7265 643b 0a7d 3b0a 0a73 7461   shared;.};..sta
+00042690: 7469 6320 7468 7265 6164 5f72 6574 5f74  tic thread_ret_t
+000426a0: 2067 676d 6c5f 6772 6170 685f 636f 6d70   ggml_graph_comp
+000426b0: 7574 655f 7468 7265 6164 2876 6f69 6420  ute_thread(void 
+000426c0: 2a20 6461 7461 2920 7b0a 2020 2020 7374  * data) {.    st
+000426d0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+000426e0: 655f 7374 6174 6520 2a20 7374 6174 6520  e_state * state 
+000426f0: 3d20 2873 7472 7563 7420 6767 6d6c 5f63  = (struct ggml_c
+00042700: 6f6d 7075 7465 5f73 7461 7465 202a 2920  ompute_state *) 
+00042710: 6461 7461 3b0a 0a20 2020 2063 6f6e 7374  data;..    const
+00042720: 2069 6e74 206e 5f74 6872 6561 6473 203d   int n_threads =
+00042730: 2073 7461 7465 2d3e 7368 6172 6564 2d3e   state->shared->
+00042740: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
+00042750: 7768 696c 6520 2874 7275 6529 207b 0a20  while (true) {. 
+00042760: 2020 2020 2020 2069 6620 2861 746f 6d69         if (atomi
+00042770: 635f 6665 7463 685f 6164 6428 2673 7461  c_fetch_add(&sta
+00042780: 7465 2d3e 7368 6172 6564 2d3e 6e5f 7265  te->shared->n_re
+00042790: 6164 792c 2031 2920 3d3d 206e 5f74 6872  ady, 1) == n_thr
+000427a0: 6561 6473 202d 2031 2920 7b0a 2020 2020  eads - 1) {.    
+000427b0: 2020 2020 2020 2020 6174 6f6d 6963 5f73          atomic_s
+000427c0: 746f 7265 2826 7374 6174 652d 3e73 6861  tore(&state->sha
+000427d0: 7265 642d 3e68 6173 5f77 6f72 6b2c 2066  red->has_work, f
+000427e0: 616c 7365 293b 0a20 2020 2020 2020 207d  alse);.        }
+000427f0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00042800: 2020 2020 7768 696c 6520 2861 746f 6d69      while (atomi
+00042810: 635f 6c6f 6164 2826 7374 6174 652d 3e73  c_load(&state->s
+00042820: 6861 7265 642d 3e68 6173 5f77 6f72 6b29  hared->has_work)
+00042830: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00042840: 2020 2020 6966 2028 6174 6f6d 6963 5f6c      if (atomic_l
+00042850: 6f61 6428 2673 7461 7465 2d3e 7368 6172  oad(&state->shar
+00042860: 6564 2d3e 7374 6f70 2929 207b 0a20 2020  ed->stop)) {.   
+00042870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042880: 2072 6574 7572 6e20 303b 0a20 2020 2020   return 0;.     
+00042890: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000428a0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000428b0: 6c5f 6c6f 636b 5f6c 6f63 6b20 2028 2673  l_lock_lock  (&s
+000428c0: 7461 7465 2d3e 7368 6172 6564 2d3e 7370  tate->shared->sp
+000428d0: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
+000428e0: 2020 2020 2067 676d 6c5f 6c6f 636b 5f75       ggml_lock_u
+000428f0: 6e6c 6f63 6b28 2673 7461 7465 2d3e 7368  nlock(&state->sh
+00042900: 6172 6564 2d3e 7370 696e 293b 0a20 2020  ared->spin);.   
+00042910: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00042920: 2020 207d 0a0a 2020 2020 2020 2020 6174     }..        at
+00042930: 6f6d 6963 5f66 6574 6368 5f73 7562 2826  omic_fetch_sub(&
+00042940: 7374 6174 652d 3e73 6861 7265 642d 3e6e  state->shared->n
+00042950: 5f72 6561 6479 2c20 3129 3b0a 0a20 2020  _ready, 1);..   
+00042960: 2020 2020 202f 2f20 7761 6974 2066 6f72       // wait for
+00042970: 2077 6f72 6b0a 2020 2020 2020 2020 7768   work.        wh
+00042980: 696c 6520 2821 6174 6f6d 6963 5f6c 6f61  ile (!atomic_loa
+00042990: 6428 2673 7461 7465 2d3e 7368 6172 6564  d(&state->shared
+000429a0: 2d3e 6861 735f 776f 726b 2929 207b 0a20  ->has_work)) {. 
+000429b0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
+000429c0: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
+000429d0: 652d 3e73 6861 7265 642d 3e73 746f 7029  e->shared->stop)
+000429e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000429f0: 2020 2020 7265 7475 726e 2030 3b0a 2020      return 0;.  
+00042a00: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00042a10: 2020 2020 2020 2020 6767 6d6c 5f6c 6f63          ggml_loc
+00042a20: 6b5f 6c6f 636b 2020 2826 7374 6174 652d  k_lock  (&state-
+00042a30: 3e73 6861 7265 642d 3e73 7069 6e29 3b0a  >shared->spin);.
+00042a40: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00042a50: 5f6c 6f63 6b5f 756e 6c6f 636b 2826 7374  _lock_unlock(&st
+00042a60: 6174 652d 3e73 6861 7265 642d 3e73 7069  ate->shared->spi
+00042a70: 6e29 3b0a 2020 2020 2020 2020 7d0a 0a20  n);.        }.. 
+00042a80: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
+00042a90: 6966 2077 6520 7368 6f75 6c64 2073 746f  if we should sto
+00042aa0: 700a 2020 2020 2020 2020 6966 2028 6174  p.        if (at
+00042ab0: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
+00042ac0: 2d3e 7368 6172 6564 2d3e 7374 6f70 2929  ->shared->stop))
+00042ad0: 207b 0a20 2020 2020 2020 2020 2020 2062   {.            b
+00042ae0: 7265 616b 3b0a 2020 2020 2020 2020 7d0a  reak;.        }.
+00042af0: 0a20 2020 2020 2020 2069 6620 2873 7461  .        if (sta
+00042b00: 7465 2d3e 6e6f 6465 2920 7b0a 2020 2020  te->node) {.    
+00042b10: 2020 2020 2020 2020 6966 2028 7374 6174          if (stat
+00042b20: 652d 3e70 6172 616d 732e 6974 6820 3c20  e->params.ith < 
+00042b30: 7374 6174 652d 3e70 6172 616d 732e 6e74  state->params.nt
+00042b40: 6829 207b 0a20 2020 2020 2020 2020 2020  h) {.           
+00042b50: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00042b60: 655f 666f 7277 6172 6428 2673 7461 7465  e_forward(&state
+00042b70: 2d3e 7061 7261 6d73 2c20 7374 6174 652d  ->params, state-
+00042b80: 3e6e 6f64 6529 3b0a 2020 2020 2020 2020  >node);.        
+00042b90: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00042ba0: 2020 2073 7461 7465 2d3e 6e6f 6465 203d     state->node =
+00042bb0: 204e 554c 4c3b 0a20 2020 2020 2020 207d   NULL;.        }
+00042bc0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00042bd0: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
+00042be0: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+00042bf0: 7265 7475 726e 2030 3b0a 7d0a 0a76 6f69  return 0;.}..voi
+00042c00: 6420 6767 6d6c 5f67 7261 7068 5f63 6f6d  d ggml_graph_com
+00042c10: 7075 7465 2873 7472 7563 7420 6767 6d6c  pute(struct ggml
+00042c20: 5f63 6f6e 7465 7874 202a 2063 7478 2c20  _context * ctx, 
+00042c30: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+00042c40: 7068 202a 2063 6772 6170 6829 207b 0a20  ph * cgraph) {. 
+00042c50: 2020 2063 6f6e 7374 2069 6e74 206e 5f74     const int n_t
+00042c60: 6872 6561 6473 203d 2063 6772 6170 682d  hreads = cgraph-
+00042c70: 3e6e 5f74 6872 6561 6473 3b0a 0a20 2020  >n_threads;..   
+00042c80: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00042c90: 7075 7465 5f73 7461 7465 5f73 6861 7265  pute_state_share
+00042ca0: 6420 7374 6174 655f 7368 6172 6564 203d  d state_shared =
+00042cb0: 207b 0a20 2020 2020 2020 202f 2a2e 7370   {.        /*.sp
+00042cc0: 696e 2020 2020 2020 3d2a 2f20 4747 4d4c  in      =*/ GGML
+00042cd0: 5f4c 4f43 4b5f 494e 4954 4941 4c49 5a45  _LOCK_INITIALIZE
+00042ce0: 522c 0a20 2020 2020 2020 202f 2a2e 6e5f  R,.        /*.n_
+00042cf0: 7468 7265 6164 7320 3d2a 2f20 6e5f 7468  threads =*/ n_th
+00042d00: 7265 6164 732c 0a20 2020 2020 2020 202f  reads,.        /
+00042d10: 2a2e 6e5f 7265 6164 7920 2020 3d2a 2f20  *.n_ready   =*/ 
+00042d20: 302c 0a20 2020 2020 2020 202f 2a2e 6861  0,.        /*.ha
+00042d30: 735f 776f 726b 2020 3d2a 2f20 6661 6c73  s_work  =*/ fals
+00042d40: 652c 0a20 2020 2020 2020 202f 2a2e 7374  e,.        /*.st
+00042d50: 6f70 2020 2020 2020 3d2a 2f20 6661 6c73  op      =*/ fals
+00042d60: 652c 0a20 2020 207d 3b0a 2020 2020 7374  e,.    };.    st
+00042d70: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00042d80: 655f 7374 6174 6520 2a20 776f 726b 6572  e_state * worker
+00042d90: 7320 3d20 6e5f 7468 7265 6164 7320 3e20  s = n_threads > 
+00042da0: 3120 3f20 616c 6c6f 6361 2873 697a 656f  1 ? alloca(sizeo
+00042db0: 6628 7374 7275 6374 2067 676d 6c5f 636f  f(struct ggml_co
+00042dc0: 6d70 7574 655f 7374 6174 6529 2a28 6e5f  mpute_state)*(n_
+00042dd0: 7468 7265 6164 7320 2d20 3129 2920 3a20  threads - 1)) : 
+00042de0: 4e55 4c4c 3b0a 0a20 2020 202f 2f20 6372  NULL;..    // cr
+00042df0: 6561 7465 2074 6872 6561 6420 706f 6f6c  eate thread pool
+00042e00: 0a20 2020 2069 6620 286e 5f74 6872 6561  .    if (n_threa
+00042e10: 6473 203e 2031 2920 7b0a 2020 2020 2020  ds > 1) {.      
+00042e20: 2020 6767 6d6c 5f6c 6f63 6b5f 696e 6974    ggml_lock_init
+00042e30: 2826 7374 6174 655f 7368 6172 6564 2e73  (&state_shared.s
+00042e40: 7069 6e29 3b0a 0a20 2020 2020 2020 2061  pin);..        a
+00042e50: 746f 6d69 635f 7374 6f72 6528 2673 7461  tomic_store(&sta
+00042e60: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
+00042e70: 726b 2c20 7472 7565 293b 0a0a 2020 2020  rk, true);..    
+00042e80: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+00042e90: 2030 3b20 6a20 3c20 6e5f 7468 7265 6164   0; j < n_thread
+00042ea0: 7320 2d20 313b 206a 2b2b 2920 7b0a 2020  s - 1; j++) {.  
+00042eb0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00042ec0: 735b 6a5d 203d 2028 7374 7275 6374 2067  s[j] = (struct g
+00042ed0: 676d 6c5f 636f 6d70 7574 655f 7374 6174  gml_compute_stat
+00042ee0: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
+00042ef0: 2020 2020 202e 7468 7264 2020 203d 2030       .thrd   = 0
+00042f00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00042f10: 2020 2e70 6172 616d 7320 3d20 7b0a 2020    .params = {.  
+00042f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042f30: 2020 2e74 7970 6520 203d 2047 474d 4c5f    .type  = GGML_
+00042f40: 5441 534b 5f43 4f4d 5055 5445 2c0a 2020  TASK_COMPUTE,.  
+00042f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042f60: 2020 2e69 7468 2020 203d 206a 202b 2031    .ith   = j + 1
+00042f70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00042f80: 2020 2020 2020 2e6e 7468 2020 203d 206e        .nth   = n
+00042f90: 5f74 6872 6561 6473 2c0a 2020 2020 2020  _threads,.      
+00042fa0: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
+00042fb0: 7369 7a65 203d 2063 6772 6170 682d 3e77  size = cgraph->w
+00042fc0: 6f72 6b20 3f20 6767 6d6c 5f6e 6279 7465  ork ? ggml_nbyte
+00042fd0: 7328 6367 7261 7068 2d3e 776f 726b 2920  s(cgraph->work) 
+00042fe0: 3a20 302c 0a20 2020 2020 2020 2020 2020  : 0,.           
+00042ff0: 2020 2020 2020 2020 202e 7764 6174 6120           .wdata 
+00043000: 3d20 6367 7261 7068 2d3e 776f 726b 203f  = cgraph->work ?
+00043010: 2063 6772 6170 682d 3e77 6f72 6b2d 3e64   cgraph->work->d
+00043020: 6174 6120 3a20 4e55 4c4c 2c0a 2020 2020  ata : NULL,.    
+00043030: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00043040: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00043050: 6e6f 6465 2020 203d 204e 554c 4c2c 0a20  node   = NULL,. 
+00043060: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00043070: 7368 6172 6564 203d 2026 7374 6174 655f  shared = &state_
+00043080: 7368 6172 6564 2c0a 2020 2020 2020 2020  shared,.        
+00043090: 2020 2020 7d3b 0a0a 2020 2020 2020 2020      };..        
+000430a0: 2020 2020 696e 7420 7263 203d 2067 676d      int rc = ggm
+000430b0: 6c5f 7468 7265 6164 5f63 7265 6174 6528  l_thread_create(
+000430c0: 2677 6f72 6b65 7273 5b6a 5d2e 7468 7264  &workers[j].thrd
+000430d0: 2c20 4e55 4c4c 2c20 6767 6d6c 5f67 7261  , NULL, ggml_gra
+000430e0: 7068 5f63 6f6d 7075 7465 5f74 6872 6561  ph_compute_threa
+000430f0: 642c 2026 776f 726b 6572 735b 6a5d 293b  d, &workers[j]);
+00043100: 0a20 2020 2020 2020 2020 2020 2047 474d  .            GGM
+00043110: 4c5f 4153 5345 5254 2872 6320 3d3d 2030  L_ASSERT(rc == 0
+00043120: 293b 0a20 2020 2020 2020 2020 2020 2055  );.            U
+00043130: 4e55 5345 4428 7263 293b 0a20 2020 2020  NUSED(rc);.     
+00043140: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+00043150: 2f2f 2069 6e69 7469 616c 697a 6520 7461  // initialize ta
+00043160: 736b 7320 2b20 776f 726b 2062 7566 6665  sks + work buffe
+00043170: 720a 2020 2020 7b0a 2020 2020 2020 2020  r.    {.        
+00043180: 7369 7a65 5f74 2077 6f72 6b5f 7369 7a65  size_t work_size
+00043190: 203d 2030 3b0a 0a20 2020 2020 2020 202f   = 0;..        /
+000431a0: 2f20 7468 7265 6164 2073 6368 6564 756c  / thread schedul
+000431b0: 696e 6720 666f 7220 7468 6520 6469 6666  ing for the diff
+000431c0: 6572 656e 7420 6f70 6572 6174 696f 6e73  erent operations
+000431d0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+000431e0: 7420 6920 3d20 303b 2069 203c 2063 6772  t i = 0; i < cgr
+000431f0: 6170 682d 3e6e 5f6e 6f64 6573 3b20 692b  aph->n_nodes; i+
+00043200: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00043210: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00043220: 736f 7220 2a20 6e6f 6465 203d 2063 6772  sor * node = cgr
+00043230: 6170 682d 3e6e 6f64 6573 5b69 5d3b 0a0a  aph->nodes[i];..
+00043240: 2020 2020 2020 2020 2020 2020 7377 6974              swit
+00043250: 6368 2028 6e6f 6465 2d3e 6f70 2920 7b0a  ch (node->op) {.
+00043260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043270: 6361 7365 2047 474d 4c5f 4f50 5f44 5550  case GGML_OP_DUP
+00043280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00043290: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000432a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000432b0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
+000432c0: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+000432d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000432e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000432f0: 6361 7365 2047 474d 4c5f 4f50 5f41 4444  case GGML_OP_ADD
+00043300: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00043310: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00043320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043330: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
+00043340: 6e5f 7468 7265 6164 733b 0a20 2020 2020  n_threads;.     
+00043350: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00043360: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00043370: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00043380: 4c5f 4f50 5f53 5542 3a0a 2020 2020 2020  L_OP_SUB:.      
+00043390: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+000433a0: 474d 4c5f 4f50 5f4d 554c 3a0a 2020 2020  GML_OP_MUL:.    
+000433b0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+000433c0: 2047 474d 4c5f 4f50 5f44 4956 3a0a 2020   GGML_OP_DIV:.  
+000433d0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+000433e0: 7365 2047 474d 4c5f 4f50 5f53 5152 3a0a  se GGML_OP_SQR:.
+000433f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043400: 6361 7365 2047 474d 4c5f 4f50 5f53 5152  case GGML_OP_SQR
+00043410: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
+00043420: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00043430: 5355 4d3a 0a20 2020 2020 2020 2020 2020  SUM:.           
+00043440: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00043450: 505f 4d45 414e 3a0a 2020 2020 2020 2020  P_MEAN:.        
+00043460: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00043470: 4c5f 4f50 5f52 4550 4541 543a 0a20 2020  L_OP_REPEAT:.   
+00043480: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00043490: 6520 4747 4d4c 5f4f 505f 4142 533a 0a20  e GGML_OP_ABS:. 
+000434a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000434b0: 6173 6520 4747 4d4c 5f4f 505f 5347 4e3a  ase GGML_OP_SGN:
+000434c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000434d0: 2063 6173 6520 4747 4d4c 5f4f 505f 4e45   case GGML_OP_NE
+000434e0: 473a 0a20 2020 2020 2020 2020 2020 2020  G:.             
+000434f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00043500: 5354 4550 3a0a 2020 2020 2020 2020 2020  STEP:.          
+00043510: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00043520: 4f50 5f52 454c 553a 0a20 2020 2020 2020  OP_RELU:.       
+00043530: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
 00043540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043550: 2020 2020 2020 2020 2020 6767 6d6c 5f6d            ggml_m
-00043560: 756c 2863 7478 2c0a 2020 2020 2020 2020  ul(ctx,.        
-00043570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043580: 2020 2020 2020 2020 6767 6d6c 5f73 7465          ggml_ste
-00043590: 7028 6374 782c 2073 7263 3029 2c0a 2020  p(ctx, src0),.  
-000435a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000435b0: 2020 2020 2020 2020 2020 2020 2020 7465                te
-000435c0: 6e73 6f72 2d3e 6772 6164 292c 0a20 2020  nsor->grad),.   
-000435d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000435e0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-000435f0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00043600: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00043610: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00043620: 2020 6361 7365 2047 474d 4c5f 4f50 5f47    case GGML_OP_G
-00043630: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
-00043640: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00043650: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00043660: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-00043670: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
-00043680: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00043690: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000436a0: 6520 4747 4d4c 5f4f 505f 5349 4c55 3a0a  e GGML_OP_SILU:.
-000436b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000436c0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000436d0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-000436e0: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-000436f0: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-00043700: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00043710: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00043720: 4c5f 4f50 5f4e 4f52 4d3a 0a20 2020 2020  L_OP_NORM:.     
-00043730: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00043740: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00043750: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
-00043760: 544f 444f 3a20 6e6f 7420 696d 706c 656d  TODO: not implem
-00043770: 656e 7465 640a 2020 2020 2020 2020 2020  ented.          
-00043780: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00043790: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000437a0: 524d 535f 4e4f 524d 3a0a 2020 2020 2020  RMS_NORM:.      
-000437b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000437c0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-000437d0: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-000437e0: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-000437f0: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-00043800: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00043810: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-00043820: 554c 5f4d 4154 3a0a 2020 2020 2020 2020  UL_MAT:.        
-00043830: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00043840: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-00043850: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-00043860: 2020 2020 2020 2020 2020 2020 2f2f 2054              // T
-00043870: 4f44 4f3a 2074 6869 7320 7265 7175 6972  ODO: this requir
-00043880: 6573 206f 7574 6572 2070 726f 6475 6374  es outer product
-00043890: 202d 2067 676d 6c5f 6f75 745f 7072 6f64   - ggml_out_prod
-000438a0: 2863 7478 2c20 7372 6331 2c20 7465 6e73  (ctx, src1, tens
-000438b0: 6f72 2d3e 6772 6164 293b 0a20 2020 2020  or->grad);.     
-000438c0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000438d0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000438e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000438f0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00043900: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
-00043910: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-00043920: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-00043930: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
-00043940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043950: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-00043960: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00043970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043980: 2020 2073 7263 312d 3e67 7261 642c 0a20     src1->grad,. 
-00043990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000439a0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-000439b0: 2f20 544f 444f 3a20 6669 7820 7472 616e  / TODO: fix tran
-000439c0: 7370 6f73 652c 2074 6865 206e 6f64 6520  spose, the node 
-000439d0: 7769 6c6c 2062 7265 616b 2074 6865 2067  will break the g
-000439e0: 7261 7068 2063 6f6e 6e65 6374 696f 6e73  raph connections
-000439f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043a10: 2067 676d 6c5f 6d75 6c5f 6d61 7428 6374   ggml_mul_mat(ct
-00043a20: 782c 2067 676d 6c5f 7472 616e 7370 6f73  x, ggml_transpos
-00043a30: 6528 6374 782c 2073 7263 3029 2c20 7465  e(ctx, src0), te
-00043a40: 6e73 6f72 2d3e 6772 6164 292c 0a20 2020  nsor->grad),.   
-00043a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043a60: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00043a70: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-00043a80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00043a90: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00043aa0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00043ab0: 4f50 5f53 4341 4c45 3a0a 2020 2020 2020  OP_SCALE:.      
-00043ac0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00043ad0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00043ae0: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-00043af0: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-00043b00: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-00043b10: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00043b20: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-00043b30: 5059 3a0a 2020 2020 2020 2020 2020 2020  PY:.            
-00043b40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00043b50: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00043b60: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
-00043b70: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
-00043b80: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00043b90: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00043ba0: 2047 474d 4c5f 4f50 5f52 4553 4841 5045   GGML_OP_RESHAPE
-00043bb0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00043550: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+00043560: 6173 6b73 203d 2031 3b0a 2020 2020 2020  asks = 1;.      
+00043570: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+00043580: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+00043590: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000435a0: 5f4f 505f 4745 4c55 3a0a 2020 2020 2020  _OP_GELU:.      
+000435b0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000435c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000435d0: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+000435e0: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+000435f0: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
+00043600: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00043610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043620: 6361 7365 2047 474d 4c5f 4f50 5f53 494c  case GGML_OP_SIL
+00043630: 553a 0a20 2020 2020 2020 2020 2020 2020  U:.             
+00043640: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00043650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043660: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
+00043670: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
+00043680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043690: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+000436a0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+000436b0: 4d4c 5f4f 505f 4e4f 524d 3a0a 2020 2020  ML_OP_NORM:.    
+000436c0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+000436d0: 2047 474d 4c5f 4f50 5f52 4d53 5f4e 4f52   GGML_OP_RMS_NOR
+000436e0: 4d3a 0a20 2020 2020 2020 2020 2020 2020  M:.             
+000436f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00043700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043710: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
+00043720: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
+00043730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043740: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00043750: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00043760: 4d4c 5f4f 505f 4d55 4c5f 4d41 543a 0a20  ML_OP_MUL_MAT:. 
+00043770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043780: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00043790: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+000437a0: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
+000437b0: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
+000437c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000437d0: 202f 2f20 544f 444f 3a20 7573 6520 6469   // TODO: use di
+000437e0: 6666 6572 656e 7420 7363 6865 6475 6c69  fferent scheduli
+000437f0: 6e67 2066 6f72 2064 6966 6665 7265 6e74  ng for different
+00043800: 206d 6174 7269 7820 7369 7a65 730a 2020   matrix sizes.  
+00043810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043820: 2020 2020 2020 2f2f 636f 6e73 7420 696e        //const in
+00043830: 7420 6e72 3020 3d20 6767 6d6c 5f6e 726f  t nr0 = ggml_nro
+00043840: 7773 286e 6f64 652d 3e73 7263 3029 3b0a  ws(node->src0);.
+00043850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043860: 2020 2020 2020 2020 2f2f 636f 6e73 7420          //const 
+00043870: 696e 7420 6e72 3120 3d20 6767 6d6c 5f6e  int nr1 = ggml_n
+00043880: 726f 7773 286e 6f64 652d 3e73 7263 3129  rows(node->src1)
+00043890: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000438a0: 2020 2020 2020 2020 2020 202f 2f6e 6f64             //nod
+000438b0: 652d 3e6e 5f74 6173 6b73 203d 204d 494e  e->n_tasks = MIN
+000438c0: 286e 5f74 6872 6561 6473 2c20 4d41 5828  (n_threads, MAX(
+000438d0: 312c 206e 7230 2f31 3238 2929 3b0a 2020  1, nr0/128));.  
+000438e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000438f0: 2020 2020 2020 2f2f 7072 696e 7466 2822        //printf("
+00043900: 6e72 3020 3d20 2538 642c 206e 7231 203d  nr0 = %8d, nr1 =
+00043910: 2025 3864 2c20 6e72 302a 6e72 3120 3d20   %8d, nr0*nr1 = 
+00043920: 2538 642c 206e 5f74 6173 6b73 203d 2025  %8d, n_tasks = %
+00043930: 645c 6e22 2c20 6e72 302c 206e 7231 2c20  d\n", nr0, nr1, 
+00043940: 6e72 302a 6e72 312c 206e 6f64 652d 3e6e  nr0*nr1, node->n
+00043950: 5f74 6173 6b73 293b 0a0a 2020 2020 2020  _tasks);..      
+00043960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043970: 2020 7369 7a65 5f74 2063 7572 203d 2030    size_t cur = 0
+00043980: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00043990: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
+000439a0: 6f64 652d 3e73 7263 302d 3e74 7970 6520  ode->src0->type 
+000439b0: 3d3d 2047 474d 4c5f 5459 5045 5f46 3136  == GGML_TYPE_F16
+000439c0: 2026 2620 6e6f 6465 2d3e 7372 6331 2d3e   && node->src1->
+000439d0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+000439e0: 455f 4633 3229 207b 0a23 6966 2064 6566  E_F32) {.#if def
+000439f0: 696e 6564 2847 474d 4c5f 5553 455f 4143  ined(GGML_USE_AC
+00043a00: 4345 4c45 5241 5445 2920 7c7c 2064 6566  CELERATE) || def
+00043a10: 696e 6564 2847 474d 4c5f 5553 455f 4f50  ined(GGML_USE_OP
+00043a20: 454e 424c 4153 290a 2020 2020 2020 2020  ENBLAS).        
+00043a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043a40: 2020 2020 6966 2028 6767 6d6c 5f63 6f6d      if (ggml_com
+00043a50: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+00043a60: 5f6d 6174 5f75 7365 5f62 6c61 7328 6e6f  _mat_use_blas(no
+00043a70: 6465 2d3e 7372 6330 2c20 6e6f 6465 2d3e  de->src0, node->
+00043a80: 7372 6331 2c20 6e6f 6465 2929 207b 0a20  src1, node)) {. 
+00043a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043aa0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00043ab0: 6f64 652d 3e6e 5f74 6173 6b73 203d 2031  ode->n_tasks = 1
+00043ac0: 3b20 2f2f 2054 4f44 4f3a 2074 6869 7320  ; // TODO: this 
+00043ad0: 6163 7475 616c 6c79 2069 7320 646f 696e  actually is doin
+00043ae0: 6720 6e6f 7468 696e 670a 2020 2020 2020  g nothing.      
+00043af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043b10: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00043b20: 2020 2020 2020 7468 6520 7468 7265 6164        the thread
+00043b30: 7320 6172 6520 7374 696c 6c20 7370 696e  s are still spin
+00043b40: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+00043b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043b60: 2020 2020 2063 7572 203d 2047 474d 4c5f       cur = GGML_
+00043b70: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
+00043b80: 5950 455f 4633 325d 2a28 6e6f 6465 2d3e  YPE_F32]*(node->
+00043b90: 7372 6330 2d3e 6e65 5b30 5d2a 6e6f 6465  src0->ne[0]*node
+00043ba0: 2d3e 7372 6330 2d3e 6e65 5b31 5d29 3b0a  ->src0->ne[1]);.
+00043bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00043bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043bd0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00043be0: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-00043bf0: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-00043c00: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00043c10: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00043c20: 474d 4c5f 4f50 5f56 4945 573a 0a20 2020  GML_OP_VIEW:.   
-00043c30: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00043c40: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00043c50: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-00043c60: 2f20 6e6f 7420 7375 7070 6f72 7465 640a  / not supported.
-00043c70: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00043c80: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00043c90: 6520 4747 4d4c 5f4f 505f 5045 524d 5554  e GGML_OP_PERMUT
-00043ca0: 453a 0a20 2020 2020 2020 2020 2020 207b  E:.            {
-00043cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043cc0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00043cd0: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
-00043ce0: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
-00043cf0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00043d00: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00043d10: 4747 4d4c 5f4f 505f 5452 414e 5350 4f53  GGML_OP_TRANSPOS
-00043d20: 453a 0a20 2020 2020 2020 2020 2020 207b  E:.            {
-00043d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043d40: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00043d50: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
-00043d60: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
-00043d70: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00043d80: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00043d90: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-00043da0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00043bd0: 2f2f 7072 696e 7466 2822 7372 6330 3a20  //printf("src0: 
+00043be0: 6e65 3020 3d20 2564 2c20 6e65 3120 3d20  ne0 = %d, ne1 = 
+00043bf0: 2564 2c20 6e65 203d 2025 645c 6e22 2c20  %d, ne = %d\n", 
+00043c00: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b30  node->src0->ne[0
+00043c10: 5d2c 206e 6f64 652d 3e73 7263 302d 3e6e  ], node->src0->n
+00043c20: 655b 315d 2c20 6e6f 6465 2d3e 7372 6330  e[1], node->src0
+00043c30: 2d3e 6e65 5b30 5d2a 6e6f 6465 2d3e 7372  ->ne[0]*node->sr
+00043c40: 6330 2d3e 6e65 5b31 5d29 3b0a 2020 2020  c0->ne[1]);.    
+00043c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043c60: 2020 2020 2020 2020 2020 2020 2f2f 7072              //pr
+00043c70: 696e 7466 2822 7372 6331 3a20 6e65 3020  intf("src1: ne0 
+00043c80: 3d20 2564 2c20 6e65 3120 3d20 2564 2c20  = %d, ne1 = %d, 
+00043c90: 6e65 203d 2025 645c 6e22 2c20 6e6f 6465  ne = %d\n", node
+00043ca0: 2d3e 7372 6331 2d3e 6e65 5b30 5d2c 206e  ->src1->ne[0], n
+00043cb0: 6f64 652d 3e73 7263 312d 3e6e 655b 315d  ode->src1->ne[1]
+00043cc0: 2c20 6e6f 6465 2d3e 7372 6331 2d3e 6e65  , node->src1->ne
+00043cd0: 5b30 5d2a 6e6f 6465 2d3e 7372 6331 2d3e  [0]*node->src1->
+00043ce0: 6e65 5b31 5d29 3b0a 2020 2020 2020 2020  ne[1]);.        
+00043cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043d00: 2020 2020 2020 2020 2f2f 7072 696e 7466          //printf
+00043d10: 2822 6375 7220 3d20 257a 755c 6e22 2c20  ("cur = %zu\n", 
+00043d20: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
+00043d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043d40: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00043d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043d60: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
+00043d70: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+00043d80: 4747 4d4c 5f54 5950 455f 4631 365d 2a67  GGML_TYPE_F16]*g
+00043d90: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6e6f  gml_nelements(no
+00043da0: 6465 2d3e 7372 6331 293b 0a20 2020 2020  de->src1);.     
 00043db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043dc0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00043dd0: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-00043de0: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-00043df0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00043e00: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00043e10: 474d 4c5f 4f50 5f44 4941 475f 4d41 534b  GML_OP_DIAG_MASK
-00043e20: 5f49 4e46 3a0a 2020 2020 2020 2020 2020  _INF:.          
-00043e30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00043e40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00043e50: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-00043e60: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-00043e70: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00043e80: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00043e90: 7365 2047 474d 4c5f 4f50 5f53 4f46 545f  se GGML_OP_SOFT_
-00043ea0: 4d41 583a 0a20 2020 2020 2020 2020 2020  MAX:.           
-00043eb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00043ec0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00043ed0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-00043ee0: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
-00043ef0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00043f00: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00043f10: 6520 4747 4d4c 5f4f 505f 524f 5045 3a0a  e GGML_OP_ROPE:.
-00043f20: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00043f30: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00043f40: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00043f50: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-00043f60: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-00043f70: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00043f80: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00043f90: 4c5f 4f50 5f43 4f4e 565f 3144 5f31 533a  L_OP_CONV_1D_1S:
-00043fa0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00043fb0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00043fc0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00043fd0: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
-00043fe0: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
-00043ff0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00044000: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00044010: 4d4c 5f4f 505f 434f 4e56 5f31 445f 3253  ML_OP_CONV_1D_2S
-00044020: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00044030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044040: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00044050: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-00044060: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-00044070: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00044080: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00044090: 474d 4c5f 4f50 5f46 4c41 5348 5f41 5454  GML_OP_FLASH_ATT
-000440a0: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
-000440b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000440c0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-000440d0: 7365 293b 202f 2f20 6e6f 7420 7375 7070  se); // not supp
-000440e0: 6f72 7465 640a 2020 2020 2020 2020 2020  orted.          
-000440f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00044100: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00044110: 464c 4153 485f 4646 3a0a 2020 2020 2020  FLASH_FF:.      
-00044120: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00044130: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00044140: 4552 5428 6661 6c73 6529 3b20 2f2f 206e  ERT(false); // n
-00044150: 6f74 2073 7570 706f 7274 6564 0a20 2020  ot supported.   
-00044160: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00044170: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00044180: 474d 4c5f 4f50 5f4e 4f4e 453a 0a20 2020  GML_OP_NONE:.   
-00044190: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000441a0: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
-000441b0: 700a 2020 2020 2020 2020 2020 2020 7d20  p.            } 
-000441c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000441d0: 6173 6520 4747 4d4c 5f4f 505f 434f 554e  ase GGML_OP_COUN
-000441e0: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-000441f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044200: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00044210: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00044220: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00044230: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00044240: 676d 6c5f 7669 7369 745f 7061 7265 6e74  gml_visit_parent
-00044250: 7328 7374 7275 6374 2067 676d 6c5f 6367  s(struct ggml_cg
-00044260: 7261 7068 202a 2063 6772 6170 682c 2073  raph * cgraph, s
-00044270: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00044280: 7220 2a20 6e6f 6465 2920 7b0a 2020 2020  r * node) {.    
-00044290: 6966 2028 6e6f 6465 2d3e 6772 6164 203d  if (node->grad =
-000442a0: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-000442b0: 2020 2f2f 2074 6869 7320 7573 7561 6c6c    // this usuall
-000442c0: 7920 6861 7070 656e 7320 7768 656e 2077  y happens when w
-000442d0: 6520 6765 6e65 7261 7465 2069 6e74 6572  e generate inter
-000442e0: 6d65 6469 6174 6520 6e6f 6465 7320 6672  mediate nodes fr
-000442f0: 6f6d 2063 6f6e 7374 616e 7473 2069 6e20  om constants in 
-00044300: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
-00044310: 730a 2020 2020 2020 2020 2f2f 2069 7420  s.        // it 
-00044320: 6361 6e20 616c 736f 2068 6170 7065 6e20  can also happen 
-00044330: 6475 7269 6e67 2066 6f72 7761 7264 2070  during forward p
-00044340: 6173 732c 2069 6620 7468 6520 7573 6572  ass, if the user
-00044350: 2070 6572 666f 726d 7320 636f 6d70 7574   performs comput
-00044360: 6174 696f 6e73 2077 6974 6820 636f 6e73  ations with cons
-00044370: 7461 6e74 730a 2020 2020 2020 2020 6966  tants.        if
-00044380: 2028 6e6f 6465 2d3e 6f70 2021 3d20 4747   (node->op != GG
-00044390: 4d4c 5f4f 505f 4e4f 4e45 2920 7b0a 2020  ML_OP_NONE) {.  
-000443a0: 2020 2020 2020 2020 2020 2f2f 4747 4d4c            //GGML
-000443b0: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
-000443c0: 3a20 7761 726e 696e 673a 206e 6f64 6520  : warning: node 
-000443d0: 2570 2068 6173 206e 6f20 6772 6164 2c20  %p has no grad, 
-000443e0: 6275 7420 6f70 2025 645c 6e22 2c20 5f5f  but op %d\n", __
-000443f0: 6675 6e63 5f5f 2c20 2876 6f69 6420 2a29  func__, (void *)
-00044400: 206e 6f64 652c 206e 6f64 652d 3e6f 7029   node, node->op)
-00044410: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-00044420: 7d0a 0a20 2020 202f 2f20 6368 6563 6b20  }..    // check 
-00044430: 6966 2061 6c72 6561 6479 2076 6973 6974  if already visit
-00044440: 6564 0a20 2020 2066 6f72 2028 696e 7420  ed.    for (int 
-00044450: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
-00044460: 682d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  h->n_nodes; i++)
-00044470: 207b 0a20 2020 2020 2020 2069 6620 2863   {.        if (c
-00044480: 6772 6170 682d 3e6e 6f64 6573 5b69 5d20  graph->nodes[i] 
-00044490: 3d3d 206e 6f64 6529 207b 0a20 2020 2020  == node) {.     
-000444a0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-000444b0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-000444c0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-000444d0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
-000444e0: 6e5f 6c65 6166 733b 2069 2b2b 2920 7b0a  n_leafs; i++) {.
-000444f0: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
-00044500: 7068 2d3e 6c65 6166 735b 695d 203d 3d20  ph->leafs[i] == 
-00044510: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
-00044520: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00044530: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-00044540: 2069 6620 286e 6f64 652d 3e73 7263 3029   if (node->src0)
-00044550: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
-00044560: 7669 7369 745f 7061 7265 6e74 7328 6367  visit_parents(cg
-00044570: 7261 7068 2c20 6e6f 6465 2d3e 7372 6330  raph, node->src0
-00044580: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
-00044590: 2028 6e6f 6465 2d3e 7372 6331 2920 7b0a   (node->src1) {.
-000445a0: 2020 2020 2020 2020 6767 6d6c 5f76 6973          ggml_vis
-000445b0: 6974 5f70 6172 656e 7473 2863 6772 6170  it_parents(cgrap
-000445c0: 682c 206e 6f64 652d 3e73 7263 3129 3b0a  h, node->src1);.
-000445d0: 2020 2020 7d0a 0a20 2020 2066 6f72 2028      }..    for (
-000445e0: 696e 7420 6920 3d20 303b 2069 203c 2047  int i = 0; i < G
-000445f0: 474d 4c5f 4d41 585f 4f50 543b 202b 2b69  GML_MAX_OPT; ++i
-00044600: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
-00044610: 6e6f 6465 2d3e 6f70 745b 695d 2920 7b0a  node->opt[i]) {.
-00044620: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00044630: 5f76 6973 6974 5f70 6172 656e 7473 2863  _visit_parents(c
-00044640: 6772 6170 682c 206e 6f64 652d 3e6f 7074  graph, node->opt
-00044650: 5b69 5d29 3b0a 2020 2020 2020 2020 7d0a  [i]);.        }.
-00044660: 2020 2020 7d0a 0a20 2020 2069 6620 286e      }..    if (n
-00044670: 6f64 652d 3e6f 7020 3d3d 2047 474d 4c5f  ode->op == GGML_
-00044680: 4f50 5f4e 4f4e 4520 2626 206e 6f64 652d  OP_NONE && node-
-00044690: 3e67 7261 6420 3d3d 204e 554c 4c29 207b  >grad == NULL) {
-000446a0: 0a20 2020 2020 2020 202f 2f20 7265 6163  .        // reac
-000446b0: 6865 6420 6120 6c65 6166 206e 6f64 652c  hed a leaf node,
-000446c0: 206e 6f74 2070 6172 7420 6f66 2074 6865   not part of the
-000446d0: 2067 7261 6469 656e 7420 6772 6170 6820   gradient graph 
-000446e0: 2865 2e67 2e20 6120 636f 6e73 7461 6e74  (e.g. a constant
-000446f0: 290a 2020 2020 2020 2020 4747 4d4c 5f41  ).        GGML_A
-00044700: 5353 4552 5428 6367 7261 7068 2d3e 6e5f  SSERT(cgraph->n_
-00044710: 6c65 6166 7320 3c20 4747 4d4c 5f4d 4158  leafs < GGML_MAX
-00044720: 5f4e 4f44 4553 293b 0a0a 2020 2020 2020  _NODES);..      
-00044730: 2020 6367 7261 7068 2d3e 6c65 6166 735b    cgraph->leafs[
-00044740: 6367 7261 7068 2d3e 6e5f 6c65 6166 735d  cgraph->n_leafs]
-00044750: 203d 206e 6f64 653b 0a20 2020 2020 2020   = node;.       
-00044760: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
-00044770: 2b2b 3b0a 2020 2020 7d20 656c 7365 207b  ++;.    } else {
-00044780: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
-00044790: 5345 5254 2863 6772 6170 682d 3e6e 5f6e  SERT(cgraph->n_n
-000447a0: 6f64 6573 203c 2047 474d 4c5f 4d41 585f  odes < GGML_MAX_
-000447b0: 4e4f 4445 5329 3b0a 0a20 2020 2020 2020  NODES);..       
-000447c0: 2063 6772 6170 682d 3e6e 6f64 6573 5b63   cgraph->nodes[c
-000447d0: 6772 6170 682d 3e6e 5f6e 6f64 6573 5d20  graph->n_nodes] 
-000447e0: 3d20 6e6f 6465 3b0a 2020 2020 2020 2020  = node;.        
-000447f0: 6367 7261 7068 2d3e 6772 6164 735b 6367  cgraph->grads[cg
-00044800: 7261 7068 2d3e 6e5f 6e6f 6465 735d 203d  raph->n_nodes] =
-00044810: 206e 6f64 652d 3e67 7261 643b 0a20 2020   node->grad;.   
-00044820: 2020 2020 2063 6772 6170 682d 3e6e 5f6e       cgraph->n_n
-00044830: 6f64 6573 2b2b 3b0a 2020 2020 7d0a 7d0a  odes++;.    }.}.
-00044840: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00044850: 6c5f 6275 696c 645f 666f 7277 6172 645f  l_build_forward_
-00044860: 696d 706c 2873 7472 7563 7420 6767 6d6c  impl(struct ggml
-00044870: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-00044880: 2c20 7374 7275 6374 2067 676d 6c5f 7465  , struct ggml_te
-00044890: 6e73 6f72 202a 2074 656e 736f 722c 2062  nsor * tensor, b
-000448a0: 6f6f 6c20 6578 7061 6e64 2920 7b0a 2020  ool expand) {.  
-000448b0: 2020 6966 2028 2165 7870 616e 6429 207b    if (!expand) {
-000448c0: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
-000448d0: 3e6e 5f6e 6f64 6573 203d 2030 3b0a 2020  >n_nodes = 0;.  
-000448e0: 2020 2020 2020 6367 7261 7068 2d3e 6e5f        cgraph->n_
-000448f0: 6c65 6166 7320 3d20 303b 0a20 2020 207d  leafs = 0;.    }
-00044900: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00044910: 6e30 203d 2063 6772 6170 682d 3e6e 5f6e  n0 = cgraph->n_n
-00044920: 6f64 6573 3b0a 2020 2020 554e 5553 4544  odes;.    UNUSED
-00044930: 286e 3029 3b0a 0a20 2020 2067 676d 6c5f  (n0);..    ggml_
-00044940: 7669 7369 745f 7061 7265 6e74 7328 6367  visit_parents(cg
-00044950: 7261 7068 2c20 7465 6e73 6f72 293b 0a0a  raph, tensor);..
-00044960: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-00044970: 6e65 7720 3d20 6367 7261 7068 2d3e 6e5f  new = cgraph->n_
-00044980: 6e6f 6465 7320 2d20 6e30 3b0a 2020 2020  nodes - n0;.    
-00044990: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-000449a0: 2822 2573 3a20 7669 7369 7465 6420 2564  ("%s: visited %d
-000449b0: 206e 6577 206e 6f64 6573 5c6e 222c 205f   new nodes\n", _
-000449c0: 5f66 756e 635f 5f2c 206e 5f6e 6577 293b  _func__, n_new);
-000449d0: 0a0a 2020 2020 6966 2028 6e5f 6e65 7720  ..    if (n_new 
-000449e0: 3e20 3029 207b 0a20 2020 2020 2020 202f  > 0) {.        /
-000449f0: 2f20 7468 6520 6c61 7374 2061 6464 6564  / the last added
-00044a00: 206e 6f64 6520 7368 6f75 6c64 2061 6c77   node should alw
-00044a10: 6179 7320 6265 2073 7461 7274 696e 6720  ays be starting 
-00044a20: 706f 696e 740a 2020 2020 2020 2020 4747  point.        GG
-00044a30: 4d4c 5f41 5353 4552 5428 6367 7261 7068  ML_ASSERT(cgraph
-00044a40: 2d3e 6e6f 6465 735b 6367 7261 7068 2d3e  ->nodes[cgraph->
-00044a50: 6e5f 6e6f 6465 7320 2d20 315d 203d 3d20  n_nodes - 1] == 
-00044a60: 7465 6e73 6f72 293b 0a20 2020 207d 0a7d  tensor);.    }.}
-00044a70: 0a0a 766f 6964 2067 676d 6c5f 6275 696c  ..void ggml_buil
-00044a80: 645f 666f 7277 6172 645f 6578 7061 6e64  d_forward_expand
-00044a90: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
-00044aa0: 6170 6820 2a20 6367 7261 7068 2c20 7374  aph * cgraph, st
-00044ab0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00044ac0: 202a 2074 656e 736f 7229 207b 0a20 2020   * tensor) {.   
-00044ad0: 2067 676d 6c5f 6275 696c 645f 666f 7277   ggml_build_forw
-00044ae0: 6172 645f 696d 706c 2863 6772 6170 682c  ard_impl(cgraph,
-00044af0: 2074 656e 736f 722c 2074 7275 6529 3b0a   tensor, true);.
-00044b00: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f63  }..struct ggml_c
-00044b10: 6772 6170 6820 6767 6d6c 5f62 7569 6c64  graph ggml_build
-00044b20: 5f66 6f72 7761 7264 2873 7472 7563 7420  _forward(struct 
-00044b30: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-00044b40: 6e73 6f72 2920 7b0a 2020 2020 7374 7275  nsor) {.    stru
-00044b50: 6374 2067 676d 6c5f 6367 7261 7068 2072  ct ggml_cgraph r
-00044b60: 6573 756c 7420 3d20 7b0a 2020 2020 2020  esult = {.      
-00044b70: 2020 2f2a 2e6e 5f6e 6f64 6573 2020 2020    /*.n_nodes    
-00044b80: 2020 3d2a 2f20 302c 0a20 2020 2020 2020    =*/ 0,.       
-00044b90: 202f 2a2e 6e5f 6c65 6166 7320 2020 2020   /*.n_leafs     
-00044ba0: 203d 2a2f 2030 2c0a 2020 2020 2020 2020   =*/ 0,.        
-00044bb0: 2f2a 2e6e 5f74 6872 6561 6473 2020 2020  /*.n_threads    
-00044bc0: 3d2a 2f20 302c 0a20 2020 2020 2020 202f  =*/ 0,.        /
-00044bd0: 2a2e 776f 726b 5f73 697a 6520 2020 203d  *.work_size    =
-00044be0: 2a2f 2030 2c0a 2020 2020 2020 2020 2f2a  */ 0,.        /*
-00044bf0: 2e77 6f72 6b20 2020 2020 2020 2020 3d2a  .work         =*
-00044c00: 2f20 4e55 4c4c 2c0a 2020 2020 2020 2020  / NULL,.        
-00044c10: 2f2a 2e6e 6f64 6573 2020 2020 2020 2020  /*.nodes        
-00044c20: 3d2a 2f20 7b20 4e55 4c4c 207d 2c0a 2020  =*/ { NULL },.  
-00044c30: 2020 2020 2020 2f2a 2e67 7261 6473 2020        /*.grads  
-00044c40: 2020 2020 2020 3d2a 2f20 7b20 4e55 4c4c        =*/ { NULL
-00044c50: 207d 2c0a 2020 2020 2020 2020 2f2a 2e6c   },.        /*.l
-00044c60: 6561 6673 2020 2020 2020 2020 3d2a 2f20  eafs        =*/ 
-00044c70: 7b20 4e55 4c4c 207d 2c0a 2020 2020 2020  { NULL },.      
-00044c80: 2020 2f2a 2e70 6572 665f 7275 6e73 2020    /*.perf_runs  
-00044c90: 2020 3d2a 2f20 302c 0a20 2020 2020 2020    =*/ 0,.       
-00044ca0: 202f 2a2e 7065 7266 5f63 7963 6c65 7320   /*.perf_cycles 
-00044cb0: 203d 2a2f 2030 2c0a 2020 2020 2020 2020   =*/ 0,.        
-00044cc0: 2f2a 2e70 6572 665f 7469 6d65 5f75 7320  /*.perf_time_us 
-00044cd0: 3d2a 2f20 302c 0a20 2020 207d 3b0a 0a20  =*/ 0,.    };.. 
-00044ce0: 2020 2067 676d 6c5f 6275 696c 645f 666f     ggml_build_fo
-00044cf0: 7277 6172 645f 696d 706c 2826 7265 7375  rward_impl(&resu
-00044d00: 6c74 2c20 7465 6e73 6f72 2c20 6661 6c73  lt, tensor, fals
-00044d10: 6529 3b0a 0a20 2020 2072 6574 7572 6e20  e);..    return 
-00044d20: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
-00044d30: 7420 6767 6d6c 5f63 6772 6170 6820 6767  t ggml_cgraph gg
-00044d40: 6d6c 5f62 7569 6c64 5f62 6163 6b77 6172  ml_build_backwar
-00044d50: 6428 7374 7275 6374 2067 676d 6c5f 636f  d(struct ggml_co
-00044d60: 6e74 6578 7420 2a20 6374 782c 2073 7472  ntext * ctx, str
-00044d70: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
-00044d80: 2a20 6766 2c20 626f 6f6c 206b 6565 7029  * gf, bool keep)
-00044d90: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
-00044da0: 6d6c 5f63 6772 6170 6820 7265 7375 6c74  ml_cgraph result
-00044db0: 203d 202a 6766 3b0a 0a20 2020 2047 474d   = *gf;..    GGM
-00044dc0: 4c5f 4153 5345 5254 2867 662d 3e6e 5f6e  L_ASSERT(gf->n_n
-00044dd0: 6f64 6573 203e 2030 293b 0a0a 2020 2020  odes > 0);..    
-00044de0: 2f2f 2069 6620 7765 2061 7265 206b 6565  // if we are kee
-00044df0: 7069 6e67 2074 6865 2067 7261 6469 656e  ping the gradien
-00044e00: 7420 6772 6170 682c 2077 6520 6861 7665  t graph, we have
-00044e10: 2074 6f20 6465 7461 6368 2074 6865 2067   to detach the g
-00044e20: 7261 6469 656e 7420 6e6f 6465 7320 6672  radient nodes fr
-00044e30: 6f6d 2074 6865 206f 7269 6769 6e61 6c20  om the original 
-00044e40: 6772 6170 680a 2020 2020 6966 2028 6b65  graph.    if (ke
-00044e50: 6570 2920 7b0a 2020 2020 2020 2020 666f  ep) {.        fo
-00044e60: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00044e70: 3c20 6766 2d3e 6e5f 6e6f 6465 733b 2069  < gf->n_nodes; i
-00044e80: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00044e90: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00044ea0: 6e73 6f72 202a 206e 6f64 6520 3d20 6766  nsor * node = gf
-00044eb0: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-00044ec0: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
-00044ed0: 652d 3e67 7261 6429 207b 0a20 2020 2020  e->grad) {.     
-00044ee0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-00044ef0: 3e67 7261 6420 3d20 6767 6d6c 5f64 7570  >grad = ggml_dup
-00044f00: 5f74 656e 736f 7228 6374 782c 206e 6f64  _tensor(ctx, nod
-00044f10: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00044f20: 2020 2020 6766 2d3e 6772 6164 735b 695d      gf->grads[i]
-00044f30: 203d 206e 6f64 652d 3e67 7261 643b 0a20   = node->grad;. 
-00044f40: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00044f50: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-00044f60: 2020 666f 7220 2869 6e74 2069 203d 2067    for (int i = g
-00044f70: 662d 3e6e 5f6e 6f64 6573 202d 2031 3b20  f->n_nodes - 1; 
-00044f80: 6920 3e3d 2030 3b20 692d 2d29 207b 0a20  i >= 0; i--) {. 
-00044f90: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00044fa0: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
-00044fb0: 203d 2067 662d 3e6e 6f64 6573 5b69 5d3b   = gf->nodes[i];
-00044fc0: 0a0a 2020 2020 2020 2020 2f2f 2062 6563  ..        // bec
-00044fd0: 6175 7365 2077 6520 6465 7461 6368 6564  ause we detached
-00044fe0: 2074 6865 2067 7261 6420 6e6f 6465 7320   the grad nodes 
-00044ff0: 6672 6f6d 2074 6865 206f 7269 6769 6e61  from the origina
-00045000: 6c20 6772 6170 682c 2077 6520 6361 6e20  l graph, we can 
-00045010: 6166 666f 7264 2069 6e70 6c61 6365 206f  afford inplace o
-00045020: 7065 7261 7469 6f6e 730a 2020 2020 2020  perations.      
-00045030: 2020 6966 2028 6e6f 6465 2d3e 6772 6164    if (node->grad
-00045040: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00045050: 6767 6d6c 5f63 6f6d 7075 7465 5f62 6163  ggml_compute_bac
-00045060: 6b77 6172 6428 6374 782c 206e 6f64 652c  kward(ctx, node,
-00045070: 206b 6565 7029 3b0a 2020 2020 2020 2020   keep);.        
-00045080: 7d0a 2020 2020 7d0a 0a20 2020 2066 6f72  }.    }..    for
-00045090: 2028 696e 7420 6920 3d20 6766 2d3e 6e5f   (int i = gf->n_
-000450a0: 6e6f 6465 7320 2d20 313b 2069 203e 3d20  nodes - 1; i >= 
-000450b0: 303b 2069 2d2d 2920 7b0a 2020 2020 2020  0; i--) {.      
-000450c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000450d0: 6e73 6f72 202a 206e 6f64 6520 3d20 6766  nsor * node = gf
-000450e0: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-000450f0: 2020 2020 2069 6620 286e 6f64 652d 3e69       if (node->i
-00045100: 735f 7061 7261 6d29 207b 0a20 2020 2020  s_param) {.     
-00045110: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-00045120: 545f 4445 4255 4728 2225 733a 2066 6f75  T_DEBUG("%s: fou
-00045130: 6e64 2072 6f6f 7420 6e6f 6465 2025 705c  nd root node %p\
-00045140: 6e22 2c20 5f5f 6675 6e63 5f5f 2c20 2876  n", __func__, (v
-00045150: 6f69 6420 2a29 206e 6f64 6529 3b0a 2020  oid *) node);.  
-00045160: 2020 2020 2020 2020 2020 6767 6d6c 5f62            ggml_b
-00045170: 7569 6c64 5f66 6f72 7761 7264 5f69 6d70  uild_forward_imp
-00045180: 6c28 2672 6573 756c 742c 206e 6f64 652d  l(&result, node-
-00045190: 3e67 7261 642c 2074 7275 6529 3b0a 2020  >grad, true);.  
-000451a0: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-000451b0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-000451c0: 3b0a 7d0a 0a2f 2f0a 2f2f 2074 6872 6561  ;.}..//.// threa
-000451d0: 6420 6461 7461 0a2f 2f0a 2f2f 2073 796e  d data.//.// syn
-000451e0: 6368 726f 6e69 7a61 7469 6f6e 2069 7320  chronization is 
-000451f0: 646f 6e65 2076 6961 2062 7573 7920 6c6f  done via busy lo
-00045200: 6f70 730a 2f2f 2049 2074 7269 6564 2075  ops.// I tried u
-00045210: 7369 6e67 2073 7069 6e20 6c6f 636b 732c  sing spin locks,
-00045220: 2062 7574 206e 6f74 2073 7572 6520 686f   but not sure ho
-00045230: 7720 746f 2075 7365 2074 6865 6d20 636f  w to use them co
-00045240: 7272 6563 746c 7920 2d20 7468 6520 7468  rrectly - the th
-00045250: 696e 6773 2049 2074 7269 6564 2077 6572  ings I tried wer
-00045260: 6520 736c 6f77 6572 2074 6861 6e20 6275  e slower than bu
-00045270: 7379 206c 6f6f 7073 0a2f 2f0a 0a23 6966  sy loops.//..#if
-00045280: 6465 6620 5f5f 4150 504c 455f 5f0a 0a2f  def __APPLE__../
-00045290: 2f23 696e 636c 7564 6520 3c6f 732f 6c6f  /#include <os/lo
-000452a0: 636b 2e68 3e0a 2f2f 0a2f 2f74 7970 6564  ck.h>.//.//typed
-000452b0: 6566 206f 735f 756e 6661 6972 5f6c 6f63  ef os_unfair_loc
-000452c0: 6b20 6767 6d6c 5f6c 6f63 6b5f 743b 0a2f  k ggml_lock_t;./
-000452d0: 2f0a 2f2f 2364 6566 696e 6520 6767 6d6c  /.//#define ggml
-000452e0: 5f6c 6f63 6b5f 696e 6974 2878 2920 2020  _lock_init(x)   
-000452f0: 2055 4e55 5345 4428 7829 0a2f 2f23 6465   UNUSED(x).//#de
-00045300: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f64  fine ggml_lock_d
-00045310: 6573 7472 6f79 2878 2920 554e 5553 4544  estroy(x) UNUSED
-00045320: 2878 290a 2f2f 2364 6566 696e 6520 6767  (x).//#define gg
-00045330: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020 2020  ml_lock_lock    
-00045340: 2020 206f 735f 756e 6661 6972 5f6c 6f63     os_unfair_loc
-00045350: 6b5f 6c6f 636b 0a2f 2f23 6465 6669 6e65  k_lock.//#define
-00045360: 2067 676d 6c5f 6c6f 636b 5f75 6e6c 6f63   ggml_lock_unloc
-00045370: 6b20 2020 2020 6f73 5f75 6e66 6169 725f  k     os_unfair_
-00045380: 6c6f 636b 5f75 6e6c 6f63 6b0a 2f2f 0a2f  lock_unlock.//./
-00045390: 2f23 6465 6669 6e65 2047 474d 4c5f 4c4f  /#define GGML_LO
-000453a0: 434b 5f49 4e49 5449 414c 495a 4552 204f  CK_INITIALIZER O
-000453b0: 535f 554e 4641 4952 5f4c 4f43 4b5f 494e  S_UNFAIR_LOCK_IN
-000453c0: 4954 0a0a 7479 7065 6465 6620 696e 7420  IT..typedef int 
-000453d0: 6767 6d6c 5f6c 6f63 6b5f 743b 0a0a 2364  ggml_lock_t;..#d
-000453e0: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-000453f0: 696e 6974 2878 2920 2020 2055 4e55 5345  init(x)    UNUSE
-00045400: 4428 7829 0a23 6465 6669 6e65 2067 676d  D(x).#define ggm
-00045410: 6c5f 6c6f 636b 5f64 6573 7472 6f79 2878  l_lock_destroy(x
-00045420: 2920 554e 5553 4544 2878 290a 2364 6566  ) UNUSED(x).#def
-00045430: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 6c6f  ine ggml_lock_lo
-00045440: 636b 2878 2920 2020 2055 4e55 5345 4428  ck(x)    UNUSED(
-00045450: 7829 0a23 6465 6669 6e65 2067 676d 6c5f  x).#define ggml_
-00045460: 6c6f 636b 5f75 6e6c 6f63 6b28 7829 2020  lock_unlock(x)  
-00045470: 554e 5553 4544 2878 290a 0a23 6465 6669  UNUSED(x)..#defi
-00045480: 6e65 2047 474d 4c5f 4c4f 434b 5f49 4e49  ne GGML_LOCK_INI
-00045490: 5449 414c 495a 4552 2030 0a0a 7479 7065  TIALIZER 0..type
-000454a0: 6465 6620 7074 6872 6561 645f 7420 6767  def pthread_t gg
-000454b0: 6d6c 5f74 6872 6561 645f 743b 0a0a 2364  ml_thread_t;..#d
-000454c0: 6566 696e 6520 6767 6d6c 5f74 6872 6561  efine ggml_threa
-000454d0: 645f 6372 6561 7465 2070 7468 7265 6164  d_create pthread
-000454e0: 5f63 7265 6174 650a 2364 6566 696e 6520  _create.#define 
-000454f0: 6767 6d6c 5f74 6872 6561 645f 6a6f 696e  ggml_thread_join
-00045500: 2020 2070 7468 7265 6164 5f6a 6f69 6e0a     pthread_join.
-00045510: 0a23 656c 7365 0a0a 2f2f 7479 7065 6465  .#else..//typede
-00045520: 6620 7074 6872 6561 645f 7370 696e 6c6f  f pthread_spinlo
-00045530: 636b 5f74 2067 676d 6c5f 6c6f 636b 5f74  ck_t ggml_lock_t
-00045540: 3b0a 0a2f 2f23 6465 6669 6e65 2067 676d  ;..//#define ggm
-00045550: 6c5f 6c6f 636b 5f69 6e69 7428 7829 2070  l_lock_init(x) p
-00045560: 7468 7265 6164 5f73 7069 6e5f 696e 6974  thread_spin_init
-00045570: 2878 2c20 5054 4852 4541 445f 5052 4f43  (x, PTHREAD_PROC
-00045580: 4553 535f 5052 4956 4154 4529 0a2f 2f23  ESS_PRIVATE).//#
-00045590: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
-000455a0: 5f64 6573 7472 6f79 2070 7468 7265 6164  _destroy pthread
-000455b0: 5f73 7069 6e5f 6465 7374 726f 790a 2f2f  _spin_destroy.//
-000455c0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
-000455d0: 6b5f 6c6f 636b 2020 2020 7074 6872 6561  k_lock    pthrea
-000455e0: 645f 7370 696e 5f6c 6f63 6b0a 2f2f 2364  d_spin_lock.//#d
-000455f0: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00045600: 756e 6c6f 636b 2020 7074 6872 6561 645f  unlock  pthread_
-00045610: 7370 696e 5f75 6e6c 6f63 6b0a 0a74 7970  spin_unlock..typ
-00045620: 6564 6566 2069 6e74 2067 676d 6c5f 6c6f  edef int ggml_lo
-00045630: 636b 5f74 3b0a 0a23 6465 6669 6e65 2067  ck_t;..#define g
-00045640: 676d 6c5f 6c6f 636b 5f69 6e69 7428 7829  gml_lock_init(x)
-00045650: 2020 2020 554e 5553 4544 2878 290a 2364      UNUSED(x).#d
-00045660: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00045670: 6465 7374 726f 7928 7829 2055 4e55 5345  destroy(x) UNUSE
-00045680: 4428 7829 0a23 6465 6669 6e65 2067 676d  D(x).#define ggm
-00045690: 6c5f 6c6f 636b 5f6c 6f63 6b28 7829 2020  l_lock_lock(x)  
-000456a0: 2020 554e 5553 4544 2878 290a 2364 6566    UNUSED(x).#def
-000456b0: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 756e  ine ggml_lock_un
-000456c0: 6c6f 636b 2878 2920 2055 4e55 5345 4428  lock(x)  UNUSED(
-000456d0: 7829 0a0a 2364 6566 696e 6520 4747 4d4c  x)..#define GGML
-000456e0: 5f4c 4f43 4b5f 494e 4954 4941 4c49 5a45  _LOCK_INITIALIZE
-000456f0: 5220 300a 0a74 7970 6564 6566 2070 7468  R 0..typedef pth
-00045700: 7265 6164 5f74 2067 676d 6c5f 7468 7265  read_t ggml_thre
-00045710: 6164 5f74 3b0a 0a23 6465 6669 6e65 2067  ad_t;..#define g
-00045720: 676d 6c5f 7468 7265 6164 5f63 7265 6174  gml_thread_creat
-00045730: 6520 7074 6872 6561 645f 6372 6561 7465  e pthread_create
-00045740: 0a23 6465 6669 6e65 2067 676d 6c5f 7468  .#define ggml_th
-00045750: 7265 6164 5f6a 6f69 6e20 2020 7074 6872  read_join   pthr
-00045760: 6561 645f 6a6f 696e 0a0a 2365 6e64 6966  ead_join..#endif
-00045770: 0a0a 7374 7275 6374 2067 676d 6c5f 636f  ..struct ggml_co
-00045780: 6d70 7574 655f 7374 6174 655f 7368 6172  mpute_state_shar
-00045790: 6564 207b 0a20 2020 2067 676d 6c5f 6c6f  ed {.    ggml_lo
-000457a0: 636b 5f74 2073 7069 6e3b 0a0a 2020 2020  ck_t spin;..    
-000457b0: 696e 7420 6e5f 7468 7265 6164 733b 0a0a  int n_threads;..
-000457c0: 2020 2020 2f2f 2073 796e 6368 726f 6e69      // synchroni
-000457d0: 7a61 7469 6f6e 2070 7269 6d69 7469 7665  zation primitive
-000457e0: 730a 2020 2020 6174 6f6d 6963 5f69 6e74  s.    atomic_int
-000457f0: 2020 6e5f 7265 6164 793b 0a20 2020 2061    n_ready;.    a
-00045800: 746f 6d69 635f 626f 6f6c 2068 6173 5f77  tomic_bool has_w
-00045810: 6f72 6b3b 0a20 2020 2061 746f 6d69 635f  ork;.    atomic_
-00045820: 626f 6f6c 2073 746f 703b 202f 2f20 7374  bool stop; // st
-00045830: 6f70 2061 6c6c 2074 6872 6561 6473 0a7d  op all threads.}
-00045840: 3b0a 0a73 7472 7563 7420 6767 6d6c 5f63  ;..struct ggml_c
-00045850: 6f6d 7075 7465 5f73 7461 7465 207b 0a20  ompute_state {. 
-00045860: 2020 2067 676d 6c5f 7468 7265 6164 5f74     ggml_thread_t
-00045870: 2074 6872 643b 0a0a 2020 2020 7374 7275   thrd;..    stru
-00045880: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00045890: 7061 7261 6d73 2070 6172 616d 733b 0a20  params params;. 
-000458a0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-000458b0: 656e 736f 7220 2a20 6e6f 6465 3b0a 0a20  ensor * node;.. 
-000458c0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-000458d0: 6f6d 7075 7465 5f73 7461 7465 5f73 6861  ompute_state_sha
-000458e0: 7265 6420 2a20 7368 6172 6564 3b0a 7d3b  red * shared;.};
-000458f0: 0a0a 7374 6174 6963 2074 6872 6561 645f  ..static thread_
-00045900: 7265 745f 7420 6767 6d6c 5f67 7261 7068  ret_t ggml_graph
-00045910: 5f63 6f6d 7075 7465 5f74 6872 6561 6428  _compute_thread(
-00045920: 766f 6964 202a 2064 6174 6129 207b 0a20  void * data) {. 
-00045930: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00045940: 6f6d 7075 7465 5f73 7461 7465 202a 2073  ompute_state * s
-00045950: 7461 7465 203d 2028 7374 7275 6374 2067  tate = (struct g
-00045960: 676d 6c5f 636f 6d70 7574 655f 7374 6174  gml_compute_stat
-00045970: 6520 2a29 2064 6174 613b 0a0a 2020 2020  e *) data;..    
-00045980: 636f 6e73 7420 696e 7420 6e5f 7468 7265  const int n_thre
-00045990: 6164 7320 3d20 7374 6174 652d 3e73 6861  ads = state->sha
-000459a0: 7265 642d 3e6e 5f74 6872 6561 6473 3b0a  red->n_threads;.
-000459b0: 0a20 2020 2077 6869 6c65 2028 7472 7565  .    while (true
-000459c0: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
-000459d0: 6174 6f6d 6963 5f66 6574 6368 5f61 6464  atomic_fetch_add
-000459e0: 2826 7374 6174 652d 3e73 6861 7265 642d  (&state->shared-
-000459f0: 3e6e 5f72 6561 6479 2c20 3129 203d 3d20  >n_ready, 1) == 
-00045a00: 6e5f 7468 7265 6164 7320 2d20 3129 207b  n_threads - 1) {
-00045a10: 0a20 2020 2020 2020 2020 2020 2061 746f  .            ato
-00045a20: 6d69 635f 7374 6f72 6528 2673 7461 7465  mic_store(&state
-00045a30: 2d3e 7368 6172 6564 2d3e 6861 735f 776f  ->shared->has_wo
-00045a40: 726b 2c20 6661 6c73 6529 3b0a 2020 2020  rk, false);.    
-00045a50: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00045a60: 2020 2020 2020 2020 2077 6869 6c65 2028           while (
-00045a70: 6174 6f6d 6963 5f6c 6f61 6428 2673 7461  atomic_load(&sta
-00045a80: 7465 2d3e 7368 6172 6564 2d3e 6861 735f  te->shared->has_
-00045a90: 776f 726b 2929 207b 0a20 2020 2020 2020  work)) {.       
-00045aa0: 2020 2020 2020 2020 2069 6620 2861 746f           if (ato
-00045ab0: 6d69 635f 6c6f 6164 2826 7374 6174 652d  mic_load(&state-
-00045ac0: 3e73 6861 7265 642d 3e73 746f 7029 2920  >shared->stop)) 
-00045ad0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00045ae0: 2020 2020 2020 7265 7475 726e 2030 3b0a        return 0;.
-00045af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045b00: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00045b10: 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b    ggml_lock_lock
-00045b20: 2020 2826 7374 6174 652d 3e73 6861 7265    (&state->share
-00045b30: 642d 3e73 7069 6e29 3b0a 2020 2020 2020  d->spin);.      
-00045b40: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
-00045b50: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
-00045b60: 652d 3e73 6861 7265 642d 3e73 7069 6e29  e->shared->spin)
-00045b70: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00045b80: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00045b90: 2020 2061 746f 6d69 635f 6665 7463 685f     atomic_fetch_
-00045ba0: 7375 6228 2673 7461 7465 2d3e 7368 6172  sub(&state->shar
-00045bb0: 6564 2d3e 6e5f 7265 6164 792c 2031 293b  ed->n_ready, 1);
-00045bc0: 0a0a 2020 2020 2020 2020 2f2f 2077 6169  ..        // wai
-00045bd0: 7420 666f 7220 776f 726b 0a20 2020 2020  t for work.     
-00045be0: 2020 2077 6869 6c65 2028 2161 746f 6d69     while (!atomi
-00045bf0: 635f 6c6f 6164 2826 7374 6174 652d 3e73  c_load(&state->s
-00045c00: 6861 7265 642d 3e68 6173 5f77 6f72 6b29  hared->has_work)
-00045c10: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00045c20: 6966 2028 6174 6f6d 6963 5f6c 6f61 6428  if (atomic_load(
-00045c30: 2673 7461 7465 2d3e 7368 6172 6564 2d3e  &state->shared->
-00045c40: 7374 6f70 2929 207b 0a20 2020 2020 2020  stop)) {.       
-00045c50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00045c60: 303b 0a20 2020 2020 2020 2020 2020 207d  0;.            }
-00045c70: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00045c80: 6c5f 6c6f 636b 5f6c 6f63 6b20 2028 2673  l_lock_lock  (&s
-00045c90: 7461 7465 2d3e 7368 6172 6564 2d3e 7370  tate->shared->sp
-00045ca0: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
-00045cb0: 2067 676d 6c5f 6c6f 636b 5f75 6e6c 6f63   ggml_lock_unloc
-00045cc0: 6b28 2673 7461 7465 2d3e 7368 6172 6564  k(&state->shared
-00045cd0: 2d3e 7370 696e 293b 0a20 2020 2020 2020  ->spin);.       
-00045ce0: 207d 0a0a 2020 2020 2020 2020 2f2f 2063   }..        // c
-00045cf0: 6865 636b 2069 6620 7765 2073 686f 756c  heck if we shoul
-00045d00: 6420 7374 6f70 0a20 2020 2020 2020 2069  d stop.        i
-00045d10: 6620 2861 746f 6d69 635f 6c6f 6164 2826  f (atomic_load(&
-00045d20: 7374 6174 652d 3e73 6861 7265 642d 3e73  state->shared->s
-00045d30: 746f 7029 2920 7b0a 2020 2020 2020 2020  top)) {.        
-00045d40: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
-00045d50: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-00045d60: 2028 7374 6174 652d 3e6e 6f64 6529 207b   (state->node) {
-00045d70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00045d80: 2873 7461 7465 2d3e 7061 7261 6d73 2e69  (state->params.i
-00045d90: 7468 203c 2073 7461 7465 2d3e 7061 7261  th < state->para
-00045da0: 6d73 2e6e 7468 2920 7b0a 2020 2020 2020  ms.nth) {.      
-00045db0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00045dc0: 6f6d 7075 7465 5f66 6f72 7761 7264 2826  ompute_forward(&
-00045dd0: 7374 6174 652d 3e70 6172 616d 732c 2073  state->params, s
-00045de0: 7461 7465 2d3e 6e6f 6465 293b 0a20 2020  tate->node);.   
-00045df0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00045e00: 2020 2020 2020 2020 7374 6174 652d 3e6e          state->n
-00045e10: 6f64 6520 3d20 4e55 4c4c 3b0a 2020 2020  ode = NULL;.    
-00045e20: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00045e30: 2020 2020 2020 2020 2062 7265 616b 3b0a           break;.
-00045e40: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00045e50: 0a20 2020 2072 6574 7572 6e20 303b 0a7d  .    return 0;.}
-00045e60: 0a0a 766f 6964 2067 676d 6c5f 6772 6170  ..void ggml_grap
-00045e70: 685f 636f 6d70 7574 6528 7374 7275 6374  h_compute(struct
-00045e80: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00045e90: 6374 782c 2073 7472 7563 7420 6767 6d6c  ctx, struct ggml
-00045ea0: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-00045eb0: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
-00045ec0: 7420 6e5f 7468 7265 6164 7320 3d20 6367  t n_threads = cg
-00045ed0: 7261 7068 2d3e 6e5f 7468 7265 6164 733b  raph->n_threads;
-00045ee0: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
-00045ef0: 6c5f 636f 6d70 7574 655f 7374 6174 655f  l_compute_state_
-00045f00: 7368 6172 6564 2073 7461 7465 5f73 6861  shared state_sha
-00045f10: 7265 6420 3d20 7b0a 2020 2020 2020 2020  red = {.        
-00045f20: 2f2a 2e73 7069 6e20 2020 2020 203d 2a2f  /*.spin      =*/
-00045f30: 2047 474d 4c5f 4c4f 434b 5f49 4e49 5449   GGML_LOCK_INITI
-00045f40: 414c 495a 4552 2c0a 2020 2020 2020 2020  ALIZER,.        
-00045f50: 2f2a 2e6e 5f74 6872 6561 6473 203d 2a2f  /*.n_threads =*/
-00045f60: 206e 5f74 6872 6561 6473 2c0a 2020 2020   n_threads,.    
-00045f70: 2020 2020 2f2a 2e6e 5f72 6561 6479 2020      /*.n_ready  
-00045f80: 203d 2a2f 2030 2c0a 2020 2020 2020 2020   =*/ 0,.        
-00045f90: 2f2a 2e68 6173 5f77 6f72 6b20 203d 2a2f  /*.has_work  =*/
-00045fa0: 2066 616c 7365 2c0a 2020 2020 2020 2020   false,.        
-00045fb0: 2f2a 2e73 746f 7020 2020 2020 203d 2a2f  /*.stop      =*/
-00045fc0: 2066 616c 7365 2c0a 2020 2020 7d3b 0a20   false,.    };. 
-00045fd0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00045fe0: 6f6d 7075 7465 5f73 7461 7465 202a 2077  ompute_state * w
-00045ff0: 6f72 6b65 7273 203d 206e 5f74 6872 6561  orkers = n_threa
-00046000: 6473 203e 2031 203f 2061 6c6c 6f63 6128  ds > 1 ? alloca(
-00046010: 7369 7a65 6f66 2873 7472 7563 7420 6767  sizeof(struct gg
-00046020: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
-00046030: 292a 286e 5f74 6872 6561 6473 202d 2031  )*(n_threads - 1
-00046040: 2929 203a 204e 554c 4c3b 0a0a 2020 2020  )) : NULL;..    
-00046050: 2f2f 2063 7265 6174 6520 7468 7265 6164  // create thread
-00046060: 2070 6f6f 6c0a 2020 2020 6966 2028 6e5f   pool.    if (n_
-00046070: 7468 7265 6164 7320 3e20 3129 207b 0a20  threads > 1) {. 
-00046080: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
-00046090: 5f69 6e69 7428 2673 7461 7465 5f73 6861  _init(&state_sha
-000460a0: 7265 642e 7370 696e 293b 0a0a 2020 2020  red.spin);..    
-000460b0: 2020 2020 6174 6f6d 6963 5f73 746f 7265      atomic_store
-000460c0: 2826 7374 6174 655f 7368 6172 6564 2e68  (&state_shared.h
-000460d0: 6173 5f77 6f72 6b2c 2074 7275 6529 3b0a  as_work, true);.
-000460e0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-000460f0: 7420 6a20 3d20 303b 206a 203c 206e 5f74  t j = 0; j < n_t
-00046100: 6872 6561 6473 202d 2031 3b20 6a2b 2b29  hreads - 1; j++)
-00046110: 207b 0a20 2020 2020 2020 2020 2020 2077   {.            w
-00046120: 6f72 6b65 7273 5b6a 5d20 3d20 2873 7472  orkers[j] = (str
-00046130: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00046140: 5f73 7461 7465 2920 7b0a 2020 2020 2020  _state) {.      
-00046150: 2020 2020 2020 2020 2020 2e74 6872 6420            .thrd 
-00046160: 2020 3d20 302c 0a20 2020 2020 2020 2020    = 0,.         
-00046170: 2020 2020 2020 202e 7061 7261 6d73 203d         .params =
-00046180: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00046190: 2020 2020 2020 202e 7479 7065 2020 3d20         .type  = 
-000461a0: 4747 4d4c 5f54 4153 4b5f 434f 4d50 5554  GGML_TASK_COMPUT
-000461b0: 452c 0a20 2020 2020 2020 2020 2020 2020  E,.             
-000461c0: 2020 2020 2020 202e 6974 6820 2020 3d20         .ith   = 
-000461d0: 6a20 2b20 312c 0a20 2020 2020 2020 2020  j + 1,.         
-000461e0: 2020 2020 2020 2020 2020 202e 6e74 6820             .nth 
-000461f0: 2020 3d20 6e5f 7468 7265 6164 732c 0a20    = n_threads,. 
-00046200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046210: 2020 202e 7773 697a 6520 3d20 6367 7261     .wsize = cgra
-00046220: 7068 2d3e 776f 726b 203f 2067 676d 6c5f  ph->work ? ggml_
-00046230: 6e62 7974 6573 2863 6772 6170 682d 3e77  nbytes(cgraph->w
-00046240: 6f72 6b29 203a 2030 2c0a 2020 2020 2020  ork) : 0,.      
-00046250: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
-00046260: 6461 7461 203d 2063 6772 6170 682d 3e77  data = cgraph->w
-00046270: 6f72 6b20 3f20 6367 7261 7068 2d3e 776f  ork ? cgraph->wo
-00046280: 726b 2d3e 6461 7461 203a 204e 554c 4c2c  rk->data : NULL,
-00046290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000462a0: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-000462b0: 2020 2020 2e6e 6f64 6520 2020 3d20 4e55      .node   = NU
-000462c0: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
-000462d0: 2020 2020 2e73 6861 7265 6420 3d20 2673      .shared = &s
-000462e0: 7461 7465 5f73 6861 7265 642c 0a20 2020  tate_shared,.   
-000462f0: 2020 2020 2020 2020 207d 3b0a 0a20 2020           };..   
-00046300: 2020 2020 2020 2020 2069 6e74 2072 6320           int rc 
-00046310: 3d20 6767 6d6c 5f74 6872 6561 645f 6372  = ggml_thread_cr
-00046320: 6561 7465 2826 776f 726b 6572 735b 6a5d  eate(&workers[j]
-00046330: 2e74 6872 642c 204e 554c 4c2c 2067 676d  .thrd, NULL, ggm
-00046340: 6c5f 6772 6170 685f 636f 6d70 7574 655f  l_graph_compute_
-00046350: 7468 7265 6164 2c20 2677 6f72 6b65 7273  thread, &workers
-00046360: 5b6a 5d29 3b0a 2020 2020 2020 2020 2020  [j]);.          
-00046370: 2020 4747 4d4c 5f41 5353 4552 5428 7263    GGML_ASSERT(rc
-00046380: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
-00046390: 2020 2020 554e 5553 4544 2872 6329 3b0a      UNUSED(rc);.
-000463a0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-000463b0: 0a20 2020 202f 2f20 696e 6974 6961 6c69  .    // initiali
-000463c0: 7a65 2074 6173 6b73 202b 2077 6f72 6b20  ze tasks + work 
-000463d0: 6275 6666 6572 0a20 2020 207b 0a20 2020  buffer.    {.   
-000463e0: 2020 2020 2073 697a 655f 7420 776f 726b       size_t work
-000463f0: 5f73 697a 6520 3d20 303b 0a0a 2020 2020  _size = 0;..    
-00046400: 2020 2020 2f2f 2074 6872 6561 6420 7363      // thread sc
-00046410: 6865 6475 6c69 6e67 2066 6f72 2074 6865  heduling for the
-00046420: 2064 6966 6665 7265 6e74 206f 7065 7261   different opera
-00046430: 7469 6f6e 730a 2020 2020 2020 2020 666f  tions.        fo
-00046440: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00046450: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
-00046460: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-00046470: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00046480: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
-00046490: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
-000464a0: 695d 3b0a 0a20 2020 2020 2020 2020 2020  i];..           
-000464b0: 2073 7769 7463 6820 286e 6f64 652d 3e6f   switch (node->o
-000464c0: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
-000464d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000464e0: 505f 4455 503a 0a20 2020 2020 2020 2020  P_DUP:.         
-000464f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00046500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046510: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
-00046520: 6b73 203d 2031 3b0a 2020 2020 2020 2020  ks = 1;.        
-00046530: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00046540: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-00046550: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00046560: 505f 4144 443a 0a20 2020 2020 2020 2020  P_ADD:.         
-00046570: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00046580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046590: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
-000465a0: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
-000465b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000465c0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000465d0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-000465e0: 6520 4747 4d4c 5f4f 505f 5355 423a 0a20  e GGML_OP_SUB:. 
-000465f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00046600: 6173 6520 4747 4d4c 5f4f 505f 4d55 4c3a  ase GGML_OP_MUL:
-00046610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046620: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
-00046630: 563a 0a20 2020 2020 2020 2020 2020 2020  V:.             
-00046640: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00046650: 5351 523a 0a20 2020 2020 2020 2020 2020  SQR:.           
-00046660: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00046670: 505f 5351 5254 3a0a 2020 2020 2020 2020  P_SQRT:.        
-00046680: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00046690: 4c5f 4f50 5f53 554d 3a0a 2020 2020 2020  L_OP_SUM:.      
-000466a0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-000466b0: 474d 4c5f 4f50 5f4d 4541 4e3a 0a20 2020  GML_OP_MEAN:.   
-000466c0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-000466d0: 6520 4747 4d4c 5f4f 505f 5245 5045 4154  e GGML_OP_REPEAT
-000466e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000466f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f41    case GGML_OP_A
-00046700: 4253 3a0a 2020 2020 2020 2020 2020 2020  BS:.            
-00046710: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00046720: 5f53 474e 3a0a 2020 2020 2020 2020 2020  _SGN:.          
-00046730: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00046740: 4f50 5f4e 4547 3a0a 2020 2020 2020 2020  OP_NEG:.        
-00046750: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00046760: 4c5f 4f50 5f53 5445 503a 0a20 2020 2020  L_OP_STEP:.     
-00046770: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00046780: 4747 4d4c 5f4f 505f 5245 4c55 3a0a 2020  GGML_OP_RELU:.  
-00046790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000467a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000467b0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000467c0: 2d3e 6e5f 7461 736b 7320 3d20 313b 0a20  ->n_tasks = 1;. 
-000467d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000467e0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000467f0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00046800: 2047 474d 4c5f 4f50 5f47 454c 553a 0a20   GGML_OP_GELU:. 
-00046810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046820: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00046830: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00046840: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
-00046850: 6872 6561 6473 3b0a 2020 2020 2020 2020  hreads;.        
-00046860: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00046870: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-00046880: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00046890: 505f 5349 4c55 3a0a 2020 2020 2020 2020  P_SILU:.        
-000468a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000468b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000468c0: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-000468d0: 736b 7320 3d20 6e5f 7468 7265 6164 733b  sks = n_threads;
-000468e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000468f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00046900: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00046910: 7365 2047 474d 4c5f 4f50 5f4e 4f52 4d3a  se GGML_OP_NORM:
-00046920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046930: 2063 6173 6520 4747 4d4c 5f4f 505f 524d   case GGML_OP_RM
-00046940: 535f 4e4f 524d 3a0a 2020 2020 2020 2020  S_NORM:.        
-00046950: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00046960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046970: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-00046980: 736b 7320 3d20 6e5f 7468 7265 6164 733b  sks = n_threads;
-00046990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000469a0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000469b0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-000469c0: 7365 2047 474d 4c5f 4f50 5f4d 554c 5f4d  se GGML_OP_MUL_M
-000469d0: 4154 3a0a 2020 2020 2020 2020 2020 2020  AT:.            
-000469e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000469f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046a00: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
-00046a10: 3d20 6e5f 7468 7265 6164 733b 0a0a 2020  = n_threads;..  
-00046a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046a30: 2020 2020 2020 2f2f 2054 4f44 4f3a 2075        // TODO: u
-00046a40: 7365 2064 6966 6665 7265 6e74 2073 6368  se different sch
-00046a50: 6564 756c 696e 6720 666f 7220 6469 6666  eduling for diff
-00046a60: 6572 656e 7420 6d61 7472 6978 2073 697a  erent matrix siz
-00046a70: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00046a80: 2020 2020 2020 2020 2020 202f 2f63 6f6e             //con
-00046a90: 7374 2069 6e74 206e 7230 203d 2067 676d  st int nr0 = ggm
-00046aa0: 6c5f 6e72 6f77 7328 6e6f 6465 2d3e 7372  l_nrows(node->sr
-00046ab0: 6330 293b 0a20 2020 2020 2020 2020 2020  c0);.           
-00046ac0: 2020 2020 2020 2020 2020 2020 202f 2f63               //c
-00046ad0: 6f6e 7374 2069 6e74 206e 7231 203d 2067  onst int nr1 = g
-00046ae0: 676d 6c5f 6e72 6f77 7328 6e6f 6465 2d3e  gml_nrows(node->
-00046af0: 7372 6331 293b 0a0a 2020 2020 2020 2020  src1);..        
-00046b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046b10: 2f2f 6e6f 6465 2d3e 6e5f 7461 736b 7320  //node->n_tasks 
-00046b20: 3d20 4d49 4e28 6e5f 7468 7265 6164 732c  = MIN(n_threads,
-00046b30: 204d 4158 2831 2c20 6e72 302f 3132 3829   MAX(1, nr0/128)
-00046b40: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00046b50: 2020 2020 2020 2020 2020 202f 2f70 7269             //pri
-00046b60: 6e74 6628 226e 7230 203d 2025 3864 2c20  ntf("nr0 = %8d, 
-00046b70: 6e72 3120 3d20 2538 642c 206e 7230 2a6e  nr1 = %8d, nr0*n
-00046b80: 7231 203d 2025 3864 2c20 6e5f 7461 736b  r1 = %8d, n_task
-00046b90: 7320 3d20 2564 5c6e 222c 206e 7230 2c20  s = %d\n", nr0, 
-00046ba0: 6e72 312c 206e 7230 2a6e 7231 2c20 6e6f  nr1, nr0*nr1, no
-00046bb0: 6465 2d3e 6e5f 7461 736b 7329 3b0a 0a20  de->n_tasks);.. 
-00046bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046bd0: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-00046be0: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
-00046bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c00: 2f2f 2054 4f44 4f3a 2062 6574 7465 7220  // TODO: better 
-00046c10: 7761 7920 746f 2064 6574 6572 6d69 6e65  way to determine
-00046c20: 2069 6620 7468 6520 6d61 7472 6978 2069   if the matrix i
-00046c30: 7320 7472 616e 7370 6f73 6564 0a20 2020  s transposed.   
-00046c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c50: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
-00046c60: 7263 302d 3e6e 625b 315d 203c 206e 6f64  rc0->nb[1] < nod
-00046c70: 652d 3e73 7263 302d 3e6e 625b 305d 2920  e->src0->nb[0]) 
-00046c80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00046c90: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00046ca0: 7220 3d20 6767 6d6c 5f6e 6279 7465 7328  r = ggml_nbytes(
-00046cb0: 6e6f 6465 292a 6e6f 6465 2d3e 6e5f 7461  node)*node->n_ta
-00046cc0: 736b 733b 202f 2f20 544f 444f 3a20 7468  sks; // TODO: th
-00046cd0: 6973 2063 616e 2062 6563 6f6d 6520 286e  is can become (n
-00046ce0: 5f74 6173 6b73 2d31 290a 2020 2020 2020  _tasks-1).      
-00046cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046d20: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00046d30: 544f 444f 3a20 6f76 6572 6573 7469 6d61  TODO: overestima
-00046d40: 7465 6420 6279 2066 6163 746f 7220 6f66  ted by factor of
-00046d50: 2078 3220 666f 7220 4650 3136 0a20 2020   x2 for FP16.   
-00046d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046d70: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
-00046d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046d90: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
-00046da0: 6465 2d3e 7372 6330 2d3e 7479 7065 203d  de->src0->type =
-00046db0: 3d20 4747 4d4c 5f54 5950 455f 4631 3620  = GGML_TYPE_F16 
-00046dc0: 2626 0a20 2020 2020 2020 2020 2020 2020  &&.             
-00046dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046de0: 2020 206e 6f64 652d 3e73 7263 312d 3e74     node->src1->t
-00046df0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00046e00: 5f46 3332 2920 7b0a 2369 6620 6465 6669  _F32) {.#if defi
-00046e10: 6e65 6428 4747 4d4c 5f55 5345 5f41 4343  ned(GGML_USE_ACC
-00046e20: 454c 4552 4154 4529 207c 7c20 6465 6669  ELERATE) || defi
-00046e30: 6e65 6428 4747 4d4c 5f55 5345 5f4f 5045  ned(GGML_USE_OPE
-00046e40: 4e42 4c41 5329 0a20 2020 2020 2020 2020  NBLAS).         
-00046e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046e60: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
-00046e70: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00046e80: 6d75 6c5f 6d61 745f 7573 655f 626c 6173  mul_mat_use_blas
-00046e90: 286e 6f64 652d 3e73 7263 302c 206e 6f64  (node->src0, nod
-00046ea0: 652d 3e73 7263 312c 206e 6f64 6529 2920  e->src1, node)) 
-00046eb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00046ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046ed0: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-00046ee0: 736b 7320 3d20 313b 202f 2f20 544f 444f  sks = 1; // TODO
-00046ef0: 3a20 7468 6973 2061 6374 7561 6c6c 7920  : this actually 
-00046f00: 6973 2064 6f69 6e67 206e 6f74 6869 6e67  is doing nothing
-00046f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046f40: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
-00046f50: 2074 6865 2074 6872 6561 6473 2061 7265   the threads are
-00046f60: 2073 7469 6c6c 2073 7069 6e6e 696e 670a   still spinning.
-00046f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046f90: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
-00046fa0: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
-00046fb0: 5045 5f46 3332 5d2a 286e 6f64 652d 3e73  PE_F32]*(node->s
-00046fc0: 7263 302d 3e6e 655b 305d 2a6e 6f64 652d  rc0->ne[0]*node-
-00046fd0: 3e73 7263 302d 3e6e 655b 315d 293b 0a20  >src0->ne[1]);. 
-00046fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047000: 2020 202f 2f70 7269 6e74 6628 2273 7263     //printf("src
-00047010: 303a 206e 6530 203d 2025 642c 206e 6531  0: ne0 = %d, ne1
-00047020: 203d 2025 642c 206e 6520 3d20 2564 5c6e   = %d, ne = %d\n
-00047030: 222c 206e 6f64 652d 3e73 7263 302d 3e6e  ", node->src0->n
-00047040: 655b 305d 2c20 6e6f 6465 2d3e 7372 6330  e[0], node->src0
-00047050: 2d3e 6e65 5b31 5d2c 206e 6f64 652d 3e73  ->ne[1], node->s
-00047060: 7263 302d 3e6e 655b 305d 2a6e 6f64 652d  rc0->ne[0]*node-
-00047070: 3e73 7263 302d 3e6e 655b 315d 293b 0a20  >src0->ne[1]);. 
-00047080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000470a0: 2020 202f 2f70 7269 6e74 6628 2273 7263     //printf("src
-000470b0: 313a 206e 6530 203d 2025 642c 206e 6531  1: ne0 = %d, ne1
-000470c0: 203d 2025 642c 206e 6520 3d20 2564 5c6e   = %d, ne = %d\n
-000470d0: 222c 206e 6f64 652d 3e73 7263 312d 3e6e  ", node->src1->n
-000470e0: 655b 305d 2c20 6e6f 6465 2d3e 7372 6331  e[0], node->src1
-000470f0: 2d3e 6e65 5b31 5d2c 206e 6f64 652d 3e73  ->ne[1], node->s
-00047100: 7263 312d 3e6e 655b 305d 2a6e 6f64 652d  rc1->ne[0]*node-
-00047110: 3e73 7263 312d 3e6e 655b 315d 293b 0a20  >src1->ne[1]);. 
-00047120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047140: 2020 202f 2f70 7269 6e74 6628 2263 7572     //printf("cur
-00047150: 203d 2025 7a75 5c6e 222c 2063 7572 293b   = %zu\n", cur);
-00047160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047180: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-00047190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000471a0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-000471b0: 7220 3d20 4747 4d4c 5f54 5950 455f 5349  r = GGML_TYPE_SI
-000471c0: 5a45 5b47 474d 4c5f 5459 5045 5f46 3136  ZE[GGML_TYPE_F16
-000471d0: 5d2a 6767 6d6c 5f6e 656c 656d 656e 7473  ]*ggml_nelements
-000471e0: 286e 6f64 652d 3e73 7263 3129 3b0a 2020  (node->src1);.  
-000471f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047200: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00047210: 2365 6c73 650a 2020 2020 2020 2020 2020  #else.          
-00047220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047230: 2020 2020 2020 6375 7220 3d20 4747 4d4c        cur = GGML
-00047240: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
-00047250: 5459 5045 5f46 3136 5d2a 6767 6d6c 5f6e  TYPE_F16]*ggml_n
-00047260: 656c 656d 656e 7473 286e 6f64 652d 3e73  elements(node->s
-00047270: 7263 3129 3b0a 2365 6e64 6966 0a20 2020  rc1);.#endif.   
-00047280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047290: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-000472a0: 6966 2028 6e6f 6465 2d3e 7372 6330 2d3e  if (node->src0->
-000472b0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-000472c0: 455f 4633 3220 2626 0a20 2020 2020 2020  E_F32 &&.       
-000472d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000472e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000472f0: 6e6f 6465 2d3e 7372 6331 2d3e 7479 7065  node->src1->type
-00047300: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-00047310: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
-00047320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047330: 2020 2020 2063 7572 203d 2030 3b0a 2020       cur = 0;.  
-00047340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047350: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-00047360: 2069 6620 286e 6f64 652d 3e73 7263 302d   if (node->src0-
-00047370: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00047380: 5045 5f51 345f 3020 2626 0a20 2020 2020  PE_Q4_0 &&.     
-00047390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000473a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000473b0: 2020 6e6f 6465 2d3e 7372 6331 2d3e 7479    node->src1->ty
-000473c0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-000473d0: 4633 3229 207b 0a23 6966 2064 6566 696e  F32) {.#if defin
-000473e0: 6564 2847 474d 4c5f 5553 455f 4143 4345  ed(GGML_USE_ACCE
-000473f0: 4c45 5241 5445 2920 7c7c 2064 6566 696e  LERATE) || defin
-00047400: 6564 2847 474d 4c5f 5553 455f 4f50 454e  ed(GGML_USE_OPEN
-00047410: 424c 4153 290a 2020 2020 2020 2020 2020  BLAS).          
-00047420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047430: 2020 2020 2020 6966 2028 6767 6d6c 5f63        if (ggml_c
-00047440: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-00047450: 756c 5f6d 6174 5f75 7365 5f62 6c61 7328  ul_mat_use_blas(
-00047460: 6e6f 6465 2d3e 7372 6330 2c20 6e6f 6465  node->src0, node
-00047470: 2d3e 7372 6331 2c20 6e6f 6465 2929 207b  ->src1, node)) {
-00047480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000474a0: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
-000474b0: 6b73 203d 2031 3b0a 2020 2020 2020 2020  ks = 1;.        
-000474c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000474d0: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-000474e0: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-000474f0: 5b47 474d 4c5f 5459 5045 5f46 3332 5d2a  [GGML_TYPE_F32]*
-00047500: 286e 6f64 652d 3e73 7263 302d 3e6e 655b  (node->src0->ne[
-00047510: 305d 2a6e 6f64 652d 3e73 7263 302d 3e6e  0]*node->src0->n
-00047520: 655b 315d 293b 0a20 2020 2020 2020 2020  e[1]);.         
-00047530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047540: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-00047550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047570: 2020 2020 6375 7220 3d20 2847 474d 4c5f      cur = (GGML_
-00047580: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
-00047590: 5950 455f 5134 5f30 5d2a 6767 6d6c 5f6e  YPE_Q4_0]*ggml_n
-000475a0: 656c 656d 656e 7473 286e 6f64 652d 3e73  elements(node->s
-000475b0: 7263 3129 292f 4747 4d4c 5f42 4c43 4b5f  rc1))/GGML_BLCK_
-000475c0: 5349 5a45 5b47 474d 4c5f 5459 5045 5f51  SIZE[GGML_TYPE_Q
-000475d0: 345f 305d 3b0a 2020 2020 2020 2020 2020  4_0];.          
-000475e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000475f0: 2020 2020 2020 7d0a 2365 6c73 650a 2020        }.#else.  
-00047600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047610: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00047620: 7220 3d20 2847 474d 4c5f 5459 5045 5f53  r = (GGML_TYPE_S
-00047630: 495a 455b 4747 4d4c 5f54 5950 455f 5134  IZE[GGML_TYPE_Q4
-00047640: 5f30 5d2a 6767 6d6c 5f6e 656c 656d 656e  _0]*ggml_nelemen
-00047650: 7473 286e 6f64 652d 3e73 7263 3129 292f  ts(node->src1))/
-00047660: 4747 4d4c 5f42 4c43 4b5f 5349 5a45 5b47  GGML_BLCK_SIZE[G
-00047670: 474d 4c5f 5459 5045 5f51 345f 305d 3b0a  GML_TYPE_Q4_0];.
-00047680: 2365 6e64 6966 0a20 2020 2020 2020 2020  #endif.         
-00047690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000476a0: 2020 207d 2065 6c73 6520 6966 2028 6e6f     } else if (no
-000476b0: 6465 2d3e 7372 6330 2d3e 7479 7065 203d  de->src0->type =
-000476c0: 3d20 4747 4d4c 5f54 5950 455f 5134 5f31  = GGML_TYPE_Q4_1
-000476d0: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
-000476e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000476f0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-00047700: 3e73 7263 312d 3e74 7970 6520 3d3d 2047  >src1->type == G
-00047710: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
-00047720: 2369 6620 6465 6669 6e65 6428 4747 4d4c  #if defined(GGML
-00047730: 5f55 5345 5f41 4343 454c 4552 4154 4529  _USE_ACCELERATE)
-00047740: 207c 7c20 6465 6669 6e65 6428 4747 4d4c   || defined(GGML
-00047750: 5f55 5345 5f4f 5045 4e42 4c41 5329 0a20  _USE_OPENBLAS). 
-00047760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047770: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00047780: 6620 2867 676d 6c5f 636f 6d70 7574 655f  f (ggml_compute_
-00047790: 666f 7277 6172 645f 6d75 6c5f 6d61 745f  forward_mul_mat_
-000477a0: 7573 655f 626c 6173 286e 6f64 652d 3e73  use_blas(node->s
-000477b0: 7263 302c 206e 6f64 652d 3e73 7263 312c  rc0, node->src1,
-000477c0: 206e 6f64 6529 2920 7b0a 2020 2020 2020   node)) {.      
-000477d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000477e0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-000477f0: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
-00047800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047820: 2020 2020 2063 7572 203d 2047 474d 4c5f       cur = GGML_
-00047830: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
-00047840: 5950 455f 4633 325d 2a28 6e6f 6465 2d3e  YPE_F32]*(node->
-00047850: 7372 6330 2d3e 6e65 5b30 5d2a 6e6f 6465  src0->ne[0]*node
-00047860: 2d3e 7372 6330 2d3e 6e65 5b31 5d29 3b0a  ->src0->ne[1]);.
-00047870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047890: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-000478a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000478b0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-000478c0: 203d 2028 4747 4d4c 5f54 5950 455f 5349   = (GGML_TYPE_SI
-000478d0: 5a45 5b47 474d 4c5f 5459 5045 5f51 345f  ZE[GGML_TYPE_Q4_
-000478e0: 315d 2a67 676d 6c5f 6e65 6c65 6d65 6e74  1]*ggml_nelement
-000478f0: 7328 6e6f 6465 2d3e 7372 6331 2929 2f47  s(node->src1))/G
-00047900: 474d 4c5f 424c 434b 5f53 495a 455b 4747  GML_BLCK_SIZE[GG
-00047910: 4d4c 5f54 5950 455f 5134 5f31 5d3b 0a20  ML_TYPE_Q4_1];. 
-00047920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047930: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00047940: 0a23 656c 7365 0a20 2020 2020 2020 2020  .#else.         
-00047950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047960: 2020 2020 2020 2063 7572 203d 2028 4747         cur = (GG
-00047970: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
-00047980: 4c5f 5459 5045 5f51 345f 315d 2a67 676d  L_TYPE_Q4_1]*ggm
-00047990: 6c5f 6e65 6c65 6d65 6e74 7328 6e6f 6465  l_nelements(node
-000479a0: 2d3e 7372 6331 2929 2f47 474d 4c5f 424c  ->src1))/GGML_BL
-000479b0: 434b 5f53 495a 455b 4747 4d4c 5f54 5950  CK_SIZE[GGML_TYP
-000479c0: 455f 5134 5f31 5d3b 0a23 656e 6469 660a  E_Q4_1];.#endif.
-000479d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000479e0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-000479f0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-00047a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047a10: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00047a20: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00047a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047a40: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00047a50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00047a60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00047a70: 2020 2020 2020 2020 2020 776f 726b 5f73            work_s
-00047a80: 697a 6520 3d20 4d41 5828 776f 726b 5f73  ize = MAX(work_s
-00047a90: 697a 652c 2063 7572 293b 0a20 2020 2020  ize, cur);.     
-00047aa0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00047ab0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00047ac0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00047ad0: 4c5f 4f50 5f53 4341 4c45 3a0a 2020 2020  L_OP_SCALE:.    
-00047ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047af0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00047b00: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-00047b10: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
-00047b20: 6164 733b 0a20 2020 2020 2020 2020 2020  ads;.           
-00047b30: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00047b40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00047b50: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-00047b60: 5059 3a0a 2020 2020 2020 2020 2020 2020  PY:.            
-00047b70: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00047b80: 5f52 4553 4841 5045 3a0a 2020 2020 2020  _RESHAPE:.      
-00047b90: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00047ba0: 474d 4c5f 4f50 5f56 4945 573a 0a20 2020  GML_OP_VIEW:.   
-00047bb0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00047bc0: 6520 4747 4d4c 5f4f 505f 5045 524d 5554  e GGML_OP_PERMUT
-00047bd0: 453a 0a20 2020 2020 2020 2020 2020 2020  E:.             
-00047be0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00047bf0: 5452 414e 5350 4f53 453a 0a20 2020 2020  TRANSPOSE:.     
-00047c00: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00047c10: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-00047c20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00047c30: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-00047c40: 4941 475f 4d41 534b 5f49 4e46 3a0a 2020  IAG_MASK_INF:.  
-00047c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047c60: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00047c70: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00047c80: 2d3e 6e5f 7461 736b 7320 3d20 313b 0a20  ->n_tasks = 1;. 
-00047c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047ca0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00047cb0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00047cc0: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
-00047cd0: 583a 0a20 2020 2020 2020 2020 2020 2020  X:.             
-00047ce0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00047cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047d00: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
-00047d10: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
-00047d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047d30: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00047d40: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00047d50: 4d4c 5f4f 505f 524f 5045 3a0a 2020 2020  ML_OP_ROPE:.    
-00047d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047d70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00047d80: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-00047d90: 6e5f 7461 736b 7320 3d20 313b 0a20 2020  n_tasks = 1;.   
-00047da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047db0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00047dc0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00047dd0: 474d 4c5f 4f50 5f43 4f4e 565f 3144 5f31  GML_OP_CONV_1D_1
-00047de0: 533a 0a20 2020 2020 2020 2020 2020 2020  S:.             
-00047df0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00047e00: 434f 4e56 5f31 445f 3253 3a0a 2020 2020  CONV_1D_2S:.    
-00047e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047e20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00047e30: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-00047e40: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
-00047e50: 6164 733b 0a0a 2020 2020 2020 2020 2020  ads;..          
-00047e60: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00047e70: 4d4c 5f41 5353 4552 5428 6e6f 6465 2d3e  ML_ASSERT(node->
-00047e80: 7372 6330 2d3e 6e65 5b33 5d20 3d3d 2031  src0->ne[3] == 1
-00047e90: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00047ea0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00047eb0: 4153 5345 5254 286e 6f64 652d 3e73 7263  ASSERT(node->src
-00047ec0: 312d 3e6e 655b 325d 203d 3d20 3129 3b0a  1->ne[2] == 1);.
-00047ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047ee0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00047ef0: 4552 5428 6e6f 6465 2d3e 7372 6331 2d3e  ERT(node->src1->
-00047f00: 6e65 5b33 5d20 3d3d 2031 293b 0a0a 2020  ne[3] == 1);..  
-00047f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047f20: 2020 2020 2020 7369 7a65 5f74 2063 7572        size_t cur
-00047f30: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-00047f40: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00047f50: 6e73 7420 696e 7420 6e6b 203d 206e 6f64  nst int nk = nod
-00047f60: 652d 3e73 7263 302d 3e6e 655b 305d 3b0a  e->src0->ne[0];.
-00047f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047f80: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
-00047f90: 652d 3e73 7263 302d 3e74 7970 6520 3d3d  e->src0->type ==
-00047fa0: 2047 474d 4c5f 5459 5045 5f46 3136 2026   GGML_TYPE_F16 &
-00047fb0: 260a 2020 2020 2020 2020 2020 2020 2020  &.              
-00047fc0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00047fd0: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
-00047fe0: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-00047ff0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00048000: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00048010: 7572 203d 2073 697a 656f 6628 6767 6d6c  ur = sizeof(ggml
-00048020: 5f66 7031 365f 7429 2a28 0a20 2020 2020  _fp16_t)*(.     
-00048030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048040: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00048050: 6b2a 6767 6d6c 5f75 7033 3228 6e6f 6465  k*ggml_up32(node
-00048060: 2d3e 7372 6330 2d3e 6e65 5b31 5d29 2a6e  ->src0->ne[1])*n
-00048070: 6f64 652d 3e73 7263 302d 3e6e 655b 325d  ode->src0->ne[2]
-00048080: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
-00048090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000480a0: 2020 2020 2020 2028 2032 2a28 6e6b 2f32         ( 2*(nk/2
-000480b0: 2920 2b20 6e6f 6465 2d3e 7372 6331 2d3e  ) + node->src1->
-000480c0: 6e65 5b30 5d29 2a6e 6f64 652d 3e73 7263  ne[0])*node->src
-000480d0: 312d 3e6e 655b 315d 0a20 2020 2020 2020  1->ne[1].       
-000480e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000480f0: 2020 2020 2020 2020 2020 2020 2029 3b0a               );.
-00048100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048110: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
-00048120: 6620 286e 6f64 652d 3e73 7263 302d 3e74  f (node->src0->t
-00048130: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00048140: 5f46 3332 2026 260a 2020 2020 2020 2020  _F32 &&.        
-00048150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048160: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-00048170: 3e73 7263 312d 3e74 7970 6520 3d3d 2047  >src1->type == G
-00048180: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
-00048190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000481a0: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-000481b0: 3d20 7369 7a65 6f66 2866 6c6f 6174 292a  = sizeof(float)*
-000481c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00043dc0: 2020 2020 2020 207d 0a23 656c 7365 0a20         }.#else. 
+00043dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043de0: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
+00043df0: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+00043e00: 4747 4d4c 5f54 5950 455f 4631 365d 2a67  GGML_TYPE_F16]*g
+00043e10: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6e6f  gml_nelements(no
+00043e20: 6465 2d3e 7372 6331 293b 0a23 656e 6469  de->src1);.#endi
+00043e30: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
+00043e40: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+00043e50: 2069 6620 286e 6f64 652d 3e73 7263 302d   if (node->src0-
+00043e60: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00043e70: 5045 5f46 3332 2026 2620 6e6f 6465 2d3e  PE_F32 && node->
+00043e80: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
+00043e90: 4d4c 5f54 5950 455f 4633 3229 207b 0a20  ML_TYPE_F32) {. 
+00043ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043eb0: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
+00043ec0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00043ed0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00043ee0: 7365 2069 6620 2871 7561 6e74 697a 655f  se if (quantize_
+00043ef0: 666e 735b 6e6f 6465 2d3e 7372 6330 2d3e  fns[node->src0->
+00043f00: 7479 7065 5d2e 7665 635f 646f 745f 7120  type].vec_dot_q 
+00043f10: 2626 206e 6f64 652d 3e73 7263 312d 3e74  && node->src1->t
+00043f20: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00043f30: 5f46 3332 2920 7b0a 2369 6620 6465 6669  _F32) {.#if defi
+00043f40: 6e65 6428 4747 4d4c 5f55 5345 5f41 4343  ned(GGML_USE_ACC
+00043f50: 454c 4552 4154 4529 207c 7c20 6465 6669  ELERATE) || defi
+00043f60: 6e65 6428 4747 4d4c 5f55 5345 5f4f 5045  ned(GGML_USE_OPE
+00043f70: 4e42 4c41 5329 0a20 2020 2020 2020 2020  NBLAS).         
+00043f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043f90: 2020 2069 6620 2867 676d 6c5f 636f 6d70     if (ggml_comp
+00043fa0: 7574 655f 666f 7277 6172 645f 6d75 6c5f  ute_forward_mul_
+00043fb0: 6d61 745f 7573 655f 626c 6173 286e 6f64  mat_use_blas(nod
+00043fc0: 652d 3e73 7263 302c 206e 6f64 652d 3e73  e->src0, node->s
+00043fd0: 7263 312c 206e 6f64 6529 2920 7b0a 2020  rc1, node)) {.  
+00043fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043ff0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00044000: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
+00044010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044030: 2063 7572 203d 2047 474d 4c5f 5459 5045   cur = GGML_TYPE
+00044040: 5f53 495a 455b 4747 4d4c 5f54 5950 455f  _SIZE[GGML_TYPE_
+00044050: 4633 325d 2a28 6e6f 6465 2d3e 7372 6330  F32]*(node->src0
+00044060: 2d3e 6e65 5b30 5d2a 6e6f 6465 2d3e 7372  ->ne[0]*node->sr
+00044070: 6330 2d3e 6e65 5b31 5d29 3b0a 2020 2020  c0->ne[1]);.    
+00044080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044090: 2020 2020 2020 2020 7d20 656c 7365 0a23          } else.#
+000440a0: 656e 6469 660a 2020 2020 2020 2020 2020  endif.          
+000440b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000440c0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000440d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000440e0: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
+000440f0: 5950 455f 5349 5a45 5b6e 6f64 652d 3e73  YPE_SIZE[node->s
+00044100: 7263 302d 3e74 7970 655d 2a67 676d 6c5f  rc0->type]*ggml_
+00044110: 6e65 6c65 6d65 6e74 7328 6e6f 6465 2d3e  nelements(node->
+00044120: 7372 6331 292f 4747 4d4c 5f42 4c43 4b5f  src1)/GGML_BLCK_
+00044130: 5349 5a45 5b6e 6f64 652d 3e73 7263 302d  SIZE[node->src0-
+00044140: 3e74 7970 655d 3b0a 2020 2020 2020 2020  >type];.        
+00044150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044160: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00044170: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+00044180: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+00044190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000441a0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+000441b0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+000441c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000441d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000441e0: 2020 2020 2020 2020 2020 776f 726b 5f73            work_s
+000441f0: 697a 6520 3d20 4d41 5828 776f 726b 5f73  ize = MAX(work_s
+00044200: 697a 652c 2063 7572 293b 0a20 2020 2020  ize, cur);.     
+00044210: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00044220: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00044230: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00044240: 4c5f 4f50 5f53 4341 4c45 3a0a 2020 2020  L_OP_SCALE:.    
+00044250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044260: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00044270: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+00044280: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
+00044290: 6164 733b 0a20 2020 2020 2020 2020 2020  ads;.           
+000442a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000442b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000442c0: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+000442d0: 5059 3a0a 2020 2020 2020 2020 2020 2020  PY:.            
+000442e0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000442f0: 5f52 4553 4841 5045 3a0a 2020 2020 2020  _RESHAPE:.      
+00044300: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00044310: 474d 4c5f 4f50 5f56 4945 573a 0a20 2020  GML_OP_VIEW:.   
+00044320: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00044330: 6520 4747 4d4c 5f4f 505f 5045 524d 5554  e GGML_OP_PERMUT
+00044340: 453a 0a20 2020 2020 2020 2020 2020 2020  E:.             
+00044350: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00044360: 5452 414e 5350 4f53 453a 0a20 2020 2020  TRANSPOSE:.     
+00044370: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00044380: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
+00044390: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000443a0: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
+000443b0: 4941 475f 4d41 534b 5f49 4e46 3a0a 2020  IAG_MASK_INF:.  
+000443c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000443d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000443e0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000443f0: 2d3e 6e5f 7461 736b 7320 3d20 313b 0a20  ->n_tasks = 1;. 
+00044400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044410: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00044420: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00044430: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
+00044440: 583a 0a20 2020 2020 2020 2020 2020 2020  X:.             
+00044450: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00044460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044470: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
+00044480: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
+00044490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000444a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+000444b0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+000444c0: 4d4c 5f4f 505f 524f 5045 3a0a 2020 2020  ML_OP_ROPE:.    
+000444d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000444e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000444f0: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+00044500: 6e5f 7461 736b 7320 3d20 313b 0a20 2020  n_tasks = 1;.   
+00044510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044520: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00044530: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00044540: 474d 4c5f 4f50 5f43 4f4e 565f 3144 5f31  GML_OP_CONV_1D_1
+00044550: 533a 0a20 2020 2020 2020 2020 2020 2020  S:.             
+00044560: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00044570: 434f 4e56 5f31 445f 3253 3a0a 2020 2020  CONV_1D_2S:.    
+00044580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044590: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000445a0: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+000445b0: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
+000445c0: 6164 733b 0a0a 2020 2020 2020 2020 2020  ads;..          
+000445d0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+000445e0: 4d4c 5f41 5353 4552 5428 6e6f 6465 2d3e  ML_ASSERT(node->
+000445f0: 7372 6330 2d3e 6e65 5b33 5d20 3d3d 2031  src0->ne[3] == 1
+00044600: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00044610: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00044620: 4153 5345 5254 286e 6f64 652d 3e73 7263  ASSERT(node->src
+00044630: 312d 3e6e 655b 325d 203d 3d20 3129 3b0a  1->ne[2] == 1);.
+00044640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044650: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00044660: 4552 5428 6e6f 6465 2d3e 7372 6331 2d3e  ERT(node->src1->
+00044670: 6e65 5b33 5d20 3d3d 2031 293b 0a0a 2020  ne[3] == 1);..  
+00044680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044690: 2020 2020 2020 7369 7a65 5f74 2063 7572        size_t cur
+000446a0: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+000446b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000446c0: 6e73 7420 696e 7420 6e6b 203d 206e 6f64  nst int nk = nod
+000446d0: 652d 3e73 7263 302d 3e6e 655b 305d 3b0a  e->src0->ne[0];.
+000446e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000446f0: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
+00044700: 652d 3e73 7263 302d 3e74 7970 6520 3d3d  e->src0->type ==
+00044710: 2047 474d 4c5f 5459 5045 5f46 3136 2026   GGML_TYPE_F16 &
+00044720: 260a 2020 2020 2020 2020 2020 2020 2020  &.              
+00044730: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00044740: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
+00044750: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+00044760: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00044770: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00044780: 7572 203d 2073 697a 656f 6628 6767 6d6c  ur = sizeof(ggml
+00044790: 5f66 7031 365f 7429 2a28 0a20 2020 2020  _fp16_t)*(.     
+000447a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000447b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000447c0: 6b2a 6767 6d6c 5f75 7033 3228 6e6f 6465  k*ggml_up32(node
+000447d0: 2d3e 7372 6330 2d3e 6e65 5b31 5d29 2a6e  ->src0->ne[1])*n
+000447e0: 6f64 652d 3e73 7263 302d 3e6e 655b 325d  ode->src0->ne[2]
+000447f0: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+00044800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044810: 2020 2020 2020 2028 2032 2a28 6e6b 2f32         ( 2*(nk/2
+00044820: 2920 2b20 6e6f 6465 2d3e 7372 6331 2d3e  ) + node->src1->
+00044830: 6e65 5b30 5d29 2a6e 6f64 652d 3e73 7263  ne[0])*node->src
+00044840: 312d 3e6e 655b 315d 0a20 2020 2020 2020  1->ne[1].       
+00044850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044860: 2020 2020 2020 2020 2020 2020 2029 3b0a               );.
+00044870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044880: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
+00044890: 6620 286e 6f64 652d 3e73 7263 302d 3e74  f (node->src0->t
+000448a0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+000448b0: 5f46 3332 2026 260a 2020 2020 2020 2020  _F32 &&.        
+000448c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000448d0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+000448e0: 3e73 7263 312d 3e74 7970 6520 3d3d 2047  >src1->type == G
+000448f0: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
+00044900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044910: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+00044920: 3d20 7369 7a65 6f66 2866 6c6f 6174 292a  = sizeof(float)*
+00044930: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00044940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044950: 2020 2020 2020 6e6b 2a67 676d 6c5f 7570        nk*ggml_up
+00044960: 3332 286e 6f64 652d 3e73 7263 302d 3e6e  32(node->src0->n
+00044970: 655b 315d 292a 6e6f 6465 2d3e 7372 6330  e[1])*node->src0
+00044980: 2d3e 6e65 5b32 5d20 2b0a 2020 2020 2020  ->ne[2] +.      
+00044990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000449a0: 2020 2020 2020 2020 2020 2020 2020 2820                ( 
+000449b0: 322a 286e 6b2f 3229 202b 206e 6f64 652d  2*(nk/2) + node-
+000449c0: 3e73 7263 312d 3e6e 655b 305d 292a 6e6f  >src1->ne[0])*no
+000449d0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d0a  de->src1->ne[1].
+000449e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000449f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044a00: 2020 2020 293b 0a20 2020 2020 2020 2020      );.         
+00044a10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00044a20: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00044a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044a40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00044a50: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00044a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044a70: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00044a80: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
+00044a90: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
+00044aa0: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
+00044ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044ac0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00044ad0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00044ae0: 4d4c 5f4f 505f 464c 4153 485f 4154 544e  ML_OP_FLASH_ATTN
+00044af0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00044b00: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00044b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044b20: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
+00044b30: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
+00044b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044b50: 2020 2020 7369 7a65 5f74 2063 7572 203d      size_t cur =
+00044b60: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
+00044b70: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00044b80: 7374 2069 6e74 206e 6531 3120 3d20 6767  st int ne11 = gg
+00044b90: 6d6c 5f75 7028 6e6f 6465 2d3e 7372 6331  ml_up(node->src1
+00044ba0: 2d3e 6e65 5b31 5d2c 2047 474d 4c5f 534f  ->ne[1], GGML_SO
+00044bb0: 4654 5f4d 4158 5f55 4e52 4f4c 4c29 3b0a  FT_MAX_UNROLL);.
+00044bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044bd0: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
+00044be0: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
+00044bf0: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
+00044c00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00044c10: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00044c20: 7220 203d 2073 697a 656f 6628 666c 6f61  r  = sizeof(floa
+00044c30: 7429 2a6e 6531 312a 6e6f 6465 2d3e 6e5f  t)*ne11*node->n_
+00044c40: 7461 736b 733b 202f 2f20 544f 444f 3a20  tasks; // TODO: 
+00044c50: 7468 6973 2063 616e 2062 6563 6f6d 6520  this can become 
+00044c60: 286e 5f74 6173 6b73 2d31 290a 2020 2020  (n_tasks-1).    
+00044c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044c80: 2020 2020 2020 2020 6375 7220 2b3d 2073          cur += s
+00044c90: 697a 656f 6628 666c 6f61 7429 2a6e 6531  izeof(float)*ne1
+00044ca0: 312a 6e6f 6465 2d3e 6e5f 7461 736b 733b  1*node->n_tasks;
+00044cb0: 202f 2f20 7468 6973 2069 7320 6f76 6572   // this is over
+00044cc0: 6573 7469 6d61 7465 6420 6279 2078 320a  estimated by x2.
+00044cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044ce0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00044cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044d00: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
+00044d10: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
+00044d20: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
+00044d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044d40: 2020 2020 2020 2020 6375 7220 203d 2073          cur  = s
+00044d50: 697a 656f 6628 666c 6f61 7429 2a6e 6531  izeof(float)*ne1
+00044d60: 312a 6e6f 6465 2d3e 6e5f 7461 736b 733b  1*node->n_tasks;
+00044d70: 202f 2f20 544f 444f 3a20 7468 6973 2063   // TODO: this c
+00044d80: 616e 2062 6563 6f6d 6520 286e 5f74 6173  an become (n_tas
+00044d90: 6b73 2d31 290a 2020 2020 2020 2020 2020  ks-1).          
+00044da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044db0: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
+00044dc0: 666c 6f61 7429 2a6e 6531 312a 6e6f 6465  float)*ne11*node
+00044dd0: 2d3e 6e5f 7461 736b 733b 202f 2f20 7468  ->n_tasks; // th
+00044de0: 6973 2069 7320 6f76 6572 6573 7469 6d61  is is overestima
+00044df0: 7465 6420 6279 2078 320a 2020 2020 2020  ted by x2.      
+00044e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044e10: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00044e20: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+00044e30: 6b5f 7369 7a65 203d 204d 4158 2877 6f72  k_size = MAX(wor
+00044e40: 6b5f 7369 7a65 2c20 6375 7229 3b0a 2020  k_size, cur);.  
+00044e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044e60: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00044e70: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00044e80: 4747 4d4c 5f4f 505f 464c 4153 485f 4646  GGML_OP_FLASH_FF
+00044e90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00044ea0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00044eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044ec0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
+00044ed0: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
+00044ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044ef0: 2020 2020 7369 7a65 5f74 2063 7572 203d      size_t cur =
+00044f00: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
+00044f10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00044f20: 286e 6f64 652d 3e73 7263 312d 3e74 7970  (node->src1->typ
+00044f30: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+00044f40: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
+00044f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044f60: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
+00044f70: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
+00044f80: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
+00044f90: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
+00044fa0: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
+00044fb0: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
+00044fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044fd0: 2020 2020 2020 2020 2063 7572 202b 3d20           cur += 
+00044fe0: 7369 7a65 6f66 2866 6c6f 6174 292a 6e6f  sizeof(float)*no
+00044ff0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2a  de->src1->ne[1]*
+00045000: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
+00045010: 2f20 7468 6973 2069 7320 6f76 6572 6573  / this is overes
+00045020: 7469 6d61 7465 6420 6279 2078 320a 2020  timated by x2.  
+00045030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045040: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00045050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045060: 2069 6620 286e 6f64 652d 3e73 7263 312d   if (node->src1-
+00045070: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00045080: 5045 5f46 3136 2920 7b0a 2020 2020 2020  PE_F16) {.      
+00045090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000450a0: 2020 2020 2020 6375 7220 203d 2073 697a        cur  = siz
+000450b0: 656f 6628 666c 6f61 7429 2a6e 6f64 652d  eof(float)*node-
+000450c0: 3e73 7263 312d 3e6e 655b 315d 2a6e 6f64  >src1->ne[1]*nod
+000450d0: 652d 3e6e 5f74 6173 6b73 3b20 2f2f 2054  e->n_tasks; // T
+000450e0: 4f44 4f3a 2074 6869 7320 6361 6e20 6265  ODO: this can be
+000450f0: 636f 6d65 2028 6e5f 7461 736b 732d 3129  come (n_tasks-1)
+00045100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045110: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00045120: 202b 3d20 7369 7a65 6f66 2866 6c6f 6174   += sizeof(float
+00045130: 292a 6e6f 6465 2d3e 7372 6331 2d3e 6e65  )*node->src1->ne
+00045140: 5b31 5d2a 6e6f 6465 2d3e 6e5f 7461 736b  [1]*node->n_task
+00045150: 733b 202f 2f20 7468 6973 2069 7320 6f76  s; // this is ov
+00045160: 6572 6573 7469 6d61 7465 6420 6279 2078  erestimated by x
+00045170: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+00045180: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00045190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000451a0: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
+000451b0: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
+000451c0: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
+000451d0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000451e0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+000451f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00045200: 4e4f 4e45 3a0a 2020 2020 2020 2020 2020  NONE:.          
+00045210: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00045220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045230: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
+00045240: 7320 3d20 313b 0a20 2020 2020 2020 2020  s = 1;.         
+00045250: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00045260: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+00045270: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00045280: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
+00045290: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000452a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000452b0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000452c0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+000452d0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+000452e0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+000452f0: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+00045300: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
+00045310: 7068 2d3e 776f 726b 2021 3d20 4e55 4c4c  ph->work != NULL
+00045320: 2026 2620 776f 726b 5f73 697a 6520 3e20   && work_size > 
+00045330: 6367 7261 7068 2d3e 776f 726b 5f73 697a  cgraph->work_siz
+00045340: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
+00045350: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+00045360: 7365 293b 202f 2f20 544f 444f 3a20 6265  se); // TODO: be
+00045370: 7474 6572 2068 616e 646c 696e 670a 2020  tter handling.  
+00045380: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00045390: 2069 6620 2877 6f72 6b5f 7369 7a65 203e   if (work_size >
+000453a0: 2030 2026 2620 6367 7261 7068 2d3e 776f   0 && cgraph->wo
+000453b0: 726b 203d 3d20 4e55 4c4c 2920 7b0a 2020  rk == NULL) {.  
+000453c0: 2020 2020 2020 2020 2020 6367 7261 7068            cgraph
+000453d0: 2d3e 776f 726b 5f73 697a 6520 3d20 776f  ->work_size = wo
+000453e0: 726b 5f73 697a 6520 2b20 4341 4348 455f  rk_size + CACHE_
+000453f0: 4c49 4e45 5f53 495a 452a 286e 5f74 6872  LINE_SIZE*(n_thr
+00045400: 6561 6473 202d 2031 293b 0a0a 2020 2020  eads - 1);..    
+00045410: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+00045420: 4e54 5f44 4542 5547 2822 2573 3a20 616c  NT_DEBUG("%s: al
+00045430: 6c6f 6361 7469 6e67 2077 6f72 6b20 6275  locating work bu
+00045440: 6666 6572 2066 6f72 2067 7261 7068 2028  ffer for graph (
+00045450: 257a 7520 6279 7465 7329 5c6e 222c 205f  %zu bytes)\n", _
+00045460: 5f66 756e 635f 5f2c 2063 6772 6170 682d  _func__, cgraph-
+00045470: 3e77 6f72 6b5f 7369 7a65 293b 0a20 2020  >work_size);.   
+00045480: 2020 2020 2020 2020 2063 6772 6170 682d           cgraph-
+00045490: 3e77 6f72 6b20 3d20 6767 6d6c 5f6e 6577  >work = ggml_new
+000454a0: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+000454b0: 4747 4d4c 5f54 5950 455f 4938 2c20 6367  GGML_TYPE_I8, cg
+000454c0: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
+000454d0: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+000454e0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+000454f0: 3634 5f74 2070 6572 665f 7374 6172 745f  64_t perf_start_
+00045500: 6379 636c 6573 2020 3d20 6767 6d6c 5f70  cycles  = ggml_p
+00045510: 6572 665f 6379 636c 6573 2829 3b0a 2020  erf_cycles();.  
+00045520: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00045530: 7065 7266 5f73 7461 7274 5f74 696d 655f  perf_start_time_
+00045540: 7573 203d 2067 676d 6c5f 7065 7266 5f74  us = ggml_perf_t
+00045550: 696d 655f 7573 2829 3b0a 0a20 2020 2066  ime_us();..    f
+00045560: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00045570: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
+00045580: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
+00045590: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
+000455a0: 4255 475f 3528 2225 733a 2025 642f 2564  BUG_5("%s: %d/%d
+000455b0: 5c6e 222c 205f 5f66 756e 635f 5f2c 2069  \n", __func__, i
+000455c0: 2c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  , cgraph->n_node
+000455d0: 7329 3b0a 0a20 2020 2020 2020 2073 7472  s);..        str
+000455e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000455f0: 2a20 6e6f 6465 203d 2063 6772 6170 682d  * node = cgraph-
+00045600: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
+00045610: 2020 2020 2f2f 2054 4f44 4f3a 2074 6869      // TODO: thi
+00045620: 7320 636f 756c 6420 6265 2075 7365 6420  s could be used 
+00045630: 746f 2061 766f 6964 2075 6e6e 6563 6573  to avoid unneces
+00045640: 7361 7279 2063 6f6d 7075 7461 7469 6f6e  sary computation
+00045650: 732c 2062 7574 2069 7420 6e65 6564 7320  s, but it needs 
+00045660: 746f 2062 6520 696d 7072 6f76 6564 0a20  to be improved. 
+00045670: 2020 2020 2020 202f 2f69 6620 286e 6f64         //if (nod
+00045680: 652d 3e67 7261 6420 3d3d 204e 554c 4c20  e->grad == NULL 
+00045690: 2626 206e 6f64 652d 3e70 6572 665f 7275  && node->perf_ru
+000456a0: 6e73 203e 2030 2920 7b0a 2020 2020 2020  ns > 0) {.      
+000456b0: 2020 2f2f 2020 2020 636f 6e74 696e 7565    //    continue
+000456c0: 3b0a 2020 2020 2020 2020 2f2f 7d0a 0a20  ;.        //}.. 
+000456d0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+000456e0: 3634 5f74 2070 6572 665f 6e6f 6465 5f73  64_t perf_node_s
+000456f0: 7461 7274 5f63 7963 6c65 7320 203d 2067  tart_cycles  = g
+00045700: 676d 6c5f 7065 7266 5f63 7963 6c65 7328  gml_perf_cycles(
+00045710: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+00045720: 2069 6e74 3634 5f74 2070 6572 665f 6e6f   int64_t perf_no
+00045730: 6465 5f73 7461 7274 5f74 696d 655f 7573  de_start_time_us
+00045740: 203d 2067 676d 6c5f 7065 7266 5f74 696d   = ggml_perf_tim
+00045750: 655f 7573 2829 3b0a 0a20 2020 2020 2020  e_us();..       
+00045760: 202f 2f20 494e 4954 0a20 2020 2020 2020   // INIT.       
+00045770: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00045780: 7075 7465 5f70 6172 616d 7320 7061 7261  pute_params para
+00045790: 6d73 203d 207b 0a20 2020 2020 2020 2020  ms = {.         
+000457a0: 2020 202f 2a2e 7479 7065 2020 3d2a 2f20     /*.type  =*/ 
+000457b0: 4747 4d4c 5f54 4153 4b5f 494e 4954 2c0a  GGML_TASK_INIT,.
+000457c0: 2020 2020 2020 2020 2020 2020 2f2a 2e69              /*.i
+000457d0: 7468 2020 203d 2a2f 2030 2c0a 2020 2020  th   =*/ 0,.    
+000457e0: 2020 2020 2020 2020 2f2a 2e6e 7468 2020          /*.nth  
+000457f0: 203d 2a2f 206e 6f64 652d 3e6e 5f74 6173   =*/ node->n_tas
+00045800: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
+00045810: 2f2a 2e77 7369 7a65 203d 2a2f 2063 6772  /*.wsize =*/ cgr
+00045820: 6170 682d 3e77 6f72 6b20 3f20 6767 6d6c  aph->work ? ggml
+00045830: 5f6e 6279 7465 7328 6367 7261 7068 2d3e  _nbytes(cgraph->
+00045840: 776f 726b 2920 3a20 302c 0a20 2020 2020  work) : 0,.     
+00045850: 2020 2020 2020 202f 2a2e 7764 6174 6120         /*.wdata 
+00045860: 3d2a 2f20 6367 7261 7068 2d3e 776f 726b  =*/ cgraph->work
+00045870: 203f 2063 6772 6170 682d 3e77 6f72 6b2d   ? cgraph->work-
+00045880: 3e64 6174 6120 3a20 4e55 4c4c 2c0a 2020  >data : NULL,.  
+00045890: 2020 2020 2020 7d3b 0a0a 2020 2020 2020        };..      
+000458a0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000458b0: 6f72 7761 7264 2826 7061 7261 6d73 2c20  orward(&params, 
+000458c0: 6e6f 6465 293b 0a0a 2020 2020 2020 2020  node);..        
+000458d0: 2f2f 2043 4f4d 5055 5445 0a20 2020 2020  // COMPUTE.     
+000458e0: 2020 2069 6620 286e 6f64 652d 3e6e 5f74     if (node->n_t
+000458f0: 6173 6b73 203e 2031 2920 7b0a 2020 2020  asks > 1) {.    
+00045900: 2020 2020 2020 2020 6966 2028 6174 6f6d          if (atom
+00045910: 6963 5f66 6574 6368 5f61 6464 2826 7374  ic_fetch_add(&st
+00045920: 6174 655f 7368 6172 6564 2e6e 5f72 6561  ate_shared.n_rea
+00045930: 6479 2c20 3129 203d 3d20 6e5f 7468 7265  dy, 1) == n_thre
+00045940: 6164 7320 2d20 3129 207b 0a20 2020 2020  ads - 1) {.     
+00045950: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
+00045960: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
+00045970: 6861 7265 642e 6861 735f 776f 726b 2c20  hared.has_work, 
+00045980: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00045990: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+000459a0: 2020 2077 6869 6c65 2028 6174 6f6d 6963     while (atomic
+000459b0: 5f6c 6f61 6428 2673 7461 7465 5f73 6861  _load(&state_sha
+000459c0: 7265 642e 6861 735f 776f 726b 2929 207b  red.has_work)) {
+000459d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000459e0: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
+000459f0: 2028 2673 7461 7465 5f73 6861 7265 642e   (&state_shared.
+00045a00: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
+00045a10: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
+00045a20: 5f75 6e6c 6f63 6b28 2673 7461 7465 5f73  _unlock(&state_s
+00045a30: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
+00045a40: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00045a50: 2020 2020 2020 2020 2f2f 206c 6175 6e63          // launc
+00045a60: 6820 7468 7265 6164 2070 6f6f 6c0a 2020  h thread pool.  
+00045a70: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00045a80: 6e74 206a 203d 2030 3b20 6a20 3c20 6e5f  nt j = 0; j < n_
+00045a90: 7468 7265 6164 7320 2d20 313b 206a 2b2b  threads - 1; j++
+00045aa0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00045ab0: 2020 2020 776f 726b 6572 735b 6a5d 2e70      workers[j].p
+00045ac0: 6172 616d 7320 3d20 2873 7472 7563 7420  arams = (struct 
+00045ad0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00045ae0: 616d 7329 207b 0a20 2020 2020 2020 2020  ams) {.         
+00045af0: 2020 2020 2020 2020 2020 202e 7479 7065             .type
+00045b00: 2020 3d20 4747 4d4c 5f54 4153 4b5f 434f    = GGML_TASK_CO
+00045b10: 4d50 5554 452c 0a20 2020 2020 2020 2020  MPUTE,.         
+00045b20: 2020 2020 2020 2020 2020 202e 6974 6820             .ith 
+00045b30: 2020 3d20 6a20 2b20 312c 0a20 2020 2020    = j + 1,.     
+00045b40: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00045b50: 6e74 6820 2020 3d20 6e6f 6465 2d3e 6e5f  nth   = node->n_
+00045b60: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
+00045b70: 2020 2020 2020 2020 2020 202e 7773 697a             .wsiz
+00045b80: 6520 3d20 6367 7261 7068 2d3e 776f 726b  e = cgraph->work
+00045b90: 203f 2067 676d 6c5f 6e62 7974 6573 2863   ? ggml_nbytes(c
+00045ba0: 6772 6170 682d 3e77 6f72 6b29 203a 2030  graph->work) : 0
+00045bb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00045bc0: 2020 2020 2020 2e77 6461 7461 203d 2063        .wdata = c
+00045bd0: 6772 6170 682d 3e77 6f72 6b20 3f20 6367  graph->work ? cg
+00045be0: 7261 7068 2d3e 776f 726b 2d3e 6461 7461  raph->work->data
+00045bf0: 203a 204e 554c 4c2c 0a20 2020 2020 2020   : NULL,.       
+00045c00: 2020 2020 2020 2020 207d 3b0a 2020 2020           };.    
+00045c10: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00045c20: 6572 735b 6a5d 2e6e 6f64 6520 3d20 6e6f  ers[j].node = no
+00045c30: 6465 3b0a 2020 2020 2020 2020 2020 2020  de;.            
+00045c40: 7d0a 0a20 2020 2020 2020 2020 2020 2061  }..            a
+00045c50: 746f 6d69 635f 6665 7463 685f 7375 6228  tomic_fetch_sub(
+00045c60: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
+00045c70: 7265 6164 792c 2031 293b 0a0a 2020 2020  ready, 1);..    
+00045c80: 2020 2020 2020 2020 7768 696c 6520 2861          while (a
+00045c90: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
+00045ca0: 655f 7368 6172 6564 2e6e 5f72 6561 6479  e_shared.n_ready
+00045cb0: 2920 3e20 3029 207b 0a20 2020 2020 2020  ) > 0) {.       
+00045cc0: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
+00045cd0: 636b 5f6c 6f63 6b20 2028 2673 7461 7465  ck_lock  (&state
+00045ce0: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
+00045cf0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00045d00: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28  gml_lock_unlock(
+00045d10: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
+00045d20: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
+00045d30: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00045d40: 6174 6f6d 6963 5f73 746f 7265 2826 7374  atomic_store(&st
+00045d50: 6174 655f 7368 6172 6564 2e68 6173 5f77  ate_shared.has_w
+00045d60: 6f72 6b2c 2074 7275 6529 3b0a 2020 2020  ork, true);.    
+00045d70: 2020 2020 7d0a 0a20 2020 2020 2020 2070      }..        p
+00045d80: 6172 616d 732e 7479 7065 203d 2047 474d  arams.type = GGM
+00045d90: 4c5f 5441 534b 5f43 4f4d 5055 5445 3b0a  L_TASK_COMPUTE;.
+00045da0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00045db0: 7075 7465 5f66 6f72 7761 7264 2826 7061  pute_forward(&pa
+00045dc0: 7261 6d73 2c20 6e6f 6465 293b 0a0a 2020  rams, node);..  
+00045dd0: 2020 2020 2020 2f2f 2077 6169 7420 666f        // wait fo
+00045de0: 7220 7468 7265 6164 2070 6f6f 6c0a 2020  r thread pool.  
+00045df0: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+00045e00: 6e5f 7461 736b 7320 3e20 3129 207b 0a20  n_tasks > 1) {. 
+00045e10: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
+00045e20: 746f 6d69 635f 6665 7463 685f 6164 6428  tomic_fetch_add(
+00045e30: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
+00045e40: 7265 6164 792c 2031 2920 3d3d 206e 5f74  ready, 1) == n_t
+00045e50: 6872 6561 6473 202d 2031 2920 7b0a 2020  hreads - 1) {.  
+00045e60: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00045e70: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
+00045e80: 655f 7368 6172 6564 2e68 6173 5f77 6f72  e_shared.has_wor
+00045e90: 6b2c 2066 616c 7365 293b 0a20 2020 2020  k, false);.     
+00045ea0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00045eb0: 2020 2020 2020 7768 696c 6520 2861 746f        while (ato
+00045ec0: 6d69 635f 6c6f 6164 2826 7374 6174 655f  mic_load(&state_
+00045ed0: 7368 6172 6564 2e68 6173 5f77 6f72 6b29  shared.has_work)
+00045ee0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00045ef0: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
+00045f00: 636b 2020 2826 7374 6174 655f 7368 6172  ck  (&state_shar
+00045f10: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
+00045f20: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
+00045f30: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
+00045f40: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
+00045f50: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00045f60: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
+00045f70: 635f 6665 7463 685f 7375 6228 2673 7461  c_fetch_sub(&sta
+00045f80: 7465 5f73 6861 7265 642e 6e5f 7265 6164  te_shared.n_read
+00045f90: 792c 2031 293b 0a0a 2020 2020 2020 2020  y, 1);..        
+00045fa0: 2020 2020 7768 696c 6520 2861 746f 6d69      while (atomi
+00045fb0: 635f 6c6f 6164 2826 7374 6174 655f 7368  c_load(&state_sh
+00045fc0: 6172 6564 2e6e 5f72 6561 6479 2920 213d  ared.n_ready) !=
+00045fd0: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
+00045fe0: 2020 2020 2020 6767 6d6c 5f6c 6f63 6b5f        ggml_lock_
+00045ff0: 6c6f 636b 2020 2826 7374 6174 655f 7368  lock  (&state_sh
+00046000: 6172 6564 2e73 7069 6e29 3b0a 2020 2020  ared.spin);.    
+00046010: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00046020: 5f6c 6f63 6b5f 756e 6c6f 636b 2826 7374  _lock_unlock(&st
+00046030: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
+00046040: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+00046050: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00046060: 2020 202f 2f20 4649 4e41 4c49 5a45 0a20     // FINALIZE. 
+00046070: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
+00046080: 3e6e 5f74 6173 6b73 203e 2031 2920 7b0a  >n_tasks > 1) {.
+00046090: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000460a0: 6174 6f6d 6963 5f66 6574 6368 5f61 6464  atomic_fetch_add
+000460b0: 2826 7374 6174 655f 7368 6172 6564 2e6e  (&state_shared.n
+000460c0: 5f72 6561 6479 2c20 3129 203d 3d20 6e5f  _ready, 1) == n_
+000460d0: 7468 7265 6164 7320 2d20 3129 207b 0a20  threads - 1) {. 
+000460e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000460f0: 746f 6d69 635f 7374 6f72 6528 2673 7461  tomic_store(&sta
+00046100: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
+00046110: 726b 2c20 6661 6c73 6529 3b0a 2020 2020  rk, false);.    
+00046120: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00046130: 2020 2020 2020 2077 6869 6c65 2028 6174         while (at
+00046140: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
+00046150: 5f73 6861 7265 642e 6861 735f 776f 726b  _shared.has_work
+00046160: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
+00046170: 2020 2020 2067 676d 6c5f 6c6f 636b 5f6c       ggml_lock_l
+00046180: 6f63 6b20 2028 2673 7461 7465 5f73 6861  ock  (&state_sha
+00046190: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
+000461a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000461b0: 6c6f 636b 5f75 6e6c 6f63 6b28 2673 7461  lock_unlock(&sta
+000461c0: 7465 5f73 6861 7265 642e 7370 696e 293b  te_shared.spin);
+000461d0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+000461e0: 2020 2020 2020 2020 2020 2020 2f2f 206c              // l
+000461f0: 6175 6e63 6820 7468 7265 6164 2070 6f6f  aunch thread poo
+00046200: 6c0a 2020 2020 2020 2020 2020 2020 666f  l.            fo
+00046210: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+00046220: 3c20 6e5f 7468 7265 6164 7320 2d20 313b  < n_threads - 1;
+00046230: 206a 2b2b 2920 7b0a 2020 2020 2020 2020   j++) {.        
+00046240: 2020 2020 2020 2020 776f 726b 6572 735b          workers[
+00046250: 6a5d 2e70 6172 616d 7320 3d20 2873 7472  j].params = (str
+00046260: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00046270: 5f70 6172 616d 7329 207b 0a20 2020 2020  _params) {.     
+00046280: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00046290: 7479 7065 2020 3d20 4747 4d4c 5f54 4153  type  = GGML_TAS
+000462a0: 4b5f 4649 4e41 4c49 5a45 2c0a 2020 2020  K_FINALIZE,.    
+000462b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000462c0: 2e69 7468 2020 203d 206a 202b 2031 2c0a  .ith   = j + 1,.
+000462d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000462e0: 2020 2020 2e6e 7468 2020 203d 206e 6f64      .nth   = nod
+000462f0: 652d 3e6e 5f74 6173 6b73 2c0a 2020 2020  e->n_tasks,.    
+00046300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046310: 2e77 7369 7a65 203d 2063 6772 6170 682d  .wsize = cgraph-
+00046320: 3e77 6f72 6b20 3f20 6767 6d6c 5f6e 6279  >work ? ggml_nby
+00046330: 7465 7328 6367 7261 7068 2d3e 776f 726b  tes(cgraph->work
+00046340: 2920 3a20 302c 0a20 2020 2020 2020 2020  ) : 0,.         
+00046350: 2020 2020 2020 2020 2020 202e 7764 6174             .wdat
+00046360: 6120 3d20 6367 7261 7068 2d3e 776f 726b  a = cgraph->work
+00046370: 203f 2063 6772 6170 682d 3e77 6f72 6b2d   ? cgraph->work-
+00046380: 3e64 6174 6120 3a20 4e55 4c4c 2c0a 2020  >data : NULL,.  
+00046390: 2020 2020 2020 2020 2020 2020 2020 7d3b                };
+000463a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000463b0: 2077 6f72 6b65 7273 5b6a 5d2e 6e6f 6465   workers[j].node
+000463c0: 203d 206e 6f64 653b 0a20 2020 2020 2020   = node;.       
+000463d0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000463e0: 2020 2020 6174 6f6d 6963 5f66 6574 6368      atomic_fetch
+000463f0: 5f73 7562 2826 7374 6174 655f 7368 6172  _sub(&state_shar
+00046400: 6564 2e6e 5f72 6561 6479 2c20 3129 3b0a  ed.n_ready, 1);.
+00046410: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
+00046420: 6c65 2028 6174 6f6d 6963 5f6c 6f61 6428  le (atomic_load(
+00046430: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
+00046440: 7265 6164 7929 203e 2030 2920 7b0a 2020  ready) > 0) {.  
+00046450: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00046460: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020 2826  ml_lock_lock  (&
+00046470: 7374 6174 655f 7368 6172 6564 2e73 7069  state_shared.spi
+00046480: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+00046490: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 756e      ggml_lock_un
+000464a0: 6c6f 636b 2826 7374 6174 655f 7368 6172  lock(&state_shar
+000464b0: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
+000464c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000464d0: 2020 2020 2061 746f 6d69 635f 7374 6f72       atomic_stor
+000464e0: 6528 2673 7461 7465 5f73 6861 7265 642e  e(&state_shared.
+000464f0: 6861 735f 776f 726b 2c20 7472 7565 293b  has_work, true);
+00046500: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00046510: 2020 2020 7061 7261 6d73 2e74 7970 6520      params.type 
+00046520: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00046530: 4c49 5a45 3b0a 2020 2020 2020 2020 6767  LIZE;.        gg
+00046540: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00046550: 7264 2826 7061 7261 6d73 2c20 6e6f 6465  rd(&params, node
+00046560: 293b 0a0a 2020 2020 2020 2020 2f2f 2077  );..        // w
+00046570: 6169 7420 666f 7220 7468 7265 6164 2070  ait for thread p
+00046580: 6f6f 6c0a 2020 2020 2020 2020 6966 2028  ool.        if (
+00046590: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3e20  node->n_tasks > 
+000465a0: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
+000465b0: 2069 6620 2861 746f 6d69 635f 6665 7463   if (atomic_fetc
+000465c0: 685f 6164 6428 2673 7461 7465 5f73 6861  h_add(&state_sha
+000465d0: 7265 642e 6e5f 7265 6164 792c 2031 2920  red.n_ready, 1) 
+000465e0: 3d3d 206e 5f74 6872 6561 6473 202d 2031  == n_threads - 1
+000465f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00046600: 2020 2020 6174 6f6d 6963 5f73 746f 7265      atomic_store
+00046610: 2826 7374 6174 655f 7368 6172 6564 2e68  (&state_shared.h
+00046620: 6173 5f77 6f72 6b2c 2066 616c 7365 293b  as_work, false);
+00046630: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00046640: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00046650: 6520 2861 746f 6d69 635f 6c6f 6164 2826  e (atomic_load(&
+00046660: 7374 6174 655f 7368 6172 6564 2e68 6173  state_shared.has
+00046670: 5f77 6f72 6b29 2920 7b0a 2020 2020 2020  _work)) {.      
+00046680: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
+00046690: 6f63 6b5f 6c6f 636b 2020 2826 7374 6174  ock_lock  (&stat
+000466a0: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
+000466b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000466c0: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
+000466d0: 2826 7374 6174 655f 7368 6172 6564 2e73  (&state_shared.s
+000466e0: 7069 6e29 3b0a 2020 2020 2020 2020 2020  pin);.          
+000466f0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00046700: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
+00046710: 6228 2673 7461 7465 5f73 6861 7265 642e  b(&state_shared.
+00046720: 6e5f 7265 6164 792c 2031 293b 0a0a 2020  n_ready, 1);..  
+00046730: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+00046740: 2861 746f 6d69 635f 6c6f 6164 2826 7374  (atomic_load(&st
+00046750: 6174 655f 7368 6172 6564 2e6e 5f72 6561  ate_shared.n_rea
+00046760: 6479 2920 213d 2030 2920 7b0a 2020 2020  dy) != 0) {.    
+00046770: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00046780: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
+00046790: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
+000467a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000467b0: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
+000467c0: 636b 2826 7374 6174 655f 7368 6172 6564  ck(&state_shared
+000467d0: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
+000467e0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+000467f0: 0a20 2020 2020 2020 202f 2f20 7065 7266  .        // perf
+00046800: 6f72 6d61 6e63 6520 7374 6174 7320 286e  ormance stats (n
+00046810: 6f64 6529 0a20 2020 2020 2020 207b 0a20  ode).        {. 
+00046820: 2020 2020 2020 2020 2020 2069 6e74 3634             int64
+00046830: 5f74 2070 6572 665f 6379 636c 6573 5f63  _t perf_cycles_c
+00046840: 7572 2020 3d20 6767 6d6c 5f70 6572 665f  ur  = ggml_perf_
+00046850: 6379 636c 6573 2829 2020 2d20 7065 7266  cycles()  - perf
+00046860: 5f6e 6f64 655f 7374 6172 745f 6379 636c  _node_start_cycl
+00046870: 6573 3b0a 2020 2020 2020 2020 2020 2020  es;.            
+00046880: 696e 7436 345f 7420 7065 7266 5f74 696d  int64_t perf_tim
+00046890: 655f 7573 5f63 7572 203d 2067 676d 6c5f  e_us_cur = ggml_
+000468a0: 7065 7266 5f74 696d 655f 7573 2829 202d  perf_time_us() -
+000468b0: 2070 6572 665f 6e6f 6465 5f73 7461 7274   perf_node_start
+000468c0: 5f74 696d 655f 7573 3b0a 0a20 2020 2020  _time_us;..     
+000468d0: 2020 2020 2020 206e 6f64 652d 3e70 6572         node->per
+000468e0: 665f 7275 6e73 2b2b 3b0a 2020 2020 2020  f_runs++;.      
+000468f0: 2020 2020 2020 6e6f 6465 2d3e 7065 7266        node->perf
+00046900: 5f63 7963 6c65 7320 202b 3d20 7065 7266  _cycles  += perf
+00046910: 5f63 7963 6c65 735f 6375 723b 0a20 2020  _cycles_cur;.   
+00046920: 2020 2020 2020 2020 206e 6f64 652d 3e70           node->p
+00046930: 6572 665f 7469 6d65 5f75 7320 2b3d 2070  erf_time_us += p
+00046940: 6572 665f 7469 6d65 5f75 735f 6375 723b  erf_time_us_cur;
+00046950: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00046960: 0a0a 2020 2020 2f2f 206a 6f69 6e20 7468  ..    // join th
+00046970: 7265 6164 2070 6f6f 6c0a 2020 2020 6966  read pool.    if
+00046980: 2028 6e5f 7468 7265 6164 7320 3e20 3129   (n_threads > 1)
+00046990: 207b 0a20 2020 2020 2020 2061 746f 6d69   {.        atomi
+000469a0: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
+000469b0: 6861 7265 642e 7374 6f70 2c20 7472 7565  hared.stop, true
+000469c0: 293b 0a20 2020 2020 2020 2061 746f 6d69  );.        atomi
+000469d0: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
+000469e0: 6861 7265 642e 6861 735f 776f 726b 2c20  hared.has_work, 
+000469f0: 7472 7565 293b 0a0a 2020 2020 2020 2020  true);..        
+00046a00: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
+00046a10: 6a20 3c20 6e5f 7468 7265 6164 7320 2d20  j < n_threads - 
+00046a20: 313b 206a 2b2b 2920 7b0a 2020 2020 2020  1; j++) {.      
+00046a30: 2020 2020 2020 696e 7420 7263 203d 2067        int rc = g
+00046a40: 676d 6c5f 7468 7265 6164 5f6a 6f69 6e28  gml_thread_join(
+00046a50: 776f 726b 6572 735b 6a5d 2e74 6872 642c  workers[j].thrd,
+00046a60: 204e 554c 4c29 3b0a 2020 2020 2020 2020   NULL);.        
+00046a70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00046a80: 7263 203d 3d20 3029 3b0a 2020 2020 2020  rc == 0);.      
+00046a90: 2020 2020 2020 554e 5553 4544 2872 6329        UNUSED(rc)
+00046aa0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+00046ab0: 2020 2020 2067 676d 6c5f 6c6f 636b 5f64       ggml_lock_d
+00046ac0: 6573 7472 6f79 2826 7374 6174 655f 7368  estroy(&state_sh
+00046ad0: 6172 6564 2e73 7069 6e29 3b0a 2020 2020  ared.spin);.    
+00046ae0: 7d0a 0a20 2020 202f 2f20 7065 7266 6f72  }..    // perfor
+00046af0: 6d61 6e63 6520 7374 6174 7320 2867 7261  mance stats (gra
+00046b00: 7068 290a 2020 2020 7b0a 2020 2020 2020  ph).    {.      
+00046b10: 2020 696e 7436 345f 7420 7065 7266 5f63    int64_t perf_c
+00046b20: 7963 6c65 735f 6375 7220 203d 2067 676d  ycles_cur  = ggm
+00046b30: 6c5f 7065 7266 5f63 7963 6c65 7328 2920  l_perf_cycles() 
+00046b40: 202d 2070 6572 665f 7374 6172 745f 6379   - perf_start_cy
+00046b50: 636c 6573 3b0a 2020 2020 2020 2020 696e  cles;.        in
+00046b60: 7436 345f 7420 7065 7266 5f74 696d 655f  t64_t perf_time_
+00046b70: 7573 5f63 7572 203d 2067 676d 6c5f 7065  us_cur = ggml_pe
+00046b80: 7266 5f74 696d 655f 7573 2829 202d 2070  rf_time_us() - p
+00046b90: 6572 665f 7374 6172 745f 7469 6d65 5f75  erf_start_time_u
+00046ba0: 733b 0a0a 2020 2020 2020 2020 6367 7261  s;..        cgra
+00046bb0: 7068 2d3e 7065 7266 5f72 756e 732b 2b3b  ph->perf_runs++;
+00046bc0: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
+00046bd0: 3e70 6572 665f 6379 636c 6573 2020 2b3d  >perf_cycles  +=
+00046be0: 2070 6572 665f 6379 636c 6573 5f63 7572   perf_cycles_cur
+00046bf0: 3b0a 2020 2020 2020 2020 6367 7261 7068  ;.        cgraph
+00046c00: 2d3e 7065 7266 5f74 696d 655f 7573 202b  ->perf_time_us +
+00046c10: 3d20 7065 7266 5f74 696d 655f 7573 5f63  = perf_time_us_c
+00046c20: 7572 3b0a 0a20 2020 2020 2020 2047 474d  ur;..        GGM
+00046c30: 4c5f 5052 494e 545f 4445 4255 4728 2225  L_PRINT_DEBUG("%
+00046c40: 733a 2070 6572 6620 2825 6429 202d 2063  s: perf (%d) - c
+00046c50: 7075 203d 2025 2e33 6620 2f20 252e 3366  pu = %.3f / %.3f
+00046c60: 206d 732c 2077 616c 6c20 3d20 252e 3366   ms, wall = %.3f
+00046c70: 202f 2025 2e33 6620 6d73 5c6e 222c 0a20   / %.3f ms\n",. 
+00046c80: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00046c90: 5f66 756e 635f 5f2c 2063 6772 6170 682d  _func__, cgraph-
+00046ca0: 3e70 6572 665f 7275 6e73 2c0a 2020 2020  >perf_runs,.    
+00046cb0: 2020 2020 2020 2020 2020 2020 2864 6f75              (dou
+00046cc0: 626c 6529 2070 6572 665f 6379 636c 6573  ble) perf_cycles
+00046cd0: 5f63 7572 2020 2020 2020 2f20 2864 6f75  _cur      / (dou
+00046ce0: 626c 6529 2067 676d 6c5f 6379 636c 6573  ble) ggml_cycles
+00046cf0: 5f70 6572 5f6d 7328 292c 0a20 2020 2020  _per_ms(),.     
+00046d00: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
+00046d10: 6c65 2920 6367 7261 7068 2d3e 7065 7266  le) cgraph->perf
+00046d20: 5f63 7963 6c65 7320 202f 2028 646f 7562  _cycles  / (doub
+00046d30: 6c65 2920 6767 6d6c 5f63 7963 6c65 735f  le) ggml_cycles_
+00046d40: 7065 725f 6d73 2829 202f 2028 646f 7562  per_ms() / (doub
+00046d50: 6c65 2920 6367 7261 7068 2d3e 7065 7266  le) cgraph->perf
+00046d60: 5f72 756e 732c 0a20 2020 2020 2020 2020  _runs,.         
+00046d70: 2020 2020 2020 2028 646f 7562 6c65 2920         (double) 
+00046d80: 7065 7266 5f74 696d 655f 7573 5f63 7572  perf_time_us_cur
+00046d90: 2020 2020 202f 2031 3030 302e 302c 0a20       / 1000.0,. 
+00046da0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00046db0: 646f 7562 6c65 2920 6367 7261 7068 2d3e  double) cgraph->
+00046dc0: 7065 7266 5f74 696d 655f 7573 202f 2031  perf_time_us / 1
+00046dd0: 3030 302e 3020 2f20 6367 7261 7068 2d3e  000.0 / cgraph->
+00046de0: 7065 7266 5f72 756e 7329 3b0a 2020 2020  perf_runs);.    
+00046df0: 7d0a 7d0a 0a76 6f69 6420 6767 6d6c 5f67  }.}..void ggml_g
+00046e00: 7261 7068 5f72 6573 6574 2873 7472 7563  raph_reset(struc
+00046e10: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+00046e20: 6367 7261 7068 2920 7b0a 2020 2020 666f  cgraph) {.    fo
+00046e30: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00046e40: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
+00046e50: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
+00046e60: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00046e70: 6e73 6f72 202a 2067 7261 6420 3d20 6367  nsor * grad = cg
+00046e80: 7261 7068 2d3e 6772 6164 735b 695d 3b0a  raph->grads[i];.
+00046e90: 0a20 2020 2020 2020 2069 6620 2867 7261  .        if (gra
+00046ea0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00046eb0: 2067 676d 6c5f 7365 745f 7a65 726f 2867   ggml_set_zero(g
+00046ec0: 7261 6429 3b0a 2020 2020 2020 2020 7d0a  rad);.        }.
+00046ed0: 2020 2020 7d0a 7d0a 0a76 6f69 6420 6767      }.}..void gg
+00046ee0: 6d6c 5f67 7261 7068 5f70 7269 6e74 2863  ml_graph_print(c
+00046ef0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00046f00: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
+00046f10: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
+00046f20: 7065 7266 5f74 6f74 616c 5f70 6572 5f6f  perf_total_per_o
+00046f30: 705f 7573 5b47 474d 4c5f 4f50 5f43 4f55  p_us[GGML_OP_COU
+00046f40: 4e54 5d20 3d20 7b30 7d3b 0a0a 2020 2020  NT] = {0};..    
+00046f50: 4747 4d4c 5f50 5249 4e54 2822 3d3d 3d20  GGML_PRINT("=== 
+00046f60: 4752 4150 4820 3d3d 3d5c 6e22 293b 0a0a  GRAPH ===\n");..
+00046f70: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+00046f80: 4542 5547 2822 6e5f 7468 7265 6164 7320  EBUG("n_threads 
+00046f90: 2020 2020 2020 3d20 2564 5c6e 222c 2020        = %d\n",  
+00046fa0: 2020 2020 2063 6772 6170 682d 3e6e 5f74       cgraph->n_t
+00046fb0: 6872 6561 6473 293b 0a20 2020 2047 474d  hreads);.    GGM
+00046fc0: 4c5f 5052 494e 545f 4445 4255 4728 2274  L_PRINT_DEBUG("t
+00046fd0: 6f74 616c 2077 6f72 6b20 7369 7a65 203d  otal work size =
+00046fe0: 2025 7a75 2062 7974 6573 5c6e 222c 6367   %zu bytes\n",cg
+00046ff0: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
+00047000: 3b0a 0a20 2020 2047 474d 4c5f 5052 494e  ;..    GGML_PRIN
+00047010: 5428 226e 5f6e 6f64 6573 203d 2025 645c  T("n_nodes = %d\
+00047020: 6e22 2c20 6367 7261 7068 2d3e 6e5f 6e6f  n", cgraph->n_no
+00047030: 6465 7329 3b0a 2020 2020 666f 7220 2869  des);.    for (i
+00047040: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
+00047050: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
+00047060: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
+00047070: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00047080: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
+00047090: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+000470a0: 2020 2020 2070 6572 665f 746f 7461 6c5f       perf_total_
+000470b0: 7065 725f 6f70 5f75 735b 6e6f 6465 2d3e  per_op_us[node->
+000470c0: 6f70 5d20 2b3d 206e 6f64 652d 3e70 6572  op] += node->per
+000470d0: 665f 7469 6d65 5f75 733b 0a0a 2020 2020  f_time_us;..    
+000470e0: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
+000470f0: 202d 2025 3364 3a20 5b20 2536 642c 2025   - %3d: [ %6d, %
+00047100: 3664 2c20 2536 645d 2025 3136 7320 2573  6d, %6d] %16s %s
+00047110: 2028 2533 6429 2063 7075 203d 2025 372e   (%3d) cpu = %7.
+00047120: 3366 202f 2025 372e 3366 206d 732c 2077  3f / %7.3f ms, w
+00047130: 616c 6c20 3d20 2537 2e33 6620 2f20 2537  all = %7.3f / %7
+00047140: 2e33 6620 6d73 5c6e 222c 0a20 2020 2020  .3f ms\n",.     
+00047150: 2020 2020 2020 2020 2020 2069 2c0a 2020             i,.  
+00047160: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00047170: 6465 2d3e 6e65 5b30 5d2c 206e 6f64 652d  de->ne[0], node-
+00047180: 3e6e 655b 315d 2c20 6e6f 6465 2d3e 6e65  >ne[1], node->ne
+00047190: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+000471a0: 2020 2020 2047 474d 4c5f 4f50 5f4c 4142       GGML_OP_LAB
+000471b0: 454c 5b6e 6f64 652d 3e6f 705d 2c20 6e6f  EL[node->op], no
+000471c0: 6465 2d3e 6973 5f70 6172 616d 203f 2022  de->is_param ? "
+000471d0: 7822 203a 206e 6f64 652d 3e67 7261 6420  x" : node->grad 
+000471e0: 3f20 2267 2220 3a20 2220 222c 206e 6f64  ? "g" : " ", nod
+000471f0: 652d 3e70 6572 665f 7275 6e73 2c0a 2020  e->perf_runs,.  
+00047200: 2020 2020 2020 2020 2020 2020 2020 2864                (d
+00047210: 6f75 626c 6529 206e 6f64 652d 3e70 6572  ouble) node->per
+00047220: 665f 6379 636c 6573 2020 2f20 2864 6f75  f_cycles  / (dou
+00047230: 626c 6529 2067 676d 6c5f 6379 636c 6573  ble) ggml_cycles
+00047240: 5f70 6572 5f6d 7328 292c 0a20 2020 2020  _per_ms(),.     
+00047250: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
+00047260: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f63  le) node->perf_c
+00047270: 7963 6c65 7320 202f 2028 646f 7562 6c65  ycles  / (double
+00047280: 2920 6767 6d6c 5f63 7963 6c65 735f 7065  ) ggml_cycles_pe
+00047290: 725f 6d73 2829 202f 2028 646f 7562 6c65  r_ms() / (double
+000472a0: 2920 6e6f 6465 2d3e 7065 7266 5f72 756e  ) node->perf_run
+000472b0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+000472c0: 2020 2028 646f 7562 6c65 2920 6e6f 6465     (double) node
+000472d0: 2d3e 7065 7266 5f74 696d 655f 7573 202f  ->perf_time_us /
+000472e0: 2031 3030 302e 302c 0a20 2020 2020 2020   1000.0,.       
+000472f0: 2020 2020 2020 2020 2028 646f 7562 6c65           (double
+00047300: 2920 6e6f 6465 2d3e 7065 7266 5f74 696d  ) node->perf_tim
+00047310: 655f 7573 202f 2031 3030 302e 3020 2f20  e_us / 1000.0 / 
+00047320: 6e6f 6465 2d3e 7065 7266 5f72 756e 7329  node->perf_runs)
+00047330: 3b0a 2020 2020 7d0a 0a20 2020 2047 474d  ;.    }..    GGM
+00047340: 4c5f 5052 494e 5428 226e 5f6c 6561 6673  L_PRINT("n_leafs
+00047350: 203d 2025 645c 6e22 2c20 6367 7261 7068   = %d\n", cgraph
+00047360: 2d3e 6e5f 6c65 6166 7329 3b0a 2020 2020  ->n_leafs);.    
+00047370: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00047380: 6920 3c20 6367 7261 7068 2d3e 6e5f 6c65  i < cgraph->n_le
+00047390: 6166 733b 2069 2b2b 2920 7b0a 2020 2020  afs; i++) {.    
+000473a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000473b0: 7465 6e73 6f72 202a 206e 6f64 6520 3d20  tensor * node = 
+000473c0: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
+000473d0: 3b0a 0a20 2020 2020 2020 2047 474d 4c5f  ;..        GGML_
+000473e0: 5052 494e 5428 2220 2d20 2533 643a 205b  PRINT(" - %3d: [
+000473f0: 2025 3664 2c20 2536 645d 2025 3873 5c6e   %6d, %6d] %8s\n
+00047400: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00047410: 2020 2069 2c0a 2020 2020 2020 2020 2020     i,.          
+00047420: 2020 2020 2020 6e6f 6465 2d3e 6e65 5b30        node->ne[0
+00047430: 5d2c 206e 6f64 652d 3e6e 655b 315d 2c0a  ], node->ne[1],.
+00047440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047450: 4747 4d4c 5f4f 505f 4c41 4245 4c5b 6e6f  GGML_OP_LABEL[no
+00047460: 6465 2d3e 6f70 5d29 3b0a 2020 2020 7d0a  de->op]);.    }.
+00047470: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00047480: 3d20 303b 2069 203c 2047 474d 4c5f 4f50  = 0; i < GGML_OP
+00047490: 5f43 4f55 4e54 3b20 692b 2b29 207b 0a20  _COUNT; i++) {. 
+000474a0: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
+000474b0: 5428 2270 6572 665f 746f 7461 6c5f 7065  T("perf_total_pe
+000474c0: 725f 6f70 5f75 735b 2531 3673 5d20 3d20  r_op_us[%16s] = 
+000474d0: 2537 2e33 6620 6d73 5c6e 222c 2047 474d  %7.3f ms\n", GGM
+000474e0: 4c5f 4f50 5f4c 4142 454c 5b69 5d2c 2028  L_OP_LABEL[i], (
+000474f0: 646f 7562 6c65 2920 7065 7266 5f74 6f74  double) perf_tot
+00047500: 616c 5f70 6572 5f6f 705f 7573 5b69 5d20  al_per_op_us[i] 
+00047510: 2f20 3130 3030 2e30 293b 0a20 2020 207d  / 1000.0);.    }
+00047520: 0a0a 2020 2020 4747 4d4c 5f50 5249 4e54  ..    GGML_PRINT
+00047530: 2822 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ("==============
+00047540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00047550: 3d3d 3d3d 3d3d 3d3d 3d3d 5c6e 2229 3b0a  ==========\n");.
+00047560: 7d0a 0a2f 2f20 6368 6563 6b20 6966 206e  }..// check if n
+00047570: 6f64 6520 6973 2070 6172 7420 6f66 2074  ode is part of t
+00047580: 6865 2067 7261 7068 0a73 7461 7469 6320  he graph.static 
+00047590: 626f 6f6c 2067 676d 6c5f 6772 6170 685f  bool ggml_graph_
+000475a0: 6669 6e64 2863 6f6e 7374 2073 7472 7563  find(const struc
+000475b0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+000475c0: 6367 7261 7068 2c20 636f 6e73 7420 7374  cgraph, const st
+000475d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000475e0: 202a 206e 6f64 6529 207b 0a20 2020 2069   * node) {.    i
+000475f0: 6620 2863 6772 6170 6820 3d3d 204e 554c  f (cgraph == NUL
+00047600: 4c29 207b 0a20 2020 2020 2020 2072 6574  L) {.        ret
+00047610: 7572 6e20 7472 7565 3b0a 2020 2020 7d0a  urn true;.    }.
+00047620: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00047630: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
+00047640: 3e6e 5f6e 6f64 6573 3b20 692b 2b29 207b  >n_nodes; i++) {
+00047650: 0a20 2020 2020 2020 2069 6620 2863 6772  .        if (cgr
+00047660: 6170 682d 3e6e 6f64 6573 5b69 5d20 3d3d  aph->nodes[i] ==
+00047670: 206e 6f64 6529 207b 0a20 2020 2020 2020   node) {.       
+00047680: 2020 2020 2072 6574 7572 6e20 7472 7565       return true
+00047690: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+000476a0: 7d0a 0a20 2020 2072 6574 7572 6e20 6661  }..    return fa
+000476b0: 6c73 653b 0a7d 0a0a 7374 6174 6963 2073  lse;.}..static s
+000476c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000476d0: 7220 2a20 6767 6d6c 5f67 7261 7068 5f67  r * ggml_graph_g
+000476e0: 6574 5f70 6172 656e 7428 636f 6e73 7420  et_parent(const 
+000476f0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+00047700: 7068 202a 2063 6772 6170 682c 2063 6f6e  ph * cgraph, con
+00047710: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00047720: 656e 736f 7220 2a20 6e6f 6465 2920 7b0a  ensor * node) {.
+00047730: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00047740: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
+00047750: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
+00047760: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00047770: 676d 6c5f 7465 6e73 6f72 202a 2070 6172  gml_tensor * par
+00047780: 656e 7420 3d20 6367 7261 7068 2d3e 6e6f  ent = cgraph->no
+00047790: 6465 735b 695d 3b0a 0a20 2020 2020 2020  des[i];..       
+000477a0: 2069 6620 2870 6172 656e 742d 3e67 7261   if (parent->gra
+000477b0: 6420 3d3d 206e 6f64 6529 207b 0a20 2020  d == node) {.   
+000477c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000477d0: 7061 7265 6e74 3b0a 2020 2020 2020 2020  parent;.        
+000477e0: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+000477f0: 7572 6e20 4e55 4c4c 3b0a 7d0a 0a76 6f69  urn NULL;.}..voi
+00047800: 6420 6767 6d6c 5f67 7261 7068 5f64 756d  d ggml_graph_dum
+00047810: 705f 646f 7428 636f 6e73 7420 7374 7275  p_dot(const stru
+00047820: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+00047830: 2067 622c 2063 6f6e 7374 2073 7472 7563   gb, const struc
+00047840: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+00047850: 6766 2c20 636f 6e73 7420 6368 6172 202a  gf, const char *
+00047860: 2066 696c 656e 616d 6529 207b 0a20 2020   filename) {.   
+00047870: 2063 6861 7220 636f 6c6f 725b 3136 5d3b   char color[16];
+00047880: 0a0a 2020 2020 4649 4c45 202a 2066 7020  ..    FILE * fp 
+00047890: 3d20 666f 7065 6e28 6669 6c65 6e61 6d65  = fopen(filename
+000478a0: 2c20 2277 2229 3b0a 2020 2020 4747 4d4c  , "w");.    GGML
+000478b0: 5f41 5353 4552 5428 6670 293b 0a0a 2020  _ASSERT(fp);..  
+000478c0: 2020 6670 7269 6e74 6628 6670 2c20 2264    fprintf(fp, "d
+000478d0: 6967 7261 7068 2047 207b 5c6e 2229 3b0a  igraph G {\n");.
+000478e0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+000478f0: 2220 206e 6577 7261 6e6b 203d 2074 7275  "  newrank = tru
+00047900: 653b 5c6e 2229 3b0a 2020 2020 6670 7269  e;\n");.    fpri
+00047910: 6e74 6628 6670 2c20 2220 2072 616e 6b64  ntf(fp, "  rankd
+00047920: 6972 203d 204c 523b 5c6e 2229 3b0a 0a20  ir = LR;\n");.. 
+00047930: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00047940: 303b 2069 203c 2067 622d 3e6e 5f6e 6f64  0; i < gb->n_nod
+00047950: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
+00047960: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00047970: 656e 736f 7220 2a20 6e6f 6465 203d 2067  ensor * node = g
+00047980: 622d 3e6e 6f64 6573 5b69 5d3b 0a0a 2020  b->nodes[i];..  
+00047990: 2020 2020 2020 6966 2028 6767 6d6c 5f67        if (ggml_g
+000479a0: 7261 7068 5f67 6574 5f70 6172 656e 7428  raph_get_parent(
+000479b0: 6762 2c20 6e6f 6465 2920 213d 204e 554c  gb, node) != NUL
+000479c0: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+000479d0: 2063 6f6e 7469 6e75 653b 0a20 2020 2020   continue;.     
+000479e0: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
+000479f0: 2028 6e6f 6465 2d3e 6973 5f70 6172 616d   (node->is_param
+00047a00: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00047a10: 736e 7072 696e 7466 2863 6f6c 6f72 2c20  snprintf(color, 
+00047a20: 7369 7a65 6f66 2863 6f6c 6f72 292c 2022  sizeof(color), "
+00047a30: 7965 6c6c 6f77 2229 3b0a 2020 2020 2020  yellow");.      
+00047a40: 2020 7d20 656c 7365 2069 6620 286e 6f64    } else if (nod
+00047a50: 652d 3e67 7261 6429 207b 0a20 2020 2020  e->grad) {.     
+00047a60: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
+00047a70: 6772 6170 685f 6669 6e64 2867 662c 206e  graph_find(gf, n
+00047a80: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
+00047a90: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
+00047aa0: 2863 6f6c 6f72 2c20 7369 7a65 6f66 2863  (color, sizeof(c
+00047ab0: 6f6c 6f72 292c 2022 6772 6565 6e22 293b  olor), "green");
+00047ac0: 0a20 2020 2020 2020 2020 2020 207d 2065  .            } e
+00047ad0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+00047ae0: 2020 2020 2020 736e 7072 696e 7466 2863        snprintf(c
+00047af0: 6f6c 6f72 2c20 7369 7a65 6f66 2863 6f6c  olor, sizeof(col
+00047b00: 6f72 292c 2022 6c69 6768 7462 6c75 6522  or), "lightblue"
+00047b10: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00047b20: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
+00047b30: 7b0a 2020 2020 2020 2020 2020 2020 736e  {.            sn
+00047b40: 7072 696e 7466 2863 6f6c 6f72 2c20 7369  printf(color, si
+00047b50: 7a65 6f66 2863 6f6c 6f72 292c 2022 7768  zeof(color), "wh
+00047b60: 6974 6522 293b 0a20 2020 2020 2020 207d  ite");.        }
+00047b70: 0a0a 2020 2020 2020 2020 6670 7269 6e74  ..        fprint
+00047b80: 6628 6670 2c20 2220 205c 2225 705c 2220  f(fp, "  \"%p\" 
+00047b90: 5b20 5c0a 7374 796c 6520 3d20 6669 6c6c  [ \.style = fill
+00047ba0: 6564 3b20 6669 6c6c 636f 6c6f 7220 3d20  ed; fillcolor = 
+00047bb0: 2573 3b20 7368 6170 6520 3d20 7265 636f  %s; shape = reco
+00047bc0: 7264 3b20 5c0a 6c61 6265 6c3d 5c22 2564  rd; \.label=\"%d
+00047bd0: 205b 2564 2c20 2564 5d20 7c20 3c78 3e25   [%d, %d] | <x>%
+00047be0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00047bf0: 2020 2020 2876 6f69 6420 2a29 206e 6f64      (void *) nod
+00047c00: 652c 2063 6f6c 6f72 2c0a 2020 2020 2020  e, color,.      
+00047c10: 2020 2020 2020 2020 2020 692c 206e 6f64            i, nod
+00047c20: 652d 3e6e 655b 305d 2c20 6e6f 6465 2d3e  e->ne[0], node->
+00047c30: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
+00047c40: 2020 2020 2020 2047 474d 4c5f 4f50 5f53         GGML_OP_S
+00047c50: 594d 424f 4c5b 6e6f 6465 2d3e 6f70 5d29  YMBOL[node->op])
+00047c60: 3b0a 0a20 2020 2020 2020 2069 6620 286e  ;..        if (n
+00047c70: 6f64 652d 3e67 7261 6429 207b 0a20 2020  ode->grad) {.   
+00047c80: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
+00047c90: 2866 702c 2022 207c 203c 673e 2573 5c22  (fp, " | <g>%s\"
+00047ca0: 3b20 5d5c 6e22 2c20 4747 4d4c 5f4f 505f  ; ]\n", GGML_OP_
+00047cb0: 5359 4d42 4f4c 5b6e 6f64 652d 3e67 7261  SYMBOL[node->gra
+00047cc0: 642d 3e6f 705d 293b 0a20 2020 2020 2020  d->op]);.       
+00047cd0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+00047ce0: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
+00047cf0: 2c20 225c 223b 205d 5c6e 2229 3b0a 2020  , "\"; ]\n");.  
+00047d00: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+00047d10: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00047d20: 303b 2069 203c 2067 622d 3e6e 5f6c 6561  0; i < gb->n_lea
+00047d30: 6673 3b20 692b 2b29 207b 0a20 2020 2020  fs; i++) {.     
+00047d40: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00047d50: 656e 736f 7220 2a20 6e6f 6465 203d 2067  ensor * node = g
+00047d60: 622d 3e6c 6561 6673 5b69 5d3b 0a0a 2020  b->leafs[i];..  
+00047d70: 2020 2020 2020 736e 7072 696e 7466 2863        snprintf(c
+00047d80: 6f6c 6f72 2c20 7369 7a65 6f66 2863 6f6c  olor, sizeof(col
+00047d90: 6f72 292c 2022 7069 6e6b 2229 3b0a 0a20  or), "pink");.. 
+00047da0: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
+00047db0: 6e65 6c65 6d65 6e74 7328 6e6f 6465 2920  nelements(node) 
+00047dc0: 3d3d 2031 2920 7b0a 2020 2020 2020 2020  == 1) {.        
+00047dd0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+00047de0: 2220 205c 2225 705c 2220 5b20 5c0a 7374  "  \"%p\" [ \.st
+00047df0: 796c 6520 3d20 6669 6c6c 6564 3b20 6669  yle = filled; fi
+00047e00: 6c6c 636f 6c6f 7220 3d20 2573 3b20 7368  llcolor = %s; sh
+00047e10: 6170 6520 3d20 7265 636f 7264 3b20 5c0a  ape = record; \.
+00047e20: 6c61 6265 6c3d 5c22 3c78 3e25 2e31 655c  label=\"<x>%.1e\
+00047e30: 223b 205d 5c6e 222c 0a20 2020 2020 2020  "; ]\n",.       
+00047e40: 2020 2020 2020 2020 2020 2020 2028 766f               (vo
+00047e50: 6964 202a 2920 6e6f 6465 2c20 636f 6c6f  id *) node, colo
+00047e60: 722c 2028 646f 7562 6c65 2967 676d 6c5f  r, (double)ggml_
+00047e70: 6765 745f 6633 325f 3164 286e 6f64 652c  get_f32_1d(node,
+00047e80: 2030 2929 3b0a 2020 2020 2020 2020 7d20   0));.        } 
+00047e90: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+00047ea0: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+00047eb0: 2020 5c22 2570 5c22 205b 205c 0a73 7479    \"%p\" [ \.sty
+00047ec0: 6c65 203d 2066 696c 6c65 643b 2066 696c  le = filled; fil
+00047ed0: 6c63 6f6c 6f72 203d 2025 733b 2073 6861  lcolor = %s; sha
+00047ee0: 7065 203d 2072 6563 6f72 643b 205c 0a6c  pe = record; \.l
+00047ef0: 6162 656c 3d5c 223c 783e 434f 4e53 5420  abel=\"<x>CONST 
+00047f00: 2564 205b 2564 2c20 2564 5d5c 223b 205d  %d [%d, %d]\"; ]
+00047f10: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+00047f20: 2020 2020 2020 2020 2028 766f 6964 202a           (void *
+00047f30: 2920 6e6f 6465 2c20 636f 6c6f 722c 0a20  ) node, color,. 
+00047f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047f50: 2020 2069 2c20 6e6f 6465 2d3e 6e65 5b30     i, node->ne[0
+00047f60: 5d2c 206e 6f64 652d 3e6e 655b 315d 293b  ], node->ne[1]);
+00047f70: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00047f80: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00047f90: 203d 2030 3b20 6920 3c20 6762 2d3e 6e5f   = 0; i < gb->n_
+00047fa0: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+00047fb0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00047fc0: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
+00047fd0: 3d20 6762 2d3e 6e6f 6465 735b 695d 3b0a  = gb->nodes[i];.
+00047fe0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00047ff0: 6767 6d6c 5f74 656e 736f 7220 2a20 7061  ggml_tensor * pa
+00048000: 7265 6e74 203d 2067 676d 6c5f 6772 6170  rent = ggml_grap
+00048010: 685f 6765 745f 7061 7265 6e74 2867 622c  h_get_parent(gb,
+00048020: 206e 6f64 6529 3b0a 0a20 2020 2020 2020   node);..       
+00048030: 2069 6620 286e 6f64 652d 3e73 7263 3029   if (node->src0)
+00048040: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
+00048050: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00048060: 7220 2a20 7061 7265 6e74 3020 3d20 6767  r * parent0 = gg
+00048070: 6d6c 5f67 7261 7068 5f67 6574 5f70 6172  ml_graph_get_par
+00048080: 656e 7428 6762 2c20 6e6f 6465 2d3e 7372  ent(gb, node->sr
+00048090: 6330 293b 0a0a 2020 2020 2020 2020 2020  c0);..          
+000480a0: 2020 6670 7269 6e74 6628 6670 2c20 2220    fprintf(fp, " 
+000480b0: 205c 2225 705c 223a 2573 202d 3e20 5c22   \"%p\":%s -> \"
+000480c0: 2570 5c22 3a25 7320 5b20 6172 726f 7768  %p\":%s [ arrowh
+000480d0: 6561 6420 3d20 2573 3b20 7374 796c 6520  ead = %s; style 
+000480e0: 3d20 2573 3b20 6c61 6265 6c20 3d20 5c22  = %s; label = \"
+000480f0: 785c 223b 205d 5c6e 222c 0a20 2020 2020  x\"; ]\n",.     
+00048100: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00048110: 6172 656e 7430 203f 2028 766f 6964 202a  arent0 ? (void *
+00048120: 2920 7061 7265 6e74 3020 3a20 2876 6f69  ) parent0 : (voi
+00048130: 6420 2a29 206e 6f64 652d 3e73 7263 302c  d *) node->src0,
+00048140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048150: 2020 2020 2070 6172 656e 7430 203f 2022       parent0 ? "
+00048160: 6722 203a 2022 7822 2c0a 2020 2020 2020  g" : "x",.      
+00048170: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00048180: 7265 6e74 203f 2028 766f 6964 202a 2920  rent ? (void *) 
+00048190: 7061 7265 6e74 203a 2028 766f 6964 202a  parent : (void *
+000481a0: 2920 6e6f 6465 2c0a 2020 2020 2020 2020  ) node,.        
+000481b0: 2020 2020 2020 2020 2020 2020 7061 7265              pare
+000481c0: 6e74 203f 2022 6722 203a 2022 7822 2c0a  nt ? "g" : "x",.
 000481d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000481e0: 2020 2020 2020 6e6b 2a67 676d 6c5f 7570        nk*ggml_up
-000481f0: 3332 286e 6f64 652d 3e73 7263 302d 3e6e  32(node->src0->n
-00048200: 655b 315d 292a 6e6f 6465 2d3e 7372 6330  e[1])*node->src0
-00048210: 2d3e 6e65 5b32 5d20 2b0a 2020 2020 2020  ->ne[2] +.      
-00048220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048230: 2020 2020 2020 2020 2020 2020 2020 2820                ( 
-00048240: 322a 286e 6b2f 3229 202b 206e 6f64 652d  2*(nk/2) + node-
-00048250: 3e73 7263 312d 3e6e 655b 305d 292a 6e6f  >src1->ne[0])*no
-00048260: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d0a  de->src1->ne[1].
-00048270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048290: 2020 2020 293b 0a20 2020 2020 2020 2020      );.         
-000482a0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000482b0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-000482c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000482d0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000482e0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-000482f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048300: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-00048310: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
-00048320: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
-00048330: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
-00048340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048350: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00048360: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00048370: 4d4c 5f4f 505f 464c 4153 485f 4154 544e  ML_OP_FLASH_ATTN
-00048380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00048390: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000483a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000483b0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-000483c0: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
-000483d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000483e0: 2020 2020 7369 7a65 5f74 2063 7572 203d      size_t cur =
-000483f0: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
-00048400: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00048410: 7374 2069 6e74 206e 6531 3120 3d20 6767  st int ne11 = gg
-00048420: 6d6c 5f75 7028 6e6f 6465 2d3e 7372 6331  ml_up(node->src1
-00048430: 2d3e 6e65 5b31 5d2c 2047 474d 4c5f 534f  ->ne[1], GGML_SO
-00048440: 4654 5f4d 4158 5f55 4e52 4f4c 4c29 3b0a  FT_MAX_UNROLL);.
-00048450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048460: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
-00048470: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
-00048480: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
-00048490: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000484a0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-000484b0: 7220 203d 2073 697a 656f 6628 666c 6f61  r  = sizeof(floa
-000484c0: 7429 2a6e 6531 312a 6e6f 6465 2d3e 6e5f  t)*ne11*node->n_
-000484d0: 7461 736b 733b 202f 2f20 544f 444f 3a20  tasks; // TODO: 
-000484e0: 7468 6973 2063 616e 2062 6563 6f6d 6520  this can become 
-000484f0: 286e 5f74 6173 6b73 2d31 290a 2020 2020  (n_tasks-1).    
-00048500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048510: 2020 2020 2020 2020 6375 7220 2b3d 2073          cur += s
-00048520: 697a 656f 6628 666c 6f61 7429 2a6e 6531  izeof(float)*ne1
-00048530: 312a 6e6f 6465 2d3e 6e5f 7461 736b 733b  1*node->n_tasks;
-00048540: 202f 2f20 7468 6973 2069 7320 6f76 6572   // this is over
-00048550: 6573 7469 6d61 7465 6420 6279 2078 320a  estimated by x2.
-00048560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048570: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00048580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048590: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
-000485a0: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-000485b0: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
-000485c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000485d0: 2020 2020 2020 2020 6375 7220 203d 2073          cur  = s
-000485e0: 697a 656f 6628 666c 6f61 7429 2a6e 6531  izeof(float)*ne1
-000485f0: 312a 6e6f 6465 2d3e 6e5f 7461 736b 733b  1*node->n_tasks;
-00048600: 202f 2f20 544f 444f 3a20 7468 6973 2063   // TODO: this c
-00048610: 616e 2062 6563 6f6d 6520 286e 5f74 6173  an become (n_tas
-00048620: 6b73 2d31 290a 2020 2020 2020 2020 2020  ks-1).          
-00048630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048640: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
-00048650: 666c 6f61 7429 2a6e 6531 312a 6e6f 6465  float)*ne11*node
-00048660: 2d3e 6e5f 7461 736b 733b 202f 2f20 7468  ->n_tasks; // th
-00048670: 6973 2069 7320 6f76 6572 6573 7469 6d61  is is overestima
-00048680: 7465 6420 6279 2078 320a 2020 2020 2020  ted by x2.      
-00048690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000486a0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-000486b0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-000486c0: 6b5f 7369 7a65 203d 204d 4158 2877 6f72  k_size = MAX(wor
-000486d0: 6b5f 7369 7a65 2c20 6375 7229 3b0a 2020  k_size, cur);.  
-000486e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000486f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00048700: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00048710: 4747 4d4c 5f4f 505f 464c 4153 485f 4646  GGML_OP_FLASH_FF
-00048720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00048730: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00048740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048750: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-00048760: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
-00048770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048780: 2020 2020 7369 7a65 5f74 2063 7572 203d      size_t cur =
-00048790: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
-000487a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000487b0: 286e 6f64 652d 3e73 7263 312d 3e74 7970  (node->src1->typ
-000487c0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-000487d0: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
-000487e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000487f0: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
-00048800: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
-00048810: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
-00048820: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
-00048830: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
-00048840: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
-00048850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048860: 2020 2020 2020 2020 2063 7572 202b 3d20           cur += 
-00048870: 7369 7a65 6f66 2866 6c6f 6174 292a 6e6f  sizeof(float)*no
-00048880: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2a  de->src1->ne[1]*
-00048890: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
-000488a0: 2f20 7468 6973 2069 7320 6f76 6572 6573  / this is overes
-000488b0: 7469 6d61 7465 6420 6279 2078 320a 2020  timated by x2.  
-000488c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000488d0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000488e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000488f0: 2069 6620 286e 6f64 652d 3e73 7263 312d   if (node->src1-
-00048900: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00048910: 5045 5f46 3136 2920 7b0a 2020 2020 2020  PE_F16) {.      
-00048920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048930: 2020 2020 2020 6375 7220 203d 2073 697a        cur  = siz
-00048940: 656f 6628 666c 6f61 7429 2a6e 6f64 652d  eof(float)*node-
-00048950: 3e73 7263 312d 3e6e 655b 315d 2a6e 6f64  >src1->ne[1]*nod
-00048960: 652d 3e6e 5f74 6173 6b73 3b20 2f2f 2054  e->n_tasks; // T
-00048970: 4f44 4f3a 2074 6869 7320 6361 6e20 6265  ODO: this can be
-00048980: 636f 6d65 2028 6e5f 7461 736b 732d 3129  come (n_tasks-1)
-00048990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000489a0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-000489b0: 202b 3d20 7369 7a65 6f66 2866 6c6f 6174   += sizeof(float
-000489c0: 292a 6e6f 6465 2d3e 7372 6331 2d3e 6e65  )*node->src1->ne
-000489d0: 5b31 5d2a 6e6f 6465 2d3e 6e5f 7461 736b  [1]*node->n_task
-000489e0: 733b 202f 2f20 7468 6973 2069 7320 6f76  s; // this is ov
-000489f0: 6572 6573 7469 6d61 7465 6420 6279 2078  erestimated by x
-00048a00: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-00048a10: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00048a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048a30: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
-00048a40: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
-00048a50: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
-00048a60: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00048a70: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00048a80: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00048a90: 4e4f 4e45 3a0a 2020 2020 2020 2020 2020  NONE:.          
-00048aa0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00048ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048ac0: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
-00048ad0: 7320 3d20 313b 0a20 2020 2020 2020 2020  s = 1;.         
-00048ae0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00048af0: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
-00048b00: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00048b10: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
-00048b20: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00048b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048b40: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00048b50: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00048b60: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00048b70: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00048b80: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
-00048b90: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
-00048ba0: 7068 2d3e 776f 726b 2021 3d20 4e55 4c4c  ph->work != NULL
-00048bb0: 2026 2620 776f 726b 5f73 697a 6520 3e20   && work_size > 
-00048bc0: 6367 7261 7068 2d3e 776f 726b 5f73 697a  cgraph->work_siz
-00048bd0: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
-00048be0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00048bf0: 7365 293b 202f 2f20 544f 444f 3a20 6265  se); // TODO: be
-00048c00: 7474 6572 2068 616e 646c 696e 670a 2020  tter handling.  
-00048c10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00048c20: 2069 6620 2877 6f72 6b5f 7369 7a65 203e   if (work_size >
-00048c30: 2030 2026 2620 6367 7261 7068 2d3e 776f   0 && cgraph->wo
-00048c40: 726b 203d 3d20 4e55 4c4c 2920 7b0a 2020  rk == NULL) {.  
-00048c50: 2020 2020 2020 2020 2020 6367 7261 7068            cgraph
-00048c60: 2d3e 776f 726b 5f73 697a 6520 3d20 776f  ->work_size = wo
-00048c70: 726b 5f73 697a 6520 2b20 4341 4348 455f  rk_size + CACHE_
-00048c80: 4c49 4e45 5f53 495a 452a 286e 5f74 6872  LINE_SIZE*(n_thr
-00048c90: 6561 6473 202d 2031 293b 0a0a 2020 2020  eads - 1);..    
-00048ca0: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
-00048cb0: 4e54 5f44 4542 5547 2822 2573 3a20 616c  NT_DEBUG("%s: al
-00048cc0: 6c6f 6361 7469 6e67 2077 6f72 6b20 6275  locating work bu
-00048cd0: 6666 6572 2066 6f72 2067 7261 7068 2028  ffer for graph (
-00048ce0: 257a 7520 6279 7465 7329 5c6e 222c 205f  %zu bytes)\n", _
-00048cf0: 5f66 756e 635f 5f2c 2063 6772 6170 682d  _func__, cgraph-
-00048d00: 3e77 6f72 6b5f 7369 7a65 293b 0a20 2020  >work_size);.   
-00048d10: 2020 2020 2020 2020 2063 6772 6170 682d           cgraph-
-00048d20: 3e77 6f72 6b20 3d20 6767 6d6c 5f6e 6577  >work = ggml_new
-00048d30: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-00048d40: 4747 4d4c 5f54 5950 455f 4938 2c20 6367  GGML_TYPE_I8, cg
-00048d50: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
-00048d60: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-00048d70: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-00048d80: 3634 5f74 2070 6572 665f 7374 6172 745f  64_t perf_start_
-00048d90: 6379 636c 6573 2020 3d20 6767 6d6c 5f70  cycles  = ggml_p
-00048da0: 6572 665f 6379 636c 6573 2829 3b0a 2020  erf_cycles();.  
-00048db0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00048dc0: 7065 7266 5f73 7461 7274 5f74 696d 655f  perf_start_time_
-00048dd0: 7573 203d 2067 676d 6c5f 7065 7266 5f74  us = ggml_perf_t
-00048de0: 696d 655f 7573 2829 3b0a 0a20 2020 2066  ime_us();..    f
-00048df0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00048e00: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
-00048e10: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
-00048e20: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
-00048e30: 4255 475f 3528 2225 733a 2025 642f 2564  BUG_5("%s: %d/%d
-00048e40: 5c6e 222c 205f 5f66 756e 635f 5f2c 2069  \n", __func__, i
-00048e50: 2c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  , cgraph->n_node
-00048e60: 7329 3b0a 0a20 2020 2020 2020 2073 7472  s);..        str
-00048e70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00048e80: 2a20 6e6f 6465 203d 2063 6772 6170 682d  * node = cgraph-
-00048e90: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
-00048ea0: 2020 2020 2f2f 2054 4f44 4f3a 2074 6869      // TODO: thi
-00048eb0: 7320 636f 756c 6420 6265 2075 7365 6420  s could be used 
-00048ec0: 746f 2061 766f 6964 2075 6e6e 6563 6573  to avoid unneces
-00048ed0: 7361 7279 2063 6f6d 7075 7461 7469 6f6e  sary computation
-00048ee0: 732c 2062 7574 2069 7420 6e65 6564 7320  s, but it needs 
-00048ef0: 746f 2062 6520 696d 7072 6f76 6564 0a20  to be improved. 
-00048f00: 2020 2020 2020 202f 2f69 6620 286e 6f64         //if (nod
-00048f10: 652d 3e67 7261 6420 3d3d 204e 554c 4c20  e->grad == NULL 
-00048f20: 2626 206e 6f64 652d 3e70 6572 665f 7275  && node->perf_ru
-00048f30: 6e73 203e 2030 2920 7b0a 2020 2020 2020  ns > 0) {.      
-00048f40: 2020 2f2f 2020 2020 636f 6e74 696e 7565    //    continue
-00048f50: 3b0a 2020 2020 2020 2020 2f2f 7d0a 0a20  ;.        //}.. 
-00048f60: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00048f70: 3634 5f74 2070 6572 665f 6e6f 6465 5f73  64_t perf_node_s
-00048f80: 7461 7274 5f63 7963 6c65 7320 203d 2067  tart_cycles  = g
-00048f90: 676d 6c5f 7065 7266 5f63 7963 6c65 7328  gml_perf_cycles(
-00048fa0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-00048fb0: 2069 6e74 3634 5f74 2070 6572 665f 6e6f   int64_t perf_no
-00048fc0: 6465 5f73 7461 7274 5f74 696d 655f 7573  de_start_time_us
-00048fd0: 203d 2067 676d 6c5f 7065 7266 5f74 696d   = ggml_perf_tim
-00048fe0: 655f 7573 2829 3b0a 0a20 2020 2020 2020  e_us();..       
-00048ff0: 202f 2f20 494e 4954 0a20 2020 2020 2020   // INIT.       
-00049000: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00049010: 7075 7465 5f70 6172 616d 7320 7061 7261  pute_params para
-00049020: 6d73 203d 207b 0a20 2020 2020 2020 2020  ms = {.         
-00049030: 2020 202f 2a2e 7479 7065 2020 3d2a 2f20     /*.type  =*/ 
-00049040: 4747 4d4c 5f54 4153 4b5f 494e 4954 2c0a  GGML_TASK_INIT,.
-00049050: 2020 2020 2020 2020 2020 2020 2f2a 2e69              /*.i
-00049060: 7468 2020 203d 2a2f 2030 2c0a 2020 2020  th   =*/ 0,.    
-00049070: 2020 2020 2020 2020 2f2a 2e6e 7468 2020          /*.nth  
-00049080: 203d 2a2f 206e 6f64 652d 3e6e 5f74 6173   =*/ node->n_tas
-00049090: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
-000490a0: 2f2a 2e77 7369 7a65 203d 2a2f 2063 6772  /*.wsize =*/ cgr
-000490b0: 6170 682d 3e77 6f72 6b20 3f20 6767 6d6c  aph->work ? ggml
-000490c0: 5f6e 6279 7465 7328 6367 7261 7068 2d3e  _nbytes(cgraph->
-000490d0: 776f 726b 2920 3a20 302c 0a20 2020 2020  work) : 0,.     
-000490e0: 2020 2020 2020 202f 2a2e 7764 6174 6120         /*.wdata 
-000490f0: 3d2a 2f20 6367 7261 7068 2d3e 776f 726b  =*/ cgraph->work
-00049100: 203f 2063 6772 6170 682d 3e77 6f72 6b2d   ? cgraph->work-
-00049110: 3e64 6174 6120 3a20 4e55 4c4c 2c0a 2020  >data : NULL,.  
-00049120: 2020 2020 2020 7d3b 0a0a 2020 2020 2020        };..      
-00049130: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00049140: 6f72 7761 7264 2826 7061 7261 6d73 2c20  orward(&params, 
-00049150: 6e6f 6465 293b 0a0a 2020 2020 2020 2020  node);..        
-00049160: 2f2f 2043 4f4d 5055 5445 0a20 2020 2020  // COMPUTE.     
-00049170: 2020 2069 6620 286e 6f64 652d 3e6e 5f74     if (node->n_t
-00049180: 6173 6b73 203e 2031 2920 7b0a 2020 2020  asks > 1) {.    
-00049190: 2020 2020 2020 2020 6966 2028 6174 6f6d          if (atom
-000491a0: 6963 5f66 6574 6368 5f61 6464 2826 7374  ic_fetch_add(&st
-000491b0: 6174 655f 7368 6172 6564 2e6e 5f72 6561  ate_shared.n_rea
-000491c0: 6479 2c20 3129 203d 3d20 6e5f 7468 7265  dy, 1) == n_thre
-000491d0: 6164 7320 2d20 3129 207b 0a20 2020 2020  ads - 1) {.     
-000491e0: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
-000491f0: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
-00049200: 6861 7265 642e 6861 735f 776f 726b 2c20  hared.has_work, 
-00049210: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00049220: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00049230: 2020 2077 6869 6c65 2028 6174 6f6d 6963     while (atomic
-00049240: 5f6c 6f61 6428 2673 7461 7465 5f73 6861  _load(&state_sha
-00049250: 7265 642e 6861 735f 776f 726b 2929 207b  red.has_work)) {
-00049260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049270: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
-00049280: 2028 2673 7461 7465 5f73 6861 7265 642e   (&state_shared.
-00049290: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
-000492a0: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
-000492b0: 5f75 6e6c 6f63 6b28 2673 7461 7465 5f73  _unlock(&state_s
-000492c0: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
-000492d0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-000492e0: 2020 2020 2020 2020 2f2f 206c 6175 6e63          // launc
-000492f0: 6820 7468 7265 6164 2070 6f6f 6c0a 2020  h thread pool.  
-00049300: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00049310: 6e74 206a 203d 2030 3b20 6a20 3c20 6e5f  nt j = 0; j < n_
-00049320: 7468 7265 6164 7320 2d20 313b 206a 2b2b  threads - 1; j++
-00049330: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00049340: 2020 2020 776f 726b 6572 735b 6a5d 2e70      workers[j].p
-00049350: 6172 616d 7320 3d20 2873 7472 7563 7420  arams = (struct 
-00049360: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00049370: 616d 7329 207b 0a20 2020 2020 2020 2020  ams) {.         
-00049380: 2020 2020 2020 2020 2020 202e 7479 7065             .type
-00049390: 2020 3d20 4747 4d4c 5f54 4153 4b5f 434f    = GGML_TASK_CO
-000493a0: 4d50 5554 452c 0a20 2020 2020 2020 2020  MPUTE,.         
-000493b0: 2020 2020 2020 2020 2020 202e 6974 6820             .ith 
-000493c0: 2020 3d20 6a20 2b20 312c 0a20 2020 2020    = j + 1,.     
-000493d0: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-000493e0: 6e74 6820 2020 3d20 6e6f 6465 2d3e 6e5f  nth   = node->n_
-000493f0: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
-00049400: 2020 2020 2020 2020 2020 202e 7773 697a             .wsiz
-00049410: 6520 3d20 6367 7261 7068 2d3e 776f 726b  e = cgraph->work
-00049420: 203f 2067 676d 6c5f 6e62 7974 6573 2863   ? ggml_nbytes(c
-00049430: 6772 6170 682d 3e77 6f72 6b29 203a 2030  graph->work) : 0
-00049440: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00049450: 2020 2020 2020 2e77 6461 7461 203d 2063        .wdata = c
-00049460: 6772 6170 682d 3e77 6f72 6b20 3f20 6367  graph->work ? cg
-00049470: 7261 7068 2d3e 776f 726b 2d3e 6461 7461  raph->work->data
-00049480: 203a 204e 554c 4c2c 0a20 2020 2020 2020   : NULL,.       
-00049490: 2020 2020 2020 2020 207d 3b0a 2020 2020           };.    
-000494a0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000494b0: 6572 735b 6a5d 2e6e 6f64 6520 3d20 6e6f  ers[j].node = no
-000494c0: 6465 3b0a 2020 2020 2020 2020 2020 2020  de;.            
-000494d0: 7d0a 0a20 2020 2020 2020 2020 2020 2061  }..            a
-000494e0: 746f 6d69 635f 6665 7463 685f 7375 6228  tomic_fetch_sub(
-000494f0: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
-00049500: 7265 6164 792c 2031 293b 0a0a 2020 2020  ready, 1);..    
-00049510: 2020 2020 2020 2020 7768 696c 6520 2861          while (a
-00049520: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
-00049530: 655f 7368 6172 6564 2e6e 5f72 6561 6479  e_shared.n_ready
-00049540: 2920 3e20 3029 207b 0a20 2020 2020 2020  ) > 0) {.       
-00049550: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
-00049560: 636b 5f6c 6f63 6b20 2028 2673 7461 7465  ck_lock  (&state
-00049570: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
-00049580: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00049590: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28  gml_lock_unlock(
-000495a0: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
-000495b0: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
-000495c0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-000495d0: 6174 6f6d 6963 5f73 746f 7265 2826 7374  atomic_store(&st
-000495e0: 6174 655f 7368 6172 6564 2e68 6173 5f77  ate_shared.has_w
-000495f0: 6f72 6b2c 2074 7275 6529 3b0a 2020 2020  ork, true);.    
-00049600: 2020 2020 7d0a 0a20 2020 2020 2020 2070      }..        p
-00049610: 6172 616d 732e 7479 7065 203d 2047 474d  arams.type = GGM
-00049620: 4c5f 5441 534b 5f43 4f4d 5055 5445 3b0a  L_TASK_COMPUTE;.
-00049630: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00049640: 7075 7465 5f66 6f72 7761 7264 2826 7061  pute_forward(&pa
-00049650: 7261 6d73 2c20 6e6f 6465 293b 0a0a 2020  rams, node);..  
-00049660: 2020 2020 2020 2f2f 2077 6169 7420 666f        // wait fo
-00049670: 7220 7468 7265 6164 2070 6f6f 6c0a 2020  r thread pool.  
-00049680: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
-00049690: 6e5f 7461 736b 7320 3e20 3129 207b 0a20  n_tasks > 1) {. 
-000496a0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
-000496b0: 746f 6d69 635f 6665 7463 685f 6164 6428  tomic_fetch_add(
-000496c0: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
-000496d0: 7265 6164 792c 2031 2920 3d3d 206e 5f74  ready, 1) == n_t
-000496e0: 6872 6561 6473 202d 2031 2920 7b0a 2020  hreads - 1) {.  
-000496f0: 2020 2020 2020 2020 2020 2020 2020 6174                at
-00049700: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
-00049710: 655f 7368 6172 6564 2e68 6173 5f77 6f72  e_shared.has_wor
-00049720: 6b2c 2066 616c 7365 293b 0a20 2020 2020  k, false);.     
-00049730: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00049740: 2020 2020 2020 7768 696c 6520 2861 746f        while (ato
-00049750: 6d69 635f 6c6f 6164 2826 7374 6174 655f  mic_load(&state_
-00049760: 7368 6172 6564 2e68 6173 5f77 6f72 6b29  shared.has_work)
-00049770: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00049780: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
-00049790: 636b 2020 2826 7374 6174 655f 7368 6172  ck  (&state_shar
-000497a0: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
-000497b0: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
-000497c0: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
-000497d0: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
-000497e0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-000497f0: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
-00049800: 635f 6665 7463 685f 7375 6228 2673 7461  c_fetch_sub(&sta
-00049810: 7465 5f73 6861 7265 642e 6e5f 7265 6164  te_shared.n_read
-00049820: 792c 2031 293b 0a0a 2020 2020 2020 2020  y, 1);..        
-00049830: 2020 2020 7768 696c 6520 2861 746f 6d69      while (atomi
-00049840: 635f 6c6f 6164 2826 7374 6174 655f 7368  c_load(&state_sh
-00049850: 6172 6564 2e6e 5f72 6561 6479 2920 213d  ared.n_ready) !=
-00049860: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-00049870: 2020 2020 2020 6767 6d6c 5f6c 6f63 6b5f        ggml_lock_
-00049880: 6c6f 636b 2020 2826 7374 6174 655f 7368  lock  (&state_sh
-00049890: 6172 6564 2e73 7069 6e29 3b0a 2020 2020  ared.spin);.    
-000498a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000498b0: 5f6c 6f63 6b5f 756e 6c6f 636b 2826 7374  _lock_unlock(&st
-000498c0: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
-000498d0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-000498e0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000498f0: 2020 202f 2f20 4649 4e41 4c49 5a45 0a20     // FINALIZE. 
-00049900: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
-00049910: 3e6e 5f74 6173 6b73 203e 2031 2920 7b0a  >n_tasks > 1) {.
-00049920: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00049930: 6174 6f6d 6963 5f66 6574 6368 5f61 6464  atomic_fetch_add
-00049940: 2826 7374 6174 655f 7368 6172 6564 2e6e  (&state_shared.n
-00049950: 5f72 6561 6479 2c20 3129 203d 3d20 6e5f  _ready, 1) == n_
-00049960: 7468 7265 6164 7320 2d20 3129 207b 0a20  threads - 1) {. 
-00049970: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00049980: 746f 6d69 635f 7374 6f72 6528 2673 7461  tomic_store(&sta
-00049990: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
-000499a0: 726b 2c20 6661 6c73 6529 3b0a 2020 2020  rk, false);.    
-000499b0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000499c0: 2020 2020 2020 2077 6869 6c65 2028 6174         while (at
-000499d0: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
-000499e0: 5f73 6861 7265 642e 6861 735f 776f 726b  _shared.has_work
-000499f0: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
-00049a00: 2020 2020 2067 676d 6c5f 6c6f 636b 5f6c       ggml_lock_l
-00049a10: 6f63 6b20 2028 2673 7461 7465 5f73 6861  ock  (&state_sha
-00049a20: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
-00049a30: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00049a40: 6c6f 636b 5f75 6e6c 6f63 6b28 2673 7461  lock_unlock(&sta
-00049a50: 7465 5f73 6861 7265 642e 7370 696e 293b  te_shared.spin);
-00049a60: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00049a70: 2020 2020 2020 2020 2020 2020 2f2f 206c              // l
-00049a80: 6175 6e63 6820 7468 7265 6164 2070 6f6f  aunch thread poo
-00049a90: 6c0a 2020 2020 2020 2020 2020 2020 666f  l.            fo
-00049aa0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-00049ab0: 3c20 6e5f 7468 7265 6164 7320 2d20 313b  < n_threads - 1;
-00049ac0: 206a 2b2b 2920 7b0a 2020 2020 2020 2020   j++) {.        
-00049ad0: 2020 2020 2020 2020 776f 726b 6572 735b          workers[
-00049ae0: 6a5d 2e70 6172 616d 7320 3d20 2873 7472  j].params = (str
-00049af0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00049b00: 5f70 6172 616d 7329 207b 0a20 2020 2020  _params) {.     
-00049b10: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00049b20: 7479 7065 2020 3d20 4747 4d4c 5f54 4153  type  = GGML_TAS
-00049b30: 4b5f 4649 4e41 4c49 5a45 2c0a 2020 2020  K_FINALIZE,.    
-00049b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049b50: 2e69 7468 2020 203d 206a 202b 2031 2c0a  .ith   = j + 1,.
-00049b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049b70: 2020 2020 2e6e 7468 2020 203d 206e 6f64      .nth   = nod
-00049b80: 652d 3e6e 5f74 6173 6b73 2c0a 2020 2020  e->n_tasks,.    
-00049b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049ba0: 2e77 7369 7a65 203d 2063 6772 6170 682d  .wsize = cgraph-
-00049bb0: 3e77 6f72 6b20 3f20 6767 6d6c 5f6e 6279  >work ? ggml_nby
-00049bc0: 7465 7328 6367 7261 7068 2d3e 776f 726b  tes(cgraph->work
-00049bd0: 2920 3a20 302c 0a20 2020 2020 2020 2020  ) : 0,.         
-00049be0: 2020 2020 2020 2020 2020 202e 7764 6174             .wdat
-00049bf0: 6120 3d20 6367 7261 7068 2d3e 776f 726b  a = cgraph->work
-00049c00: 203f 2063 6772 6170 682d 3e77 6f72 6b2d   ? cgraph->work-
-00049c10: 3e64 6174 6120 3a20 4e55 4c4c 2c0a 2020  >data : NULL,.  
-00049c20: 2020 2020 2020 2020 2020 2020 2020 7d3b                };
-00049c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049c40: 2077 6f72 6b65 7273 5b6a 5d2e 6e6f 6465   workers[j].node
-00049c50: 203d 206e 6f64 653b 0a20 2020 2020 2020   = node;.       
-00049c60: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00049c70: 2020 2020 6174 6f6d 6963 5f66 6574 6368      atomic_fetch
-00049c80: 5f73 7562 2826 7374 6174 655f 7368 6172  _sub(&state_shar
-00049c90: 6564 2e6e 5f72 6561 6479 2c20 3129 3b0a  ed.n_ready, 1);.
-00049ca0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-00049cb0: 6c65 2028 6174 6f6d 6963 5f6c 6f61 6428  le (atomic_load(
-00049cc0: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
-00049cd0: 7265 6164 7929 203e 2030 2920 7b0a 2020  ready) > 0) {.  
-00049ce0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00049cf0: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020 2826  ml_lock_lock  (&
-00049d00: 7374 6174 655f 7368 6172 6564 2e73 7069  state_shared.spi
-00049d10: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-00049d20: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 756e      ggml_lock_un
-00049d30: 6c6f 636b 2826 7374 6174 655f 7368 6172  lock(&state_shar
-00049d40: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
-00049d50: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00049d60: 2020 2020 2061 746f 6d69 635f 7374 6f72       atomic_stor
-00049d70: 6528 2673 7461 7465 5f73 6861 7265 642e  e(&state_shared.
-00049d80: 6861 735f 776f 726b 2c20 7472 7565 293b  has_work, true);
-00049d90: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00049da0: 2020 2020 7061 7261 6d73 2e74 7970 6520      params.type 
-00049db0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00049dc0: 4c49 5a45 3b0a 2020 2020 2020 2020 6767  LIZE;.        gg
-00049dd0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00049de0: 7264 2826 7061 7261 6d73 2c20 6e6f 6465  rd(&params, node
-00049df0: 293b 0a0a 2020 2020 2020 2020 2f2f 2077  );..        // w
-00049e00: 6169 7420 666f 7220 7468 7265 6164 2070  ait for thread p
-00049e10: 6f6f 6c0a 2020 2020 2020 2020 6966 2028  ool.        if (
-00049e20: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3e20  node->n_tasks > 
-00049e30: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00049e40: 2069 6620 2861 746f 6d69 635f 6665 7463   if (atomic_fetc
-00049e50: 685f 6164 6428 2673 7461 7465 5f73 6861  h_add(&state_sha
-00049e60: 7265 642e 6e5f 7265 6164 792c 2031 2920  red.n_ready, 1) 
-00049e70: 3d3d 206e 5f74 6872 6561 6473 202d 2031  == n_threads - 1
-00049e80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00049e90: 2020 2020 6174 6f6d 6963 5f73 746f 7265      atomic_store
-00049ea0: 2826 7374 6174 655f 7368 6172 6564 2e68  (&state_shared.h
-00049eb0: 6173 5f77 6f72 6b2c 2066 616c 7365 293b  as_work, false);
-00049ec0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00049ed0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-00049ee0: 6520 2861 746f 6d69 635f 6c6f 6164 2826  e (atomic_load(&
-00049ef0: 7374 6174 655f 7368 6172 6564 2e68 6173  state_shared.has
-00049f00: 5f77 6f72 6b29 2920 7b0a 2020 2020 2020  _work)) {.      
-00049f10: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
-00049f20: 6f63 6b5f 6c6f 636b 2020 2826 7374 6174  ock_lock  (&stat
-00049f30: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
-00049f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049f50: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
-00049f60: 2826 7374 6174 655f 7368 6172 6564 2e73  (&state_shared.s
-00049f70: 7069 6e29 3b0a 2020 2020 2020 2020 2020  pin);.          
-00049f80: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00049f90: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
-00049fa0: 6228 2673 7461 7465 5f73 6861 7265 642e  b(&state_shared.
-00049fb0: 6e5f 7265 6164 792c 2031 293b 0a0a 2020  n_ready, 1);..  
-00049fc0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00049fd0: 2861 746f 6d69 635f 6c6f 6164 2826 7374  (atomic_load(&st
-00049fe0: 6174 655f 7368 6172 6564 2e6e 5f72 6561  ate_shared.n_rea
-00049ff0: 6479 2920 213d 2030 2920 7b0a 2020 2020  dy) != 0) {.    
-0004a000: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0004a010: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
-0004a020: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
-0004a030: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0004a040: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
-0004a050: 636b 2826 7374 6174 655f 7368 6172 6564  ck(&state_shared
-0004a060: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
-0004a070: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-0004a080: 0a20 2020 2020 2020 202f 2f20 7065 7266  .        // perf
-0004a090: 6f72 6d61 6e63 6520 7374 6174 7320 286e  ormance stats (n
-0004a0a0: 6f64 6529 0a20 2020 2020 2020 207b 0a20  ode).        {. 
-0004a0b0: 2020 2020 2020 2020 2020 2069 6e74 3634             int64
-0004a0c0: 5f74 2070 6572 665f 6379 636c 6573 5f63  _t perf_cycles_c
-0004a0d0: 7572 2020 3d20 6767 6d6c 5f70 6572 665f  ur  = ggml_perf_
-0004a0e0: 6379 636c 6573 2829 2020 2d20 7065 7266  cycles()  - perf
-0004a0f0: 5f6e 6f64 655f 7374 6172 745f 6379 636c  _node_start_cycl
-0004a100: 6573 3b0a 2020 2020 2020 2020 2020 2020  es;.            
-0004a110: 696e 7436 345f 7420 7065 7266 5f74 696d  int64_t perf_tim
-0004a120: 655f 7573 5f63 7572 203d 2067 676d 6c5f  e_us_cur = ggml_
-0004a130: 7065 7266 5f74 696d 655f 7573 2829 202d  perf_time_us() -
-0004a140: 2070 6572 665f 6e6f 6465 5f73 7461 7274   perf_node_start
-0004a150: 5f74 696d 655f 7573 3b0a 0a20 2020 2020  _time_us;..     
-0004a160: 2020 2020 2020 206e 6f64 652d 3e70 6572         node->per
-0004a170: 665f 7275 6e73 2b2b 3b0a 2020 2020 2020  f_runs++;.      
-0004a180: 2020 2020 2020 6e6f 6465 2d3e 7065 7266        node->perf
-0004a190: 5f63 7963 6c65 7320 202b 3d20 7065 7266  _cycles  += perf
-0004a1a0: 5f63 7963 6c65 735f 6375 723b 0a20 2020  _cycles_cur;.   
-0004a1b0: 2020 2020 2020 2020 206e 6f64 652d 3e70           node->p
-0004a1c0: 6572 665f 7469 6d65 5f75 7320 2b3d 2070  erf_time_us += p
-0004a1d0: 6572 665f 7469 6d65 5f75 735f 6375 723b  erf_time_us_cur;
-0004a1e0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0004a1f0: 0a0a 2020 2020 2f2f 206a 6f69 6e20 7468  ..    // join th
-0004a200: 7265 6164 2070 6f6f 6c0a 2020 2020 6966  read pool.    if
-0004a210: 2028 6e5f 7468 7265 6164 7320 3e20 3129   (n_threads > 1)
-0004a220: 207b 0a20 2020 2020 2020 2061 746f 6d69   {.        atomi
-0004a230: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
-0004a240: 6861 7265 642e 7374 6f70 2c20 7472 7565  hared.stop, true
-0004a250: 293b 0a20 2020 2020 2020 2061 746f 6d69  );.        atomi
-0004a260: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
-0004a270: 6861 7265 642e 6861 735f 776f 726b 2c20  hared.has_work, 
-0004a280: 7472 7565 293b 0a0a 2020 2020 2020 2020  true);..        
-0004a290: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-0004a2a0: 6a20 3c20 6e5f 7468 7265 6164 7320 2d20  j < n_threads - 
-0004a2b0: 313b 206a 2b2b 2920 7b0a 2020 2020 2020  1; j++) {.      
-0004a2c0: 2020 2020 2020 696e 7420 7263 203d 2067        int rc = g
-0004a2d0: 676d 6c5f 7468 7265 6164 5f6a 6f69 6e28  gml_thread_join(
-0004a2e0: 776f 726b 6572 735b 6a5d 2e74 6872 642c  workers[j].thrd,
-0004a2f0: 204e 554c 4c29 3b0a 2020 2020 2020 2020   NULL);.        
-0004a300: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0004a310: 7263 203d 3d20 3029 3b0a 2020 2020 2020  rc == 0);.      
-0004a320: 2020 2020 2020 554e 5553 4544 2872 6329        UNUSED(rc)
-0004a330: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-0004a340: 2020 2020 2067 676d 6c5f 6c6f 636b 5f64       ggml_lock_d
-0004a350: 6573 7472 6f79 2826 7374 6174 655f 7368  estroy(&state_sh
-0004a360: 6172 6564 2e73 7069 6e29 3b0a 2020 2020  ared.spin);.    
-0004a370: 7d0a 0a20 2020 202f 2f20 7065 7266 6f72  }..    // perfor
-0004a380: 6d61 6e63 6520 7374 6174 7320 2867 7261  mance stats (gra
-0004a390: 7068 290a 2020 2020 7b0a 2020 2020 2020  ph).    {.      
-0004a3a0: 2020 696e 7436 345f 7420 7065 7266 5f63    int64_t perf_c
-0004a3b0: 7963 6c65 735f 6375 7220 203d 2067 676d  ycles_cur  = ggm
-0004a3c0: 6c5f 7065 7266 5f63 7963 6c65 7328 2920  l_perf_cycles() 
-0004a3d0: 202d 2070 6572 665f 7374 6172 745f 6379   - perf_start_cy
-0004a3e0: 636c 6573 3b0a 2020 2020 2020 2020 696e  cles;.        in
-0004a3f0: 7436 345f 7420 7065 7266 5f74 696d 655f  t64_t perf_time_
-0004a400: 7573 5f63 7572 203d 2067 676d 6c5f 7065  us_cur = ggml_pe
-0004a410: 7266 5f74 696d 655f 7573 2829 202d 2070  rf_time_us() - p
-0004a420: 6572 665f 7374 6172 745f 7469 6d65 5f75  erf_start_time_u
-0004a430: 733b 0a0a 2020 2020 2020 2020 6367 7261  s;..        cgra
-0004a440: 7068 2d3e 7065 7266 5f72 756e 732b 2b3b  ph->perf_runs++;
-0004a450: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
-0004a460: 3e70 6572 665f 6379 636c 6573 2020 2b3d  >perf_cycles  +=
-0004a470: 2070 6572 665f 6379 636c 6573 5f63 7572   perf_cycles_cur
-0004a480: 3b0a 2020 2020 2020 2020 6367 7261 7068  ;.        cgraph
-0004a490: 2d3e 7065 7266 5f74 696d 655f 7573 202b  ->perf_time_us +
-0004a4a0: 3d20 7065 7266 5f74 696d 655f 7573 5f63  = perf_time_us_c
-0004a4b0: 7572 3b0a 0a20 2020 2020 2020 2047 474d  ur;..        GGM
-0004a4c0: 4c5f 5052 494e 545f 4445 4255 4728 2225  L_PRINT_DEBUG("%
-0004a4d0: 733a 2070 6572 6620 2825 6429 202d 2063  s: perf (%d) - c
-0004a4e0: 7075 203d 2025 2e33 6620 2f20 252e 3366  pu = %.3f / %.3f
-0004a4f0: 206d 732c 2077 616c 6c20 3d20 252e 3366   ms, wall = %.3f
-0004a500: 202f 2025 2e33 6620 6d73 5c6e 222c 0a20   / %.3f ms\n",. 
-0004a510: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0004a520: 5f66 756e 635f 5f2c 2063 6772 6170 682d  _func__, cgraph-
-0004a530: 3e70 6572 665f 7275 6e73 2c0a 2020 2020  >perf_runs,.    
-0004a540: 2020 2020 2020 2020 2020 2020 2864 6f75              (dou
-0004a550: 626c 6529 2070 6572 665f 6379 636c 6573  ble) perf_cycles
-0004a560: 5f63 7572 2020 2020 2020 2f20 2864 6f75  _cur      / (dou
-0004a570: 626c 6529 2067 676d 6c5f 6379 636c 6573  ble) ggml_cycles
-0004a580: 5f70 6572 5f6d 7328 292c 0a20 2020 2020  _per_ms(),.     
-0004a590: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
-0004a5a0: 6c65 2920 6367 7261 7068 2d3e 7065 7266  le) cgraph->perf
-0004a5b0: 5f63 7963 6c65 7320 202f 2028 646f 7562  _cycles  / (doub
-0004a5c0: 6c65 2920 6767 6d6c 5f63 7963 6c65 735f  le) ggml_cycles_
-0004a5d0: 7065 725f 6d73 2829 202f 2028 646f 7562  per_ms() / (doub
-0004a5e0: 6c65 2920 6367 7261 7068 2d3e 7065 7266  le) cgraph->perf
-0004a5f0: 5f72 756e 732c 0a20 2020 2020 2020 2020  _runs,.         
-0004a600: 2020 2020 2020 2028 646f 7562 6c65 2920         (double) 
-0004a610: 7065 7266 5f74 696d 655f 7573 5f63 7572  perf_time_us_cur
-0004a620: 2020 2020 202f 2031 3030 302e 302c 0a20       / 1000.0,. 
-0004a630: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0004a640: 646f 7562 6c65 2920 6367 7261 7068 2d3e  double) cgraph->
-0004a650: 7065 7266 5f74 696d 655f 7573 202f 2031  perf_time_us / 1
-0004a660: 3030 302e 3020 2f20 6367 7261 7068 2d3e  000.0 / cgraph->
-0004a670: 7065 7266 5f72 756e 7329 3b0a 2020 2020  perf_runs);.    
-0004a680: 7d0a 7d0a 0a76 6f69 6420 6767 6d6c 5f67  }.}..void ggml_g
-0004a690: 7261 7068 5f72 6573 6574 2873 7472 7563  raph_reset(struc
-0004a6a0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-0004a6b0: 6367 7261 7068 2920 7b0a 2020 2020 666f  cgraph) {.    fo
-0004a6c0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0004a6d0: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
-0004a6e0: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-0004a6f0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0004a700: 6e73 6f72 202a 2067 7261 6420 3d20 6367  nsor * grad = cg
-0004a710: 7261 7068 2d3e 6772 6164 735b 695d 3b0a  raph->grads[i];.
-0004a720: 0a20 2020 2020 2020 2069 6620 2867 7261  .        if (gra
-0004a730: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0004a740: 2067 676d 6c5f 7365 745f 7a65 726f 2867   ggml_set_zero(g
-0004a750: 7261 6429 3b0a 2020 2020 2020 2020 7d0a  rad);.        }.
-0004a760: 2020 2020 7d0a 7d0a 0a76 6f69 6420 6767      }.}..void gg
-0004a770: 6d6c 5f67 7261 7068 5f70 7269 6e74 2863  ml_graph_print(c
-0004a780: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0004a790: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-0004a7a0: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
-0004a7b0: 7065 7266 5f74 6f74 616c 5f70 6572 5f6f  perf_total_per_o
-0004a7c0: 705f 7573 5b47 474d 4c5f 4f50 5f43 4f55  p_us[GGML_OP_COU
-0004a7d0: 4e54 5d20 3d20 7b30 7d3b 0a0a 2020 2020  NT] = {0};..    
-0004a7e0: 4747 4d4c 5f50 5249 4e54 2822 3d3d 3d20  GGML_PRINT("=== 
-0004a7f0: 4752 4150 4820 3d3d 3d5c 6e22 293b 0a0a  GRAPH ===\n");..
-0004a800: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-0004a810: 4542 5547 2822 6e5f 7468 7265 6164 7320  EBUG("n_threads 
-0004a820: 2020 2020 2020 3d20 2564 5c6e 222c 2020        = %d\n",  
-0004a830: 2020 2020 2063 6772 6170 682d 3e6e 5f74       cgraph->n_t
-0004a840: 6872 6561 6473 293b 0a20 2020 2047 474d  hreads);.    GGM
-0004a850: 4c5f 5052 494e 545f 4445 4255 4728 2274  L_PRINT_DEBUG("t
-0004a860: 6f74 616c 2077 6f72 6b20 7369 7a65 203d  otal work size =
-0004a870: 2025 7a75 2062 7974 6573 5c6e 222c 6367   %zu bytes\n",cg
-0004a880: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
-0004a890: 3b0a 0a20 2020 2047 474d 4c5f 5052 494e  ;..    GGML_PRIN
-0004a8a0: 5428 226e 5f6e 6f64 6573 203d 2025 645c  T("n_nodes = %d\
-0004a8b0: 6e22 2c20 6367 7261 7068 2d3e 6e5f 6e6f  n", cgraph->n_no
-0004a8c0: 6465 7329 3b0a 2020 2020 666f 7220 2869  des);.    for (i
-0004a8d0: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
-0004a8e0: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
-0004a8f0: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
-0004a900: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004a910: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
-0004a920: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-0004a930: 2020 2020 2070 6572 665f 746f 7461 6c5f       perf_total_
-0004a940: 7065 725f 6f70 5f75 735b 6e6f 6465 2d3e  per_op_us[node->
-0004a950: 6f70 5d20 2b3d 206e 6f64 652d 3e70 6572  op] += node->per
-0004a960: 665f 7469 6d65 5f75 733b 0a0a 2020 2020  f_time_us;..    
-0004a970: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
-0004a980: 202d 2025 3364 3a20 5b20 2536 642c 2025   - %3d: [ %6d, %
-0004a990: 3664 2c20 2536 645d 2025 3136 7320 2573  6d, %6d] %16s %s
-0004a9a0: 2028 2533 6429 2063 7075 203d 2025 372e   (%3d) cpu = %7.
-0004a9b0: 3366 202f 2025 372e 3366 206d 732c 2077  3f / %7.3f ms, w
-0004a9c0: 616c 6c20 3d20 2537 2e33 6620 2f20 2537  all = %7.3f / %7
-0004a9d0: 2e33 6620 6d73 5c6e 222c 0a20 2020 2020  .3f ms\n",.     
-0004a9e0: 2020 2020 2020 2020 2020 2069 2c0a 2020             i,.  
-0004a9f0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0004aa00: 6465 2d3e 6e65 5b30 5d2c 206e 6f64 652d  de->ne[0], node-
-0004aa10: 3e6e 655b 315d 2c20 6e6f 6465 2d3e 6e65  >ne[1], node->ne
-0004aa20: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
-0004aa30: 2020 2020 2047 474d 4c5f 4f50 5f4c 4142       GGML_OP_LAB
-0004aa40: 454c 5b6e 6f64 652d 3e6f 705d 2c20 6e6f  EL[node->op], no
-0004aa50: 6465 2d3e 6973 5f70 6172 616d 203f 2022  de->is_param ? "
-0004aa60: 7822 203a 206e 6f64 652d 3e67 7261 6420  x" : node->grad 
-0004aa70: 3f20 2267 2220 3a20 2220 222c 206e 6f64  ? "g" : " ", nod
-0004aa80: 652d 3e70 6572 665f 7275 6e73 2c0a 2020  e->perf_runs,.  
-0004aa90: 2020 2020 2020 2020 2020 2020 2020 2864                (d
-0004aaa0: 6f75 626c 6529 206e 6f64 652d 3e70 6572  ouble) node->per
-0004aab0: 665f 6379 636c 6573 2020 2f20 2864 6f75  f_cycles  / (dou
-0004aac0: 626c 6529 2067 676d 6c5f 6379 636c 6573  ble) ggml_cycles
-0004aad0: 5f70 6572 5f6d 7328 292c 0a20 2020 2020  _per_ms(),.     
-0004aae0: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
-0004aaf0: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f63  le) node->perf_c
-0004ab00: 7963 6c65 7320 202f 2028 646f 7562 6c65  ycles  / (double
-0004ab10: 2920 6767 6d6c 5f63 7963 6c65 735f 7065  ) ggml_cycles_pe
-0004ab20: 725f 6d73 2829 202f 2028 646f 7562 6c65  r_ms() / (double
-0004ab30: 2920 6e6f 6465 2d3e 7065 7266 5f72 756e  ) node->perf_run
-0004ab40: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0004ab50: 2020 2028 646f 7562 6c65 2920 6e6f 6465     (double) node
-0004ab60: 2d3e 7065 7266 5f74 696d 655f 7573 202f  ->perf_time_us /
-0004ab70: 2031 3030 302e 302c 0a20 2020 2020 2020   1000.0,.       
-0004ab80: 2020 2020 2020 2020 2028 646f 7562 6c65           (double
-0004ab90: 2920 6e6f 6465 2d3e 7065 7266 5f74 696d  ) node->perf_tim
-0004aba0: 655f 7573 202f 2031 3030 302e 3020 2f20  e_us / 1000.0 / 
-0004abb0: 6e6f 6465 2d3e 7065 7266 5f72 756e 7329  node->perf_runs)
-0004abc0: 3b0a 2020 2020 7d0a 0a20 2020 2047 474d  ;.    }..    GGM
-0004abd0: 4c5f 5052 494e 5428 226e 5f6c 6561 6673  L_PRINT("n_leafs
-0004abe0: 203d 2025 645c 6e22 2c20 6367 7261 7068   = %d\n", cgraph
-0004abf0: 2d3e 6e5f 6c65 6166 7329 3b0a 2020 2020  ->n_leafs);.    
-0004ac00: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0004ac10: 6920 3c20 6367 7261 7068 2d3e 6e5f 6c65  i < cgraph->n_le
-0004ac20: 6166 733b 2069 2b2b 2920 7b0a 2020 2020  afs; i++) {.    
-0004ac30: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0004ac40: 7465 6e73 6f72 202a 206e 6f64 6520 3d20  tensor * node = 
-0004ac50: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
-0004ac60: 3b0a 0a20 2020 2020 2020 2047 474d 4c5f  ;..        GGML_
-0004ac70: 5052 494e 5428 2220 2d20 2533 643a 205b  PRINT(" - %3d: [
-0004ac80: 2025 3664 2c20 2536 645d 2025 3873 5c6e   %6d, %6d] %8s\n
-0004ac90: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0004aca0: 2020 2069 2c0a 2020 2020 2020 2020 2020     i,.          
-0004acb0: 2020 2020 2020 6e6f 6465 2d3e 6e65 5b30        node->ne[0
-0004acc0: 5d2c 206e 6f64 652d 3e6e 655b 315d 2c0a  ], node->ne[1],.
-0004acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ace0: 4747 4d4c 5f4f 505f 4c41 4245 4c5b 6e6f  GGML_OP_LABEL[no
-0004acf0: 6465 2d3e 6f70 5d29 3b0a 2020 2020 7d0a  de->op]);.    }.
-0004ad00: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0004ad10: 3d20 303b 2069 203c 2047 474d 4c5f 4f50  = 0; i < GGML_OP
-0004ad20: 5f43 4f55 4e54 3b20 692b 2b29 207b 0a20  _COUNT; i++) {. 
-0004ad30: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-0004ad40: 5428 2270 6572 665f 746f 7461 6c5f 7065  T("perf_total_pe
-0004ad50: 725f 6f70 5f75 735b 2531 3673 5d20 3d20  r_op_us[%16s] = 
-0004ad60: 2537 2e33 6620 6d73 5c6e 222c 2047 474d  %7.3f ms\n", GGM
-0004ad70: 4c5f 4f50 5f4c 4142 454c 5b69 5d2c 2028  L_OP_LABEL[i], (
-0004ad80: 646f 7562 6c65 2920 7065 7266 5f74 6f74  double) perf_tot
-0004ad90: 616c 5f70 6572 5f6f 705f 7573 5b69 5d20  al_per_op_us[i] 
-0004ada0: 2f20 3130 3030 2e30 293b 0a20 2020 207d  / 1000.0);.    }
-0004adb0: 0a0a 2020 2020 4747 4d4c 5f50 5249 4e54  ..    GGML_PRINT
-0004adc0: 2822 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ("==============
-0004add0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0004ade0: 3d3d 3d3d 3d3d 3d3d 3d3d 5c6e 2229 3b0a  ==========\n");.
-0004adf0: 7d0a 0a2f 2f20 6368 6563 6b20 6966 206e  }..// check if n
-0004ae00: 6f64 6520 6973 2070 6172 7420 6f66 2074  ode is part of t
-0004ae10: 6865 2067 7261 7068 0a73 7461 7469 6320  he graph.static 
-0004ae20: 626f 6f6c 2067 676d 6c5f 6772 6170 685f  bool ggml_graph_
-0004ae30: 6669 6e64 2863 6f6e 7374 2073 7472 7563  find(const struc
-0004ae40: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-0004ae50: 6367 7261 7068 2c20 636f 6e73 7420 7374  cgraph, const st
-0004ae60: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004ae70: 202a 206e 6f64 6529 207b 0a20 2020 2069   * node) {.    i
-0004ae80: 6620 2863 6772 6170 6820 3d3d 204e 554c  f (cgraph == NUL
-0004ae90: 4c29 207b 0a20 2020 2020 2020 2072 6574  L) {.        ret
-0004aea0: 7572 6e20 7472 7565 3b0a 2020 2020 7d0a  urn true;.    }.
-0004aeb0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0004aec0: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
-0004aed0: 3e6e 5f6e 6f64 6573 3b20 692b 2b29 207b  >n_nodes; i++) {
-0004aee0: 0a20 2020 2020 2020 2069 6620 2863 6772  .        if (cgr
-0004aef0: 6170 682d 3e6e 6f64 6573 5b69 5d20 3d3d  aph->nodes[i] ==
-0004af00: 206e 6f64 6529 207b 0a20 2020 2020 2020   node) {.       
-0004af10: 2020 2020 2072 6574 7572 6e20 7472 7565       return true
-0004af20: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-0004af30: 7d0a 0a20 2020 2072 6574 7572 6e20 6661  }..    return fa
-0004af40: 6c73 653b 0a7d 0a0a 7374 6174 6963 2073  lse;.}..static s
-0004af50: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0004af60: 7220 2a20 6767 6d6c 5f67 7261 7068 5f67  r * ggml_graph_g
-0004af70: 6574 5f70 6172 656e 7428 636f 6e73 7420  et_parent(const 
-0004af80: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-0004af90: 7068 202a 2063 6772 6170 682c 2063 6f6e  ph * cgraph, con
-0004afa0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0004afb0: 656e 736f 7220 2a20 6e6f 6465 2920 7b0a  ensor * node) {.
-0004afc0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-0004afd0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
-0004afe0: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
-0004aff0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0004b000: 676d 6c5f 7465 6e73 6f72 202a 2070 6172  gml_tensor * par
-0004b010: 656e 7420 3d20 6367 7261 7068 2d3e 6e6f  ent = cgraph->no
-0004b020: 6465 735b 695d 3b0a 0a20 2020 2020 2020  des[i];..       
-0004b030: 2069 6620 2870 6172 656e 742d 3e67 7261   if (parent->gra
-0004b040: 6420 3d3d 206e 6f64 6529 207b 0a20 2020  d == node) {.   
-0004b050: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0004b060: 7061 7265 6e74 3b0a 2020 2020 2020 2020  parent;.        
-0004b070: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
-0004b080: 7572 6e20 4e55 4c4c 3b0a 7d0a 0a76 6f69  urn NULL;.}..voi
-0004b090: 6420 6767 6d6c 5f67 7261 7068 5f64 756d  d ggml_graph_dum
-0004b0a0: 705f 646f 7428 636f 6e73 7420 7374 7275  p_dot(const stru
-0004b0b0: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
-0004b0c0: 2067 622c 2063 6f6e 7374 2073 7472 7563   gb, const struc
-0004b0d0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-0004b0e0: 6766 2c20 636f 6e73 7420 6368 6172 202a  gf, const char *
-0004b0f0: 2066 696c 656e 616d 6529 207b 0a20 2020   filename) {.   
-0004b100: 2063 6861 7220 636f 6c6f 725b 3136 5d3b   char color[16];
-0004b110: 0a0a 2020 2020 4649 4c45 202a 2066 7020  ..    FILE * fp 
-0004b120: 3d20 666f 7065 6e28 6669 6c65 6e61 6d65  = fopen(filename
-0004b130: 2c20 2277 2229 3b0a 2020 2020 4747 4d4c  , "w");.    GGML
-0004b140: 5f41 5353 4552 5428 6670 293b 0a0a 2020  _ASSERT(fp);..  
-0004b150: 2020 6670 7269 6e74 6628 6670 2c20 2264    fprintf(fp, "d
-0004b160: 6967 7261 7068 2047 207b 5c6e 2229 3b0a  igraph G {\n");.
-0004b170: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-0004b180: 2220 206e 6577 7261 6e6b 203d 2074 7275  "  newrank = tru
-0004b190: 653b 5c6e 2229 3b0a 2020 2020 6670 7269  e;\n");.    fpri
-0004b1a0: 6e74 6628 6670 2c20 2220 2072 616e 6b64  ntf(fp, "  rankd
-0004b1b0: 6972 203d 204c 523b 5c6e 2229 3b0a 0a20  ir = LR;\n");.. 
-0004b1c0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0004b1d0: 303b 2069 203c 2067 622d 3e6e 5f6e 6f64  0; i < gb->n_nod
-0004b1e0: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
-0004b1f0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0004b200: 656e 736f 7220 2a20 6e6f 6465 203d 2067  ensor * node = g
-0004b210: 622d 3e6e 6f64 6573 5b69 5d3b 0a0a 2020  b->nodes[i];..  
-0004b220: 2020 2020 2020 6966 2028 6767 6d6c 5f67        if (ggml_g
-0004b230: 7261 7068 5f67 6574 5f70 6172 656e 7428  raph_get_parent(
-0004b240: 6762 2c20 6e6f 6465 2920 213d 204e 554c  gb, node) != NUL
-0004b250: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
-0004b260: 2063 6f6e 7469 6e75 653b 0a20 2020 2020   continue;.     
-0004b270: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-0004b280: 2028 6e6f 6465 2d3e 6973 5f70 6172 616d   (node->is_param
-0004b290: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004b2a0: 736e 7072 696e 7466 2863 6f6c 6f72 2c20  snprintf(color, 
-0004b2b0: 7369 7a65 6f66 2863 6f6c 6f72 292c 2022  sizeof(color), "
-0004b2c0: 7965 6c6c 6f77 2229 3b0a 2020 2020 2020  yellow");.      
-0004b2d0: 2020 7d20 656c 7365 2069 6620 286e 6f64    } else if (nod
-0004b2e0: 652d 3e67 7261 6429 207b 0a20 2020 2020  e->grad) {.     
-0004b2f0: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
-0004b300: 6772 6170 685f 6669 6e64 2867 662c 206e  graph_find(gf, n
-0004b310: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
-0004b320: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
-0004b330: 2863 6f6c 6f72 2c20 7369 7a65 6f66 2863  (color, sizeof(c
-0004b340: 6f6c 6f72 292c 2022 6772 6565 6e22 293b  olor), "green");
-0004b350: 0a20 2020 2020 2020 2020 2020 207d 2065  .            } e
-0004b360: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-0004b370: 2020 2020 2020 736e 7072 696e 7466 2863        snprintf(c
-0004b380: 6f6c 6f72 2c20 7369 7a65 6f66 2863 6f6c  olor, sizeof(col
-0004b390: 6f72 292c 2022 6c69 6768 7462 6c75 6522  or), "lightblue"
-0004b3a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0004b3b0: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
-0004b3c0: 7b0a 2020 2020 2020 2020 2020 2020 736e  {.            sn
-0004b3d0: 7072 696e 7466 2863 6f6c 6f72 2c20 7369  printf(color, si
-0004b3e0: 7a65 6f66 2863 6f6c 6f72 292c 2022 7768  zeof(color), "wh
-0004b3f0: 6974 6522 293b 0a20 2020 2020 2020 207d  ite");.        }
-0004b400: 0a0a 2020 2020 2020 2020 6670 7269 6e74  ..        fprint
-0004b410: 6628 6670 2c20 2220 205c 2225 705c 2220  f(fp, "  \"%p\" 
-0004b420: 5b20 5c0a 7374 796c 6520 3d20 6669 6c6c  [ \.style = fill
-0004b430: 6564 3b20 6669 6c6c 636f 6c6f 7220 3d20  ed; fillcolor = 
-0004b440: 2573 3b20 7368 6170 6520 3d20 7265 636f  %s; shape = reco
-0004b450: 7264 3b20 5c0a 6c61 6265 6c3d 5c22 2564  rd; \.label=\"%d
-0004b460: 205b 2564 2c20 2564 5d20 7c20 3c78 3e25   [%d, %d] | <x>%
-0004b470: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0004b480: 2020 2020 2876 6f69 6420 2a29 206e 6f64      (void *) nod
-0004b490: 652c 2063 6f6c 6f72 2c0a 2020 2020 2020  e, color,.      
-0004b4a0: 2020 2020 2020 2020 2020 692c 206e 6f64            i, nod
-0004b4b0: 652d 3e6e 655b 305d 2c20 6e6f 6465 2d3e  e->ne[0], node->
-0004b4c0: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
-0004b4d0: 2020 2020 2020 2047 474d 4c5f 4f50 5f53         GGML_OP_S
-0004b4e0: 594d 424f 4c5b 6e6f 6465 2d3e 6f70 5d29  YMBOL[node->op])
-0004b4f0: 3b0a 0a20 2020 2020 2020 2069 6620 286e  ;..        if (n
-0004b500: 6f64 652d 3e67 7261 6429 207b 0a20 2020  ode->grad) {.   
-0004b510: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
-0004b520: 2866 702c 2022 207c 203c 673e 2573 5c22  (fp, " | <g>%s\"
-0004b530: 3b20 5d5c 6e22 2c20 4747 4d4c 5f4f 505f  ; ]\n", GGML_OP_
-0004b540: 5359 4d42 4f4c 5b6e 6f64 652d 3e67 7261  SYMBOL[node->gra
-0004b550: 642d 3e6f 705d 293b 0a20 2020 2020 2020  d->op]);.       
-0004b560: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-0004b570: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
-0004b580: 2c20 225c 223b 205d 5c6e 2229 3b0a 2020  , "\"; ]\n");.  
-0004b590: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-0004b5a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0004b5b0: 303b 2069 203c 2067 622d 3e6e 5f6c 6561  0; i < gb->n_lea
-0004b5c0: 6673 3b20 692b 2b29 207b 0a20 2020 2020  fs; i++) {.     
-0004b5d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0004b5e0: 656e 736f 7220 2a20 6e6f 6465 203d 2067  ensor * node = g
-0004b5f0: 622d 3e6c 6561 6673 5b69 5d3b 0a0a 2020  b->leafs[i];..  
-0004b600: 2020 2020 2020 736e 7072 696e 7466 2863        snprintf(c
-0004b610: 6f6c 6f72 2c20 7369 7a65 6f66 2863 6f6c  olor, sizeof(col
-0004b620: 6f72 292c 2022 7069 6e6b 2229 3b0a 0a20  or), "pink");.. 
-0004b630: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
-0004b640: 6e65 6c65 6d65 6e74 7328 6e6f 6465 2920  nelements(node) 
-0004b650: 3d3d 2031 2920 7b0a 2020 2020 2020 2020  == 1) {.        
-0004b660: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-0004b670: 2220 205c 2225 705c 2220 5b20 5c0a 7374  "  \"%p\" [ \.st
-0004b680: 796c 6520 3d20 6669 6c6c 6564 3b20 6669  yle = filled; fi
-0004b690: 6c6c 636f 6c6f 7220 3d20 2573 3b20 7368  llcolor = %s; sh
-0004b6a0: 6170 6520 3d20 7265 636f 7264 3b20 5c0a  ape = record; \.
-0004b6b0: 6c61 6265 6c3d 5c22 3c78 3e25 2e31 655c  label=\"<x>%.1e\
-0004b6c0: 223b 205d 5c6e 222c 0a20 2020 2020 2020  "; ]\n",.       
-0004b6d0: 2020 2020 2020 2020 2020 2020 2028 766f               (vo
-0004b6e0: 6964 202a 2920 6e6f 6465 2c20 636f 6c6f  id *) node, colo
-0004b6f0: 722c 2067 676d 6c5f 6765 745f 6633 325f  r, ggml_get_f32_
-0004b700: 3164 286e 6f64 652c 2030 2929 3b0a 2020  1d(node, 0));.  
-0004b710: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0004b720: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-0004b730: 7466 2866 702c 2022 2020 5c22 2570 5c22  tf(fp, "  \"%p\"
-0004b740: 205b 205c 0a73 7479 6c65 203d 2066 696c   [ \.style = fil
-0004b750: 6c65 643b 2066 696c 6c63 6f6c 6f72 203d  led; fillcolor =
-0004b760: 2025 733b 2073 6861 7065 203d 2072 6563   %s; shape = rec
-0004b770: 6f72 643b 205c 0a6c 6162 656c 3d5c 223c  ord; \.label=\"<
-0004b780: 783e 434f 4e53 5420 2564 205b 2564 2c20  x>CONST %d [%d, 
-0004b790: 2564 5d5c 223b 205d 5c6e 222c 0a20 2020  %d]\"; ]\n",.   
-0004b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b7b0: 2028 766f 6964 202a 2920 6e6f 6465 2c20   (void *) node, 
-0004b7c0: 636f 6c6f 722c 0a20 2020 2020 2020 2020  color,.         
-0004b7d0: 2020 2020 2020 2020 2020 2069 2c20 6e6f             i, no
-0004b7e0: 6465 2d3e 6e65 5b30 5d2c 206e 6f64 652d  de->ne[0], node-
-0004b7f0: 3e6e 655b 315d 293b 0a20 2020 2020 2020  >ne[1]);.       
-0004b800: 207d 0a20 2020 207d 0a0a 2020 2020 666f   }.    }..    fo
-0004b810: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0004b820: 3c20 6762 2d3e 6e5f 6e6f 6465 733b 2069  < gb->n_nodes; i
-0004b830: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
-0004b840: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004b850: 202a 206e 6f64 6520 3d20 6762 2d3e 6e6f   * node = gb->no
-0004b860: 6465 735b 695d 3b0a 0a20 2020 2020 2020  des[i];..       
-0004b870: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0004b880: 736f 7220 2a20 7061 7265 6e74 203d 2067  sor * parent = g
-0004b890: 676d 6c5f 6772 6170 685f 6765 745f 7061  gml_graph_get_pa
-0004b8a0: 7265 6e74 2867 622c 206e 6f64 6529 3b0a  rent(gb, node);.
-0004b8b0: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
-0004b8c0: 652d 3e73 7263 3029 207b 0a20 2020 2020  e->src0) {.     
-0004b8d0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0004b8e0: 6d6c 5f74 656e 736f 7220 2a20 7061 7265  ml_tensor * pare
-0004b8f0: 6e74 3020 3d20 6767 6d6c 5f67 7261 7068  nt0 = ggml_graph
-0004b900: 5f67 6574 5f70 6172 656e 7428 6762 2c20  _get_parent(gb, 
-0004b910: 6e6f 6465 2d3e 7372 6330 293b 0a0a 2020  node->src0);..  
-0004b920: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
-0004b930: 6628 6670 2c20 2220 205c 2225 705c 223a  f(fp, "  \"%p\":
-0004b940: 2573 202d 3e20 5c22 2570 5c22 3a25 7320  %s -> \"%p\":%s 
-0004b950: 5b20 6172 726f 7768 6561 6420 3d20 2573  [ arrowhead = %s
-0004b960: 3b20 7374 796c 6520 3d20 2573 3b20 6c61  ; style = %s; la
-0004b970: 6265 6c20 3d20 5c22 785c 223b 205d 5c6e  bel = \"x\"; ]\n
-0004b980: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0004b990: 2020 2020 2020 2070 6172 656e 7430 203f         parent0 ?
-0004b9a0: 2028 766f 6964 202a 2920 7061 7265 6e74   (void *) parent
-0004b9b0: 3020 3a20 2876 6f69 6420 2a29 206e 6f64  0 : (void *) nod
-0004b9c0: 652d 3e73 7263 302c 0a20 2020 2020 2020  e->src0,.       
-0004b9d0: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0004b9e0: 656e 7430 203f 2022 6722 203a 2022 7822  ent0 ? "g" : "x"
-0004b9f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004ba00: 2020 2020 2020 7061 7265 6e74 203f 2028        parent ? (
-0004ba10: 766f 6964 202a 2920 7061 7265 6e74 203a  void *) parent :
-0004ba20: 2028 766f 6964 202a 2920 6e6f 6465 2c0a   (void *) node,.
-0004ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ba40: 2020 2020 7061 7265 6e74 203f 2022 6722      parent ? "g"
-0004ba50: 203a 2022 7822 2c0a 2020 2020 2020 2020   : "x",.        
-0004ba60: 2020 2020 2020 2020 2020 2020 7061 7265              pare
-0004ba70: 6e74 203f 2022 656d 7074 7922 203a 2022  nt ? "empty" : "
-0004ba80: 7665 6522 2c0a 2020 2020 2020 2020 2020  vee",.          
-0004ba90: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-0004baa0: 203f 2022 6461 7368 6564 2220 3a20 2273   ? "dashed" : "s
-0004bab0: 6f6c 6964 2229 3b0a 2020 2020 2020 2020  olid");.        
-0004bac0: 7d0a 0a20 2020 2020 2020 2069 6620 286e  }..        if (n
-0004bad0: 6f64 652d 3e73 7263 3129 207b 0a20 2020  ode->src1) {.   
-0004bae0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
-0004baf0: 6767 6d6c 5f74 656e 736f 7220 2a20 7061  ggml_tensor * pa
-0004bb00: 7265 6e74 3120 3d20 6767 6d6c 5f67 7261  rent1 = ggml_gra
-0004bb10: 7068 5f67 6574 5f70 6172 656e 7428 6762  ph_get_parent(gb
-0004bb20: 2c20 6e6f 6465 2d3e 7372 6331 293b 0a0a  , node->src1);..
-0004bb30: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-0004bb40: 6e74 6628 6670 2c20 2220 205c 2225 705c  ntf(fp, "  \"%p\
-0004bb50: 223a 2573 202d 3e20 5c22 2570 5c22 3a25  ":%s -> \"%p\":%
-0004bb60: 7320 5b20 6172 726f 7768 6561 6420 3d20  s [ arrowhead = 
-0004bb70: 2573 3b20 7374 796c 6520 3d20 2573 3b20  %s; style = %s; 
-0004bb80: 6c61 6265 6c20 3d20 5c22 795c 223b 205d  label = \"y\"; ]
-0004bb90: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-0004bba0: 2020 2020 2020 2020 2070 6172 656e 7431           parent1
-0004bbb0: 203f 2028 766f 6964 202a 2920 7061 7265   ? (void *) pare
-0004bbc0: 6e74 3120 3a20 2876 6f69 6420 2a29 206e  nt1 : (void *) n
-0004bbd0: 6f64 652d 3e73 7263 312c 0a20 2020 2020  ode->src1,.     
-0004bbe0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0004bbf0: 6172 656e 7431 203f 2022 6722 203a 2022  arent1 ? "g" : "
-0004bc00: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
-0004bc10: 2020 2020 2020 2020 7061 7265 6e74 203f          parent ?
-0004bc20: 2028 766f 6964 202a 2920 7061 7265 6e74   (void *) parent
-0004bc30: 203a 2028 766f 6964 202a 2920 6e6f 6465   : (void *) node
-0004bc40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004bc50: 2020 2020 2020 7061 7265 6e74 203f 2022        parent ? "
-0004bc60: 6722 203a 2022 7822 2c0a 2020 2020 2020  g" : "x",.      
-0004bc70: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0004bc80: 7265 6e74 203f 2022 656d 7074 7922 203a  rent ? "empty" :
-0004bc90: 2022 7665 6522 2c0a 2020 2020 2020 2020   "vee",.        
-0004bca0: 2020 2020 2020 2020 2020 2020 7061 7265              pare
-0004bcb0: 6e74 203f 2022 6461 7368 6564 2220 3a20  nt ? "dashed" : 
-0004bcc0: 2273 6f6c 6964 2229 3b0a 2020 2020 2020  "solid");.      
-0004bcd0: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
-0004bce0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0004bcf0: 203c 2067 622d 3e6e 5f6c 6561 6673 3b20   < gb->n_leafs; 
-0004bd00: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
-0004bd10: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0004bd20: 7220 2a20 6e6f 6465 203d 2067 622d 3e6c  r * node = gb->l
-0004bd30: 6561 6673 5b69 5d3b 0a0a 2020 2020 2020  eafs[i];..      
-0004bd40: 2020 6966 2028 6e6f 6465 2d3e 7372 6330    if (node->src0
-0004bd50: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004bd60: 6670 7269 6e74 6628 6670 2c20 2220 205c  fprintf(fp, "  \
-0004bd70: 2225 705c 223a 2573 202d 3e20 5c22 2570  "%p\":%s -> \"%p
-0004bd80: 5c22 3a25 7320 5b20 6c61 6265 6c20 3d20  \":%s [ label = 
-0004bd90: 5c22 785c 223b 205d 5c6e 222c 0a20 2020  \"x\"; ]\n",.   
-0004bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bdb0: 2028 766f 6964 202a 2920 6e6f 6465 2d3e   (void *) node->
-0004bdc0: 7372 6330 2c20 2278 222c 0a20 2020 2020  src0, "x",.     
-0004bdd0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0004bde0: 766f 6964 202a 2920 6e6f 6465 2c20 2278  void *) node, "x
-0004bdf0: 2229 3b0a 2020 2020 2020 2020 7d0a 0a20  ");.        }.. 
-0004be00: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
-0004be10: 3e73 7263 3129 207b 0a20 2020 2020 2020  >src1) {.       
-0004be20: 2020 2020 2066 7072 696e 7466 2866 702c       fprintf(fp,
-0004be30: 2022 2020 5c22 2570 5c22 3a25 7320 2d3e   "  \"%p\":%s ->
-0004be40: 205c 2225 705c 223a 2573 205b 206c 6162   \"%p\":%s [ lab
-0004be50: 656c 203d 205c 2279 5c22 3b20 5d5c 6e22  el = \"y\"; ]\n"
-0004be60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004be70: 2020 2020 2020 2876 6f69 6420 2a29 206e        (void *) n
-0004be80: 6f64 652d 3e73 7263 312c 2022 7822 2c0a  ode->src1, "x",.
-0004be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bea0: 2020 2020 2876 6f69 6420 2a29 206e 6f64      (void *) nod
-0004beb0: 652c 2022 7822 293b 0a20 2020 2020 2020  e, "x");.       
-0004bec0: 207d 0a20 2020 207d 0a0a 2020 2020 6670   }.    }..    fp
-0004bed0: 7269 6e74 6628 6670 2c20 227d 5c6e 2229  rintf(fp, "}\n")
-0004bee0: 3b0a 0a20 2020 2066 636c 6f73 6528 6670  ;..    fclose(fp
-0004bef0: 293b 0a0a 2020 2020 4747 4d4c 5f50 5249  );..    GGML_PRI
-0004bf00: 4e54 2822 2573 3a20 646f 7420 2d54 706e  NT("%s: dot -Tpn
-0004bf10: 6720 2573 202d 6f20 2573 2e70 6e67 2026  g %s -o %s.png &
-0004bf20: 2620 6f70 656e 2025 732e 706e 675c 6e22  & open %s.png\n"
-0004bf30: 2c20 5f5f 6675 6e63 5f5f 2c20 6669 6c65  , __func__, file
-0004bf40: 6e61 6d65 2c20 6669 6c65 6e61 6d65 2c20  name, filename, 
-0004bf50: 6669 6c65 6e61 6d65 293b 0a7d 0a0a 2f2f  filename);.}..//
-0004bf60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0004bf70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0004bf80: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0004bf90: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0004bfa0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a  //////////////..
-0004bfb0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0004bfc0: 5f6f 7074 5f73 6574 5f70 6172 616d 7328  _opt_set_params(
-0004bfd0: 696e 7420 6e70 2c20 7374 7275 6374 2067  int np, struct g
-0004bfe0: 676d 6c5f 7465 6e73 6f72 202a 2063 6f6e  gml_tensor * con
-0004bff0: 7374 2070 735b 5d2c 2063 6f6e 7374 2066  st ps[], const f
-0004c000: 6c6f 6174 202a 2078 2920 7b0a 2020 2020  loat * x) {.    
-0004c010: 696e 7420 6920 3d20 303b 0a20 2020 2066  int i = 0;.    f
-0004c020: 6f72 2028 696e 7420 7020 3d20 303b 2070  or (int p = 0; p
-0004c030: 203c 206e 703b 202b 2b70 2920 7b0a 2020   < np; ++p) {.  
-0004c040: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0004c050: 6e65 203d 2067 676d 6c5f 6e65 6c65 6d65  ne = ggml_neleme
-0004c060: 6e74 7328 7073 5b70 5d29 203b 0a20 2020  nts(ps[p]) ;.   
-0004c070: 2020 2020 202f 2f20 544f 444f 3a20 6164       // TODO: ad
-0004c080: 6420 6675 6e63 7469 6f6e 2074 6f20 7365  d function to se
-0004c090: 7420 7465 6e73 6f72 2066 726f 6d20 6172  t tensor from ar
-0004c0a0: 7261 790a 2020 2020 2020 2020 666f 7220  ray.        for 
-0004c0b0: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
-0004c0c0: 6e65 3b20 2b2b 6a29 207b 0a20 2020 2020  ne; ++j) {.     
-0004c0d0: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
-0004c0e0: 6633 325f 3164 2870 735b 705d 2c20 6a2c  f32_1d(ps[p], j,
-0004c0f0: 2078 5b69 2b2b 5d29 3b0a 2020 2020 2020   x[i++]);.      
-0004c100: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-0004c110: 7469 6320 766f 6964 2067 676d 6c5f 6f70  tic void ggml_op
-0004c120: 745f 6765 745f 7061 7261 6d73 2869 6e74  t_get_params(int
-0004c130: 206e 702c 2073 7472 7563 7420 6767 6d6c   np, struct ggml
-0004c140: 5f74 656e 736f 7220 2a20 636f 6e73 7420  _tensor * const 
-0004c150: 7073 5b5d 2c20 666c 6f61 7420 2a20 7829  ps[], float * x)
-0004c160: 207b 0a20 2020 2069 6e74 2069 203d 2030   {.    int i = 0
-0004c170: 3b0a 2020 2020 666f 7220 2869 6e74 2070  ;.    for (int p
-0004c180: 203d 2030 3b20 7020 3c20 6e70 3b20 2b2b   = 0; p < np; ++
-0004c190: 7029 207b 0a20 2020 2020 2020 2063 6f6e  p) {.        con
-0004c1a0: 7374 2069 6e74 206e 6520 3d20 6767 6d6c  st int ne = ggml
-0004c1b0: 5f6e 656c 656d 656e 7473 2870 735b 705d  _nelements(ps[p]
-0004c1c0: 2920 3b0a 2020 2020 2020 2020 2f2f 2054  ) ;.        // T
-0004c1d0: 4f44 4f3a 2061 6464 2066 756e 6374 696f  ODO: add functio
-0004c1e0: 6e20 746f 2067 6574 2061 6c6c 2065 6c65  n to get all ele
-0004c1f0: 6d65 6e74 7320 6174 206f 6e63 650a 2020  ments at once.  
-0004c200: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-0004c210: 203d 2030 3b20 6a20 3c20 6e65 3b20 2b2b   = 0; j < ne; ++
-0004c220: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-0004c230: 2078 5b69 2b2b 5d20 3d20 6767 6d6c 5f67   x[i++] = ggml_g
-0004c240: 6574 5f66 3332 5f31 6428 7073 5b70 5d2c  et_f32_1d(ps[p],
-0004c250: 206a 293b 0a20 2020 2020 2020 207d 0a20   j);.        }. 
-0004c260: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-0004c270: 6f69 6420 6767 6d6c 5f6f 7074 5f67 6574  oid ggml_opt_get
-0004c280: 5f67 7261 6428 696e 7420 6e70 2c20 7374  _grad(int np, st
-0004c290: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004c2a0: 202a 2063 6f6e 7374 2070 735b 5d2c 2066   * const ps[], f
-0004c2b0: 6c6f 6174 202a 2067 2920 7b0a 2020 2020  loat * g) {.    
-0004c2c0: 696e 7420 6920 3d20 303b 0a20 2020 2066  int i = 0;.    f
-0004c2d0: 6f72 2028 696e 7420 7020 3d20 303b 2070  or (int p = 0; p
-0004c2e0: 203c 206e 703b 202b 2b70 2920 7b0a 2020   < np; ++p) {.  
-0004c2f0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0004c300: 6e65 203d 2067 676d 6c5f 6e65 6c65 6d65  ne = ggml_neleme
-0004c310: 6e74 7328 7073 5b70 5d29 203b 0a20 2020  nts(ps[p]) ;.   
-0004c320: 2020 2020 202f 2f20 544f 444f 3a20 6164       // TODO: ad
-0004c330: 6420 6675 6e63 7469 6f6e 2074 6f20 6765  d function to ge
-0004c340: 7420 616c 6c20 656c 656d 656e 7473 2061  t all elements a
-0004c350: 7420 6f6e 6365 0a20 2020 2020 2020 2066  t once.        f
-0004c360: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-0004c370: 203c 206e 653b 202b 2b6a 2920 7b0a 2020   < ne; ++j) {.  
-0004c380: 2020 2020 2020 2020 2020 675b 692b 2b5d            g[i++]
-0004c390: 203d 2067 676d 6c5f 6765 745f 6633 325f   = ggml_get_f32_
-0004c3a0: 3164 2870 735b 705d 2d3e 6772 6164 2c20  1d(ps[p]->grad, 
-0004c3b0: 6a29 3b0a 2020 2020 2020 2020 7d0a 2020  j);.        }.  
-0004c3c0: 2020 7d0a 7d0a 0a2f 2f0a 2f2f 2041 4441    }.}..//.// ADA
-0004c3d0: 4d0a 2f2f 0a2f 2f20 2020 7265 663a 2068  M.//.//   ref: h
-0004c3e0: 7474 7073 3a2f 2f61 7278 6976 2e6f 7267  ttps://arxiv.org
-0004c3f0: 2f70 6466 2f31 3431 322e 3639 3830 2e70  /pdf/1412.6980.p
-0004c400: 6466 0a2f 2f0a 0a73 7461 7469 6320 656e  df.//..static en
-0004c410: 756d 2067 676d 6c5f 6f70 745f 7265 7375  um ggml_opt_resu
-0004c420: 6c74 2067 676d 6c5f 6f70 745f 6164 616d  lt ggml_opt_adam
-0004c430: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0004c440: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0004c450: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0004c460: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
-0004c470: 616d 7320 7061 7261 6d73 2c0a 2020 2020  ams params,.    
-0004c480: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0004c490: 7465 6e73 6f72 202a 2066 2c0a 2020 2020  tensor * f,.    
-0004c4a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0004c4b0: 6367 7261 7068 202a 2067 662c 0a20 2020  cgraph * gf,.   
-0004c4c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0004c4d0: 5f63 6772 6170 6820 2a20 6762 2920 7b0a  _cgraph * gb) {.
-0004c4e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0004c4f0: 6767 6d6c 5f69 735f 7363 616c 6172 2866  ggml_is_scalar(f
-0004c500: 2929 3b0a 0a20 2020 2067 662d 3e6e 5f74  ));..    gf->n_t
-0004c510: 6872 6561 6473 203d 2070 6172 616d 732e  hreads = params.
-0004c520: 6e5f 7468 7265 6164 733b 0a20 2020 2067  n_threads;.    g
-0004c530: 622d 3e6e 5f74 6872 6561 6473 203d 2070  b->n_threads = p
-0004c540: 6172 616d 732e 6e5f 7468 7265 6164 733b  arams.n_threads;
-0004c550: 0a0a 2020 2020 2f2f 2074 6865 7365 2077  ..    // these w
-0004c560: 696c 6c20 7374 6f72 6520 7468 6520 7061  ill store the pa
-0004c570: 7261 6d65 7465 7273 2077 6520 7761 6e74  rameters we want
-0004c580: 2074 6f20 6f70 7469 6d69 7a65 0a20 2020   to optimize.   
-0004c590: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0004c5a0: 736f 7220 2a20 7073 5b47 474d 4c5f 4d41  sor * ps[GGML_MA
-0004c5b0: 585f 5041 5241 4d53 5d3b 0a0a 2020 2020  X_PARAMS];..    
-0004c5c0: 696e 7420 6e70 203d 2030 3b0a 2020 2020  int np = 0;.    
-0004c5d0: 696e 7420 6e78 203d 2030 3b0a 2020 2020  int nx = 0;.    
-0004c5e0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0004c5f0: 6920 3c20 6766 2d3e 6e5f 6e6f 6465 733b  i < gf->n_nodes;
-0004c600: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0004c610: 6966 2028 6766 2d3e 6e6f 6465 735b 695d  if (gf->nodes[i]
-0004c620: 2d3e 6973 5f70 6172 616d 2920 7b0a 2020  ->is_param) {.  
-0004c630: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
-0004c640: 5249 4e54 5f44 4542 5547 2822 666f 756e  RINT_DEBUG("foun
-0004c650: 6420 7061 7261 6d20 2564 3a20 6772 6164  d param %d: grad
-0004c660: 2d3e 6f70 203d 2025 645c 6e22 2c20 6e70  ->op = %d\n", np
-0004c670: 2c20 6766 2d3e 6e6f 6465 735b 695d 2d3e  , gf->nodes[i]->
-0004c680: 6772 6164 2d3e 6f70 293b 0a0a 2020 2020  grad->op);..    
-0004c690: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0004c6a0: 4552 5428 6e70 203c 2047 474d 4c5f 4d41  ERT(np < GGML_MA
-0004c6b0: 585f 5041 5241 4d53 293b 0a0a 2020 2020  X_PARAMS);..    
-0004c6c0: 2020 2020 2020 2020 7073 5b6e 702b 2b5d          ps[np++]
-0004c6d0: 203d 2067 662d 3e6e 6f64 6573 5b69 5d3b   = gf->nodes[i];
-0004c6e0: 0a20 2020 2020 2020 2020 2020 206e 7820  .            nx 
-0004c6f0: 2b3d 2067 676d 6c5f 6e65 6c65 6d65 6e74  += ggml_nelement
-0004c700: 7328 6766 2d3e 6e6f 6465 735b 695d 293b  s(gf->nodes[i]);
-0004c710: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0004c720: 0a0a 2020 2020 2f2f 2063 6f6e 7374 616e  ..    // constan
-0004c730: 7473 0a20 2020 2063 6f6e 7374 2066 6c6f  ts.    const flo
-0004c740: 6174 2061 6c70 6861 203d 2070 6172 616d  at alpha = param
-0004c750: 732e 6164 616d 2e61 6c70 6861 3b0a 2020  s.adam.alpha;.  
-0004c760: 2020 636f 6e73 7420 666c 6f61 7420 6265    const float be
-0004c770: 7461 3120 3d20 7061 7261 6d73 2e61 6461  ta1 = params.ada
-0004c780: 6d2e 6265 7461 313b 0a20 2020 2063 6f6e  m.beta1;.    con
-0004c790: 7374 2066 6c6f 6174 2062 6574 6132 203d  st float beta2 =
-0004c7a0: 2070 6172 616d 732e 6164 616d 2e62 6574   params.adam.bet
-0004c7b0: 6132 3b0a 2020 2020 636f 6e73 7420 666c  a2;.    const fl
-0004c7c0: 6f61 7420 6570 7320 2020 3d20 7061 7261  oat eps   = para
-0004c7d0: 6d73 2e61 6461 6d2e 6570 733b 0a0a 2020  ms.adam.eps;..  
-0004c7e0: 2020 666c 6f61 7420 2a20 7820 203d 2067    float * x  = g
-0004c7f0: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
-0004c800: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
-0004c810: 5f46 3332 2c20 6e78 292d 3e64 6174 613b  _F32, nx)->data;
-0004c820: 202f 2f20 7669 6577 206f 6620 7468 6520   // view of the 
-0004c830: 7061 7261 6d65 7465 7273 0a20 2020 2066  parameters.    f
-0004c840: 6c6f 6174 202a 2067 3120 3d20 6767 6d6c  loat * g1 = ggml
-0004c850: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
-0004c860: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-0004c870: 322c 206e 7829 2d3e 6461 7461 3b20 2f2f  2, nx)->data; //
-0004c880: 2067 7261 6469 656e 740a 2020 2020 666c   gradient.    fl
-0004c890: 6f61 7420 2a20 6732 203d 2067 676d 6c5f  oat * g2 = ggml_
-0004c8a0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-0004c8b0: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-0004c8c0: 2c20 6e78 292d 3e64 6174 613b 202f 2f20  , nx)->data; // 
-0004c8d0: 6772 6164 6965 6e74 2073 7175 6172 6564  gradient squared
-0004c8e0: 0a20 2020 2066 6c6f 6174 202a 206d 2020  .    float * m  
-0004c8f0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0004c900: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0004c910: 5950 455f 4633 322c 206e 7829 2d3e 6461  YPE_F32, nx)->da
-0004c920: 7461 3b20 2f2f 2066 6972 7374 206d 6f6d  ta; // first mom
-0004c930: 656e 740a 2020 2020 666c 6f61 7420 2a20  ent.    float * 
-0004c940: 7620 203d 2067 676d 6c5f 6e65 775f 7465  v  = ggml_new_te
-0004c950: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-0004c960: 4c5f 5459 5045 5f46 3332 2c20 6e78 292d  L_TYPE_F32, nx)-
-0004c970: 3e64 6174 613b 202f 2f20 7365 636f 6e64  >data; // second
-0004c980: 206d 6f6d 656e 740a 2020 2020 666c 6f61   moment.    floa
-0004c990: 7420 2a20 6d68 203d 2067 676d 6c5f 6e65  t * mh = ggml_ne
-0004c9a0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-0004c9b0: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
-0004c9c0: 6e78 292d 3e64 6174 613b 202f 2f20 6669  nx)->data; // fi
-0004c9d0: 7273 7420 6d6f 6d65 6e74 2068 6174 0a20  rst moment hat. 
-0004c9e0: 2020 2066 6c6f 6174 202a 2076 6820 3d20     float * vh = 
-0004c9f0: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-0004ca00: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-0004ca10: 455f 4633 322c 206e 7829 2d3e 6461 7461  E_F32, nx)->data
-0004ca20: 3b20 2f2f 2073 6563 6f6e 6420 6d6f 6d65  ; // second mome
-0004ca30: 6e74 2068 6174 0a0a 2020 2020 666c 6f61  nt hat..    floa
-0004ca40: 7420 2a20 7066 203d 2070 6172 616d 732e  t * pf = params.
-0004ca50: 7061 7374 203e 2030 203f 2067 676d 6c5f  past > 0 ? ggml_
-0004ca60: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-0004ca70: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-0004ca80: 2c20 7061 7261 6d73 2e70 6173 7429 2d3e  , params.past)->
-0004ca90: 6461 7461 203a 204e 554c 4c3b 202f 2f20  data : NULL; // 
-0004caa0: 7061 7374 2066 756e 6374 696f 6e20 7661  past function va
-0004cab0: 6c75 6573 0a0a 2020 2020 2f2f 2069 6e69  lues..    // ini
-0004cac0: 7469 616c 697a 650a 2020 2020 6767 6d6c  tialize.    ggml
-0004cad0: 5f76 6563 5f73 6574 5f66 3332 286e 782c  _vec_set_f32(nx,
-0004cae0: 206d 2c20 302e 3066 293b 0a20 2020 2067   m, 0.0f);.    g
-0004caf0: 676d 6c5f 7665 635f 7365 745f 6633 3228  gml_vec_set_f32(
-0004cb00: 6e78 2c20 762c 2030 2e30 6629 3b0a 0a20  nx, v, 0.0f);.. 
-0004cb10: 2020 202f 2f20 7570 6461 7465 2076 6965     // update vie
-0004cb20: 770a 2020 2020 6767 6d6c 5f6f 7074 5f67  w.    ggml_opt_g
-0004cb30: 6574 5f70 6172 616d 7328 6e70 2c20 7073  et_params(np, ps
-0004cb40: 2c20 7829 3b0a 0a20 2020 202f 2f20 636f  , x);..    // co
-0004cb50: 6d70 7574 6520 7468 6520 6675 6e63 7469  mpute the functi
-0004cb60: 6f6e 2076 616c 7565 0a20 2020 2067 676d  on value.    ggm
-0004cb70: 6c5f 6772 6170 685f 7265 7365 7420 2028  l_graph_reset  (
-0004cb80: 6766 293b 0a20 2020 2067 676d 6c5f 7365  gf);.    ggml_se
-0004cb90: 745f 6633 3220 2020 2020 2028 662d 3e67  t_f32      (f->g
-0004cba0: 7261 642c 2031 2e30 6629 3b0a 2020 2020  rad, 1.0f);.    
-0004cbb0: 6767 6d6c 5f67 7261 7068 5f63 6f6d 7075  ggml_graph_compu
-0004cbc0: 7465 2863 7478 2c20 6762 293b 0a0a 2020  te(ctx, gb);..  
-0004cbd0: 2020 666c 6f61 7420 6678 5f70 7265 7620    float fx_prev 
-0004cbe0: 3d20 6767 6d6c 5f67 6574 5f66 3332 5f31  = ggml_get_f32_1
-0004cbf0: 6428 662c 2030 293b 0a20 2020 2069 6620  d(f, 0);.    if 
-0004cc00: 2870 6629 207b 0a20 2020 2020 2020 2070  (pf) {.        p
-0004cc10: 665b 305d 203d 2066 785f 7072 6576 3b0a  f[0] = fx_prev;.
-0004cc20: 2020 2020 7d0a 0a20 2020 2069 6e74 206e      }..    int n
-0004cc30: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
-0004cc40: 3d20 303b 0a20 2020 2066 6c6f 6174 2066  = 0;.    float f
-0004cc50: 785f 6265 7374 203d 2066 785f 7072 6576  x_best = fx_prev
-0004cc60: 3b0a 0a20 2020 202f 2f20 7275 6e20 7468  ;..    // run th
-0004cc70: 6520 6f70 7469 6d69 7a65 720a 2020 2020  e optimizer.    
-0004cc80: 666f 7220 2869 6e74 2074 203d 2030 3b20  for (int t = 0; 
-0004cc90: 7420 3c20 7061 7261 6d73 2e61 6461 6d2e  t < params.adam.
-0004cca0: 6e5f 6974 6572 3b20 2b2b 7429 207b 0a20  n_iter; ++t) {. 
-0004ccb0: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-0004ccc0: 545f 4445 4255 4720 2028 223d 3d3d 2069  T_DEBUG  ("=== i
-0004ccd0: 7465 7220 2564 203d 3d3d 5c6e 222c 2074  ter %d ===\n", t
-0004cce0: 293b 0a0a 2020 2020 2020 2020 4747 4d4c  );..        GGML
-0004ccf0: 5f50 5249 4e54 5f44 4542 5547 2020 2822  _PRINT_DEBUG  ("
-0004cd00: 6620 2020 2020 203d 2025 3130 2e36 665c  f      = %10.6f\
-0004cd10: 6e22 2c20 6767 6d6c 5f67 6574 5f66 3332  n", ggml_get_f32
-0004cd20: 5f31 6428 662c 2030 2929 3b0a 2020 2020  _1d(f, 0));.    
-0004cd30: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-0004cd40: 4542 5547 5f35 2822 6466 2f64 7830 203d  EBUG_5("df/dx0 =
-0004cd50: 2025 3130 2e36 665c 6e22 2c20 6767 6d6c   %10.6f\n", ggml
-0004cd60: 5f67 6574 5f66 3332 5f31 6428 7073 5b30  _get_f32_1d(ps[0
-0004cd70: 5d2d 3e67 7261 642c 2030 2929 3b0a 2020  ]->grad, 0));.  
-0004cd80: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
-0004cd90: 5f44 4542 5547 5f35 2822 6466 2f64 7831  _DEBUG_5("df/dx1
-0004cda0: 203d 2025 3130 2e36 665c 6e22 2c20 6767   = %10.6f\n", gg
-0004cdb0: 6d6c 5f67 6574 5f66 3332 5f31 6428 7073  ml_get_f32_1d(ps
-0004cdc0: 5b31 5d2d 3e67 7261 642c 2030 2929 3b0a  [1]->grad, 0));.
-0004cdd0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-0004cde0: 7420 6920 3d20 303b 2069 203c 206e 703b  t i = 0; i < np;
-0004cdf0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0004ce00: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-0004ce10: 4542 5547 2822 7061 7261 6d20 2564 3a20  EBUG("param %d: 
-0004ce20: 2531 302e 3666 2c20 6720 3d20 2531 302e  %10.6f, g = %10.
-0004ce30: 3666 5c6e 222c 2069 2c0a 2020 2020 2020  6f\n", i,.      
-0004ce40: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0004ce50: 6d6c 5f67 6574 5f66 3332 5f31 6428 7073  ml_get_f32_1d(ps
-0004ce60: 5b69 5d2c 2030 292c 2067 676d 6c5f 6765  [i], 0), ggml_ge
-0004ce70: 745f 6633 325f 3164 2870 735b 695d 2d3e  t_f32_1d(ps[i]->
-0004ce80: 6772 6164 2c20 3029 293b 0a20 2020 2020  grad, 0));.     
-0004ce90: 2020 207d 0a0a 2020 2020 2020 2020 636f     }..        co
-0004cea0: 6e73 7420 696e 7436 345f 7420 745f 7374  nst int64_t t_st
-0004ceb0: 6172 745f 7761 6c6c 203d 2067 676d 6c5f  art_wall = ggml_
-0004cec0: 7469 6d65 5f75 7328 293b 0a20 2020 2020  time_us();.     
-0004ced0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-0004cee0: 2074 5f73 7461 7274 5f63 7075 203d 2067   t_start_cpu = g
-0004cef0: 676d 6c5f 6379 636c 6573 2829 3b0a 2020  gml_cycles();.  
-0004cf00: 2020 2020 2020 554e 5553 4544 2874 5f73        UNUSED(t_s
-0004cf10: 7461 7274 5f77 616c 6c29 3b0a 2020 2020  tart_wall);.    
-0004cf20: 2020 2020 554e 5553 4544 2874 5f73 7461      UNUSED(t_sta
-0004cf30: 7274 5f63 7075 293b 0a0a 2020 2020 2020  rt_cpu);..      
-0004cf40: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0004cf50: 2f2f 2075 7064 6174 6520 7468 6520 6772  // update the gr
-0004cf60: 6164 6965 6e74 0a20 2020 2020 2020 2020  adient.         
-0004cf70: 2020 2067 676d 6c5f 6f70 745f 6765 745f     ggml_opt_get_
-0004cf80: 6772 6164 286e 702c 2070 732c 2067 3129  grad(np, ps, g1)
-0004cf90: 3b0a 0a20 2020 2020 2020 2020 2020 202f  ;..            /
-0004cfa0: 2f20 6d5f 7420 3d20 6265 7461 312a 6d5f  / m_t = beta1*m_
-0004cfb0: 742d 3120 2b20 2831 202d 2062 6574 6131  t-1 + (1 - beta1
-0004cfc0: 292a 675f 740a 2020 2020 2020 2020 2020  )*g_t.          
-0004cfd0: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
-0004cfe0: 5f66 3332 286e 782c 206d 2c20 6265 7461  _f32(nx, m, beta
-0004cff0: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-0004d000: 6767 6d6c 5f76 6563 5f6d 6164 5f66 3332  ggml_vec_mad_f32
-0004d010: 2020 286e 782c 206d 2c20 6731 2c20 312e    (nx, m, g1, 1.
-0004d020: 3066 202d 2062 6574 6131 293b 0a0a 2020  0f - beta1);..  
-0004d030: 2020 2020 2020 2020 2020 2f2f 2067 3220            // g2 
-0004d040: 3d20 6731 5e32 0a20 2020 2020 2020 2020  = g1^2.         
-0004d050: 2020 2067 676d 6c5f 7665 635f 7371 725f     ggml_vec_sqr_
-0004d060: 6633 3220 2028 6e78 2c20 6732 2c20 6731  f32  (nx, g2, g1
-0004d070: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0004d080: 2f2f 2076 5f74 203d 2062 6574 6132 2a76  // v_t = beta2*v
-0004d090: 5f74 2d31 202b 2028 3120 2d20 6265 7461  _t-1 + (1 - beta
-0004d0a0: 3229 2a67 5f74 5e32 0a20 2020 2020 2020  2)*g_t^2.       
-0004d0b0: 2020 2020 2067 676d 6c5f 7665 635f 7363       ggml_vec_sc
-0004d0c0: 616c 655f 6633 3228 6e78 2c20 762c 2062  ale_f32(nx, v, b
-0004d0d0: 6574 6132 293b 0a20 2020 2020 2020 2020  eta2);.         
-0004d0e0: 2020 2067 676d 6c5f 7665 635f 6d61 645f     ggml_vec_mad_
-0004d0f0: 6633 3220 2028 6e78 2c20 762c 2067 322c  f32  (nx, v, g2,
-0004d100: 2031 2e30 6620 2d20 6265 7461 3229 3b0a   1.0f - beta2);.
-0004d110: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0004d120: 6d5e 6861 7420 3d20 6d5f 7420 2f20 2831  m^hat = m_t / (1
-0004d130: 202d 2062 6574 6131 5e74 290a 2020 2020   - beta1^t).    
-0004d140: 2020 2020 2020 2020 2f2f 2076 5e68 6174          // v^hat
-0004d150: 203d 2076 5f74 202f 2028 3120 2d20 6265   = v_t / (1 - be
-0004d160: 7461 325e 7429 0a20 2020 2020 2020 2020  ta2^t).         
-0004d170: 2020 202f 2f20 785f 7420 3d20 785f 742d     // x_t = x_t-
-0004d180: 3120 2d20 616c 7068 612a 6d5e 6861 742f  1 - alpha*m^hat/
-0004d190: 2873 7172 7428 765e 6861 7429 202b 2065  (sqrt(v^hat) + e
-0004d1a0: 7073 290a 2020 2020 2020 2020 2020 2020  ps).            
-0004d1b0: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-0004d1c0: 2020 286e 782c 206d 682c 206d 293b 0a20    (nx, mh, m);. 
-0004d1d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0004d1e0: 7665 635f 6370 795f 6633 3220 2028 6e78  vec_cpy_f32  (nx
-0004d1f0: 2c20 7668 2c20 7629 3b0a 0a20 2020 2020  , vh, v);..     
-0004d200: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0004d210: 7363 616c 655f 6633 3228 6e78 2c20 6d68  scale_f32(nx, mh
-0004d220: 2c20 616c 7068 612f 2831 2e30 6620 2d20  , alpha/(1.0f - 
-0004d230: 706f 7766 2862 6574 6131 2c20 7420 2b20  powf(beta1, t + 
-0004d240: 3129 2929 3b0a 2020 2020 2020 2020 2020  1)));.          
-0004d250: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
-0004d260: 5f66 3332 286e 782c 2076 682c 2020 312e  _f32(nx, vh,  1.
-0004d270: 3066 2f28 312e 3066 202d 2070 6f77 6628  0f/(1.0f - powf(
-0004d280: 6265 7461 322c 2074 202b 2031 2929 293b  beta2, t + 1)));
-0004d290: 0a0a 2020 2020 2020 2020 2020 2020 6767  ..            gg
-0004d2a0: 6d6c 5f76 6563 5f73 7172 745f 6633 3220  ml_vec_sqrt_f32 
-0004d2b0: 286e 782c 2076 682c 2076 6829 3b0a 2020  (nx, vh, vh);.  
-0004d2c0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0004d2d0: 6563 5f61 6363 315f 6633 3220 286e 782c  ec_acc1_f32 (nx,
-0004d2e0: 2076 682c 2065 7073 293b 0a0a 2020 2020   vh, eps);..    
-0004d2f0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0004d300: 5f64 6976 5f66 3332 2020 286e 782c 206d  _div_f32  (nx, m
-0004d310: 682c 206d 682c 2076 6829 3b0a 2020 2020  h, mh, vh);.    
-0004d320: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0004d330: 5f73 7562 5f66 3332 2020 286e 782c 2078  _sub_f32  (nx, x
-0004d340: 2c20 2078 2c20 206d 6829 3b0a 0a20 2020  ,  x,  mh);..   
-0004d350: 2020 2020 2020 2020 202f 2f20 7570 6461           // upda
-0004d360: 7465 2074 6865 2070 6172 616d 6574 6572  te the parameter
-0004d370: 730a 2020 2020 2020 2020 2020 2020 6767  s.            gg
-0004d380: 6d6c 5f6f 7074 5f73 6574 5f70 6172 616d  ml_opt_set_param
-0004d390: 7328 6e70 2c20 7073 2c20 7829 3b0a 2020  s(np, ps, x);.  
-0004d3a0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0004d3b0: 2067 676d 6c5f 6772 6170 685f 7265 7365   ggml_graph_rese
-0004d3c0: 7420 2028 6766 293b 0a20 2020 2020 2020  t  (gf);.       
-0004d3d0: 2067 676d 6c5f 7365 745f 6633 3220 2020   ggml_set_f32   
-0004d3e0: 2020 2028 662d 3e67 7261 642c 2031 2e30     (f->grad, 1.0
-0004d3f0: 6629 3b0a 2020 2020 2020 2020 6767 6d6c  f);.        ggml
-0004d400: 5f67 7261 7068 5f63 6f6d 7075 7465 2863  _graph_compute(c
-0004d410: 7478 2c20 6762 293b 0a0a 2020 2020 2020  tx, gb);..      
-0004d420: 2020 636f 6e73 7420 666c 6f61 7420 6678    const float fx
-0004d430: 203d 2067 676d 6c5f 6765 745f 6633 325f   = ggml_get_f32_
-0004d440: 3164 2866 2c20 3029 3b0a 0a20 2020 2020  1d(f, 0);..     
-0004d450: 2020 202f 2f20 6368 6563 6b20 636f 6e76     // check conv
-0004d460: 6572 6765 6e63 650a 2020 2020 2020 2020  ergence.        
-0004d470: 6966 2028 6661 6273 6628 6678 202d 2066  if (fabsf(fx - f
-0004d480: 785f 7072 6576 292f 6678 203c 2070 6172  x_prev)/fx < par
-0004d490: 616d 732e 6164 616d 2e65 7073 5f66 2920  ams.adam.eps_f) 
-0004d4a0: 7b0a 2020 2020 2020 2020 2020 2020 4747  {.            GG
-0004d4b0: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
-0004d4c0: 636f 6e76 6572 6765 645c 6e22 293b 0a0a  converged\n");..
-0004d4d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0004d4e0: 726e 2047 474d 4c5f 4f50 545f 4f4b 3b0a  rn GGML_OPT_OK;.
-0004d4f0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0004d500: 2020 202f 2f20 6465 6c74 612d 6261 7365     // delta-base
-0004d510: 6420 636f 6e76 6572 6765 6e63 6520 7465  d convergence te
-0004d520: 7374 0a20 2020 2020 2020 2069 6620 2870  st.        if (p
-0004d530: 6620 213d 204e 554c 4c29 207b 0a20 2020  f != NULL) {.   
-0004d540: 2020 2020 2020 2020 202f 2f20 6e65 6564           // need
-0004d550: 2061 7420 6c65 6173 7420 7061 7261 6d73   at least params
-0004d560: 2e70 6173 7420 6974 6572 6174 696f 6e73  .past iterations
-0004d570: 2074 6f20 7374 6172 7420 6368 6563 6b69   to start checki
-0004d580: 6e67 2066 6f72 2063 6f6e 7665 7267 656e  ng for convergen
-0004d590: 6365 0a20 2020 2020 2020 2020 2020 2069  ce.            i
-0004d5a0: 6620 2870 6172 616d 732e 7061 7374 203c  f (params.past <
-0004d5b0: 3d20 7429 207b 0a20 2020 2020 2020 2020  = t) {.         
-0004d5c0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0004d5d0: 6174 2072 6174 6520 3d20 2870 665b 7425  at rate = (pf[t%
-0004d5e0: 7061 7261 6d73 2e70 6173 745d 202d 2066  params.past] - f
-0004d5f0: 7829 2f66 783b 0a0a 2020 2020 2020 2020  x)/fx;..        
-0004d600: 2020 2020 2020 2020 6966 2028 6661 6273          if (fabs
-0004d610: 2872 6174 6529 203c 2070 6172 616d 732e  (rate) < params.
-0004d620: 6465 6c74 6129 207b 0a20 2020 2020 2020  delta) {.       
-0004d630: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0004d640: 7572 6e20 4747 4d4c 5f4f 5054 5f4f 4b3b  urn GGML_OPT_OK;
-0004d650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004d660: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0004d670: 0a0a 2020 2020 2020 2020 2020 2020 7066  ..            pf
-0004d680: 5b74 2570 6172 616d 732e 7061 7374 5d20  [t%params.past] 
-0004d690: 3d20 6678 3b0a 2020 2020 2020 2020 7d0a  = fx;.        }.
-0004d6a0: 0a20 2020 2020 2020 202f 2f20 6368 6563  .        // chec
-0004d6b0: 6b20 666f 7220 696d 7072 6f76 656d 656e  k for improvemen
-0004d6c0: 740a 2020 2020 2020 2020 6966 2028 7061  t.        if (pa
-0004d6d0: 7261 6d73 2e6d 6178 5f6e 6f5f 696d 7072  rams.max_no_impr
-0004d6e0: 6f76 656d 656e 7420 3e20 3029 207b 0a20  ovement > 0) {. 
-0004d6f0: 2020 2020 2020 2020 2020 2069 6620 2866             if (f
-0004d700: 785f 6265 7374 203e 2066 7829 207b 0a20  x_best > fx) {. 
-0004d710: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004d720: 785f 6265 7374 203d 2066 783b 0a20 2020  x_best = fx;.   
-0004d730: 2020 2020 2020 2020 2020 2020 206e 5f6e               n_n
-0004d740: 6f5f 696d 7072 6f76 656d 656e 7420 3d20  o_improvement = 
-0004d750: 303b 0a20 2020 2020 2020 2020 2020 207d  0;.            }
-0004d760: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0004d770: 2020 2020 2020 2020 2b2b 6e5f 6e6f 5f69          ++n_no_i
-0004d780: 6d70 726f 7665 6d65 6e74 3b0a 0a20 2020  mprovement;..   
-0004d790: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0004d7a0: 286e 5f6e 6f5f 696d 7072 6f76 656d 656e  (n_no_improvemen
-0004d7b0: 7420 3e3d 2070 6172 616d 732e 6d61 785f  t >= params.max_
-0004d7c0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 2920  no_improvement) 
-0004d7d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0004d7e0: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
-0004d7f0: 4c5f 4f50 545f 4f4b 3b0a 2020 2020 2020  L_OPT_OK;.      
-0004d800: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0004d810: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0004d820: 2020 7d0a 0a20 2020 2020 2020 2066 785f    }..        fx_
-0004d830: 7072 6576 203d 2066 783b 0a0a 2020 2020  prev = fx;..    
-0004d840: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0004d850: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0004d860: 745f 656e 645f 6370 7520 3d20 6767 6d6c  t_end_cpu = ggml
-0004d870: 5f63 7963 6c65 7328 293b 0a20 2020 2020  _cycles();.     
-0004d880: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-0004d890: 545f 4445 4255 4728 2274 696d 6520 6974  T_DEBUG("time it
-0004d8a0: 6572 3a20 2020 2020 2025 352e 3366 2073  er:      %5.3f s
-0004d8b0: 5c6e 222c 2028 2866 6c6f 6174 2928 745f  \n", ((float)(t_
-0004d8c0: 656e 645f 6370 7520 2d20 745f 7374 6172  end_cpu - t_star
-0004d8d0: 745f 6370 7529 292f 434c 4f43 4b53 5f50  t_cpu))/CLOCKS_P
-0004d8e0: 4552 5f53 4543 293b 0a20 2020 2020 2020  ER_SEC);.       
-0004d8f0: 2020 2020 2055 4e55 5345 4428 745f 656e       UNUSED(t_en
-0004d900: 645f 6370 7529 3b0a 0a20 2020 2020 2020  d_cpu);..       
-0004d910: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0004d920: 5f74 2074 5f65 6e64 5f77 616c 6c20 3d20  _t t_end_wall = 
-0004d930: 6767 6d6c 5f74 696d 655f 7573 2829 3b0a  ggml_time_us();.
-0004d940: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0004d950: 5f50 5249 4e54 5f44 4542 5547 2822 7761  _PRINT_DEBUG("wa
-0004d960: 6c6c 2074 696d 6520 6974 6572 3a20 2535  ll time iter: %5
-0004d970: 2e33 6620 735c 6e22 2c20 2874 5f65 6e64  .3f s\n", (t_end
-0004d980: 5f77 616c 6c20 2d20 745f 7374 6172 745f  _wall - t_start_
-0004d990: 7761 6c6c 292f 3165 3629 3b0a 2020 2020  wall)/1e6);.    
-0004d9a0: 2020 2020 2020 2020 554e 5553 4544 2874          UNUSED(t
-0004d9b0: 5f65 6e64 5f77 616c 6c29 3b0a 2020 2020  _end_wall);.    
-0004d9c0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-0004d9d0: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
-0004d9e0: 5f44 4944 5f4e 4f54 5f43 4f4e 5645 5247  _DID_NOT_CONVERG
-0004d9f0: 453b 0a7d 0a0a 2f2f 0a2f 2f20 4c2d 4246  E;.}..//.// L-BF
-0004da00: 4753 0a2f 2f0a 2f2f 2074 6865 204c 2d42  GS.//.// the L-B
-0004da10: 4647 5320 696d 706c 656d 656e 7461 7469  FGS implementati
-0004da20: 6f6e 2062 656c 6f77 2069 7320 6261 7365  on below is base
-0004da30: 6420 6f6e 2074 6865 2066 6f6c 6c6f 7769  d on the followi
-0004da40: 6e67 2069 6d70 6c65 6d65 6e74 6174 696f  ng implementatio
-0004da50: 6e3a 0a2f 2f0a 2f2f 2020 2068 7474 7073  n:.//.//   https
-0004da60: 3a2f 2f67 6974 6875 622e 636f 6d2f 6368  ://github.com/ch
-0004da70: 6f6b 6b61 6e2f 6c69 626c 6266 6773 0a2f  okkan/liblbfgs./
-0004da80: 2f0a 0a73 7472 7563 7420 6767 6d6c 5f6c  /..struct ggml_l
-0004da90: 6266 6773 5f69 7465 7261 7469 6f6e 5f64  bfgs_iteration_d
-0004daa0: 6174 6120 7b0a 2020 2020 666c 6f61 7420  ata {.    float 
-0004dab0: 616c 7068 613b 0a20 2020 2066 6c6f 6174  alpha;.    float
-0004dac0: 2079 733b 0a20 2020 2066 6c6f 6174 202a   ys;.    float *
-0004dad0: 2073 3b0a 2020 2020 666c 6f61 7420 2a20   s;.    float * 
-0004dae0: 793b 0a7d 3b0a 0a73 7461 7469 6320 656e  y;.};..static en
-0004daf0: 756d 2067 676d 6c5f 6f70 745f 7265 7375  um ggml_opt_resu
-0004db00: 6c74 206c 696e 6573 6561 7263 685f 6261  lt linesearch_ba
-0004db10: 636b 7472 6163 6b69 6e67 280a 2020 2020  cktracking(.    
-0004db20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0004db30: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-0004db40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0004db50: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
-0004db60: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-0004db70: 2020 2020 2020 696e 7420 6e78 2c0a 2020        int nx,.  
-0004db80: 2020 2020 2020 666c 6f61 7420 2a20 782c        float * x,
-0004db90: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-0004dba0: 2066 782c 0a20 2020 2020 2020 2066 6c6f   fx,.        flo
-0004dbb0: 6174 202a 2067 2c0a 2020 2020 2020 2020  at * g,.        
-0004dbc0: 666c 6f61 7420 2a20 642c 0a20 2020 2020  float * d,.     
-0004dbd0: 2020 2066 6c6f 6174 202a 2073 7465 702c     float * step,
-0004dbe0: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-0004dbf0: 6c6f 6174 202a 2078 702c 0a20 2020 2020  loat * xp,.     
-0004dc00: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0004dc10: 656e 736f 7220 2a20 662c 0a20 2020 2020  ensor * f,.     
-0004dc20: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0004dc30: 6772 6170 6820 2a20 6766 2c0a 2020 2020  graph * gf,.    
-0004dc40: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0004dc50: 6367 7261 7068 202a 2067 622c 0a20 2020  cgraph * gb,.   
-0004dc60: 2020 2020 2063 6f6e 7374 2069 6e74 206e       const int n
-0004dc70: 702c 0a20 2020 2020 2020 2073 7472 7563  p,.        struc
-0004dc80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0004dc90: 7073 5b5d 2920 7b0a 2020 2020 696e 7420  ps[]) {.    int 
-0004dca0: 636f 756e 7420 3d20 303b 0a0a 2020 2020  count = 0;..    
-0004dcb0: 666c 6f61 7420 7769 6474 6820 203d 2030  float width  = 0
-0004dcc0: 2e30 663b 0a20 2020 2066 6c6f 6174 2064  .0f;.    float d
-0004dcd0: 6720 2020 2020 3d20 302e 3066 3b0a 2020  g     = 0.0f;.  
-0004dce0: 2020 666c 6f61 7420 6669 6e69 7420 203d    float finit  =
-0004dcf0: 2030 2e30 663b 0a20 2020 2066 6c6f 6174   0.0f;.    float
-0004dd00: 2064 6769 6e69 7420 3d20 302e 3066 3b0a   dginit = 0.0f;.
-0004dd10: 2020 2020 666c 6f61 7420 6467 7465 7374      float dgtest
-0004dd20: 203d 2030 2e30 663b 0a0a 2020 2020 636f   = 0.0f;..    co
-0004dd30: 6e73 7420 666c 6f61 7420 6465 6320 3d20  nst float dec = 
-0004dd40: 302e 3566 3b0a 2020 2020 636f 6e73 7420  0.5f;.    const 
-0004dd50: 666c 6f61 7420 696e 6320 3d20 322e 3166  float inc = 2.1f
-0004dd60: 3b0a 0a20 2020 2069 6620 282a 7374 6570  ;..    if (*step
-0004dd70: 203c 3d20 302e 2920 7b0a 2020 2020 2020   <= 0.) {.      
-0004dd80: 2020 7265 7475 726e 2047 474d 4c5f 4c49    return GGML_LI
-0004dd90: 4e45 5345 4152 4348 5f49 4e56 414c 4944  NESEARCH_INVALID
-0004dda0: 5f50 4152 414d 4554 4552 533b 0a20 2020  _PARAMETERS;.   
-0004ddb0: 207d 0a0a 2020 2020 2f2f 2063 6f6d 7075   }..    // compu
-0004ddc0: 7465 2074 6865 2069 6e69 7469 616c 2067  te the initial g
-0004ddd0: 7261 6469 656e 7420 696e 2074 6865 2073  radient in the s
-0004dde0: 6561 7263 6820 6469 7265 6374 696f 6e0a  earch direction.
-0004ddf0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
-0004de00: 5f66 3332 286e 782c 2026 6467 696e 6974  _f32(nx, &dginit
-0004de10: 2c20 672c 2064 293b 0a0a 2020 2020 2f2f  , g, d);..    //
-0004de20: 206d 616b 6520 7375 7265 2074 6861 7420   make sure that 
-0004de30: 6420 706f 696e 7473 2074 6f20 6120 6465  d points to a de
-0004de40: 7363 656e 7420 6469 7265 6374 696f 6e0a  scent direction.
-0004de50: 2020 2020 6966 2028 3020 3c20 6467 696e      if (0 < dgin
-0004de60: 6974 2920 7b0a 2020 2020 2020 2020 7265  it) {.        re
-0004de70: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
-0004de80: 4152 4348 5f46 4149 4c3b 0a20 2020 207d  ARCH_FAIL;.    }
-0004de90: 0a0a 2020 2020 2f2f 2069 6e69 7469 616c  ..    // initial
-0004dea0: 697a 6520 6c6f 6361 6c20 7661 7269 6162  ize local variab
-0004deb0: 6c65 730a 2020 2020 6669 6e69 7420 3d20  les.    finit = 
-0004dec0: 2a66 783b 0a20 2020 2064 6774 6573 7420  *fx;.    dgtest 
-0004ded0: 3d20 7061 7261 6d73 2d3e 6c62 6667 732e  = params->lbfgs.
-0004dee0: 6674 6f6c 2a64 6769 6e69 743b 0a0a 2020  ftol*dginit;..  
-0004def0: 2020 7768 696c 6520 2874 7275 6529 207b    while (true) {
-0004df00: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-0004df10: 635f 6370 795f 6633 3228 6e78 2c20 782c  c_cpy_f32(nx, x,
-0004df20: 2078 7029 3b0a 2020 2020 2020 2020 6767   xp);.        gg
-0004df30: 6d6c 5f76 6563 5f6d 6164 5f66 3332 286e  ml_vec_mad_f32(n
-0004df40: 782c 2078 2c20 642c 202a 7374 6570 293b  x, x, d, *step);
-0004df50: 0a0a 2020 2020 2020 2020 2f2f 2065 7661  ..        // eva
-0004df60: 6c75 6174 6520 7468 6520 6675 6e63 7469  luate the functi
-0004df70: 6f6e 2061 6e64 2067 7261 6469 656e 7420  on and gradient 
-0004df80: 7661 6c75 6573 0a20 2020 2020 2020 207b  values.        {
-0004df90: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0004dfa0: 6c5f 6f70 745f 7365 745f 7061 7261 6d73  l_opt_set_params
-0004dfb0: 286e 702c 2070 732c 2078 293b 0a0a 2020  (np, ps, x);..  
-0004dfc0: 2020 2020 2020 2020 2020 6767 6d6c 5f67            ggml_g
-0004dfd0: 7261 7068 5f72 6573 6574 2020 2867 6629  raph_reset  (gf)
-0004dfe0: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
-0004dff0: 6d6c 5f73 6574 5f66 3332 2020 2020 2020  ml_set_f32      
-0004e000: 2866 2d3e 6772 6164 2c20 312e 3066 293b  (f->grad, 1.0f);
-0004e010: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0004e020: 6c5f 6772 6170 685f 636f 6d70 7574 6528  l_graph_compute(
-0004e030: 6374 782c 2067 6229 3b0a 0a20 2020 2020  ctx, gb);..     
-0004e040: 2020 2020 2020 2067 676d 6c5f 6f70 745f         ggml_opt_
-0004e050: 6765 745f 6772 6164 286e 702c 2070 732c  get_grad(np, ps,
-0004e060: 2067 293b 0a0a 2020 2020 2020 2020 2020   g);..          
-0004e070: 2020 2a66 7820 3d20 6767 6d6c 5f67 6574    *fx = ggml_get
-0004e080: 5f66 3332 5f31 6428 662c 2030 293b 0a20  _f32_1d(f, 0);. 
-0004e090: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0004e0a0: 2020 2b2b 636f 756e 743b 0a0a 2020 2020    ++count;..    
-0004e0b0: 2020 2020 6966 2028 2a66 7820 3e20 6669      if (*fx > fi
-0004e0c0: 6e69 7420 2b20 282a 7374 6570 292a 6467  nit + (*step)*dg
-0004e0d0: 7465 7374 2920 7b0a 2020 2020 2020 2020  test) {.        
-0004e0e0: 2020 2020 7769 6474 6820 3d20 6465 633b      width = dec;
-0004e0f0: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
-0004e100: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
-0004e110: 2041 726d 696a 6f20 636f 6e64 6974 696f   Armijo conditio
-0004e120: 6e20 6973 2073 6174 6973 6669 6564 0a20  n is satisfied. 
-0004e130: 2020 2020 2020 2020 2020 2069 6620 2870             if (p
-0004e140: 6172 616d 732d 3e6c 6266 6773 2e6c 696e  arams->lbfgs.lin
-0004e150: 6573 6561 7263 6820 3d3d 2047 474d 4c5f  esearch == GGML_
-0004e160: 4c49 4e45 5345 4152 4348 5f42 4143 4b54  LINESEARCH_BACKT
-0004e170: 5241 434b 494e 475f 4152 4d49 4a4f 2920  RACKING_ARMIJO) 
-0004e180: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0004e190: 2020 7265 7475 726e 2063 6f75 6e74 3b0a    return count;.
-0004e1a0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0004e1b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0004e1c0: 7665 635f 646f 745f 6633 3228 6e78 2c20  vec_dot_f32(nx, 
-0004e1d0: 2664 672c 2067 2c20 6429 3b0a 0a20 2020  &dg, g, d);..   
-0004e1e0: 2020 2020 2020 2020 202f 2f20 6368 6563           // chec
-0004e1f0: 6b20 7468 6520 576f 6c66 6520 636f 6e64  k the Wolfe cond
-0004e200: 6974 696f 6e0a 2020 2020 2020 2020 2020  ition.          
-0004e210: 2020 6966 2028 6467 203c 2070 6172 616d    if (dg < param
-0004e220: 732d 3e6c 6266 6773 2e77 6f6c 6665 202a  s->lbfgs.wolfe *
-0004e230: 2064 6769 6e69 7429 207b 0a20 2020 2020   dginit) {.     
-0004e240: 2020 2020 2020 2020 2020 2077 6964 7468             width
-0004e250: 203d 2069 6e63 3b0a 2020 2020 2020 2020   = inc;.        
-0004e260: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-0004e270: 2020 2020 2020 2020 2020 2020 2069 6628               if(
-0004e280: 7061 7261 6d73 2d3e 6c62 6667 732e 6c69  params->lbfgs.li
-0004e290: 6e65 7365 6172 6368 203d 3d20 4747 4d4c  nesearch == GGML
-0004e2a0: 5f4c 494e 4553 4541 5243 485f 4241 434b  _LINESEARCH_BACK
-0004e2b0: 5452 4143 4b49 4e47 5f57 4f4c 4645 2920  TRACKING_WOLFE) 
-0004e2c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0004e2d0: 2020 2020 2020 2f2f 2072 6567 756c 6172        // regular
-0004e2e0: 2057 6f6c 6665 2063 6f6e 6469 7469 6f6e   Wolfe condition
-0004e2f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0004e300: 2020 2020 2020 7265 7475 726e 2063 6f75        return cou
-0004e310: 6e74 3b0a 2020 2020 2020 2020 2020 2020  nt;.            
-0004e320: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0004e330: 2020 2020 2020 2069 6628 6467 203e 202d         if(dg > -
-0004e340: 7061 7261 6d73 2d3e 6c62 6667 732e 776f  params->lbfgs.wo
-0004e350: 6c66 652a 6467 696e 6974 2920 7b0a 2020  lfe*dginit) {.  
-0004e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e370: 2020 7769 6474 6820 3d20 6465 633b 0a20    width = dec;. 
-0004e380: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0004e390: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0004e3a0: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-0004e3b0: 7472 6f6e 6720 576f 6c66 6520 636f 6e64  trong Wolfe cond
-0004e3c0: 6974 696f 6e20 2847 474d 4c5f 4c49 4e45  ition (GGML_LINE
-0004e3d0: 5345 4152 4348 5f42 4143 4b54 5241 434b  SEARCH_BACKTRACK
-0004e3e0: 494e 475f 5354 524f 4e47 5f57 4f4c 4645  ING_STRONG_WOLFE
-0004e3f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004e400: 2020 2020 2020 7265 7475 726e 2063 6f75        return cou
-0004e410: 6e74 3b0a 2020 2020 2020 2020 2020 2020  nt;.            
-0004e420: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0004e430: 2020 2020 2020 7265 7475 726e 2063 6f75        return cou
-0004e440: 6e74 3b0a 2020 2020 2020 2020 2020 2020  nt;.            
-0004e450: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0004e460: 2020 2020 2069 6620 282a 7374 6570 203c       if (*step <
-0004e470: 2070 6172 616d 732d 3e6c 6266 6773 2e6d   params->lbfgs.m
-0004e480: 696e 5f73 7465 7029 207b 0a20 2020 2020  in_step) {.     
-0004e490: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
-0004e4a0: 4d4c 5f4c 494e 4553 4541 5243 485f 4d49  ML_LINESEARCH_MI
-0004e4b0: 4e49 4d55 4d5f 5354 4550 3b0a 2020 2020  NIMUM_STEP;.    
-0004e4c0: 2020 2020 7d0a 2020 2020 2020 2020 6966      }.        if
-0004e4d0: 2028 2a73 7465 7020 3e20 7061 7261 6d73   (*step > params
-0004e4e0: 2d3e 6c62 6667 732e 6d61 785f 7374 6570  ->lbfgs.max_step
-0004e4f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004e500: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
-0004e510: 5345 4152 4348 5f4d 4158 494d 554d 5f53  SEARCH_MAXIMUM_S
-0004e520: 5445 503b 0a20 2020 2020 2020 207d 0a20  TEP;.        }. 
-0004e530: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
-0004e540: 732d 3e6c 6266 6773 2e6d 6178 5f6c 696e  s->lbfgs.max_lin
-0004e550: 6573 6561 7263 6820 3c3d 2063 6f75 6e74  esearch <= count
-0004e560: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004e570: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
-0004e580: 5345 4152 4348 5f4d 4158 494d 554d 5f49  SEARCH_MAXIMUM_I
-0004e590: 5445 5241 5449 4f4e 533b 0a20 2020 2020  TERATIONS;.     
-0004e5a0: 2020 207d 0a0a 2020 2020 2020 2020 282a     }..        (*
-0004e5b0: 7374 6570 2920 2a3d 2077 6964 7468 3b0a  step) *= width;.
-0004e5c0: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-0004e5d0: 6e20 4747 4d4c 5f4c 494e 4553 4541 5243  n GGML_LINESEARC
-0004e5e0: 485f 4641 494c 3b0a 7d0a 0a73 7461 7469  H_FAIL;.}..stati
-0004e5f0: 6320 656e 756d 2067 676d 6c5f 6f70 745f  c enum ggml_opt_
-0004e600: 7265 7375 6c74 2067 676d 6c5f 6f70 745f  result ggml_opt_
-0004e610: 6c62 6667 7328 0a20 2020 2020 2020 2073  lbfgs(.        s
-0004e620: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-0004e630: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-0004e640: 2020 7374 7275 6374 2067 676d 6c5f 6f70    struct ggml_op
-0004e650: 745f 7061 7261 6d73 2070 6172 616d 732c  t_params params,
-0004e660: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0004e670: 6767 6d6c 5f74 656e 736f 7220 2a20 662c  ggml_tensor * f,
-0004e680: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0004e690: 6767 6d6c 5f63 6772 6170 6820 2a20 6766  ggml_cgraph * gf
-0004e6a0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0004e6b0: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
-0004e6c0: 6229 207b 0a20 2020 2069 6620 2870 6172  b) {.    if (par
-0004e6d0: 616d 732e 6c62 6667 732e 6c69 6e65 7365  ams.lbfgs.linese
-0004e6e0: 6172 6368 203d 3d20 4747 4d4c 5f4c 494e  arch == GGML_LIN
-0004e6f0: 4553 4541 5243 485f 4241 434b 5452 4143  ESEARCH_BACKTRAC
-0004e700: 4b49 4e47 5f57 4f4c 4645 207c 7c0a 2020  KING_WOLFE ||.  
-0004e710: 2020 2020 2020 7061 7261 6d73 2e6c 6266        params.lbf
-0004e720: 6773 2e6c 696e 6573 6561 7263 6820 3d3d  gs.linesearch ==
-0004e730: 2047 474d 4c5f 4c49 4e45 5345 4152 4348   GGML_LINESEARCH
-0004e740: 5f42 4143 4b54 5241 434b 494e 475f 5354  _BACKTRACKING_ST
-0004e750: 524f 4e47 5f57 4f4c 4645 2920 7b0a 2020  RONG_WOLFE) {.  
-0004e760: 2020 2020 2020 6966 2028 7061 7261 6d73        if (params
-0004e770: 2e6c 6266 6773 2e77 6f6c 6665 203c 3d20  .lbfgs.wolfe <= 
-0004e780: 7061 7261 6d73 2e6c 6266 6773 2e66 746f  params.lbfgs.fto
-0004e790: 6c20 7c7c 2031 2e20 3c3d 2070 6172 616d  l || 1. <= param
-0004e7a0: 732e 6c62 6667 732e 776f 6c66 6529 207b  s.lbfgs.wolfe) {
-0004e7b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0004e7c0: 7572 6e20 4747 4d4c 5f4f 5054 5f49 4e56  urn GGML_OPT_INV
-0004e7d0: 414c 4944 5f57 4f4c 4645 3b0a 2020 2020  ALID_WOLFE;.    
-0004e7e0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-0004e7f0: 2067 662d 3e6e 5f74 6872 6561 6473 203d   gf->n_threads =
-0004e800: 2070 6172 616d 732e 6e5f 7468 7265 6164   params.n_thread
-0004e810: 733b 0a20 2020 2067 622d 3e6e 5f74 6872  s;.    gb->n_thr
-0004e820: 6561 6473 203d 2070 6172 616d 732e 6e5f  eads = params.n_
-0004e830: 7468 7265 6164 733b 0a0a 2020 2020 636f  threads;..    co
-0004e840: 6e73 7420 696e 7420 6d20 3d20 7061 7261  nst int m = para
-0004e850: 6d73 2e6c 6266 6773 2e6d 3b0a 0a20 2020  ms.lbfgs.m;..   
-0004e860: 202f 2f20 7468 6573 6520 7769 6c6c 2073   // these will s
-0004e870: 746f 7265 2074 6865 2070 6172 616d 6574  tore the paramet
-0004e880: 6572 7320 7765 2077 616e 7420 746f 206f  ers we want to o
-0004e890: 7074 696d 697a 650a 2020 2020 7374 7275  ptimize.    stru
-0004e8a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0004e8b0: 2070 735b 4747 4d4c 5f4d 4158 5f50 4152   ps[GGML_MAX_PAR
-0004e8c0: 414d 535d 3b0a 0a20 2020 2069 6e74 206e  AMS];..    int n
-0004e8d0: 7020 3d20 303b 0a20 2020 2069 6e74 206e  p = 0;.    int n
-0004e8e0: 7820 3d20 303b 0a20 2020 2066 6f72 2028  x = 0;.    for (
-0004e8f0: 696e 7420 6920 3d20 303b 2069 203c 2067  int i = 0; i < g
-0004e900: 662d 3e6e 5f6e 6f64 6573 3b20 2b2b 6929  f->n_nodes; ++i)
-0004e910: 207b 0a20 2020 2020 2020 2069 6620 2867   {.        if (g
-0004e920: 662d 3e6e 6f64 6573 5b69 5d2d 3e69 735f  f->nodes[i]->is_
-0004e930: 7061 7261 6d29 207b 0a20 2020 2020 2020  param) {.       
-0004e940: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
-0004e950: 4445 4255 4728 2266 6f75 6e64 2070 6172  DEBUG("found par
-0004e960: 616d 2025 643a 2067 7261 642d 3e6f 7020  am %d: grad->op 
-0004e970: 3d20 2564 5c6e 222c 206e 702c 2067 662d  = %d\n", np, gf-
-0004e980: 3e6e 6f64 6573 5b69 5d2d 3e67 7261 642d  >nodes[i]->grad-
-0004e990: 3e6f 7029 3b0a 0a20 2020 2020 2020 2020  >op);..         
-0004e9a0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0004e9b0: 7020 3c20 4747 4d4c 5f4d 4158 5f50 4152  p < GGML_MAX_PAR
-0004e9c0: 414d 5329 3b0a 0a20 2020 2020 2020 2020  AMS);..         
-0004e9d0: 2020 2070 735b 6e70 2b2b 5d20 3d20 6766     ps[np++] = gf
-0004e9e0: 2d3e 6e6f 6465 735b 695d 3b0a 2020 2020  ->nodes[i];.    
-0004e9f0: 2020 2020 2020 2020 6e78 202b 3d20 6767          nx += gg
-0004ea00: 6d6c 5f6e 656c 656d 656e 7473 2867 662d  ml_nelements(gf-
-0004ea10: 3e6e 6f64 6573 5b69 5d29 3b0a 2020 2020  >nodes[i]);.    
-0004ea20: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-0004ea30: 2066 6c6f 6174 202a 2078 2020 3d20 6767   float * x  = gg
-0004ea40: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-0004ea50: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-0004ea60: 4633 322c 206e 7829 2d3e 6461 7461 3b20  F32, nx)->data; 
-0004ea70: 2f2f 2063 7572 7265 6e74 2070 6172 616d  // current param
-0004ea80: 6574 6572 730a 2020 2020 666c 6f61 7420  eters.    float 
-0004ea90: 2a20 7870 203d 2067 676d 6c5f 6e65 775f  * xp = ggml_new_
-0004eaa0: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-0004eab0: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
-0004eac0: 292d 3e64 6174 613b 202f 2f20 7072 6576  )->data; // prev
-0004ead0: 696f 7573 2070 6172 616d 6574 6572 730a  ious parameters.
-0004eae0: 2020 2020 666c 6f61 7420 2a20 6720 203d      float * g  =
-0004eaf0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-0004eb00: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
-0004eb10: 5045 5f46 3332 2c20 6e78 292d 3e64 6174  PE_F32, nx)->dat
-0004eb20: 613b 202f 2f20 6375 7272 656e 7420 6772  a; // current gr
-0004eb30: 6164 6965 6e74 0a20 2020 2066 6c6f 6174  adient.    float
-0004eb40: 202a 2067 7020 3d20 6767 6d6c 5f6e 6577   * gp = ggml_new
-0004eb50: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-0004eb60: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
-0004eb70: 7829 2d3e 6461 7461 3b20 2f2f 2070 7265  x)->data; // pre
-0004eb80: 7669 6f75 7320 6772 6164 6965 6e74 0a20  vious gradient. 
-0004eb90: 2020 2066 6c6f 6174 202a 2064 2020 3d20     float * d  = 
-0004eba0: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-0004ebb0: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-0004ebc0: 455f 4633 322c 206e 7829 2d3e 6461 7461  E_F32, nx)->data
-0004ebd0: 3b20 2f2f 2073 6561 7263 6820 6469 7265  ; // search dire
-0004ebe0: 6374 696f 6e0a 0a20 2020 2066 6c6f 6174  ction..    float
-0004ebf0: 202a 2070 6620 3d20 7061 7261 6d73 2e70   * pf = params.p
-0004ec00: 6173 7420 3e20 3020 3f20 6767 6d6c 5f6e  ast > 0 ? ggml_n
-0004ec10: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-0004ec20: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-0004ec30: 2070 6172 616d 732e 7061 7374 292d 3e64   params.past)->d
-0004ec40: 6174 6120 3a20 4e55 4c4c 3b20 2f2f 2070  ata : NULL; // p
-0004ec50: 6173 7420 6675 6e63 7469 6f6e 2076 616c  ast function val
-0004ec60: 7565 730a 0a20 2020 2066 6c6f 6174 2066  ues..    float f
-0004ec70: 7820 2020 203d 2030 2e30 663b 202f 2f20  x    = 0.0f; // 
-0004ec80: 636f 7374 2066 756e 6374 696f 6e20 7661  cost function va
-0004ec90: 6c75 650a 2020 2020 666c 6f61 7420 786e  lue.    float xn
-0004eca0: 6f72 6d20 3d20 302e 3066 3b20 2f2f 207c  orm = 0.0f; // |
-0004ecb0: 7c78 7c7c 0a20 2020 2066 6c6f 6174 2067  |x||.    float g
-0004ecc0: 6e6f 726d 203d 2030 2e30 663b 202f 2f20  norm = 0.0f; // 
-0004ecd0: 7c7c 677c 7c0a 2020 2020 666c 6f61 7420  ||g||.    float 
-0004ece0: 7374 6570 2020 3d20 302e 3066 3b0a 0a20  step  = 0.0f;.. 
-0004ecf0: 2020 202f 2f20 696e 6974 6961 6c69 7a65     // initialize
-0004ed00: 2078 2066 726f 6d20 7468 6520 6772 6170   x from the grap
-0004ed10: 6820 6e6f 6465 730a 2020 2020 6767 6d6c  h nodes.    ggml
-0004ed20: 5f6f 7074 5f67 6574 5f70 6172 616d 7328  _opt_get_params(
-0004ed30: 6e70 2c20 7073 2c20 7829 3b0a 0a20 2020  np, ps, x);..   
-0004ed40: 202f 2f20 7468 6520 4c2d 4246 4753 206d   // the L-BFGS m
-0004ed50: 656d 6f72 790a 2020 2020 7374 7275 6374  emory.    struct
-0004ed60: 2067 676d 6c5f 6c62 6667 735f 6974 6572   ggml_lbfgs_iter
-0004ed70: 6174 696f 6e5f 6461 7461 202a 206c 6d20  ation_data * lm 
-0004ed80: 3d20 616c 6c6f 6361 2873 697a 656f 6628  = alloca(sizeof(
-0004ed90: 7374 7275 6374 2067 676d 6c5f 6c62 6667  struct ggml_lbfg
-0004eda0: 735f 6974 6572 6174 696f 6e5f 6461 7461  s_iteration_data
-0004edb0: 292a 6d29 3b0a 0a20 2020 2066 6f72 2028  )*m);..    for (
-0004edc0: 696e 7420 6920 3d20 303b 2069 203c 206d  int i = 0; i < m
-0004edd0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-0004ede0: 206c 6d5b 695d 2e61 6c70 6861 203d 2030   lm[i].alpha = 0
-0004edf0: 2e30 663b 0a20 2020 2020 2020 206c 6d5b  .0f;.        lm[
-0004ee00: 695d 2e79 7320 2020 203d 2030 2e30 663b  i].ys    = 0.0f;
-0004ee10: 0a20 2020 2020 2020 206c 6d5b 695d 2e73  .        lm[i].s
-0004ee20: 2020 2020 203d 2067 676d 6c5f 6e65 775f       = ggml_new_
-0004ee30: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-0004ee40: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
-0004ee50: 292d 3e64 6174 613b 0a20 2020 2020 2020  )->data;.       
-0004ee60: 206c 6d5b 695d 2e79 2020 2020 203d 2067   lm[i].y     = g
-0004ee70: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
-0004ee80: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
-0004ee90: 5f46 3332 2c20 6e78 292d 3e64 6174 613b  _F32, nx)->data;
-0004eea0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2065  .    }..    // e
-0004eeb0: 7661 6c75 6174 6520 7468 6520 6675 6e63  valuate the func
-0004eec0: 7469 6f6e 2076 616c 7565 2061 6e64 2069  tion value and i
-0004eed0: 7473 2067 7261 6469 656e 740a 2020 2020  ts gradient.    
-0004eee0: 7b0a 2020 2020 2020 2020 6767 6d6c 5f6f  {.        ggml_o
-0004eef0: 7074 5f73 6574 5f70 6172 616d 7328 6e70  pt_set_params(np
-0004ef00: 2c20 7073 2c20 7829 3b0a 0a20 2020 2020  , ps, x);..     
-0004ef10: 2020 2067 676d 6c5f 6772 6170 685f 7265     ggml_graph_re
-0004ef20: 7365 7420 2028 6766 293b 0a20 2020 2020  set  (gf);.     
-0004ef30: 2020 2067 676d 6c5f 7365 745f 6633 3220     ggml_set_f32 
-0004ef40: 2020 2020 2028 662d 3e67 7261 642c 2031       (f->grad, 1
-0004ef50: 2e30 6629 3b0a 2020 2020 2020 2020 6767  .0f);.        gg
-0004ef60: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
-0004ef70: 2863 7478 2c20 6762 293b 0a0a 2020 2020  (ctx, gb);..    
-0004ef80: 2020 2020 6767 6d6c 5f6f 7074 5f67 6574      ggml_opt_get
-0004ef90: 5f67 7261 6428 6e70 2c20 7073 2c20 6729  _grad(np, ps, g)
-0004efa0: 3b0a 0a20 2020 2020 2020 2066 7820 3d20  ;..        fx = 
-0004efb0: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
-0004efc0: 662c 2030 293b 0a20 2020 207d 0a0a 2020  f, 0);.    }..  
-0004efd0: 2020 6966 2028 7066 2920 7b0a 2020 2020    if (pf) {.    
-0004efe0: 2020 2020 7066 5b30 5d20 3d20 6678 3b0a      pf[0] = fx;.
-0004eff0: 2020 2020 7d0a 0a20 2020 2066 6c6f 6174      }..    float
-0004f000: 2066 785f 6265 7374 203d 2066 783b 0a0a   fx_best = fx;..
-0004f010: 2020 2020 2f2f 2073 6561 7263 6820 6469      // search di
-0004f020: 7265 6374 696f 6e20 3d20 2d67 7261 6469  rection = -gradi
-0004f030: 656e 740a 2020 2020 6767 6d6c 5f76 6563  ent.    ggml_vec
-0004f040: 5f6e 6567 5f66 3332 286e 782c 2064 2c20  _neg_f32(nx, d, 
-0004f050: 6729 3b0a 0a20 2020 202f 2f20 7c7c 787c  g);..    // ||x|
-0004f060: 7c2c 207c 7c67 7c7c 0a20 2020 2067 676d  |, ||g||.    ggm
-0004f070: 6c5f 7665 635f 6e6f 726d 5f66 3332 286e  l_vec_norm_f32(n
-0004f080: 782c 2026 786e 6f72 6d2c 2078 293b 0a20  x, &xnorm, x);. 
-0004f090: 2020 2067 676d 6c5f 7665 635f 6e6f 726d     ggml_vec_norm
-0004f0a0: 5f66 3332 286e 782c 2026 676e 6f72 6d2c  _f32(nx, &gnorm,
-0004f0b0: 2067 293b 0a0a 2020 2020 6966 2028 786e   g);..    if (xn
-0004f0c0: 6f72 6d20 3c20 312e 3066 2920 7b0a 2020  orm < 1.0f) {.  
-0004f0d0: 2020 2020 2020 786e 6f72 6d20 3d20 312e        xnorm = 1.
-0004f0e0: 3066 3b0a 2020 2020 7d0a 0a20 2020 202f  0f;.    }..    /
-0004f0f0: 2f20 616c 7265 6164 7920 6f70 7469 6d69  / already optimi
-0004f100: 7a65 640a 2020 2020 6966 2028 676e 6f72  zed.    if (gnor
-0004f110: 6d2f 786e 6f72 6d20 3c3d 2070 6172 616d  m/xnorm <= param
-0004f120: 732e 6c62 6667 732e 6570 7329 207b 0a20  s.lbfgs.eps) {. 
-0004f130: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
-0004f140: 4d4c 5f4f 5054 5f4f 4b3b 0a20 2020 207d  ML_OPT_OK;.    }
-0004f150: 0a0a 2020 2020 2f2f 2069 6e69 7469 616c  ..    // initial
-0004f160: 2073 7465 700a 2020 2020 6767 6d6c 5f76   step.    ggml_v
-0004f170: 6563 5f6e 6f72 6d5f 696e 765f 6633 3228  ec_norm_inv_f32(
-0004f180: 6e78 2c20 2673 7465 702c 2064 293b 0a0a  nx, &step, d);..
-0004f190: 2020 2020 696e 7420 6a20 2020 2020 2020      int j       
-0004f1a0: 2020 2020 2020 2020 203d 2030 3b0a 2020           = 0;.  
-0004f1b0: 2020 696e 7420 6b20 2020 2020 2020 2020    int k         
-0004f1c0: 2020 2020 2020 203d 2031 3b0a 2020 2020         = 1;.    
-0004f1d0: 696e 7420 6c73 2020 2020 2020 2020 2020  int ls          
-0004f1e0: 2020 2020 203d 2030 3b0a 2020 2020 696e       = 0;.    in
-0004f1f0: 7420 656e 6420 2020 2020 2020 2020 2020  t end           
-0004f200: 2020 203d 2030 3b0a 2020 2020 696e 7420     = 0;.    int 
-0004f210: 626f 756e 6420 2020 2020 2020 2020 2020  bound           
-0004f220: 203d 2030 3b0a 2020 2020 696e 7420 6e5f   = 0;.    int n_
-0004f230: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203d  no_improvement =
-0004f240: 2030 3b0a 0a20 2020 2066 6c6f 6174 2079   0;..    float y
-0004f250: 7320 2020 3d20 302e 3066 3b0a 2020 2020  s   = 0.0f;.    
-0004f260: 666c 6f61 7420 7979 2020 203d 2030 2e30  float yy   = 0.0
-0004f270: 663b 0a20 2020 2066 6c6f 6174 2062 6574  f;.    float bet
-0004f280: 6120 3d20 302e 3066 3b0a 0a20 2020 2077  a = 0.0f;..    w
-0004f290: 6869 6c65 2028 7472 7565 2920 7b0a 2020  hile (true) {.  
-0004f2a0: 2020 2020 2020 2f2f 2073 746f 7265 2074        // store t
-0004f2b0: 6865 2063 7572 7265 6e74 2070 6f73 6974  he current posit
-0004f2c0: 696f 6e20 616e 6420 6772 6164 6965 6e74  ion and gradient
-0004f2d0: 2076 6563 746f 7273 0a20 2020 2020 2020   vectors.       
-0004f2e0: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
-0004f2f0: 3228 6e78 2c20 7870 2c20 7829 3b0a 2020  2(nx, xp, x);.  
-0004f300: 2020 2020 2020 6767 6d6c 5f76 6563 5f63        ggml_vec_c
-0004f310: 7079 5f66 3332 286e 782c 2067 702c 2067  py_f32(nx, gp, g
-0004f320: 293b 0a0a 2020 2020 2020 2020 6c73 203d  );..        ls =
-0004f330: 206c 696e 6573 6561 7263 685f 6261 636b   linesearch_back
-0004f340: 7472 6163 6b69 6e67 2863 7478 2c20 2670  tracking(ctx, &p
-0004f350: 6172 616d 732c 206e 782c 2078 2c20 2666  arams, nx, x, &f
-0004f360: 782c 2067 2c20 642c 2026 7374 6570 2c20  x, g, d, &step, 
-0004f370: 7870 2c20 662c 2067 662c 2067 622c 206e  xp, f, gf, gb, n
-0004f380: 702c 2070 7329 3b0a 0a20 2020 2020 2020  p, ps);..       
-0004f390: 2069 6620 286c 7320 3c20 3029 207b 0a20   if (ls < 0) {. 
-0004f3a0: 2020 2020 2020 2020 2020 202f 2f20 6c69             // li
-0004f3b0: 6e65 7365 6172 6368 2066 6169 6c65 6420  nesearch failed 
-0004f3c0: 2d20 676f 2062 6163 6b20 746f 2074 6865  - go back to the
-0004f3d0: 2070 7265 7669 6f75 7320 706f 696e 7420   previous point 
-0004f3e0: 616e 6420 7265 7475 726e 0a20 2020 2020  and return.     
-0004f3f0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0004f400: 6370 795f 6633 3228 6e78 2c20 782c 2078  cpy_f32(nx, x, x
-0004f410: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
-0004f420: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-0004f430: 286e 782c 2067 2c20 6770 293b 0a0a 2020  (nx, g, gp);..  
-0004f440: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0004f450: 206c 733b 0a20 2020 2020 2020 207d 0a0a   ls;.        }..
-0004f460: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0004f470: 5f6e 6f72 6d5f 6633 3228 6e78 2c20 2678  _norm_f32(nx, &x
-0004f480: 6e6f 726d 2c20 7829 3b0a 2020 2020 2020  norm, x);.      
-0004f490: 2020 6767 6d6c 5f76 6563 5f6e 6f72 6d5f    ggml_vec_norm_
-0004f4a0: 6633 3228 6e78 2c20 2667 6e6f 726d 2c20  f32(nx, &gnorm, 
-0004f4b0: 6729 3b0a 0a20 2020 2020 2020 2047 474d  g);..        GGM
-0004f4c0: 4c5f 5052 494e 545f 4445 4255 4728 2266  L_PRINT_DEBUG("f
-0004f4d0: 203d 2025 3130 2e36 665c 6e22 2c20 6767   = %10.6f\n", gg
-0004f4e0: 6d6c 5f67 6574 5f66 3332 5f31 6428 662c  ml_get_f32_1d(f,
-0004f4f0: 2030 2929 3b0a 0a20 2020 2020 2020 2069   0));..        i
-0004f500: 6620 2878 6e6f 726d 203c 2031 2e30 2920  f (xnorm < 1.0) 
-0004f510: 7b0a 2020 2020 2020 2020 2020 2020 786e  {.            xn
-0004f520: 6f72 6d20 3d20 312e 303b 0a20 2020 2020  orm = 1.0;.     
-0004f530: 2020 207d 0a20 2020 2020 2020 2069 6620     }.        if 
-0004f540: 2867 6e6f 726d 2f78 6e6f 726d 203c 3d20  (gnorm/xnorm <= 
-0004f550: 7061 7261 6d73 2e6c 6266 6773 2e65 7073  params.lbfgs.eps
-0004f560: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004f570: 2f2f 2063 6f6e 7665 7267 6564 0a20 2020  // converged.   
-0004f580: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0004f590: 4747 4d4c 5f4f 5054 5f4f 4b3b 0a20 2020  GGML_OPT_OK;.   
-0004f5a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0004f5b0: 2f2f 2064 656c 7461 2d62 6173 6564 2063  // delta-based c
-0004f5c0: 6f6e 7665 7267 656e 6365 2074 6573 740a  onvergence test.
-0004f5d0: 2020 2020 2020 2020 6966 2028 7066 2021          if (pf !
-0004f5e0: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-0004f5f0: 2020 2020 2020 2f2f 206e 6565 6420 6174        // need at
-0004f600: 206c 6561 7374 2070 6172 616d 732e 7061   least params.pa
-0004f610: 7374 2069 7465 7261 7469 6f6e 7320 746f  st iterations to
-0004f620: 2073 7461 7274 2063 6865 636b 696e 6720   start checking 
-0004f630: 666f 7220 636f 6e76 6572 6765 6e63 650a  for convergence.
-0004f640: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0004f650: 7061 7261 6d73 2e70 6173 7420 3c3d 206b  params.past <= k
-0004f660: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004f670: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0004f680: 7261 7465 203d 2028 7066 5b6b 2570 6172  rate = (pf[k%par
-0004f690: 616d 732e 7061 7374 5d20 2d20 6678 292f  ams.past] - fx)/
-0004f6a0: 6678 3b0a 0a20 2020 2020 2020 2020 2020  fx;..           
-0004f6b0: 2020 2020 2069 6620 2866 6162 7328 7261       if (fabs(ra
-0004f6c0: 7465 2920 3c20 7061 7261 6d73 2e64 656c  te) < params.del
-0004f6d0: 7461 2920 7b0a 2020 2020 2020 2020 2020  ta) {.          
-0004f6e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0004f6f0: 2047 474d 4c5f 4f50 545f 4f4b 3b0a 2020   GGML_OPT_OK;.  
-0004f700: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0004f710: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0004f720: 2020 2020 2020 2020 2020 2070 665b 6b25             pf[k%
-0004f730: 7061 7261 6d73 2e70 6173 745d 203d 2066  params.past] = f
-0004f740: 783b 0a20 2020 2020 2020 207d 0a0a 2020  x;.        }..  
-0004f750: 2020 2020 2020 2f2f 2063 6865 636b 2066        // check f
-0004f760: 6f72 2069 6d70 726f 7665 6d65 6e74 0a20  or improvement. 
-0004f770: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
-0004f780: 732e 6d61 785f 6e6f 5f69 6d70 726f 7665  s.max_no_improve
-0004f790: 6d65 6e74 203e 2030 2920 7b0a 2020 2020  ment > 0) {.    
-0004f7a0: 2020 2020 2020 2020 6966 2028 6678 203c          if (fx <
-0004f7b0: 2066 785f 6265 7374 2920 7b0a 2020 2020   fx_best) {.    
-0004f7c0: 2020 2020 2020 2020 2020 2020 6678 5f62              fx_b
-0004f7d0: 6573 7420 3d20 6678 3b0a 2020 2020 2020  est = fx;.      
-0004f7e0: 2020 2020 2020 2020 2020 6e5f 6e6f 5f69            n_no_i
-0004f7f0: 6d70 726f 7665 6d65 6e74 203d 2030 3b0a  mprovement = 0;.
-0004f800: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-0004f810: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-0004f820: 2020 2020 206e 5f6e 6f5f 696d 7072 6f76       n_no_improv
-0004f830: 656d 656e 742b 2b3b 0a0a 2020 2020 2020  ement++;..      
-0004f840: 2020 2020 2020 2020 2020 6966 2028 6e5f            if (n_
-0004f850: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203e  no_improvement >
-0004f860: 3d20 7061 7261 6d73 2e6d 6178 5f6e 6f5f  = params.max_no_
-0004f870: 696d 7072 6f76 656d 656e 7429 207b 0a20  improvement) {. 
-0004f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f890: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
-0004f8a0: 5054 5f4f 4b3b 0a20 2020 2020 2020 2020  PT_OK;.         
-0004f8b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0004f8c0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0004f8d0: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
-0004f8e0: 7261 6d73 2e6c 6266 6773 2e6e 5f69 7465  rams.lbfgs.n_ite
-0004f8f0: 7220 213d 2030 2026 2620 7061 7261 6d73  r != 0 && params
-0004f900: 2e6c 6266 6773 2e6e 5f69 7465 7220 3c20  .lbfgs.n_iter < 
-0004f910: 6b20 2b20 3129 207b 0a20 2020 2020 2020  k + 1) {.       
-0004f920: 2020 2020 202f 2f20 7265 6163 6865 6420       // reached 
-0004f930: 7468 6520 6d61 7869 6d75 6d20 6e75 6d62  the maximum numb
-0004f940: 6572 206f 6620 6974 6572 6174 696f 6e73  er of iterations
-0004f950: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0004f960: 7572 6e20 4747 4d4c 5f4f 5054 5f44 4944  urn GGML_OPT_DID
-0004f970: 5f4e 4f54 5f43 4f4e 5645 5247 453b 0a20  _NOT_CONVERGE;. 
-0004f980: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0004f990: 2020 2f2f 2075 7064 6174 6520 7665 6374    // update vect
-0004f9a0: 6f72 7320 7320 616e 6420 793a 0a20 2020  ors s and y:.   
-0004f9b0: 2020 2020 202f 2f20 2020 735f 7b6b 2b31       //   s_{k+1
-0004f9c0: 7d20 3d20 785f 7b6b 2b31 7d20 2d20 785f  } = x_{k+1} - x_
-0004f9d0: 7b6b 7d20 3d20 5c73 7465 7020 2a20 645f  {k} = \step * d_
-0004f9e0: 7b6b 7d2e 0a20 2020 2020 2020 202f 2f20  {k}..        // 
-0004f9f0: 2020 795f 7b6b 2b31 7d20 3d20 675f 7b6b    y_{k+1} = g_{k
-0004fa00: 2b31 7d20 2d20 675f 7b6b 7d2e 0a20 2020  +1} - g_{k}..   
-0004fa10: 2020 2020 202f 2f0a 2020 2020 2020 2020       //.        
-0004fa20: 6767 6d6c 5f76 6563 5f73 7562 5f66 3332  ggml_vec_sub_f32
-0004fa30: 286e 782c 206c 6d5b 656e 645d 2e73 2c20  (nx, lm[end].s, 
-0004fa40: 782c 2078 7029 3b0a 2020 2020 2020 2020  x, xp);.        
-0004fa50: 6767 6d6c 5f76 6563 5f73 7562 5f66 3332  ggml_vec_sub_f32
-0004fa60: 286e 782c 206c 6d5b 656e 645d 2e79 2c20  (nx, lm[end].y, 
-0004fa70: 672c 2067 7029 3b0a 0a20 2020 2020 2020  g, gp);..       
-0004fa80: 202f 2f20 636f 6d70 7574 6520 7363 616c   // compute scal
-0004fa90: 6172 7320 7973 2061 6e64 2079 793a 0a20  ars ys and yy:. 
-0004faa0: 2020 2020 2020 202f 2f20 2020 2020 7973         //     ys
-0004fab0: 203d 2079 5e74 205c 6364 6f74 2073 2020   = y^t \cdot s  
-0004fac0: 2020 2d3e 2031 202f 205c 7268 6f2e 0a20    -> 1 / \rho.. 
-0004fad0: 2020 2020 2020 202f 2f20 2020 2020 7979         //     yy
-0004fae0: 203d 2079 5e74 205c 6364 6f74 2079 2e0a   = y^t \cdot y..
-0004faf0: 2020 2020 2020 2020 2f2f 0a20 2020 2020          //.     
-0004fb00: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
-0004fb10: 6633 3228 6e78 2c20 2679 732c 206c 6d5b  f32(nx, &ys, lm[
-0004fb20: 656e 645d 2e79 2c20 6c6d 5b65 6e64 5d2e  end].y, lm[end].
-0004fb30: 7329 3b0a 2020 2020 2020 2020 6767 6d6c  s);.        ggml
-0004fb40: 5f76 6563 5f64 6f74 5f66 3332 286e 782c  _vec_dot_f32(nx,
-0004fb50: 2026 7979 2c20 6c6d 5b65 6e64 5d2e 792c   &yy, lm[end].y,
-0004fb60: 206c 6d5b 656e 645d 2e79 293b 0a0a 2020   lm[end].y);..  
-0004fb70: 2020 2020 2020 6c6d 5b65 6e64 5d2e 7973        lm[end].ys
-0004fb80: 203d 2079 733b 0a0a 2020 2020 2020 2020   = ys;..        
-0004fb90: 2f2f 2066 696e 6420 6e65 7720 7365 6172  // find new sear
-0004fba0: 6368 2064 6972 6563 7469 6f6e 0a20 2020  ch direction.   
-0004fbb0: 2020 2020 202f 2f20 2020 7265 663a 2068       //   ref: h
-0004fbc0: 7474 7073 3a2f 2f65 6e2e 7769 6b69 7065  ttps://en.wikipe
-0004fbd0: 6469 612e 6f72 672f 7769 6b69 2f4c 696d  dia.org/wiki/Lim
-0004fbe0: 6974 6564 2d6d 656d 6f72 795f 4246 4753  ited-memory_BFGS
-0004fbf0: 0a0a 2020 2020 2020 2020 626f 756e 6420  ..        bound 
-0004fc00: 3d20 286d 203c 3d20 6b29 203f 206d 203a  = (m <= k) ? m :
-0004fc10: 206b 3b0a 2020 2020 2020 2020 6b2b 2b3b   k;.        k++;
-0004fc20: 0a20 2020 2020 2020 2065 6e64 203d 2028  .        end = (
-0004fc30: 656e 6420 2b20 3129 256d 3b0a 0a20 2020  end + 1)%m;..   
-0004fc40: 2020 2020 202f 2f20 696e 6974 6961 6c69       // initiali
-0004fc50: 7a65 2073 6561 7263 6820 6469 7265 6374  ze search direct
-0004fc60: 696f 6e20 7769 7468 202d 670a 2020 2020  ion with -g.    
-0004fc70: 2020 2020 6767 6d6c 5f76 6563 5f6e 6567      ggml_vec_neg
-0004fc80: 5f66 3332 286e 782c 2064 2c20 6729 3b0a  _f32(nx, d, g);.
-0004fc90: 0a20 2020 2020 2020 206a 203d 2065 6e64  .        j = end
-0004fca0: 3b0a 2020 2020 2020 2020 666f 7220 2869  ;.        for (i
-0004fcb0: 6e74 2069 203d 2030 3b20 6920 3c20 626f  nt i = 0; i < bo
-0004fcc0: 756e 643b 202b 2b69 2920 7b0a 2020 2020  und; ++i) {.    
-0004fcd0: 2020 2020 2020 2020 6a20 3d20 286a 202b          j = (j +
-0004fce0: 206d 202d 2031 2920 2520 6d3b 0a20 2020   m - 1) % m;.   
-0004fcf0: 2020 2020 2020 2020 202f 2f20 5c61 6c70           // \alp
-0004fd00: 6861 5f7b 6a7d 203d 205c 7268 6f5f 7b6a  ha_{j} = \rho_{j
-0004fd10: 7d20 735e 7b74 7d5f 7b6a 7d20 5c63 646f  } s^{t}_{j} \cdo
-0004fd20: 7420 715f 7b6b 2b31 7d0a 2020 2020 2020  t q_{k+1}.      
-0004fd30: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-0004fd40: 6f74 5f66 3332 286e 782c 2026 6c6d 5b6a  ot_f32(nx, &lm[j
-0004fd50: 5d2e 616c 7068 612c 206c 6d5b 6a5d 2e73  ].alpha, lm[j].s
-0004fd60: 2c20 6429 3b0a 2020 2020 2020 2020 2020  , d);.          
-0004fd70: 2020 6c6d 5b6a 5d2e 616c 7068 6120 2f3d    lm[j].alpha /=
-0004fd80: 206c 6d5b 6a5d 2e79 733b 0a20 2020 2020   lm[j].ys;.     
-0004fd90: 2020 2020 2020 202f 2f20 715f 7b69 7d20         // q_{i} 
-0004fda0: 3d20 715f 7b69 2b31 7d20 2d20 5c61 6c70  = q_{i+1} - \alp
-0004fdb0: 6861 5f7b 697d 2079 5f7b 697d 0a20 2020  ha_{i} y_{i}.   
-0004fdc0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0004fdd0: 635f 6d61 645f 6633 3228 6e78 2c20 642c  c_mad_f32(nx, d,
-0004fde0: 206c 6d5b 6a5d 2e79 2c20 2d6c 6d5b 6a5d   lm[j].y, -lm[j]
-0004fdf0: 2e61 6c70 6861 293b 0a20 2020 2020 2020  .alpha);.       
-0004fe00: 207d 0a0a 2020 2020 2020 2020 6767 6d6c   }..        ggml
-0004fe10: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
-0004fe20: 782c 2064 2c20 7973 2f79 7929 3b0a 0a20  x, d, ys/yy);.. 
-0004fe30: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0004fe40: 6920 3d20 303b 2069 203c 2062 6f75 6e64  i = 0; i < bound
-0004fe50: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-0004fe60: 2020 2020 202f 2f20 5c62 6574 615f 7b6a       // \beta_{j
-0004fe70: 7d20 3d20 5c72 686f 5f7b 6a7d 2079 5e74  } = \rho_{j} y^t
-0004fe80: 5f7b 6a7d 205c 6364 6f74 205c 6761 6d6d  _{j} \cdot \gamm
-0004fe90: 615f 7b69 7d0a 2020 2020 2020 2020 2020  a_{i}.          
-0004fea0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
-0004feb0: 3332 286e 782c 2026 6265 7461 2c20 6c6d  32(nx, &beta, lm
-0004fec0: 5b6a 5d2e 792c 2064 293b 0a20 2020 2020  [j].y, d);.     
-0004fed0: 2020 2020 2020 2062 6574 6120 2f3d 206c         beta /= l
-0004fee0: 6d5b 6a5d 2e79 733b 0a20 2020 2020 2020  m[j].ys;.       
-0004fef0: 2020 2020 202f 2f20 5c67 616d 6d61 5f7b       // \gamma_{
-0004ff00: 692b 317d 203d 205c 6761 6d6d 615f 7b69  i+1} = \gamma_{i
-0004ff10: 7d20 2b20 285c 616c 7068 615f 7b6a 7d20  } + (\alpha_{j} 
-0004ff20: 2d20 5c62 6574 615f 7b6a 7d29 2073 5f7b  - \beta_{j}) s_{
-0004ff30: 6a7d 0a20 2020 2020 2020 2020 2020 2067  j}.            g
-0004ff40: 676d 6c5f 7665 635f 6d61 645f 6633 3228  gml_vec_mad_f32(
-0004ff50: 6e78 2c20 642c 206c 6d5b 6a5d 2e73 2c20  nx, d, lm[j].s, 
-0004ff60: 6c6d 5b6a 5d2e 616c 7068 6120 2d20 6265  lm[j].alpha - be
-0004ff70: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
-0004ff80: 206a 203d 2028 6a20 2b20 3129 256d 3b0a   j = (j + 1)%m;.
-0004ff90: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0004ffa0: 2020 2073 7465 7020 3d20 312e 303b 0a20     step = 1.0;. 
-0004ffb0: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
-0004ffc0: 2047 474d 4c5f 4f50 545f 4449 445f 4e4f   GGML_OPT_DID_NO
-0004ffd0: 545f 434f 4e56 4552 4745 3b0a 7d0a 0a73  T_CONVERGE;.}..s
-0004ffe0: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
-0004fff0: 6172 616d 7320 6767 6d6c 5f6f 7074 5f64  arams ggml_opt_d
-00050000: 6566 6175 6c74 5f70 6172 616d 7328 656e  efault_params(en
-00050010: 756d 2067 676d 6c5f 6f70 745f 7479 7065  um ggml_opt_type
-00050020: 2074 7970 6529 207b 0a20 2020 2073 7472   type) {.    str
-00050030: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
-00050040: 616d 7320 7265 7375 6c74 3b0a 0a20 2020  ams result;..   
-00050050: 2073 7769 7463 6820 2874 7970 6529 207b   switch (type) {
-00050060: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00050070: 4d4c 5f4f 5054 5f41 4441 4d3a 0a20 2020  ML_OPT_ADAM:.   
-00050080: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00050090: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-000500a0: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
-000500b0: 5f6f 7074 5f70 6172 616d 7329 207b 0a20  _opt_params) {. 
-000500c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000500d0: 2020 202e 7479 7065 2020 2020 2020 3d20     .type      = 
-000500e0: 4747 4d4c 5f4f 5054 5f41 4441 4d2c 0a20  GGML_OPT_ADAM,. 
-000500f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050100: 2020 202e 6e5f 7468 7265 6164 7320 3d20     .n_threads = 
-00050110: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00050120: 2020 2020 2020 202e 7061 7374 2020 2020         .past    
-00050130: 2020 3d20 302c 0a20 2020 2020 2020 2020    = 0,.         
-00050140: 2020 2020 2020 2020 2020 202e 6465 6c74             .delt
-00050150: 6120 2020 2020 3d20 3165 2d35 662c 0a0a  a     = 1e-5f,..
-00050160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050170: 2020 2020 2e6d 6178 5f6e 6f5f 696d 7072      .max_no_impr
-00050180: 6f76 656d 656e 7420 3d20 3130 302c 0a0a  ovement = 100,..
-00050190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000501a0: 2020 2020 2e70 7269 6e74 5f66 6f72 7761      .print_forwa
-000501b0: 7264 5f67 7261 7068 2020 3d20 7472 7565  rd_graph  = true
-000501c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000501d0: 2020 2020 2020 2e70 7269 6e74 5f62 6163        .print_bac
-000501e0: 6b77 6172 645f 6772 6170 6820 3d20 7472  kward_graph = tr
-000501f0: 7565 2c0a 0a20 2020 2020 2020 2020 2020  ue,..           
-00050200: 2020 2020 2020 2020 202e 6164 616d 203d           .adam =
-00050210: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00050220: 2020 2020 2020 2020 2020 202e 6e5f 6974             .n_it
-00050230: 6572 203d 2031 3030 3030 2c0a 2020 2020  er = 10000,.    
-00050240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050250: 2020 2020 2e61 6c70 6861 2020 3d20 302e      .alpha  = 0.
-00050260: 3030 3166 2c0a 2020 2020 2020 2020 2020  001f,.          
-00050270: 2020 2020 2020 2020 2020 2020 2020 2e62                .b
-00050280: 6574 6131 2020 3d20 302e 3966 2c0a 2020  eta1  = 0.9f,.  
-00050290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000502a0: 2020 2020 2020 2e62 6574 6132 2020 3d20        .beta2  = 
-000502b0: 302e 3939 3966 2c0a 2020 2020 2020 2020  0.999f,.        
-000502c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000502d0: 2e65 7073 2020 2020 3d20 3165 2d38 662c  .eps    = 1e-8f,
-000502e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000502f0: 2020 2020 2020 2020 202e 6570 735f 6620           .eps_f 
-00050300: 203d 2031 652d 3566 2c0a 2020 2020 2020   = 1e-5f,.      
-00050310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050320: 2020 2e65 7073 5f67 2020 3d20 3165 2d33    .eps_g  = 1e-3
-00050330: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
-00050340: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00050350: 2020 2020 2020 2020 2020 7d3b 0a20 2020            };.   
-00050360: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00050370: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00050380: 474d 4c5f 4f50 545f 4c42 4647 533a 0a20  GML_OPT_LBFGS:. 
-00050390: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000503a0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-000503b0: 756c 7420 3d20 2873 7472 7563 7420 6767  ult = (struct gg
-000503c0: 6d6c 5f6f 7074 5f70 6172 616d 7329 207b  ml_opt_params) {
-000503d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000503e0: 2020 2020 202e 7479 7065 2020 2020 2020       .type      
-000503f0: 3d20 4747 4d4c 5f4f 5054 5f4c 4246 4753  = GGML_OPT_LBFGS
-00050400: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00050410: 2020 2020 2020 2e6e 5f74 6872 6561 6473        .n_threads
-00050420: 203d 2031 2c0a 2020 2020 2020 2020 2020   = 1,.          
-00050430: 2020 2020 2020 2020 2020 2e70 6173 7420            .past 
-00050440: 2020 2020 203d 2030 2c0a 2020 2020 2020       = 0,.      
-00050450: 2020 2020 2020 2020 2020 2020 2020 2e64                .d
-00050460: 656c 7461 2020 2020 203d 2031 652d 3566  elta     = 1e-5f
-00050470: 2c0a 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00050480: 2020 2020 2020 202e 6d61 785f 6e6f 5f69         .max_no_i
-00050490: 6d70 726f 7665 6d65 6e74 203d 2030 2c0a  mprovement = 0,.
-000504a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000504b0: 2020 2020 202e 7072 696e 745f 666f 7277       .print_forw
-000504c0: 6172 645f 6772 6170 6820 203d 2074 7275  ard_graph  = tru
-000504d0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000504e0: 2020 2020 2020 202e 7072 696e 745f 6261         .print_ba
-000504f0: 636b 7761 7264 5f67 7261 7068 203d 2074  ckward_graph = t
-00050500: 7275 652c 0a0a 2020 2020 2020 2020 2020  rue,..          
-00050510: 2020 2020 2020 2020 2020 2e6c 6266 6773            .lbfgs
-00050520: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00050530: 2020 2020 2020 2020 2020 2020 202e 6d20               .m 
-00050540: 2020 2020 2020 2020 2020 2020 203d 2036               = 6
-00050550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00050560: 2020 2020 2020 2020 2020 2e6e 5f69 7465            .n_ite
-00050570: 7220 2020 2020 2020 2020 3d20 3130 302c  r         = 100,
-00050580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050590: 2020 2020 2020 2020 202e 6d61 785f 6c69           .max_li
-000505a0: 6e65 7365 6172 6368 203d 2032 302c 0a0a  nesearch = 20,..
-000505b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000505c0: 2020 2020 2020 2020 2e65 7073 2020 2020          .eps    
-000505d0: 2020 3d20 3165 2d35 662c 0a20 2020 2020    = 1e-5f,.     
-000505e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000505f0: 2020 202e 6674 6f6c 2020 2020 203d 2031     .ftol     = 1
-00050600: 652d 3466 2c0a 2020 2020 2020 2020 2020  e-4f,.          
-00050610: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
-00050620: 6f6c 6665 2020 2020 3d20 302e 3966 2c0a  olfe    = 0.9f,.
-00050630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050640: 2020 2020 2020 2020 2e6d 696e 5f73 7465          .min_ste
-00050650: 7020 3d20 3165 2d32 3066 2c0a 2020 2020  p = 1e-20f,.    
-00050660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050670: 2020 2020 2e6d 6178 5f73 7465 7020 3d20      .max_step = 
-00050680: 3165 2b32 3066 2c0a 0a20 2020 2020 2020  1e+20f,..       
-00050690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000506a0: 202e 6c69 6e65 7365 6172 6368 203d 2047   .linesearch = G
-000506b0: 474d 4c5f 4c49 4e45 5345 4152 4348 5f44  GML_LINESEARCH_D
-000506c0: 4546 4155 4c54 2c0a 2020 2020 2020 2020  EFAULT,.        
-000506d0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-000506e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000506f0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00050700: 6272 6561 6b3b 0a20 2020 207d 0a0a 2020  break;.    }..  
-00050710: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-00050720: 0a7d 0a0a 656e 756d 2067 676d 6c5f 6f70  .}..enum ggml_op
-00050730: 745f 7265 7375 6c74 2067 676d 6c5f 6f70  t_result ggml_op
-00050740: 7428 0a20 2020 2020 2020 2073 7472 7563  t(.        struc
-00050750: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00050760: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-00050770: 7275 6374 2067 676d 6c5f 6f70 745f 7061  ruct ggml_opt_pa
-00050780: 7261 6d73 2070 6172 616d 732c 0a20 2020  rams params,.   
-00050790: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000507a0: 5f74 656e 736f 7220 2a20 6629 207b 0a20  _tensor * f) {. 
-000507b0: 2020 2062 6f6f 6c20 6672 6565 5f63 7478     bool free_ctx
-000507c0: 203d 2066 616c 7365 3b0a 2020 2020 6966   = false;.    if
-000507d0: 2028 6374 7820 3d3d 204e 554c 4c29 207b   (ctx == NULL) {
-000507e0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000507f0: 6767 6d6c 5f69 6e69 745f 7061 7261 6d73  ggml_init_params
-00050800: 2070 6172 616d 735f 6374 7820 3d20 7b0a   params_ctx = {.
-00050810: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
-00050820: 5f73 697a 6520 2020 3d20 3136 2a31 3032  _size   = 16*102
-00050830: 342a 3130 3234 2c0a 2020 2020 2020 2020  4*1024,.        
-00050840: 2020 2020 2e6d 656d 5f62 7566 6665 7220      .mem_buffer 
-00050850: 3d20 4e55 4c4c 2c0a 2020 2020 2020 2020  = NULL,.        
-00050860: 7d3b 0a0a 2020 2020 2020 2020 6374 7820  };..        ctx 
-00050870: 3d20 6767 6d6c 5f69 6e69 7428 7061 7261  = ggml_init(para
-00050880: 6d73 5f63 7478 293b 0a20 2020 2020 2020  ms_ctx);.       
-00050890: 2069 6620 2863 7478 203d 3d20 4e55 4c4c   if (ctx == NULL
-000508a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000508b0: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
-000508c0: 4e4f 5f43 4f4e 5445 5854 3b0a 2020 2020  NO_CONTEXT;.    
-000508d0: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
-000508e0: 7265 655f 6374 7820 3d20 7472 7565 3b0a  ree_ctx = true;.
-000508f0: 2020 2020 7d0a 0a20 2020 2065 6e75 6d20      }..    enum 
-00050900: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
-00050910: 7265 7375 6c74 203d 2047 474d 4c5f 4f50  result = GGML_OP
-00050920: 545f 4f4b 3b0a 0a20 2020 202f 2f20 6275  T_OK;..    // bu
-00050930: 696c 6420 666f 7277 6172 6420 2b20 6261  ild forward + ba
-00050940: 636b 7761 7264 2063 6f6d 7075 7465 2067  ckward compute g
-00050950: 7261 7068 730a 2020 2020 7374 7275 6374  raphs.    struct
-00050960: 2067 676d 6c5f 6367 7261 7068 2067 6620   ggml_cgraph gf 
-00050970: 3d20 6767 6d6c 5f62 7569 6c64 5f66 6f72  = ggml_build_for
-00050980: 7761 7264 2028 6629 3b0a 2020 2020 7374  ward (f);.    st
-00050990: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
-000509a0: 2067 6220 3d20 6767 6d6c 5f62 7569 6c64   gb = ggml_build
-000509b0: 5f62 6163 6b77 6172 6428 6374 782c 2026  _backward(ctx, &
-000509c0: 6766 2c20 6661 6c73 6529 3b0a 0a20 2020  gf, false);..   
-000509d0: 2073 7769 7463 6820 2870 6172 616d 732e   switch (params.
-000509e0: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-000509f0: 6361 7365 2047 474d 4c5f 4f50 545f 4144  case GGML_OPT_AD
-00050a00: 414d 3a0a 2020 2020 2020 2020 2020 2020  AM:.            
-00050a10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00050a20: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
-00050a30: 6f70 745f 6164 616d 2863 7478 2c20 7061  opt_adam(ctx, pa
-00050a40: 7261 6d73 2c20 662c 2026 6766 2c20 2667  rams, f, &gf, &g
-00050a50: 6229 3b0a 2020 2020 2020 2020 2020 2020  b);.            
-00050a60: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00050a70: 2063 6173 6520 4747 4d4c 5f4f 5054 5f4c   case GGML_OPT_L
-00050a80: 4246 4753 3a0a 2020 2020 2020 2020 2020  BFGS:.          
-00050a90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00050aa0: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
-00050ab0: 6c5f 6f70 745f 6c62 6667 7328 6374 782c  l_opt_lbfgs(ctx,
-00050ac0: 2070 6172 616d 732c 2066 2c20 2667 662c   params, f, &gf,
-00050ad0: 2026 6762 293b 0a20 2020 2020 2020 2020   &gb);.         
-00050ae0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00050af0: 7d0a 0a20 2020 2069 6620 2870 6172 616d  }..    if (param
-00050b00: 732e 7072 696e 745f 666f 7277 6172 645f  s.print_forward_
-00050b10: 6772 6170 6829 207b 0a20 2020 2020 2020  graph) {.       
-00050b20: 2067 676d 6c5f 6772 6170 685f 7072 696e   ggml_graph_prin
-00050b30: 7420 2020 2826 6766 293b 0a20 2020 2020  t   (&gf);.     
-00050b40: 2020 2067 676d 6c5f 6772 6170 685f 6475     ggml_graph_du
-00050b50: 6d70 5f64 6f74 2826 6766 2c20 4e55 4c4c  mp_dot(&gf, NULL
-00050b60: 2c20 226f 7074 2d66 6f72 7761 7264 2e64  , "opt-forward.d
-00050b70: 6f74 2229 3b0a 2020 2020 7d0a 0a20 2020  ot");.    }..   
-00050b80: 2069 6620 2870 6172 616d 732e 7072 696e   if (params.prin
-00050b90: 745f 6261 636b 7761 7264 5f67 7261 7068  t_backward_graph
-00050ba0: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
-00050bb0: 5f67 7261 7068 5f70 7269 6e74 2020 2028  _graph_print   (
-00050bc0: 2667 6229 3b0a 2020 2020 2020 2020 6767  &gb);.        gg
-00050bd0: 6d6c 5f67 7261 7068 5f64 756d 705f 646f  ml_graph_dump_do
-00050be0: 7428 2667 622c 2026 6766 2c20 226f 7074  t(&gb, &gf, "opt
-00050bf0: 2d62 6163 6b77 6172 642e 646f 7422 293b  -backward.dot");
-00050c00: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-00050c10: 6672 6565 5f63 7478 2920 7b0a 2020 2020  free_ctx) {.    
-00050c20: 2020 2020 6767 6d6c 5f66 7265 6528 6374      ggml_free(ct
-00050c30: 7829 3b0a 2020 2020 7d0a 0a20 2020 2072  x);.    }..    r
-00050c40: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00050c50: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
-00050c60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00050c70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00050c80: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00050c90: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00050ca0: 2f0a 0a69 6e74 2067 676d 6c5f 6370 755f  /..int ggml_cpu_
-00050cb0: 6861 735f 6176 7828 766f 6964 2920 7b0a  has_avx(void) {.
-00050cc0: 2369 6620 6465 6669 6e65 6428 5f5f 4156  #if defined(__AV
-00050cd0: 585f 5f29 0a20 2020 2072 6574 7572 6e20  X__).    return 
-00050ce0: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-00050cf0: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-00050d00: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
-00050d10: 735f 6176 7832 2876 6f69 6429 207b 0a23  s_avx2(void) {.#
-00050d20: 6966 2064 6566 696e 6564 285f 5f41 5658  if defined(__AVX
-00050d30: 325f 5f29 0a20 2020 2072 6574 7572 6e20  2__).    return 
-00050d40: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-00050d50: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-00050d60: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
-00050d70: 735f 6176 7835 3132 2876 6f69 6429 207b  s_avx512(void) {
-00050d80: 0a23 6966 2064 6566 696e 6564 285f 5f41  .#if defined(__A
-00050d90: 5658 3531 3246 5f5f 290a 2020 2020 7265  VX512F__).    re
-00050da0: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
-00050db0: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
-00050dc0: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
-00050dd0: 7075 5f68 6173 5f66 6d61 2876 6f69 6429  pu_has_fma(void)
-00050de0: 207b 0a23 6966 2064 6566 696e 6564 285f   {.#if defined(_
-00050df0: 5f46 4d41 5f5f 290a 2020 2020 7265 7475  _FMA__).    retu
-00050e00: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
-00050e10: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
-00050e20: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
-00050e30: 5f68 6173 5f6e 656f 6e28 766f 6964 2920  _has_neon(void) 
-00050e40: 7b0a 2369 6620 6465 6669 6e65 6428 5f5f  {.#if defined(__
-00050e50: 4152 4d5f 4e45 4f4e 290a 2020 2020 7265  ARM_NEON).    re
-00050e60: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
-00050e70: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
-00050e80: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
-00050e90: 7075 5f68 6173 5f61 726d 5f66 6d61 2876  pu_has_arm_fma(v
-00050ea0: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
-00050eb0: 6564 285f 5f41 524d 5f46 4541 5455 5245  ed(__ARM_FEATURE
-00050ec0: 5f46 4d41 290a 2020 2020 7265 7475 726e  _FMA).    return
-00050ed0: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
-00050ee0: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
-00050ef0: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
-00050f00: 6173 5f66 3136 6328 766f 6964 2920 7b0a  as_f16c(void) {.
-00050f10: 2369 6620 6465 6669 6e65 6428 5f5f 4631  #if defined(__F1
-00050f20: 3643 5f5f 290a 2020 2020 7265 7475 726e  6C__).    return
-00050f30: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
-00050f40: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
-00050f50: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
-00050f60: 6173 5f66 7031 365f 7661 2876 6f69 6429  as_fp16_va(void)
-00050f70: 207b 0a23 6966 2064 6566 696e 6564 285f   {.#if defined(_
-00050f80: 5f41 524d 5f46 4541 5455 5245 5f46 5031  _ARM_FEATURE_FP1
-00050f90: 365f 5645 4354 4f52 5f41 5249 5448 4d45  6_VECTOR_ARITHME
-00050fa0: 5449 4329 0a20 2020 2072 6574 7572 6e20  TIC).    return 
-00050fb0: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-00050fc0: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-00050fd0: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
-00050fe0: 735f 7761 736d 5f73 696d 6428 766f 6964  s_wasm_simd(void
-00050ff0: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
-00051000: 5f5f 7761 736d 5f73 696d 6431 3238 5f5f  __wasm_simd128__
-00051010: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
-00051020: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
-00051030: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
-00051040: 7420 6767 6d6c 5f63 7075 5f68 6173 5f62  t ggml_cpu_has_b
-00051050: 6c61 7328 766f 6964 2920 7b0a 2369 6620  las(void) {.#if 
-00051060: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-00051070: 5f41 4343 454c 4552 4154 4529 207c 7c20  _ACCELERATE) || 
-00051080: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-00051090: 5f4f 5045 4e42 4c41 5329 0a20 2020 2072  _OPENBLAS).    r
-000510a0: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
-000510b0: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
-000510c0: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
-000510d0: 6370 755f 6861 735f 7373 6533 2876 6f69  cpu_has_sse3(voi
-000510e0: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
-000510f0: 285f 5f53 5345 335f 5f29 0a20 2020 2072  (__SSE3__).    r
-00051100: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
-00051110: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
-00051120: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
-00051130: 6370 755f 6861 735f 7673 7828 766f 6964  cpu_has_vsx(void
-00051140: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
-00051150: 5f5f 504f 5745 5239 5f56 4543 544f 525f  __POWER9_VECTOR_
-00051160: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
-00051170: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
-00051180: 6e20 303b 0a23 656e 6469 660a 7d0a 0a2f  n 0;.#endif.}../
-00051190: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000511a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000511b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000511c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000511d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
+000481e0: 2020 2020 7061 7265 6e74 203f 2022 656d      parent ? "em
+000481f0: 7074 7922 203a 2022 7665 6522 2c0a 2020  pty" : "vee",.  
+00048200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048210: 2020 7061 7265 6e74 203f 2022 6461 7368    parent ? "dash
+00048220: 6564 2220 3a20 2273 6f6c 6964 2229 3b0a  ed" : "solid");.
+00048230: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00048240: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
+00048250: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
+00048260: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00048270: 736f 7220 2a20 7061 7265 6e74 3120 3d20  sor * parent1 = 
+00048280: 6767 6d6c 5f67 7261 7068 5f67 6574 5f70  ggml_graph_get_p
+00048290: 6172 656e 7428 6762 2c20 6e6f 6465 2d3e  arent(gb, node->
+000482a0: 7372 6331 293b 0a0a 2020 2020 2020 2020  src1);..        
+000482b0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+000482c0: 2220 205c 2225 705c 223a 2573 202d 3e20  "  \"%p\":%s -> 
+000482d0: 5c22 2570 5c22 3a25 7320 5b20 6172 726f  \"%p\":%s [ arro
+000482e0: 7768 6561 6420 3d20 2573 3b20 7374 796c  whead = %s; styl
+000482f0: 6520 3d20 2573 3b20 6c61 6265 6c20 3d20  e = %s; label = 
+00048300: 5c22 795c 223b 205d 5c6e 222c 0a20 2020  \"y\"; ]\n",.   
+00048310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048320: 2070 6172 656e 7431 203f 2028 766f 6964   parent1 ? (void
+00048330: 202a 2920 7061 7265 6e74 3120 3a20 2876   *) parent1 : (v
+00048340: 6f69 6420 2a29 206e 6f64 652d 3e73 7263  oid *) node->src
+00048350: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+00048360: 2020 2020 2020 2070 6172 656e 7431 203f         parent1 ?
+00048370: 2022 6722 203a 2022 7822 2c0a 2020 2020   "g" : "x",.    
+00048380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048390: 7061 7265 6e74 203f 2028 766f 6964 202a  parent ? (void *
+000483a0: 2920 7061 7265 6e74 203a 2028 766f 6964  ) parent : (void
+000483b0: 202a 2920 6e6f 6465 2c0a 2020 2020 2020   *) node,.      
+000483c0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000483d0: 7265 6e74 203f 2022 6722 203a 2022 7822  rent ? "g" : "x"
+000483e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000483f0: 2020 2020 2020 7061 7265 6e74 203f 2022        parent ? "
+00048400: 656d 7074 7922 203a 2022 7665 6522 2c0a  empty" : "vee",.
+00048410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048420: 2020 2020 7061 7265 6e74 203f 2022 6461      parent ? "da
+00048430: 7368 6564 2220 3a20 2273 6f6c 6964 2229  shed" : "solid")
+00048440: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00048450: 7d0a 0a20 2020 2066 6f72 2028 696e 7420  }..    for (int 
+00048460: 6920 3d20 303b 2069 203c 2067 622d 3e6e  i = 0; i < gb->n
+00048470: 5f6c 6561 6673 3b20 692b 2b29 207b 0a20  _leafs; i++) {. 
+00048480: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00048490: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
+000484a0: 203d 2067 622d 3e6c 6561 6673 5b69 5d3b   = gb->leafs[i];
+000484b0: 0a0a 2020 2020 2020 2020 6966 2028 6e6f  ..        if (no
+000484c0: 6465 2d3e 7372 6330 2920 7b0a 2020 2020  de->src0) {.    
+000484d0: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+000484e0: 6670 2c20 2220 205c 2225 705c 223a 2573  fp, "  \"%p\":%s
+000484f0: 202d 3e20 5c22 2570 5c22 3a25 7320 5b20   -> \"%p\":%s [ 
+00048500: 6c61 6265 6c20 3d20 5c22 785c 223b 205d  label = \"x\"; ]
+00048510: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+00048520: 2020 2020 2020 2020 2028 766f 6964 202a           (void *
+00048530: 2920 6e6f 6465 2d3e 7372 6330 2c20 2278  ) node->src0, "x
+00048540: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00048550: 2020 2020 2020 2028 766f 6964 202a 2920         (void *) 
+00048560: 6e6f 6465 2c20 2278 2229 3b0a 2020 2020  node, "x");.    
+00048570: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+00048580: 6620 286e 6f64 652d 3e73 7263 3129 207b  f (node->src1) {
+00048590: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+000485a0: 696e 7466 2866 702c 2022 2020 5c22 2570  intf(fp, "  \"%p
+000485b0: 5c22 3a25 7320 2d3e 205c 2225 705c 223a  \":%s -> \"%p\":
+000485c0: 2573 205b 206c 6162 656c 203d 205c 2279  %s [ label = \"y
+000485d0: 5c22 3b20 5d5c 6e22 2c0a 2020 2020 2020  \"; ]\n",.      
+000485e0: 2020 2020 2020 2020 2020 2020 2020 2876                (v
+000485f0: 6f69 6420 2a29 206e 6f64 652d 3e73 7263  oid *) node->src
+00048600: 312c 2022 7822 2c0a 2020 2020 2020 2020  1, "x",.        
+00048610: 2020 2020 2020 2020 2020 2020 2876 6f69              (voi
+00048620: 6420 2a29 206e 6f64 652c 2022 7822 293b  d *) node, "x");
+00048630: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00048640: 0a0a 2020 2020 6670 7269 6e74 6628 6670  ..    fprintf(fp
+00048650: 2c20 227d 5c6e 2229 3b0a 0a20 2020 2066  , "}\n");..    f
+00048660: 636c 6f73 6528 6670 293b 0a0a 2020 2020  close(fp);..    
+00048670: 4747 4d4c 5f50 5249 4e54 2822 2573 3a20  GGML_PRINT("%s: 
+00048680: 646f 7420 2d54 706e 6720 2573 202d 6f20  dot -Tpng %s -o 
+00048690: 2573 2e70 6e67 2026 2620 6f70 656e 2025  %s.png && open %
+000486a0: 732e 706e 675c 6e22 2c20 5f5f 6675 6e63  s.png\n", __func
+000486b0: 5f5f 2c20 6669 6c65 6e61 6d65 2c20 6669  __, filename, fi
+000486c0: 6c65 6e61 6d65 2c20 6669 6c65 6e61 6d65  lename, filename
+000486d0: 293b 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f  );.}..//////////
+000486e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000486f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00048700: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00048710: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00048720: 2f2f 2f2f 2f2f 0a0a 7374 6174 6963 2076  //////..static v
+00048730: 6f69 6420 6767 6d6c 5f6f 7074 5f73 6574  oid ggml_opt_set
+00048740: 5f70 6172 616d 7328 696e 7420 6e70 2c20  _params(int np, 
+00048750: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00048760: 6f72 202a 2063 6f6e 7374 2070 735b 5d2c  or * const ps[],
+00048770: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+00048780: 2920 7b0a 2020 2020 696e 7420 6920 3d20  ) {.    int i = 
+00048790: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
+000487a0: 7020 3d20 303b 2070 203c 206e 703b 202b  p = 0; p < np; +
+000487b0: 2b70 2920 7b0a 2020 2020 2020 2020 636f  +p) {.        co
+000487c0: 6e73 7420 696e 7420 6e65 203d 2067 676d  nst int ne = ggm
+000487d0: 6c5f 6e65 6c65 6d65 6e74 7328 7073 5b70  l_nelements(ps[p
+000487e0: 5d29 203b 0a20 2020 2020 2020 202f 2f20  ]) ;.        // 
+000487f0: 544f 444f 3a20 6164 6420 6675 6e63 7469  TODO: add functi
+00048800: 6f6e 2074 6f20 7365 7420 7465 6e73 6f72  on to set tensor
+00048810: 2066 726f 6d20 6172 7261 790a 2020 2020   from array.    
+00048820: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+00048830: 2030 3b20 6a20 3c20 6e65 3b20 2b2b 6a29   0; j < ne; ++j)
+00048840: 207b 0a20 2020 2020 2020 2020 2020 2067   {.            g
+00048850: 676d 6c5f 7365 745f 6633 325f 3164 2870  gml_set_f32_1d(p
+00048860: 735b 705d 2c20 6a2c 2078 5b69 2b2b 5d29  s[p], j, x[i++])
+00048870: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00048880: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+00048890: 2067 676d 6c5f 6f70 745f 6765 745f 7061   ggml_opt_get_pa
+000488a0: 7261 6d73 2869 6e74 206e 702c 2073 7472  rams(int np, str
+000488b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000488c0: 2a20 636f 6e73 7420 7073 5b5d 2c20 666c  * const ps[], fl
+000488d0: 6f61 7420 2a20 7829 207b 0a20 2020 2069  oat * x) {.    i
+000488e0: 6e74 2069 203d 2030 3b0a 2020 2020 666f  nt i = 0;.    fo
+000488f0: 7220 2869 6e74 2070 203d 2030 3b20 7020  r (int p = 0; p 
+00048900: 3c20 6e70 3b20 2b2b 7029 207b 0a20 2020  < np; ++p) {.   
+00048910: 2020 2020 2063 6f6e 7374 2069 6e74 206e       const int n
+00048920: 6520 3d20 6767 6d6c 5f6e 656c 656d 656e  e = ggml_nelemen
+00048930: 7473 2870 735b 705d 2920 3b0a 2020 2020  ts(ps[p]) ;.    
+00048940: 2020 2020 2f2f 2054 4f44 4f3a 2061 6464      // TODO: add
+00048950: 2066 756e 6374 696f 6e20 746f 2067 6574   function to get
+00048960: 2061 6c6c 2065 6c65 6d65 6e74 7320 6174   all elements at
+00048970: 206f 6e63 650a 2020 2020 2020 2020 666f   once.        fo
+00048980: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+00048990: 3c20 6e65 3b20 2b2b 6a29 207b 0a20 2020  < ne; ++j) {.   
+000489a0: 2020 2020 2020 2020 2078 5b69 2b2b 5d20           x[i++] 
+000489b0: 3d20 6767 6d6c 5f67 6574 5f66 3332 5f31  = ggml_get_f32_1
+000489c0: 6428 7073 5b70 5d2c 206a 293b 0a20 2020  d(ps[p], j);.   
+000489d0: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+000489e0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+000489f0: 5f6f 7074 5f67 6574 5f67 7261 6428 696e  _opt_get_grad(in
+00048a00: 7420 6e70 2c20 7374 7275 6374 2067 676d  t np, struct ggm
+00048a10: 6c5f 7465 6e73 6f72 202a 2063 6f6e 7374  l_tensor * const
+00048a20: 2070 735b 5d2c 2066 6c6f 6174 202a 2067   ps[], float * g
+00048a30: 2920 7b0a 2020 2020 696e 7420 6920 3d20  ) {.    int i = 
+00048a40: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
+00048a50: 7020 3d20 303b 2070 203c 206e 703b 202b  p = 0; p < np; +
+00048a60: 2b70 2920 7b0a 2020 2020 2020 2020 636f  +p) {.        co
+00048a70: 6e73 7420 696e 7420 6e65 203d 2067 676d  nst int ne = ggm
+00048a80: 6c5f 6e65 6c65 6d65 6e74 7328 7073 5b70  l_nelements(ps[p
+00048a90: 5d29 203b 0a20 2020 2020 2020 202f 2f20  ]) ;.        // 
+00048aa0: 544f 444f 3a20 6164 6420 6675 6e63 7469  TODO: add functi
+00048ab0: 6f6e 2074 6f20 6765 7420 616c 6c20 656c  on to get all el
+00048ac0: 656d 656e 7473 2061 7420 6f6e 6365 0a20  ements at once. 
+00048ad0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00048ae0: 6a20 3d20 303b 206a 203c 206e 653b 202b  j = 0; j < ne; +
+00048af0: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+00048b00: 2020 675b 692b 2b5d 203d 2067 676d 6c5f    g[i++] = ggml_
+00048b10: 6765 745f 6633 325f 3164 2870 735b 705d  get_f32_1d(ps[p]
+00048b20: 2d3e 6772 6164 2c20 6a29 3b0a 2020 2020  ->grad, j);.    
+00048b30: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a2f      }.    }.}../
+00048b40: 2f0a 2f2f 2041 4441 4d0a 2f2f 0a2f 2f20  /.// ADAM.//.// 
+00048b50: 2020 7265 663a 2068 7474 7073 3a2f 2f61    ref: https://a
+00048b60: 7278 6976 2e6f 7267 2f70 6466 2f31 3431  rxiv.org/pdf/141
+00048b70: 322e 3639 3830 2e70 6466 0a2f 2f0a 0a73  2.6980.pdf.//..s
+00048b80: 7461 7469 6320 656e 756d 2067 676d 6c5f  tatic enum ggml_
+00048b90: 6f70 745f 7265 7375 6c74 2067 676d 6c5f  opt_result ggml_
+00048ba0: 6f70 745f 6164 616d 280a 2020 2020 2020  opt_adam(.      
+00048bb0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+00048bc0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+00048bd0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00048be0: 5f6f 7074 5f70 6172 616d 7320 7061 7261  _opt_params para
+00048bf0: 6d73 2c0a 2020 2020 2020 2020 7374 7275  ms,.        stru
+00048c00: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00048c10: 2066 2c0a 2020 2020 2020 2020 7374 7275   f,.        stru
+00048c20: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+00048c30: 2067 662c 0a20 2020 2020 2020 2073 7472   gf,.        str
+00048c40: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+00048c50: 2a20 6762 2920 7b0a 2020 2020 4747 4d4c  * gb) {.    GGML
+00048c60: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+00048c70: 7363 616c 6172 2866 2929 3b0a 0a20 2020  scalar(f));..   
+00048c80: 2067 662d 3e6e 5f74 6872 6561 6473 203d   gf->n_threads =
+00048c90: 2070 6172 616d 732e 6e5f 7468 7265 6164   params.n_thread
+00048ca0: 733b 0a20 2020 2067 622d 3e6e 5f74 6872  s;.    gb->n_thr
+00048cb0: 6561 6473 203d 2070 6172 616d 732e 6e5f  eads = params.n_
+00048cc0: 7468 7265 6164 733b 0a0a 2020 2020 2f2f  threads;..    //
+00048cd0: 2074 6865 7365 2077 696c 6c20 7374 6f72   these will stor
+00048ce0: 6520 7468 6520 7061 7261 6d65 7465 7273  e the parameters
+00048cf0: 2077 6520 7761 6e74 2074 6f20 6f70 7469   we want to opti
+00048d00: 6d69 7a65 0a20 2020 2073 7472 7563 7420  mize.    struct 
+00048d10: 6767 6d6c 5f74 656e 736f 7220 2a20 7073  ggml_tensor * ps
+00048d20: 5b47 474d 4c5f 4d41 585f 5041 5241 4d53  [GGML_MAX_PARAMS
+00048d30: 5d3b 0a0a 2020 2020 696e 7420 6e70 203d  ];..    int np =
+00048d40: 2030 3b0a 2020 2020 696e 7420 6e78 203d   0;.    int nx =
+00048d50: 2030 3b0a 2020 2020 666f 7220 2869 6e74   0;.    for (int
+00048d60: 2069 203d 2030 3b20 6920 3c20 6766 2d3e   i = 0; i < gf->
+00048d70: 6e5f 6e6f 6465 733b 202b 2b69 2920 7b0a  n_nodes; ++i) {.
+00048d80: 2020 2020 2020 2020 6966 2028 6766 2d3e          if (gf->
+00048d90: 6e6f 6465 735b 695d 2d3e 6973 5f70 6172  nodes[i]->is_par
+00048da0: 616d 2920 7b0a 2020 2020 2020 2020 2020  am) {.          
+00048db0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+00048dc0: 5547 2822 666f 756e 6420 7061 7261 6d20  UG("found param 
+00048dd0: 2564 3a20 6772 6164 2d3e 6f70 203d 2025  %d: grad->op = %
+00048de0: 645c 6e22 2c20 6e70 2c20 6766 2d3e 6e6f  d\n", np, gf->no
+00048df0: 6465 735b 695d 2d3e 6772 6164 2d3e 6f70  des[i]->grad->op
+00048e00: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00048e10: 4747 4d4c 5f41 5353 4552 5428 6e70 203c  GGML_ASSERT(np <
+00048e20: 2047 474d 4c5f 4d41 585f 5041 5241 4d53   GGML_MAX_PARAMS
+00048e30: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00048e40: 7073 5b6e 702b 2b5d 203d 2067 662d 3e6e  ps[np++] = gf->n
+00048e50: 6f64 6573 5b69 5d3b 0a20 2020 2020 2020  odes[i];.       
+00048e60: 2020 2020 206e 7820 2b3d 2067 676d 6c5f       nx += ggml_
+00048e70: 6e65 6c65 6d65 6e74 7328 6766 2d3e 6e6f  nelements(gf->no
+00048e80: 6465 735b 695d 293b 0a20 2020 2020 2020  des[i]);.       
+00048e90: 207d 0a20 2020 207d 0a0a 2020 2020 2f2f   }.    }..    //
+00048ea0: 2063 6f6e 7374 616e 7473 0a20 2020 2063   constants.    c
+00048eb0: 6f6e 7374 2066 6c6f 6174 2061 6c70 6861  onst float alpha
+00048ec0: 203d 2070 6172 616d 732e 6164 616d 2e61   = params.adam.a
+00048ed0: 6c70 6861 3b0a 2020 2020 636f 6e73 7420  lpha;.    const 
+00048ee0: 666c 6f61 7420 6265 7461 3120 3d20 7061  float beta1 = pa
+00048ef0: 7261 6d73 2e61 6461 6d2e 6265 7461 313b  rams.adam.beta1;
+00048f00: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
+00048f10: 2062 6574 6132 203d 2070 6172 616d 732e   beta2 = params.
+00048f20: 6164 616d 2e62 6574 6132 3b0a 2020 2020  adam.beta2;.    
+00048f30: 636f 6e73 7420 666c 6f61 7420 6570 7320  const float eps 
+00048f40: 2020 3d20 7061 7261 6d73 2e61 6461 6d2e    = params.adam.
+00048f50: 6570 733b 0a0a 2020 2020 666c 6f61 7420  eps;..    float 
+00048f60: 2a20 7820 203d 2067 676d 6c5f 6e65 775f  * x  = ggml_new_
+00048f70: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
+00048f80: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
+00048f90: 292d 3e64 6174 613b 202f 2f20 7669 6577  )->data; // view
+00048fa0: 206f 6620 7468 6520 7061 7261 6d65 7465   of the paramete
+00048fb0: 7273 0a20 2020 2066 6c6f 6174 202a 2067  rs.    float * g
+00048fc0: 3120 3d20 6767 6d6c 5f6e 6577 5f74 656e  1 = ggml_new_ten
+00048fd0: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+00048fe0: 5f54 5950 455f 4633 322c 206e 7829 2d3e  _TYPE_F32, nx)->
+00048ff0: 6461 7461 3b20 2f2f 2067 7261 6469 656e  data; // gradien
+00049000: 740a 2020 2020 666c 6f61 7420 2a20 6732  t.    float * g2
+00049010: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00049020: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+00049030: 5459 5045 5f46 3332 2c20 6e78 292d 3e64  TYPE_F32, nx)->d
+00049040: 6174 613b 202f 2f20 6772 6164 6965 6e74  ata; // gradient
+00049050: 2073 7175 6172 6564 0a20 2020 2066 6c6f   squared.    flo
+00049060: 6174 202a 206d 2020 3d20 6767 6d6c 5f6e  at * m  = ggml_n
+00049070: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
+00049080: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
+00049090: 206e 7829 2d3e 6461 7461 3b20 2f2f 2066   nx)->data; // f
+000490a0: 6972 7374 206d 6f6d 656e 740a 2020 2020  irst moment.    
+000490b0: 666c 6f61 7420 2a20 7620 203d 2067 676d  float * v  = ggm
+000490c0: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
+000490d0: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
+000490e0: 3332 2c20 6e78 292d 3e64 6174 613b 202f  32, nx)->data; /
+000490f0: 2f20 7365 636f 6e64 206d 6f6d 656e 740a  / second moment.
+00049100: 2020 2020 666c 6f61 7420 2a20 6d68 203d      float * mh =
+00049110: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00049120: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
+00049130: 5045 5f46 3332 2c20 6e78 292d 3e64 6174  PE_F32, nx)->dat
+00049140: 613b 202f 2f20 6669 7273 7420 6d6f 6d65  a; // first mome
+00049150: 6e74 2068 6174 0a20 2020 2066 6c6f 6174  nt hat.    float
+00049160: 202a 2076 6820 3d20 6767 6d6c 5f6e 6577   * vh = ggml_new
+00049170: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+00049180: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
+00049190: 7829 2d3e 6461 7461 3b20 2f2f 2073 6563  x)->data; // sec
+000491a0: 6f6e 6420 6d6f 6d65 6e74 2068 6174 0a0a  ond moment hat..
+000491b0: 2020 2020 666c 6f61 7420 2a20 7066 203d      float * pf =
+000491c0: 2070 6172 616d 732e 7061 7374 203e 2030   params.past > 0
+000491d0: 203f 2067 676d 6c5f 6e65 775f 7465 6e73   ? ggml_new_tens
+000491e0: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+000491f0: 5459 5045 5f46 3332 2c20 7061 7261 6d73  TYPE_F32, params
+00049200: 2e70 6173 7429 2d3e 6461 7461 203a 204e  .past)->data : N
+00049210: 554c 4c3b 202f 2f20 7061 7374 2066 756e  ULL; // past fun
+00049220: 6374 696f 6e20 7661 6c75 6573 0a0a 2020  ction values..  
+00049230: 2020 2f2f 2069 6e69 7469 616c 697a 650a    // initialize.
+00049240: 2020 2020 6767 6d6c 5f76 6563 5f73 6574      ggml_vec_set
+00049250: 5f66 3332 286e 782c 206d 2c20 302e 3066  _f32(nx, m, 0.0f
+00049260: 293b 0a20 2020 2067 676d 6c5f 7665 635f  );.    ggml_vec_
+00049270: 7365 745f 6633 3228 6e78 2c20 762c 2030  set_f32(nx, v, 0
+00049280: 2e30 6629 3b0a 0a20 2020 202f 2f20 7570  .0f);..    // up
+00049290: 6461 7465 2076 6965 770a 2020 2020 6767  date view.    gg
+000492a0: 6d6c 5f6f 7074 5f67 6574 5f70 6172 616d  ml_opt_get_param
+000492b0: 7328 6e70 2c20 7073 2c20 7829 3b0a 0a20  s(np, ps, x);.. 
+000492c0: 2020 202f 2f20 636f 6d70 7574 6520 7468     // compute th
+000492d0: 6520 6675 6e63 7469 6f6e 2076 616c 7565  e function value
+000492e0: 0a20 2020 2067 676d 6c5f 6772 6170 685f  .    ggml_graph_
+000492f0: 7265 7365 7420 2028 6766 293b 0a20 2020  reset  (gf);.   
+00049300: 2067 676d 6c5f 7365 745f 6633 3220 2020   ggml_set_f32   
+00049310: 2020 2028 662d 3e67 7261 642c 2031 2e30     (f->grad, 1.0
+00049320: 6629 3b0a 2020 2020 6767 6d6c 5f67 7261  f);.    ggml_gra
+00049330: 7068 5f63 6f6d 7075 7465 2863 7478 2c20  ph_compute(ctx, 
+00049340: 6762 293b 0a0a 2020 2020 666c 6f61 7420  gb);..    float 
+00049350: 6678 5f70 7265 7620 3d20 6767 6d6c 5f67  fx_prev = ggml_g
+00049360: 6574 5f66 3332 5f31 6428 662c 2030 293b  et_f32_1d(f, 0);
+00049370: 0a20 2020 2069 6620 2870 6629 207b 0a20  .    if (pf) {. 
+00049380: 2020 2020 2020 2070 665b 305d 203d 2066         pf[0] = f
+00049390: 785f 7072 6576 3b0a 2020 2020 7d0a 0a20  x_prev;.    }.. 
+000493a0: 2020 2069 6e74 206e 5f6e 6f5f 696d 7072     int n_no_impr
+000493b0: 6f76 656d 656e 7420 3d20 303b 0a20 2020  ovement = 0;.   
+000493c0: 2066 6c6f 6174 2066 785f 6265 7374 203d   float fx_best =
+000493d0: 2066 785f 7072 6576 3b0a 0a20 2020 202f   fx_prev;..    /
+000493e0: 2f20 7275 6e20 7468 6520 6f70 7469 6d69  / run the optimi
+000493f0: 7a65 720a 2020 2020 666f 7220 2869 6e74  zer.    for (int
+00049400: 2074 203d 2030 3b20 7420 3c20 7061 7261   t = 0; t < para
+00049410: 6d73 2e61 6461 6d2e 6e5f 6974 6572 3b20  ms.adam.n_iter; 
+00049420: 2b2b 7429 207b 0a20 2020 2020 2020 2047  ++t) {.        G
+00049430: 474d 4c5f 5052 494e 545f 4445 4255 4720  GML_PRINT_DEBUG 
+00049440: 2028 223d 3d3d 2069 7465 7220 2564 203d   ("=== iter %d =
+00049450: 3d3d 5c6e 222c 2074 293b 0a0a 2020 2020  ==\n", t);..    
+00049460: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+00049470: 4542 5547 2020 2822 6620 2020 2020 203d  EBUG  ("f      =
+00049480: 2025 3130 2e36 665c 6e22 2c20 6767 6d6c   %10.6f\n", ggml
+00049490: 5f67 6574 5f66 3332 5f31 6428 662c 2030  _get_f32_1d(f, 0
+000494a0: 2929 3b0a 2020 2020 2020 2020 4747 4d4c  ));.        GGML
+000494b0: 5f50 5249 4e54 5f44 4542 5547 5f35 2822  _PRINT_DEBUG_5("
+000494c0: 6466 2f64 7830 203d 2025 3130 2e36 665c  df/dx0 = %10.6f\
+000494d0: 6e22 2c20 6767 6d6c 5f67 6574 5f66 3332  n", ggml_get_f32
+000494e0: 5f31 6428 7073 5b30 5d2d 3e67 7261 642c  _1d(ps[0]->grad,
+000494f0: 2030 2929 3b0a 2020 2020 2020 2020 4747   0));.        GG
+00049500: 4d4c 5f50 5249 4e54 5f44 4542 5547 5f35  ML_PRINT_DEBUG_5
+00049510: 2822 6466 2f64 7831 203d 2025 3130 2e36  ("df/dx1 = %10.6
+00049520: 665c 6e22 2c20 6767 6d6c 5f67 6574 5f66  f\n", ggml_get_f
+00049530: 3332 5f31 6428 7073 5b31 5d2d 3e67 7261  32_1d(ps[1]->gra
+00049540: 642c 2030 2929 3b0a 0a20 2020 2020 2020  d, 0));..       
+00049550: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00049560: 2069 203c 206e 703b 202b 2b69 2920 7b0a   i < np; ++i) {.
+00049570: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00049580: 5f50 5249 4e54 5f44 4542 5547 2822 7061  _PRINT_DEBUG("pa
+00049590: 7261 6d20 2564 3a20 2531 302e 3666 2c20  ram %d: %10.6f, 
+000495a0: 6720 3d20 2531 302e 3666 5c6e 222c 2069  g = %10.6f\n", i
+000495b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000495c0: 2020 2020 2020 6767 6d6c 5f67 6574 5f66        ggml_get_f
+000495d0: 3332 5f31 6428 7073 5b69 5d2c 2030 292c  32_1d(ps[i], 0),
+000495e0: 2067 676d 6c5f 6765 745f 6633 325f 3164   ggml_get_f32_1d
+000495f0: 2870 735b 695d 2d3e 6772 6164 2c20 3029  (ps[i]->grad, 0)
+00049600: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
+00049610: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00049620: 345f 7420 745f 7374 6172 745f 7761 6c6c  4_t t_start_wall
+00049630: 203d 2067 676d 6c5f 7469 6d65 5f75 7328   = ggml_time_us(
+00049640: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+00049650: 2069 6e74 3634 5f74 2074 5f73 7461 7274   int64_t t_start
+00049660: 5f63 7075 203d 2067 676d 6c5f 6379 636c  _cpu = ggml_cycl
+00049670: 6573 2829 3b0a 2020 2020 2020 2020 554e  es();.        UN
+00049680: 5553 4544 2874 5f73 7461 7274 5f77 616c  USED(t_start_wal
+00049690: 6c29 3b0a 2020 2020 2020 2020 554e 5553  l);.        UNUS
+000496a0: 4544 2874 5f73 7461 7274 5f63 7075 293b  ED(t_start_cpu);
+000496b0: 0a0a 2020 2020 2020 2020 7b0a 2020 2020  ..        {.    
+000496c0: 2020 2020 2020 2020 2f2f 2075 7064 6174          // updat
+000496d0: 6520 7468 6520 6772 6164 6965 6e74 0a20  e the gradient. 
+000496e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000496f0: 6f70 745f 6765 745f 6772 6164 286e 702c  opt_get_grad(np,
+00049700: 2070 732c 2067 3129 3b0a 0a20 2020 2020   ps, g1);..     
+00049710: 2020 2020 2020 202f 2f20 6d5f 7420 3d20         // m_t = 
+00049720: 6265 7461 312a 6d5f 742d 3120 2b20 2831  beta1*m_t-1 + (1
+00049730: 202d 2062 6574 6131 292a 675f 740a 2020   - beta1)*g_t.  
+00049740: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+00049750: 6563 5f73 6361 6c65 5f66 3332 286e 782c  ec_scale_f32(nx,
+00049760: 206d 2c20 6265 7461 3129 3b0a 2020 2020   m, beta1);.    
+00049770: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00049780: 5f6d 6164 5f66 3332 2020 286e 782c 206d  _mad_f32  (nx, m
+00049790: 2c20 6731 2c20 312e 3066 202d 2062 6574  , g1, 1.0f - bet
+000497a0: 6131 293b 0a0a 2020 2020 2020 2020 2020  a1);..          
+000497b0: 2020 2f2f 2067 3220 3d20 6731 5e32 0a20    // g2 = g1^2. 
+000497c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000497d0: 7665 635f 7371 725f 6633 3220 2028 6e78  vec_sqr_f32  (nx
+000497e0: 2c20 6732 2c20 6731 293b 0a0a 2020 2020  , g2, g1);..    
+000497f0: 2020 2020 2020 2020 2f2f 2076 5f74 203d          // v_t =
+00049800: 2062 6574 6132 2a76 5f74 2d31 202b 2028   beta2*v_t-1 + (
+00049810: 3120 2d20 6265 7461 3229 2a67 5f74 5e32  1 - beta2)*g_t^2
+00049820: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00049830: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+00049840: 6e78 2c20 762c 2062 6574 6132 293b 0a20  nx, v, beta2);. 
+00049850: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00049860: 7665 635f 6d61 645f 6633 3220 2028 6e78  vec_mad_f32  (nx
+00049870: 2c20 762c 2067 322c 2031 2e30 6620 2d20  , v, g2, 1.0f - 
+00049880: 6265 7461 3229 3b0a 0a20 2020 2020 2020  beta2);..       
+00049890: 2020 2020 202f 2f20 6d5e 6861 7420 3d20       // m^hat = 
+000498a0: 6d5f 7420 2f20 2831 202d 2062 6574 6131  m_t / (1 - beta1
+000498b0: 5e74 290a 2020 2020 2020 2020 2020 2020  ^t).            
+000498c0: 2f2f 2076 5e68 6174 203d 2076 5f74 202f  // v^hat = v_t /
+000498d0: 2028 3120 2d20 6265 7461 325e 7429 0a20   (1 - beta2^t). 
+000498e0: 2020 2020 2020 2020 2020 202f 2f20 785f             // x_
+000498f0: 7420 3d20 785f 742d 3120 2d20 616c 7068  t = x_t-1 - alph
+00049900: 612a 6d5e 6861 742f 2873 7172 7428 765e  a*m^hat/(sqrt(v^
+00049910: 6861 7429 202b 2065 7073 290a 2020 2020  hat) + eps).    
+00049920: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00049930: 5f63 7079 5f66 3332 2020 286e 782c 206d  _cpy_f32  (nx, m
+00049940: 682c 206d 293b 0a20 2020 2020 2020 2020  h, m);.         
+00049950: 2020 2067 676d 6c5f 7665 635f 6370 795f     ggml_vec_cpy_
+00049960: 6633 3220 2028 6e78 2c20 7668 2c20 7629  f32  (nx, vh, v)
+00049970: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
+00049980: 676d 6c5f 7665 635f 7363 616c 655f 6633  gml_vec_scale_f3
+00049990: 3228 6e78 2c20 6d68 2c20 616c 7068 612f  2(nx, mh, alpha/
+000499a0: 2831 2e30 6620 2d20 706f 7766 2862 6574  (1.0f - powf(bet
+000499b0: 6131 2c20 7420 2b20 3129 2929 3b0a 2020  a1, t + 1)));.  
+000499c0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+000499d0: 6563 5f73 6361 6c65 5f66 3332 286e 782c  ec_scale_f32(nx,
+000499e0: 2076 682c 2020 312e 3066 2f28 312e 3066   vh,  1.0f/(1.0f
+000499f0: 202d 2070 6f77 6628 6265 7461 322c 2074   - powf(beta2, t
+00049a00: 202b 2031 2929 293b 0a0a 2020 2020 2020   + 1)));..      
+00049a10: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+00049a20: 7172 745f 6633 3220 286e 782c 2076 682c  qrt_f32 (nx, vh,
+00049a30: 2076 6829 3b0a 2020 2020 2020 2020 2020   vh);.          
+00049a40: 2020 6767 6d6c 5f76 6563 5f61 6363 315f    ggml_vec_acc1_
+00049a50: 6633 3220 286e 782c 2076 682c 2065 7073  f32 (nx, vh, eps
+00049a60: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00049a70: 6767 6d6c 5f76 6563 5f64 6976 5f66 3332  ggml_vec_div_f32
+00049a80: 2020 286e 782c 206d 682c 206d 682c 2076    (nx, mh, mh, v
+00049a90: 6829 3b0a 2020 2020 2020 2020 2020 2020  h);.            
+00049aa0: 6767 6d6c 5f76 6563 5f73 7562 5f66 3332  ggml_vec_sub_f32
+00049ab0: 2020 286e 782c 2078 2c20 2078 2c20 206d    (nx, x,  x,  m
+00049ac0: 6829 3b0a 0a20 2020 2020 2020 2020 2020  h);..           
+00049ad0: 202f 2f20 7570 6461 7465 2074 6865 2070   // update the p
+00049ae0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00049af0: 2020 2020 2020 6767 6d6c 5f6f 7074 5f73        ggml_opt_s
+00049b00: 6574 5f70 6172 616d 7328 6e70 2c20 7073  et_params(np, ps
+00049b10: 2c20 7829 3b0a 2020 2020 2020 2020 7d0a  , x);.        }.
+00049b20: 0a20 2020 2020 2020 2067 676d 6c5f 6772  .        ggml_gr
+00049b30: 6170 685f 7265 7365 7420 2028 6766 293b  aph_reset  (gf);
+00049b40: 0a20 2020 2020 2020 2067 676d 6c5f 7365  .        ggml_se
+00049b50: 745f 6633 3220 2020 2020 2028 662d 3e67  t_f32      (f->g
+00049b60: 7261 642c 2031 2e30 6629 3b0a 2020 2020  rad, 1.0f);.    
+00049b70: 2020 2020 6767 6d6c 5f67 7261 7068 5f63      ggml_graph_c
+00049b80: 6f6d 7075 7465 2863 7478 2c20 6762 293b  ompute(ctx, gb);
+00049b90: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+00049ba0: 666c 6f61 7420 6678 203d 2067 676d 6c5f  float fx = ggml_
+00049bb0: 6765 745f 6633 325f 3164 2866 2c20 3029  get_f32_1d(f, 0)
+00049bc0: 3b0a 0a20 2020 2020 2020 202f 2f20 6368  ;..        // ch
+00049bd0: 6563 6b20 636f 6e76 6572 6765 6e63 650a  eck convergence.
+00049be0: 2020 2020 2020 2020 6966 2028 6661 6273          if (fabs
+00049bf0: 6628 6678 202d 2066 785f 7072 6576 292f  f(fx - fx_prev)/
+00049c00: 6678 203c 2070 6172 616d 732e 6164 616d  fx < params.adam
+00049c10: 2e65 7073 5f66 2920 7b0a 2020 2020 2020  .eps_f) {.      
+00049c20: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+00049c30: 5f44 4542 5547 2822 636f 6e76 6572 6765  _DEBUG("converge
+00049c40: 645c 6e22 293b 0a0a 2020 2020 2020 2020  d\n");..        
+00049c50: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
+00049c60: 4f50 545f 4f4b 3b0a 2020 2020 2020 2020  OPT_OK;.        
+00049c70: 7d0a 0a20 2020 2020 2020 202f 2f20 6465  }..        // de
+00049c80: 6c74 612d 6261 7365 6420 636f 6e76 6572  lta-based conver
+00049c90: 6765 6e63 6520 7465 7374 0a20 2020 2020  gence test.     
+00049ca0: 2020 2069 6620 2870 6620 213d 204e 554c     if (pf != NUL
+00049cb0: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+00049cc0: 202f 2f20 6e65 6564 2061 7420 6c65 6173   // need at leas
+00049cd0: 7420 7061 7261 6d73 2e70 6173 7420 6974  t params.past it
+00049ce0: 6572 6174 696f 6e73 2074 6f20 7374 6172  erations to star
+00049cf0: 7420 6368 6563 6b69 6e67 2066 6f72 2063  t checking for c
+00049d00: 6f6e 7665 7267 656e 6365 0a20 2020 2020  onvergence.     
+00049d10: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
+00049d20: 732e 7061 7374 203c 3d20 7429 207b 0a20  s.past <= t) {. 
+00049d30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00049d40: 6f6e 7374 2066 6c6f 6174 2072 6174 6520  onst float rate 
+00049d50: 3d20 2870 665b 7425 7061 7261 6d73 2e70  = (pf[t%params.p
+00049d60: 6173 745d 202d 2066 7829 2f66 783b 0a0a  ast] - fx)/fx;..
+00049d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049d80: 6966 2028 6661 6273 6628 7261 7465 2920  if (fabsf(rate) 
+00049d90: 3c20 7061 7261 6d73 2e64 656c 7461 2920  < params.delta) 
+00049da0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00049db0: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
+00049dc0: 4c5f 4f50 545f 4f4b 3b0a 2020 2020 2020  L_OPT_OK;.      
+00049dd0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00049de0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00049df0: 2020 2020 2020 2070 665b 7425 7061 7261         pf[t%para
+00049e00: 6d73 2e70 6173 745d 203d 2066 783b 0a20  ms.past] = fx;. 
+00049e10: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00049e20: 2020 2f2f 2063 6865 636b 2066 6f72 2069    // check for i
+00049e30: 6d70 726f 7665 6d65 6e74 0a20 2020 2020  mprovement.     
+00049e40: 2020 2069 6620 2870 6172 616d 732e 6d61     if (params.ma
+00049e50: 785f 6e6f 5f69 6d70 726f 7665 6d65 6e74  x_no_improvement
+00049e60: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
+00049e70: 2020 2020 6966 2028 6678 5f62 6573 7420      if (fx_best 
+00049e80: 3e20 6678 2920 7b0a 2020 2020 2020 2020  > fx) {.        
+00049e90: 2020 2020 2020 2020 6678 5f62 6573 7420          fx_best 
+00049ea0: 3d20 6678 3b0a 2020 2020 2020 2020 2020  = fx;.          
+00049eb0: 2020 2020 2020 6e5f 6e6f 5f69 6d70 726f        n_no_impro
+00049ec0: 7665 6d65 6e74 203d 2030 3b0a 2020 2020  vement = 0;.    
+00049ed0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+00049ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049ef0: 202b 2b6e 5f6e 6f5f 696d 7072 6f76 656d   ++n_no_improvem
+00049f00: 656e 743b 0a0a 2020 2020 2020 2020 2020  ent;..          
+00049f10: 2020 2020 2020 6966 2028 6e5f 6e6f 5f69        if (n_no_i
+00049f20: 6d70 726f 7665 6d65 6e74 203e 3d20 7061  mprovement >= pa
+00049f30: 7261 6d73 2e6d 6178 5f6e 6f5f 696d 7072  rams.max_no_impr
+00049f40: 6f76 656d 656e 7429 207b 0a20 2020 2020  ovement) {.     
+00049f50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00049f60: 6574 7572 6e20 4747 4d4c 5f4f 5054 5f4f  eturn GGML_OPT_O
+00049f70: 4b3b 0a20 2020 2020 2020 2020 2020 2020  K;.             
+00049f80: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00049f90: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+00049fa0: 2020 2020 2020 6678 5f70 7265 7620 3d20        fx_prev = 
+00049fb0: 6678 3b0a 0a20 2020 2020 2020 207b 0a20  fx;..        {. 
+00049fc0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00049fd0: 2069 6e74 3634 5f74 2074 5f65 6e64 5f63   int64_t t_end_c
+00049fe0: 7075 203d 2067 676d 6c5f 6379 636c 6573  pu = ggml_cycles
+00049ff0: 2829 3b0a 2020 2020 2020 2020 2020 2020  ();.            
+0004a000: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+0004a010: 2822 7469 6d65 2069 7465 723a 2020 2020  ("time iter:    
+0004a020: 2020 2535 2e33 6620 735c 6e22 2c20 2828    %5.3f s\n", ((
+0004a030: 666c 6f61 7429 2874 5f65 6e64 5f63 7075  float)(t_end_cpu
+0004a040: 202d 2074 5f73 7461 7274 5f63 7075 2929   - t_start_cpu))
+0004a050: 2f43 4c4f 434b 535f 5045 525f 5345 4329  /CLOCKS_PER_SEC)
+0004a060: 3b0a 2020 2020 2020 2020 2020 2020 554e  ;.            UN
+0004a070: 5553 4544 2874 5f65 6e64 5f63 7075 293b  USED(t_end_cpu);
+0004a080: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+0004a090: 6e73 7420 696e 7436 345f 7420 745f 656e  nst int64_t t_en
+0004a0a0: 645f 7761 6c6c 203d 2067 676d 6c5f 7469  d_wall = ggml_ti
+0004a0b0: 6d65 5f75 7328 293b 0a20 2020 2020 2020  me_us();.       
+0004a0c0: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
+0004a0d0: 4445 4255 4728 2277 616c 6c20 7469 6d65  DEBUG("wall time
+0004a0e0: 2069 7465 723a 2025 352e 3366 2073 5c6e   iter: %5.3f s\n
+0004a0f0: 222c 2028 745f 656e 645f 7761 6c6c 202d  ", (t_end_wall -
+0004a100: 2074 5f73 7461 7274 5f77 616c 6c29 2f31   t_start_wall)/1
+0004a110: 6536 293b 0a20 2020 2020 2020 2020 2020  e6);.           
+0004a120: 2055 4e55 5345 4428 745f 656e 645f 7761   UNUSED(t_end_wa
+0004a130: 6c6c 293b 0a20 2020 2020 2020 207d 0a20  ll);.        }. 
+0004a140: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
+0004a150: 2047 474d 4c5f 4f50 545f 4449 445f 4e4f   GGML_OPT_DID_NO
+0004a160: 545f 434f 4e56 4552 4745 3b0a 7d0a 0a2f  T_CONVERGE;.}../
+0004a170: 2f0a 2f2f 204c 2d42 4647 530a 2f2f 0a2f  /.// L-BFGS.//./
+0004a180: 2f20 7468 6520 4c2d 4246 4753 2069 6d70  / the L-BFGS imp
+0004a190: 6c65 6d65 6e74 6174 696f 6e20 6265 6c6f  lementation belo
+0004a1a0: 7720 6973 2062 6173 6564 206f 6e20 7468  w is based on th
+0004a1b0: 6520 666f 6c6c 6f77 696e 6720 696d 706c  e following impl
+0004a1c0: 656d 656e 7461 7469 6f6e 3a0a 2f2f 0a2f  ementation:.//./
+0004a1d0: 2f20 2020 6874 7470 733a 2f2f 6769 7468  /   https://gith
+0004a1e0: 7562 2e63 6f6d 2f63 686f 6b6b 616e 2f6c  ub.com/chokkan/l
+0004a1f0: 6962 6c62 6667 730a 2f2f 0a0a 7374 7275  iblbfgs.//..stru
+0004a200: 6374 2067 676d 6c5f 6c62 6667 735f 6974  ct ggml_lbfgs_it
+0004a210: 6572 6174 696f 6e5f 6461 7461 207b 0a20  eration_data {. 
+0004a220: 2020 2066 6c6f 6174 2061 6c70 6861 3b0a     float alpha;.
+0004a230: 2020 2020 666c 6f61 7420 7973 3b0a 2020      float ys;.  
+0004a240: 2020 666c 6f61 7420 2a20 733b 0a20 2020    float * s;.   
+0004a250: 2066 6c6f 6174 202a 2079 3b0a 7d3b 0a0a   float * y;.};..
+0004a260: 7374 6174 6963 2065 6e75 6d20 6767 6d6c  static enum ggml
+0004a270: 5f6f 7074 5f72 6573 756c 7420 6c69 6e65  _opt_result line
+0004a280: 7365 6172 6368 5f62 6163 6b74 7261 636b  search_backtrack
+0004a290: 696e 6728 0a20 2020 2020 2020 2073 7472  ing(.        str
+0004a2a0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0004a2b0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0004a2c0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0004a2d0: 6c5f 6f70 745f 7061 7261 6d73 202a 2070  l_opt_params * p
+0004a2e0: 6172 616d 732c 0a20 2020 2020 2020 2069  arams,.        i
+0004a2f0: 6e74 206e 782c 0a20 2020 2020 2020 2066  nt nx,.        f
+0004a300: 6c6f 6174 202a 2078 2c0a 2020 2020 2020  loat * x,.      
+0004a310: 2020 666c 6f61 7420 2a20 6678 2c0a 2020    float * fx,.  
+0004a320: 2020 2020 2020 666c 6f61 7420 2a20 672c        float * g,
+0004a330: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
+0004a340: 2064 2c0a 2020 2020 2020 2020 666c 6f61   d,.        floa
+0004a350: 7420 2a20 7374 6570 2c0a 2020 2020 2020  t * step,.      
+0004a360: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
+0004a370: 7870 2c0a 2020 2020 2020 2020 7374 7275  xp,.        stru
+0004a380: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0004a390: 2066 2c0a 2020 2020 2020 2020 7374 7275   f,.        stru
+0004a3a0: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+0004a3b0: 2067 662c 0a20 2020 2020 2020 2073 7472   gf,.        str
+0004a3c0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+0004a3d0: 2a20 6762 2c0a 2020 2020 2020 2020 636f  * gb,.        co
+0004a3e0: 6e73 7420 696e 7420 6e70 2c0a 2020 2020  nst int np,.    
+0004a3f0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0004a400: 7465 6e73 6f72 202a 2070 735b 5d29 207b  tensor * ps[]) {
+0004a410: 0a20 2020 2069 6e74 2063 6f75 6e74 203d  .    int count =
+0004a420: 2030 3b0a 0a20 2020 2066 6c6f 6174 2077   0;..    float w
+0004a430: 6964 7468 2020 3d20 302e 3066 3b0a 2020  idth  = 0.0f;.  
+0004a440: 2020 666c 6f61 7420 6467 2020 2020 203d    float dg     =
+0004a450: 2030 2e30 663b 0a20 2020 2066 6c6f 6174   0.0f;.    float
+0004a460: 2066 696e 6974 2020 3d20 302e 3066 3b0a   finit  = 0.0f;.
+0004a470: 2020 2020 666c 6f61 7420 6467 696e 6974      float dginit
+0004a480: 203d 2030 2e30 663b 0a20 2020 2066 6c6f   = 0.0f;.    flo
+0004a490: 6174 2064 6774 6573 7420 3d20 302e 3066  at dgtest = 0.0f
+0004a4a0: 3b0a 0a20 2020 2063 6f6e 7374 2066 6c6f  ;..    const flo
+0004a4b0: 6174 2064 6563 203d 2030 2e35 663b 0a20  at dec = 0.5f;. 
+0004a4c0: 2020 2063 6f6e 7374 2066 6c6f 6174 2069     const float i
+0004a4d0: 6e63 203d 2032 2e31 663b 0a0a 2020 2020  nc = 2.1f;..    
+0004a4e0: 6966 2028 2a73 7465 7020 3c3d 2030 2e66  if (*step <= 0.f
+0004a4f0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+0004a500: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
+0004a510: 4348 5f49 4e56 414c 4944 5f50 4152 414d  CH_INVALID_PARAM
+0004a520: 4554 4552 533b 0a20 2020 207d 0a0a 2020  ETERS;.    }..  
+0004a530: 2020 2f2f 2063 6f6d 7075 7465 2074 6865    // compute the
+0004a540: 2069 6e69 7469 616c 2067 7261 6469 656e   initial gradien
+0004a550: 7420 696e 2074 6865 2073 6561 7263 6820  t in the search 
+0004a560: 6469 7265 6374 696f 6e0a 2020 2020 6767  direction.    gg
+0004a570: 6d6c 5f76 6563 5f64 6f74 5f66 3332 286e  ml_vec_dot_f32(n
+0004a580: 782c 2026 6467 696e 6974 2c20 672c 2064  x, &dginit, g, d
+0004a590: 293b 0a0a 2020 2020 2f2f 206d 616b 6520  );..    // make 
+0004a5a0: 7375 7265 2074 6861 7420 6420 706f 696e  sure that d poin
+0004a5b0: 7473 2074 6f20 6120 6465 7363 656e 7420  ts to a descent 
+0004a5c0: 6469 7265 6374 696f 6e0a 2020 2020 6966  direction.    if
+0004a5d0: 2028 3020 3c20 6467 696e 6974 2920 7b0a   (0 < dginit) {.
+0004a5e0: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+0004a5f0: 474d 4c5f 4c49 4e45 5345 4152 4348 5f46  GML_LINESEARCH_F
+0004a600: 4149 4c3b 0a20 2020 207d 0a0a 2020 2020  AIL;.    }..    
+0004a610: 2f2f 2069 6e69 7469 616c 697a 6520 6c6f  // initialize lo
+0004a620: 6361 6c20 7661 7269 6162 6c65 730a 2020  cal variables.  
+0004a630: 2020 6669 6e69 7420 3d20 2a66 783b 0a20    finit = *fx;. 
+0004a640: 2020 2064 6774 6573 7420 3d20 7061 7261     dgtest = para
+0004a650: 6d73 2d3e 6c62 6667 732e 6674 6f6c 2a64  ms->lbfgs.ftol*d
+0004a660: 6769 6e69 743b 0a0a 2020 2020 7768 696c  ginit;..    whil
+0004a670: 6520 2874 7275 6529 207b 0a20 2020 2020  e (true) {.     
+0004a680: 2020 2067 676d 6c5f 7665 635f 6370 795f     ggml_vec_cpy_
+0004a690: 6633 3228 6e78 2c20 782c 2078 7029 3b0a  f32(nx, x, xp);.
+0004a6a0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0004a6b0: 5f6d 6164 5f66 3332 286e 782c 2078 2c20  _mad_f32(nx, x, 
+0004a6c0: 642c 202a 7374 6570 293b 0a0a 2020 2020  d, *step);..    
+0004a6d0: 2020 2020 2f2f 2065 7661 6c75 6174 6520      // evaluate 
+0004a6e0: 7468 6520 6675 6e63 7469 6f6e 2061 6e64  the function and
+0004a6f0: 2067 7261 6469 656e 7420 7661 6c75 6573   gradient values
+0004a700: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
+0004a710: 2020 2020 2020 2067 676d 6c5f 6f70 745f         ggml_opt_
+0004a720: 7365 745f 7061 7261 6d73 286e 702c 2070  set_params(np, p
+0004a730: 732c 2078 293b 0a0a 2020 2020 2020 2020  s, x);..        
+0004a740: 2020 2020 6767 6d6c 5f67 7261 7068 5f72      ggml_graph_r
+0004a750: 6573 6574 2020 2867 6629 3b0a 2020 2020  eset  (gf);.    
+0004a760: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
+0004a770: 5f66 3332 2020 2020 2020 2866 2d3e 6772  _f32      (f->gr
+0004a780: 6164 2c20 312e 3066 293b 0a20 2020 2020  ad, 1.0f);.     
+0004a790: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
+0004a7a0: 685f 636f 6d70 7574 6528 6374 782c 2067  h_compute(ctx, g
+0004a7b0: 6229 3b0a 0a20 2020 2020 2020 2020 2020  b);..           
+0004a7c0: 2067 676d 6c5f 6f70 745f 6765 745f 6772   ggml_opt_get_gr
+0004a7d0: 6164 286e 702c 2070 732c 2067 293b 0a0a  ad(np, ps, g);..
+0004a7e0: 2020 2020 2020 2020 2020 2020 2a66 7820              *fx 
+0004a7f0: 3d20 6767 6d6c 5f67 6574 5f66 3332 5f31  = ggml_get_f32_1
+0004a800: 6428 662c 2030 293b 0a20 2020 2020 2020  d(f, 0);.       
+0004a810: 207d 0a0a 2020 2020 2020 2020 2b2b 636f   }..        ++co
+0004a820: 756e 743b 0a0a 2020 2020 2020 2020 6966  unt;..        if
+0004a830: 2028 2a66 7820 3e20 6669 6e69 7420 2b20   (*fx > finit + 
+0004a840: 282a 7374 6570 292a 6467 7465 7374 2920  (*step)*dgtest) 
+0004a850: 7b0a 2020 2020 2020 2020 2020 2020 7769  {.            wi
+0004a860: 6474 6820 3d20 6465 633b 0a20 2020 2020  dth = dec;.     
+0004a870: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0004a880: 2020 2020 2020 2020 2f2f 2041 726d 696a          // Armij
+0004a890: 6f20 636f 6e64 6974 696f 6e20 6973 2073  o condition is s
+0004a8a0: 6174 6973 6669 6564 0a20 2020 2020 2020  atisfied.       
+0004a8b0: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
+0004a8c0: 3e6c 6266 6773 2e6c 696e 6573 6561 7263  >lbfgs.linesearc
+0004a8d0: 6820 3d3d 2047 474d 4c5f 4c49 4e45 5345  h == GGML_LINESE
+0004a8e0: 4152 4348 5f42 4143 4b54 5241 434b 494e  ARCH_BACKTRACKIN
+0004a8f0: 475f 4152 4d49 4a4f 2920 7b0a 2020 2020  G_ARMIJO) {.    
+0004a900: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0004a910: 726e 2063 6f75 6e74 3b0a 2020 2020 2020  rn count;.      
+0004a920: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0004a930: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
+0004a940: 745f 6633 3228 6e78 2c20 2664 672c 2067  t_f32(nx, &dg, g
+0004a950: 2c20 6429 3b0a 0a20 2020 2020 2020 2020  , d);..         
+0004a960: 2020 202f 2f20 6368 6563 6b20 7468 6520     // check the 
+0004a970: 576f 6c66 6520 636f 6e64 6974 696f 6e0a  Wolfe condition.
+0004a980: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0004a990: 6467 203c 2070 6172 616d 732d 3e6c 6266  dg < params->lbf
+0004a9a0: 6773 2e77 6f6c 6665 202a 2064 6769 6e69  gs.wolfe * dgini
+0004a9b0: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
+0004a9c0: 2020 2020 2077 6964 7468 203d 2069 6e63       width = inc
+0004a9d0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0004a9e0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+0004a9f0: 2020 2020 2020 2069 6628 7061 7261 6d73         if(params
+0004aa00: 2d3e 6c62 6667 732e 6c69 6e65 7365 6172  ->lbfgs.linesear
+0004aa10: 6368 203d 3d20 4747 4d4c 5f4c 494e 4553  ch == GGML_LINES
+0004aa20: 4541 5243 485f 4241 434b 5452 4143 4b49  EARCH_BACKTRACKI
+0004aa30: 4e47 5f57 4f4c 4645 2920 7b0a 2020 2020  NG_WOLFE) {.    
+0004aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aa50: 2f2f 2072 6567 756c 6172 2057 6f6c 6665  // regular Wolfe
+0004aa60: 2063 6f6e 6469 7469 6f6e 730a 2020 2020   conditions.    
+0004aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aa80: 7265 7475 726e 2063 6f75 6e74 3b0a 2020  return count;.  
+0004aa90: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0004aaa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004aab0: 2069 6628 6467 203e 202d 7061 7261 6d73   if(dg > -params
+0004aac0: 2d3e 6c62 6667 732e 776f 6c66 652a 6467  ->lbfgs.wolfe*dg
+0004aad0: 696e 6974 2920 7b0a 2020 2020 2020 2020  init) {.        
+0004aae0: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+0004aaf0: 6820 3d20 6465 633b 0a20 2020 2020 2020  h = dec;.       
+0004ab00: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+0004ab10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0004ab20: 2020 2020 2020 2f2f 2073 7472 6f6e 6720        // strong 
+0004ab30: 576f 6c66 6520 636f 6e64 6974 696f 6e20  Wolfe condition 
+0004ab40: 2847 474d 4c5f 4c49 4e45 5345 4152 4348  (GGML_LINESEARCH
+0004ab50: 5f42 4143 4b54 5241 434b 494e 475f 5354  _BACKTRACKING_ST
+0004ab60: 524f 4e47 5f57 4f4c 4645 290a 2020 2020  RONG_WOLFE).    
+0004ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ab80: 7265 7475 726e 2063 6f75 6e74 3b0a 2020  return count;.  
+0004ab90: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0004aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004abb0: 7265 7475 726e 2063 6f75 6e74 3b0a 2020  return count;.  
+0004abc0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0004abd0: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+0004abe0: 6620 282a 7374 6570 203c 2070 6172 616d  f (*step < param
+0004abf0: 732d 3e6c 6266 6773 2e6d 696e 5f73 7465  s->lbfgs.min_ste
+0004ac00: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
+0004ac10: 2072 6574 7572 6e20 4747 4d4c 5f4c 494e   return GGML_LIN
+0004ac20: 4553 4541 5243 485f 4d49 4e49 4d55 4d5f  ESEARCH_MINIMUM_
+0004ac30: 5354 4550 3b0a 2020 2020 2020 2020 7d0a  STEP;.        }.
+0004ac40: 2020 2020 2020 2020 6966 2028 2a73 7465          if (*ste
+0004ac50: 7020 3e20 7061 7261 6d73 2d3e 6c62 6667  p > params->lbfg
+0004ac60: 732e 6d61 785f 7374 6570 2920 7b0a 2020  s.max_step) {.  
+0004ac70: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0004ac80: 2047 474d 4c5f 4c49 4e45 5345 4152 4348   GGML_LINESEARCH
+0004ac90: 5f4d 4158 494d 554d 5f53 5445 503b 0a20  _MAXIMUM_STEP;. 
+0004aca0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0004acb0: 2069 6620 2870 6172 616d 732d 3e6c 6266   if (params->lbf
+0004acc0: 6773 2e6d 6178 5f6c 696e 6573 6561 7263  gs.max_linesearc
+0004acd0: 6820 3c3d 2063 6f75 6e74 2920 7b0a 2020  h <= count) {.  
+0004ace0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0004acf0: 2047 474d 4c5f 4c49 4e45 5345 4152 4348   GGML_LINESEARCH
+0004ad00: 5f4d 4158 494d 554d 5f49 5445 5241 5449  _MAXIMUM_ITERATI
+0004ad10: 4f4e 533b 0a20 2020 2020 2020 207d 0a0a  ONS;.        }..
+0004ad20: 2020 2020 2020 2020 282a 7374 6570 2920          (*step) 
+0004ad30: 2a3d 2077 6964 7468 3b0a 2020 2020 7d0a  *= width;.    }.
+0004ad40: 0a20 2020 2072 6574 7572 6e20 4747 4d4c  .    return GGML
+0004ad50: 5f4c 494e 4553 4541 5243 485f 4641 494c  _LINESEARCH_FAIL
+0004ad60: 3b0a 7d0a 0a73 7461 7469 6320 656e 756d  ;.}..static enum
+0004ad70: 2067 676d 6c5f 6f70 745f 7265 7375 6c74   ggml_opt_result
+0004ad80: 2067 676d 6c5f 6f70 745f 6c62 6667 7328   ggml_opt_lbfgs(
+0004ad90: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0004ada0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0004adb0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0004adc0: 6374 2067 676d 6c5f 6f70 745f 7061 7261  ct ggml_opt_para
+0004add0: 6d73 2070 6172 616d 732c 0a20 2020 2020  ms params,.     
+0004ade0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0004adf0: 656e 736f 7220 2a20 662c 0a20 2020 2020  ensor * f,.     
+0004ae00: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0004ae10: 6772 6170 6820 2a20 6766 2c0a 2020 2020  graph * gf,.    
+0004ae20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0004ae30: 6367 7261 7068 202a 2067 6229 207b 0a20  cgraph * gb) {. 
+0004ae40: 2020 2069 6620 2870 6172 616d 732e 6c62     if (params.lb
+0004ae50: 6667 732e 6c69 6e65 7365 6172 6368 203d  fgs.linesearch =
+0004ae60: 3d20 4747 4d4c 5f4c 494e 4553 4541 5243  = GGML_LINESEARC
+0004ae70: 485f 4241 434b 5452 4143 4b49 4e47 5f57  H_BACKTRACKING_W
+0004ae80: 4f4c 4645 207c 7c0a 2020 2020 2020 2020  OLFE ||.        
+0004ae90: 7061 7261 6d73 2e6c 6266 6773 2e6c 696e  params.lbfgs.lin
+0004aea0: 6573 6561 7263 6820 3d3d 2047 474d 4c5f  esearch == GGML_
+0004aeb0: 4c49 4e45 5345 4152 4348 5f42 4143 4b54  LINESEARCH_BACKT
+0004aec0: 5241 434b 494e 475f 5354 524f 4e47 5f57  RACKING_STRONG_W
+0004aed0: 4f4c 4645 2920 7b0a 2020 2020 2020 2020  OLFE) {.        
+0004aee0: 6966 2028 7061 7261 6d73 2e6c 6266 6773  if (params.lbfgs
+0004aef0: 2e77 6f6c 6665 203c 3d20 7061 7261 6d73  .wolfe <= params
+0004af00: 2e6c 6266 6773 2e66 746f 6c20 7c7c 2031  .lbfgs.ftol || 1
+0004af10: 2e66 203c 3d20 7061 7261 6d73 2e6c 6266  .f <= params.lbf
+0004af20: 6773 2e77 6f6c 6665 2920 7b0a 2020 2020  gs.wolfe) {.    
+0004af30: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+0004af40: 474d 4c5f 4f50 545f 494e 5641 4c49 445f  GML_OPT_INVALID_
+0004af50: 574f 4c46 453b 0a20 2020 2020 2020 207d  WOLFE;.        }
+0004af60: 0a20 2020 207d 0a0a 2020 2020 6766 2d3e  .    }..    gf->
+0004af70: 6e5f 7468 7265 6164 7320 3d20 7061 7261  n_threads = para
+0004af80: 6d73 2e6e 5f74 6872 6561 6473 3b0a 2020  ms.n_threads;.  
+0004af90: 2020 6762 2d3e 6e5f 7468 7265 6164 7320    gb->n_threads 
+0004afa0: 3d20 7061 7261 6d73 2e6e 5f74 6872 6561  = params.n_threa
+0004afb0: 6473 3b0a 0a20 2020 2063 6f6e 7374 2069  ds;..    const i
+0004afc0: 6e74 206d 203d 2070 6172 616d 732e 6c62  nt m = params.lb
+0004afd0: 6667 732e 6d3b 0a0a 2020 2020 2f2f 2074  fgs.m;..    // t
+0004afe0: 6865 7365 2077 696c 6c20 7374 6f72 6520  hese will store 
+0004aff0: 7468 6520 7061 7261 6d65 7465 7273 2077  the parameters w
+0004b000: 6520 7761 6e74 2074 6f20 6f70 7469 6d69  e want to optimi
+0004b010: 7a65 0a20 2020 2073 7472 7563 7420 6767  ze.    struct gg
+0004b020: 6d6c 5f74 656e 736f 7220 2a20 7073 5b47  ml_tensor * ps[G
+0004b030: 474d 4c5f 4d41 585f 5041 5241 4d53 5d3b  GML_MAX_PARAMS];
+0004b040: 0a0a 2020 2020 696e 7420 6e70 203d 2030  ..    int np = 0
+0004b050: 3b0a 2020 2020 696e 7420 6e78 203d 2030  ;.    int nx = 0
+0004b060: 3b0a 2020 2020 666f 7220 2869 6e74 2069  ;.    for (int i
+0004b070: 203d 2030 3b20 6920 3c20 6766 2d3e 6e5f   = 0; i < gf->n_
+0004b080: 6e6f 6465 733b 202b 2b69 2920 7b0a 2020  nodes; ++i) {.  
+0004b090: 2020 2020 2020 6966 2028 6766 2d3e 6e6f        if (gf->no
+0004b0a0: 6465 735b 695d 2d3e 6973 5f70 6172 616d  des[i]->is_param
+0004b0b0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0004b0c0: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+0004b0d0: 2822 666f 756e 6420 7061 7261 6d20 2564  ("found param %d
+0004b0e0: 3a20 6772 6164 2d3e 6f70 203d 2025 645c  : grad->op = %d\
+0004b0f0: 6e22 2c20 6e70 2c20 6766 2d3e 6e6f 6465  n", np, gf->node
+0004b100: 735b 695d 2d3e 6772 6164 2d3e 6f70 293b  s[i]->grad->op);
+0004b110: 0a0a 2020 2020 2020 2020 2020 2020 4747  ..            GG
+0004b120: 4d4c 5f41 5353 4552 5428 6e70 203c 2047  ML_ASSERT(np < G
+0004b130: 474d 4c5f 4d41 585f 5041 5241 4d53 293b  GML_MAX_PARAMS);
+0004b140: 0a0a 2020 2020 2020 2020 2020 2020 7073  ..            ps
+0004b150: 5b6e 702b 2b5d 203d 2067 662d 3e6e 6f64  [np++] = gf->nod
+0004b160: 6573 5b69 5d3b 0a20 2020 2020 2020 2020  es[i];.         
+0004b170: 2020 206e 7820 2b3d 2067 676d 6c5f 6e65     nx += ggml_ne
+0004b180: 6c65 6d65 6e74 7328 6766 2d3e 6e6f 6465  lements(gf->node
+0004b190: 735b 695d 293b 0a20 2020 2020 2020 207d  s[i]);.        }
+0004b1a0: 0a20 2020 207d 0a0a 2020 2020 666c 6f61  .    }..    floa
+0004b1b0: 7420 2a20 7820 203d 2067 676d 6c5f 6e65  t * x  = ggml_ne
+0004b1c0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+0004b1d0: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+0004b1e0: 6e78 292d 3e64 6174 613b 202f 2f20 6375  nx)->data; // cu
+0004b1f0: 7272 656e 7420 7061 7261 6d65 7465 7273  rrent parameters
+0004b200: 0a20 2020 2066 6c6f 6174 202a 2078 7020  .    float * xp 
+0004b210: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
+0004b220: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
+0004b230: 5950 455f 4633 322c 206e 7829 2d3e 6461  YPE_F32, nx)->da
+0004b240: 7461 3b20 2f2f 2070 7265 7669 6f75 7320  ta; // previous 
+0004b250: 7061 7261 6d65 7465 7273 0a20 2020 2066  parameters.    f
+0004b260: 6c6f 6174 202a 2067 2020 3d20 6767 6d6c  loat * g  = ggml
+0004b270: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+0004b280: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
+0004b290: 322c 206e 7829 2d3e 6461 7461 3b20 2f2f  2, nx)->data; //
+0004b2a0: 2063 7572 7265 6e74 2067 7261 6469 656e   current gradien
+0004b2b0: 740a 2020 2020 666c 6f61 7420 2a20 6770  t.    float * gp
+0004b2c0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+0004b2d0: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+0004b2e0: 5459 5045 5f46 3332 2c20 6e78 292d 3e64  TYPE_F32, nx)->d
+0004b2f0: 6174 613b 202f 2f20 7072 6576 696f 7573  ata; // previous
+0004b300: 2067 7261 6469 656e 740a 2020 2020 666c   gradient.    fl
+0004b310: 6f61 7420 2a20 6420 203d 2067 676d 6c5f  oat * d  = ggml_
+0004b320: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+0004b330: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+0004b340: 2c20 6e78 292d 3e64 6174 613b 202f 2f20  , nx)->data; // 
+0004b350: 7365 6172 6368 2064 6972 6563 7469 6f6e  search direction
+0004b360: 0a0a 2020 2020 666c 6f61 7420 2a20 7066  ..    float * pf
+0004b370: 203d 2070 6172 616d 732e 7061 7374 203e   = params.past >
+0004b380: 2030 203f 2067 676d 6c5f 6e65 775f 7465   0 ? ggml_new_te
+0004b390: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+0004b3a0: 4c5f 5459 5045 5f46 3332 2c20 7061 7261  L_TYPE_F32, para
+0004b3b0: 6d73 2e70 6173 7429 2d3e 6461 7461 203a  ms.past)->data :
+0004b3c0: 204e 554c 4c3b 202f 2f20 7061 7374 2066   NULL; // past f
+0004b3d0: 756e 6374 696f 6e20 7661 6c75 6573 0a0a  unction values..
+0004b3e0: 2020 2020 666c 6f61 7420 6678 2020 2020      float fx    
+0004b3f0: 3d20 302e 3066 3b20 2f2f 2063 6f73 7420  = 0.0f; // cost 
+0004b400: 6675 6e63 7469 6f6e 2076 616c 7565 0a20  function value. 
+0004b410: 2020 2066 6c6f 6174 2078 6e6f 726d 203d     float xnorm =
+0004b420: 2030 2e30 663b 202f 2f20 7c7c 787c 7c0a   0.0f; // ||x||.
+0004b430: 2020 2020 666c 6f61 7420 676e 6f72 6d20      float gnorm 
+0004b440: 3d20 302e 3066 3b20 2f2f 207c 7c67 7c7c  = 0.0f; // ||g||
+0004b450: 0a20 2020 2066 6c6f 6174 2073 7465 7020  .    float step 
+0004b460: 203d 2030 2e30 663b 0a0a 2020 2020 2f2f   = 0.0f;..    //
+0004b470: 2069 6e69 7469 616c 697a 6520 7820 6672   initialize x fr
+0004b480: 6f6d 2074 6865 2067 7261 7068 206e 6f64  om the graph nod
+0004b490: 6573 0a20 2020 2067 676d 6c5f 6f70 745f  es.    ggml_opt_
+0004b4a0: 6765 745f 7061 7261 6d73 286e 702c 2070  get_params(np, p
+0004b4b0: 732c 2078 293b 0a0a 2020 2020 2f2f 2074  s, x);..    // t
+0004b4c0: 6865 204c 2d42 4647 5320 6d65 6d6f 7279  he L-BFGS memory
+0004b4d0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0004b4e0: 5f6c 6266 6773 5f69 7465 7261 7469 6f6e  _lbfgs_iteration
+0004b4f0: 5f64 6174 6120 2a20 6c6d 203d 2061 6c6c  _data * lm = all
+0004b500: 6f63 6128 7369 7a65 6f66 2873 7472 7563  oca(sizeof(struc
+0004b510: 7420 6767 6d6c 5f6c 6266 6773 5f69 7465  t ggml_lbfgs_ite
+0004b520: 7261 7469 6f6e 5f64 6174 6129 2a6d 293b  ration_data)*m);
+0004b530: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+0004b540: 203d 2030 3b20 6920 3c20 6d3b 202b 2b69   = 0; i < m; ++i
+0004b550: 2920 7b0a 2020 2020 2020 2020 6c6d 5b69  ) {.        lm[i
+0004b560: 5d2e 616c 7068 6120 3d20 302e 3066 3b0a  ].alpha = 0.0f;.
+0004b570: 2020 2020 2020 2020 6c6d 5b69 5d2e 7973          lm[i].ys
+0004b580: 2020 2020 3d20 302e 3066 3b0a 2020 2020      = 0.0f;.    
+0004b590: 2020 2020 6c6d 5b69 5d2e 7320 2020 2020      lm[i].s     
+0004b5a0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
+0004b5b0: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
+0004b5c0: 5950 455f 4633 322c 206e 7829 2d3e 6461  YPE_F32, nx)->da
+0004b5d0: 7461 3b0a 2020 2020 2020 2020 6c6d 5b69  ta;.        lm[i
+0004b5e0: 5d2e 7920 2020 2020 3d20 6767 6d6c 5f6e  ].y     = ggml_n
+0004b5f0: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
+0004b600: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
+0004b610: 206e 7829 2d3e 6461 7461 3b0a 2020 2020   nx)->data;.    
+0004b620: 7d0a 0a20 2020 202f 2f20 6576 616c 7561  }..    // evalua
+0004b630: 7465 2074 6865 2066 756e 6374 696f 6e20  te the function 
+0004b640: 7661 6c75 6520 616e 6420 6974 7320 6772  value and its gr
+0004b650: 6164 6965 6e74 0a20 2020 207b 0a20 2020  adient.    {.   
+0004b660: 2020 2020 2067 676d 6c5f 6f70 745f 7365       ggml_opt_se
+0004b670: 745f 7061 7261 6d73 286e 702c 2070 732c  t_params(np, ps,
+0004b680: 2078 293b 0a0a 2020 2020 2020 2020 6767   x);..        gg
+0004b690: 6d6c 5f67 7261 7068 5f72 6573 6574 2020  ml_graph_reset  
+0004b6a0: 2867 6629 3b0a 2020 2020 2020 2020 6767  (gf);.        gg
+0004b6b0: 6d6c 5f73 6574 5f66 3332 2020 2020 2020  ml_set_f32      
+0004b6c0: 2866 2d3e 6772 6164 2c20 312e 3066 293b  (f->grad, 1.0f);
+0004b6d0: 0a20 2020 2020 2020 2067 676d 6c5f 6772  .        ggml_gr
+0004b6e0: 6170 685f 636f 6d70 7574 6528 6374 782c  aph_compute(ctx,
+0004b6f0: 2067 6229 3b0a 0a20 2020 2020 2020 2067   gb);..        g
+0004b700: 676d 6c5f 6f70 745f 6765 745f 6772 6164  gml_opt_get_grad
+0004b710: 286e 702c 2070 732c 2067 293b 0a0a 2020  (np, ps, g);..  
+0004b720: 2020 2020 2020 6678 203d 2067 676d 6c5f        fx = ggml_
+0004b730: 6765 745f 6633 325f 3164 2866 2c20 3029  get_f32_1d(f, 0)
+0004b740: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
+0004b750: 2870 6629 207b 0a20 2020 2020 2020 2070  (pf) {.        p
+0004b760: 665b 305d 203d 2066 783b 0a20 2020 207d  f[0] = fx;.    }
+0004b770: 0a0a 2020 2020 666c 6f61 7420 6678 5f62  ..    float fx_b
+0004b780: 6573 7420 3d20 6678 3b0a 0a20 2020 202f  est = fx;..    /
+0004b790: 2f20 7365 6172 6368 2064 6972 6563 7469  / search directi
+0004b7a0: 6f6e 203d 202d 6772 6164 6965 6e74 0a20  on = -gradient. 
+0004b7b0: 2020 2067 676d 6c5f 7665 635f 6e65 675f     ggml_vec_neg_
+0004b7c0: 6633 3228 6e78 2c20 642c 2067 293b 0a0a  f32(nx, d, g);..
+0004b7d0: 2020 2020 2f2f 207c 7c78 7c7c 2c20 7c7c      // ||x||, ||
+0004b7e0: 677c 7c0a 2020 2020 6767 6d6c 5f76 6563  g||.    ggml_vec
+0004b7f0: 5f6e 6f72 6d5f 6633 3228 6e78 2c20 2678  _norm_f32(nx, &x
+0004b800: 6e6f 726d 2c20 7829 3b0a 2020 2020 6767  norm, x);.    gg
+0004b810: 6d6c 5f76 6563 5f6e 6f72 6d5f 6633 3228  ml_vec_norm_f32(
+0004b820: 6e78 2c20 2667 6e6f 726d 2c20 6729 3b0a  nx, &gnorm, g);.
+0004b830: 0a20 2020 2069 6620 2878 6e6f 726d 203c  .    if (xnorm <
+0004b840: 2031 2e30 6629 207b 0a20 2020 2020 2020   1.0f) {.       
+0004b850: 2078 6e6f 726d 203d 2031 2e30 663b 0a20   xnorm = 1.0f;. 
+0004b860: 2020 207d 0a0a 2020 2020 2f2f 2061 6c72     }..    // alr
+0004b870: 6561 6479 206f 7074 696d 697a 6564 0a20  eady optimized. 
+0004b880: 2020 2069 6620 2867 6e6f 726d 2f78 6e6f     if (gnorm/xno
+0004b890: 726d 203c 3d20 7061 7261 6d73 2e6c 6266  rm <= params.lbf
+0004b8a0: 6773 2e65 7073 2920 7b0a 2020 2020 2020  gs.eps) {.      
+0004b8b0: 2020 7265 7475 726e 2047 474d 4c5f 4f50    return GGML_OP
+0004b8c0: 545f 4f4b 3b0a 2020 2020 7d0a 0a20 2020  T_OK;.    }..   
+0004b8d0: 202f 2f20 696e 6974 6961 6c20 7374 6570   // initial step
+0004b8e0: 0a20 2020 2067 676d 6c5f 7665 635f 6e6f  .    ggml_vec_no
+0004b8f0: 726d 5f69 6e76 5f66 3332 286e 782c 2026  rm_inv_f32(nx, &
+0004b900: 7374 6570 2c20 6429 3b0a 0a20 2020 2069  step, d);..    i
+0004b910: 6e74 206a 2020 2020 2020 2020 2020 2020  nt j            
+0004b920: 2020 2020 3d20 303b 0a20 2020 2069 6e74      = 0;.    int
+0004b930: 206b 2020 2020 2020 2020 2020 2020 2020   k              
+0004b940: 2020 3d20 313b 0a20 2020 2069 6e74 206c    = 1;.    int l
+0004b950: 7320 2020 2020 2020 2020 2020 2020 2020  s               
+0004b960: 3d20 303b 0a20 2020 2069 6e74 2065 6e64  = 0;.    int end
+0004b970: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
+0004b980: 303b 0a20 2020 2069 6e74 2062 6f75 6e64  0;.    int bound
+0004b990: 2020 2020 2020 2020 2020 2020 3d20 303b              = 0;
+0004b9a0: 0a20 2020 2069 6e74 206e 5f6e 6f5f 696d  .    int n_no_im
+0004b9b0: 7072 6f76 656d 656e 7420 3d20 303b 0a0a  provement = 0;..
+0004b9c0: 2020 2020 666c 6f61 7420 7973 2020 203d      float ys   =
+0004b9d0: 2030 2e30 663b 0a20 2020 2066 6c6f 6174   0.0f;.    float
+0004b9e0: 2079 7920 2020 3d20 302e 3066 3b0a 2020   yy   = 0.0f;.  
+0004b9f0: 2020 666c 6f61 7420 6265 7461 203d 2030    float beta = 0
+0004ba00: 2e30 663b 0a0a 2020 2020 7768 696c 6520  .0f;..    while 
+0004ba10: 2874 7275 6529 207b 0a20 2020 2020 2020  (true) {.       
+0004ba20: 202f 2f20 7374 6f72 6520 7468 6520 6375   // store the cu
+0004ba30: 7272 656e 7420 706f 7369 7469 6f6e 2061  rrent position a
+0004ba40: 6e64 2067 7261 6469 656e 7420 7665 6374  nd gradient vect
+0004ba50: 6f72 730a 2020 2020 2020 2020 6767 6d6c  ors.        ggml
+0004ba60: 5f76 6563 5f63 7079 5f66 3332 286e 782c  _vec_cpy_f32(nx,
+0004ba70: 2078 702c 2078 293b 0a20 2020 2020 2020   xp, x);.       
+0004ba80: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
+0004ba90: 3228 6e78 2c20 6770 2c20 6729 3b0a 0a20  2(nx, gp, g);.. 
+0004baa0: 2020 2020 2020 206c 7320 3d20 6c69 6e65         ls = line
+0004bab0: 7365 6172 6368 5f62 6163 6b74 7261 636b  search_backtrack
+0004bac0: 696e 6728 6374 782c 2026 7061 7261 6d73  ing(ctx, &params
+0004bad0: 2c20 6e78 2c20 782c 2026 6678 2c20 672c  , nx, x, &fx, g,
+0004bae0: 2064 2c20 2673 7465 702c 2078 702c 2066   d, &step, xp, f
+0004baf0: 2c20 6766 2c20 6762 2c20 6e70 2c20 7073  , gf, gb, np, ps
+0004bb00: 293b 0a0a 2020 2020 2020 2020 6966 2028  );..        if (
+0004bb10: 6c73 203c 2030 2920 7b0a 2020 2020 2020  ls < 0) {.      
+0004bb20: 2020 2020 2020 2f2f 206c 696e 6573 6561        // linesea
+0004bb30: 7263 6820 6661 696c 6564 202d 2067 6f20  rch failed - go 
+0004bb40: 6261 636b 2074 6f20 7468 6520 7072 6576  back to the prev
+0004bb50: 696f 7573 2070 6f69 6e74 2061 6e64 2072  ious point and r
+0004bb60: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+0004bb70: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
+0004bb80: 3332 286e 782c 2078 2c20 7870 293b 0a20  32(nx, x, xp);. 
+0004bb90: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0004bba0: 7665 635f 6370 795f 6633 3228 6e78 2c20  vec_cpy_f32(nx, 
+0004bbb0: 672c 2067 7029 3b0a 0a20 2020 2020 2020  g, gp);..       
+0004bbc0: 2020 2020 2072 6574 7572 6e20 6c73 3b0a       return ls;.
+0004bbd0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0004bbe0: 2020 2067 676d 6c5f 7665 635f 6e6f 726d     ggml_vec_norm
+0004bbf0: 5f66 3332 286e 782c 2026 786e 6f72 6d2c  _f32(nx, &xnorm,
+0004bc00: 2078 293b 0a20 2020 2020 2020 2067 676d   x);.        ggm
+0004bc10: 6c5f 7665 635f 6e6f 726d 5f66 3332 286e  l_vec_norm_f32(n
+0004bc20: 782c 2026 676e 6f72 6d2c 2067 293b 0a0a  x, &gnorm, g);..
+0004bc30: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+0004bc40: 4e54 5f44 4542 5547 2822 6620 3d20 2531  NT_DEBUG("f = %1
+0004bc50: 302e 3666 5c6e 222c 2067 676d 6c5f 6765  0.6f\n", ggml_ge
+0004bc60: 745f 6633 325f 3164 2866 2c20 3029 293b  t_f32_1d(f, 0));
+0004bc70: 0a0a 2020 2020 2020 2020 6966 2028 786e  ..        if (xn
+0004bc80: 6f72 6d20 3c20 312e 3066 2920 7b0a 2020  orm < 1.0f) {.  
+0004bc90: 2020 2020 2020 2020 2020 786e 6f72 6d20            xnorm 
+0004bca0: 3d20 312e 3066 3b0a 2020 2020 2020 2020  = 1.0f;.        
+0004bcb0: 7d0a 2020 2020 2020 2020 6966 2028 676e  }.        if (gn
+0004bcc0: 6f72 6d2f 786e 6f72 6d20 3c3d 2070 6172  orm/xnorm <= par
+0004bcd0: 616d 732e 6c62 6667 732e 6570 7329 207b  ams.lbfgs.eps) {
+0004bce0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0004bcf0: 636f 6e76 6572 6765 640a 2020 2020 2020  converged.      
+0004bd00: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
+0004bd10: 4c5f 4f50 545f 4f4b 3b0a 2020 2020 2020  L_OPT_OK;.      
+0004bd20: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+0004bd30: 6465 6c74 612d 6261 7365 6420 636f 6e76  delta-based conv
+0004bd40: 6572 6765 6e63 6520 7465 7374 0a20 2020  ergence test.   
+0004bd50: 2020 2020 2069 6620 2870 6620 213d 204e       if (pf != N
+0004bd60: 554c 4c29 207b 0a20 2020 2020 2020 2020  ULL) {.         
+0004bd70: 2020 202f 2f20 6e65 6564 2061 7420 6c65     // need at le
+0004bd80: 6173 7420 7061 7261 6d73 2e70 6173 7420  ast params.past 
+0004bd90: 6974 6572 6174 696f 6e73 2074 6f20 7374  iterations to st
+0004bda0: 6172 7420 6368 6563 6b69 6e67 2066 6f72  art checking for
+0004bdb0: 2063 6f6e 7665 7267 656e 6365 0a20 2020   convergence.   
+0004bdc0: 2020 2020 2020 2020 2069 6620 2870 6172           if (par
+0004bdd0: 616d 732e 7061 7374 203c 3d20 6b29 207b  ams.past <= k) {
+0004bde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bdf0: 2063 6f6e 7374 2066 6c6f 6174 2072 6174   const float rat
+0004be00: 6520 3d20 2870 665b 6b25 7061 7261 6d73  e = (pf[k%params
+0004be10: 2e70 6173 745d 202d 2066 7829 2f66 783b  .past] - fx)/fx;
+0004be20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004be30: 2020 6966 2028 6661 6273 6628 7261 7465    if (fabsf(rate
+0004be40: 2920 3c20 7061 7261 6d73 2e64 656c 7461  ) < params.delta
+0004be50: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0004be60: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+0004be70: 474d 4c5f 4f50 545f 4f4b 3b0a 2020 2020  GML_OPT_OK;.    
+0004be80: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0004be90: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0004bea0: 2020 2020 2020 2020 2070 665b 6b25 7061           pf[k%pa
+0004beb0: 7261 6d73 2e70 6173 745d 203d 2066 783b  rams.past] = fx;
+0004bec0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0004bed0: 2020 2020 2f2f 2063 6865 636b 2066 6f72      // check for
+0004bee0: 2069 6d70 726f 7665 6d65 6e74 0a20 2020   improvement.   
+0004bef0: 2020 2020 2069 6620 2870 6172 616d 732e       if (params.
+0004bf00: 6d61 785f 6e6f 5f69 6d70 726f 7665 6d65  max_no_improveme
+0004bf10: 6e74 203e 2030 2920 7b0a 2020 2020 2020  nt > 0) {.      
+0004bf20: 2020 2020 2020 6966 2028 6678 203c 2066        if (fx < f
+0004bf30: 785f 6265 7374 2920 7b0a 2020 2020 2020  x_best) {.      
+0004bf40: 2020 2020 2020 2020 2020 6678 5f62 6573            fx_bes
+0004bf50: 7420 3d20 6678 3b0a 2020 2020 2020 2020  t = fx;.        
+0004bf60: 2020 2020 2020 2020 6e5f 6e6f 5f69 6d70          n_no_imp
+0004bf70: 726f 7665 6d65 6e74 203d 2030 3b0a 2020  rovement = 0;.  
+0004bf80: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+0004bf90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0004bfa0: 2020 206e 5f6e 6f5f 696d 7072 6f76 656d     n_no_improvem
+0004bfb0: 656e 742b 2b3b 0a0a 2020 2020 2020 2020  ent++;..        
+0004bfc0: 2020 2020 2020 2020 6966 2028 6e5f 6e6f          if (n_no
+0004bfd0: 5f69 6d70 726f 7665 6d65 6e74 203e 3d20  _improvement >= 
+0004bfe0: 7061 7261 6d73 2e6d 6178 5f6e 6f5f 696d  params.max_no_im
+0004bff0: 7072 6f76 656d 656e 7429 207b 0a20 2020  provement) {.   
+0004c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c010: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
+0004c020: 5f4f 4b3b 0a20 2020 2020 2020 2020 2020  _OK;.           
+0004c030: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0004c040: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+0004c050: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
+0004c060: 6d73 2e6c 6266 6773 2e6e 5f69 7465 7220  ms.lbfgs.n_iter 
+0004c070: 213d 2030 2026 2620 7061 7261 6d73 2e6c  != 0 && params.l
+0004c080: 6266 6773 2e6e 5f69 7465 7220 3c20 6b20  bfgs.n_iter < k 
+0004c090: 2b20 3129 207b 0a20 2020 2020 2020 2020  + 1) {.         
+0004c0a0: 2020 202f 2f20 7265 6163 6865 6420 7468     // reached th
+0004c0b0: 6520 6d61 7869 6d75 6d20 6e75 6d62 6572  e maximum number
+0004c0c0: 206f 6620 6974 6572 6174 696f 6e73 0a20   of iterations. 
+0004c0d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0004c0e0: 6e20 4747 4d4c 5f4f 5054 5f44 4944 5f4e  n GGML_OPT_DID_N
+0004c0f0: 4f54 5f43 4f4e 5645 5247 453b 0a20 2020  OT_CONVERGE;.   
+0004c100: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0004c110: 2f2f 2075 7064 6174 6520 7665 6374 6f72  // update vector
+0004c120: 7320 7320 616e 6420 793a 0a20 2020 2020  s s and y:.     
+0004c130: 2020 202f 2f20 2020 735f 7b6b 2b31 7d20     //   s_{k+1} 
+0004c140: 3d20 785f 7b6b 2b31 7d20 2d20 785f 7b6b  = x_{k+1} - x_{k
+0004c150: 7d20 3d20 5c73 7465 7020 2a20 645f 7b6b  } = \step * d_{k
+0004c160: 7d2e 0a20 2020 2020 2020 202f 2f20 2020  }..        //   
+0004c170: 795f 7b6b 2b31 7d20 3d20 675f 7b6b 2b31  y_{k+1} = g_{k+1
+0004c180: 7d20 2d20 675f 7b6b 7d2e 0a20 2020 2020  } - g_{k}..     
+0004c190: 2020 202f 2f0a 2020 2020 2020 2020 6767     //.        gg
+0004c1a0: 6d6c 5f76 6563 5f73 7562 5f66 3332 286e  ml_vec_sub_f32(n
+0004c1b0: 782c 206c 6d5b 656e 645d 2e73 2c20 782c  x, lm[end].s, x,
+0004c1c0: 2078 7029 3b0a 2020 2020 2020 2020 6767   xp);.        gg
+0004c1d0: 6d6c 5f76 6563 5f73 7562 5f66 3332 286e  ml_vec_sub_f32(n
+0004c1e0: 782c 206c 6d5b 656e 645d 2e79 2c20 672c  x, lm[end].y, g,
+0004c1f0: 2067 7029 3b0a 0a20 2020 2020 2020 202f   gp);..        /
+0004c200: 2f20 636f 6d70 7574 6520 7363 616c 6172  / compute scalar
+0004c210: 7320 7973 2061 6e64 2079 793a 0a20 2020  s ys and yy:.   
+0004c220: 2020 2020 202f 2f20 2020 2020 7973 203d       //     ys =
+0004c230: 2079 5e74 205c 6364 6f74 2073 2020 2020   y^t \cdot s    
+0004c240: 2d3e 2031 202f 205c 7268 6f2e 0a20 2020  -> 1 / \rho..   
+0004c250: 2020 2020 202f 2f20 2020 2020 7979 203d       //     yy =
+0004c260: 2079 5e74 205c 6364 6f74 2079 2e0a 2020   y^t \cdot y..  
+0004c270: 2020 2020 2020 2f2f 0a20 2020 2020 2020        //.       
+0004c280: 2067 676d 6c5f 7665 635f 646f 745f 6633   ggml_vec_dot_f3
+0004c290: 3228 6e78 2c20 2679 732c 206c 6d5b 656e  2(nx, &ys, lm[en
+0004c2a0: 645d 2e79 2c20 6c6d 5b65 6e64 5d2e 7329  d].y, lm[end].s)
+0004c2b0: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
+0004c2c0: 6563 5f64 6f74 5f66 3332 286e 782c 2026  ec_dot_f32(nx, &
+0004c2d0: 7979 2c20 6c6d 5b65 6e64 5d2e 792c 206c  yy, lm[end].y, l
+0004c2e0: 6d5b 656e 645d 2e79 293b 0a0a 2020 2020  m[end].y);..    
+0004c2f0: 2020 2020 6c6d 5b65 6e64 5d2e 7973 203d      lm[end].ys =
+0004c300: 2079 733b 0a0a 2020 2020 2020 2020 2f2f   ys;..        //
+0004c310: 2066 696e 6420 6e65 7720 7365 6172 6368   find new search
+0004c320: 2064 6972 6563 7469 6f6e 0a20 2020 2020   direction.     
+0004c330: 2020 202f 2f20 2020 7265 663a 2068 7474     //   ref: htt
+0004c340: 7073 3a2f 2f65 6e2e 7769 6b69 7065 6469  ps://en.wikipedi
+0004c350: 612e 6f72 672f 7769 6b69 2f4c 696d 6974  a.org/wiki/Limit
+0004c360: 6564 2d6d 656d 6f72 795f 4246 4753 0a0a  ed-memory_BFGS..
+0004c370: 2020 2020 2020 2020 626f 756e 6420 3d20          bound = 
+0004c380: 286d 203c 3d20 6b29 203f 206d 203a 206b  (m <= k) ? m : k
+0004c390: 3b0a 2020 2020 2020 2020 6b2b 2b3b 0a20  ;.        k++;. 
+0004c3a0: 2020 2020 2020 2065 6e64 203d 2028 656e         end = (en
+0004c3b0: 6420 2b20 3129 256d 3b0a 0a20 2020 2020  d + 1)%m;..     
+0004c3c0: 2020 202f 2f20 696e 6974 6961 6c69 7a65     // initialize
+0004c3d0: 2073 6561 7263 6820 6469 7265 6374 696f   search directio
+0004c3e0: 6e20 7769 7468 202d 670a 2020 2020 2020  n with -g.      
+0004c3f0: 2020 6767 6d6c 5f76 6563 5f6e 6567 5f66    ggml_vec_neg_f
+0004c400: 3332 286e 782c 2064 2c20 6729 3b0a 0a20  32(nx, d, g);.. 
+0004c410: 2020 2020 2020 206a 203d 2065 6e64 3b0a         j = end;.
+0004c420: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0004c430: 2069 203d 2030 3b20 6920 3c20 626f 756e   i = 0; i < boun
+0004c440: 643b 202b 2b69 2920 7b0a 2020 2020 2020  d; ++i) {.      
+0004c450: 2020 2020 2020 6a20 3d20 286a 202b 206d        j = (j + m
+0004c460: 202d 2031 2920 2520 6d3b 0a20 2020 2020   - 1) % m;.     
+0004c470: 2020 2020 2020 202f 2f20 5c61 6c70 6861         // \alpha
+0004c480: 5f7b 6a7d 203d 205c 7268 6f5f 7b6a 7d20  _{j} = \rho_{j} 
+0004c490: 735e 7b74 7d5f 7b6a 7d20 5c63 646f 7420  s^{t}_{j} \cdot 
+0004c4a0: 715f 7b6b 2b31 7d0a 2020 2020 2020 2020  q_{k+1}.        
+0004c4b0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+0004c4c0: 5f66 3332 286e 782c 2026 6c6d 5b6a 5d2e  _f32(nx, &lm[j].
+0004c4d0: 616c 7068 612c 206c 6d5b 6a5d 2e73 2c20  alpha, lm[j].s, 
+0004c4e0: 6429 3b0a 2020 2020 2020 2020 2020 2020  d);.            
+0004c4f0: 6c6d 5b6a 5d2e 616c 7068 6120 2f3d 206c  lm[j].alpha /= l
+0004c500: 6d5b 6a5d 2e79 733b 0a20 2020 2020 2020  m[j].ys;.       
+0004c510: 2020 2020 202f 2f20 715f 7b69 7d20 3d20       // q_{i} = 
+0004c520: 715f 7b69 2b31 7d20 2d20 5c61 6c70 6861  q_{i+1} - \alpha
+0004c530: 5f7b 697d 2079 5f7b 697d 0a20 2020 2020  _{i} y_{i}.     
+0004c540: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0004c550: 6d61 645f 6633 3228 6e78 2c20 642c 206c  mad_f32(nx, d, l
+0004c560: 6d5b 6a5d 2e79 2c20 2d6c 6d5b 6a5d 2e61  m[j].y, -lm[j].a
+0004c570: 6c70 6861 293b 0a20 2020 2020 2020 207d  lpha);.        }
+0004c580: 0a0a 2020 2020 2020 2020 6767 6d6c 5f76  ..        ggml_v
+0004c590: 6563 5f73 6361 6c65 5f66 3332 286e 782c  ec_scale_f32(nx,
+0004c5a0: 2064 2c20 7973 2f79 7929 3b0a 0a20 2020   d, ys/yy);..   
+0004c5b0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+0004c5c0: 3d20 303b 2069 203c 2062 6f75 6e64 3b20  = 0; i < bound; 
+0004c5d0: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
+0004c5e0: 2020 202f 2f20 5c62 6574 615f 7b6a 7d20     // \beta_{j} 
+0004c5f0: 3d20 5c72 686f 5f7b 6a7d 2079 5e74 5f7b  = \rho_{j} y^t_{
+0004c600: 6a7d 205c 6364 6f74 205c 6761 6d6d 615f  j} \cdot \gamma_
+0004c610: 7b69 7d0a 2020 2020 2020 2020 2020 2020  {i}.            
+0004c620: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
+0004c630: 286e 782c 2026 6265 7461 2c20 6c6d 5b6a  (nx, &beta, lm[j
+0004c640: 5d2e 792c 2064 293b 0a20 2020 2020 2020  ].y, d);.       
+0004c650: 2020 2020 2062 6574 6120 2f3d 206c 6d5b       beta /= lm[
+0004c660: 6a5d 2e79 733b 0a20 2020 2020 2020 2020  j].ys;.         
+0004c670: 2020 202f 2f20 5c67 616d 6d61 5f7b 692b     // \gamma_{i+
+0004c680: 317d 203d 205c 6761 6d6d 615f 7b69 7d20  1} = \gamma_{i} 
+0004c690: 2b20 285c 616c 7068 615f 7b6a 7d20 2d20  + (\alpha_{j} - 
+0004c6a0: 5c62 6574 615f 7b6a 7d29 2073 5f7b 6a7d  \beta_{j}) s_{j}
+0004c6b0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0004c6c0: 6c5f 7665 635f 6d61 645f 6633 3228 6e78  l_vec_mad_f32(nx
+0004c6d0: 2c20 642c 206c 6d5b 6a5d 2e73 2c20 6c6d  , d, lm[j].s, lm
+0004c6e0: 5b6a 5d2e 616c 7068 6120 2d20 6265 7461  [j].alpha - beta
+0004c6f0: 293b 0a20 2020 2020 2020 2020 2020 206a  );.            j
+0004c700: 203d 2028 6a20 2b20 3129 256d 3b0a 2020   = (j + 1)%m;.  
+0004c710: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0004c720: 2073 7465 7020 3d20 312e 303b 0a20 2020   step = 1.0;.   
+0004c730: 207d 0a0a 2020 2020 7265 7475 726e 2047   }..    return G
+0004c740: 474d 4c5f 4f50 545f 4449 445f 4e4f 545f  GML_OPT_DID_NOT_
+0004c750: 434f 4e56 4552 4745 3b0a 7d0a 0a73 7472  CONVERGE;.}..str
+0004c760: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
+0004c770: 616d 7320 6767 6d6c 5f6f 7074 5f64 6566  ams ggml_opt_def
+0004c780: 6175 6c74 5f70 6172 616d 7328 656e 756d  ault_params(enum
+0004c790: 2067 676d 6c5f 6f70 745f 7479 7065 2074   ggml_opt_type t
+0004c7a0: 7970 6529 207b 0a20 2020 2073 7472 7563  ype) {.    struc
+0004c7b0: 7420 6767 6d6c 5f6f 7074 5f70 6172 616d  t ggml_opt_param
+0004c7c0: 7320 7265 7375 6c74 3b0a 0a20 2020 2073  s result;..    s
+0004c7d0: 7769 7463 6820 2874 7970 6529 207b 0a20  witch (type) {. 
+0004c7e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0004c7f0: 5f4f 5054 5f41 4441 4d3a 0a20 2020 2020  _OPT_ADAM:.     
+0004c800: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0004c810: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+0004c820: 3d20 2873 7472 7563 7420 6767 6d6c 5f6f  = (struct ggml_o
+0004c830: 7074 5f70 6172 616d 7329 207b 0a20 2020  pt_params) {.   
+0004c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c850: 202e 7479 7065 2020 2020 2020 3d20 4747   .type      = GG
+0004c860: 4d4c 5f4f 5054 5f41 4441 4d2c 0a20 2020  ML_OPT_ADAM,.   
+0004c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c880: 202e 6e5f 7468 7265 6164 7320 3d20 312c   .n_threads = 1,
+0004c890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c8a0: 2020 2020 202e 7061 7374 2020 2020 2020       .past      
+0004c8b0: 3d20 302c 0a20 2020 2020 2020 2020 2020  = 0,.           
+0004c8c0: 2020 2020 2020 2020 202e 6465 6c74 6120           .delta 
+0004c8d0: 2020 2020 3d20 3165 2d35 662c 0a0a 2020      = 1e-5f,..  
+0004c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c8f0: 2020 2e6d 6178 5f6e 6f5f 696d 7072 6f76    .max_no_improv
+0004c900: 656d 656e 7420 3d20 3130 302c 0a0a 2020  ement = 100,..  
+0004c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c920: 2020 2e70 7269 6e74 5f66 6f72 7761 7264    .print_forward
+0004c930: 5f67 7261 7068 2020 3d20 7472 7565 2c0a  _graph  = true,.
+0004c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c950: 2020 2020 2e70 7269 6e74 5f62 6163 6b77      .print_backw
+0004c960: 6172 645f 6772 6170 6820 3d20 7472 7565  ard_graph = true
+0004c970: 2c0a 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0004c980: 2020 2020 2020 202e 6164 616d 203d 207b         .adam = {
+0004c990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c9a0: 2020 2020 2020 2020 202e 6e5f 6974 6572           .n_iter
+0004c9b0: 203d 2031 3030 3030 2c0a 2020 2020 2020   = 10000,.      
+0004c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c9d0: 2020 2e61 6c70 6861 2020 3d20 302e 3030    .alpha  = 0.00
+0004c9e0: 3166 2c0a 2020 2020 2020 2020 2020 2020  1f,.            
+0004c9f0: 2020 2020 2020 2020 2020 2020 2e62 6574              .bet
+0004ca00: 6131 2020 3d20 302e 3966 2c0a 2020 2020  a1  = 0.9f,.    
+0004ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ca20: 2020 2020 2e62 6574 6132 2020 3d20 302e      .beta2  = 0.
+0004ca30: 3939 3966 2c0a 2020 2020 2020 2020 2020  999f,.          
+0004ca40: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
+0004ca50: 7073 2020 2020 3d20 3165 2d38 662c 0a20  ps    = 1e-8f,. 
+0004ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ca70: 2020 2020 2020 202e 6570 735f 6620 203d         .eps_f  =
+0004ca80: 2031 652d 3566 2c0a 2020 2020 2020 2020   1e-5f,.        
+0004ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004caa0: 2e65 7073 5f67 2020 3d20 3165 2d33 662c  .eps_g  = 1e-3f,
+0004cab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cac0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0004cad0: 2020 2020 2020 2020 7d3b 0a20 2020 2020          };.     
+0004cae0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0004caf0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0004cb00: 4c5f 4f50 545f 4c42 4647 533a 0a20 2020  L_OPT_LBFGS:.   
+0004cb10: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0004cb20: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0004cb30: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
+0004cb40: 5f6f 7074 5f70 6172 616d 7329 207b 0a20  _opt_params) {. 
+0004cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cb60: 2020 202e 7479 7065 2020 2020 2020 3d20     .type      = 
+0004cb70: 4747 4d4c 5f4f 5054 5f4c 4246 4753 2c0a  GGML_OPT_LBFGS,.
+0004cb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cb90: 2020 2020 2e6e 5f74 6872 6561 6473 203d      .n_threads =
+0004cba0: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+0004cbb0: 2020 2020 2020 2020 2e70 6173 7420 2020          .past   
+0004cbc0: 2020 203d 2030 2c0a 2020 2020 2020 2020     = 0,.        
+0004cbd0: 2020 2020 2020 2020 2020 2020 2e64 656c              .del
+0004cbe0: 7461 2020 2020 203d 2031 652d 3566 2c0a  ta     = 1e-5f,.
+0004cbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cc00: 2020 2020 202e 6d61 785f 6e6f 5f69 6d70       .max_no_imp
+0004cc10: 726f 7665 6d65 6e74 203d 2030 2c0a 0a20  rovement = 0,.. 
+0004cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cc30: 2020 202e 7072 696e 745f 666f 7277 6172     .print_forwar
+0004cc40: 645f 6772 6170 6820 203d 2074 7275 652c  d_graph  = true,
+0004cc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cc60: 2020 2020 202e 7072 696e 745f 6261 636b       .print_back
+0004cc70: 7761 7264 5f67 7261 7068 203d 2074 7275  ward_graph = tru
+0004cc80: 652c 0a0a 2020 2020 2020 2020 2020 2020  e,..            
+0004cc90: 2020 2020 2020 2020 2e6c 6266 6773 203d          .lbfgs =
+0004cca0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0004ccb0: 2020 2020 2020 2020 2020 202e 6d20 2020             .m   
+0004ccc0: 2020 2020 2020 2020 2020 203d 2036 2c0a             = 6,.
+0004ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cce0: 2020 2020 2020 2020 2e6e 5f69 7465 7220          .n_iter 
+0004ccf0: 2020 2020 2020 2020 3d20 3130 302c 0a20          = 100,. 
+0004cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cd10: 2020 2020 2020 202e 6d61 785f 6c69 6e65         .max_line
+0004cd20: 7365 6172 6368 203d 2032 302c 0a0a 2020  search = 20,..  
+0004cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cd40: 2020 2020 2020 2e65 7073 2020 2020 2020        .eps      
+0004cd50: 3d20 3165 2d35 662c 0a20 2020 2020 2020  = 1e-5f,.       
+0004cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cd70: 202e 6674 6f6c 2020 2020 203d 2031 652d   .ftol     = 1e-
+0004cd80: 3466 2c0a 2020 2020 2020 2020 2020 2020  4f,.            
+0004cd90: 2020 2020 2020 2020 2020 2020 2e77 6f6c              .wol
+0004cda0: 6665 2020 2020 3d20 302e 3966 2c0a 2020  fe    = 0.9f,.  
+0004cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cdc0: 2020 2020 2020 2e6d 696e 5f73 7465 7020        .min_step 
+0004cdd0: 3d20 3165 2d32 3066 2c0a 2020 2020 2020  = 1e-20f,.      
+0004cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cdf0: 2020 2e6d 6178 5f73 7465 7020 3d20 3165    .max_step = 1e
+0004ce00: 2b32 3066 2c0a 0a20 2020 2020 2020 2020  +20f,..         
+0004ce10: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0004ce20: 6c69 6e65 7365 6172 6368 203d 2047 474d  linesearch = GGM
+0004ce30: 4c5f 4c49 4e45 5345 4152 4348 5f44 4546  L_LINESEARCH_DEF
+0004ce40: 4155 4c54 2c0a 2020 2020 2020 2020 2020  AULT,.          
+0004ce50: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0004ce60: 2020 2020 2020 2020 2020 2020 207d 3b0a               };.
+0004ce70: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0004ce80: 6561 6b3b 0a20 2020 207d 0a0a 2020 2020  eak;.    }..    
+0004ce90: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+0004cea0: 0a0a 656e 756d 2067 676d 6c5f 6f70 745f  ..enum ggml_opt_
+0004ceb0: 7265 7375 6c74 2067 676d 6c5f 6f70 7428  result ggml_opt(
+0004cec0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0004ced0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0004cee0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0004cef0: 6374 2067 676d 6c5f 6f70 745f 7061 7261  ct ggml_opt_para
+0004cf00: 6d73 2070 6172 616d 732c 0a20 2020 2020  ms params,.     
+0004cf10: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0004cf20: 656e 736f 7220 2a20 6629 207b 0a20 2020  ensor * f) {.   
+0004cf30: 2062 6f6f 6c20 6672 6565 5f63 7478 203d   bool free_ctx =
+0004cf40: 2066 616c 7365 3b0a 2020 2020 6966 2028   false;.    if (
+0004cf50: 6374 7820 3d3d 204e 554c 4c29 207b 0a20  ctx == NULL) {. 
+0004cf60: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0004cf70: 6d6c 5f69 6e69 745f 7061 7261 6d73 2070  ml_init_params p
+0004cf80: 6172 616d 735f 6374 7820 3d20 7b0a 2020  arams_ctx = {.  
+0004cf90: 2020 2020 2020 2020 2020 2e6d 656d 5f73            .mem_s
+0004cfa0: 697a 6520 2020 3d20 3136 2a31 3032 342a  ize   = 16*1024*
+0004cfb0: 3130 3234 2c0a 2020 2020 2020 2020 2020  1024,.          
+0004cfc0: 2020 2e6d 656d 5f62 7566 6665 7220 3d20    .mem_buffer = 
+0004cfd0: 4e55 4c4c 2c0a 2020 2020 2020 2020 7d3b  NULL,.        };
+0004cfe0: 0a0a 2020 2020 2020 2020 6374 7820 3d20  ..        ctx = 
+0004cff0: 6767 6d6c 5f69 6e69 7428 7061 7261 6d73  ggml_init(params
+0004d000: 5f63 7478 293b 0a20 2020 2020 2020 2069  _ctx);.        i
+0004d010: 6620 2863 7478 203d 3d20 4e55 4c4c 2920  f (ctx == NULL) 
+0004d020: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+0004d030: 7475 726e 2047 474d 4c5f 4f50 545f 4e4f  turn GGML_OPT_NO
+0004d040: 5f43 4f4e 5445 5854 3b0a 2020 2020 2020  _CONTEXT;.      
+0004d050: 2020 7d0a 0a20 2020 2020 2020 2066 7265    }..        fre
+0004d060: 655f 6374 7820 3d20 7472 7565 3b0a 2020  e_ctx = true;.  
+0004d070: 2020 7d0a 0a20 2020 2065 6e75 6d20 6767    }..    enum gg
+0004d080: 6d6c 5f6f 7074 5f72 6573 756c 7420 7265  ml_opt_result re
+0004d090: 7375 6c74 203d 2047 474d 4c5f 4f50 545f  sult = GGML_OPT_
+0004d0a0: 4f4b 3b0a 0a20 2020 202f 2f20 6275 696c  OK;..    // buil
+0004d0b0: 6420 666f 7277 6172 6420 2b20 6261 636b  d forward + back
+0004d0c0: 7761 7264 2063 6f6d 7075 7465 2067 7261  ward compute gra
+0004d0d0: 7068 730a 2020 2020 7374 7275 6374 2067  phs.    struct g
+0004d0e0: 676d 6c5f 6367 7261 7068 2067 6620 3d20  gml_cgraph gf = 
+0004d0f0: 6767 6d6c 5f62 7569 6c64 5f66 6f72 7761  ggml_build_forwa
+0004d100: 7264 2028 6629 3b0a 2020 2020 7374 7275  rd (f);.    stru
+0004d110: 6374 2067 676d 6c5f 6367 7261 7068 2067  ct ggml_cgraph g
+0004d120: 6220 3d20 6767 6d6c 5f62 7569 6c64 5f62  b = ggml_build_b
+0004d130: 6163 6b77 6172 6428 6374 782c 2026 6766  ackward(ctx, &gf
+0004d140: 2c20 6661 6c73 6529 3b0a 0a20 2020 2073  , false);..    s
+0004d150: 7769 7463 6820 2870 6172 616d 732e 7479  witch (params.ty
+0004d160: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
+0004d170: 7365 2047 474d 4c5f 4f50 545f 4144 414d  se GGML_OPT_ADAM
+0004d180: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0004d190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d1a0: 7265 7375 6c74 203d 2067 676d 6c5f 6f70  result = ggml_op
+0004d1b0: 745f 6164 616d 2863 7478 2c20 7061 7261  t_adam(ctx, para
+0004d1c0: 6d73 2c20 662c 2026 6766 2c20 2667 6229  ms, f, &gf, &gb)
+0004d1d0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0004d1e0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0004d1f0: 6173 6520 4747 4d4c 5f4f 5054 5f4c 4246  ase GGML_OPT_LBF
+0004d200: 4753 3a0a 2020 2020 2020 2020 2020 2020  GS:.            
+0004d210: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0004d220: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
+0004d230: 6f70 745f 6c62 6667 7328 6374 782c 2070  opt_lbfgs(ctx, p
+0004d240: 6172 616d 732c 2066 2c20 2667 662c 2026  arams, f, &gf, &
+0004d250: 6762 293b 0a20 2020 2020 2020 2020 2020  gb);.           
+0004d260: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+0004d270: 0a20 2020 2069 6620 2870 6172 616d 732e  .    if (params.
+0004d280: 7072 696e 745f 666f 7277 6172 645f 6772  print_forward_gr
+0004d290: 6170 6829 207b 0a20 2020 2020 2020 2067  aph) {.        g
+0004d2a0: 676d 6c5f 6772 6170 685f 7072 696e 7420  gml_graph_print 
+0004d2b0: 2020 2826 6766 293b 0a20 2020 2020 2020    (&gf);.       
+0004d2c0: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
+0004d2d0: 5f64 6f74 2826 6766 2c20 4e55 4c4c 2c20  _dot(&gf, NULL, 
+0004d2e0: 226f 7074 2d66 6f72 7761 7264 2e64 6f74  "opt-forward.dot
+0004d2f0: 2229 3b0a 2020 2020 7d0a 0a20 2020 2069  ");.    }..    i
+0004d300: 6620 2870 6172 616d 732e 7072 696e 745f  f (params.print_
+0004d310: 6261 636b 7761 7264 5f67 7261 7068 2920  backward_graph) 
+0004d320: 7b0a 2020 2020 2020 2020 6767 6d6c 5f67  {.        ggml_g
+0004d330: 7261 7068 5f70 7269 6e74 2020 2028 2667  raph_print   (&g
+0004d340: 6229 3b0a 2020 2020 2020 2020 6767 6d6c  b);.        ggml
+0004d350: 5f67 7261 7068 5f64 756d 705f 646f 7428  _graph_dump_dot(
+0004d360: 2667 622c 2026 6766 2c20 226f 7074 2d62  &gb, &gf, "opt-b
+0004d370: 6163 6b77 6172 642e 646f 7422 293b 0a20  ackward.dot");. 
+0004d380: 2020 207d 0a0a 2020 2020 6966 2028 6672     }..    if (fr
+0004d390: 6565 5f63 7478 2920 7b0a 2020 2020 2020  ee_ctx) {.      
+0004d3a0: 2020 6767 6d6c 5f66 7265 6528 6374 7829    ggml_free(ctx)
+0004d3b0: 3b0a 2020 2020 7d0a 0a20 2020 2072 6574  ;.    }..    ret
+0004d3c0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+0004d3d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d3e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d3f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d400: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d410: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
+0004d420: 0a73 697a 655f 7420 6767 6d6c 5f71 7561  .size_t ggml_qua
+0004d430: 6e74 697a 655f 7134 5f30 2863 6f6e 7374  ntize_q4_0(const
+0004d440: 2066 6c6f 6174 202a 2073 7263 2c20 766f   float * src, vo
+0004d450: 6964 202a 2064 7374 2c20 696e 7420 6e2c  id * dst, int n,
+0004d460: 2069 6e74 206b 2c20 696e 7436 345f 7420   int k, int64_t 
+0004d470: 2a20 6869 7374 2920 7b0a 2020 2020 6173  * hist) {.    as
+0004d480: 7365 7274 286b 2025 2051 4b20 3d3d 2030  sert(k % QK == 0
+0004d490: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
+0004d4a0: 206e 6220 3d20 6b20 2f20 514b 3b0a 0a20   nb = k / QK;.. 
+0004d4b0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+0004d4c0: 303b 206a 203c 206e 3b20 6a20 2b3d 206b  0; j < n; j += k
+0004d4d0: 2920 7b0a 2020 2020 2020 2020 626c 6f63  ) {.        bloc
+0004d4e0: 6b5f 7134 5f30 202a 2072 6573 7472 6963  k_q4_0 * restric
+0004d4f0: 7420 7920 3d20 2862 6c6f 636b 5f71 345f  t y = (block_q4_
+0004d500: 3020 2a29 6473 7420 2b20 6a2f 514b 3b0a  0 *)dst + j/QK;.
+0004d510: 0a20 2020 2020 2020 2071 7561 6e74 697a  .        quantiz
+0004d520: 655f 726f 775f 7134 5f30 5f72 6566 6572  e_row_q4_0_refer
+0004d530: 656e 6365 2873 7263 202b 206a 2c20 792c  ence(src + j, y,
+0004d540: 206b 293b 0a0a 2020 2020 2020 2020 666f   k);..        fo
+0004d550: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0004d560: 3c20 6e62 3b20 692b 2b29 207b 0a20 2020  < nb; i++) {.   
+0004d570: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0004d580: 7420 6c20 3d20 303b 206c 203c 2051 4b3b  t l = 0; l < QK;
+0004d590: 206c 202b 3d20 3229 207b 0a20 2020 2020   l += 2) {.     
+0004d5a0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0004d5b0: 2075 696e 7438 5f74 2076 6930 203d 2079   uint8_t vi0 = y
+0004d5c0: 5b69 5d2e 7173 5b6c 2f32 5d20 2620 3078  [i].qs[l/2] & 0x
+0004d5d0: 463b 0a20 2020 2020 2020 2020 2020 2020  F;.             
+0004d5e0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
+0004d5f0: 2076 6931 203d 2079 5b69 5d2e 7173 5b6c   vi1 = y[i].qs[l
+0004d600: 2f32 5d20 3e3e 2034 3b0a 0a20 2020 2020  /2] >> 4;..     
+0004d610: 2020 2020 2020 2020 2020 2068 6973 745b             hist[
+0004d620: 7669 305d 2b2b 3b0a 2020 2020 2020 2020  vi0]++;.        
+0004d630: 2020 2020 2020 2020 6869 7374 5b76 6931          hist[vi1
+0004d640: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
+0004d650: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+0004d660: 207d 0a0a 2020 2020 7265 7475 726e 2028   }..    return (
+0004d670: 6e2f 514b 2a73 697a 656f 6628 626c 6f63  n/QK*sizeof(bloc
+0004d680: 6b5f 7134 5f30 2929 3b0a 7d0a 0a73 697a  k_q4_0));.}..siz
+0004d690: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
+0004d6a0: 655f 7134 5f31 2863 6f6e 7374 2066 6c6f  e_q4_1(const flo
+0004d6b0: 6174 202a 2073 7263 2c20 766f 6964 202a  at * src, void *
+0004d6c0: 2064 7374 2c20 696e 7420 6e2c 2069 6e74   dst, int n, int
+0004d6d0: 206b 2c20 696e 7436 345f 7420 2a20 6869   k, int64_t * hi
+0004d6e0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
+0004d6f0: 286b 2025 2051 4b20 3d3d 2030 293b 0a20  (k % QK == 0);. 
+0004d700: 2020 2063 6f6e 7374 2069 6e74 206e 6220     const int nb 
+0004d710: 3d20 6b20 2f20 514b 3b0a 0a20 2020 2066  = k / QK;..    f
+0004d720: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+0004d730: 203c 206e 3b20 6a20 2b3d 206b 2920 7b0a   < n; j += k) {.
+0004d740: 2020 2020 2020 2020 626c 6f63 6b5f 7134          block_q4
+0004d750: 5f31 202a 2072 6573 7472 6963 7420 7920  _1 * restrict y 
+0004d760: 3d20 2862 6c6f 636b 5f71 345f 3120 2a29  = (block_q4_1 *)
+0004d770: 6473 7420 2b20 6a2f 514b 3b0a 0a20 2020  dst + j/QK;..   
+0004d780: 2020 2020 2071 7561 6e74 697a 655f 726f       quantize_ro
+0004d790: 775f 7134 5f31 5f72 6566 6572 656e 6365  w_q4_1_reference
+0004d7a0: 2873 7263 202b 206a 2c20 792c 206b 293b  (src + j, y, k);
+0004d7b0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+0004d7c0: 6e74 2069 203d 2030 3b20 6920 3c20 6e62  nt i = 0; i < nb
+0004d7d0: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0004d7e0: 2020 2020 2066 6f72 2028 696e 7420 6c20       for (int l 
+0004d7f0: 3d20 303b 206c 203c 2051 4b3b 206c 202b  = 0; l < QK; l +
+0004d800: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
+0004d810: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+0004d820: 7438 5f74 2076 6930 203d 2079 5b69 5d2e  t8_t vi0 = y[i].
+0004d830: 7173 5b6c 2f32 5d20 2620 3078 463b 0a20  qs[l/2] & 0xF;. 
+0004d840: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0004d850: 6f6e 7374 2075 696e 7438 5f74 2076 6931  onst uint8_t vi1
+0004d860: 203d 2079 5b69 5d2e 7173 5b6c 2f32 5d20   = y[i].qs[l/2] 
+0004d870: 3e3e 2034 3b0a 0a20 2020 2020 2020 2020  >> 4;..         
+0004d880: 2020 2020 2020 2068 6973 745b 7669 305d         hist[vi0]
+0004d890: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
+0004d8a0: 2020 2020 6869 7374 5b76 6931 5d2b 2b3b      hist[vi1]++;
+0004d8b0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0004d8c0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+0004d8d0: 2020 2020 7265 7475 726e 2028 6e2f 514b      return (n/QK
+0004d8e0: 2a73 697a 656f 6628 626c 6f63 6b5f 7134  *sizeof(block_q4
+0004d8f0: 5f31 2929 3b0a 7d0a 0a2f 2f2f 2f2f 2f2f  _1));.}..///////
+0004d900: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d910: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d920: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d930: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004d940: 2f2f 2f2f 2f2f 2f2f 2f0a 0a69 6e74 2067  /////////..int g
+0004d950: 676d 6c5f 6370 755f 6861 735f 6176 7828  gml_cpu_has_avx(
+0004d960: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+0004d970: 6e65 6428 5f5f 4156 585f 5f29 0a20 2020  ned(__AVX__).   
+0004d980: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+0004d990: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+0004d9a0: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+0004d9b0: 6c5f 6370 755f 6861 735f 6176 7832 2876  l_cpu_has_avx2(v
+0004d9c0: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
+0004d9d0: 6564 285f 5f41 5658 325f 5f29 0a20 2020  ed(__AVX2__).   
+0004d9e0: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+0004d9f0: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+0004da00: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+0004da10: 6c5f 6370 755f 6861 735f 6176 7835 3132  l_cpu_has_avx512
+0004da20: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
+0004da30: 696e 6564 285f 5f41 5658 3531 3246 5f5f  ined(__AVX512F__
+0004da40: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+0004da50: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+0004da60: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+0004da70: 7420 6767 6d6c 5f63 7075 5f68 6173 5f66  t ggml_cpu_has_f
+0004da80: 6d61 2876 6f69 6429 207b 0a23 6966 2064  ma(void) {.#if d
+0004da90: 6566 696e 6564 285f 5f46 4d41 5f5f 290a  efined(__FMA__).
+0004daa0: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+0004dab0: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+0004dac0: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+0004dad0: 6767 6d6c 5f63 7075 5f68 6173 5f6e 656f  ggml_cpu_has_neo
+0004dae0: 6e28 766f 6964 2920 7b0a 2369 6620 6465  n(void) {.#if de
+0004daf0: 6669 6e65 6428 5f5f 4152 4d5f 4e45 4f4e  fined(__ARM_NEON
+0004db00: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+0004db10: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+0004db20: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+0004db30: 7420 6767 6d6c 5f63 7075 5f68 6173 5f61  t ggml_cpu_has_a
+0004db40: 726d 5f66 6d61 2876 6f69 6429 207b 0a23  rm_fma(void) {.#
+0004db50: 6966 2064 6566 696e 6564 285f 5f41 524d  if defined(__ARM
+0004db60: 5f46 4541 5455 5245 5f46 4d41 290a 2020  _FEATURE_FMA).  
+0004db70: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
+0004db80: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
+0004db90: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
+0004dba0: 6d6c 5f63 7075 5f68 6173 5f66 3136 6328  ml_cpu_has_f16c(
+0004dbb0: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+0004dbc0: 6e65 6428 5f5f 4631 3643 5f5f 290a 2020  ned(__F16C__).  
+0004dbd0: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
+0004dbe0: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
+0004dbf0: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
+0004dc00: 6d6c 5f63 7075 5f68 6173 5f66 7031 365f  ml_cpu_has_fp16_
+0004dc10: 7661 2876 6f69 6429 207b 0a23 6966 2064  va(void) {.#if d
+0004dc20: 6566 696e 6564 285f 5f41 524d 5f46 4541  efined(__ARM_FEA
+0004dc30: 5455 5245 5f46 5031 365f 5645 4354 4f52  TURE_FP16_VECTOR
+0004dc40: 5f41 5249 5448 4d45 5449 4329 0a20 2020  _ARITHMETIC).   
+0004dc50: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+0004dc60: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+0004dc70: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+0004dc80: 6c5f 6370 755f 6861 735f 7761 736d 5f73  l_cpu_has_wasm_s
+0004dc90: 696d 6428 766f 6964 2920 7b0a 2369 6620  imd(void) {.#if 
+0004dca0: 6465 6669 6e65 6428 5f5f 7761 736d 5f73  defined(__wasm_s
+0004dcb0: 696d 6431 3238 5f5f 290a 2020 2020 7265  imd128__).    re
+0004dcc0: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
+0004dcd0: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
+0004dce0: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
+0004dcf0: 7075 5f68 6173 5f62 6c61 7328 766f 6964  pu_has_blas(void
+0004dd00: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
+0004dd10: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
+0004dd20: 4154 4529 207c 7c20 6465 6669 6e65 6428  ATE) || defined(
+0004dd30: 4747 4d4c 5f55 5345 5f4f 5045 4e42 4c41  GGML_USE_OPENBLA
+0004dd40: 5329 0a20 2020 2072 6574 7572 6e20 313b  S).    return 1;
+0004dd50: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+0004dd60: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+0004dd70: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+0004dd80: 7373 6533 2876 6f69 6429 207b 0a23 6966  sse3(void) {.#if
+0004dd90: 2064 6566 696e 6564 285f 5f53 5345 335f   defined(__SSE3_
+0004dda0: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
+0004ddb0: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+0004ddc0: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+0004ddd0: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+0004dde0: 7673 7828 766f 6964 2920 7b0a 2369 6620  vsx(void) {.#if 
+0004ddf0: 6465 6669 6e65 6428 5f5f 504f 5745 5239  defined(__POWER9
+0004de00: 5f56 4543 544f 525f 5f29 0a20 2020 2072  _VECTOR__).    r
+0004de10: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+0004de20: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+0004de30: 6469 660a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f  dif.}../////////
+0004de40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004de50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004de60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004de70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0004de80: 2f2f 2f2f 2f2f 2f0a                      ///////.
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/ggml.h` & `llamacpp-0.1.9/vendor/llama.cpp/ggml.h`

 * *Files 1% similar despite different names*

```diff
@@ -339,14 +339,17 @@
 struct ggml_context * ggml_init(struct ggml_init_params params);
 void ggml_free(struct ggml_context * ctx);
 
 size_t ggml_used_mem(const struct ggml_context * ctx);
 
 size_t ggml_set_scratch(struct ggml_context * ctx, struct ggml_scratch scratch);
 
+bool ggml_mlock_supported(void);
+bool ggml_mlock(struct ggml_context * ctx, char ** err_p);
+
 struct ggml_tensor * ggml_new_tensor(
         struct ggml_context * ctx,
         enum   ggml_type type,
         int    n_dims,
         const int *ne);
 
 struct ggml_tensor * ggml_new_tensor_1d(
@@ -738,14 +741,21 @@
 // optimize the function defined by the tensor f
 enum ggml_opt_result ggml_opt(
         struct ggml_context * ctx,
         struct ggml_opt_params params,
         struct ggml_tensor * f);
 
 //
+// quantization
+//
+
+size_t ggml_quantize_q4_0(const float * src, void * dst, int n, int k, int64_t * hist);
+size_t ggml_quantize_q4_1(const float * src, void * dst, int n, int k, int64_t * hist);
+
+//
 // system info
 //
 
 int ggml_cpu_has_avx(void);
 int ggml_cpu_has_avx2(void);
 int ggml_cpu_has_avx512(void);
 int ggml_cpu_has_fma(void);
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/llama.cpp` & `llamacpp-0.1.9/vendor/llama.cpp/llama.cpp`

 * *Files 20% similar despite different names*

```diff
@@ -1,43 +1,99 @@
 #include "llama.h"
+
 #include "ggml.h"
 
-#include <cassert>
-#include <cmath>
-#include <cstdio>
-#include <cstring>
+#include <cinttypes>
 #include <fstream>
+#include <random>
 #include <map>
-#include <string>
-#include <vector>
+#include <unordered_map>
+#include <queue>
 #include <regex>
-#include <optional>
+#include <cassert>
+#include <cstring>
 
-// TODO: move somewhere else
-#define QK 32
+#define LLAMA_USE_SCRATCH
+#define LLAMA_MAX_SCRATCH_BUFFERS 16
+
+#define LLAMA_ASSERT(x) \
+    do { \
+        if (!(x)) { \
+            fprintf(stderr, "LLAMA_ASSERT: %s:%d: %s\n", __FILE__, __LINE__, #x); \
+            abort(); \
+        } \
+    } while (0)
 
-// Define std::make_unique if it's not available
-// (e.g. on C++11)
-#ifndef __cpp_lib_make_unique
-template<typename T, typename... Args>
-std::unique_ptr<T> make_unique(Args&&... args) {
-    return std::unique_ptr<T>(new T(std::forward<Args>(args)...));
-}
-#else
-using std::make_unique;
-#endif
 
 // determine number of model parts based on the dimension
-static const std::map<int, int> LLAMA_N_PARTS = {
+static const std::unordered_map<int, int> LLAMA_N_PARTS = {
     { 4096, 1 },
     { 5120, 2 },
     { 6656, 4 },
     { 8192, 8 },
 };
 
+// available llama models
+enum e_model {
+    MODEL_UNKNOWN,
+    MODEL_7B,
+    MODEL_13B,
+    MODEL_30B,
+    MODEL_65B,
+};
+
+static const size_t MB = 1024*1024;
+
+// computed for n_ctx == 2048
+// TODO: dynamically determine these sizes
+//       needs modifications in ggml
+
+static const std::map<e_model, size_t> MEM_REQ_SCRATCH0 = {
+    { MODEL_7B,    512ull*MB },
+    { MODEL_13B,   512ull*MB },
+    { MODEL_30B,   512ull*MB },
+    { MODEL_65B,   512ull*MB },
+};
+
+static const std::map<e_model, size_t> MEM_REQ_SCRATCH1 = {
+    { MODEL_7B,    512ull*MB },
+    { MODEL_13B,   512ull*MB },
+    { MODEL_30B,   512ull*MB },
+    { MODEL_65B,   512ull*MB },
+};
+
+// 2*n_embd*n_ctx*n_layer*sizeof(float16)
+static const std::map<e_model, size_t> MEM_REQ_KV_SELF = {
+    { MODEL_7B,   1026ull*MB },
+    { MODEL_13B,  1608ull*MB },
+    { MODEL_30B,  3124ull*MB },
+    { MODEL_65B,  5120ull*MB },
+};
+
+// this is mostly needed for temporary mul_mat buffers to dequantize the data
+// not actually needed if BLAS is disabled
+static const std::map<e_model, size_t> MEM_REQ_EVAL = {
+    { MODEL_7B,   768ull*MB },
+    { MODEL_13B, 1024ull*MB },
+    { MODEL_30B, 1280ull*MB },
+    { MODEL_65B, 1536ull*MB },
+};
+
+// default hparams (LLaMA 7B)
+struct llama_hparams {
+    int32_t n_vocab = 32000;
+    int32_t n_ctx   = 512;   // this is provided as user input?
+    int32_t n_embd  = 4096;
+    int32_t n_mult  = 256;
+    int32_t n_head  = 32;
+    int32_t n_layer = 32;
+    int32_t n_rot   = 64;
+    int32_t f16     = 1;
+};
+
 struct llama_layer {
     // normalization
     struct ggml_tensor * attention_norm;
 
     // attention
     struct ggml_tensor * wq;
     struct ggml_tensor * wk;
@@ -48,115 +104,246 @@
     struct ggml_tensor * ffn_norm;
 
     // ff
     struct ggml_tensor * w1;
     struct ggml_tensor * w2;
     struct ggml_tensor * w3;
 };
+
+struct llama_kv_cache {
+    struct ggml_tensor * k;
+    struct ggml_tensor * v;
+
+    struct ggml_context * ctx;
+
+    std::vector<uint8_t> buf;
+
+    int n; // number of tokens currently in the cache
+};
+
 struct llama_model {
+    e_model type = MODEL_UNKNOWN;
+
     llama_hparams hparams;
 
     struct ggml_tensor * tok_embeddings;
 
     struct ggml_tensor * norm;
     struct ggml_tensor * output;
 
     std::vector<llama_layer> layers;
 
-    // key + value memory
-    struct ggml_tensor * memory_k;
-    struct ggml_tensor * memory_v;
-
-    //
+    // context
     struct ggml_context * ctx;
-    std::map<std::string, struct ggml_tensor *> tensors;
+
+    // key + value cache for the self attention
+    // TODO: move to llama_state
+    struct llama_kv_cache kv_self;
+
+    // the model memory buffer
+    std::vector<uint8_t> buf;
+
+    // tensors
+    int n_loaded;
+    std::unordered_map<std::string, struct ggml_tensor *> tensors;
 };
-struct llama_state
-{
-    // Timers
-    struct timing {
-        int64_t t_load_us = 0;
-
-        int64_t t_sample_us = 0;
-        int64_t t_predict_us = 0;
-    } timing;
-
-    // Random number generator
-    std::mt19937 rng{};
-
-    // Tokens
-    std::vector<gpt_vocab::id> embd{};
-    std::vector<gpt_vocab::id> embd_inp{};
-    std::vector<gpt_vocab::id> last_n_tokens{};
-
-    // Logits from inference
-    std::vector<float> logits{};
-
-    // Counters
-    int input_consumed = 0;
-    int remaining_tokens = 0;
-    int n_past = 0;
-    size_t mem_per_token = 0;
 
-    // Flag set after initialization
-    bool is_initialized = false;
+struct llama_vocab {
+    using id    = int32_t;
+    using token = std::string;
+
+    struct token_score {
+        token tok;
+        float score;
+    };
+
+    std::unordered_map<token, id> token_to_id;
+    std::vector<token_score> id_to_token;
 };
-struct llama_context
-{
-    ggml_type wtype = ggml_type::GGML_TYPE_F16; // weight type (FP32 or FP16)
-
-    llama_model model{};
-    gpt_vocab vocab{};
-    gpt_params params{};
-
-    std::unique_ptr<llama_state> state = nullptr;
-
-    // default constructor
-    llama_context() = default;
-    // constructor
-    llama_context(llama_model&& model, gpt_vocab&& vocab, const gpt_params& params):
-        wtype(ggml_type::GGML_TYPE_F16),
-        model(std::move(model)),
-        vocab(std::move(vocab)),
-        params(params),
-        state(make_unique<llama_state>())
-    {
+
+struct llama_context {
+    std::mt19937 rng;
+
+    int64_t t_load_us = 0;
+    int64_t t_start_us = 0;
+
+    int64_t t_sample_us = 0;
+    int64_t t_eval_us   = 0;
+    int64_t t_p_eval_us = 0;
+
+    int32_t n_sample = 0; // number of tokens sampled
+    int32_t n_eval   = 0; // number of eval calls
+    int32_t n_p_eval = 0; // number of tokens in eval calls for the prompt (with batch size > 1)
+
+    llama_model model;
+    llama_vocab vocab;
+
+    size_t mem_per_token = 0;
+
+    // decode output (2-dimensional array: [n_tokens][n_vocab])
+    std::vector<float> logits;
+    bool logits_all = false;
+
+    // input embedding (1-dimensional array: [n_embd])
+    std::vector<float> embedding;
+
+    // memory buffers used to evaluate the model
+    // TODO: move in llama_state
+    std::vector<uint8_t> buf_compute;
+    std::vector<uint8_t> buf_scratch[LLAMA_MAX_SCRATCH_BUFFERS];
+
+    int    buf_last = 0;
+    size_t buf_max_size[LLAMA_MAX_SCRATCH_BUFFERS] = { 0 };
+
+    void use_buf(struct ggml_context * ctx, int i) {
+#if defined(LLAMA_USE_SCRATCH)
+        size_t last_size = 0;
+
+        if (i == -1) {
+            last_size = ggml_set_scratch(ctx, { 0, 0, nullptr, });
+        } else {
+            auto & buf = buf_scratch[i];
+            last_size = ggml_set_scratch(ctx, { 0, buf.size(), buf.data(), });
+        }
+
+        if (buf_last >= 0) {
+            buf_max_size[buf_last] = std::max(buf_max_size[buf_last], last_size);
+        }
+
+        buf_last = i;
+#else
+        (void) i;
+        (void) ctx;
+#endif
     }
-    ~llama_context(){
-        ggml_free(model.ctx);
+
+    size_t get_buf_max_mem(int i) const {
+#if defined(LLAMA_USE_SCRATCH)
+        return buf_max_size[i];
+#else
+        (void) i;
+        return 0;
+#endif
     }
 };
 
-/* Original code by @ggerganov */
-// load the model's weights from a file
-bool llama_model_load(const std::string & fname, llama_model & model, gpt_vocab & vocab, int n_ctx, ggml_type memory_type = GGML_TYPE_F32) {
+//
+// kv cache
+//
+
+static bool kv_cache_init(
+        const struct llama_hparams & hparams,
+             struct llama_kv_cache & cache,
+                         ggml_type   wtype,
+                               int   n_ctx) {
+    const int n_embd  = hparams.n_embd;
+    const int n_layer = hparams.n_layer;
+
+    const int n_mem      = n_layer*n_ctx;
+    const int n_elements = n_embd*n_mem;
+
+    cache.buf.resize(2u*n_elements*ggml_type_size(wtype) + 2u*MB);
+
+    struct ggml_init_params params;
+    params.mem_size   = cache.buf.size();
+    params.mem_buffer = cache.buf.data();
+
+    cache.ctx = ggml_init(params);
+
+    if (!cache.ctx) {
+        fprintf(stderr, "%s: failed to allocate memory for kv cache\n", __func__);
+        return false;
+    }
+
+    cache.k = ggml_new_tensor_1d(cache.ctx, wtype, n_elements);
+    cache.v = ggml_new_tensor_1d(cache.ctx, wtype, n_elements);
+
+    return true;
+}
 
+static void kv_cache_free(struct llama_kv_cache & cache) {
+    if (cache.ctx) {
+        ggml_free(cache.ctx);
+        cache.ctx = nullptr;
+    }
+}
+
+struct llama_context_params llama_context_default_params() {
+    struct llama_context_params result = {
+        /*.n_ctx                       =*/ 512,
+        /*.n_parts                     =*/ -1,
+        /*.seed                        =*/ 0,
+        /*.f16_kv                      =*/ false,
+        /*.logits_all                  =*/ false,
+        /*.vocab_only                  =*/ false,
+        /*.use_mlock                   =*/ false,
+        /*.embedding                   =*/ false,
+        /*.progress_callback           =*/ nullptr,
+        /*.progress_callback_user_data =*/ nullptr,
+    };
+
+    return result;
+}
+
+//
+// model loading
+//
+
+static bool llama_model_load(
+        const std::string & fname,
+        llama_context & lctx,
+        int n_ctx,
+        int n_parts,
+        ggml_type memory_type,
+        bool vocab_only,
+        llama_progress_callback progress_callback,
+        void *progress_callback_user_data) {
     fprintf(stderr, "%s: loading model from '%s' - please wait ...\n", __func__, fname.c_str());
 
+    const int64_t t_start_us = ggml_time_us();
+
+    lctx.t_start_us = t_start_us;
+
     std::vector<char> f_buf(1024*1024);
 
+    auto & model = lctx.model;
+    auto & vocab = lctx.vocab;
+
     auto fin = std::ifstream(fname, std::ios::binary);
     fin.rdbuf()->pubsetbuf(f_buf.data(), f_buf.size());
     if (!fin) {
         fprintf(stderr, "%s: failed to open '%s'\n", __func__, fname.c_str());
         return false;
     }
 
     // verify magic
     {
         uint32_t magic;
         fin.read((char *) &magic, sizeof(magic));
-        if (magic != 0x67676d6c) {
+        if (magic == LLAMA_FILE_MAGIC_UNVERSIONED) {
+            fprintf(stderr, "%s: invalid model file '%s' (too old, regenerate your model files or convert them with convert-unversioned-ggml-to-ggml.py!)\n",
+                    __func__, fname.c_str());
+            return false;
+        }
+        if (magic != LLAMA_FILE_MAGIC) {
             fprintf(stderr, "%s: invalid model file '%s' (bad magic)\n", __func__, fname.c_str());
             return false;
         }
+
+        uint32_t format_version;
+        fin.read((char *) &format_version, sizeof(format_version));
+
+        if (format_version != LLAMA_FILE_VERSION) {
+            fprintf(stderr, "%s: invalid model file '%s' (unsupported format version %" PRIu32 ", expected %d)\n",
+                    __func__, fname.c_str(), format_version, LLAMA_FILE_VERSION);
+            return false;
+        }
     }
 
     int n_ff = 0;
-    int n_parts = 0;
 
     // load hparams
     {
         auto & hparams = model.hparams;
 
         fin.read((char *) &hparams.n_vocab, sizeof(hparams.n_vocab));
         //fin.read((char *) &hparams.n_ctx,   sizeof(hparams.n_ctx));
@@ -166,109 +353,171 @@
         fin.read((char *) &hparams.n_layer, sizeof(hparams.n_layer));
         fin.read((char *) &hparams.n_rot,   sizeof(hparams.n_rot));
         fin.read((char *) &hparams.f16,     sizeof(hparams.f16));
 
         hparams.n_ctx = n_ctx;
 
         n_ff = ((2*(4*hparams.n_embd)/3 + hparams.n_mult - 1)/hparams.n_mult)*hparams.n_mult;
-        n_parts = LLAMA_N_PARTS.at(hparams.n_embd);
+
+        if (n_parts < 1) {
+            n_parts = LLAMA_N_PARTS.at(hparams.n_embd);
+        }
+
+        // temp warning to tell the user to use "--n_parts"
+        if (hparams.f16 == 4 && n_parts != 1) {
+            fprintf(stderr, "%s: GPTQ model detected - are you sure n_parts should be %d? we normally expect it to be 1\n", __func__, n_parts);
+            fprintf(stderr, "%s: use '--n_parts 1' if necessary\n", __func__);
+        }
+
+        if (hparams.n_layer == 32) {
+            model.type = e_model::MODEL_7B;
+        }
+
+        if (hparams.n_layer == 40) {
+            model.type = e_model::MODEL_13B;
+        }
+
+        if (hparams.n_layer == 60) {
+            model.type = e_model::MODEL_30B;
+        }
+
+        if (hparams.n_layer == 80) {
+            model.type = e_model::MODEL_65B;
+        }
 
         fprintf(stderr, "%s: n_vocab = %d\n", __func__, hparams.n_vocab);
         fprintf(stderr, "%s: n_ctx   = %d\n", __func__, hparams.n_ctx);
         fprintf(stderr, "%s: n_embd  = %d\n", __func__, hparams.n_embd);
         fprintf(stderr, "%s: n_mult  = %d\n", __func__, hparams.n_mult);
         fprintf(stderr, "%s: n_head  = %d\n", __func__, hparams.n_head);
         fprintf(stderr, "%s: n_layer = %d\n", __func__, hparams.n_layer);
         fprintf(stderr, "%s: n_rot   = %d\n", __func__, hparams.n_rot);
         fprintf(stderr, "%s: f16     = %d\n", __func__, hparams.f16);
         fprintf(stderr, "%s: n_ff    = %d\n", __func__, n_ff);
         fprintf(stderr, "%s: n_parts = %d\n", __func__, n_parts);
+        fprintf(stderr, "%s: type    = %d\n", __func__, model.type);
     }
 
     // load vocab
     {
         std::string word;
+        vocab.id_to_token.resize(model.hparams.n_vocab);
+        std::vector<char> tmp(64);
+
         for (int i = 0; i < model.hparams.n_vocab; i++) {
             uint32_t len;
             fin.read((char *) &len, sizeof(len));
 
             word.resize(len);
-            fin.read((char *) word.data(), len);
+            if (len > 0) {
+                tmp.resize(len);
+                fin.read(tmp.data(), len);
+                word.assign(tmp.data(), len);
+            } else {
+                word.clear();
+            }
+
+            float score;
+            fin.read((char *) &score, sizeof(score));
 
             vocab.token_to_id[word] = i;
-            vocab.id_to_token[i] = word;
 
-            //if (i < 30000) {
-            //    fprintf(stderr, "%s: vocab[%d] = '%s'\n", __func__, i, word.c_str());
-            //}
+            auto &tok_score = vocab.id_to_token[i];
+            tok_score.tok = word;
+            tok_score.score = score;
         }
     }
 
+    if (vocab_only) {
+        return true;
+    }
+
     // for the big tensors, we have the option to store the data in 16-bit floats or quantized
     // in order to save memory and also to speed up the computation
-    ggml_type wtype = GGML_TYPE_COUNT;
+    // wtype is for per-layer weights, while vtype is for other weights
+    ggml_type wtype, vtype;
     switch (model.hparams.f16) {
-        case 0: wtype = GGML_TYPE_F32;  break;
-        case 1: wtype = GGML_TYPE_F16;  break;
-        case 2: wtype = GGML_TYPE_Q4_0; break;
-        case 3: wtype = GGML_TYPE_Q4_1; break;
+        case 0: wtype = vtype = GGML_TYPE_F32;  break;
+        case 1: wtype = vtype = GGML_TYPE_F16;  break;
+        case 2: wtype = vtype = GGML_TYPE_Q4_0; break;
+        case 3: wtype = vtype = GGML_TYPE_Q4_1; break;
+        case 4: wtype = GGML_TYPE_Q4_1; vtype = GGML_TYPE_F16; break;
         default:
                 {
                     fprintf(stderr, "%s: invalid model file '%s' (bad f16 value %d)\n",
                             __func__, fname.c_str(), model.hparams.f16);
                     return false;
                 }
     }
 
-    const ggml_type wtype2 = GGML_TYPE_F32;
-
     auto & ctx = model.ctx;
 
     size_t ctx_size = 0;
 
     {
         const auto & hparams = model.hparams;
 
         const int n_embd  = hparams.n_embd;
         const int n_layer = hparams.n_layer;
         const int n_ctx   = hparams.n_ctx;
         const int n_vocab = hparams.n_vocab;
 
-        ctx_size += n_embd*n_vocab*ggml_type_sizef(wtype); // tok_embeddings
+        ctx_size += n_embd*n_vocab*ggml_type_sizef(vtype); // tok_embeddings
 
         ctx_size += n_embd*ggml_type_sizef(GGML_TYPE_F32); // norm
 
-        ctx_size += n_embd*n_vocab*ggml_type_sizef(wtype); // output
+        ctx_size += n_embd*n_vocab*ggml_type_sizef(vtype); // output
 
         ctx_size += n_layer*(n_embd*ggml_type_sizef(GGML_TYPE_F32)); // attention_norm
 
         ctx_size += n_layer*(n_embd*n_embd*ggml_type_sizef(wtype)); // wq
         ctx_size += n_layer*(n_embd*n_embd*ggml_type_sizef(wtype)); // wk
         ctx_size += n_layer*(n_embd*n_embd*ggml_type_sizef(wtype)); // wv
         ctx_size += n_layer*(n_embd*n_embd*ggml_type_sizef(wtype)); // wo
 
         ctx_size += n_layer*(n_embd*ggml_type_sizef(GGML_TYPE_F32)); // ffn_norm
 
         ctx_size += n_layer*(n_ff*n_embd*ggml_type_sizef(wtype)); // w1
         ctx_size += n_layer*(n_ff*n_embd*ggml_type_sizef(wtype)); // w2
         ctx_size += n_layer*(n_ff*n_embd*ggml_type_sizef(wtype)); // w3
 
-        ctx_size += n_ctx*n_layer*n_embd*ggml_type_sizef(GGML_TYPE_F32); // memory_k
-        ctx_size += n_ctx*n_layer*n_embd*ggml_type_sizef(GGML_TYPE_F32); // memory_v
+        ctx_size += n_ctx*n_layer*n_embd*ggml_type_sizef(memory_type); // memory_k
+        ctx_size += n_ctx*n_layer*n_embd*ggml_type_sizef(memory_type); // memory_v
 
         ctx_size += (5 + 10*n_layer)*256; // object overhead
 
         fprintf(stderr, "%s: ggml ctx size = %6.2f MB\n", __func__, ctx_size/(1024.0*1024.0));
     }
 
+    // print memory requirements
+    {
+        const size_t scale = memory_type == GGML_TYPE_F32 ? 2 : 1;
+
+        // this is the total memory required to run the inference
+        const size_t mem_required =
+            ctx_size +
+            MEM_REQ_SCRATCH0.at(model.type) +
+            MEM_REQ_SCRATCH1.at(model.type) +
+            MEM_REQ_EVAL.at    (model.type);
+
+        // this is the memory required by one llama_state
+        const size_t mem_required_state =
+            scale*MEM_REQ_KV_SELF.at(model.type);
+
+        fprintf(stderr, "%s: mem required  = %7.2f MB (+ %7.2f MB per state)\n", __func__,
+                mem_required / 1024.0 / 1024.0, mem_required_state / 1024.0 / 1024.0);
+    }
+
     // create the ggml context
     {
+        lctx.model.buf.resize(ctx_size);
+
         struct ggml_init_params params = {
-            /*.mem_size   =*/ ctx_size,
-            /*.mem_buffer =*/ NULL,
+            /*.mem_size   =*/ lctx.model.buf.size(),
+            /*.mem_buffer =*/ lctx.model.buf.data(),
         };
 
         model.ctx = ggml_init(params);
         if (!model.ctx) {
             fprintf(stderr, "%s: ggml_init() failed\n", __func__);
             return false;
         }
@@ -276,23 +525,22 @@
 
     // prepare memory for the weights
     {
         const auto & hparams = model.hparams;
 
         const int n_embd  = hparams.n_embd;
         const int n_layer = hparams.n_layer;
-        const int n_ctx   = hparams.n_ctx;
         const int n_vocab = hparams.n_vocab;
 
         model.layers.resize(n_layer);
 
-        model.tok_embeddings = ggml_new_tensor_2d(ctx, wtype, n_embd, n_vocab);
+        model.tok_embeddings = ggml_new_tensor_2d(ctx, vtype, n_embd, n_vocab);
 
         model.norm   = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
-        model.output = ggml_new_tensor_2d(ctx, wtype,         n_embd, n_vocab);
+        model.output = ggml_new_tensor_2d(ctx, vtype,         n_embd, n_vocab);
 
         // map by name
         model.tensors["tok_embeddings.weight"] = model.tok_embeddings;
 
         model.tensors["norm.weight"]   = model.norm;
         model.tensors["output.weight"] = model.output;
 
@@ -324,59 +572,49 @@
 
             model.tensors["layers." + std::to_string(i) + ".feed_forward.w1.weight"] = layer.w1;
             model.tensors["layers." + std::to_string(i) + ".feed_forward.w2.weight"] = layer.w2;
             model.tensors["layers." + std::to_string(i) + ".feed_forward.w3.weight"] = layer.w3;
         }
     }
 
-    // key + value memory
-    {
-        const auto & hparams = model.hparams;
-
-        const int n_embd  = hparams.n_embd;
-        const int n_layer = hparams.n_layer;
-        const int n_ctx   = hparams.n_ctx;
-
-        const int n_mem      = n_layer*n_ctx;
-        const int n_elements = n_embd*n_mem;
-
-        model.memory_k = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_elements);
-        model.memory_v = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_elements);
-
-        const size_t memory_size = ggml_nbytes(model.memory_k) + ggml_nbytes(model.memory_v);
-
-        fprintf(stderr, "%s: memory_size = %8.2f MB, n_mem = %d\n", __func__, memory_size/1024.0/1024.0, n_mem);
-    }
-
     const size_t file_offset = fin.tellg();
 
     fin.close();
 
     std::vector<uint8_t> tmp;
 
+    if (progress_callback) {
+        progress_callback(0.0, progress_callback_user_data);
+    }
+
     for (int i = 0; i < n_parts; ++i) {
         const int part_id = i;
         //const int part_id = n_parts - i - 1;
 
         std::string fname_part = fname;
         if (i > 0) {
             fname_part += "." + std::to_string(i);
         }
 
         fprintf(stderr, "%s: loading model part %d/%d from '%s'\n", __func__, i+1, n_parts, fname_part.c_str());
 
         fin = std::ifstream(fname_part, std::ios::binary);
         fin.rdbuf()->pubsetbuf(f_buf.data(), f_buf.size());
+
+        fin.seekg(0, fin.end);
+        const size_t file_size = fin.tellg();
+
         fin.seekg(file_offset);
 
         // load weights
         {
-            int n_tensors = 0;
             size_t total_size = 0;
 
+            model.n_loaded = 0;
+
             fprintf(stderr, "%s: ", __func__);
 
             while (true) {
                 int32_t n_dims;
                 int32_t length;
                 int32_t ftype;
 
@@ -533,46 +771,599 @@
                         }
                     }
 
                     total_size += ggml_nbytes(tensor)/n_parts;
                 }
 
                 //fprintf(stderr, "%42s - [%5d, %5d], type = %6s, %6.2f MB\n", name.data(), ne[0], ne[1], ftype == 0 ? "float" : "f16", ggml_nbytes(tensor)/1024.0/1024.0);
-                if (++n_tensors % 8 == 0) {
+                model.n_loaded++;
+
+                // progress
+                if (progress_callback) {
+                    float current_file_progress = float(size_t(fin.tellg()) - file_offset) / float(file_size - file_offset);
+                    float current_progress = (float(i) + current_file_progress) / float(n_parts);
+                    progress_callback(current_progress, progress_callback_user_data);
+                }
+                if (model.n_loaded % 8 == 0) {
                     fprintf(stderr, ".");
                     fflush(stderr);
                 }
             }
 
             fprintf(stderr, " done\n");
 
-            fprintf(stderr, "%s: model size = %8.2f MB / num tensors = %d\n", __func__, total_size/1024.0/1024.0, n_tensors);
+            fprintf(stderr, "%s: model size = %8.2f MB / num tensors = %d\n", __func__, total_size/1024.0/1024.0, model.n_loaded);
+            if (model.n_loaded == 0) {
+                fprintf(stderr, "%s: WARN no tensors loaded from model file - assuming empty model for testing\n", __func__);
+            } else if (model.n_loaded != (int) model.tensors.size()) {
+                fprintf(stderr, "%s: ERROR not all tensors loaded from model file - expected %zu, got %d\n", __func__, model.tensors.size(), model.n_loaded);
+                return false;
+            }
         }
 
         fin.close();
     }
 
+    lctx.t_load_us = ggml_time_us() - t_start_us;
+
+    if (progress_callback) {
+        progress_callback(1.0, progress_callback_user_data);
+    }
+
     return true;
 }
 
-bool llama_model_quantize(const std::string & fname_inp, const std::string & fname_out, int itype) {
+// evaluate the transformer
+//
+//   - lctx:      llama context
+//   - tokens:    new batch of tokens to process
+//   - n_past:    the context size so far
+//   - n_threads: number of threads to use
+//
+static bool llama_eval_internal(
+        llama_context & lctx,
+    const llama_token * tokens,
+            const int   n_tokens,
+            const int   n_past,
+            const int   n_threads) {
+    const int64_t t_start_us = ggml_time_us();
+
+    const int N = n_tokens;
+
+    const auto & model   = lctx.model;
+    const auto & hparams = model.hparams;
+
+    auto & kv_self = model.kv_self;
+
+    LLAMA_ASSERT(!!kv_self.ctx);
+
+    const int n_embd  = hparams.n_embd;
+    const int n_layer = hparams.n_layer;
+    const int n_ctx   = hparams.n_ctx;
+    const int n_head  = hparams.n_head;
+    const int n_vocab = hparams.n_vocab;
+    const int n_rot   = hparams.n_embd/hparams.n_head;
+
+    auto & mem_per_token = lctx.mem_per_token;
+    auto & buf_compute   = lctx.buf_compute;
+
+    struct ggml_init_params params = {
+        /*.mem_size   =*/ buf_compute.size(),
+        /*.mem_buffer =*/ buf_compute.data(),
+    };
+
+    struct ggml_context * ctx0 = ggml_init(params);
+
+    // for big prompts, if BLAS is enabled, it is better to use only one thread
+    // otherwise, the threads are spin-lock waiting for the BLAS calls and are degrading the performance
+    ggml_cgraph gf = {};
+    gf.n_threads = N > 255 && ggml_cpu_has_blas() ? 1 : n_threads;
+
+    struct ggml_tensor * embd = ggml_new_tensor_1d(ctx0, GGML_TYPE_I32, N);
+    memcpy(embd->data, tokens, N*ggml_element_size(embd));
+
+    struct ggml_tensor * inpL = ggml_get_rows(ctx0, model.tok_embeddings, embd);
+
+    for (int il = 0; il < n_layer; ++il) {
+        struct ggml_tensor * inpSA = inpL;
+
+        struct ggml_tensor * cur;
+
+        lctx.use_buf(ctx0, 0);
+
+        // norm
+        {
+            cur = ggml_rms_norm(ctx0, inpL);
+
+            // cur = attention_norm*cur
+            cur = ggml_mul(ctx0,
+                        ggml_repeat(ctx0, model.layers[il].attention_norm, cur),
+                        cur);
+        }
+
+        // self-attention
+        {
+            struct ggml_tensor * Qcur = ggml_mul_mat(ctx0, model.layers[il].wq, cur);
+            struct ggml_tensor * Kcur = ggml_mul_mat(ctx0, model.layers[il].wk, cur);
+            struct ggml_tensor * Vcur = ggml_mul_mat(ctx0, model.layers[il].wv, cur);
+
+            // store key and value to memory
+            if (N >= 1) {
+                struct ggml_tensor * k = ggml_view_1d(ctx0, kv_self.k, N*n_embd, (ggml_element_size(kv_self.k)*n_embd)*(il*n_ctx + n_past));
+                struct ggml_tensor * v = ggml_view_1d(ctx0, kv_self.v, N*n_embd, (ggml_element_size(kv_self.v)*n_embd)*(il*n_ctx + n_past));
+
+                ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Kcur, k));
+                ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Vcur, v));
+            }
+
+            // Q = Qcur.contiguous().view(n_embd/n_head, n_head, N).permute(0, 2, 1, 3)
+            struct ggml_tensor * Q =
+                ggml_permute(ctx0,
+                        ggml_rope(ctx0,
+                            ggml_cpy(ctx0,
+                                Qcur,
+                                ggml_new_tensor_3d(ctx0, GGML_TYPE_F32, n_embd/n_head, n_head, N)),
+                            n_past, n_rot, 0),
+                        0, 2, 1, 3);
+
+            // K = Kmem.view(n_embd/n_head, n_head, n_past + N).permute(0, 2, 1, 3)
+            struct ggml_tensor * K =
+                ggml_permute(ctx0,
+                        ggml_rope(ctx0,
+                            ggml_reshape_3d(ctx0,
+                                ggml_view_1d(ctx0, kv_self.k, (n_past + N)*n_embd, il*n_ctx*ggml_element_size(kv_self.k)*n_embd),
+                                n_embd/n_head, n_head, n_past + N),
+                            n_past, n_rot, 1),
+                        0, 2, 1, 3);
+
+            // K * Q
+            struct ggml_tensor * KQ = ggml_mul_mat(ctx0, K, Q);
+
+            // KQ_scaled = KQ / sqrt(n_embd/n_head)
+            struct ggml_tensor * KQ_scaled =
+                ggml_scale(ctx0,
+                        KQ,
+                        ggml_new_f32(ctx0, 1.0f/sqrtf(float(n_embd)/n_head)));
+
+            // KQ_masked = mask_past(KQ_scaled)
+            struct ggml_tensor * KQ_masked = ggml_diag_mask_inf(ctx0, KQ_scaled, n_past);
+
+            // KQ = soft_max(KQ_masked)
+            struct ggml_tensor * KQ_soft_max = ggml_soft_max(ctx0, KQ_masked);
+
+            // V_trans = Vmem.view(n_embd/n_head, n_head, n_past + N).permute(1, 2, 0, 3).contiguous()
+            struct ggml_tensor * V_trans =
+                ggml_cpy(ctx0,
+                    ggml_permute(ctx0,
+                            ggml_reshape_3d(ctx0,
+                                ggml_view_1d(ctx0, kv_self.v, (n_past + N)*n_embd, il*n_ctx*ggml_element_size(kv_self.v)*n_embd),
+                                n_embd/n_head, n_head, n_past + N),
+                            1, 2, 0, 3),
+                    ggml_new_tensor_3d(ctx0, kv_self.v->type, n_past + N, n_embd/n_head, n_head));
+
+            // KQV = transpose(V) * KQ_soft_max
+            struct ggml_tensor * KQV = ggml_mul_mat(ctx0, V_trans, KQ_soft_max);
+
+            // KQV_merged = KQV.permute(0, 2, 1, 3)
+            struct ggml_tensor * KQV_merged = ggml_permute(ctx0, KQV, 0, 2, 1, 3);
+
+            // cur = KQV_merged.contiguous().view(n_embd, N)
+            cur = ggml_cpy(ctx0,
+                    KQV_merged,
+                    ggml_new_tensor_2d(ctx0, GGML_TYPE_F32, n_embd, N));
+
+            // projection (no bias)
+            cur = ggml_mul_mat(ctx0,
+                    model.layers[il].wo,
+                    cur);
+        }
+
+        lctx.use_buf(ctx0, 1);
+
+        struct ggml_tensor * inpFF = ggml_add(ctx0, cur, inpSA);
+
+        // feed-forward network
+        {
+            // norm
+            {
+                cur = ggml_rms_norm(ctx0, inpFF);
+
+                // cur = ffn_norm*cur
+                cur = ggml_mul(ctx0,
+                        ggml_repeat(ctx0, model.layers[il].ffn_norm, cur),
+                        cur);
+            }
+
+            struct ggml_tensor * tmp = ggml_mul_mat(ctx0,
+                    model.layers[il].w3,
+                    cur);
+
+            cur = ggml_mul_mat(ctx0,
+                    model.layers[il].w1,
+                    cur);
+
+            // SILU activation
+            cur = ggml_silu(ctx0, cur);
+
+            cur = ggml_mul(ctx0, cur, tmp);
+
+            cur = ggml_mul_mat(ctx0,
+                    model.layers[il].w2,
+                    cur);
+        }
+
+        cur = ggml_add(ctx0, cur, inpFF);
+
+        // input for next layer
+        inpL = cur;
+    }
+
+    lctx.use_buf(ctx0, 0);
+
+    // used at the end to optionally extract the embeddings
+    struct ggml_tensor * embeddings = NULL;
+
+    // norm
+    {
+
+        inpL = ggml_rms_norm(ctx0, inpL);
+
+        // inpL = norm*inpL
+        inpL = ggml_mul(ctx0,
+                    ggml_repeat(ctx0, model.norm, inpL),
+                    inpL);
+
+        embeddings = inpL;
+    }
+
+    // lm_head
+    inpL = ggml_mul_mat(ctx0, model.output, inpL);
+
+    lctx.use_buf(ctx0, -1);
+
+    // logits -> probs
+    //inpL = ggml_soft_max(ctx0, inpL);
+
+    // run the computation
+    ggml_build_forward_expand(&gf, inpL);
+    ggml_graph_compute       (ctx0, &gf);
+
+    //if (n_past%100 == 0) {
+    //    ggml_graph_print   (&gf);
+    //    ggml_graph_dump_dot(&gf, NULL, "gpt-2.dot");
+    //}
+
+    //embd_w.resize(n_vocab*N);
+    //memcpy(embd_w.data(), ggml_get_data(inpL), sizeof(float)*n_vocab*N);
+
+    // extract logits
+    {
+        auto & logits_out = lctx.logits;
+
+        if (lctx.logits_all) {
+            logits_out.resize(n_vocab * N);
+            memcpy(logits_out.data(), (float *) ggml_get_data(inpL), sizeof(float)*n_vocab*N);
+        } else {
+            // return result for just the last token
+            logits_out.resize(n_vocab);
+            memcpy(logits_out.data(), (float *) ggml_get_data(inpL) + (n_vocab*(N-1)), sizeof(float)*n_vocab);
+        }
+    }
+
+    // extract embeddings
+    if (lctx.embedding.size()) {
+        auto & embedding_out = lctx.embedding;
+
+        embedding_out.resize(n_embd);
+        memcpy(embedding_out.data(), (float *) ggml_get_data(embeddings) + (n_embd*(N - 1)), sizeof(float)*n_embd);
+    }
+
+    if (mem_per_token == 0) {
+        mem_per_token = ggml_used_mem(ctx0)/N;
+    }
+
+#if 0
+    printf("\n%s: used_mem = %.3f MB, scratch -- %.3f MB %.3f MB\n", __func__,
+            ggml_used_mem(ctx0)/1024.0/1024.0,
+            lctx.get_buf_max_mem(0)/1024.0/1024.0,
+            lctx.get_buf_max_mem(1)/1024.0/1024.0);
+#endif
+
+    ggml_free(ctx0);
+
+    // measure the performance only for the single-token evals
+    if (N == 1) {
+        lctx.t_eval_us += ggml_time_us() - t_start_us;
+        lctx.n_eval++;
+    }
+    else if (N > 1) {
+        lctx.t_p_eval_us += ggml_time_us() - t_start_us;
+        lctx.n_p_eval += N;
+    }
+
+    return true;
+}
+
+//
+// tokenizer
+//
+
+static size_t utf8_len(char src) {
+    const size_t lookup[] = { 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 3, 4 };
+    uint8_t highbits = static_cast<uint8_t>(src) >> 4;
+    return lookup[highbits];
+}
+
+struct llama_sp_symbol {
+    using index = int;
+    index prev;
+    index next;
+    const char * text;
+    size_t n;
+};
+
+struct llama_sp_bigram {
+    struct comparator {
+        bool operator()(llama_sp_bigram & l, llama_sp_bigram & r) {
+            return (l.score < r.score) || (l.score == r.score && l.left > r.left);
+        }
+    };
+    using queue_storage = std::vector<llama_sp_bigram>;
+    using queue = std::priority_queue<llama_sp_bigram, queue_storage, comparator>;
+    llama_sp_symbol::index left;
+    llama_sp_symbol::index right;
+    float score;
+    size_t size;
+};
+
+// original implementation:
+// https://github.com/ggerganov/llama.cpp/commit/074bea2eb1f1349a0118239c4152914aecaa1be4
+struct llama_tokenizer {
+    llama_tokenizer(const llama_vocab & vocab): vocab_(vocab) {}
+
+    void tokenize(const std::string & text, std::vector<llama_vocab::id> & output) {
+        // split string into utf8 chars
+        int index = 0;
+        size_t offs = 0;
+        while (offs < text.size()) {
+            llama_sp_symbol sym;
+            size_t char_len = std::min(text.size() - offs, utf8_len(text[offs]));
+            sym.text = text.c_str() + offs;
+            sym.n = char_len;
+            offs += char_len;
+            sym.prev = index - 1;
+            sym.next = offs == text.size() ? -1 : index + 1;
+            index++;
+            symbols_.emplace_back(std::move(sym));
+        }
+
+        // seed the work queue with all possible 2-character tokens.
+        for (size_t i = 1; i < symbols_.size(); ++i) {
+            try_add_bigram(i - 1, i);
+        }
+
+        // keep substituting the highest frequency pairs for as long as we can.
+        while (!work_queue_.empty()) {
+            auto bigram = work_queue_.top();
+            work_queue_.pop();
+
+            auto & left_sym = symbols_[bigram.left];
+            auto & right_sym = symbols_[bigram.right];
+
+            // if one of the symbols already got merged, skip it.
+            if (left_sym.n == 0 || right_sym.n == 0 ||
+                left_sym.n + right_sym.n != bigram.size) {
+                continue;
+            }
+
+            // merge the right sym into the left one
+            left_sym.n += right_sym.n;
+            right_sym.n = 0;
+
+            //printf("left = '%*s' size = %zu\n", (int) left_sym.n, left_sym.text, bigram.size);
+
+            // remove the right sym from the chain
+            left_sym.next = right_sym.next;
+            if (right_sym.next >= 0) {
+                symbols_[right_sym.next].prev = bigram.left;
+            }
+
+            // find more substitutions
+            try_add_bigram(left_sym.prev, bigram.left);
+            try_add_bigram(bigram.left, left_sym.next);
+        }
+
+        for (int i = 0; i != -1; i = symbols_[i].next) {
+            auto & symbol = symbols_[i];
+            auto token = vocab_.token_to_id.find(std::string(symbol.text, symbol.n));
+
+            if (token == vocab_.token_to_id.end()) {
+                // output any symbols that did not form tokens as bytes.
+                for (int j = 0; j < (int) symbol.n; ++j) {
+                    llama_vocab::id token_id = static_cast<uint8_t>(symbol.text[j]) + 3;
+                    output.push_back(token_id);
+                }
+            } else {
+                output.push_back((*token).second);
+            }
+        }
+    }
+
+private:
+    void try_add_bigram(int left, int right) {
+        if (left == -1 || right == -1) {
+            return;
+        }
+
+        const std::string text = std::string(symbols_[left].text, symbols_[left].n + symbols_[right].n);
+        auto token = vocab_.token_to_id.find(text);
+
+        if (token == vocab_.token_to_id.end()) {
+            return;
+        }
+
+        if (static_cast<size_t>((*token).second) >= vocab_.id_to_token.size()) {
+            return;
+        }
+
+        const auto &tok_score = vocab_.id_to_token[(*token).second];
+
+        llama_sp_bigram bigram;
+        bigram.left = left;
+        bigram.right = right;
+        bigram.score = tok_score.score;
+        bigram.size = text.size();
+        work_queue_.push(bigram);
+    }
+
+    const llama_vocab & vocab_;
+    std::vector<llama_sp_symbol> symbols_;
+    llama_sp_bigram::queue work_queue_;
+};
+
+static std::vector<llama_vocab::id> llama_tokenize(const llama_vocab & vocab, const std::string & text, bool bos) {
+    llama_tokenizer tokenizer(vocab);
+    std::vector<llama_vocab::id> output;
+
+    if (text.size() == 0) {
+        return output;
+    }
+
+    if (bos) {
+        output.push_back(1);
+    }
+
+    tokenizer.tokenize(text, output);
+    return output;
+}
+
+//
+// sampling
+//
+
+static void sample_top_k(std::vector<std::pair<float, llama_vocab::id>> & logits_id, int top_k) {
+    // find the top k tokens
+    std::partial_sort(
+            logits_id.begin(),
+            logits_id.begin() + top_k, logits_id.end(),
+            [](const std::pair<float, llama_vocab::id> & a, const std::pair<float, llama_vocab::id> & b) {
+        return a.first > b.first;
+    });
+
+    logits_id.resize(top_k);
+}
+
+static llama_vocab::id llama_sample_top_p_top_k(
+        llama_context & lctx,
+        const std::vector<llama_vocab::id> & last_n_tokens,
+        int top_k,
+        float top_p,
+        float temp,
+        float repeat_penalty) {
+    auto & rng = lctx.rng;
+
+    const int n_logits = lctx.model.hparams.n_vocab;
+
+    const auto & logits = lctx.logits;
+    const auto * plogits = logits.data() + logits.size() - n_logits;
+
+    std::vector<std::pair<float, llama_vocab::id>> logits_id;
+    logits_id.reserve(n_logits);
+
+    {
+        const float scale = 1.0f/temp;
+        for (int i = 0; i < n_logits; ++i) {
+            // repetition penalty from ctrl paper (https://arxiv.org/abs/1909.05858)
+            // credit https://github.com/facebookresearch/llama/compare/main...shawwn:llama:main
+            if (std::find(last_n_tokens.begin(), last_n_tokens.end(), i) != last_n_tokens.end()) {
+                // if score < 0 then repetition penalty has to multiplied to reduce the previous token probability
+                if (plogits[i] < 0.0f) {
+                    logits_id.push_back(std::make_pair(plogits[i]*scale*repeat_penalty, i));
+                } else {
+                    logits_id.push_back(std::make_pair(plogits[i]*scale/repeat_penalty, i));
+                }
+            } else {
+                logits_id.push_back(std::make_pair(plogits[i]*scale, i));
+            }
+        }
+    }
+
+    sample_top_k(logits_id, top_k);
+
+    float maxl = -std::numeric_limits<float>::infinity();
+    for (const auto & kv : logits_id) {
+        maxl = std::max(maxl, kv.first);
+    }
+
+    // compute probs for the top k tokens
+    std::vector<float> probs;
+    probs.reserve(logits_id.size());
+
+    double sum = 0.0;
+    for (const auto & kv : logits_id) {
+        const float p = expf(kv.first - maxl);
+        probs.push_back(p);
+        sum += p;
+    }
+
+    // normalize the probs
+    for (auto & p : probs) {
+        p /= sum;
+    }
+
+    if (top_p < 1.0) {
+        double cumsum = 0.0;
+        for (int i = 0; i < (int) probs.size(); i++) {
+            cumsum += probs[i];
+            if (cumsum >= top_p) {
+                probs.resize(i + 1);
+                logits_id.resize(i + 1);
+                break;
+            }
+        }
+
+        cumsum = 1.0/cumsum;
+        for (int i = 0; i < (int) probs.size(); i++) {
+            probs[i] *= cumsum;
+        }
+    }
+
+    //printf("\n");
+    //for (int i = 0; i < (int) 10; i++) {
+    //    printf("%d: '%s' %f\n", i, vocab.id_to_token.at(logits_id[i].second).c_str(), probs[i]);
+    //}
+    //printf("\n\n");
+    //exit(0);
+
+    std::discrete_distribution<> dist(probs.begin(), probs.end());
+    int idx = dist(rng);
+
+    return logits_id[idx].second;
+}
+
+//
+// quantization
+//
+
+// TODO: reuse code from the llama_model_load() somehow
+static bool llama_model_quantize_internal(const std::string & fname_inp, const std::string & fname_out, int itype) {
     ggml_type type = GGML_TYPE_Q4_1;
 
     switch (itype) {
         case 2: type = GGML_TYPE_Q4_0; break;
         case 3: type = GGML_TYPE_Q4_1; break;
         default: fprintf(stderr, "%s: invalid quantization type %d\n", __func__, itype); return 1;
     };
 
     if (type != GGML_TYPE_Q4_0 && type != GGML_TYPE_Q4_1) {
         fprintf(stderr, "%s: invalid quantization type %d\n", __func__, type);
         return false;
     }
 
-    gpt_vocab vocab;
+    llama_vocab vocab;
 
     printf("%s: loading model from '%s'\n", __func__, fname_inp.c_str());
 
     auto finp = std::ifstream(fname_inp, std::ios::binary);
     if (!finp) {
         fprintf(stderr, "%s: failed to open '%s' for reading\n", __func__, fname_inp.c_str());
         return false;
@@ -584,20 +1375,36 @@
         return false;
     }
 
     // verify magic
     {
         uint32_t magic;
         finp.read((char *) &magic, sizeof(magic));
-        if (magic != 0x67676d6c) {
+        if (magic == LLAMA_FILE_MAGIC_UNVERSIONED) {
+            fprintf(stderr, "%s: invalid model file '%s' (too old, regenerate your model files!)\n",
+                    __func__, fname_inp.c_str());
+            return false;
+        }
+        if (magic != LLAMA_FILE_MAGIC) {
             fprintf(stderr, "%s: invalid model file '%s' (bad magic)\n", __func__, fname_inp.c_str());
             return false;
         }
 
         fout.write((char *) &magic, sizeof(magic));
+
+        uint32_t format_version;
+        finp.read((char *) &format_version, sizeof(format_version));
+
+        if (format_version != LLAMA_FILE_VERSION) {
+            fprintf(stderr, "%s: invalid model file '%s' (unsupported format version %" PRIu32 ", expected %d)\n",
+                    __func__, fname_inp.c_str(), format_version, LLAMA_FILE_VERSION);
+            return false;
+        }
+
+        fout.write((char *) &format_version, sizeof(format_version));
     }
 
     llama_hparams hparams;
 
     // load hparams
     {
         finp.read((char *) &hparams.n_vocab, sizeof(hparams.n_vocab));
@@ -634,25 +1441,33 @@
         if (n_vocab != hparams.n_vocab) {
             fprintf(stderr, "%s: invalid model file '%s' (bad vocab size %d != %d)\n",
                     __func__, fname_inp.c_str(), n_vocab, hparams.n_vocab);
             return false;
         }
 
         std::string word;
+        vocab.id_to_token.resize(n_vocab);
         for (int i = 0; i < n_vocab; i++) {
             uint32_t len;
             finp.read ((char *) &len, sizeof(len));
             fout.write((char *) &len, sizeof(len));
 
             word.resize(len);
             finp.read ((char *) word.data(), len);
             fout.write((char *) word.data(), len);
 
+            float score;
+            finp.read ((char *) &score, sizeof(score));
+            fout.write((char *) &score, sizeof(score));
+
             vocab.token_to_id[word] = i;
-            vocab.id_to_token[i] = word;
+
+            auto &tok_score = vocab.id_to_token[i];
+            tok_score.tok = word;
+            tok_score.score = score;
         }
     }
 
     // load weights
     {
         size_t total_size_org = 0;
         size_t total_size_new = 0;
@@ -749,37 +1564,37 @@
 
                 size_t cur_size = 0;
                 std::vector<int64_t> hist_cur(1 << 4, 0);
 
                 switch (type) {
                     case GGML_TYPE_Q4_0:
                         {
-                            cur_size = ggml_quantize_q4_0(data_f32.data(), work.data(), nelements, ne[0], QK, hist_cur.data());
+                            cur_size = ggml_quantize_q4_0(data_f32.data(), work.data(), nelements, ne[0], hist_cur.data());
                         } break;
                     case GGML_TYPE_Q4_1:
                         {
-                            cur_size = ggml_quantize_q4_1(data_f32.data(), work.data(), nelements, ne[0], QK, hist_cur.data());
+                            cur_size = ggml_quantize_q4_1(data_f32.data(), work.data(), nelements, ne[0], hist_cur.data());
                         } break;
                     default:
                         {
                             fprintf(stderr, "%s: unsupported quantization type %d\n", __func__, type);
                             return false;
                         }
                 }
 
                 fout.write(reinterpret_cast<char *>(work.data()), cur_size);
                 total_size_new += cur_size;
 
                 printf("size = %8.2f MB -> %8.2f MB | hist: ", nelements * sizeof(float)/1024.0/1024.0, cur_size/1024.0/1024.0);
-                for (int i = 0; i < hist_cur.size(); ++i) {
+                for (int i = 0; i < (int) hist_cur.size(); ++i) {
                     hist_all[i] += hist_cur[i];
                 }
 
-                for (int i = 0; i < hist_cur.size(); ++i) {
-                    printf("%5.3f ", hist_cur[i] / (float)nelements);
+                for (int i = 0; i < (int) hist_cur.size(); ++i) {
+                    printf("%5.3f ", hist_cur[i] / float(nelements));
                 }
                 printf("\n");
             } else {
                 printf("size = %8.3f MB\n", data_u8.size()/1024.0/1024.0);
                 fout.write(reinterpret_cast<char *>(data_u8.data()), data_u8.size());
                 total_size_new += data_u8.size();
             }
@@ -788,265 +1603,248 @@
         }
 
         printf("%s: model size  = %8.2f MB\n", __func__, total_size_org/1024.0/1024.0);
         printf("%s: quant size  = %8.2f MB\n", __func__, total_size_new/1024.0/1024.0);
 
         {
             int64_t sum_all = 0;
-            for (int i = 0; i < hist_all.size(); ++i) {
+            for (int i = 0; i < (int) hist_all.size(); ++i) {
                 sum_all += hist_all[i];
             }
 
             printf("%s: hist: ", __func__);
-            for (int i = 0; i < hist_all.size(); ++i) {
-                printf("%5.3f ", hist_all[i] / (float)sum_all);
+            for (int i = 0; i < (int) hist_all.size(); ++i) {
+                printf("%5.3f ", hist_all[i] / float(sum_all));
             }
             printf("\n");
         }
     }
 
     finp.close();
     fout.close();
 
     return true;
 }
-// evaluate the transformer
-//
-//   - model:     the model
-//   - n_threads: number of threads to use
-//   - n_past:    the context size so far
-//   - embd_inp:  the embeddings of the tokens in the context
-//   - embd_w:    the predicted logits for the next token
+
 //
-// The GPT-J model requires about 16MB of memory per input token.
+// interface implementation
 //
-bool llama_eval(
-        const llama_model & model,
-        const int n_threads,
-        const int n_past,
-        const std::vector<gpt_vocab::id> & embd_inp,
-              std::vector<float>         & embd_w,
-              size_t                     & mem_per_token) {
-    const int N = embd_inp.size();
-
-    const auto & hparams = model.hparams;
 
-    const int n_embd  = hparams.n_embd;
-    const int n_layer = hparams.n_layer;
-    const int n_ctx   = hparams.n_ctx;
-    const int n_head  = hparams.n_head;
-    const int n_vocab = hparams.n_vocab;
-    const int n_rot   = hparams.n_embd/hparams.n_head;
+struct llama_context * llama_init_from_file(
+                             const char * path_model,
+            struct llama_context_params   params) {
+    ggml_time_init();
 
-    const int d_key = n_embd/n_head;
+    llama_context * ctx = new llama_context;
 
-     // TODO: check if this size scales with n_ctx linearly and remove constant. somehow I feel it wasn't the case
-    // static size_t buf_size = hparams.n_ctx*1024*1024;
-    static size_t buf_size = 512u*1024*1024;
-    static void * buf = malloc(buf_size);
-
-    if (mem_per_token > 0 && mem_per_token*N > buf_size) {
-        const size_t buf_size_new = 1.1*(mem_per_token*N); // add 10% to account for ggml object overhead
-        //fprintf(stderr, "\n%s: reallocating buffer from %zu to %zu bytes\n", __func__, buf_size, buf_size_new);
-
-        // reallocate
-        buf_size = buf_size_new;
-        buf = realloc(buf, buf_size);
-        if (buf == nullptr) {
-            fprintf(stderr, "%s: failed to allocate %zu bytes\n", __func__, buf_size);
-            return false;
-        }
+    if (params.seed <= 0) {
+        params.seed = time(NULL);
     }
 
-    struct ggml_init_params params = {
-        /*.mem_size   =*/ buf_size,
-        /*.mem_buffer =*/ buf,
-    };
+    ctx->rng = std::mt19937(params.seed);
+    ctx->logits_all = params.logits_all;
 
-    struct ggml_context * ctx0 = ggml_init(params);
-    ggml_cgraph gf = {};
-    gf.n_threads = n_threads;
-
-    struct ggml_tensor * embd = ggml_new_tensor_1d(ctx0, GGML_TYPE_I32, N);
-    memcpy(embd->data, embd_inp.data(), N*ggml_element_size(embd));
+    ggml_type memory_type = params.f16_kv ? GGML_TYPE_F16 : GGML_TYPE_F32;
 
-    struct ggml_tensor * inpL = ggml_get_rows(ctx0, model.tok_embeddings, embd);
+    if (!llama_model_load(path_model, *ctx, params.n_ctx, params.n_parts, memory_type,
+                          params.vocab_only, params.progress_callback,
+                          params.progress_callback_user_data)) {
+        fprintf(stderr, "%s: failed to load model\n", __func__);
+        llama_free(ctx);
+        return nullptr;
+    }
 
-    for (int il = 0; il < n_layer; ++il) {
-        struct ggml_tensor * inpSA = inpL;
+    if (params.use_mlock) {
+        char *err;
+        if (!ggml_mlock(ctx->model.ctx, &err)) {
+            fprintf(stderr, "%s\n", err);
+            free(err);
+            llama_free(ctx);
+            return nullptr;
+        }
+    }
 
-        struct ggml_tensor * cur;
+    // reserve memory for context buffers
+    {
+        if (!kv_cache_init(ctx->model.hparams, ctx->model.kv_self, memory_type, ctx->model.hparams.n_ctx)) {
+            fprintf(stderr, "%s: kv_cache_init() failed for self-attention cache\n", __func__);
+            llama_free(ctx);
+            return nullptr;
+        }
 
-        // norm
         {
-            cur = ggml_rms_norm(ctx0, inpL);
-
-            // cur = attention_norm*cur
-            cur = ggml_mul(ctx0,
-                        ggml_repeat(ctx0, model.layers[il].attention_norm, cur),
-                        cur);
+            const size_t memory_size = ggml_nbytes(ctx->model.kv_self.k) + ggml_nbytes(ctx->model.kv_self.v);
+            fprintf(stderr, "%s: kv self size  = %7.2f MB\n", __func__, memory_size / 1024.0 / 1024.0);
         }
 
-        // self-attention
-        {
-            struct ggml_tensor * Qcur = ggml_mul_mat(ctx0, model.layers[il].wq, cur);
-            struct ggml_tensor * Kcur = ggml_mul_mat(ctx0, model.layers[il].wk, cur);
-            struct ggml_tensor * Vcur = ggml_mul_mat(ctx0, model.layers[il].wv, cur);
+        const auto & hparams = ctx->model.hparams;
 
-            // store key and value to memory
-            if (N >= 1) {
-                struct ggml_tensor * k = ggml_view_1d(ctx0, model.memory_k, N*n_embd, (ggml_element_size(model.memory_k)*n_embd)*(il*n_ctx + n_past));
-                struct ggml_tensor * v = ggml_view_1d(ctx0, model.memory_v, N*n_embd, (ggml_element_size(model.memory_v)*n_embd)*(il*n_ctx + n_past));
+        // resized during inference
+        if (params.logits_all) {
+            ctx->logits.reserve(hparams.n_ctx*hparams.n_vocab);
+        } else {
+            ctx->logits.reserve(hparams.n_ctx);
+        }
 
-                ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Kcur, k));
-                ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Vcur, v));
-            }
+        if (params.embedding){
+            ctx->embedding.resize(hparams.n_embd);
+        }
 
-            // Q = Qcur.contiguous().view(n_embd/n_head, n_head, N).permute(0, 2, 1, 3)
-            struct ggml_tensor * Q =
-                ggml_permute(ctx0,
-                        ggml_rope(ctx0,
-                            ggml_cpy(ctx0,
-                                Qcur,
-                                ggml_new_tensor_3d(ctx0, GGML_TYPE_F32, n_embd/n_head, n_head, N)),
-                            n_past, n_rot, 0),
-                        0, 2, 1, 3);
+        ctx->buf_compute.resize(MEM_REQ_EVAL.at(ctx->model.type));
 
-            // K = Kmem.view(n_embd/n_head, n_head, n_past + N).permute(0, 2, 1, 3)
-            struct ggml_tensor * K =
-                ggml_permute(ctx0,
-                        ggml_rope(ctx0,
-                            ggml_reshape_3d(ctx0,
-                                ggml_view_1d(ctx0, model.memory_k, (n_past + N)*n_embd, il*n_ctx*ggml_element_size(model.memory_k)*n_embd),
-                                n_embd/n_head, n_head, n_past + N),
-                            n_past, n_rot, 1),
-                        0, 2, 1, 3);
+        ctx->buf_scratch[0].resize(MEM_REQ_SCRATCH0.at(ctx->model.type));
+        ctx->buf_scratch[1].resize(MEM_REQ_SCRATCH1.at(ctx->model.type));
+    }
 
-            // K * Q
-            struct ggml_tensor * KQ = ggml_mul_mat(ctx0, K, Q);
+    return ctx;
+}
 
-            // KQ_scaled = KQ / sqrt(n_embd/n_head)
-            struct ggml_tensor * KQ_scaled =
-                ggml_scale(ctx0,
-                        KQ,
-                        ggml_new_f32(ctx0, 1.0f/sqrt(float(n_embd)/n_head))
-                        );
+void llama_free(struct llama_context * ctx) {
+    kv_cache_free(ctx->model.kv_self);
 
-            // KQ_masked = mask_past(KQ_scaled)
-            struct ggml_tensor * KQ_masked = ggml_diag_mask_inf(ctx0, KQ_scaled, n_past);
+    if (ctx->model.ctx) {
+        ggml_free(ctx->model.ctx);
+    }
 
-            // KQ = soft_max(KQ_masked)
-            struct ggml_tensor * KQ_soft_max = ggml_soft_max(ctx0, KQ_masked);
+    delete ctx;
+}
 
-            // V_trans = Vmem.view(n_embd/n_head, n_head, n_past + N).permute(1, 2, 0, 3).contiguous()
-            struct ggml_tensor * V_trans =
-                ggml_permute(ctx0,
-                        ggml_reshape_3d(ctx0,
-                            ggml_view_1d(ctx0, model.memory_v, (n_past + N)*n_embd, il*n_ctx*ggml_element_size(model.memory_v)*n_embd),
-                            n_embd/n_head, n_head, n_past + N),
-                        1, 2, 0, 3);
+int llama_model_quantize(
+        const char * fname_inp,
+        const char * fname_out,
+               int   itype) {
+    if (!llama_model_quantize_internal(fname_inp, fname_out, itype)) {
+        fprintf(stderr, "%s: failed to quantize\n", __func__);
+        return 1;
+    }
 
-            // KQV = transpose(V) * KQ_soft_max
-            struct ggml_tensor * KQV = ggml_mul_mat(ctx0, V_trans, KQ_soft_max);
+    return 0;
+}
 
-            // KQV_merged = KQV.permute(0, 2, 1, 3)
-            struct ggml_tensor * KQV_merged = ggml_permute(ctx0, KQV, 0, 2, 1, 3);
+int llama_eval(
+        struct llama_context * ctx,
+           const llama_token * tokens,
+                         int   n_tokens,
+                         int   n_past,
+                         int   n_threads) {
+    if (!llama_eval_internal(*ctx, tokens, n_tokens, n_past, n_threads)) {
+        fprintf(stderr, "%s: failed to eval\n", __func__);
+        return 1;
+    }
 
-            // cur = KQV_merged.contiguous().view(n_embd, N)
-            cur = ggml_cpy(ctx0,
-                    KQV_merged,
-                    ggml_new_tensor_2d(ctx0, GGML_TYPE_F32, n_embd, N));
+    return 0;
+}
 
-            // projection (no bias)
-            cur = ggml_mul_mat(ctx0,
-                    model.layers[il].wo,
-                    cur);
-        }
+int llama_tokenize(
+        struct llama_context * ctx,
+                  const char * text,
+                 llama_token * tokens,
+                         int   n_max_tokens,
+                        bool   add_bos) {
+    auto res = llama_tokenize(ctx->vocab, text, add_bos);
 
-        struct ggml_tensor * inpFF = ggml_add(ctx0, cur, inpSA);
+    if (n_max_tokens < (int) res.size()) {
+        fprintf(stderr, "%s: too many tokens\n", __func__);
+        return -((int) res.size());
+    }
 
-        // feed-forward network
-        {
-            // norm
-            {
-                cur = ggml_rms_norm(ctx0, inpFF);
+    for (size_t i = 0; i < res.size(); i++) {
+        tokens[i] = res[i];
+    }
 
-                // cur = ffn_norm*cur
-                cur = ggml_mul(ctx0,
-                        ggml_repeat(ctx0, model.layers[il].ffn_norm, cur),
-                        cur);
-            }
+    return res.size();
+}
 
-            struct ggml_tensor * tmp = ggml_mul_mat(ctx0,
-                    model.layers[il].w3,
-                    cur);
+int llama_n_vocab(struct llama_context * ctx) {
+    return ctx->vocab.id_to_token.size();
+}
 
+int llama_n_ctx(struct llama_context * ctx) {
+    return ctx->model.hparams.n_ctx;
+}
 
-            cur = ggml_mul_mat(ctx0,
-                    model.layers[il].w1,
-                    cur);
+int llama_n_embd(struct llama_context * ctx) {
+    return ctx->model.hparams.n_embd;
+}
 
-            // SILU activation
-            cur = ggml_silu(ctx0, cur);
+float * llama_get_logits(struct llama_context * ctx) {
+    return ctx->logits.data();
+}
 
-            cur = ggml_mul(ctx0, cur, tmp);
+float * llama_get_embeddings(struct llama_context * ctx) {
+    return ctx->embedding.data();
+}
 
-            cur = ggml_mul_mat(ctx0,
-                    model.layers[il].w2,
-                    cur);
-        }
+const char * llama_token_to_str(struct llama_context * ctx, llama_token token) {
+    if (token >= llama_n_vocab(ctx)) {
+        return nullptr;
+    }
 
-        cur  = ggml_add(ctx0, cur, inpFF);
+    return ctx->vocab.id_to_token[token].tok.c_str();
+}
 
-        // input for next layer
-        inpL = cur;
-    }
+llama_token llama_token_bos() {
+    return 1;
+}
 
-    // norm
-    {
-        inpL = ggml_rms_norm(ctx0, inpL);
+llama_token llama_token_eos() {
+    return 2;
+}
 
-        // inpL = norm*inpL
-        inpL = ggml_mul(ctx0,
-                    ggml_repeat(ctx0, model.norm, inpL),
-                    inpL);
-    }
+llama_token llama_sample_top_p_top_k(
+          llama_context * ctx,
+      const llama_token * last_n_tokens_data,
+                    int   last_n_tokens_size,
+                    int   top_k,
+                  float   top_p,
+                  float   temp,
+                  float   repeat_penalty) {
+    const int64_t t_start_sample_us = ggml_time_us();
 
-    // lm_head
-    {
-        inpL = ggml_mul_mat(ctx0, model.output, inpL);
-    }
+    llama_token result = 0;
 
-    // logits -> probs
-    //inpL = ggml_soft_max(ctx0, inpL);
+    // TODO: avoid this ...
+    const auto last_n_tokens = std::vector<llama_token>(last_n_tokens_data, last_n_tokens_data + last_n_tokens_size);
 
-    // run the computation
-    ggml_build_forward_expand(&gf, inpL);
-    ggml_graph_compute       (ctx0, &gf);
+    result = llama_sample_top_p_top_k(
+            *ctx,
+            last_n_tokens,
+            top_k,
+            top_p,
+            temp,
+            repeat_penalty);
 
-    //if (n_past%100 == 0) {
-    //    ggml_graph_print   (&gf);
-    //    ggml_graph_dump_dot(&gf, NULL, "gpt-2.dot");
-    //}
+    ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
+    ctx->n_sample++;
 
-    //embd_w.resize(n_vocab*N);
-    //memcpy(embd_w.data(), ggml_get_data(inpL), sizeof(float)*n_vocab*N);
+    return result;
+}
 
-    // return result for just the last token
-    embd_w.resize(n_vocab);
-    memcpy(embd_w.data(), (float *) ggml_get_data(inpL) + (n_vocab*(N-1)), sizeof(float)*n_vocab);
 
-    if (mem_per_token == 0) {
-        mem_per_token = ggml_used_mem(ctx0)/N;
-    }
-    //fprintf(stderr, "used_mem = %zu\n", ggml_used_mem(ctx0));
+void llama_print_timings(struct llama_context * ctx) {
+    const int64_t t_end_us = ggml_time_us();
 
-    ggml_free(ctx0);
+    const int32_t n_sample = std::max(1, ctx->n_sample);
+    const int32_t n_eval   = std::max(1, ctx->n_eval);
+    const int32_t n_p_eval = std::max(1, ctx->n_p_eval);
 
-    return true;
+    fprintf(stderr, "\n");
+    fprintf(stderr, "%s:        load time = %8.2f ms\n", __func__, ctx->t_load_us / 1000.0);
+    fprintf(stderr, "%s:      sample time = %8.2f ms / %5d runs   (%8.2f ms per run)\n",   __func__, 1e-3 * ctx->t_sample_us, n_sample, 1e-3 * ctx->t_sample_us / n_sample);
+    fprintf(stderr, "%s: prompt eval time = %8.2f ms / %5d tokens (%8.2f ms per token)\n", __func__, 1e-3 * ctx->t_p_eval_us, n_p_eval, 1e-3 * ctx->t_p_eval_us / n_p_eval);
+    fprintf(stderr, "%s:        eval time = %8.2f ms / %5d runs   (%8.2f ms per run)\n",   __func__, 1e-3 * ctx->t_eval_us,   n_eval,   1e-3 * ctx->t_eval_us   / n_eval);
+    fprintf(stderr, "%s:       total time = %8.2f ms\n", __func__, (t_end_us - ctx->t_start_us)/1000.0);
+}
+
+void llama_reset_timings(struct llama_context * ctx) {
+    ctx->t_start_us = ggml_time_us();
+
+    ctx->t_sample_us = ctx->n_sample = 0;
+    ctx->t_eval_us   = ctx->n_eval   = 0;
+    ctx->t_p_eval_us = ctx->n_p_eval = 0;
 }
 
 const char * llama_print_system_info(void) {
     static std::string s;
 
     s  = "";
     s += "AVX = "       + std::to_string(ggml_cpu_has_avx())       + " | ";
@@ -1060,326 +1858,7 @@
     s += "WASM_SIMD = " + std::to_string(ggml_cpu_has_wasm_simd()) + " | ";
     s += "BLAS = "      + std::to_string(ggml_cpu_has_blas())      + " | ";
     s += "SSE3 = "      + std::to_string(ggml_cpu_has_sse3())      + " | ";
     s += "VSX = "       + std::to_string(ggml_cpu_has_vsx())       + " | ";
 
     return s.c_str();
 }
-
-/* External API */
-/// @brief Initialize the context from a set of parameters
-/// @param params 
-llama_context* llama_init_from_params(const gpt_params& params) {
-    llama_model model{};
-    gpt_vocab vocab{};
-
-    const ggml_type memory_type = params.memory_f16 ? GGML_TYPE_F16 : GGML_TYPE_F32;
-
-    // Compute time taken to load model
-    const int64_t t_start = ggml_time_us();
-    
-    bool ret = llama_model_load(params.model, model, vocab, params.n_ctx, memory_type);
-    const int64_t t_end = ggml_time_us();
-    if(!ret)
-    {
-        return nullptr;
-    }
-    llama_context* ctx =  new llama_context(std::move(model), std::move(vocab), params);
-    ctx->state->timing.t_load_us = t_end - t_start;
-    ctx->state->rng = std::mt19937(params.seed);
-    return ctx;
-}
-/// @brief Prepare the context for inference
-/// @param ctx 
-bool llama_prepare_context(llama_context& ctx)
-{
-    llama_state& state = *ctx.state;
-    llama_model& model = ctx.model;
-    gpt_params& params = ctx.params;
-
-    int n_predict = std::min(params.n_predict, model.hparams.n_ctx - (int) state.embd_inp.size());
-    params.n_predict = n_predict;
-
-    // determine the required inference memory per token:
-    state.mem_per_token = 0;
-    if(!llama_eval(model, params.n_threads, 0, { 0, 1, 2, 3 }, state.logits, state.mem_per_token))
-    {
-        fprintf(stderr, "Failed to predict with initial prompt\n");
-        return false;
-    }
-
-    int last_n_size = params.repeat_last_n;
-    state.last_n_tokens = std::vector<gpt_vocab::id>(last_n_size);
-    std::fill(state.last_n_tokens.begin(), state.last_n_tokens.end(), 0);
-    state.is_initialized = true;
-    state.remaining_tokens = params.n_predict;
-    state.input_consumed = 0;
-    return true;
-}
-/// @brief Free the context
-void llama_free_context(llama_context* ctx) {
-    delete ctx;
-}
-
-/* Getters and setters */
-/// @brief Get the embedding vector for the last token
-const std::vector<gpt_vocab::id>& llama_context_get_embedding(const llama_context& ctx) {
-    return ctx.state->embd;
-}
-/// @brief Get the vector for the last token
-/// @param ctx 
-gpt_vocab& llama_context_get_vocab(llama_context& ctx) {
-    return ctx.vocab;
-}
-/// @brief Is the context finished?
-/// @param ctx 
-bool llama_context_is_finished(const llama_context& ctx)
-{
-    return ctx.state->remaining_tokens <= 0;
-}
-/// @brief Is the context finished?
-/// @param ctx 
-void llama_reset_remaining_tokens(const llama_context& ctx)
-{
-    ctx.state->remaining_tokens = ctx.params.n_predict;
-}
-
-/// @brief Tokenize a text into a vector of ids
-/// @param ctx
-/// @param text
-const std::vector<gpt_vocab::id> llama_tokenize_text(const llama_context& ctx, const std::string& text) {
-    // Make sure that the "beginning of string" token is not prefixed to the text
-    return llama_tokenize(ctx.vocab, text, false);
-}
-const std::vector<gpt_vocab::id>& llama_context_get_last_n_tokens(const llama_context& ctx) {
-    return ctx.state->last_n_tokens;
-}
-
-/// @brief Adds the "beginning of string" token to the model input
-/// @param ctx 
-void llama_add_bos(llama_context& ctx){
-    // Add the "bos" token into the model input
-    llama_state& state = *ctx.state;
-    llama_model& model = ctx.model;
-    const gpt_params& params = ctx.params;
-
-    const gpt_vocab::id bos_token = 1;
-    state.embd_inp.push_back(bos_token);
-}
-
-/// @brief Updates the context and appends new input text
-/// @param ctx 
-/// @param text 
-void llama_update_input(llama_context& ctx, const std::string& text)
-{
-    llama_state& state = *ctx.state;
-    llama_model& model = ctx.model;
-    const gpt_params& params = ctx.params;
-
-    std::vector<gpt_vocab::id> line_inp = llama_tokenize_text(ctx, text);
-
-    state.embd_inp.insert(state.embd_inp.end(), line_inp.begin(), line_inp.end());
-    state.remaining_tokens -= line_inp.size();
-}
-/// @brief Updates the context and appends new input tokens (overloaded version)
-/// @param ctx
-/// @param tokens
-void llama_update_input(llama_context& ctx, const std::vector<gpt_vocab::id>& tokens)
-{
-    llama_state& state = *ctx.state;
-    llama_model& model = ctx.model;
-    const gpt_params& params = ctx.params;
-
-    state.embd_inp.insert(state.embd_inp.end(), tokens.begin(), tokens.end());
-    state.remaining_tokens -= tokens.size();
-}
-
-/// @brief  Ingests a batch of input tokens into the context
-/// @param ctx 
-void llama_ingest_input_batch(llama_context& ctx)
-{
-    llama_state& state = *ctx.state;
-    const gpt_params& params = ctx.params;
-
-    // Copy at most n_batch elements from embd_inp to embd
-    size_t num_copied = std::min((size_t) params.n_batch+1, state.embd_inp.size() - state.input_consumed);
-    std::copy(state.embd_inp.begin() + state.input_consumed,
-                state.embd_inp.begin() + state.input_consumed + num_copied,
-                std::back_inserter(state.embd));
-    state.input_consumed += num_copied;
-
-    // Copy the last `repeat_last_n` elements copied into embd to last_n_tokens
-    size_t num_copied_last_n = std::min(num_copied, (size_t) params.repeat_last_n);
-    state.last_n_tokens.erase(state.last_n_tokens.begin(), state.last_n_tokens.begin()+num_copied_last_n);
-    state.last_n_tokens.insert(state.last_n_tokens.end(), state.embd.end() - num_copied_last_n, state.embd.end());
-}
-
-/// @brief Returns true if there is unconsumed input in the context
-/// @param ctx 
-bool llama_has_unconsumed_input(llama_context& ctx)
-{
-    llama_state& state = *ctx.state;
-    return state.input_consumed < state.embd_inp.size();
-}
-
-/// @brief Ingest all input (in multiple batches) into model and run call predict()
-/// @param ctx  
-bool llama_ingest_all_pending_input(llama_context& ctx, bool print_tokens)
-{
-    llama_state& state = *ctx.state;
-    const std::vector<gpt_vocab::id>& embd = state.embd;
-    gpt_vocab& vocab = ctx.vocab;
-
-    if(!state.is_initialized)
-    {
-        fprintf(stderr, "Context must be initialized before ingesting input");
-        return false;
-    }
-
-    // ingest the tokens into the model one batch at a time
-    while (llama_has_unconsumed_input(ctx)) 
-    {
-        llama_ingest_input_batch(ctx);
-        if (print_tokens) {
-            std::string s = llama_tokens_to_string(vocab, embd);
-            printf("%s", s.c_str());
-            fflush(stdout);
-        }
-        llama_eval_model(ctx);
-    }
-    return true;
-}
-/// @brief Evaluate the model with the current input batch
-/// @param ctx 
-bool llama_eval_model(llama_context& ctx)
-{
-    llama_state& state = *ctx.state;
-    llama_model& model = ctx.model;
-    const gpt_params& params = ctx.params;
-
-    if (state.embd.size() > 0) {
-        const int64_t t_start_us = ggml_time_us();
-
-        if (!llama_eval(model, params.n_threads, state.n_past, state.embd, state.logits, state.mem_per_token)) {
-            fprintf(stderr, "Failed to predict\n");
-            return false;
-        }
-        state.timing.t_predict_us += ggml_time_us() - t_start_us;
-    }
-    state.n_past += state.embd.size();
-    state.embd.clear();
-    return true;
-}
-/// @brief  Sample a token from the logits
-/// @param ctx 
-/// @return token id
-gpt_vocab::id llama_sample_token(llama_context& ctx)
-{
-    llama_state& state = *ctx.state;
-    llama_model& model = ctx.model;
-    const gpt_params& params = ctx.params;
-
-    const float top_k = params.top_k;
-    const float top_p = params.top_p;
-    const float temp  = params.temp;
-    const float repeat_penalty = params.repeat_penalty;
-
-    const int n_vocab = model.hparams.n_vocab;
-
-    gpt_vocab::id id = 0;
-
-    {
-        const int64_t t_start_sample_us = ggml_time_us();
-
-        id = llama_sample_top_p_top_k(ctx.vocab, state.logits.data() + (state.logits.size() - n_vocab),
-            state.last_n_tokens, repeat_penalty, top_k, top_p, temp, state.rng);
-
-        state.last_n_tokens.erase(state.last_n_tokens.begin());
-        state.last_n_tokens.push_back(id);
-
-        state.timing.t_sample_us += ggml_time_us() - t_start_sample_us;
-    }
-    return id;
-}
-/// @brief  Run inference for one token and return the token id
-/// @param ctx
-/// @param id
-bool llama_infer(llama_context& ctx, gpt_vocab::id& id) {
-    llama_state& state = *ctx.state;
-
-    // Tokenize text if we are starting out
-    if(!state.is_initialized)
-    {
-        fprintf(stderr, "State must be initialized before running inference");
-        return false;
-    }
-
-    // No more tokens to generate
-    if (state.remaining_tokens <= 0) {
-        return false;
-    }
-
-    // Already predicted, so we just need to sample
-    // sample a token
-    id = llama_sample_token(ctx);
-
-    // add it to the context
-    state.embd.push_back(id);
-
-    // decrement remaining sampling budget
-    --state.remaining_tokens;
-
-    return true;
-}
-/// @brief  Run inference for one token and return the token as a string
-/// @param ctx
-/// @param output
-/// @param is_end_of_text
-bool llama_infer(llama_context& ctx, std::string& output, bool& is_end_of_text) {
-    // Call overloaded llama_infer and convert to string before returning
-    gpt_vocab::id id_int;
-    is_end_of_text = false;
-    if(!llama_infer(ctx, id_int)){
-        return false;
-    }
-    
-    // Pass through the "end of text" token to the user
-    is_end_of_text = (id_int == EOS_TOKEN_ID);
-
-    // Make sure to pass in the newly generated token to the model as well
-    llama_eval_model(ctx);
-    output = ctx.vocab.id_to_token.at(id_int);
-    return true;
-}
-bool llama_is_anti_prompt_present(llama_context& ctx, const std::vector<gpt_vocab::id>& antiprompt_inp)
-{
-    llama_state& state = *ctx.state;
-    return std::equal(antiprompt_inp.rbegin(), antiprompt_inp.rend(), state.last_n_tokens.rbegin());
-}
-
-void llama_print_startup_stats(const llama_context& ctx)
-{
-    const gpt_params& params = ctx.params;
-    const std::vector<gpt_vocab::id>& embd_inp = ctx.state->embd_inp;
-    {
-        fprintf(stderr, "\n");
-        fprintf(stderr, "system_info: n_threads = %d / %d | %s\n",
-                params.n_threads, std::thread::hardware_concurrency(), llama_print_system_info());
-    }
-    fprintf(stderr, "\n");
-    fprintf(stderr, "%s: prompt: '%s'\n", __func__, params.prompt.c_str());
-    fprintf(stderr, "%s: number of tokens in prompt = %zu\n", __func__, embd_inp.size());
-    for (int i = 0; i < (int) embd_inp.size(); i++) {
-        fprintf(stderr, "%6d -> '%s'\n", embd_inp[i], ctx.vocab.id_to_token.at(embd_inp[i]).c_str());
-    }
-    fprintf(stderr, "\n");
-}
-
-void llama_print_end_stats(const llama_context& ctx)
-{
-    const llama_state& state = *ctx.state;
-    fprintf(stderr, "\n\n");
-    fprintf(stderr, "%s: mem per token = %8zu bytes\n", __func__, state.mem_per_token);
-    fprintf(stderr, "%s:     load time = %8.2f ms\n", __func__, state.timing.t_load_us/1000.0f);
-    fprintf(stderr, "%s:   sample time = %8.2f ms\n", __func__, state.timing.t_sample_us/1000.0f);
-    fprintf(stderr, "%s:  predict time = %8.2f ms / %.2f ms per token\n", __func__, state.timing.t_predict_us/1000.0f,  state.timing.t_predict_us/1000.0f/state.n_past);
-}
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/quantize.cpp` & `llamacpp-0.1.9/vendor/llama.cpp/examples/quantize/quantize.cpp`

 * *Files 22% similar despite different names*

```diff
@@ -1,30 +1,19 @@
 #include "ggml.h"
-
-#include "utils.h"
 #include "llama.h"
 
-#include <cassert>
-#include <cmath>
 #include <cstdio>
-#include <cstring>
-#include <fstream>
-#include <map>
 #include <string>
-#include <vector>
-
-
-// quantize a model
-
 
 // usage:
 //  ./llama-quantize models/llama/ggml-model.bin models/llama/ggml-model-quant.bin type
 //
 int main(int argc, char ** argv) {
     ggml_time_init();
+
     if (argc != 4) {
         fprintf(stderr, "usage: %s model-f32.bin model-quant.bin type\n", argv[0]);
         fprintf(stderr, "  type = 2 - q4_0\n");
         fprintf(stderr, "  type = 3 - q4_1\n");
         return 1;
     }
 
@@ -44,26 +33,26 @@
 
     int64_t t_quantize_us = 0;
 
     // load the model
     {
         const int64_t t_start_us = ggml_time_us();
 
-        if (!llama_model_quantize(fname_inp, fname_out, itype)) {
+        if (llama_model_quantize(fname_inp.c_str(), fname_out.c_str(), itype)) {
             fprintf(stderr, "%s: failed to quantize model from '%s'\n", __func__, fname_inp.c_str());
             return 1;
         }
 
         t_quantize_us = ggml_time_us() - t_start_us;
     }
 
     // report timing
     {
         const int64_t t_main_end_us = ggml_time_us();
 
         printf("\n");
-        printf("%s: quantize time = %8.2f ms\n", __func__, t_quantize_us/1000.0f);
-        printf("%s:    total time = %8.2f ms\n", __func__, (t_main_end_us - t_main_start_us)/1000.0f);
+        printf("%s: quantize time = %8.2f ms\n", __func__, t_quantize_us/1000.0);
+        printf("%s:    total time = %8.2f ms\n", __func__, (t_main_end_us - t_main_start_us)/1000.0);
     }
 
     return 0;
 }
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/quantize.py` & `llamacpp-0.1.9/vendor/llama.cpp/quantize.py`

 * *Files 5% similar despite different names*

```diff
@@ -53,14 +53,15 @@
     #     '-t', '--threads', dest='threads', type='int',
     #     default=os.cpu_count(),
     #     help='Specify the number of threads to use to quantize many models at '
     #     'once. Defaults to os.cpu_count().'
     # )
 
     args = parser.parse_args()
+    args.models_path = os.path.abspath(args.models_path)
 
     if not os.path.isfile(args.quantize_script_path):
         print(
             f'The "{quantize_script_binary}" script was not found in the '
             "current location.\nIf you want to use it from another location, "
             "set the --quantize-script-path argument from the command line."
         )
@@ -69,14 +70,18 @@
     for model in args.models:
         # The model is separated in various parts
         # (ggml-model-f16.bin, ggml-model-f16.bin.0, ggml-model-f16.bin.1...)
         f16_model_path_base = os.path.join(
             args.models_path, model, "ggml-model-f16.bin"
         )
 
+        if not os.path.isfile(f16_model_path_base):
+            print(f'The file %s was not found' % f16_model_path_base)
+            sys.exit(1)
+
         f16_model_parts_paths = map(
             lambda filename: os.path.join(f16_model_path_base, filename),
             glob.glob(f"{f16_model_path_base}*")
         )
 
         for f16_model_part_path in f16_model_parts_paths:
             if not os.path.isfile(f16_model_part_path):
```

### Comparing `llamacpp-0.1.8/vendor/llama.cpp/utils.cpp` & `llamacpp-0.1.9/vendor/llama.cpp/examples/main/main.cpp`

 * *Files 26% similar despite different names*

```diff
@@ -1,596 +1,455 @@
-#include "utils.h"
+#include "common.h"
+#include "llama.h"
 
 #include <cassert>
+#include <cinttypes>
+#include <cmath>
+#include <cstdio>
 #include <cstring>
 #include <fstream>
-#include <regex>
 #include <iostream>
-#include <iterator>
 #include <string>
-#include <math.h>
+#include <vector>
 
- #if defined(_MSC_VER) || defined(__MINGW32__)
- #include <malloc.h> // using malloc.h with MSC/MINGW
- #elif !defined(__FreeBSD__) && !defined(__NetBSD__)
- #include <alloca.h>
- #endif
-
-bool gpt_params_parse(int argc, char ** argv, gpt_params & params) {
-    // determine sensible default number of threads.
-    // std::thread::hardware_concurrency may not be equal to the number of cores, or may return 0.
-#ifdef __linux__
-    std::ifstream cpuinfo("/proc/cpuinfo");
-    params.n_threads = std::count(std::istream_iterator<std::string>(cpuinfo),
-                                  std::istream_iterator<std::string>(),
-                                  std::string("processor"));
+#if defined (__unix__) || (defined (__APPLE__) && defined (__MACH__))
+#include <signal.h>
+#include <unistd.h>
+#elif defined (_WIN32)
+#include <signal.h>
 #endif
-    if (params.n_threads == 0) {
-        params.n_threads = std::max(1, (int32_t) std::thread::hardware_concurrency());
-    }
 
-    for (int i = 1; i < argc; i++) {
-        std::string arg = argv[i];
+static console_state con_st;
+
+static bool is_interacting = false;
 
-        if (arg == "-s" || arg == "--seed") {
-            params.seed = std::stoi(argv[++i]);
-        } else if (arg == "-t" || arg == "--threads") {
-            params.n_threads = std::stoi(argv[++i]);
-        } else if (arg == "-p" || arg == "--prompt") {
-            params.prompt = argv[++i];
-        } else if (arg == "-f" || arg == "--file") {
-            std::ifstream file(argv[++i]);
-            std::copy(std::istreambuf_iterator<char>(file), std::istreambuf_iterator<char>(), back_inserter(params.prompt));
-            if (params.prompt.back() == '\n') {
-                params.prompt.pop_back();
-            }
-        } else if (arg == "-n" || arg == "--n_predict") {
-            params.n_predict = std::stoi(argv[++i]);
-        } else if (arg == "--top_k") {
-            params.top_k = std::stoi(argv[++i]);
-        } else if (arg == "-c" || arg == "--ctx_size") {
-            params.n_ctx = std::stoi(argv[++i]);
-        } else if (arg == "--memory_f16") {
-            params.memory_f16 = true;
-        } else if (arg == "--top_p") {
-            params.top_p = std::stof(argv[++i]);
-        } else if (arg == "--temp") {
-            params.temp = std::stof(argv[++i]);
-        } else if (arg == "--repeat_last_n") {
-            params.repeat_last_n = std::stoi(argv[++i]);
-        } else if (arg == "--repeat_penalty") {
-            params.repeat_penalty = std::stof(argv[++i]);
-        } else if (arg == "-b" || arg == "--batch_size") {
-            params.n_batch = std::stoi(argv[++i]);
-        } else if (arg == "-m" || arg == "--model") {
-            params.model = argv[++i];
-        } else if (arg == "-i" || arg == "--interactive") {
-            params.interactive = true;
-        } else if (arg == "-ins" || arg == "--instruct") {
-            params.instruct = true;
-        } else if (arg == "--color") {
-            params.use_color = true;
-        } else if (arg == "-r" || arg == "--reverse-prompt") {
-            params.antiprompt.push_back(argv[++i]);
-        } else if (arg == "--ignore-eos") {
-            params.ignore_eos = true;
-        } else if (arg == "-h" || arg == "--help") {
-            gpt_print_usage(argc, argv, params);
-            exit(0);
-        } else if (arg == "--random-prompt") {
-            params.random_prompt = true;
+#if defined (__unix__) || (defined (__APPLE__) && defined (__MACH__)) || defined (_WIN32)
+void sigint_handler(int signo) {
+    set_console_color(con_st, CONSOLE_COLOR_DEFAULT);
+    printf("\n"); // this also force flush stdout.
+    if (signo == SIGINT) {
+        if (!is_interacting) {
+            is_interacting=true;
         } else {
-            fprintf(stderr, "error: unknown argument: %s\n", arg.c_str());
-            gpt_print_usage(argc, argv, params);
-            exit(0);
+            _exit(130);
         }
     }
-
-    return true;
 }
+#endif
 
-void gpt_print_usage(int /*argc*/, char ** argv, const gpt_params & params) {
-    fprintf(stderr, "usage: %s [options]\n", argv[0]);
-    fprintf(stderr, "\n");
-    fprintf(stderr, "options:\n");
-    fprintf(stderr, "  -h, --help            show this help message and exit\n");
-    fprintf(stderr, "  -i, --interactive     run in interactive mode\n");
-    fprintf(stderr, "  -ins, --instruct      run in instruction mode (use with Alpaca models)\n");
-    fprintf(stderr, "  -r PROMPT, --reverse-prompt PROMPT\n");
-    fprintf(stderr, "                        in interactive mode, poll user input upon seeing PROMPT (can be\n");
-    fprintf(stderr, "                        specified more than once for multiple prompts).\n");
-    fprintf(stderr, "  --color               colorise output to distinguish prompt and user input from generations\n");
-    fprintf(stderr, "  -s SEED, --seed SEED  RNG seed (default: -1)\n");
-    fprintf(stderr, "  -t N, --threads N     number of threads to use during computation (default: %d)\n", params.n_threads);
-    fprintf(stderr, "  -p PROMPT, --prompt PROMPT\n");
-    fprintf(stderr, "                        prompt to start generation with (default: empty)\n");
-    fprintf(stderr, "  --random-prompt       start with a randomized prompt.\n");
-    fprintf(stderr, "  -f FNAME, --file FNAME\n");
-    fprintf(stderr, "                        prompt file to start generation.\n");
-    fprintf(stderr, "  -n N, --n_predict N   number of tokens to predict (default: %d)\n", params.n_predict);
-    fprintf(stderr, "  --top_k N             top-k sampling (default: %d)\n", params.top_k);
-    fprintf(stderr, "  --top_p N             top-p sampling (default: %.1f)\n", params.top_p);
-    fprintf(stderr, "  --repeat_last_n N     last n tokens to consider for penalize (default: %d)\n", params.repeat_last_n);
-    fprintf(stderr, "  --repeat_penalty N    penalize repeat sequence of tokens (default: %.1f)\n", params.repeat_penalty);
-    fprintf(stderr, "  -c N, --ctx_size N    size of the prompt context (default: %d)\n", params.n_ctx);
-    fprintf(stderr, "  --ignore-eos          ignore end of stream token and continue generating\n");
-    fprintf(stderr, "  --memory_f16          use f16 instead of f32 for memory key+value\n");
-    fprintf(stderr, "  --temp N              temperature (default: %.1f)\n", params.temp);
-    fprintf(stderr, "  -b N, --batch_size N  batch size for prompt processing (default: %d)\n", params.n_batch);
-    fprintf(stderr, "  -m FNAME, --model FNAME\n");
-    fprintf(stderr, "                        model path (default: %s)\n", params.model.c_str());
-    fprintf(stderr, "\n");
-}
+int main(int argc, char ** argv) {
+    gpt_params params;
+    params.model = "models/llama-7B/ggml-model.bin";
 
-std::string gpt_random_prompt(std::mt19937 & rng) {
-    const int r = rng() % 10;
-    switch (r) {
-        case 0: return "So";
-        case 1: return "Once upon a time";
-        case 2: return "When";
-        case 3: return "The";
-        case 4: return "After";
-        case 5: return "If";
-        case 6: return "import";
-        case 7: return "He";
-        case 8: return "She";
-        case 9: return "They";
-        default: return "To";
+    if (gpt_params_parse(argc, argv, params) == false) {
+        return 1;
     }
 
-    return "The";
-}
+    // save choice to use color for later
+    // (note for later: this is a slightly awkward choice)
+    con_st.use_color = params.use_color;
 
-void replace(std::string & str, const std::string & needle, const std::string & replacement) {
-    size_t pos = 0;
-    while ((pos = str.find(needle, pos)) != std::string::npos) {
-        str.replace(pos, needle.length(), replacement);
-        pos += replacement.length();
-    }
-}
-
-std::map<std::string, int32_t> json_parse(const std::string & fname) {
-    std::map<std::string, int32_t> result;
+#if defined (_WIN32)
+    win32_console_init(params.use_color);
+#endif
 
-    // read file into string
-    std::string json;
-    {
-        std::ifstream ifs(fname);
-        if (!ifs) {
-            fprintf(stderr, "Failed to open %s\n", fname.c_str());
-            exit(1);
-        }
+    if (params.perplexity) {
+        printf("\n************\n");
+        printf("%s: please use the 'perplexity' tool for perplexity calculations\n", __func__);
+        printf("************\n\n");
 
-        json = std::string((std::istreambuf_iterator<char>(ifs)),
-                (std::istreambuf_iterator<char>()));
+        return 0;
     }
 
-    if (json[0] != '{') {
-        return result;
-    }
+    if (params.embedding) {
+        printf("\n************\n");
+        printf("%s: please use the 'embedding' tool for embedding calculations\n", __func__);
+        printf("************\n\n");
 
-    // parse json
-    {
-        bool has_key  = false;
-        bool in_token = false;
+        return 0;
+    }
 
-        std::string str_key = "";
-        std::string str_val = "";
+    if (params.n_ctx > 2048) {
+        fprintf(stderr, "%s: warning: model does not support context sizes greater than 2048 tokens (%d specified);"
+                "expect poor results\n", __func__, params.n_ctx);
+    }
 
-        int n = json.size();
-        for (int i = 1; i < n; ++i) {
-            if (!in_token) {
-                if (json[i] == ' ') continue;
-                if (json[i] == '"') {
-                    in_token = true;
-                    continue;
-                }
-            } else {
-                if (json[i] == '\\' && i+1 < n) {
-                    if (has_key == false) {
-                        str_key += json[i];
-                    } else {
-                        str_val += json[i];
-                    }
-                    ++i;
-                } else if (json[i] == '"') {
-                    if (has_key == false) {
-                        has_key = true;
-                        ++i;
-                        while (json[i] == ' ') ++i;
-                        ++i; // :
-                        while (json[i] == ' ') ++i;
-                        if (json[i] != '\"') {
-                            while (json[i] != ',' && json[i] != '}') {
-                                str_val += json[i++];
-                            }
-                            has_key = false;
-                        } else {
-                            in_token = true;
-                            continue;
-                        }
-                    } else {
-                        has_key = false;
-                    }
+    if (params.seed <= 0) {
+        params.seed = time(NULL);
+    }
 
-                    ::replace(str_key, "\\u0120", " " ); // \u0120 -> space
-                    ::replace(str_key, "\\u010a", "\n"); // \u010a -> new line
-                    ::replace(str_key, "\\\"",    "\""); // \\\"   -> "
-
-                    try {
-                        result[str_key] = std::stoi(str_val);
-                    } catch (...) {
-                        //fprintf(stderr, "%s: ignoring key '%s' with value '%s'\n", fname.c_str(), str_key.c_str(), str_val.c_str());
+    fprintf(stderr, "%s: seed = %d\n", __func__, params.seed);
 
-                    }
-                    str_key = "";
-                    str_val = "";
-                    in_token = false;
-                    continue;
-                }
-                if (has_key == false) {
-                    str_key += json[i];
-                } else {
-                    str_val += json[i];
-                }
-            }
-        }
+    std::mt19937 rng(params.seed);
+    if (params.random_prompt) {
+        params.prompt = gpt_random_prompt(rng);
     }
 
-    return result;
-}
+//    params.prompt = R"(// this function checks if the number n is prime
+//bool is_prime(int n) {)";
 
-std::vector<gpt_vocab::id> gpt_tokenize(const gpt_vocab & vocab, const std::string & text) {
-    std::vector<std::string> words;
+    llama_context * ctx;
 
-    // first split the text into words
+    // load the model
     {
-        std::string str = text;
-        std::string pat = R"('s|'t|'re|'ve|'m|'ll|'d| ?[[:alpha:]]+| ?[[:digit:]]+| ?[^\s[:alpha:][:digit:]]+|\s+(?!\S)|\s+)";
+        auto lparams = llama_context_default_params();
 
-        std::regex re(pat);
-        std::smatch m;
+        lparams.n_ctx      = params.n_ctx;
+        lparams.n_parts    = params.n_parts;
+        lparams.seed       = params.seed;
+        lparams.f16_kv     = params.memory_f16;
+        lparams.use_mlock  = params.use_mlock;
 
-        while (std::regex_search(str, m, re)) {
-            for (auto x : m) {
-                words.push_back(x);
-            }
-            str = m.suffix();
-        }
-    }
+        ctx = llama_init_from_file(params.model.c_str(), lparams);
 
-    // find the longest tokens that form the words:
-    std::vector<gpt_vocab::id> tokens;
-    for (const auto & word : words) {
-        if (word.size() == 0) continue;
-
-        int i = 0;
-        int n = word.size();
-        while (i < n) {
-            int j = n;
-            while (j > i) {
-                auto it = vocab.token_to_id.find(word.substr(i, j-i));
-                if (it != vocab.token_to_id.end()) {
-                    tokens.push_back(it->second);
-                    i = j;
-                    break;
-                }
-                --j;
-            }
-            if (i == n) {
-                break;
-            }
-            if (j == i) {
-                auto sub = word.substr(i, 1);
-                if (vocab.token_to_id.find(sub) != vocab.token_to_id.end()) {
-                    tokens.push_back(vocab.token_to_id.at(sub));
-                } else {
-                    fprintf(stderr, "%s: unknown token '%s'\n", __func__, sub.data());
-                }
-                ++i;
-            }
+        if (ctx == NULL) {
+            fprintf(stderr, "%s: error: failed to load model '%s'\n", __func__, params.model.c_str());
+            return 1;
         }
     }
 
-    return tokens;
-}
-
-// TODO: Calculate this constant from the vocabulary
-#define MAX_TOKEN_LEN 18
-// SentencePiece implementation after https://guillaume-be.github.io/2020-05-30/sentence_piece
-std::vector<gpt_vocab::id> llama_tokenize(const gpt_vocab & vocab, const std::string & text, bool bos) {
-    std::vector<gpt_vocab::id> res;
-    std::vector<int> score;
-    std::vector<gpt_vocab::id> prev;
-    int len = text.length();
-
-    score.resize(len + 1);
-    prev.resize(len + 1);
-
-    // Forward pass
-    for (int i = 0; i < len; i++) {
-        int max_len = std::min(len - i, MAX_TOKEN_LEN);
-        for (int sub_len = 1; sub_len <= max_len; sub_len++) {
-            auto sub = text.substr(i, sub_len);
-            auto token = vocab.token_to_id.find(sub);
-            if (token != vocab.token_to_id.end()) {
-                int token_score = sub.length() * sub.length();
-                int local_score = score[i] + token_score;
-                int next = i + sub_len;
-                if (score[next] < local_score) {
-                    score[next] = local_score;
-                    prev[next] = (*token).second;
-                }
-            }
-        }
+    // print system information
+    {
+        fprintf(stderr, "\n");
+        fprintf(stderr, "system_info: n_threads = %d / %d | %s\n",
+                params.n_threads, std::thread::hardware_concurrency(), llama_print_system_info());
     }
 
-    // Backward pass
-    int i = len;
-    while (i > 0) {
-        gpt_vocab::id token_id = prev[i];
-        if (token_id == 0) {
-	    // TODO: Return error or something more meaningful
-            printf("failed to tokenize string!\n");
-	    break;
+    // determine the maximum memory usage needed to do inference for the given n_batch and n_predict parameters
+    // uncomment the "used_mem" line in llama.cpp to see the results
+    if (params.mem_test) {
+        {
+            const std::vector<llama_token> tmp(params.n_batch, 0);
+            llama_eval(ctx, tmp.data(), tmp.size(), 0, params.n_threads);
         }
-        res.push_back(token_id);
-        auto token = (*vocab.id_to_token.find(token_id)).second;
-        i -= token.length();
-    }
 
-    if (bos) {
-        res.push_back(1); // TODO: replace with vocab.bos
-    }
+        {
+            const std::vector<llama_token> tmp = { 0, };
+            llama_eval(ctx, tmp.data(), tmp.size(), params.n_predict - 1, params.n_threads);
+        }
 
-    // Pieces are in reverse order so correct that
-    std::reverse(res.begin(), res.end());
+        llama_print_timings(ctx);
+        llama_free(ctx);
 
-    return res;
-}
-std::string llama_tokens_to_string(const gpt_vocab & vocab, const std::vector<gpt_vocab::id> & tokens) {
-    std::string res;
-    for (auto t : tokens) {
-        res += vocab.id_to_token.at(t);
+        return 0;
     }
-    return res;
-}
-std::string single_llama_token_to_string(const gpt_vocab & vocab, const gpt_vocab::id & tokens) {
-    return vocab.id_to_token.at(tokens);
-}
-
-bool gpt_vocab_init(const std::string & fname, gpt_vocab & vocab) {
-    printf("%s: loading vocab from '%s'\n", __func__, fname.c_str());
 
-    vocab.token_to_id = ::json_parse(fname);
+    // Add a space in front of the first character to match OG llama tokenizer behavior
+    params.prompt.insert(0, 1, ' ');
 
-    for (const auto & kv : vocab.token_to_id) {
-        vocab.id_to_token[kv.second] = kv.first;
-    }
-
-    printf("%s: vocab size = %d\n", __func__, (int) vocab.token_to_id.size());
+    // tokenize the prompt
+    auto embd_inp = ::llama_tokenize(ctx, params.prompt, true);
 
-    // print the vocabulary
-    //for (auto kv : vocab.token_to_id) {
-    //    printf("'%s' -> %d\n", kv.first.data(), kv.second);
-    //}
+    const int n_ctx = llama_n_ctx(ctx);
 
-    return true;
-}
+    if ((int) embd_inp.size() > n_ctx - 4) {
+        fprintf(stderr, "%s: error: prompt is too long (%d tokens, max %d)\n", __func__, (int) embd_inp.size(), n_ctx - 4);
+        return 1;
+    }
 
+    // number of tokens to keep when resetting context
+    if (params.n_keep < 0 || params.n_keep > (int)embd_inp.size() || params.instruct) {
+        params.n_keep = (int)embd_inp.size();
+    }
 
-void sample_top_k(std::vector<std::pair<double, gpt_vocab::id>> & logits_id, int top_k) {
-    // find the top K tokens
-    std::partial_sort(
-            logits_id.begin(),
-            logits_id.begin() + top_k, logits_id.end(),
-            [](const std::pair<double, gpt_vocab::id> & a, const std::pair<double, gpt_vocab::id> & b) {
-        return a.first > b.first;
-    });
+    // prefix & suffix for instruct mode
+    const auto inp_pfx = ::llama_tokenize(ctx, "\n\n### Instruction:\n\n", true);
+    const auto inp_sfx = ::llama_tokenize(ctx, "\n\n### Response:\n\n", false);
 
-    logits_id.resize(top_k);
-}
+    // in instruct mode, we inject a prefix and a suffix to each input by the user
+    if (params.instruct) {
+        params.interactive_start = true;
+        params.antiprompt.push_back("### Instruction:\n\n");
+    }
 
-gpt_vocab::id llama_sample_top_p_top_k(
-        const gpt_vocab & vocab,
-        const float * logits,
-        std::vector<gpt_vocab::id> & last_n_tokens,
-        double repeat_penalty,
-        int top_k,
-        double top_p,
-        double temp,
-        std::mt19937 & rng) {
-    int n_logits = vocab.id_to_token.size();
+    // enable interactive mode if reverse prompt or interactive start is specified
+    if (params.antiprompt.size() != 0 || params.interactive_start) { 
+        params.interactive = true;
+    }
 
-    std::vector<std::pair<double, gpt_vocab::id>> logits_id;
-    logits_id.reserve(n_logits);
+    // determine newline token
+    auto llama_token_newline = ::llama_tokenize(ctx, "\n", false);
 
-    {
-        const double scale = 1.0/temp;
-        for (int i = 0; i < n_logits; ++i) {
-            // repetition penalty from CTRL paper (https://arxiv.org/abs/1909.05858)
-            // credit https://github.com/facebookresearch/llama/compare/main...shawwn:llama:main
-            if (std::find(last_n_tokens.begin(), last_n_tokens.end(), i) != last_n_tokens.end()) {
-                // if score < 0 then repetition penalty has to multiplied to reduce the previous token probability
-                if (logits[i] < 0.0) {
-                    logits_id.push_back(std::make_pair(logits[i]*scale*repeat_penalty, i));
-                } else {
-                    logits_id.push_back(std::make_pair(logits[i]*scale/repeat_penalty, i));
-                }
-            } else {
-                logits_id.push_back(std::make_pair(logits[i]*scale, i));
+    if (params.verbose_prompt) {
+        fprintf(stderr, "\n");
+        fprintf(stderr, "%s: prompt: '%s'\n", __func__, params.prompt.c_str());
+        fprintf(stderr, "%s: number of tokens in prompt = %zu\n", __func__, embd_inp.size());
+        for (int i = 0; i < (int) embd_inp.size(); i++) {
+            fprintf(stderr, "%6d -> '%s'\n", embd_inp[i], llama_token_to_str(ctx, embd_inp[i]));
+        }
+        if (params.n_keep > 0) {
+        fprintf(stderr, "%s: static prompt based on n_keep: '", __func__);
+            for (int i = 0; i < params.n_keep; i++) {
+                fprintf(stderr, "%s", llama_token_to_str(ctx, embd_inp[i]));
             }
+            fprintf(stderr, "'\n");
         }
+        fprintf(stderr, "\n");
     }
 
-    sample_top_k(logits_id, top_k);
+    if (params.interactive) {
+#if defined (__unix__) || (defined (__APPLE__) && defined (__MACH__))
+        struct sigaction sigint_action;
+        sigint_action.sa_handler = sigint_handler;
+        sigemptyset (&sigint_action.sa_mask);
+        sigint_action.sa_flags = 0;
+        sigaction(SIGINT, &sigint_action, NULL);
+#elif defined (_WIN32)
+        signal(SIGINT, sigint_handler);
+#endif
 
-    double maxl = -INFINITY;
-    for (const auto & kv : logits_id) {
-        maxl = std::max(maxl, kv.first);
-    }
+        fprintf(stderr, "%s: interactive mode on.\n", __func__);
 
-    // compute probs for the top K tokens
-    std::vector<double> probs;
-    probs.reserve(logits_id.size());
+        if (params.antiprompt.size()) {
+            for (auto antiprompt : params.antiprompt) {
+                fprintf(stderr, "Reverse prompt: '%s'\n", antiprompt.c_str());
+            }
+        }
 
-    double sum = 0.0;
-    for (const auto & kv : logits_id) {
-        double p = exp(kv.first - maxl);
-        probs.push_back(p);
-        sum += p;
+        if (!params.input_prefix.empty()) {
+            fprintf(stderr, "Input prefix: '%s'\n", params.input_prefix.c_str());
+        }
     }
+    fprintf(stderr, "sampling: temp = %f, top_k = %d, top_p = %f, repeat_last_n = %i, repeat_penalty = %f\n",
+        params.temp, params.top_k, params.top_p, params.repeat_last_n, params.repeat_penalty);
+    fprintf(stderr, "generate: n_ctx = %d, n_batch = %d, n_predict = %d, n_keep = %d\n", n_ctx, params.n_batch, params.n_predict, params.n_keep);
+    fprintf(stderr, "\n\n");
 
-    // normalize the probs
-    for (auto & p : probs) {
-        p /= sum;
+    // TODO: replace with ring-buffer
+    std::vector<llama_token> last_n_tokens(n_ctx);
+    std::fill(last_n_tokens.begin(), last_n_tokens.end(), 0);
+
+    if (params.interactive) {
+        fprintf(stderr, "== Running in interactive mode. ==\n"
+#if defined (__unix__) || (defined (__APPLE__) && defined (__MACH__)) || defined (_WIN32)
+               " - Press Ctrl+C to interject at any time.\n"
+#endif
+               " - Press Return to return control to LLaMa.\n"
+               " - If you want to submit another line, end your input in '\\'.\n\n");
+        is_interacting = params.interactive_start;
     }
 
-    if (top_p < 1.0f) {
-        double cumsum = 0.0f;
-        for (int i = 0; i < (int) probs.size(); i++) {
-            cumsum += probs[i];
-            if (cumsum >= top_p) {
-                probs.resize(i + 1);
-                logits_id.resize(i + 1);
-                break;
-            }
-        }
+    bool is_antiprompt = false;
+    bool input_noecho  = false;
 
-        cumsum = 1.0/cumsum;
-        for (int i = 0; i < (int) probs.size(); i++) {
-            probs[i] *= cumsum;
-        }
-    }
+    int n_past     = 0;
+    int n_remain   = params.n_predict;
+    int n_consumed = 0;
 
-    //printf("\n");
-    //for (int i = 0; i < (int) 10; i++) {
-    //    printf("%d: '%s' %f\n", i, vocab.id_to_token.at(logits_id[i].second).c_str(), probs[i]);
-    //}
-    //printf("\n\n");
-    //exit(0);
+    // the first thing we will do is to output the prompt, so set color accordingly
+    set_console_color(con_st, CONSOLE_COLOR_PROMPT);
 
-    std::discrete_distribution<> dist(probs.begin(), probs.end());
-    int idx = dist(rng);
+    std::vector<llama_token> embd;
 
-    return logits_id[idx].second;
-}
+    while (n_remain != 0 || params.interactive) {
+        // predict
+        if (embd.size() > 0) {
+            // infinite text generation via context swapping
+            // if we run out of context:
+            // - take the n_keep first tokens from the original prompt (via n_past)
+            // - take half of the last (n_ctx - n_keep) tokens and recompute the logits in a batch
+            if (n_past + (int) embd.size() > n_ctx) {
+                const int n_left = n_past - params.n_keep;
 
+                n_past = params.n_keep;
 
-size_t ggml_quantize_q4_0(float * src, void * dst, int n, int k, int qk, int64_t * hist) {
-    const int nb = k / qk;
-    const size_t bs = (sizeof(float) + sizeof(uint8_t)*qk/2);
-    const size_t row_size = nb*bs;
+                // insert n_left/2 tokens at the start of embd from last_n_tokens
+                embd.insert(embd.begin(), last_n_tokens.begin() + n_ctx - n_left/2 - embd.size(), last_n_tokens.end() - embd.size());
 
-    assert(k % qk == 0);
+                //printf("\n---\n");
+                //printf("resetting: '");
+                //for (int i = 0; i < (int) embd.size(); i++) {
+                //    printf("%s", llama_token_to_str(ctx, embd[i]));
+                //}
+                //printf("'\n");
+                //printf("\n---\n");
+            }
 
-    const size_t pp_size = qk / 2;
-    uint8_t *pp = static_cast<uint8_t*>(alloca(pp_size));
+            if (llama_eval(ctx, embd.data(), embd.size(), n_past, params.n_threads)) {
+                fprintf(stderr, "%s : failed to eval\n", __func__);
+                return 1;
+            }
+        }
 
-    char * pdst = (char *) dst;
+        n_past += embd.size();
+        embd.clear();
 
-    for (int j = 0; j < n; j += k) {
-        uint8_t * pd = (uint8_t *) (pdst + (j/k)*row_size + 0*bs);
-        uint8_t * pb = (uint8_t *) (pdst + (j/k)*row_size + 0*bs + sizeof(float));
+        if ((int) embd_inp.size() <= n_consumed && !is_interacting) {
+            // out of user input, sample next token
+            const int32_t top_k          = params.top_k;
+            const float   top_p          = params.top_p;
+            const float   temp           = params.temp;
+            const float   repeat_penalty = params.repeat_penalty;
 
-        for (int i = 0; i < nb; i++) {
-            float amax = 0.0f; // absolute max
+            llama_token id = 0;
 
             {
-                for (int l = 0; l < qk; l++) {
-                    const float v = src[j + i*qk + l];
-                    amax = std::max(amax, fabsf(v));
-                }
+                auto logits = llama_get_logits(ctx);
 
-                const float d = amax / ((1 << 3) - 1);
-                const float id = d ? 1.0f/d : 0.0f;
+                if (params.ignore_eos) {
+                    logits[llama_token_eos()] = 0;
+                }
 
-                *(float *) pd = d;
-                pd += bs;
+                id = llama_sample_top_p_top_k(ctx,
+                        last_n_tokens.data() + n_ctx - params.repeat_last_n,
+                        params.repeat_last_n, top_k, top_p, temp, repeat_penalty);
 
-                for (int l = 0; l < qk; l += 2) {
-                    const float v0 = (src[j + i*qk + l + 0])*id;
-                    const float v1 = (src[j + i*qk + l + 1])*id;
+                last_n_tokens.erase(last_n_tokens.begin());
+                last_n_tokens.push_back(id);
+            }
 
-                    const uint8_t vi0 = ((int8_t) (round(v0))) + 8;
-                    const uint8_t vi1 = ((int8_t) (round(v1))) + 8;
+            // replace end of text token with newline token when in interactive mode
+            if (id == llama_token_eos() && params.interactive && !params.instruct) {
+                id = llama_token_newline.front();
+                if (params.antiprompt.size() != 0) {
+                    // tokenize and inject first reverse prompt
+                    const auto first_antiprompt = ::llama_tokenize(ctx, params.antiprompt.front(), false);
+                    embd_inp.insert(embd_inp.end(), first_antiprompt.begin(), first_antiprompt.end());
+                }
+            }
 
-                    assert(vi0 >= 0 && vi0 < 16);
-                    assert(vi1 >= 0 && vi1 < 16);
+            // add it to the context
+            embd.push_back(id);
 
-                    hist[vi0]++;
-                    hist[vi1]++;
+            // echo this to console
+            input_noecho = false;
 
-                    pp[l/2] = vi0 | (vi1 << 4);
+            // decrement remaining sampling budget
+            --n_remain;
+        } else {
+            // some user input remains from prompt or interaction, forward it to processing
+            while ((int) embd_inp.size() > n_consumed) {
+                embd.push_back(embd_inp[n_consumed]);
+                last_n_tokens.erase(last_n_tokens.begin());
+                last_n_tokens.push_back(embd_inp[n_consumed]);
+                ++n_consumed;
+                if ((int) embd.size() >= params.n_batch) {
+                    break;
                 }
-
-                memcpy(pb, pp, pp_size);
-                pb += bs;
             }
         }
-    }
-
-    return (n/k)*row_size;
-}
-
-size_t ggml_quantize_q4_1(float * src, void * dst, int n, int k, int qk, int64_t * hist) {
-    const int nb = k / qk;
-    const size_t bs = (2*sizeof(float) + sizeof(uint8_t)*qk/2);
-    const size_t row_size = nb*bs;
 
-    assert(k % qk == 0);
+        // display text
+        if (!input_noecho) {
+            for (auto id : embd) {
+                printf("%s", llama_token_to_str(ctx, id));
+            }
+            fflush(stdout);
+        }
+        // reset color to default if we there is no pending user input
+        if (!input_noecho && (int)embd_inp.size() == n_consumed) {
+            set_console_color(con_st, CONSOLE_COLOR_DEFAULT);
+        }
+
+        // in interactive mode, and not currently processing queued inputs;
+        // check if we should prompt the user for more
+        if (params.interactive && (int) embd_inp.size() <= n_consumed) {
+
+            // check for reverse prompt
+            if (params.antiprompt.size()) {
+                std::string last_output;
+                for (auto id : last_n_tokens) {
+                    last_output += llama_token_to_str(ctx, id);
+                }
+
+                is_antiprompt = false;
+                // Check if each of the reverse prompts appears at the end of the output.
+                for (std::string & antiprompt : params.antiprompt) {
+                    if (last_output.find(antiprompt.c_str(), last_output.length() - antiprompt.length(), antiprompt.length()) != std::string::npos) {
+                        is_interacting = true;
+                        is_antiprompt = true;
+                        set_console_color(con_st, CONSOLE_COLOR_USER_INPUT);
+                        fflush(stdout);
+                        break;
+                    }
+                }
+            }
 
-    const size_t pp_size = qk / 2;
-    uint8_t *pp = static_cast<uint8_t*>(alloca(pp_size));
+            if (n_past > 0 && is_interacting) {
+                // potentially set color to indicate we are taking user input
+                set_console_color(con_st, CONSOLE_COLOR_USER_INPUT);
+
+                if (params.instruct) {
+                    printf("\n> ");
+                }
+
+                std::string buffer;
+                if (!params.input_prefix.empty()) {
+                    buffer += params.input_prefix;
+                    printf("%s", buffer.c_str());
+                }
+
+                std::string line;
+                bool another_line = true;
+                do {
+                    if (!std::getline(std::cin, line)) {
+                        // input stream is bad or EOF received
+                        return 0;
+                    }
+                    if (line.empty() || line.back() != '\\') {
+                        another_line = false;
+                    } else {
+                        line.pop_back(); // Remove the continue character
+                    }
+                    buffer += line + '\n'; // Append the line to the result
+                } while (another_line);
 
-    char * pdst = (char *) dst;
+                // done taking input, reset color
+                set_console_color(con_st, CONSOLE_COLOR_DEFAULT);
 
-    for (int j = 0; j < n; j += k) { 
-        uint8_t * pd = (uint8_t *) (pdst + (j/k)*row_size + 0*bs);
-        uint8_t * pm = (uint8_t *) (pdst + (j/k)*row_size + 0*bs +   sizeof(float));
-        uint8_t * pb = (uint8_t *) (pdst + (j/k)*row_size + 0*bs + 2*sizeof(float));
+                // Add tokens to embd only if the input buffer is non-empty
+                // Entering a empty line lets the user pass control back
+                if (buffer.length() > 1) {
+
+                    // instruct mode: insert instruction prefix
+                    if (params.instruct && !is_antiprompt) {
+                        n_consumed = embd_inp.size();
+                        embd_inp.insert(embd_inp.end(), inp_pfx.begin(), inp_pfx.end());
+                    }
 
-        //printf("n = %d, k = %d, nb = %d, row_size = %d, j = %d, pm = %p, pd = %p, pb = %p\n", n, k, nb, row_size, j, pm, pd, pb);
+                    auto line_inp = ::llama_tokenize(ctx, buffer, false);
+                    embd_inp.insert(embd_inp.end(), line_inp.begin(), line_inp.end());
 
-        for (int i = 0; i < nb; i++) {
-            float min = std::numeric_limits<float>::max();
-            float max = std::numeric_limits<float>::min();
+                    // instruct mode: insert response suffix
+                    if (params.instruct) {
+                        embd_inp.insert(embd_inp.end(), inp_sfx.begin(), inp_sfx.end());
+                    }
 
-            {
-                for (int l = 0; l < qk; l++) {
-                    const float v = src[j + i*qk + l];
-                    if (v < min) min = v;
-                    if (v > max) max = v;
+                    n_remain -= line_inp.size();
                 }
 
-                const float d = (max - min) / ((1 << 4) - 1);
-                const float id = d ? 1.0f/d : 0.0f;
-
-                *(float *) pd = d;
-                *(float *) pm = min;
-                pd += bs; 
-                pm += bs;
+                input_noecho = true; // do not echo this again
+            }
 
-                for (int l = 0; l < qk; l += 2) {
-                    const float v0 = (src[j + i*qk + l + 0] - min)*id;
-                    const float v1 = (src[j + i*qk + l + 1] - min)*id;
+            if (n_past > 0) {
+                is_interacting = false;
+            }
+        }
 
-                    const uint8_t vi0 = round(v0);
-                    const uint8_t vi1 = round(v1);
+        // end of text token
+        if (embd.back() == llama_token_eos()) {
+            if (params.instruct) {
+                is_interacting = true;
+            } else {
+                fprintf(stderr, " [end of text]\n");
+                break;
+            }
+        }
 
-                    assert(vi0 >= 0 && vi0 < 16);
-                    assert(vi1 >= 0 && vi1 < 16);
+        // In interactive mode, respect the maximum number of tokens and drop back to user input when reached.
+        if (params.interactive && n_remain <= 0 && params.n_predict != -1) {
+            n_remain = params.n_predict;
+            is_interacting = true;
+        }
+    }
 
-                    hist[vi0]++;
-                    hist[vi1]++;
+#if defined (_WIN32)
+    signal(SIGINT, SIG_DFL);
+#endif
 
-                    pp[l/2] = vi0 | (vi1 << 4);
-                }
+    llama_print_timings(ctx);
+    llama_free(ctx);
 
-                memcpy(pb, pp, pp_size);
-                pb += bs;
-            }
-        }
-    }
+    set_console_color(con_st, CONSOLE_COLOR_DEFAULT);
 
-    return (n/k)*row_size;
+    return 0;
 }
```

