# Comparing `tmp/nucliadb_telemetry-1.6.1-py3-none-any.whl.zip` & `tmp/nucliadb_telemetry-1.7.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,28 +1,28 @@
-Zip file size: 36812 bytes, number of entries: 26
--rw-r--r--  2.0 unx      899 b- defN 23-Apr-04 15:20 nucliadb_telemetry/__init__.py
--rw-r--r--  2.0 unx    12027 b- defN 23-Apr-04 15:20 nucliadb_telemetry/batch_span.py
--rw-r--r--  2.0 unx     1254 b- defN 23-Apr-04 15:20 nucliadb_telemetry/common.py
--rw-r--r--  2.0 unx     2925 b- defN 23-Apr-04 15:20 nucliadb_telemetry/errors.py
--rw-r--r--  2.0 unx     2615 b- defN 23-Apr-04 15:20 nucliadb_telemetry/fastapi.py
--rw-r--r--  2.0 unx    14809 b- defN 23-Apr-04 15:20 nucliadb_telemetry/grpc.py
--rw-r--r--  2.0 unx     4970 b- defN 23-Apr-04 15:20 nucliadb_telemetry/grpc_metrics.py
--rw-r--r--  2.0 unx     7231 b- defN 23-Apr-04 15:20 nucliadb_telemetry/jaeger.py
--rw-r--r--  2.0 unx     8226 b- defN 23-Apr-04 15:20 nucliadb_telemetry/jetstream.py
--rw-r--r--  2.0 unx     6138 b- defN 23-Apr-04 15:20 nucliadb_telemetry/metrics.py
--rw-r--r--  2.0 unx        0 b- defN 23-Apr-04 15:20 nucliadb_telemetry/py.typed
--rw-r--r--  2.0 unx     1165 b- defN 23-Apr-04 15:20 nucliadb_telemetry/settings.py
--rw-r--r--  2.0 unx     3883 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tracerprovider.py
--rw-r--r--  2.0 unx     5187 b- defN 23-Apr-04 15:20 nucliadb_telemetry/utils.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/__init__.py
--rw-r--r--  2.0 unx      960 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/conftest.py
--rw-r--r--  2.0 unx    12593 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/telemetry.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/grpc/__init__.py
--rw-r--r--  2.0 unx     2340 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/grpc/hellostreamingworld_pb2.py
--rw-r--r--  2.0 unx     2822 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/grpc/hellostreamingworld_pb2_grpc.py
--rw-r--r--  2.0 unx     2290 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/grpc/helloworld_pb2.py
--rw-r--r--  2.0 unx     2677 b- defN 23-Apr-04 15:20 nucliadb_telemetry/tests/grpc/helloworld_pb2_grpc.py
--rw-r--r--  2.0 unx     7177 b- defN 23-Apr-04 15:20 nucliadb_telemetry-1.6.1.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Apr-04 15:20 nucliadb_telemetry-1.6.1.dist-info/WHEEL
--rw-r--r--  2.0 unx       19 b- defN 23-Apr-04 15:20 nucliadb_telemetry-1.6.1.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     2373 b- defN 23-Apr-04 15:20 nucliadb_telemetry-1.6.1.dist-info/RECORD
-26 files, 106338 bytes uncompressed, 32908 bytes compressed:  69.1%
+Zip file size: 38240 bytes, number of entries: 26
+-rw-r--r--  2.0 unx      899 b- defN 23-Apr-06 11:12 nucliadb_telemetry/__init__.py
+-rw-r--r--  2.0 unx    12027 b- defN 23-Apr-06 11:12 nucliadb_telemetry/batch_span.py
+-rw-r--r--  2.0 unx     1254 b- defN 23-Apr-06 11:12 nucliadb_telemetry/common.py
+-rw-r--r--  2.0 unx     2925 b- defN 23-Apr-06 11:12 nucliadb_telemetry/errors.py
+-rw-r--r--  2.0 unx     7739 b- defN 23-Apr-06 11:12 nucliadb_telemetry/fastapi.py
+-rw-r--r--  2.0 unx    14809 b- defN 23-Apr-06 11:12 nucliadb_telemetry/grpc.py
+-rw-r--r--  2.0 unx     4970 b- defN 23-Apr-06 11:12 nucliadb_telemetry/grpc_metrics.py
+-rw-r--r--  2.0 unx     7231 b- defN 23-Apr-06 11:12 nucliadb_telemetry/jaeger.py
+-rw-r--r--  2.0 unx     8226 b- defN 23-Apr-06 11:12 nucliadb_telemetry/jetstream.py
+-rw-r--r--  2.0 unx     6138 b- defN 23-Apr-06 11:12 nucliadb_telemetry/metrics.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Apr-06 11:12 nucliadb_telemetry/py.typed
+-rw-r--r--  2.0 unx     1165 b- defN 23-Apr-06 11:12 nucliadb_telemetry/settings.py
+-rw-r--r--  2.0 unx     3883 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tracerprovider.py
+-rw-r--r--  2.0 unx     5187 b- defN 23-Apr-06 11:12 nucliadb_telemetry/utils.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/__init__.py
+-rw-r--r--  2.0 unx      960 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/conftest.py
+-rw-r--r--  2.0 unx    12593 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/telemetry.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/grpc/__init__.py
+-rw-r--r--  2.0 unx     2340 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/grpc/hellostreamingworld_pb2.py
+-rw-r--r--  2.0 unx     2822 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/grpc/hellostreamingworld_pb2_grpc.py
+-rw-r--r--  2.0 unx     2290 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/grpc/helloworld_pb2.py
+-rw-r--r--  2.0 unx     2677 b- defN 23-Apr-06 11:12 nucliadb_telemetry/tests/grpc/helloworld_pb2_grpc.py
+-rw-r--r--  2.0 unx     7177 b- defN 23-Apr-06 11:13 nucliadb_telemetry-1.7.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Apr-06 11:13 nucliadb_telemetry-1.7.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx       19 b- defN 23-Apr-06 11:13 nucliadb_telemetry-1.7.0.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     2373 b- defN 23-Apr-06 11:13 nucliadb_telemetry-1.7.0.dist-info/RECORD
+26 files, 111462 bytes uncompressed, 34336 bytes compressed:  69.2%
```

## zipnote {}

```diff
@@ -60,20 +60,20 @@
 
 Filename: nucliadb_telemetry/tests/grpc/helloworld_pb2.py
 Comment: 
 
 Filename: nucliadb_telemetry/tests/grpc/helloworld_pb2_grpc.py
 Comment: 
 
-Filename: nucliadb_telemetry-1.6.1.dist-info/METADATA
+Filename: nucliadb_telemetry-1.7.0.dist-info/METADATA
 Comment: 
 
-Filename: nucliadb_telemetry-1.6.1.dist-info/WHEEL
+Filename: nucliadb_telemetry-1.7.0.dist-info/WHEEL
 Comment: 
 
-Filename: nucliadb_telemetry-1.6.1.dist-info/top_level.txt
+Filename: nucliadb_telemetry-1.7.0.dist-info/top_level.txt
 Comment: 
 
-Filename: nucliadb_telemetry-1.6.1.dist-info/RECORD
+Filename: nucliadb_telemetry-1.7.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nucliadb_telemetry/fastapi.py

```diff
@@ -13,28 +13,160 @@
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
-from typing import Callable, Iterable, List, Optional
+import time
+from typing import Callable, Iterable, List, Optional, Tuple
 from urllib.parse import urlparse
 
+import prometheus_client  # type: ignore
 from fastapi import FastAPI
 from opentelemetry.instrumentation.asgi import OpenTelemetryMiddleware  # type: ignore
 from opentelemetry.instrumentation.fastapi import _get_route_details  # type: ignore
 from opentelemetry.trace import Span  # type: ignore
+from prometheus_client import CONTENT_TYPE_LATEST, Counter, Gauge, Histogram
+from starlette.middleware.base import BaseHTTPMiddleware, RequestResponseEndpoint
+from starlette.requests import Request
+from starlette.responses import PlainTextResponse, Response
+from starlette.routing import Match, Mount, Route
+from starlette.status import HTTP_500_INTERNAL_SERVER_ERROR
+from starlette.types import ASGIApp, Scope
 
 try:
     from sentry_sdk.integrations.asgi import SentryAsgiMiddleware
 except ImportError:  # pragma: no cover
     SentryAsgiMiddleware = None  # type: ignore
 
 
+async def metrics_endpoint(request):
+    output = prometheus_client.exposition.generate_latest()
+    return PlainTextResponse(
+        output.decode("utf8"), headers={"Content-Type": CONTENT_TYPE_LATEST}
+    )
+
+
+application_metrics = FastAPI(title="Metrics")  # type: ignore
+application_metrics.add_route("/metrics", metrics_endpoint)
+
+
+try:
+    from starlette_prometheus.middleware import (
+        EXCEPTIONS,
+        REQUESTS,
+        REQUESTS_IN_PROGRESS,
+        REQUESTS_PROCESSING_TIME,
+        RESPONSES,
+    )
+except ImportError:  # pragma: no cover
+    # prometheus does not allow duplicate metric names, so we need to
+    # conditionally import to avoid conflicts when both are installed
+    REQUESTS = Counter(
+        "starlette_requests_total",
+        "Total count of requests by method and path.",
+        ["method", "path_template"],
+    )
+    RESPONSES = Counter(
+        "starlette_responses_total",
+        "Total count of responses by method, path and status codes.",
+        ["method", "path_template", "status_code"],
+    )
+    REQUESTS_PROCESSING_TIME = Histogram(
+        "starlette_requests_processing_time_seconds",
+        "Histogram of requests processing time by path (in seconds)",
+        ["method", "path_template"],
+    )
+    EXCEPTIONS = Counter(
+        "starlette_exceptions_total",
+        "Total count of exceptions raised by path and exception type",
+        ["method", "path_template", "exception_type"],
+    )
+    REQUESTS_IN_PROGRESS = Gauge(
+        "starlette_requests_in_progress",
+        "Gauge of requests by method and path currently being processed",
+        ["method", "path_template"],
+    )
+
+
+class PrometheusMiddleware(BaseHTTPMiddleware):
+    def __init__(self, app: ASGIApp, filter_unhandled_paths: bool = False) -> None:
+        super().__init__(app)
+        self.filter_unhandled_paths = filter_unhandled_paths
+
+    async def dispatch(
+        self, request: Request, call_next: RequestResponseEndpoint
+    ) -> Response:
+        method = request.method
+        path_template, is_handled_path = self.get_path_template(request)
+
+        if self._is_path_filtered(is_handled_path):
+            return await call_next(request)
+
+        REQUESTS_IN_PROGRESS.labels(method=method, path_template=path_template).inc()
+        REQUESTS.labels(method=method, path_template=path_template).inc()
+        before_time = time.perf_counter()
+        try:
+            response = await call_next(request)
+        except BaseException as e:
+            status_code = HTTP_500_INTERNAL_SERVER_ERROR
+            EXCEPTIONS.labels(
+                method=method,
+                path_template=path_template,
+                exception_type=type(e).__name__,
+            ).inc()
+            raise e from None
+        else:
+            status_code = response.status_code
+            after_time = time.perf_counter()
+            REQUESTS_PROCESSING_TIME.labels(
+                method=method, path_template=path_template
+            ).observe(after_time - before_time)
+        finally:
+            RESPONSES.labels(
+                method=method, path_template=path_template, status_code=status_code
+            ).inc()
+            REQUESTS_IN_PROGRESS.labels(
+                method=method, path_template=path_template
+            ).dec()
+
+        return response
+
+    @staticmethod
+    def get_path_template(request: Request) -> Tuple[str, bool]:
+        path, found = PrometheusMiddleware._find_route(
+            request.scope, request.app.routes
+        )
+        return path or request.url.path, found
+
+    @staticmethod
+    def _find_route(scope: Scope, routes: list[Route]) -> Tuple[Optional[str], bool]:
+        # we mutate scope, so we need a copy
+        scope = scope.copy()  # type:ignore
+        for route in routes:
+            if isinstance(route, Mount):
+                mount_match, child_scope = route.matches(scope)
+                if mount_match == Match.FULL:
+                    scope.update(child_scope)
+                    sub_path, sub_match = PrometheusMiddleware._find_route(
+                        scope, route.routes
+                    )
+                    if sub_match:
+                        return route.path + sub_path, sub_match
+            elif isinstance(route, Route):
+                match, child_scope = route.matches(scope)
+                if match == Match.FULL:
+                    return route.path, True
+        return None, False
+
+    def _is_path_filtered(self, is_handled_path: bool) -> bool:
+        return self.filter_unhandled_paths and not is_handled_path
+
+
 class ExcludeList:
 
     """Class to exclude certain paths (given as a list of regexes) from tracing requests"""
 
     def __init__(self, excluded_urls: Iterable[str]):
         self._excluded_urls = excluded_urls
 
@@ -50,15 +182,19 @@
 def instrument_app(
     app: FastAPI,
     excluded_urls: List[str],
     server_request_hook: _ServerRequestHookT = None,
     client_request_hook: _ClientRequestHookT = None,
     client_response_hook: _ClientResponseHookT = None,
     tracer_provider=None,
+    metrics=False,
 ):
+    if metrics:
+        # b/w compat
+        app.add_middleware(PrometheusMiddleware)
     if SentryAsgiMiddleware is not None:
         app.add_middleware(SentryAsgiMiddleware)
 
     excluded_urls_obj = ExcludeList(excluded_urls)
 
     app.add_middleware(
         OpenTelemetryMiddleware,
```

## Comparing `nucliadb_telemetry-1.6.1.dist-info/METADATA` & `nucliadb_telemetry-1.7.0.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nucliadb-telemetry
-Version: 1.6.1
+Version: 1.7.0
 Summary: NucliaDB Telemetry Library Python process
 Home-page: https://github.com/nuclia/nucliadb
 Author: nucliadb Authors
 Author-email: nucliadb@nuclia.com
 License: MIT
 Platform: UNKNOWN
 Classifier: Development Status :: 3 - Alpha
```

## Comparing `nucliadb_telemetry-1.6.1.dist-info/RECORD` & `nucliadb_telemetry-1.7.0.dist-info/RECORD`

 * *Files 5% similar despite different names*

```diff
@@ -1,12 +1,12 @@
 nucliadb_telemetry/__init__.py,sha256=Spgi2Ggxn-7EwLPzAVSANxup76s3mPAt_Hv7EI--hV4,899
 nucliadb_telemetry/batch_span.py,sha256=M9442x9-0jPmckfFEMYNBW2FBCxm89Jb3GzfFFvQnJs,12027
 nucliadb_telemetry/common.py,sha256=ZIvQTk_-xiaqNURBocz14w4cLoMyxXVg3Yk9oWCYKpc,1254
 nucliadb_telemetry/errors.py,sha256=kYovtISME_1V-_xbaQy1Jz0maqA6Ovga4CYUg3-XeWQ,2925
-nucliadb_telemetry/fastapi.py,sha256=JlaQutRTmuD8ZMr_e3XVwHIlP8T-xc5Ms1-oinzlBPc,2615
+nucliadb_telemetry/fastapi.py,sha256=1_O5ROvptiAUW8uAVJw1T7TPNzxoYI-2NXq0pFZAMo4,7739
 nucliadb_telemetry/grpc.py,sha256=qJ0YayPHQSymP2RKQnrOKM5s7TVvZmWz5jY7Rr8UzR0,14809
 nucliadb_telemetry/grpc_metrics.py,sha256=q__fDACP2LGIpPKAW_49hyplSbbhYspNnogY5DNitS0,4970
 nucliadb_telemetry/jaeger.py,sha256=iiG1_5wq_8vP_dChFa0CU98S6C7rvMm_LYwZXLPrGlA,7231
 nucliadb_telemetry/jetstream.py,sha256=rr2iKgnm7nWMrBETNlEteMvNhMcYGS5k5aT6kJwoETE,8226
 nucliadb_telemetry/metrics.py,sha256=Oq-8cLDzVLjOJUahBF4YI31kfcIcJEDtKG4rYKLkzD0,6138
 nucliadb_telemetry/py.typed,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nucliadb_telemetry/settings.py,sha256=Cz6EMH3MQ3zAdspXomDrvGcxYokiHI4RDi-xlVoAAF8,1165
@@ -16,11 +16,11 @@
 nucliadb_telemetry/tests/conftest.py,sha256=38jA3yjjHqTcITCIogWUp05w7p_VfdSGhczi91REt8c,960
 nucliadb_telemetry/tests/telemetry.py,sha256=kdmmY513GgtSslUkvrKHs7XW_nANd42LrCgTMv2_Ymo,12593
 nucliadb_telemetry/tests/grpc/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_telemetry/tests/grpc/hellostreamingworld_pb2.py,sha256=ieRO-vJCBnbZHxgzOMkcbravm106w6gIaSk2Rn2yFCk,2340
 nucliadb_telemetry/tests/grpc/hellostreamingworld_pb2_grpc.py,sha256=t0AUJC2DgtMwFZUGs8dGlMlb2k4YmvXgzWRg029-m0k,2822
 nucliadb_telemetry/tests/grpc/helloworld_pb2.py,sha256=GLe7zEa6k4UqwZTrp34DFeg7R0_INvWSEUf_vudIdJ8,2290
 nucliadb_telemetry/tests/grpc/helloworld_pb2_grpc.py,sha256=_jxUNxl4Fx-JztK9RO5R6osjNP2sVNVPAxLnmczEYOc,2677
-nucliadb_telemetry-1.6.1.dist-info/METADATA,sha256=sqvUSKuqY0YHYXjkITSMldeRYSIeF-MaXxBewXFXSCo,7177
-nucliadb_telemetry-1.6.1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-nucliadb_telemetry-1.6.1.dist-info/top_level.txt,sha256=3qEHI_5ttqQIL2gkNYwSlKsFyBBiEzDiIy9UKISzOaQ,19
-nucliadb_telemetry-1.6.1.dist-info/RECORD,,
+nucliadb_telemetry-1.7.0.dist-info/METADATA,sha256=JWmdOEF5xkoXEEpGTE_9XHnoLnSG0TESghy1rF8ZMO4,7177
+nucliadb_telemetry-1.7.0.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+nucliadb_telemetry-1.7.0.dist-info/top_level.txt,sha256=3qEHI_5ttqQIL2gkNYwSlKsFyBBiEzDiIy9UKISzOaQ,19
+nucliadb_telemetry-1.7.0.dist-info/RECORD,,
```

