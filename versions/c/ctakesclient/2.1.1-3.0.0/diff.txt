--- tmp/ctakesclient-2.1.1.tar.gz
+++ tmp/ctakesclient-3.0.0.tar.gz
â”œâ”€â”€ filetype from file(1)
â”‚ @@ -1 +1 @@
â”‚ -gzip compressed data, was "ctakesclient-2.1.1.tar", last modified: Thu Mar 30 19:29:44 2023, max compression
â”‚ +gzip compressed data, was "ctakesclient-3.0.0.tar", last modified: Fri Apr  7 14:05:48 2023, max compression
â”‚   --- ctakesclient-2.1.1.tar
â”œâ”€â”€ +++ ctakesclient-3.0.0.tar
â”‚ â”œâ”€â”€ file list
â”‚ â”‚ @@ -1,52 +1,52 @@
â”‚ â”‚ --rw-r--r--   0        0        0    11357 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/LICENSE
â”‚ â”‚ --rw-r--r--   0        0        0     2245 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/README.md
â”‚ â”‚ --rw-r--r--   0        0        0      162 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/__init__.py
â”‚ â”‚ --rw-r--r--   0        0        0     5104 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/client.py
â”‚ â”‚ --rw-r--r--   0        0        0      534 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/exceptions.py
â”‚ â”‚ --rw-r--r--   0        0        0     7412 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/filesystem.py
â”‚ â”‚ --rw-r--r--   0        0        0     5469 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/resources/SemGroups_2018.bsv
â”‚ â”‚ --rw-r--r--   0        0        0     9865 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/resources/covid_symptoms.bsv
â”‚ â”‚ --rw-r--r--   0        0        0    16785 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/text2fhir.py
â”‚ â”‚ --rw-r--r--   0        0        0     2424 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/transformer.py
â”‚ â”‚ --rw-r--r--   0        0        0     8846 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/ctakesclient/typesystem.py
â”‚ â”‚ --rw-r--r--   0        0        0      634 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/Makefile
â”‚ â”‚ --rw-r--r--   0        0        0      795 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/api.md
â”‚ â”‚ --rw-r--r--   0        0        0     1246 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/conf.py
â”‚ â”‚ --rw-r--r--   0        0        0     4180 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/MatchText.png
â”‚ â”‚ --rw-r--r--   0        0        0     2699 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/UmlsConcept.png
â”‚ â”‚ --rw-r--r--   0        0        0     4791 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/begin.png
â”‚ â”‚ --rw-r--r--   0        0        0     4075 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/code.png
â”‚ â”‚ --rw-r--r--   0        0        0     3215 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/codingScheme.png
â”‚ â”‚ --rw-r--r--   0        0        0     2557 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/conceptAttributes.png
â”‚ â”‚ --rw-r--r--   0        0        0     6469 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/cui.png
â”‚ â”‚ --rw-r--r--   0        0        0      551 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/diagram.bnf
â”‚ â”‚ --rw-r--r--   0        0        0     4732 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/end.png
â”‚ â”‚ --rw-r--r--   0        0        0    10252 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/polarity.png
â”‚ â”‚ --rw-r--r--   0        0        0      755 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/rr-1.63.png
â”‚ â”‚ --rw-r--r--   0        0        0     3874 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/text.png
â”‚ â”‚ --rw-r--r--   0        0        0     4070 2023-03-30 19:29:34.881712 ctakesclient-2.1.1/docs/diagram/tui.png
â”‚ â”‚ --rw-r--r--   0        0        0     3528 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/docs/index.md
â”‚ â”‚ --rw-r--r--   0        0        0      800 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/docs/make.bat
â”‚ â”‚ --rw-r--r--   0        0        0     1292 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/pyproject.toml
â”‚ â”‚ --rwxr-xr-x   0        0        0     7211 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/scripts/polarity-diff-report.py
â”‚ â”‚ --rw-r--r--   0        0        0        0 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/__init__.py
â”‚ â”‚ --rw-r--r--   0        0        0     1258 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/conftest.py
â”‚ â”‚ --rw-r--r--   0        0        0        0 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/integration/__init__.py
â”‚ â”‚ --rw-r--r--   0        0        0     5363 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/integration/test_client_covid_symptoms.py
â”‚ â”‚ --rw-r--r--   0        0        0     1595 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/integration/test_client_ctakes_rest_server.py
â”‚ â”‚ --rw-r--r--   0        0        0     2389 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/integration/test_negation.py
â”‚ â”‚ --rw-r--r--   0        0        0     3284 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/integration/test_negation_transformer.py
â”‚ â”‚ --rw-r--r--   0        0        0      135 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/concepts.bsv
â”‚ â”‚ --rw-r--r--   0        0        0       63 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/semantics.bsv
â”‚ â”‚ --rw-r--r--   0        0        0     3135 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/synthentic.txt
â”‚ â”‚ --rw-r--r--   0        0        0    58544 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/synthetic.json
â”‚ â”‚ --rw-r--r--   0        0        0      680 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/test_negation_hard.txt
â”‚ â”‚ --rw-r--r--   0        0        0     6699 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/test_physician_note.json
â”‚ â”‚ --rw-r--r--   0        0        0      144 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/resources/test_physician_note.txt
â”‚ â”‚ --rw-r--r--   0        0        0     1464 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/test_client.py
â”‚ â”‚ --rw-r--r--   0        0        0     3968 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/test_filesystem.py
â”‚ â”‚ --rw-r--r--   0        0        0     1640 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/test_resources.py
â”‚ â”‚ --rw-r--r--   0        0        0    13571 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/test_text2fhir.py
â”‚ â”‚ --rw-r--r--   0        0        0      648 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/test_transformer.py
â”‚ â”‚ --rw-r--r--   0        0        0     2916 2023-03-30 19:29:34.885712 ctakesclient-2.1.1/tests/test_typesystem.py
â”‚ â”‚ --rw-r--r--   0        0        0     3319 1970-01-01 00:00:00.000000 ctakesclient-2.1.1/PKG-INFO
â”‚ â”‚ +-rw-r--r--   0        0        0    11357 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/LICENSE
â”‚ â”‚ +-rw-r--r--   0        0        0     2447 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/README.md
â”‚ â”‚ +-rw-r--r--   0        0        0      162 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/__init__.py
â”‚ â”‚ +-rw-r--r--   0        0        0     5278 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/client.py
â”‚ â”‚ +-rw-r--r--   0        0        0      534 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/exceptions.py
â”‚ â”‚ +-rw-r--r--   0        0        0     7412 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/filesystem.py
â”‚ â”‚ +-rw-r--r--   0        0        0     5469 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/resources/SemGroups_2018.bsv
â”‚ â”‚ +-rw-r--r--   0        0        0     9865 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/resources/covid_symptoms.bsv
â”‚ â”‚ +-rw-r--r--   0        0        0    16785 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/text2fhir.py
â”‚ â”‚ +-rw-r--r--   0        0        0     2549 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/transformer.py
â”‚ â”‚ +-rw-r--r--   0        0        0     8846 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/ctakesclient/typesystem.py
â”‚ â”‚ +-rw-r--r--   0        0        0      634 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/Makefile
â”‚ â”‚ +-rw-r--r--   0        0        0      795 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/api.md
â”‚ â”‚ +-rw-r--r--   0        0        0     1246 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/conf.py
â”‚ â”‚ +-rw-r--r--   0        0        0     4180 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/MatchText.png
â”‚ â”‚ +-rw-r--r--   0        0        0     2699 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/UmlsConcept.png
â”‚ â”‚ +-rw-r--r--   0        0        0     4791 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/begin.png
â”‚ â”‚ +-rw-r--r--   0        0        0     4075 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/code.png
â”‚ â”‚ +-rw-r--r--   0        0        0     3215 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/codingScheme.png
â”‚ â”‚ +-rw-r--r--   0        0        0     2557 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/conceptAttributes.png
â”‚ â”‚ +-rw-r--r--   0        0        0     6469 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/cui.png
â”‚ â”‚ +-rw-r--r--   0        0        0      551 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/diagram.bnf
â”‚ â”‚ +-rw-r--r--   0        0        0     4732 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/end.png
â”‚ â”‚ +-rw-r--r--   0        0        0    10252 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/polarity.png
â”‚ â”‚ +-rw-r--r--   0        0        0      755 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/rr-1.63.png
â”‚ â”‚ +-rw-r--r--   0        0        0     3874 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/text.png
â”‚ â”‚ +-rw-r--r--   0        0        0     4070 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/diagram/tui.png
â”‚ â”‚ +-rw-r--r--   0        0        0     3528 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/index.md
â”‚ â”‚ +-rw-r--r--   0        0        0      800 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/docs/make.bat
â”‚ â”‚ +-rw-r--r--   0        0        0     1302 2023-04-07 14:05:40.657647 ctakesclient-3.0.0/pyproject.toml
â”‚ â”‚ +-rwxr-xr-x   0        0        0     7287 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/scripts/polarity-diff-report.py
â”‚ â”‚ +-rw-r--r--   0        0        0        0 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/__init__.py
â”‚ â”‚ +-rw-r--r--   0        0        0     1258 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/conftest.py
â”‚ â”‚ +-rw-r--r--   0        0        0        0 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/integration/__init__.py
â”‚ â”‚ +-rw-r--r--   0        0        0     5440 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/integration/test_client_covid_symptoms.py
â”‚ â”‚ +-rw-r--r--   0        0        0     1644 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/integration/test_client_ctakes_rest_server.py
â”‚ â”‚ +-rw-r--r--   0        0        0     2440 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/integration/test_negation.py
â”‚ â”‚ +-rw-r--r--   0        0        0     3377 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/integration/test_negation_transformer.py
â”‚ â”‚ +-rw-r--r--   0        0        0      135 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/concepts.bsv
â”‚ â”‚ +-rw-r--r--   0        0        0       63 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/semantics.bsv
â”‚ â”‚ +-rw-r--r--   0        0        0     3135 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/synthentic.txt
â”‚ â”‚ +-rw-r--r--   0        0        0    58544 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/synthetic.json
â”‚ â”‚ +-rw-r--r--   0        0        0      680 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/test_negation_hard.txt
â”‚ â”‚ +-rw-r--r--   0        0        0     6699 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/test_physician_note.json
â”‚ â”‚ +-rw-r--r--   0        0        0      144 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/resources/test_physician_note.txt
â”‚ â”‚ +-rw-r--r--   0        0        0     1625 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/test_client.py
â”‚ â”‚ +-rw-r--r--   0        0        0     3968 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/test_filesystem.py
â”‚ â”‚ +-rw-r--r--   0        0        0     1640 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/test_resources.py
â”‚ â”‚ +-rw-r--r--   0        0        0    13571 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/test_text2fhir.py
â”‚ â”‚ +-rw-r--r--   0        0        0     1394 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/test_transformer.py
â”‚ â”‚ +-rw-r--r--   0        0        0     2916 2023-04-07 14:05:40.661647 ctakesclient-3.0.0/tests/test_typesystem.py
â”‚ â”‚ +-rw-r--r--   0        0        0     3558 1970-01-01 00:00:00.000000 ctakesclient-3.0.0/PKG-INFO
â”‚ â”‚   --- ctakesclient-2.1.1/LICENSE
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/LICENSE
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/README.md
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/README.md
â”‚ â”‚â”„ Files 18% similar despite different names
â”‚ â”‚ @@ -5,15 +5,22 @@
â”‚ â”‚  - Unified Medical Language System ([UMLS](https://nlm.nih.gov/research/umls))
â”‚ â”‚  
â”‚ â”‚  # Quickstart
â”‚ â”‚  Clinical text fragment or entire physician note.
â”‚ â”‚  
â”‚ â”‚  ```python
â”‚ â”‚  physician_note = 'Chief Complaint: Patient c/o cough, denies fever, recent COVID test negative. Denies smoking.'
â”‚ â”‚ -output = ctakesclient.client.post(physician_note)
â”‚ â”‚ +output = await ctakesclient.client.post(physician_note)
â”‚ â”‚ +```
â”‚ â”‚ +
â”‚ â”‚ +Note that `ctakesclient` uses an async API.
â”‚ â”‚ +If your code is not async, you can simply wrap calls in `asyncio.run()`:
â”‚ â”‚ +
â”‚ â”‚ +```python
â”‚ â”‚ +output = asyncio.run(ctakesclient.client.post(physician_note))
â”‚ â”‚  ```
â”‚ â”‚  
â”‚ â”‚  # Output
â”‚ â”‚  
â”‚ â”‚  This client parses responses into lists of MatchText and UmlsConcept.
â”‚ â”‚  
â”‚ â”‚  ```
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/client.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/client.py
â”‚ â”‚â”„ Files 11% similar despite different names
â”‚ â”‚ @@ -1,12 +1,14 @@
â”‚ â”‚  """HTTP client for medical language"""
â”‚ â”‚  
â”‚ â”‚  import os
â”‚ â”‚  import logging
â”‚ â”‚ -import requests
â”‚ â”‚ +
â”‚ â”‚ +import httpx
â”‚ â”‚ +
â”‚ â”‚  from ctakesclient.typesystem import CtakesJSON
â”‚ â”‚  
â”‚ â”‚  ###############################################################################
â”‚ â”‚  #
â”‚ â”‚  # https://github.com/Machine-Learning-for-Medical-Language/ctakes-covid-container
â”‚ â”‚  #
â”‚ â”‚  # https://github.com/Machine-Learning-for-Medical-Language/cnlp_transformers#negation-api
â”‚ â”‚ @@ -20,51 +22,53 @@
â”‚ â”‚  
â”‚ â”‚      :return: URL_CTAKES_REST env variable or default using localhost
â”‚ â”‚      """
â”‚ â”‚      url = os.environ.get("URL_CTAKES_REST")
â”‚ â”‚      return url or "http://localhost:8080/ctakes-web-rest/service/analyze"
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def post(sentence: str, url: str = None) -> dict:
â”‚ â”‚ +async def post(sentence: str, url: str = None, client: httpx.AsyncClient = None) -> dict:
â”‚ â”‚      """
â”‚ â”‚      Sends clinical text to cTAKES for analysis and returns the raw server response
â”‚ â”‚  
â”‚ â”‚      You likely want the higher-level `extract` method instead of this one.
â”‚ â”‚      For one, it will return a nice `CtakesJSON` object instead of raw json.
â”‚ â”‚      For another, the raw cTAKES response has some oddities, like utf16-based span indexes,
â”‚ â”‚      which `extract` fixes for you.
â”‚ â”‚  
â”‚ â”‚      :param sentence: clinical text to send to cTAKES
â”‚ â”‚      :param url: cTAKES REST server fully qualified path
â”‚ â”‚ +    :param client: optional existing HTTPX client session
â”‚ â”‚      :return: Parsed json response from cTAKES
â”‚ â”‚      """
â”‚ â”‚      url = url or get_url_ctakes_rest()
â”‚ â”‚ +    client = client or httpx.AsyncClient()
â”‚ â”‚      logging.debug(url)
â”‚ â”‚ -    response = requests.post(
â”‚ â”‚ +    response = await client.post(
â”‚ â”‚          url,
â”‚ â”‚ -        data=sentence.encode("utf8"),
â”‚ â”‚ +        content=sentence.encode("utf8"),
â”‚ â”‚          headers={
â”‚ â”‚              "Content-Type": "text/plain; charset=UTF-8",
â”‚ â”‚          },
â”‚ â”‚ -        timeout=300,  # TODO: consider exposing a pass-through timeout parameter
â”‚ â”‚      )
â”‚ â”‚      response.raise_for_status()
â”‚ â”‚      return response.json()
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def extract(sentence: str, url: str = None) -> CtakesJSON:
â”‚ â”‚ +async def extract(sentence: str, url: str = None, client: httpx.AsyncClient = None) -> CtakesJSON:
â”‚ â”‚      """
â”‚ â”‚      Send clinical text to cTAKES for analysis and packages the response up for you
â”‚ â”‚  
â”‚ â”‚      :param sentence: clinical text to send to cTAKES
â”‚ â”‚      :param url: cTAKES REST server fully qualified path
â”‚ â”‚ +    :param client: optional existing HTTPX client session
â”‚ â”‚      :return: CtakesJSON wrapper
â”‚ â”‚      """
â”‚ â”‚ -    url = url or get_url_ctakes_rest()
â”‚ â”‚ -    ner = CtakesJSON(post(sentence, url))
â”‚ â”‚ +    response = await post(sentence, url=url, client=client)
â”‚ â”‚ +    ner = CtakesJSON(response)
â”‚ â”‚      _adjust_character_indexes(sentence, ner)  # Fix Java character indexes into Python ones
â”‚ â”‚      return ner
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚  ###############################################################################
â”‚ â”‚  #
â”‚ â”‚  # Helpers
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/exceptions.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/exceptions.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/filesystem.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/filesystem.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/resources/SemGroups_2018.bsv
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/resources/SemGroups_2018.bsv
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/resources/covid_symptoms.bsv
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/resources/covid_symptoms.bsv
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/text2fhir.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/text2fhir.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/transformer.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/transformer.py
â”‚ â”‚â”„ Files 10% similar despite different names
â”‚ â”‚ @@ -1,12 +1,14 @@
â”‚ â”‚  """HTTP client for medical language"""
â”‚ â”‚  
â”‚ â”‚ -from typing import List
â”‚ â”‚  import os
â”‚ â”‚ -import requests
â”‚ â”‚ +from typing import List, Tuple
â”‚ â”‚ +
â”‚ â”‚ +import httpx
â”‚ â”‚ +
â”‚ â”‚  from ctakesclient.exceptions import ClientError
â”‚ â”‚  from ctakesclient.typesystem import Polarity
â”‚ â”‚  
â”‚ â”‚  ###############################################################################
â”‚ â”‚  #
â”‚ â”‚  # https://github.com/Machine-Learning-for-Medical-Language/cnlp_transformers#negation-api
â”‚ â”‚  #
â”‚ â”‚ @@ -19,26 +21,29 @@
â”‚ â”‚  
â”‚ â”‚      :return: CTAKES_URL_NEGATION env variable or default using localhost
â”‚ â”‚      """
â”‚ â”‚      url = os.environ.get("URL_CNLP_NEGATION")
â”‚ â”‚      return url or "http://localhost:8000/negation/process"
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def list_polarity(sentence: str, spans: list, url: str = None) -> List[Polarity]:
â”‚ â”‚ +async def list_polarity(
â”‚ â”‚ +    sentence: str, spans: List[Tuple[int, int]], url: str = None, client: httpx.AsyncClient = None
â”‚ â”‚ +) -> List[Polarity]:
â”‚ â”‚      """
â”‚ â”‚      :param sentence: clinical text to send to cTAKES
â”‚ â”‚      :param spans: list of spans where each span is a tuple of (begin,end)
â”‚ â”‚      :param url: Clinical NLP Transformer: Negation API
â”‚ â”‚ +    :param client: optional existing HTTPX client session
â”‚ â”‚      :return: List of Polarity (positive or negated)
â”‚ â”‚      """
â”‚ â”‚      url = url or get_url_cnlp_negation()
â”‚ â”‚ -    doc = {"doc_text": sentence, "entities": spans}
â”‚ â”‚ +    client = client or httpx.AsyncClient()
â”‚ â”‚  
â”‚ â”‚ -    # TODO: consider exposing a pass-through timeout parameter
â”‚ â”‚ -    response = requests.post(url=url, json=doc, timeout=300)
â”‚ â”‚ +    doc = {"doc_text": sentence, "entities": spans}
â”‚ â”‚ +    response = await client.post(url=url, json=doc)
â”‚ â”‚      response.raise_for_status()
â”‚ â”‚      response = response.json()
â”‚ â”‚      polarities = []
â”‚ â”‚  
â”‚ â”‚      for status in response["statuses"]:
â”‚ â”‚          # NOT negated (double negative)
â”‚ â”‚          if status == -1:
â”‚ â”‚ @@ -51,22 +56,19 @@
â”‚ â”‚  
â”‚ â”‚      if len(spans) != len(polarities):
â”‚ â”‚          raise ClientError("Number of Spans and Polarities did not match: " f"{spans}, {polarities}")
â”‚ â”‚  
â”‚ â”‚      return polarities
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def map_polarity(sentence: str, spans: list, url: str = None) -> dict:
â”‚ â”‚ +async def map_polarity(
â”‚ â”‚ +    sentence: str, spans: List[Tuple[int, int]], url: str = None, client: httpx.AsyncClient = None
â”‚ â”‚ +) -> dict:
â”‚ â”‚      """
â”‚ â”‚      :param sentence: clinical text to send to cTAKES
â”‚ â”‚      :param spans: list of spans where each span is a tuple of (begin,end)
â”‚ â”‚      :param url: Clinical NLP Transformer: Negation API
â”‚ â”‚ +    :param client: optional existing HTTPX client session
â”‚ â”‚      :return: Map of Polarity key=span, value=polarity
â”‚ â”‚      """
â”‚ â”‚ -    url = url or get_url_cnlp_negation()
â”‚ â”‚ -    polarities = list_polarity(sentence, spans, url)
â”‚ â”‚ -    mapped = {}
â”‚ â”‚ -
â”‚ â”‚ -    for span, polarity in zip(spans, polarities):
â”‚ â”‚ -        mapped[span] = polarity
â”‚ â”‚ -
â”‚ â”‚ -    return mapped
â”‚ â”‚ +    polarities = await list_polarity(sentence, spans, url=url, client=client)
â”‚ â”‚ +    return dict(zip(spans, polarities))
â”‚ â”‚   --- ctakesclient-2.1.1/ctakesclient/typesystem.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/ctakesclient/typesystem.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/Makefile
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/Makefile
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/api.md
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/api.md
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/conf.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/conf.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/MatchText.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/MatchText.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/UmlsConcept.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/UmlsConcept.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/begin.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/begin.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/code.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/code.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/codingScheme.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/codingScheme.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/conceptAttributes.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/conceptAttributes.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/cui.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/cui.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/diagram.bnf
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/diagram.bnf
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/end.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/end.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/polarity.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/polarity.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/rr-1.63.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/rr-1.63.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/text.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/text.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/diagram/tui.png
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/diagram/tui.png
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/index.md
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/index.md
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/docs/make.bat
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/docs/make.bat
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/pyproject.toml
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/pyproject.toml
â”‚ â”‚â”„ Files 12% similar despite different names
â”‚ â”‚ @@ -1,13 +1,13 @@
â”‚ â”‚  [project]
â”‚ â”‚  name = "ctakesclient"
â”‚ â”‚ -requires-python = ">= 3.7"
â”‚ â”‚ +requires-python = ">= 3.8"
â”‚ â”‚  dependencies = [
â”‚ â”‚      "fhirclient >= 4.1",
â”‚ â”‚ -    "requests",
â”‚ â”‚ +    "httpx",
â”‚ â”‚  ]
â”‚ â”‚  authors = [
â”‚ â”‚    { name="Andy McMurry, PhD", email="andrew.mcmurry@childrens.harvard.edu" },
â”‚ â”‚    { name="Michael Terry", email="michael.terry@childrens.harvard.edu" },
â”‚ â”‚    { name="Tim Miller", email="timothy.miller@childrens.harvard.edu" },
â”‚ â”‚  ]
â”‚ â”‚  description = "cTAKES client support for accessing cTAKES REST services"
â”‚ â”‚ @@ -47,11 +47,12 @@
â”‚ â”‚      "myst-parser", # markdown support in sphinx
â”‚ â”‚      "sphinx < 6",
â”‚ â”‚      "sphinx-rtd-theme",
â”‚ â”‚  ]
â”‚ â”‚  tests = [
â”‚ â”‚      "ddt",
â”‚ â”‚      "pytest",
â”‚ â”‚ +    "respx",
â”‚ â”‚  ]
â”‚ â”‚  dev = [
â”‚ â”‚      "pre-commit"
â”‚ â”‚  ]
â”‚ â”‚   --- ctakesclient-2.1.1/scripts/polarity-diff-report.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/scripts/polarity-diff-report.py
â”‚ â”‚â”„ Files 3% similar despite different names
â”‚ â”‚ @@ -1,12 +1,13 @@
â”‚ â”‚  #!/usr/bin/env python3
â”‚ â”‚  # pylint: disable=invalid-name
â”‚ â”‚  """Generates and shows polarity difference reports between cTAKES and cNLP"""
â”‚ â”‚  
â”‚ â”‚  import argparse
â”‚ â”‚ +import asyncio
â”‚ â”‚  import csv
â”‚ â”‚  import json
â”‚ â”‚  import os
â”‚ â”‚  import sys
â”‚ â”‚  import time
â”‚ â”‚  from json.decoder import JSONDecodeError
â”‚ â”‚  
â”‚ â”‚ @@ -16,24 +17,24 @@
â”‚ â”‚  
â”‚ â”‚  def default(parser, args):
â”‚ â”‚      del args
â”‚ â”‚  
â”‚ â”‚      parser.print_help()
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def compare_note_polarity(text: str):
â”‚ â”‚ +async def compare_note_polarity(text: str):
â”‚ â”‚      """
â”‚ â”‚      Prints difference summary (if any)
â”‚ â”‚      """
â”‚ â”‚ -    ner = ctakesclient.client.extract(text)
â”‚ â”‚ +    ner = await ctakesclient.client.extract(text)
â”‚ â”‚  
â”‚ â”‚      matches = ner.list_match()
â”‚ â”‚      spans = ner.list_spans(matches)
â”‚ â”‚  
â”‚ â”‚ -    polarities_cnlp = ctakesclient.transformer.list_polarity(text, spans)
â”‚ â”‚ +    polarities_cnlp = await ctakesclient.transformer.list_polarity(text, spans)
â”‚ â”‚      if len(matches) != len(polarities_cnlp):
â”‚ â”‚          raise JSONDecodeError("Polarity lists had different lengths!", text, 0)
â”‚ â”‚  
â”‚ â”‚      differing = []
â”‚ â”‚      for i in range(len(matches)):
â”‚ â”‚          if matches[i].polarity.value != polarities_cnlp[i].value:
â”‚ â”‚              differing.append(
â”‚ â”‚ @@ -42,15 +43,15 @@
â”‚ â”‚                      "match": matches[i].as_json(),
â”‚ â”‚                  }
â”‚ â”‚              )
â”‚ â”‚  
â”‚ â”‚      return differing
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def calculate(parser, args):
â”‚ â”‚ +async def calculate(parser, args):
â”‚ â”‚      del parser
â”‚ â”‚  
â”‚ â”‚      output_path = os.path.splitext(args.notes_path)[0] + ".pdr.ndjson"
â”‚ â”‚      if os.path.exists(output_path) and not args.resume:
â”‚ â”‚          print("Output file already exists. Use --continue if this is intended.", file=sys.stderr)
â”‚ â”‚          sys.exit(1)
â”‚ â”‚  
â”‚ â”‚ @@ -80,15 +81,15 @@
â”‚ â”‚                      if note["INSTANCE_NUM"] == start_processing_after:
â”‚ â”‚                          start_processing_after = None
â”‚ â”‚                      continue
â”‚ â”‚  
â”‚ â”‚                  note_tic = time.perf_counter()
â”‚ â”‚                  try:
â”‚ â”‚                      error = None
â”‚ â”‚ -                    differences = compare_note_polarity(note["OBSERVATION_BLOB"])
â”‚ â”‚ +                    differences = await compare_note_polarity(note["OBSERVATION_BLOB"])
â”‚ â”‚                  except JSONDecodeError as e:
â”‚ â”‚                      error = str(e)
â”‚ â”‚                      differences = []
â”‚ â”‚  
â”‚ â”‚                  json.dump(
â”‚ â”‚                      {
â”‚ â”‚                          # Save the instance id for later sanity checking
â”‚ â”‚ @@ -155,15 +156,15 @@
â”‚ â”‚          print("Context:", note_context(note["note"], m))
â”‚ â”‚          found_any = True
â”‚ â”‚  
â”‚ â”‚      if not found_any:
â”‚ â”‚          print("No matching differences found!")
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def report(parser, args):
â”‚ â”‚ +async def report(parser, args):
â”‚ â”‚      del parser
â”‚ â”‚  
â”‚ â”‚      if args.note and args.instance:
â”‚ â”‚          print("You can only specify a note number or an instance number but " "not both", file=sys.stderr)
â”‚ â”‚          sys.exit(1)
â”‚ â”‚  
â”‚ â”‚      if not args.note and not args.instance:
â”‚ â”‚ @@ -182,15 +183,15 @@
â”‚ â”‚                  show_note(args, note_data)
â”‚ â”‚                  return
â”‚ â”‚  
â”‚ â”‚      print("Note not found!", file=sys.stderr)
â”‚ â”‚      sys.exit(1)
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def main():
â”‚ â”‚ +async def main():
â”‚ â”‚      parser = argparse.ArgumentParser()
â”‚ â”‚      subparsers = parser.add_subparsers()
â”‚ â”‚  
â”‚ â”‚      parser.set_defaults(func=default)
â”‚ â”‚  
â”‚ â”‚      calculate_parser = subparsers.add_parser("calculate")
â”‚ â”‚      calculate_parser.add_argument("notes_path", metavar="notes.csv")
â”‚ â”‚ @@ -204,12 +205,12 @@
â”‚ â”‚      report_parser.add_argument("--note", type=int, action="store", help="only show differences for this note number")
â”‚ â”‚      report_parser.add_argument("--instance", type=int, action="store", help="only show differences for this note ID")
â”‚ â”‚      report_parser.add_argument("--diff", type=int, action="store", help="only show this specific difference number")
â”‚ â”‚      report_parser.add_argument("--mention", action="append", default=[], help="only show these mention types")
â”‚ â”‚      report_parser.set_defaults(func=report)
â”‚ â”‚  
â”‚ â”‚      args = parser.parse_args()
â”‚ â”‚ -    args.func(parser, args)
â”‚ â”‚ +    await args.func(parser, args)
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚  if __name__ == "__main__":
â”‚ â”‚ -    main()
â”‚ â”‚ +    asyncio.run(main())
â”‚ â”‚   --- ctakesclient-2.1.1/tests/conftest.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/conftest.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/integration/test_client_covid_symptoms.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/integration/test_client_covid_symptoms.py
â”‚ â”‚â”„ Files 2% similar despite different names
â”‚ â”‚ @@ -28,25 +28,25 @@
â”‚ â”‚      Headache = ["R51.9", "R51", "Headache", "Headaches", "HA"]
â”‚ â”‚      Dyspnea = ["R06.0", "SOB", "Short of Breath"]
â”‚ â”‚      Aches = ["Myalgias", "Muscle Aches"]
â”‚ â”‚      Anosmia = ["R43", "R43.0", "Loss of smell", "loss of taste"]
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚  @ddt.ddt
â”‚ â”‚ -class TestCtakesClient(unittest.TestCase):
â”‚ â”‚ +class TestCtakesClient(unittest.IsolatedAsyncioTestCase):
â”‚ â”‚      """Test case for ctakes client extracting covid symptoms"""
â”‚ â”‚  
â”‚ â”‚ -    def test_chief_complaint_is_symptom(self):
â”‚ â”‚ +    async def test_chief_complaint_is_symptom(self):
â”‚ â”‚          for bsv in covid_symptoms():
â”‚ â”‚  
â”‚ â”‚              chief_complaint = f"Chief Complaint: {bsv.text.lower()} ."
â”‚ â”‚  
â”‚ â”‚              print(f"{chief_complaint}")
â”‚ â”‚  
â”‚ â”‚ -            res = ctakesclient.client.extract(bsv.text)
â”‚ â”‚ +            res = await ctakesclient.client.extract(bsv.text)
â”‚ â”‚  
â”‚ â”‚              ss_list = res.list_sign_symptom()
â”‚ â”‚              match_list = res.list_match()
â”‚ â”‚  
â”‚ â”‚              # validated manually
â”‚ â”‚              excludes = [
â”‚ â”‚                  "nasal congestion",  # Nasal (anatomic site)
â”‚ â”‚ @@ -75,26 +75,27 @@
â”‚ â”‚                  "muscle pains",  # muscle (anatomic site)
â”‚ â”‚                  "muscle soreness",
â”‚ â”‚              ]  # muscle (anatomic site)
â”‚ â”‚  
â”‚ â”‚              if bsv.text.lower() not in excludes:
â”‚ â”‚                  self.assertDictEqual({"root": match_list}, {"root": ss_list})
â”‚ â”‚  
â”‚ â”‚ -    def test_covid_symptoms_medical_synonyms(self):
â”‚ â”‚ +    async def test_covid_symptoms_medical_synonyms(self):
â”‚ â”‚          """
â”‚ â”‚          Test if COVID19 symptom synonyms are mapped in the BSV dictionary.
â”‚ â”‚          """
â”‚ â”‚          expected = []
â”‚ â”‚          miss_icd = []
â”‚ â”‚          actual = []
â”‚ â”‚          for symptom in Symptom:
â”‚ â”‚              for synonym in symptom.value:
â”‚ â”‚  
â”‚ â”‚                  text = f"Chief Complaint: {synonym}"
â”‚ â”‚ -                found = ctakesclient.client.extract(text).list_match_text()
â”‚ â”‚ +                ner = await ctakesclient.client.extract(text)
â”‚ â”‚ +                found = ner.list_match_text()
â”‚ â”‚                  found = [hit.title() for hit in found]
â”‚ â”‚  
â”‚ â”‚                  if synonym.title() in found:
â”‚ â”‚                      expected.append(synonym.title())
â”‚ â”‚                      actual.append(synonym.title())
â”‚ â”‚                  elif len(synonym) < 3:
â”‚ â”‚                      miss_icd.append(synonym)
â”‚ â”‚ @@ -106,15 +107,15 @@
â”‚ â”‚          diff = set(expected).difference(set(actual))
â”‚ â”‚  
â”‚ â”‚          self.assertEqual(set(), diff, "diff should be empty, missing")
â”‚ â”‚  
â”‚ â”‚      @ddt.data(
â”‚ â”‚          *ctakesclient.filesystem.covid_symptoms(),
â”‚ â”‚      )
â”‚ â”‚ -    def test_covid_symptoms_exist_in_response(self, bsv):
â”‚ â”‚ +    async def test_covid_symptoms_exist_in_response(self, bsv):
â”‚ â”‚          """
â”‚ â”‚          Symptoms of COVID-19
â”‚ â”‚          https://www.cdc.gov/coronavirus/2019-ncov/symptoms-testing/symptoms.html
â”‚ â”‚  
â”‚ â”‚          Test if every COVID symptom is found in server dictionary.
â”‚ â”‚          https://github.com/Machine-Learning-for-Medical-Language/ctakes-client-py/blob/main/ctakesclient/resources/covid_symptoms.bsv
â”‚ â”‚          -->
â”‚ â”‚ @@ -129,15 +130,15 @@
â”‚ â”‚              "R53.81",
â”‚ â”‚              "R53.83",
â”‚ â”‚              "R68.83",
â”‚ â”‚          ]
â”‚ â”‚          if bsv.text in known_issues:
â”‚ â”‚              pytest.xfail(f"Known cTAKES failure with {bsv.text}")
â”‚ â”‚  
â”‚ â”‚ -        ner = ctakesclient.client.extract(bsv.text)
â”‚ â”‚ +        ner = await ctakesclient.client.extract(bsv.text)
â”‚ â”‚  
â”‚ â”‚          cui_list = []
â”‚ â”‚          text_list = []
â”‚ â”‚  
â”‚ â”‚          for match in ner.list_sign_symptom():
â”‚ â”‚              text_list.append(match.text)
â”‚ â”‚              for concept in match.conceptAttributes:
â”‚ â”‚   --- ctakesclient-2.1.1/tests/integration/test_client_ctakes_rest_server.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/integration/test_client_ctakes_rest_server.py
â”‚ â”‚â”„ Files 23% similar despite different names
â”‚ â”‚ @@ -1,38 +1,38 @@
â”‚ â”‚  """Tests for the cTAKES REST API"""
â”‚ â”‚  
â”‚ â”‚  import unittest
â”‚ â”‚  import ctakesclient
â”‚ â”‚  from tests.test_resources import LoadResource
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -class TestClientCtakesRestServer(unittest.TestCase):
â”‚ â”‚ +class TestClientCtakesRestServer(unittest.IsolatedAsyncioTestCase):
â”‚ â”‚      """Test case for REST requests"""
â”‚ â”‚  
â”‚ â”‚ -    def test_physician_note(self):
â”‚ â”‚ +    async def test_physician_note(self):
â”‚ â”‚          """
â”‚ â”‚          Test calling REST server returns JSON that matches expected.
â”‚ â”‚          Strong typing (Polarity, MatchText, UmlsConcept) enforced during
â”‚ â”‚          serialization.
â”‚ â”‚          """
â”‚ â”‚          physician_note = LoadResource.PHYSICIAN_NOTE_TEXT.value
â”‚ â”‚          expected = LoadResource.PHYSICIAN_NOTE_JSON.value
â”‚ â”‚  
â”‚ â”‚ -        actual1 = ctakesclient.client.extract(physician_note).as_json()
â”‚ â”‚ -        actual2 = ctakesclient.client.extract(physician_note).as_json()
â”‚ â”‚ +        actual1 = (await ctakesclient.client.extract(physician_note)).as_json()
â”‚ â”‚ +        actual2 = (await ctakesclient.client.extract(physician_note)).as_json()
â”‚ â”‚  
â”‚ â”‚          unittest.TestCase.maxDiff = None
â”‚ â”‚  
â”‚ â”‚          self.assertDictEqual(expected, actual1, "JSON did not match round trip serialization")
â”‚ â”‚          self.assertDictEqual(actual1, actual2, "calling service twice produces same results")
â”‚ â”‚  
â”‚ â”‚ -    def test_unicode(self):
â”‚ â”‚ +    async def test_unicode(self):
â”‚ â”‚          """Ensure that we handle utf8/unicode correctly"""
â”‚ â”‚          # First, make sure we don't blow up just by sending it
â”‚ â”‚ -        ner = ctakesclient.client.extract("patient feels ðŸ¤’ with fever")
â”‚ â”‚ +        ner = await ctakesclient.client.extract("patient feels ðŸ¤’ with fever")
â”‚ â”‚  
â”‚ â”‚          # Then confirm that our spans are correct (0-based and character-based)
â”‚ â”‚          self.assertLess(0, len(ner.list_sign_symptom()))
â”‚ â”‚          for symptom in ner.list_sign_symptom():  # sometimes cTAKES breaks it into multiple matches
â”‚ â”‚              self.assertEqual("fever", symptom.text)
â”‚ â”‚              self.assertEqual(21, symptom.begin)
â”‚ â”‚              self.assertEqual(26, symptom.end)
â”‚ â”‚   --- ctakesclient-2.1.1/tests/integration/test_negation.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/integration/test_negation.py
â”‚ â”‚â”„ Files 14% similar despite different names
â”‚ â”‚ @@ -26,21 +26,21 @@
â”‚ â”‚      return "The patient has a sore knee and headache but denies nausea " "and has no anosmia."
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚  def pretty(result: dict) -> str:
â”‚ â”‚      return json.dumps(result, indent=4)
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -class TestNegationCtakesDefaultContext(unittest.TestCase):
â”‚ â”‚ +class TestNegationCtakesDefaultContext(unittest.IsolatedAsyncioTestCase):
â”‚ â”‚      """
â”‚ â”‚      https://cwiki.apache.org/confluence/display/CTAKES/cTAKES+3.0+-+NE+Contexts
â”‚ â”‚      """
â”‚ â”‚  
â”‚ â”‚ -    def test_ctakes_covid_symptoms(self):
â”‚ â”‚ -        ner = ctakesclient.client.extract(note_negated_ros_review_of_symptoms())
â”‚ â”‚ +    async def test_ctakes_covid_symptoms(self):
â”‚ â”‚ +        ner = await ctakesclient.client.extract(note_negated_ros_review_of_symptoms())
â”‚ â”‚  
â”‚ â”‚          symptoms_dict = ctakesclient.filesystem.covid_symptoms()
â”‚ â”‚          symptoms_fp = []
â”‚ â”‚  
â”‚ â”‚          for match in ner.list_match(Polarity.pos):
â”‚ â”‚              for concept in match.conceptAttributes:
â”‚ â”‚                  if concept.cui in symptoms_dict:
â”‚ â”‚ @@ -50,26 +50,26 @@
â”‚ â”‚              [],
â”‚ â”‚              symptoms_fp,
â”‚ â”‚              ("false positives found in purely NEGATED physician " f"note review of systems {symptoms_fp}"),
â”‚ â”‚          )
â”‚ â”‚  
â”‚ â”‚      # pylint: disable-next=line-too-long
â”‚ â”‚      @unittest.skip("https://github.com/Machine-Learning-for-Medical-Language/ctakes-client-py/issues/8")
â”‚ â”‚ -    def test_patient_denies(self):
â”‚ â”‚ +    async def test_patient_denies(self):
â”‚ â”‚          """
â”‚ â”‚          Test everything in this example note is negated.
â”‚ â”‚          Unfortunately ctakes negation algorithm is not perfect.
â”‚ â”‚          See linked issue above.
â”‚ â”‚          """
â”‚ â”‚          text = note_negated_denies()
â”‚ â”‚ -        ner = ctakesclient.client.extract(text)
â”‚ â”‚ +        ner = await ctakesclient.client.extract(text)
â”‚ â”‚          false_positives = ner.list_match_text(Polarity.pos)
â”‚ â”‚          self.assertEqual([], false_positives)
â”‚ â”‚  
â”‚ â”‚ -    def test_history_of_headache(self):
â”‚ â”‚ +    async def test_history_of_headache(self):
â”‚ â”‚          text = note_positive_headache()
â”‚ â”‚ -        ner = ctakesclient.client.extract(text)
â”‚ â”‚ +        ner = await ctakesclient.client.extract(text)
â”‚ â”‚          self.assertIn("headache", ner.list_match_text())
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚  if __name__ == "__main__":
â”‚ â”‚      unittest.main()
â”‚ â”‚   --- ctakesclient-2.1.1/tests/integration/test_negation_transformer.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/integration/test_negation_transformer.py
â”‚ â”‚â”„ Files 20% similar despite different names
â”‚ â”‚ @@ -7,90 +7,90 @@
â”‚ â”‚  from .test_negation import (
â”‚ â”‚      note_negated_denies,
â”‚ â”‚      note_negated_ros_review_of_symptoms,
â”‚ â”‚      note_negation_api_example,
â”‚ â”‚  )
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def list_false_positive_ss(physician_note: str) -> List[str]:
â”‚ â”‚ +async def list_false_positive_ss(physician_note: str) -> List[str]:
â”‚ â”‚      """
â”‚ â”‚      :param physician_note: note containing negated entries.
â”‚ â”‚      :return: strings of symptoms that were actually marked *Polarity.pos*
â”‚ â”‚      """
â”‚ â”‚ -    ner = ctakesclient.client.extract(physician_note)
â”‚ â”‚ +    ner = await ctakesclient.client.extract(physician_note)
â”‚ â”‚      symptoms = ner.list_sign_symptom()
â”‚ â”‚      spans = ner.list_spans(symptoms)
â”‚ â”‚ -    polarities_cnlp = ctakesclient.transformer.list_polarity(sentence=physician_note, spans=spans)
â”‚ â”‚ +    polarities_cnlp = await ctakesclient.transformer.list_polarity(sentence=physician_note, spans=spans)
â”‚ â”‚  
â”‚ â”‚      fp = []
â”‚ â”‚  
â”‚ â”‚      for index in range(0, len(symptoms)):
â”‚ â”‚          polarity = polarities_cnlp[index]
â”‚ â”‚  
â”‚ â”‚          if polarity != Polarity.neg:
â”‚ â”‚              fp.append(symptoms[index].text)
â”‚ â”‚              # print(f'symptoms={symptoms}, polarities={polarities_cnlp}, '
â”‚ â”‚              #       f'text={note}')
â”‚ â”‚      return fp
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -def debug_helper(physician_note: str):
â”‚ â”‚ +async def debug_helper(physician_note: str):
â”‚ â”‚      print("##################################################################")
â”‚ â”‚      print(physician_note)
â”‚ â”‚  
â”‚ â”‚ -    ner = ctakesclient.client.extract(physician_note)
â”‚ â”‚ +    ner = await ctakesclient.client.extract(physician_note)
â”‚ â”‚  
â”‚ â”‚      matches = ner.list_match()
â”‚ â”‚      spans = ner.list_spans(matches)
â”‚ â”‚  
â”‚ â”‚      for match in matches:
â”‚ â”‚          print(f"{match.polarity.name}\t{match.span()}\t{match.text}\t\t" f"{match.type.value}")
â”‚ â”‚  
â”‚ â”‚ -    polarities_cnlp = ctakesclient.transformer.list_polarity(physician_note, spans)
â”‚ â”‚ +    polarities_cnlp = await ctakesclient.transformer.list_polarity(physician_note, spans)
â”‚ â”‚      polarities_ctakes = ner.list_polarity(spans)
â”‚ â”‚  
â”‚ â”‚      print("##################################################################")
â”‚ â”‚      print("cNLP=")
â”‚ â”‚      print(polarities_cnlp)
â”‚ â”‚  
â”‚ â”‚      print("##################################################################")
â”‚ â”‚      print("cTAKES=")
â”‚ â”‚      print(polarities_ctakes)
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -class TestNegationTransformer(unittest.TestCase):
â”‚ â”‚ +class TestNegationTransformer(unittest.IsolatedAsyncioTestCase):
â”‚ â”‚      """Test case for the machine learning negation API"""
â”‚ â”‚  
â”‚ â”‚      def test_negation_api_example(self):
â”‚ â”‚          """
â”‚ â”‚          Test negation using the example provided by upstream.
â”‚ â”‚          (the author of the server library, Tim Miller, PhD)
â”‚ â”‚          """
â”‚ â”‚          self.assertPolarityCompatible(note_negation_api_example())
â”‚ â”‚  
â”‚ â”‚ -    def test_negated_denies(self):
â”‚ â”‚ +    async def test_negated_denies(self):
â”‚ â”‚          """
â”‚ â”‚          Test simple 'patient denies' type statements.
â”‚ â”‚          """
â”‚ â”‚ -        self.assertEqual([], list_false_positive_ss(note_negated_denies()))
â”‚ â”‚ +        self.assertEqual([], await list_false_positive_ss(note_negated_denies()))
â”‚ â”‚  
â”‚ â”‚      # pylint: disable-next=line-too-long
â”‚ â”‚      @unittest.skip("https://github.com/Machine-Learning-for-Medical-Language/ctakes-client-py/issues/8")
â”‚ â”‚ -    def test_negated_review_of_symptoms(self):
â”‚ â”‚ +    async def test_negated_review_of_symptoms(self):
â”‚ â”‚          """
â”‚ â”‚          Test hard ROS section of a medical note.
â”‚ â”‚          This is not yet 100% accurate and will take consider time to be perfect.
â”‚ â”‚          Negation is not a solved problem in NLP community.
â”‚ â”‚          """
â”‚ â”‚ -        self.assertEqual([], list_false_positive_ss(note_negated_ros_review_of_symptoms()))
â”‚ â”‚ +        self.assertEqual([], await list_false_positive_ss(note_negated_ros_review_of_symptoms()))
â”‚ â”‚  
â”‚ â”‚ -    def assertPolarityCompatible(self, text: str):
â”‚ â”‚ -        ner = ctakesclient.client.extract(text)
â”‚ â”‚ +    async def assertPolarityCompatible(self, text: str):
â”‚ â”‚ +        ner = await ctakesclient.client.extract(text)
â”‚ â”‚          symptoms = ner.list_sign_symptom()
â”‚ â”‚          polarities_ctakes = ner.list_polarity(symptoms)
â”‚ â”‚ -        polarities_cnlp = ctakesclient.transformer.list_polarity(text, ner.list_spans(symptoms))
â”‚ â”‚ +        polarities_cnlp = await ctakesclient.transformer.list_polarity(text, ner.list_spans(symptoms))
â”‚ â”‚  
â”‚ â”‚          self.assertEqual(polarities_ctakes, polarities_cnlp, text)
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚  if __name__ == "__main__":
â”‚ â”‚      unittest.main()
â”‚ â”‚   --- ctakesclient-2.1.1/tests/resources/synthentic.txt
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/resources/synthentic.txt
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/resources/synthetic.json
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/resources/synthetic.json
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/resources/test_negation_hard.txt
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/resources/test_negation_hard.txt
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/resources/test_physician_note.json
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/resources/test_physician_note.json
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/test_client.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/test_client.py
â”‚ â”‚â”„ Files 25% similar despite different names
â”‚ â”‚ @@ -1,36 +1,45 @@
â”‚ â”‚  """Tests for the client module"""
â”‚ â”‚  
â”‚ â”‚  import os
â”‚ â”‚  import unittest
â”‚ â”‚  from unittest import mock
â”‚ â”‚  
â”‚ â”‚ +import respx
â”‚ â”‚ +
â”‚ â”‚  from ctakesclient import client
â”‚ â”‚  from ctakesclient.typesystem import Polarity
â”‚ â”‚  
â”‚ â”‚  from tests.test_resources import LoadResource
â”‚ â”‚  
â”‚ â”‚  
â”‚ â”‚ -class TestClient(unittest.TestCase):
â”‚ â”‚ +class TestClient(unittest.IsolatedAsyncioTestCase):
â”‚ â”‚      """Test case for client cTAKES extraction"""
â”‚ â”‚  
â”‚ â”‚      @mock.patch.dict(os.environ, {"URL_CTAKES_REST": ""})
â”‚ â”‚      def test_server_url_default(self):
â”‚ â”‚          self.assertEqual(client.get_url_ctakes_rest(), "http://localhost:8080/ctakes-web-rest/service/analyze")
â”‚ â”‚  
â”‚ â”‚      @mock.patch.dict(os.environ, {"URL_CTAKES_REST": "http://example.com:2002/blarg"})
â”‚ â”‚      def test_server_url_override(self):
â”‚ â”‚          self.assertEqual(client.get_url_ctakes_rest(), "http://example.com:2002/blarg")
â”‚ â”‚  
â”‚ â”‚ -    @mock.patch("ctakesclient.client.requests.post")
â”‚ â”‚ -    def test_simple_extract(self, mock_post):
â”‚ â”‚ +    @respx.mock
â”‚ â”‚ +    async def test_simple_extract(self):
â”‚ â”‚          """Confirm that a call to extract() gives us the expected CtakesJSON object"""
â”‚ â”‚ -        mock_response = mock.MagicMock()
â”‚ â”‚ -        mock_response.json.return_value = LoadResource.PHYSICIAN_NOTE_JSON.value
â”‚ â”‚ -        mock_post.return_value = mock_response
â”‚ â”‚ -        ner = client.extract("input text does not matter")
â”‚ â”‚ +        sentence = "input text sentence"
â”‚ â”‚ +
â”‚ â”‚ +        # Prepare mocked response
â”‚ â”‚ +        respx.post(
â”‚ â”‚ +            "http://localhost:8080/ctakes-web-rest/service/analyze",
â”‚ â”‚ +            headers={"Content-Type": "text/plain; charset=UTF-8"},
â”‚ â”‚ +            content=sentence,
â”‚ â”‚ +        ).respond(json=LoadResource.PHYSICIAN_NOTE_JSON.value)
â”‚ â”‚ +
â”‚ â”‚ +        # Make the actual call
â”‚ â”‚ +        ner = await client.extract(sentence)
â”‚ â”‚  
â”‚ â”‚          # CtakesJSON is tested more fully in test_typesystem.py.
â”‚ â”‚          # We just want to make sure that we did actually load the json here.
â”‚ â”‚          expected = {"Diarrhea", "cough"}
â”‚ â”‚          sign_symptom_pos = [m.text for m in ner.list_sign_symptom(Polarity.pos)]
â”‚ â”‚          self.assertEqual(expected, set(sign_symptom_pos))
â”‚ â”‚   --- ctakesclient-2.1.1/tests/test_filesystem.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/test_filesystem.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/test_resources.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/test_resources.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/test_text2fhir.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/test_text2fhir.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/tests/test_typesystem.py
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/tests/test_typesystem.py
â”‚ â”‚â”„ Files identical despite different names
â”‚ â”‚   --- ctakesclient-2.1.1/PKG-INFO
â”‚ â”œâ”€â”€ +++ ctakesclient-3.0.0/PKG-INFO
â”‚ â”‚â”„ Files 7% similar despite different names
â”‚ â”‚ @@ -1,26 +1,27 @@
â”‚ â”‚  Metadata-Version: 2.1
â”‚ â”‚  Name: ctakesclient
â”‚ â”‚ -Version: 2.1.1
â”‚ â”‚ +Version: 3.0.0
â”‚ â”‚  Summary: cTAKES client support for accessing cTAKES REST services
â”‚ â”‚  Author-email: "Andy McMurry, PhD" <andrew.mcmurry@childrens.harvard.edu>, Michael Terry <michael.terry@childrens.harvard.edu>, Tim Miller <timothy.miller@childrens.harvard.edu>
â”‚ â”‚ -Requires-Python: >= 3.7
â”‚ â”‚ +Requires-Python: >= 3.8
â”‚ â”‚  Description-Content-Type: text/markdown
â”‚ â”‚  Classifier: License :: OSI Approved :: Apache Software License
â”‚ â”‚  Classifier: Operating System :: OS Independent
â”‚ â”‚  Classifier: Programming Language :: Python :: 3
â”‚ â”‚  Classifier: Topic :: Software Development :: Libraries :: Python Modules
â”‚ â”‚  Requires-Dist: fhirclient >= 4.1
â”‚ â”‚ -Requires-Dist: requests
â”‚ â”‚ +Requires-Dist: httpx
â”‚ â”‚  Requires-Dist: pre-commit ; extra == "dev"
â”‚ â”‚  Requires-Dist: myst-parser ; extra == "docs"
â”‚ â”‚  Requires-Dist: sphinx < 6 ; extra == "docs"
â”‚ â”‚  Requires-Dist: sphinx-rtd-theme ; extra == "docs"
â”‚ â”‚  Requires-Dist: ddt ; extra == "tests"
â”‚ â”‚  Requires-Dist: pytest ; extra == "tests"
â”‚ â”‚ +Requires-Dist: respx ; extra == "tests"
â”‚ â”‚  Project-URL: Homepage, https://github.com/Machine-Learning-for-Medical-Language/ctakes-client-py
â”‚ â”‚  Provides-Extra: dev
â”‚ â”‚  Provides-Extra: docs
â”‚ â”‚  Provides-Extra: tests
â”‚ â”‚  
â”‚ â”‚  # Purpose: Extract Medical Concepts from Physician Notes
â”‚ â”‚  This package simplifies communication with cTAKES NLP servers which produce matches with UMLS Concepts.
â”‚ â”‚ @@ -29,15 +30,22 @@
â”‚ â”‚  - Unified Medical Language System ([UMLS](https://nlm.nih.gov/research/umls))
â”‚ â”‚  
â”‚ â”‚  # Quickstart
â”‚ â”‚  Clinical text fragment or entire physician note.
â”‚ â”‚  
â”‚ â”‚  ```python
â”‚ â”‚  physician_note = 'Chief Complaint: Patient c/o cough, denies fever, recent COVID test negative. Denies smoking.'
â”‚ â”‚ -output = ctakesclient.client.post(physician_note)
â”‚ â”‚ +output = await ctakesclient.client.post(physician_note)
â”‚ â”‚ +```
â”‚ â”‚ +
â”‚ â”‚ +Note that `ctakesclient` uses an async API.
â”‚ â”‚ +If your code is not async, you can simply wrap calls in `asyncio.run()`:
â”‚ â”‚ +
â”‚ â”‚ +```python
â”‚ â”‚ +output = asyncio.run(ctakesclient.client.post(physician_note))
â”‚ â”‚  ```
â”‚ â”‚  
â”‚ â”‚  # Output
â”‚ â”‚  
â”‚ â”‚  This client parses responses into lists of MatchText and UmlsConcept.
â”‚ â”‚  
â”‚ â”‚  ```
